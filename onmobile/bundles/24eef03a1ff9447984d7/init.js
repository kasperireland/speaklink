(window.webpackJsonp=window.webpackJsonp||[]).push([[14],[function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(4),i=s.n(n);i.a.methodFactory=function(e,t,s){return function(...t){this.prefix&&t.unshift(this.prefix);return"error"===e||"warn"===e||"trace"===e||"info"===e?console[e](...t):console.log(...t)}};const o=i.a.getLogger("matrix");function a(e){e.withPrefix=function(e){return function(e){const t=i.a.getLogger("matrix-"+e);t.prefix!==e&&(a(t),t.prefix=e,t.setLevel(i.a.levels.DEBUG));return t}((this.prefix||"")+e)}}o.setLevel(i.a.levels.DEBUG),a(o)},function(e,t,s){"use strict";s.d(t,"k",(function(){return r})),s.d(t,"l",(function(){return c})),s.d(t,"C",(function(){return l})),s.d(t,"s",(function(){return d})),s.d(t,"e",(function(){return u})),s.d(t,"h",(function(){return h})),s.d(t,"g",(function(){return m})),s.d(t,"i",(function(){return p})),s.d(t,"o",(function(){return g})),s.d(t,"r",(function(){return v})),s.d(t,"y",(function(){return f})),s.d(t,"u",(function(){return b})),s.d(t,"D",(function(){return y})),s.d(t,"x",(function(){return _})),s.d(t,"n",(function(){return S})),s.d(t,"q",(function(){return w})),s.d(t,"m",(function(){return C})),s.d(t,"F",(function(){return k})),s.d(t,"t",(function(){return O})),s.d(t,"j",(function(){return R})),s.d(t,"A",(function(){return I})),s.d(t,"B",(function(){return x})),s.d(t,"f",(function(){return T})),s.d(t,"E",(function(){return j})),s.d(t,"p",(function(){return P})),s.d(t,"a",(function(){return D})),s.d(t,"b",(function(){return A})),s.d(t,"d",(function(){return M})),s.d(t,"G",(function(){return U})),s.d(t,"c",(function(){return L})),s.d(t,"w",(function(){return F})),s.d(t,"z",(function(){return B})),s.d(t,"v",(function(){return V}));var n=s(24),i=s.n(n),o=s(20),a=s.n(o);function r(e){let t="";for(const s in e)e.hasOwnProperty(s)&&(t+="&"+encodeURIComponent(s)+"="+encodeURIComponent(e[s]));return t.substring(1)}function c(e,t){for(const s in t)t.hasOwnProperty(s)&&(e=e.replace(s,encodeURIComponent(t[s])));return e}function l(e,t,s){let n,i;if(s){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return i=e[n],e.splice(n,1),i}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return i=e[n],e.splice(n,1),i;return!1}function d(e){return"[object Function]"===Object.prototype.toString.call(e)}function u(e,t){for(let s=0;s<t.length;s++)if(!e.hasOwnProperty(t[s]))throw new Error("Missing required key: "+t[s])}function h(e){return JSON.parse(JSON.stringify(e))}function m(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;if("number"==typeof e&&isNaN(e)&&isNaN(t))return!0;if(null===e||null===t)return e===t;if(!(e instanceof Object))return!1;if(e.constructor!==t.constructor||e.prototype!==t.prototype)return!1;if(e instanceof RegExp||e instanceof Date)return e.toString()===t.toString();if(e instanceof Array){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!m(e[s],t[s]))return!1}else{let s;for(s in t)if(t.hasOwnProperty(s)!==e.hasOwnProperty(s))return!1;for(s in t){if(t.hasOwnProperty(s)!==e.hasOwnProperty(s))return!1;if(!m(e[s],t[s]))return!1}}return!0}function p(e){if("object"!=typeof e)return e;if(null==e||Array.isArray(e))return e;const t=[];for(const[s,n]of Object.entries(e))t.push([s,p(n)]);return t.sort((e,t)=>V(e[0],t[0])),t}function g(...e){const t=e[0]||{};for(let s=1;s<e.length;s++){const n=e[s];if(n)for(const e in n)t[e]=n[e]}return t}function v(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}function f(e,t,...s){try{t.call(e,...s)}catch(n){const i=new t(...s);Object.assign(e,i)}}function b(e){return"number"==typeof e&&isFinite(e)}function y(e){return"string"==typeof e?i()(e.normalize("NFD").replace(E,"")):""}function _(e){return y(e.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}const E=/[\u2000-\u200F\u202A-\u202F\u0300-\u036f\uFEFF\s]/g;function S(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function w(e,t){t="boolean"!=typeof t||t;let s=S(e);return s=s.replace(/\\\*/g,".*"),s=s.replace(/\?/g,"."),t&&(s=s.replace(/\\\[(!|)(.*)\\]/g,(function(e,t,s,n,i){return"["+(t?"^":"")+s.replace(/\\-/,"-")+"]"}))),s}function C(e){return e&&e.endsWith("/")?e.substr(0,e.length-1):e}function k(e,t){return new Promise(s=>{setTimeout(s,e,t)})}function O(e){return null==e}function R(){let e,t;const s=new Promise((s,n)=>{e=s,t=n});return{resolve:e,reject:t,promise:s}}async function I(e,t){for(const s of await e)await t(await s)}function x(e){return new Promise(t=>t(e()))}async function T(e,t){const s=[];for(let n=0;n<e.length;n+=t)s.push(...await Promise.all(e.slice(n,n+t).map(e=>e())));return s}function j(e){return a()(t=>e(t),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}let N;function P(){return N}const D=(()=>{let e="";for(let t=32;t<=126;t++)e+=String.fromCharCode(t);return e})();function A(e,t,s=D){return e.padEnd(t,s[0])}function M(e,t=D){const s=BigInt(t.length);var n;if(e<=s)return null!==(n=t[Number(e)-1])&&void 0!==n?n:"";let i=e/s,o=Number(e%s)-1;return o<0&&(i-=BigInt(Math.abs(o)),o=Number(s)-1),M(i,t)+t[o]}function U(e,t=D){const s=BigInt(t.length);let n=BigInt(0);for(let i=e.length-1,o=BigInt(0);i>=0;i--,o++){const a=e.charCodeAt(i)-t.charCodeAt(0);n+=BigInt(1+a)*s**o}return n}function L(e,t,s=D){const n=Math.max(e.length,t.length),i=U(A(e,n,s),s),o=U(A(t,n,s),s),a=(i+o)/BigInt(2);return a===i||a==o?M(a,s)+s[0]:M(a,s)}function F(e,t=D){return M(U(e,t)+BigInt(1),t)}function B(e,t=D){return M(U(e,t)-BigInt(1),t)}function V(e,t){return e<t?-1:e===t?0:1}},,,,function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.ClientReady="im.vector.ready",e.HangupCall="im.vector.hangup",e.StartLiveStream="im.vector.start_live_stream",e.OpenIntegrationManager="integration_manager_open",e.ViewRoom="io.element.view_room"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i}));const n="mx-voice-worklet";let i;!function(e){e.Timekeep="timekeep",e.AmplitudeMark="amplitude_mark"}(i||(i={}))},,,function(e,t,s){"use strict";function n(e,t){return Number.isFinite(e)?Number(e):t}function i(e,t,s){return Math.min(Math.max(e,t),s)}function o(...e){return[...e].reduce((e,t)=>t+e,0)}function a(e,t,s){return e*(s-t)+t}function r(e,t,s){return(e-t)/(s-t)}s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i})),s.d(t,"e",(function(){return o})),s.d(t,"d",(function(){return a})),s.d(t,"c",(function(){return r}))},,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(0),i=s(1);class o{constructor(e){(e=e||{}).maxTimelineEntries=e.maxTimelineEntries||50,this.opts=e,this.accountData={},this.inviteRooms={},this.joinRooms={},this.nextBatch=null,this.groups={invite:{},join:{},leave:{}}}accumulate(e,t){this._accumulateRooms(e,t),this._accumulateGroups(e),this._accumulateAccountData(e),this.nextBatch=e.next_batch}_accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach(e=>{this.accountData[e.type]=e})}_accumulateRooms(e,t){e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(s=>{this._accumulateRoom(s,"invite",e.rooms.invite[s],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(s=>{this._accumulateRoom(s,"join",e.rooms.join[s],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(s=>{this._accumulateRoom(s,"leave",e.rooms.leave[s],t)}))}_accumulateRoom(e,t,s,i){switch(t){case"invite":this._accumulateInviteState(e,s);break;case"join":this.inviteRooms[e]&&delete this.inviteRooms[e],this._accumulateJoinState(e,s,i);break;case"leave":this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:n.a.error("Unknown cateogory: ",t)}}_accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});const s=this.inviteRooms[e];t.invite_state.events.forEach(e=>{let t=!1;for(let n=0;n<s.invite_state.events.length;n++){const i=s.invite_state.events[n];i.type===e.type&&i.state_key==e.state_key&&(s.invite_state.events[n]=e,t=!0)}t||s.invite_state.events.push(e)})}_accumulateJoinState(e,t,s){this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_summary:{},_readReceipts:{}});const n=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(e=>{n._accountData[e.type]=e}),t.unread_notifications&&(n._unreadNotifications=t.unread_notifications),t.summary){const e="m.heroes",s="m.invited_member_count",i="m.joined_member_count",o=n._summary,a=t.summary;o[e]=a[e]||o[e],o[i]=a[i]||o[i],o[s]=a[s]||o[s]}if(t.ephemeral&&t.ephemeral.events&&t.ephemeral.events.forEach(e=>{"m.receipt"===e.type&&e.content&&Object.keys(e.content).forEach(t=>{e.content[t]["m.read"]&&Object.keys(e.content[t]["m.read"]).forEach(s=>{n._readReceipts[s]={data:e.content[t]["m.read"][s],eventId:t}})})}),t.timeline&&t.timeline.limited&&(n._timeline=[]),t.state&&t.state.events&&t.state.events.forEach(e=>{a(n._currentState,e)}),t.timeline&&t.timeline.events&&t.timeline.events.forEach((e,i)=>{let o;if(a(n._currentState,e),s)o=e;else{o=Object.assign({},e),void 0!==o.unsigned&&(o.unsigned=Object.assign({},o.unsigned));const t=e.unsigned?e.unsigned.age:e.age;void 0!==t&&(o._localTs=Date.now()-t)}n._timeline.push({event:o,token:0===i?t.timeline.prev_batch:null})}),n._timeline.length>this.opts.maxTimelineEntries){for(let e=n._timeline.length-this.opts.maxTimelineEntries;e<n._timeline.length;e++)if(n._timeline[e].token){n._timeline=n._timeline.slice(e,n._timeline.length);break}}}_accumulateGroups(e){e.groups&&(e.groups.invite&&Object.keys(e.groups.invite).forEach(t=>{this._accumulateGroup(t,"invite",e.groups.invite[t])}),e.groups.join&&Object.keys(e.groups.join).forEach(t=>{this._accumulateGroup(t,"join",e.groups.join[t])}),e.groups.leave&&Object.keys(e.groups.leave).forEach(t=>{this._accumulateGroup(t,"leave",e.groups.leave[t])}))}_accumulateGroup(e,t,s){for(const t of["invite","join","leave"])delete this.groups[t][e];this.groups[t][e]=s}getJSON(e){const t={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach(e=>{t.invite[e]=this.inviteRooms[e]}),Object.keys(this.joinRooms).forEach(s=>{const n=this.joinRooms[s],o={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:n._unreadNotifications,summary:n._summary};Object.keys(n._accountData).forEach(e=>{o.account_data.events.push(n._accountData[e])});const r={type:"m.receipt",room_id:s,content:{}};Object.keys(n._readReceipts).forEach(e=>{const t=n._readReceipts[e];r.content[t.eventId]||(r.content[t.eventId]={"m.read":{}}),r.content[t.eventId]["m.read"][e]=t.data}),Object.keys(r.content).length>0&&o.ephemeral.events.push(r),n._timeline.forEach(t=>{if(!o.timeline.prev_batch){if(!t.token)return;o.timeline.prev_batch=t.token}let s;!e&&t.event._localTs?(s=Object.assign({},t.event),void 0!==s.unsigned&&(s.unsigned=Object.assign({},s.unsigned)),delete s._localTs,s.unsigned=s.unsigned||{},s.unsigned.age=Date.now()-t.event._localTs):s=t.event,o.timeline.events.push(s)});const c=Object.create(null);for(let e=o.timeline.events.length-1;e>=0;e--){const t=o.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;const s=Object(i.h)(t);s.unsigned&&(s.unsigned.prev_content&&(s.content=s.unsigned.prev_content),s.unsigned.prev_sender&&(s.sender=s.unsigned.prev_sender)),a(c,s)}Object.keys(n._currentState).forEach(e=>{Object.keys(n._currentState[e]).forEach(t=>{let s=n._currentState[e][t];c[e]&&c[e][t]&&(s=c[e][t]),o.state.events.push(s)})}),t.join[s]=o});const s=[];return Object.keys(this.accountData).forEach(e=>{s.push(this.accountData[e])}),{nextBatch:this.nextBatch,roomsData:t,groupsData:this.groups,accountData:s}}getNextBatchToken(){return this.nextBatch}}function a(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}},,function(e,t,s){"use strict";function n(e,t){return new Promise((s,n)=>{let i=!0;const o=e.open(t);o.onupgradeneeded=()=>{i=!1},o.onblocked=()=>n(),o.onsuccess=()=>{o.result.close(),i||e.deleteDatabase(t),s(i)},o.onerror=e=>n(e.target.error)})}s.d(t,"a",(function(){return n}))},,function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(19),i=s(1),o=s(21),a=s(0);function r(e,t,s){const n=e.openCursor(t);return new Promise((e,t)=>{const i=[];n.onerror=e=>{t(new Error("Query failed: "+e.target.errorCode))},n.onsuccess=t=>{const n=t.target.result;n?(i.push(s(n)),n.continue()):e(i)}})}function c(e){return new Promise((t,s)=>{e.oncomplete=function(e){t(e)},e.onerror=function(e){s(e.target.error)}})}function l(e){return new Promise((t,s)=>{e.onsuccess=function(e){t(e)},e.onerror=function(e){s(e.target.error)}})}function d(e){return l(e).then(e=>e.target.result)}function u(e,t){this.indexedDB=e,this._dbName="matrix-js-sdk:"+(t||"default"),this.db=null,this._disconnected=!0,this._syncAccumulator=new n.a,this._isNewlyCreated=!1}u.exists=function(e,t){return t="matrix-js-sdk:"+(t||"default"),o.a(e,t)},u.prototype={connect:function(){if(!this._disconnected)return a.a.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this._disconnected=!1,a.a.log("LocalIndexedDBStoreBackend.connect: connecting...");const e=this.indexedDB.open(this._dbName,3);return e.onupgradeneeded=e=>{const t=e.target.result,s=e.oldVersion;a.a.log("LocalIndexedDBStoreBackend.connect: upgrading from "+s),s<1&&(this._isNewlyCreated=!0,function(e){e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})}(t)),s<2&&function(e){e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")}(t),s<3&&function(e){e.createObjectStore("client_options",{keyPath:["clobber"]})}(t)},e.onblocked=()=>{a.a.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},a.a.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),l(e).then(e=>(a.a.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=e.target.result,this.db.onversionchange=()=>{this.db.close()},this._init()))},isNewlyCreated:function(){return Promise.resolve(this._isNewlyCreated)},_init:function(){return Promise.all([this._loadAccountData(),this._loadSyncData()]).then(([e,t])=>{a.a.log("LocalIndexedDBStoreBackend: loaded initial data"),this._syncAccumulator.accumulate({next_batch:t.nextBatch,rooms:t.roomsData,groups:t.groupsData,account_data:{events:e}},!0)})},getOutOfBandMembers:function(e){return new Promise((t,s)=>{const n=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),i=IDBKeyRange.only(e),o=n.openCursor(i),a=[];let r=!1;o.onsuccess=e=>{const s=e.target.result;if(!s)return a.length||r?t(a):t(null);const n=s.value;n.oob_written?r=!0:a.push(n),s.continue()},o.onerror=e=>{s(e)}}).then(t=>(a.a.log("LL: got "+(t&&t.length)+` membershipEvents from storage for room ${e} ...`),t))},setOutOfBandMembers:async function(e,t){a.a.log("LL: backend about to store "+t.length+" members for "+e);const s=this.db.transaction(["oob_membership_events"],"readwrite"),n=s.objectStore("oob_membership_events");t.forEach(e=>{n.put(e)});const i={room_id:e,oob_written:!0,state_key:0};n.put(i),await c(s),a.a.log(`LL: backend done storing for ${e}!`)},clearOutOfBandMembers:async function(e){const t=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),s=IDBKeyRange.only(e),n=d(t.openKeyCursor(s,"next")).then(e=>e&&e.primaryKey[1]),i=d(t.openKeyCursor(s,"prev")).then(e=>e&&e.primaryKey[1]),[o,r]=await Promise.all([n,i]),c=this.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),l=IDBKeyRange.bound([e,o],[e,r]);var u;a.a.log(`LL: Deleting all users + marker in storage for room ${e}, with key range:`,[e,o],[e,r]),await(u=c.delete(l),new Promise((e,t)=>{u.onsuccess=()=>e(u),u.onerror=e=>t(e)}))},clearDatabase:function(){return new Promise((e,t)=>{a.a.log("Removing indexeddb instance: "+this._dbName);const s=this.indexedDB.deleteDatabase(this._dbName);s.onblocked=()=>{a.a.log("can't yet delete indexeddb "+this._dbName+" because it is open elsewhere")},s.onerror=t=>{a.a.warn("unable to delete js-sdk store indexeddb: "+t.target.error),e()},s.onsuccess=()=>{a.a.log("Removed indexeddb instance: "+this._dbName),e()}})},getSavedSync:function(e){void 0===e&&(e=!0);const t=this._syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(i.h(t)):Promise.resolve(t):Promise.resolve(null)},getNextBatchToken:function(){return Promise.resolve(this._syncAccumulator.getNextBatchToken())},setSyncData:function(e){return Promise.resolve().then(()=>{this._syncAccumulator.accumulate(e)})},syncToDatabase:function(e){const t=this._syncAccumulator.getJSON(!0);return Promise.all([this._persistUserPresenceEvents(e),this._persistAccountData(t.accountData),this._persistSyncData(t.nextBatch,t.roomsData,t.groupsData)])},_persistSyncData:function(e,t,s){return a.a.log("Persisting sync data up to",e),i.B(()=>{const n=this.db.transaction(["sync"],"readwrite");return n.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t,groupsData:s}),c(n)})},_persistAccountData:function(e){return i.B(()=>{const t=this.db.transaction(["accountData"],"readwrite"),s=t.objectStore("accountData");for(let t=0;t<e.length;t++)s.put(e[t]);return c(t)})},_persistUserPresenceEvents:function(e){return i.B(()=>{const t=this.db.transaction(["users"],"readwrite"),s=t.objectStore("users");for(const t of e)s.put({userId:t[0],event:t[1]});return c(t)})},getUserPresenceEvents:function(){return i.B(()=>r(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,e=>[e.value.userId,e.value.event]))},_loadAccountData:function(){return a.a.log("LocalIndexedDBStoreBackend: loading account data..."),i.B(()=>r(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,e=>e.value).then(e=>(a.a.log("LocalIndexedDBStoreBackend: loaded account data"),e)))},_loadSyncData:function(){return a.a.log("LocalIndexedDBStoreBackend: loading sync data..."),i.B(()=>r(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,e=>e.value).then(e=>(a.a.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&a.a.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))},getClientOptions:function(){return Promise.resolve().then(()=>r(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,e=>{if(e.value&&e.value&&e.value.options)return e.value.options}).then(e=>e[0]))},storeClientOptions:async function(e){const t=this.db.transaction(["client_options"],"readwrite");t.objectStore("client_options").put({clobber:"-",options:e}),await c(t)}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(22),i=s.n(n);async function o(e=""){""===e||e.endsWith("/")||(e+="/");const t=a(`${e}config.${document.domain}.json`),s=a(e+"config.json");try{const e=await t;if(0===Object.keys(e).length)throw new Error;return e}catch(e){return await s}}function a(e){return new Promise((function(t,s){i()({method:"GET",url:e,qs:{cachebuster:Date.now()}},(e,n,i)=>{try{if(e||n.status<200||n.status>=300)return n&&(404==n.status||0==n.status&&""==i)&&t({}),void s({err:e,response:n});t(JSON.parse(i))}catch(e){s({err:e})}})}))}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.r(t),s.d(t,"rageshakePromise",(function(){return H})),s.d(t,"preparePlatform",(function(){return $})),s.d(t,"setupLogStorage",(function(){return z})),s.d(t,"loadConfig",(function(){return Y})),s.d(t,"loadOlm",(function(){return J})),s.d(t,"loadLanguage",(function(){return Q})),s.d(t,"loadSkin",(function(){return X})),s.d(t,"loadTheme",(function(){return Z})),s.d(t,"loadApp",(function(){return ee})),s.d(t,"showError",(function(){return te})),s.d(t,"showIncompatibleBrowser",(function(){return se})),s.d(t,"_t",(function(){return ne}));var n=s(749),i=s(750),o=s.n(i),a=s(147),r=s(91),c=s.n(r),l=s(92),d=s(98),u=s(229),h=s.n(u),m=s(255);var p=s(96),g=s(102),v=s(440),f=s(99),b=s(226),y=s(119),_=s(442),E=s(111),S=s(186),w=s(103),C=s(435),k=s(144),O=s(731),R=s(25),I=s(1303);class x extends m.e{constructor(...e){super(...e),h()(this,"_favicon",void 0)}async getConfig(){return Object(R.a)()}getHumanReadableName(){return"Vector Base Platform"}get favicon(){return this._favicon?this._favicon:this._favicon=new I.a}_updateFavicon(){let e="#d00",t=this.notificationCount;this.errorDidOccur&&(t=t||"×",e="#f00"),this.favicon.badge(t,{bgColor:e})}setNotificationCount(e){this.notificationCount!==e&&(super.setNotificationCount(e),this._updateFavicon())}setErrorStatus(e){this.errorDidOccur!==e&&(super.setErrorStatus(e),this._updateFavicon())}startUpdater(){}getDefaultDeviceDisplayName(){return Object(l.a)("Unknown device")}}function T(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}const j=window.electron,N=navigator.platform.toUpperCase().includes("MAC");function P(e){["call_state"].includes(e.action)&&j.send("app_onAction",e)}class D extends class{async supportsEventIndexing(){return!0}async initEventIndex(e,t){throw new Error("Unimplemented")}async addEventToIndex(e,t){throw new Error("Unimplemented")}async deleteEvent(e){throw new Error("Unimplemented")}async isEventIndexEmpty(){throw new Error("Unimplemented")}indexIsEmpty(){throw new Error("Unimplemented")}isRoomIndexed(e){throw new Error("Unimplemented")}async getStats(){throw new Error("Unimplemented")}async getUserVersion(){throw new Error("Unimplemented")}async setUserVersion(e){throw new Error("Unimplemented")}async commitLiveEvents(){throw new Error("Unimplemented")}async searchEventIndex(e){throw new Error("Unimplemented")}async addHistoricEvents(e,t,s){throw new Error("Unimplemented")}async addCrawlerCheckpoint(e){throw new Error("Unimplemented")}async removeCrawlerCheckpoint(e){throw new Error("Unimplemented")}async loadCheckpoints(){throw new Error("Unimplemented")}async loadFileEvents(e){throw new Error("Unimplemented")}async closeEventIndex(){throw new Error("Unimplemented")}async deleteEventIndex(){throw new Error("Unimplemented")}}{constructor(){super(),h()(this,"pendingIpcCalls",{}),h()(this,"nextIpcCallId",0),h()(this,"_onIpcReply",(e,t)=>{if(void 0===t.id)return void console.warn("Ignoring IPC reply with no ID");if(void 0===this.pendingIpcCalls[t.id])return void console.warn("Unknown IPC payload ID: "+t.id);const s=this.pendingIpcCalls[t.id];delete this.pendingIpcCalls[t.id],t.error?s.reject(t.error):s.resolve(t.reply)}),j.on("seshatReply",this._onIpcReply)}async _ipcCall(e,...t){const s=++this.nextIpcCallId;return new Promise((n,i)=>{this.pendingIpcCalls[s]={resolve:n,reject:i},window.electron.send("seshat",{id:s,name:e,args:t})})}async supportsEventIndexing(){return this._ipcCall("supportsEventIndexing")}async initEventIndex(e,t){return this._ipcCall("initEventIndex",e,t)}async addEventToIndex(e,t){return this._ipcCall("addEventToIndex",e,t)}async deleteEvent(e){return this._ipcCall("deleteEvent",e)}async isEventIndexEmpty(){return this._ipcCall("isEventIndexEmpty")}async isRoomIndexed(e){return this._ipcCall("isRoomIndexed",e)}async commitLiveEvents(){return this._ipcCall("commitLiveEvents")}async searchEventIndex(e){return this._ipcCall("searchEventIndex",e)}async addHistoricEvents(e,t,s){return this._ipcCall("addHistoricEvents",e,t,s)}async addCrawlerCheckpoint(e){return this._ipcCall("addCrawlerCheckpoint",e)}async removeCrawlerCheckpoint(e){return this._ipcCall("removeCrawlerCheckpoint",e)}async loadFileEvents(e){return this._ipcCall("loadFileEvents",e)}async loadCheckpoints(){return this._ipcCall("loadCheckpoints")}async closeEventIndex(){return this._ipcCall("closeEventIndex")}async getStats(){return this._ipcCall("getStats")}async getUserVersion(){return this._ipcCall("getUserVersion")}async setUserVersion(e){return this._ipcCall("setUserVersion",e)}async deleteEventIndex(){return this._ipcCall("deleteEventIndex")}}class A extends x{constructor(){super(),h()(this,"eventIndexManager",new D),h()(this,"pendingIpcCalls",{}),h()(this,"nextIpcCallId",0),h()(this,"ssoID",Object(S.b)(32)),h()(this,"onUpdateDownloaded",async(e,{releaseNotes:t,releaseName:s})=>{p.a.dispatch({action:w.a.CheckUpdates,status:m.d.Ready}),this.shouldShowUpdate(s)&&Object(C.b)(await this.getAppVersion(),s,t)}),h()(this,"_onIpcReply",(e,t)=>{if(void 0===t.id)return void console.warn("Ignoring IPC reply with no ID");if(void 0===this.pendingIpcCalls[t.id])return void console.warn("Unknown IPC payload ID: "+t.id);const s=this.pendingIpcCalls[t.id];delete this.pendingIpcCalls[t.id],t.error?s.reject(t.error):s.resolve(t.reply)}),p.a.register(P),j.on("check_updates",(e,t)=>{p.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?T(Object(s),!0).forEach((function(t){h()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):T(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({action:w.a.CheckUpdates},function(e){return!0===e?{status:m.d.Downloading}:!1===e?{status:m.d.NotAvailable}:{status:m.d.Error,detail:e}}(t)))}),j.on("before-quit",(function(){console.log("element-desktop closing"),v.b()})),j.on("ipcReply",this._onIpcReply),j.on("update-downloaded",this.onUpdateDownloaded),j.on("preferences",()=>{p.a.fire(w.a.ViewUserSettings)}),j.on("userDownloadCompleted",(e,{path:t,name:s})=>{k.a.sharedInstance().addOrReplaceToast({key:"DOWNLOAD_TOAST_"+t,title:Object(l.a)("Download Completed"),props:{description:s,acceptLabel:Object(l.a)("Open"),onAccept:()=>{j.send("userDownloadOpen",{path:t})},dismissLabel:Object(l.a)("Dismiss"),numSeconds:10},component:O.a,priority:99})}),Object(_.e)(_.b.NAVIGATION,{keybinds:[{modifiers:[_.a],key:_.c}],description:Object(l.b)("Switch to space by number")}),N?(Object(_.e)(_.b.NAVIGATION,{keybinds:[{modifiers:[_.d.COMMAND],key:E.a.COMMA}],description:Object(l.b)("Open user settings")}),Object(_.e)(_.b.NAVIGATION,{keybinds:[{modifiers:[_.d.COMMAND],key:E.a.SQUARE_BRACKET_LEFT},{modifiers:[_.d.COMMAND],key:E.a.SQUARE_BRACKET_RIGHT}],description:Object(l.b)("Previous/next recently visited room or community")})):Object(_.e)(_.b.NAVIGATION,{keybinds:[{modifiers:[_.d.ALT],key:E.a.ARROW_LEFT},{modifiers:[_.d.ALT],key:E.a.ARROW_RIGHT}],description:Object(l.b)("Previous/next recently visited room or community")}),this._ipcCall("startSSOFlow",this.ssoID)}async getConfig(){return this._ipcCall("getConfig")}getHumanReadableName(){return"Electron Platform"}supportsMultiLanguageSpellCheck(){return!N}setNotificationCount(e){this.notificationCount!==e&&(super.setNotificationCount(e),j.send("setBadgeCount",e))}supportsNotifications(){return!0}maySendNotifications(){return!0}displayNotification(e,t,s,n){navigator.userAgent.includes("Linux")&&(t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;"));const i={body:t,silent:!0};s&&(i.icon=s);const o=new window.Notification(e,i);return o.onclick=()=>{p.a.dispatch({action:"view_room",room_id:n.roomId}),window.focus(),this._ipcCall("focusWindow")},o}loudNotification(e,t){j.send("loudNotification")}async getAppVersion(){return this._ipcCall("getAppVersion")}supportsAutoLaunch(){return!0}async getAutoLaunchEnabled(){return this._ipcCall("getAutoLaunchEnabled")}async setAutoLaunchEnabled(e){return this._ipcCall("setAutoLaunchEnabled",e)}supportsWarnBeforeExit(){return!0}async shouldWarnBeforeExit(){return this._ipcCall("shouldWarnBeforeExit")}async setWarnBeforeExit(e){return this._ipcCall("setWarnBeforeExit",e)}supportsAutoHideMenuBar(){return!N}async getAutoHideMenuBarEnabled(){return this._ipcCall("getAutoHideMenuBarEnabled")}async setAutoHideMenuBarEnabled(e){return this._ipcCall("setAutoHideMenuBarEnabled",e)}supportsMinimizeToTray(){return!N}async getMinimizeToTrayEnabled(){return this._ipcCall("getMinimizeToTrayEnabled")}async setMinimizeToTrayEnabled(e){return this._ipcCall("setMinimizeToTrayEnabled",e)}async canSelfUpdate(){const e=await this._ipcCall("getUpdateFeedUrl");return Boolean(e)}startUpdateCheck(){super.startUpdateCheck(),j.send("check_updates")}installUpdate(){j.send("install_update")}getDefaultDeviceDisplayName(){const e=g.a.get().brand;return Object(l.a)("%(brand)s Desktop (%(platformName)s)",{brand:e,platformName:navigator.userAgent.includes("Macintosh")?"macOS":navigator.userAgent.includes("FreeBSD")?"FreeBSD":navigator.userAgent.includes("OpenBSD")?"OpenBSD":navigator.userAgent.includes("SunOS")?"SunOS":navigator.userAgent.includes("Windows")?"Windows":navigator.userAgent.includes("Linux")?"Linux":"Unknown"})}screenCaptureErrorString(){return null}requestNotificationPermission(){return Promise.resolve("granted")}reload(){window.location.reload(!1)}async _ipcCall(e,...t){const s=++this.nextIpcCallId;return new Promise((n,i)=>{this.pendingIpcCalls[s]={resolve:n,reject:i},window.electron.send("ipcCall",{id:s,name:e,args:t})})}getEventIndexingManager(){return this.eventIndexManager}async setLanguage(e){return this._ipcCall("setLanguage",e)}setSpellCheckLanguages(e){this._ipcCall("setSpellCheckLanguages",e).catch(e=>{console.log("Failed to send setSpellCheckLanguages IPC to Electron"),console.error(e)})}async getSpellCheckLanguages(){return this._ipcCall("getSpellCheckLanguages")}async getAvailableSpellCheckLanguages(){return this._ipcCall("getAvailableSpellCheckLanguages")}getSSOCallbackUrl(e){const t=super.getSSOCallbackUrl(e);return t.protocol="element",t.searchParams.set("element-desktop-ssoid",this.ssoID),t}startSingleSignOn(e,t,s,n){super.startSingleSignOn(e,t,s,n),f.a.createTrackedDialog("Electron","SSO",b.a,{title:Object(l.a)("Go to your browser to complete Sign In"),description:c.a.createElement(y.a,null)})}navigateForwardBack(e){this._ipcCall(e?"navigateBack":"navigateForward")}navigateToSpace(e){p.a.dispatch({action:w.a.SwitchSpace,num:e})}onKeyDown(e){let t=!1;switch(e.key){case E.a.SQUARE_BRACKET_LEFT:case E.a.SQUARE_BRACKET_RIGHT:!N||!e.metaKey||e.altKey||e.ctrlKey||e.shiftKey||(this.navigateForwardBack(e.key===E.a.SQUARE_BRACKET_LEFT),t=!0);break;case E.a.ARROW_LEFT:case E.a.ARROW_RIGHT:N||!e.altKey||e.metaKey||e.ctrlKey||e.shiftKey||(this.navigateForwardBack(e.key===E.a.ARROW_LEFT),t=!0);break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"0":d.b.getValue("feature_spaces")&&Object(E.d)(e)&&(this.navigateToSpace(parseInt(e.key,10)),t=!0)}return t}async getPickleKey(e,t){try{return await this._ipcCall("getPickleKey",e,t)}catch(e){return null}}async createPickleKey(e,t){try{return await this._ipcCall("createPickleKey",e,t)}catch(e){return null}}async destroyPickleKey(e,t){try{await this._ipcCall("destroyPickleKey",e,t)}catch(e){}}}var M=s(22),U=s.n(M),L=s(1304),F=s.n(L);function B(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}class V extends x{constructor(){super(),h()(this,"runningVersion",null),h()(this,"pollForUpdate",()=>this._getVersion().then(e=>{if(null===this.runningVersion)this.runningVersion=e;else{if(this.runningVersion!==e)return this.shouldShowUpdate(e)&&Object(C.b)(this.runningVersion,e),{status:m.d.Ready};Object(C.a)()}return{status:m.d.NotAvailable}},e=>(console.error("Failed to poll for update",e),{status:m.d.Error,detail:e.message||e.status?e.status.toString():"Unknown Error"}))),"serviceWorker"in navigator&&navigator.serviceWorker.register("sw.js")}getHumanReadableName(){return"Web Platform"}supportsNotifications(){return Boolean(window.Notification)}maySendNotifications(){return"granted"===window.Notification.permission}requestNotificationPermission(){return new Promise((function(e,t){window.Notification.requestPermission(t=>{e(t)})}))}displayNotification(e,t,s,n){const i={body:t,tag:"vector",silent:!0};s&&(i.icon=s);const o=new window.Notification(e,i);return o.onclick=function(){p.a.dispatch({action:"view_room",room_id:n.roomId}),window.focus(),o.close()},o}_getVersion(){return new Promise((function(e,t){U()({method:"GET",url:"version",qs:{cachebuster:Date.now()}},(s,n,i)=>{if(s||n.status<200||n.status>=300)return null===s&&(s={status:n.status}),void t(s);const o=i.trim();e(o)})}))}getAppVersion(){return null!==this.runningVersion?Promise.resolve(this.runningVersion):this._getVersion()}startUpdater(){this.pollForUpdate(),setInterval(this.pollForUpdate,6e5)}async canSelfUpdate(){return!0}startUpdateCheck(){super.startUpdateCheck(),this.pollForUpdate().then(e=>{p.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?B(Object(s),!0).forEach((function(t){h()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):B(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({action:w.a.CheckUpdates},e))})}installUpdate(){window.location.reload(!0)}getDefaultDeviceDisplayName(){const e=new URL(window.location.href),t=[e.host,e.pathname.replace(/\/$/,"")].join(""),s=new F.a,n=s.getBrowser().name||"unknown browser";let i=s.getOS().name||"unknown OS";return"Mac OS"===i&&(i="macOS"),Object(l.a)("%(appName)s (%(browserName)s, %(osName)s)",{appName:t,browserName:n,osName:i})}screenCaptureErrorString(){return"https:"!==window.location.protocol?Object(l.a)("You need to be using HTTPS to place a screen-sharing call."):null}reload(){window.location.reload(!1)}}class K extends V{setNotificationCount(e){if(!navigator.setAppBadge)return super.setNotificationCount(e);this.notificationCount!==e&&(this.notificationCount=e,navigator.setAppBadge(e).catch(e=>{console.error("Failed to update PWA app badge",e)}))}}var W=s(118),G=s(252),q=s(438);window.mxSendRageshake=function(e,t){const s=g.a.get().bug_report_endpoint_url;s?(void 0===t&&(t=!0),e&&e.trim()?Object(q.a)(s,{userText:e,sendLogs:t,progressCallback:console.log.bind(console)}).then(()=>{console.log("Bug report sent!")},e=>{console.error(e)}):console.error("Cannot send a rageshake without a message - please tell us what went wrong")):console.error("Cannot send a rageshake - no bug_report_endpoint_url configured")};const H=function(){const e=v.d(!1);return e.then(()=>{console.log("Initialised rageshake."),console.log("To fix line numbers in Chrome: Meatball menu → Settings → Ignore list → Add /rageshake\\.js$"),window.addEventListener("beforeunload",e=>{console.log("element-web closing"),v.b()}),v.a()},e=>{console.error("Failed to initialise rageshake: "+e)}),e}();function $(){window.electron?(console.log("Using Electron platform"),W.a.set(new A)):window.matchMedia("(display-mode: standalone)").matches?(console.log("Using PWA platform"),W.a.set(new K)):(console.log("Using Web platform"),W.a.set(new V))}function z(){return g.a.get().bug_report_endpoint_url?v.e():(console.warn("No bug report endpoint set - logs will not be persisted"),Promise.resolve())}async function Y(){g.a.put(await W.a.get().getConfig()||{})}function J(){return o.a.init({locateFile:()=>n.a}).then(()=>{console.log("Using WebAssembly Olm")}).catch(e=>(console.log("Failed to load Olm: trying legacy version",e),new Promise((e,t)=>{const s=document.createElement("script");s.src="olm_legacy.js",s.onload=e,s.onerror=t,document.body.appendChild(s)}).then(()=>window.Olm.init()).then(()=>{console.log("Using legacy Olm")}).catch(e=>{console.log("Both WebAssembly and asm.js Olm failed!",e)})))}async function Q(){const e=d.b.getValue("language",null,!0);let t=[];e?t=[e]:l.e().forEach(e=>{t.push(...l.f(e))});try{await l.j(t),document.documentElement.setAttribute("lang",l.d())}catch(e){console.error("Unable to set language",e)}}async function X(){console.log("Loading skin...");const[e,t]=await Promise.all([Promise.resolve().then(s.bind(null,95)),s.e(11).then(s.bind(null,1328))]);e.loadSkin(t),console.log("Skin loaded!")}async function Z(){Object(G.d)()}async function ee(e){const t=await s.e(10).then(s.bind(null,1322));window.matrixChat=a.render(await t.loadApp(e),document.getElementById("matrixchat"))}async function te(e,t){const n=(await s.e(12).then(s.bind(null,1323))).default;window.matrixChat=a.render(r.createElement(n,{title:e,messages:t}),document.getElementById("matrixchat"))}async function se(e){const t=(await s.e(9).then(s.bind(null,1324))).default;window.matrixChat=a.render(r.createElement(t,{onAccept:e}),document.getElementById("matrixchat"))}const ne=l.a},,function(e,t,s){"use strict";s.d(t,"h",(function(){return p})),s.d(t,"g",(function(){return g})),s.d(t,"b",(function(){return v})),s.d(t,"a",(function(){return f})),s.d(t,"j",(function(){return y})),s.d(t,"c",(function(){return _})),s.d(t,"e",(function(){return E})),s.d(t,"f",(function(){return S})),s.d(t,"d",(function(){return C})),s.d(t,"i",(function(){return k}));var n=s(296),i=s.n(n),o=s(755),a=s.n(o),r=s(91),c=s.n(r),l=s(98),d=s(118),u=s.p+"i18n/languages.27f54b3.json",h=s(106),m=s(149);function p(e){const t=new Error(e);return t.translatedMessage=f(e),t}function g(){const e=l.b.getValue("language",null,!0);return e||w(E()[0])}function v(e){return e}function f(e,t,s){const n=function(e,t,s){let n=e;if(void 0!==t){const e={};for(const s in t)e[`%\\(${s}\\)s`]=t[s];n=b(n,e)}if(void 0!==s){const e={};for(const t in s)e[`(<${t}>(.*?)<\\/${t}>|<${t}>|<${t}\\s*\\/>)`]=s[t];n=b(n,e)}return n}(function(e,t){let s;t&&"object"==typeof t&&(s=t.count,Object.keys(t).forEach(e=>{void 0===t[e]&&(console.warn("safeCounterpartTranslate called with undefined interpolation name: "+e),t[e]="undefined"),null===t[e]&&(console.warn("safeCounterpartTranslate called with null interpolation name: "+e),t[e]="null")}));let n=a.a.translate(e,t);return void 0===n&&void 0!==s&&(n=a.a.translate(e,Object.assign({},t,{locale:"en"}))),n}(e,Object.assign({interpolate:!1},t)),t,s);return n}function b(e,t){const s=[e];let n=!1;for(const i in t){const o=new RegExp(i,"g");let a=!1;for(let e=0;e<s.length;e++){const r=s[e];if("string"!=typeof r)continue;let c=o.exec(r);if(!c)continue;a=!0;const l=r.substr(0,c.index),d=[];let u;for(;c;){u=c;const e=c.slice(2);let s,a;if(s=t[i]instanceof Function?t[i](...e):t[i],"object"==typeof s&&(n=!0),"string"==typeof s&&""===s||d.push(s),c=o.exec(r),c){const e=u.index+u[0].length;a=r.substr(e,c.index-e)}else a=r.substr(u.index+u[0].length);a&&d.push(a)}s.splice(e,1,...d),""!==l&&s.splice(e,0,l)}a||"%\\(count\\)s"!==i&&console.log(`Could not find ${o} in ${e}`)}return n?c.a.createElement("span",null,...s):s.join("")}function y(e){Array.isArray(e)||(e=[e]);const t=d.a.get();let s,n;return t&&t.setLanguage(e),O().then(t=>{n=t;for(let t=0;t<e.length;++t)if(n.hasOwnProperty(e[t])){s=e[t];break}return s||(s="en",console.error("Unable to find an appropriate language")),R("i18n/"+n[s].fileName)}).then(e=>{if(a.a.registerTranslations(s,e),a.a.setLocale(s),l.b.setValue("language",null,h.a.DEVICE,s),console.log("set language to "+s),"en"!==s)return R("i18n/"+n.en.fileName)}).then(e=>{e&&a.a.registerTranslations("en",e)})}function _(){return O().then(e=>{const t=[];for(const s in e)e.hasOwnProperty(s)&&t.push({value:s,label:e[s].label});return t})}function E(){return navigator.languages&&navigator.languages.length?navigator.languages:navigator.language?[navigator.language]:[navigator.userLanguage||"en"]}function S(e){const t=[],s=w(e),n=s.split("-");return 2===n.length&&n[0]===n[1]?t.push(n[0]):(t.push(s),2===n.length&&t.push(n[0])),t}function w(e){return e.toLowerCase().replace("_","-")}function C(){return a.a.getLocale()}function k(e){const t=C(),s=e.map(w);{const n=s.indexOf(t);if(n>-1)return e[n]}{const n=s.findIndex(e=>e.substr(0,2)===t.substr(0,2));if(n>-1)return e[n]}{const t=s.findIndex(e=>e.startsWith("en"));if(t>-1)return e[t]}return e[0]}function O(){return new Promise((e,t)=>{let s;s="string"==typeof u?u:"i18n/languages.json",i()({method:"GET",url:s},(n,i,o)=>{n?t(n):i.status<200||i.status>=300?t(new Error(`Failed to load ${s}, got ${i.status}`)):e(JSON.parse(o))})})}async function R(e,t=3){return Object(m.b)(()=>function(e){return new Promise((t,s)=>{i()({method:"GET",url:e},(n,i,o)=>{n?s(n):i.status<200||i.status>=300?s(new Error(`Failed to load ${e}, got ${i.status}`)):t(function(e){const t={};for(const s of Object.keys(e)){const n=s.split("|",2);if(2===n.length){let i=t[n[0]];void 0===i&&(i={},t[n[0]]=i),i[n[1]]=e[s]}else t[s]=e[s]}return t}(JSON.parse(o)))})})}(e),t,t=>(console.log("Failed to load i18n",e),console.error(t),!0))}a.a.setSeparator("|"),a.a.setFallbackLocale("en")},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(95);function i(e,t){return()=>n.getComponent(e)||t}},function(e,t,s){"use strict";s.d(t,"a",(function(){return D}));var n=s(18),i=s.n(n),o=s(260),a=s(1),r=s(167),c=s(350),l=s(95),d=s(628),u=s(98),h=s(96);function m(e,t,s){return{action:"MatrixActions.sync",state:t,prevState:s,matrixClient:e}}function p(e,t){return{action:"MatrixActions.accountData",event:t,event_type:t.getType(),event_content:t.getContent()}}function g(e,t,s){return{action:"MatrixActions.Room.accountData",event:t,event_type:t.getType(),event_content:t.getContent(),room:s}}function v(e,t){return{action:"MatrixActions.Room",room:t}}function f(e,t,s){return{action:"MatrixActions.Room.tags",room:s}}function b(e,t,s){return{action:"MatrixActions.Room.receipt",event:t,room:s,matrixClient:e}}function y(e,t,s,n,i,o){return{action:"MatrixActions.Room.timeline",event:t,isLiveEvent:o.liveEvent,isLiveUnfilteredRoomTimelineEvent:s&&o.timeline.getTimelineSet()===s.getUnfilteredTimelineSet()}}function _(e,t,s,n){return{action:"MatrixActions.Room.myMembership",room:t,membership:s,oldMembership:n}}function E(e,t){return{action:"MatrixActions.Event.decrypted",event:t}}let S=[];function w(e,t,s){const n=(...t)=>{const n=s(e,...t);n&&h.a.dispatch(n,!0)};e.on(t,n),S.push(()=>{e.removeListener(t,n)})}var C={start(e){w(e,"sync",m),w(e,"accountData",p),w(e,"Room.accountData",g),w(e,"Room",v),w(e,"Room.tags",f),w(e,"Room.receipt",b),w(e,"Room.timeline",y),w(e,"Room.myMembership",_),w(e,"Event.decrypted",E)},stop(){S.forEach(e=>e()),S=[]}},k=s(99),O=s(312),R=s(343),I=s(337),x=s(200),T=s(181),j=s(275),N=s(221);class P{constructor(){i()(this,"opts",{initialSyncLimit:20}),i()(this,"matrixClient",null),i()(this,"justRegisteredUserId",void 0),i()(this,"currentClientCreds",void 0)}setIndexedDbWorkerScript(e){d.a.indexedDbWorkerScript=e}get(){return this.matrixClient}unset(){this.matrixClient=null,C.stop()}setJustRegisteredUserId(e){this.justRegisteredUserId=e,e&&window.localStorage.setItem("mx_registration_time",String((new Date).getTime()))}currentUserIsJustRegistered(){return this.matrixClient&&this.matrixClient.credentials.userId===this.justRegisteredUserId}userRegisteredWithinLastHours(e){try{const t=new Date(window.localStorage.getItem("mx_registration_time"));return((new Date).getTime()-t.getTime())/36e5<=e}catch(e){return!1}}replaceUsingCreds(e){this.currentClientCreds=e,this.createClient(e)}async assign(){for(const e of["indexeddb","memory"])try{const e=this.matrixClient.store.startup();console.log("MatrixClientPeg: waiting for MatrixClient store to initialise"),await e;break}catch(t){if("indexeddb"!==e)throw console.error("Failed to start memory store!",t),t;console.error("Error starting matrixclient store - falling back to memory store",t),this.matrixClient.store=new o.a({localStorage:localStorage})}I.f(this.matrixClient);try{!u.b.getValue("lowBandwidth")&&this.matrixClient.initCrypto&&(await this.matrixClient.initCrypto(),this.matrixClient.setCryptoTrustCrossSignedDevices(!u.b.getValue("e2ee.manuallyVerifyAllSessions")),await Object(T.f)(this.matrixClient),I.e(!0))}catch(e){if(e&&"InvalidCryptoStoreError"===e.name){const e=l.getComponent("views.dialogs.CryptoStoreTooNewDialog");k.a.createDialog(e)}console.warn("Unable to initialise e2e",e)}const e=a.h(this.opts);return e.pendingEventOrdering="detached",e.lazyLoadMembers=!0,e.clientWellKnownPollPeriod=7200,C.start(this.matrixClient),R.a.matrixClient=this.matrixClient,e}async start(){const e=await this.assign();console.log("MatrixClientPeg: really starting MatrixClient"),await this.get().startClient(e),console.log("MatrixClientPeg: MatrixClient started")}getCredentials(){return{homeserverUrl:this.matrixClient.baseUrl,identityServerUrl:this.matrixClient.idBaseUrl,userId:this.matrixClient.credentials.userId,deviceId:this.matrixClient.getDeviceId(),accessToken:this.matrixClient.getAccessToken(),guest:this.matrixClient.isGuest()}}getHomeserverName(){const e=/^@[^:]+:(.+)$/.exec(this.matrixClient.credentials.userId);if(null===e||e.length<1)throw new Error("Failed to derive homeserver name from user ID!");return e[1]}createClient(e){const t={baseUrl:e.homeserverUrl,idBaseUrl:e.identityServerUrl,accessToken:e.accessToken,userId:e.userId,deviceId:e.deviceId,pickleKey:e.pickleKey,timelineSupport:!0,forceTURN:!u.b.getValue("webRtcAllowPeerToPeer"),fallbackICEServerAllowed:!!u.b.getValue("fallbackICEServerAllowed"),iceCandidatePoolSize:20,verificationMethods:[O.d.SAS,j.d,O.d.RECIPROCATE_QR_CODE],unstableClientRelationAggregation:!0,identityServer:new x.a,cryptoCallbacks:{}};Object.assign(t.cryptoCallbacks,T.c),N.a.getDehydrationKey&&(t.cryptoCallbacks.getDehydrationKey=N.a.getDehydrationKey),this.matrixClient=Object(d.a)(t),this.matrixClient.setMaxListeners(500),this.matrixClient.setGuest(Boolean(e.guest));const s=new c.a(null,{timelineSupport:!0});s.getLiveTimeline().setPaginationToken("",r.a.BACKWARDS),this.matrixClient.setNotifTimelineSet(s)}}window.mxMatrixClientPeg||(window.mxMatrixClientPeg=new P);const D=window.mxMatrixClientPeg},function(e,t,s){"use strict";s.r(t),s.d(t,"loadSkin",(function(){return i})),s.d(t,"resetSkin",(function(){return o})),s.d(t,"getComponent",(function(){return a}));var n=s(766);s(1298);function i(e){n.a.load(e)}function o(){n.a.reset()}function a(e){return n.a.getComponent(e)}},function(e,t,s){"use strict";(function(e){s.d(t,"b",(function(){return a}));var n=s(771),i=s(355);class o extends n.Dispatcher{dispatch(e,t=!1){e instanceof i.a?e.fn(e=>{this.dispatch(e,t)}):t?super.dispatch(e):setTimeout(super.dispatch.bind(this,e),0)}fire(e,t=!1){this.dispatch({action:e},t)}}const a=new o,r=e;r.mxDispatcher||(r.mxDispatcher=a),t.a=a}).call(this,s(7))},,function(e,t,s){"use strict";s.d(t,"a",(function(){return j})),s.d(t,"b",(function(){return N}));var n=s(18),i=s.n(n),o=s(232),a=s(94),r=s(106),c=s(155);class l extends o.a{constructor(e,t){super(),this.featureNames=e,this.watchers=t}getValue(e,t){if(this.featureNames.includes(e))return this.readFeature(e);if("notificationsEnabled"===e){const e=localStorage.getItem("notifications_enabled");return"string"==typeof e?"true"===e:null}if("notificationBodyEnabled"===e){const e=localStorage.getItem("notifications_body_enabled");return"string"==typeof e?"true"===e:null}if("audioNotificationsEnabled"===e){const e=localStorage.getItem("audio_notifications_enabled");return"string"==typeof e?"true"===e:null}if(["showRightPanelInRoom","showRightPanelInGroup","lastRightPanelPhaseForRoom","lastRightPanelPhaseForGroup"].includes(e)){return JSON.parse(localStorage.getItem("mx_"+e)||"{}").value}if("layout"===e){const t=this.getSettings()||{};return t.useIRCLayout?c.a.IRC:"useBubbleLayout"in t&&!1===t.useBubbleLayout?c.a.Group:t[e]}return(this.getSettings()||{})[e]}setValue(e,t,s){if(this.featureNames.includes(e))return this.writeFeature(e,s),Promise.resolve();if("notificationsEnabled"===e)return localStorage.setItem("notifications_enabled",s),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve();if("notificationBodyEnabled"===e)return localStorage.setItem("notifications_body_enabled",s),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve();if("audioNotificationsEnabled"===e)return localStorage.setItem("audio_notifications_enabled",s),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve();if(["showRightPanelInRoom","showRightPanelInGroup","lastRightPanelPhaseForRoom","lastRightPanelPhaseForGroup"].includes(e))return localStorage.setItem("mx_"+e,JSON.stringify({value:s})),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve();if("layout"===e){const t=this.getSettings()||{};return delete t.useBubbleLayout,delete t.useIRCLayout,t.layout=s,localStorage.setItem("mx_local_settings",JSON.stringify(t)),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve()}const n=this.getSettings()||{};return n[e]=s,localStorage.setItem("mx_local_settings",JSON.stringify(n)),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve()}canSetValue(e,t){return!0}isSupported(){return void 0!==localStorage&&null!==localStorage}watchSetting(e,t,s){this.watchers.watchSetting(e,t,s)}unwatchSetting(e){this.watchers.unwatchSetting(e)}getSettings(){const e=localStorage.getItem("mx_local_settings");return e?JSON.parse(e):null}readFeature(e){if(a.a.get()&&a.a.get().isGuest())return!1;const t=localStorage.getItem("mx_labs_feature_"+e);return"true"===t||"false"!==t&&null}writeFeature(e,t){localStorage.setItem("mx_labs_feature_"+e,""+t),this.watchers.notifyUpdate(e,null,r.a.DEVICE,t)}}class d extends o.a{constructor(e){super(),this.watchers=e}getValue(e,t){if("blacklistUnverifiedDevices"===e){const e=this.read("mx_local_settings");if(e&&e.blacklistUnverifiedDevicesPerRoom)return e.blacklistUnverifiedDevicesPerRoom[t]}const s=this.read(this.getKey(e,t));return s?s.value:null}setValue(e,t,s){if("blacklistUnverifiedDevices"===e){let n=this.read("mx_local_settings");return n||(n={}),n.blacklistUnverifiedDevicesPerRoom||(n.blacklistUnverifiedDevicesPerRoom={}),n.blacklistUnverifiedDevicesPerRoom[t]=s,localStorage.setItem("mx_local_settings",JSON.stringify(n)),this.watchers.notifyUpdate(e,t,r.a.ROOM_DEVICE,s),Promise.resolve()}return null===s?localStorage.removeItem(this.getKey(e,t)):(s=JSON.stringify({value:s}),localStorage.setItem(this.getKey(e,t),s)),this.watchers.notifyUpdate(e,t,r.a.ROOM_DEVICE,s),Promise.resolve()}canSetValue(e,t){return!0}isSupported(){return void 0!==localStorage&&null!==localStorage}read(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null}getKey(e,t){return"mx_setting_"+e+"_"+t}}class u extends o.a{constructor(e,t){super(),this.defaults=e,this.invertedDefaults=t}getValue(e,t){let s=this.defaults[e];return void 0===s&&(s=this.invertedDefaults[e]),s}async setValue(e,t,s){throw new Error("Cannot set values on the default level handler")}canSetValue(e,t){return!1}isSupported(){return!0}}var h=s(343),m=s(141);class p extends h.a{constructor(e){super(),this.watchers=e,i()(this,"onAccountData",(e,t,s)=>{const n=t.roomId;if("org.matrix.room.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",n,r.a.ROOM_ACCOUNT,t)}else if("org.matrix.room.color_scheme"===e.getType())this.watchers.notifyUpdate("roomColor",n,r.a.ROOM_ACCOUNT,e.getContent());else if("im.vector.web.settings"===e.getType()){const t=s?s.getContent():{},i=Object(m.e)(t,e.getContent());for(const t of i){const s=e.getContent()[t];this.watchers.notifyUpdate(t,n,r.a.ROOM_ACCOUNT,s)}}else"im.vector.setting.allowed_widgets"===e.getType()&&this.watchers.notifyUpdate("allowedWidgets",n,r.a.ROOM_ACCOUNT,e.getContent())})}initMatrixClient(e,t){e&&e.removeListener("Room.accountData",this.onAccountData),t.on("Room.accountData",this.onAccountData)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}if("roomColor"===e)return this.getSettings(t,"org.matrix.room.color_scheme");if("allowedWidgets"===e)return this.getSettings(t,"im.vector.setting.allowed_widgets");return(this.getSettings(t)||{})[e]}setValue(e,t,s){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return e.disable=!s,a.a.get().setRoomAccountData(t,"org.matrix.room.preview_urls",e)}if("roomColor"===e)return a.a.get().setRoomAccountData(t,"org.matrix.room.color_scheme",s);if("allowedWidgets"===e)return a.a.get().setRoomAccountData(t,"im.vector.setting.allowed_widgets",s);const n=this.getSettings(t)||{};return n[e]=s,a.a.get().setRoomAccountData(t,"im.vector.web.settings",n)}canSetValue(e,t){const s=a.a.get().getRoom(t);return null!=s}isSupported(){const e=a.a.get();return null!=e&&!e.isGuest()}getSettings(e,t="im.vector.web.settings"){const s=a.a.get().getRoom(e);if(!s)return null;const n=s.getAccountData(t);return n&&n.getContent()?Object(m.a)(n.getContent()):null}}const g=["im.vector.riot.breadcrumb_rooms","im.vector.setting.breadcrumbs"];class v extends h.a{constructor(e){super(),this.watchers=e,i()(this,"onAccountData",(e,t)=>{if("org.matrix.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",null,r.a.ACCOUNT,t)}else if("im.vector.web.settings"===e.getType()){const s=t?t.getContent():{},n=Object(m.e)(s,e.getContent());for(const t of n){const s=e.getContent()[t];this.watchers.notifyUpdate(t,null,r.a.ACCOUNT,s)}}else if(g.includes(e.getType()))this.notifyBreadcrumbsUpdate(e);else if("im.vector.setting.integration_provisioning"===e.getType()){const t=e.getContent().enabled;this.watchers.notifyUpdate("integrationProvisioning",null,r.a.ACCOUNT,t)}else if("io.element.recent_emoji"===e.getType()){const t=e.getContent().enabled;this.watchers.notifyUpdate("recent_emoji",null,r.a.ACCOUNT,t)}})}initMatrixClient(e,t){e&&e.removeListener("accountData",this.onAccountData),t.on("accountData",this.onAccountData)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings("org.matrix.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}if("breadcrumb_rooms"===e){let e=this.getSettings("im.vector.setting.breadcrumbs");return e&&e.recent_rooms||(e=this.getSettings("im.vector.riot.breadcrumb_rooms"),e&&(e.recent_rooms=e.rooms)),e&&e.recent_rooms?e.recent_rooms:[]}if("recent_emoji"===e){const e=this.getSettings("io.element.recent_emoji");return e?e.recent_emoji:null}if("integrationProvisioning"===e){const e=this.getSettings("im.vector.setting.integration_provisioning");return e?e.enabled:null}const s=this.getSettings()||{};let n=s[e];return null==n&&("hideAvatarChanges"!==e&&"hideDisplaynameChanges"!==e||(n=s.hideAvatarDisplaynameChanges)),n}setValue(e,t,s){if("urlPreviewsEnabled"===e){const e=this.getSettings("org.matrix.preview_urls")||{};return e.disable=!s,a.a.get().setAccountData("org.matrix.preview_urls",e)}if("breadcrumb_rooms"===e){let e=this.getSettings("im.vector.setting.breadcrumbs");return e&&e.recent_rooms||(e=this.getSettings("im.vector.riot.breadcrumb_rooms")),e||(e={}),e.recent_rooms=s,a.a.get().setAccountData("im.vector.setting.breadcrumbs",e)}if("recent_emoji"===e){const e=this.getSettings("io.element.recent_emoji")||{};return e.recent_emoji=s,a.a.get().setAccountData("io.element.recent_emoji",e)}if("integrationProvisioning"===e){const e=this.getSettings("im.vector.setting.integration_provisioning")||{};return e.enabled=s,a.a.get().setAccountData("im.vector.setting.integration_provisioning",e)}const n=this.getSettings()||{};return n[e]=s,a.a.get().setAccountData("im.vector.web.settings",n)}canSetValue(e,t){return!0}isSupported(){const e=a.a.get();return null!=e&&!e.isGuest()}getSettings(e="im.vector.web.settings"){const t=a.a.get();if(!t)return null;const s=t.getAccountData(e);return s&&s.getContent()?Object(m.a)(s.getContent()):null}notifyBreadcrumbsUpdate(e){let t=[];if("im.vector.riot.breadcrumb_rooms"===e.getType()){const s=this.getSettings("im.vector.setting.breadcrumbs");t=s?s.recent_rooms:e.getContent().rooms}else{if("im.vector.setting.breadcrumbs"!==e.getType())return;t=e.getContent().recent_rooms}this.watchers.notifyUpdate("breadcrumb_rooms",null,r.a.ACCOUNT,t||[])}}class f extends h.a{constructor(e){super(),this.watchers=e,i()(this,"onEvent",(e,t,s)=>{const n=e.getRoomId(),i=this.client.getRoom(n);if(i&&(!i||t===i.currentState))if("org.matrix.room.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",n,r.a.ROOM,t)}else if("im.vector.web.settings"===e.getType()){const t=s?s.getContent():{},i=Object(m.e)(t,e.getContent());for(const t of i)this.watchers.notifyUpdate(t,n,r.a.ROOM,e.getContent()[t])}})}initMatrixClient(e,t){e&&e.removeListener("RoomState.events",this.onEvent),t.on("RoomState.events",this.onEvent)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}return(this.getSettings(t)||{})[e]}setValue(e,t,s){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return e.disable=!s,a.a.get().sendStateEvent(t,"org.matrix.room.preview_urls",e)}const n=this.getSettings(t)||{};return n[e]=s,a.a.get().sendStateEvent(t,"im.vector.web.settings",n,"")}canSetValue(e,t){const s=a.a.get(),n=s.getRoom(t);let i="im.vector.web.settings";return"urlPreviewsEnabled"===e&&(i="org.matrix.room.preview_urls"),!!n&&n.currentState.maySendStateEvent(i,s.getUserId())}isSupported(){const e=a.a.get();return null!=e}getSettings(e,t="im.vector.web.settings"){const s=a.a.get().getRoom(e);if(!s)return null;const n=s.currentState.getStateEvents(t,"");return n&&n.getContent()?Object(m.a)(n.getContent()):null}}var b=s(102),y=s(1);class _ extends o.a{constructor(e){super(),this.featureNames=e}getValue(e,t){const s=b.a.get()||{};if(this.featureNames.includes(e)){const t=(s.features||{})[e];return Object(y.t)(t)?null:!0===t||!1===t?t:"enable"===t||"disable"!==t&&null}if("theme"===e)return s.default_theme;const n=s.settingDefaults;return!n||Object(y.t)(n[e])?null:n[e]}async setValue(e,t,s){throw new Error("Cannot change settings at the config level")}canSetValue(e,t){return!1}isSupported(){return!0}}var E=s(92),S=s(96),w=s(741);class C extends o.a{constructor(e){super(),this.handler=e,i()(this,"cache",{})}getValue(e,t){const s=t||"UNDEFINED",n=this.cache[e];return n&&n.hasOwnProperty(s)?n[s]:this.handler.getValue(e,t)}setValue(e,t,s){this.cache[e]||(this.cache[e]={});const n=this.cache[e],i=t||"UNDEFINED";n[i]=s;const o=this.handler.setValue(e,t,s);return Promise.resolve(o).finally(()=>{delete n[i]})}canSetValue(e,t){return this.handler.canSetValue(e,t)}isSupported(){return this.handler.isSupported()}}const k=Symbol("irrelevant-room");const O=new class{constructor(){i()(this,"watchers",new Map)}watchSetting(e,t,s){this.watchers.has(e)||this.watchers.set(e,new Map),this.watchers.get(e).has(t)||this.watchers.get(e).set(t,[]),this.watchers.get(e).get(t).push(s)}unwatchSetting(e){this.watchers.forEach(t=>{t.forEach(t=>{let s;for(;-1!==(s=t.indexOf(e));)t.splice(s,1)})})}notifyUpdate(e,t,s,n){if(!this.watchers.has(e))return;const i=this.watchers.get(e),o=[];null!==t&&i.has(t)&&o.push(...i.get(t)),t?i.has(k)&&o.push(...i.get(k)):o.push(...Array.from(i.values()).flat(1));for(const e of o)e(t,s,n)}},R={},I={},x=[];for(const e of Object.keys(w.a))R[e]=w.a[e].default,w.a[e].isFeature&&x.push(e),w.a[e].invertedSettingName&&(I[w.a[e].invertedSettingName]=!w.a[e].default);const T={[r.a.DEVICE]:new l(x,O),[r.a.ROOM_DEVICE]:new d(O),[r.a.ROOM_ACCOUNT]:new p(O),[r.a.ACCOUNT]:new v(O),[r.a.ROOM]:new f(O),[r.a.CONFIG]:new _(x),[r.a.DEFAULT]:new u(R,I)};for(const e of Object.keys(T))T[e]=new C(T[e]);const j=[r.a.DEVICE,r.a.ROOM_DEVICE,r.a.ROOM_ACCOUNT,r.a.ACCOUNT,r.a.ROOM,r.a.CONFIG,r.a.DEFAULT];class N{static getFeatureSettingNames(){return Object.keys(w.a).filter(e=>N.isFeature(e))}static watchSetting(e,t,s){const n=w.a[e],i=e;if(!n)throw new Error(e+" is not a setting");n.invertedSettingName&&(e=n.invertedSettingName);const o=`${(new Date).getTime()}_${N.watcherCount++}_${e}_${t}`,a=(e,t,n)=>{const o=N.getValue(i);s(i,e,t,n,o)};return N.watchers.set(o,a),O.watchSetting(e,t,a),o}static unwatchSetting(e){N.watchers.has(e)?(O.unwatchSetting(N.watchers.get(e)),N.watchers.delete(e)):console.warn("Ending non-existent watcher ID "+e)}static monitorSetting(e,t){t=t||null,this.monitors.has(e)||this.monitors.set(e,new Map);const s=()=>{this.monitors.get(e).set(t,N.watchSetting(e,t,(e,t,s,n,i)=>{S.a.dispatch({action:"setting_updated",settingName:e,roomId:t,level:s,newValueAtLevel:n,newValue:i})}))},n=Array.from(this.monitors.get(e).keys());n.find(e=>e===t||null===e)?null===t&&(n.forEach(t=>{N.unwatchSetting(this.monitors.get(e).get(t))}),this.monitors.get(e).clear(),s()):s()}static getDisplayName(e,t=r.a.DEFAULT){if(!w.a[e]||!w.a[e].displayName)return null;let s=w.a[e].displayName;return s instanceof Object&&(s=s[t]?s[t]:s.default),Object(E.a)(s)}static getDescription(e){var t;return null!==(t=w.a[e])&&void 0!==t&&t.description?Object(E.a)(w.a[e].description):null}static isFeature(e){return!!w.a[e]&&w.a[e].isFeature}static getBetaInfo(e){var t;if(N.isFeature(e)&&!1!==N.getValueAt(r.a.CONFIG,e,null,!0,!0))return null===(t=w.a[e])||void 0===t?void 0:t.betaInfo}static isEnabled(e){return!!w.a[e]&&(!w.a[e].controller||!w.a[e].controller.settingDisabled)}static getValue(e,t=null,s=!1){if(!w.a[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");const n=w.a[e],i=n.supportedLevelsAreOrdered?n.supportedLevels:j;return N.getValueAt(i[0],e,t,!1,s)}static getValueAt(e,t,s=null,n=!1,i=!1){const o=w.a[t];if(!o)throw new Error("Setting '"+t+"' does not appear to be a setting.");const a=o.supportedLevelsAreOrdered?o.supportedLevels:j;a.includes(r.a.DEFAULT)||a.push(r.a.DEFAULT);const c=a.indexOf(e);if(-1===c)throw new Error("Level "+e+" is not prioritized");const l=N.getHandlers(t);if(o.invertedSettingName&&(t=o.invertedSettingName),n){const n=l[e];if(!n)return N.getFinalValue(o,e,s,null,null);const i=n.getValue(t,s);return N.getFinalValue(o,e,s,i,e)}for(let n=c;n<a.length;n++){const r=l[a[n]];if(!r)continue;if(i&&"default"===a[n])continue;const c=r.getValue(t,s);if(null!=c)return N.getFinalValue(o,e,s,c,a[n])}return N.getFinalValue(o,e,s,null,null)}static getDefaultValue(e){if(!w.a[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");return w.a[e].default}static getFinalValue(e,t,s,n,i){let o=n;if(e.controller){const a=e.controller.getValueOverride(t,s,n,i);null!=a&&(o=a)}return e.invertedSettingName&&(o=!o),o}static async setValue(e,t,s,n){const i=w.a[e];if(!i)throw new Error("Setting '"+e+"' does not appear to be a setting.");const o=N.getHandler(e,s);if(!o)throw new Error("Setting "+e+" does not have a handler for "+s);if(i.invertedSettingName&&(e=i.invertedSettingName,n=!n),!o.canSetValue(e,t))throw new Error("User cannot set "+e+" at "+s+" in "+t);await o.setValue(e,t,n);const a=i.controller;a&&a.onChange(s,t,n)}static canSetValue(e,t,s){var n;if(!w.a[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");if(N.isFeature(e)&&(null===(n=w.a[e])||void 0===n||!n.betaInfo)){const s=N.getValueAt(r.a.CONFIG,e,t,!0,!0);if(!0===s||!1===s)return!1}const i=N.getHandler(e,s);return!!i&&i.canSetValue(e,t)}static isLevelSupported(e){return!!T[e]&&T[e].isSupported()}static firstSupportedLevel(e){const t=w.a[e];if(!t)throw new Error("Setting '"+e+"' does not appear to be a setting.");const s=t.supportedLevelsAreOrdered?t.supportedLevels:j;s.includes(r.a.DEFAULT)||s.push(r.a.DEFAULT);const n=N.getHandlers(e);for(const e of s){if(n[e])return e}return null}static debugSetting(e,t){console.log("--- DEBUG "+e);const s=w.a[e];console.log("--- definition: "+(s?JSON.stringify(s):"<NOT_FOUND>")),console.log("--- default level order: "+JSON.stringify(j)),console.log("--- registered handlers: "+JSON.stringify(Object.keys(T)));const n=e=>{for(const s of Object.keys(T)){const n=T[s];try{const i=n.getValue(e,t);console.log(`---     ${s}@${t||"<no_room>"} = ${JSON.stringify(i)}`)}catch(e){console.log(`---     ${n}@${t||"<no_room>"} THREW ERROR: ${e.message}`),console.error(e)}if(t)try{const t=n.getValue(e,null);console.log(`---     ${s}@<no_room> = ${JSON.stringify(t)}`)}catch(e){console.log(`---     ${n}@<no_room> THREW ERROR: ${e.message}`),console.error(e)}}console.log("--- calculating as returned by SettingsStore"),console.log("--- these might not match if the setting uses a controller - be warned!");try{const s=N.getValue(e,t);console.log(`---     SettingsStore#generic@${t||"<no_room>"}  = ${JSON.stringify(s)}`)}catch(e){console.log(`---     SettingsStore#generic@${t||"<no_room>"} THREW ERROR: ${e.message}`),console.error(e)}if(t)try{const t=N.getValue(e,null);console.log("---     SettingsStore#generic@<no_room>  = "+JSON.stringify(t))}catch(e){console.log("---     SettingsStore#generic@$<no_room> THREW ERROR: "+e.message),console.error(e)}for(const s of j){try{const n=N.getValueAt(s,e,t);console.log(`---     SettingsStore#${s}@${t||"<no_room>"} = ${JSON.stringify(n)}`)}catch(e){console.log(`---     SettingsStore#${s}@${t||"<no_room>"} THREW ERROR: ${e.message}`),console.error(e)}if(t)try{const t=N.getValueAt(s,e,null);console.log(`---     SettingsStore#${s}@<no_room> = ${JSON.stringify(t)}`)}catch(e){console.log(`---     SettingsStore#${s}@$<no_room> THREW ERROR: ${e.message}`),console.error(e)}}};n(e),s.invertedSettingName&&(console.log("--- TESTING INVERTED SETTING NAME"),console.log("--- inverted: "+s.invertedSettingName),n(s.invertedSettingName)),console.log("--- END DEBUG")}static getHandler(e,t){const s=N.getHandlers(e);return s[t]?s[t]:null}static getHandlers(e){if(!w.a[e])return{};const t={};for(const s of w.a[e].supportedLevels){if(!T[s])throw new Error("Unexpected level "+s);N.isLevelSupported(s)&&(t[s]=T[s])}return t.default||(t.default=T.default),t}}i()(N,"watchers",new Map),i()(N,"monitors",new Map),i()(N,"watcherCount",1),window.mxSettingsStore=N},function(e,t,s){"use strict";(function(e){var n=s(104),i=s.n(n),o=s(18),a=s.n(o),r=s(91),c=s.n(r),l=s(147),d=s.n(l),u=s(101),h=s.n(u),m=s(132),p=s(96),g=s(149),v=s(775);class f{constructor(){a()(this,"counter",0),a()(this,"priorityModal",null),a()(this,"staticModal",null),a()(this,"modals",[]),a()(this,"onBackgroundClick",()=>{const e=this.getCurrentModal();e&&(e.closeReason="backgroundClick",e.close(),e.closeReason=null)})}static getOrCreateContainer(){let e=document.getElementById("mx_Dialog_Container");return e||(e=document.createElement("div"),e.id="mx_Dialog_Container",document.body.appendChild(e)),e}static getOrCreateStaticContainer(){let e=document.getElementById("mx_Dialog_StaticContainer");return e||(e=document.createElement("div"),e.id="mx_Dialog_StaticContainer",document.body.appendChild(e)),e}toggleCurrentDialogVisibility(){const e=this.getCurrentModal();e&&(e.hidden=!e.hidden)}hasDialogs(){return this.priorityModal||this.staticModal||this.modals.length>0}createTrackedDialog(e,t,...s){return m.a.trackEvent("Modal",e,t),this.createDialog(...s)}appendTrackedDialog(e,t,...s){return m.a.trackEvent("Modal",e,t),this.appendDialog(...s)}createDialog(e,...t){return this.createDialogAsync(Promise.resolve(e),...t)}appendDialog(e,...t){return this.appendDialogAsync(Promise.resolve(e),...t)}createTrackedDialogAsync(e,t,...s){return m.a.trackEvent("Modal",e,t),this.createDialogAsync(...s)}appendTrackedDialogAsync(e,t,...s){return m.a.trackEvent("Modal",e,t),this.appendDialogAsync(...s)}closeCurrentModal(e){const t=this.getCurrentModal();t&&(t.closeReason=e,t.close())}buildModal(e,t,s,n){const o={onFinished:t?t.onFinished:null,onBeforeClose:n.onBeforeClose,beforeClosePromise:null,closeReason:null,className:s,elem:null,close:null},[a,r]=this.getCloseFn(o,t),l=this.counter++;return o.elem=c.a.createElement(v.a,i()({key:l,prom:e},t,{onFinished:a})),o.close=a,{modal:o,closeDialog:a,onFinishedProm:r}}getCloseFn(e,t){const s=Object(g.a)();return[async(...n)=>{if(e.beforeClosePromise)await e.beforeClosePromise;else if(e.onBeforeClose){e.beforeClosePromise=e.onBeforeClose(e.closeReason);const t=await e.beforeClosePromise;if(e.beforeClosePromise=null,!t)return}s.resolve(n),t&&t.onFinished&&t.onFinished.apply(null,n);const i=this.modals.indexOf(e);i>=0&&this.modals.splice(i,1),this.priorityModal===e&&(this.priorityModal=null,this.modals=[]),this.staticModal===e&&(this.staticModal=null,this.modals=[]),this.reRender()},s.promise]}createDialogAsync(e,t,s,n=!1,i=!1,o={}){const{modal:a,closeDialog:r,onFinishedProm:c}=this.buildModal(e,t,s,o);return n?this.priorityModal=a:i?this.staticModal=a:this.modals.unshift(a),this.reRender(),{close:r,finished:c}}appendDialogAsync(e,t,s){const{modal:n,closeDialog:i,onFinishedProm:o}=this.buildModal(e,t,s,{});return this.modals.push(n),this.reRender(),{close:i,finished:o}}getCurrentModal(){return this.priorityModal?this.priorityModal:this.modals[0]||this.staticModal}reRender(){if(0===this.modals.length&&!this.priorityModal&&!this.staticModal)return p.a.dispatch({action:"aria_unhide_main_app"}),d.a.unmountComponentAtNode(f.getOrCreateContainer()),void d.a.unmountComponentAtNode(f.getOrCreateStaticContainer());if(p.a.dispatch({action:"aria_hide_main_app"}),this.staticModal){const e=h()("mx_Dialog_wrapper mx_Dialog_staticWrapper",this.staticModal.className),t=c.a.createElement("div",{className:e},c.a.createElement("div",{className:"mx_Dialog"},this.staticModal.elem),c.a.createElement("div",{className:"mx_Dialog_background mx_Dialog_staticBackground",onClick:this.onBackgroundClick}));d.a.render(t,f.getOrCreateStaticContainer())}else d.a.unmountComponentAtNode(f.getOrCreateStaticContainer());const t=this.getCurrentModal();if(t===this.staticModal||t.hidden)d.a.unmountComponentAtNode(f.getOrCreateContainer());else{const s=h()("mx_Dialog_wrapper",t.className,{mx_Dialog_wrapperWithStaticUnder:this.staticModal}),n=c.a.createElement("div",{className:s},c.a.createElement("div",{className:"mx_Dialog"},t.elem),c.a.createElement("div",{className:"mx_Dialog_background",onClick:this.onBackgroundClick}));e(()=>d.a.render(n,f.getOrCreateContainer()))}}}window.singletonModalManager||(window.singletonModalManager=new f),t.a=window.singletonModalManager}).call(this,s(169).setImmediate)},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(108),i=s.n(n),o=s(91),a=s.n(o),r=s(111),c=s(101),l=s.n(c);function d(e){let{element:t,onClick:s,children:n,kind:o,disabled:c,inputRef:d,className:u,onKeyDown:h,onKeyUp:m}=e,p=i()(e,["element","onClick","children","kind","disabled","inputRef","className","onKeyDown","onKeyUp"]);const g=p;return c||(g.onClick=s,g.onKeyDown=e=>{if(e.key===r.a.ENTER)return e.stopPropagation(),e.preventDefault(),s(e);e.key===r.a.SPACE?(e.stopPropagation(),e.preventDefault()):null==h||h(e)},g.onKeyUp=e=>{if(e.key===r.a.SPACE)return e.stopPropagation(),e.preventDefault(),s(e);e.key===r.a.ENTER?(e.stopPropagation(),e.preventDefault()):null==m||m(e)}),g.ref=d,g.className=l()("mx_AccessibleButton",u,{mx_AccessibleButton_hasKind:o,["mx_AccessibleButton_kind_"+o]:o,mx_AccessibleButton_disabled:c}),a.a.createElement(t,p,n)}d.defaultProps={element:"div",role:"button",tabIndex:0},d.displayName="AccessibleButton"},,function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(18),i=s.n(n);const o={brand:"SchildiChat",integrations_ui_url:"https://scalar.vector.im/",integrations_rest_url:"https://scalar.vector.im/api",bug_report_endpoint_url:null,jitsi:{preferredDomain:"meet.jit.si"},desktopBuilds:{available:!0,logo:s(770),url:"https://schildi.chat/desktop"}};class a{static setInstance(e){a.instance=e,window.mxReactSdkConfig=e}static get(){return a.instance||{}}static put(e){const t=Object.keys(o);for(let s=0;s<t.length;++s)void 0===e[t[s]]&&(e[t[s]]=o[t[s]]);a.setInstance(e)}static unset(){a.setInstance({})}static add(e){const t=a.get(),s=Object.assign({},t,e);a.put(s)}}i()(a,"instance",void 0)},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.ViewUser="view_user",e.ViewUserSettings="view_user_settings",e.ViewRoomDirectory="view_room_directory",e.RecheckTheme="recheck_theme",e.CheckUpdates="check_updates",e.FocusComposer="focus_composer",e.ToggleUserMenu="toggle_user_menu",e.UpdateFontSize="update_font_size",e.UpdateSystemFont="update_system_font",e.ViewRoomDelta="view_room_delta",e.SetRightPanelPhase="set_right_panel_phase",e.ToggleRightPanel="toggle_right_panel",e.AfterRightPanelPhaseChange="after_right_panel_phase_change",e.OpenDialPad="open_dial_pad",e.DialNumber="dial_number",e.PstnSupportUpdated="pstn_support_updated",e.VirtualRoomSupportUpdated="virtual_room_support_updated",e.UploadStarted="upload_started",e.UploadProgress="upload_progress",e.UploadFinished="upload_finished",e.UploadFailed="upload_failed",e.UploadCanceled="upload_canceled",e.JoinRoom="join_room",e.JoinRoomReady="join_room_ready",e.JoinRoomError="join_room_error",e.ComposerInsert="composer_insert",e.SwitchSpace="switch_space"}(n||(n={}))},,function(e,t,s){"use strict";var n=s(91);const i=Object(n.createContext)(void 0);i.displayName="MatrixClientContext",t.a=i},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.DEVICE="device",e.ROOM_DEVICE="room-device",e.ROOM_ACCOUNT="room-account",e.ACCOUNT="account",e.ROOM="room",e.CONFIG="config",e.DEFAULT="default"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return c}));var n=s(18),i=s.n(n),o=s(94);class a{constructor(e,t){if(this.prepared=e,i()(this,"client",void 0),this.client=null!=t?t:o.a.get(),!this.client)throw new Error("No possible MatrixClient for media resolution. Please provide one or log in.")}get isEncrypted(){return!!this.prepared.file}get srcMxc(){return this.prepared.mxc}get thumbnailMxc(){var e;return null===(e=this.prepared.thumbnail)||void 0===e?void 0:e.mxc}get hasThumbnail(){return!!this.thumbnailMxc}get srcHttp(){return this.client.mxcUrlToHttp(this.srcMxc)}get thumbnailHttp(){return this.hasThumbnail?this.client.mxcUrlToHttp(this.thumbnailMxc):null}getThumbnailHttp(e,t,s="scale"){return this.hasThumbnail?(e=Math.floor(e*window.devicePixelRatio),t=Math.floor(t*window.devicePixelRatio),this.client.mxcUrlToHttp(this.thumbnailMxc,e,t,s)):null}getThumbnailOfSourceHttp(e,t,s="scale"){return e=Math.floor(e*window.devicePixelRatio),t=Math.floor(t*window.devicePixelRatio),this.client.mxcUrlToHttp(this.srcMxc,e,t,s)}getSquareThumbnailHttp(e){return e=Math.floor(e*window.devicePixelRatio),this.hasThumbnail?this.getThumbnailHttp(e,e,"crop"):this.getThumbnailOfSourceHttp(e,e,"crop")}downloadSource(){return fetch(this.srcHttp)}}function r(e,t){return new a(function(e){var t,s,n,i;let o=null;if(null!=e&&null!==(t=e.info)&&void 0!==t&&t.thumbnail_url?o={mxc:e.info.thumbnail_url,file:e.info.thumbnail_file}:null!=e&&null!==(s=e.info)&&void 0!==s&&null!==(n=s.thumbnail_file)&&void 0!==n&&n.url&&(o={mxc:e.info.thumbnail_file.url,file:e.info.thumbnail_file}),null!=e&&e.url)return{thumbnail:o,mxc:e.url,file:e.file};if(null!=e&&null!==(i=e.file)&&void 0!==i&&i.url)return{thumbnail:o,mxc:e.file.url,file:e.file};throw new Error("Invalid file provided: cannot determine MXC URI. Has it been redacted?")}(e),t)}function c(e,t){return r({url:e},t)}},,function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return N})),s.d(t,"b",(function(){return P})),s.d(t,"p",(function(){return D})),s.d(t,"k",(function(){return A})),s.d(t,"l",(function(){return M})),s.d(t,"m",(function(){return U})),s.d(t,"q",(function(){return L})),s.d(t,"o",(function(){return F})),s.d(t,"n",(function(){return B}));var n=s(104),i=s.n(n),o=s(18),a=s.n(o),r=s(91),c=s.n(r),l=s(147),d=s.n(l),u=s(101),h=s.n(u),m=s(111),p=s(93),g=s(154),v=s(480);s.d(t,"c",(function(){return v.a}));var f=s(262);s.d(t,"d",(function(){return f.a}));var b=s(481);s.d(t,"e",(function(){return b.a}));var y=s(482);s.d(t,"f",(function(){return y.a}));var _=s(483);s.d(t,"g",(function(){return _.a}));var E=s(484);s.d(t,"h",(function(){return E.a}));var S=s(485);s.d(t,"i",(function(){return S.a}));var w,C,k,O,R=s(486);function I(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function x(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?I(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):I(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}s.d(t,"j",(function(){return R.a}));function T(){let e=document.getElementById("mx_ContextualMenu_Container");return e||(e=document.createElement("div"),e.id="mx_ContextualMenu_Container",document.body.appendChild(e)),e}const j=new Set(["menuitem","menuitemcheckbox","menuitemradio"]);let N;!function(e){e.Top="top",e.Bottom="bottom",e.Left="left",e.Right="right",e.None="none"}(N||(N={}));let P=Object(p.a)("structures.ContextMenu")((k=C=class extends c.a.PureComponent{constructor(t,s){super(t,s),a()(this,"initialFocus",void 0),a()(this,"collectContextMenuRect",e=>{if(!e)return;let t=e.querySelector('[role^="menuitem"]');t||(t=e.querySelector("[tab-index]")),t&&t.focus(),this.setState({contextMenuElem:e})}),a()(this,"onContextMenu",t=>{if(this.props.onFinished){this.props.onFinished(),t.preventDefault(),t.stopPropagation();const s=t.clientX,n=t.clientY;e(()=>{const e=document.createEvent("MouseEvents");e.initMouseEvent("contextmenu",!0,!0,window,0,0,0,s,n,!1,!1,!1,!1,0,null),document.elementFromPoint(s,n).dispatchEvent(e)})}}),a()(this,"onContextMenuPreventBubbling",e=>{e.stopPropagation()}),a()(this,"onFinished",e=>{e.stopPropagation(),e.preventDefault(),this.props.onFinished&&this.props.onFinished()}),a()(this,"onMoveFocus",(e,t)=>{let s=!1;do{const n=t?e.lastElementChild:e.firstElementChild,i=t?e.previousElementSibling:e.nextElementSibling;s?n?e=n:i?e=i:(s=!1,e=e.parentElement):i?(e=i,s=!0):e=e.parentElement,e&&e.classList.contains("mx_ContextualMenu")&&(e=t?e.lastElementChild:e.firstElementChild,s=!0)}while(e&&!j.has(e.getAttribute("role")));e&&e.focus()}),a()(this,"onMoveFocusHomeEnd",(e,t)=>{let s=e.querySelectorAll('[role^="menuitem"]');s||(s=e.querySelectorAll("[tab-index]")),s&&s.length&&(t?s[0].focus():s[s.length-1].focus())}),a()(this,"onKeyDown",e=>{if(e.stopPropagation(),!this.props.managed)return void(e.key===m.a.ESCAPE&&(this.props.onFinished(),e.preventDefault()));let t=!0;switch(e.key){case m.a.TAB:case m.a.ESCAPE:case m.a.ARROW_LEFT:case m.a.ARROW_RIGHT:this.props.onFinished();break;case m.a.ARROW_UP:this.onMoveFocus(e.target,!0);break;case m.a.ARROW_DOWN:this.onMoveFocus(e.target,!1);break;case m.a.HOME:this.onMoveFocusHomeEnd(this.state.contextMenuElem,!0);break;case m.a.END:this.onMoveFocusHomeEnd(this.state.contextMenuElem,!1);break;default:t=!1}t&&e.preventDefault()}),this.state={contextMenuElem:null},this.initialFocus=document.activeElement}componentWillUnmount(){this.initialFocus.focus()}renderMenu(e=this.props.hasBackground){const t={},s=this.props;let n;s.top?t.top=s.top:t.bottom=s.bottom,s.left?(t.left=s.left,n=N.Left):(t.right=s.right,n=N.Right);const i=this.state.contextMenuElem?this.state.contextMenuElem.getBoundingClientRect():null,o={};s.chevronFace&&(n=s.chevronFace);const a=n&&n!==N.None;if(n===N.Top||n===N.Bottom)o.left=s.chevronOffset;else if(void 0!==t.top){const e=t.top;let n=e;if(i){const e=10;n=Math.min(t.top,document.body.clientHeight-i.height-e)}t.top=n,o.top=Math.max(s.chevronOffset,s.chevronOffset+e-n)}let r;a&&(r=c.a.createElement("div",{style:o,className:"mx_ContextualMenu_chevron_"+n}));const l=h()({mx_ContextualMenu:!0,mx_ContextualMenu_left:!a&&t.left,mx_ContextualMenu_right:!a&&t.right,mx_ContextualMenu_top:!a&&t.top,mx_ContextualMenu_bottom:!a&&t.bottom,mx_ContextualMenu_withChevron_left:n===N.Left,mx_ContextualMenu_withChevron_right:n===N.Right,mx_ContextualMenu_withChevron_top:n===N.Top,mx_ContextualMenu_withChevron_bottom:n===N.Bottom}),d={};s.menuWidth&&(d.width=s.menuWidth),s.menuHeight&&(d.height=s.menuHeight),isNaN(Number(s.menuPaddingTop))||(d.paddingTop=s.menuPaddingTop),isNaN(Number(s.menuPaddingLeft))||(d.paddingLeft=s.menuPaddingLeft),isNaN(Number(s.menuPaddingBottom))||(d.paddingBottom=s.menuPaddingBottom),isNaN(Number(s.menuPaddingRight))||(d.paddingRight=s.menuPaddingRight);const u={};let m;return isNaN(Number(s.zIndex))||(d.zIndex=s.zIndex+1,u.zIndex=s.zIndex),e&&(m=c.a.createElement("div",{className:"mx_ContextualMenu_background",style:u,onClick:this.onFinished,onContextMenu:this.onContextMenu})),c.a.createElement("div",{className:h()("mx_ContextualMenu_wrapper",this.props.wrapperClassName),style:x(x({},t),u),onKeyDown:this.onKeyDown,onContextMenu:this.onContextMenuPreventBubbling},c.a.createElement("div",{className:l,style:d,ref:this.collectContextMenuRect,role:this.props.managed?"menu":void 0},r,s.children),m)}render(){return d.a.createPortal(this.renderMenu(),T())}},a()(C,"defaultProps",{hasBackground:!0,managed:!0}),w=k))||w;const D=(e,t=12)=>{const s=e.right+window.pageXOffset+3;let n=e.top+e.height/2+window.pageYOffset;return n-=t+8,{left:s,top:n,chevronOffset:t}},A=(e,t=N.None,s=0)=>{const n={chevronFace:t},i=e.right+window.pageXOffset,o=e.bottom+window.pageYOffset,a=e.top+window.pageYOffset;return n.right=g.b.instance.windowWidth-i,o<g.b.instance.windowHeight/2?n.top=o+s:n.bottom=g.b.instance.windowHeight-a+s,n},M=(e,t=N.None,s=0)=>{const n={chevronFace:t},i=e.right+window.pageXOffset,o=e.bottom+window.pageYOffset,a=e.top+window.pageYOffset;return n.right=g.b.instance.windowWidth-i,o<g.b.instance.windowHeight/2?n.top=o+s:n.bottom=g.b.instance.windowHeight-a+s,n},U=(e,t=N.None,s=0)=>{const n={chevronFace:t},i=e.left+window.pageXOffset,o=e.top+window.pageYOffset;return n.left=i,n.bottom=g.b.instance.windowHeight-o+s,n},L=()=>{const e=Object(r.useRef)(null),[t,s]=Object(r.useState)(!1);return[t,e,()=>{s(!0)},()=>{s(!1)},s]};let F=Object(p.a)("structures.LegacyContextMenu")(O=class extends P{render(){return this.renderMenu(!1)}})||O;function B(e,t){const s=function(...e){d.a.unmountComponentAtNode(T()),t&&t.onFinished&&t.onFinished.apply(null,e)},n=c.a.createElement(F,i()({},t,{onFinished:s,windowResize:s}),c.a.createElement(e,i()({},t,{onFinished:s})));return d.a.render(n,T()),{close:s}}}).call(this,s(169).setImmediate)},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"c",(function(){return o})),s.d(t,"b",(function(){return a})),s.d(t,"d",(function(){return r})),s.d(t,"e",(function(){return c})),s.d(t,"g",(function(){return l})),s.d(t,"f",(function(){return d})),s.d(t,"j",(function(){return u})),s.d(t,"i",(function(){return h})),s.d(t,"h",(function(){return m}));class n extends class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}matches(e){return this.name===e||this.altName===e}findIn(e){let t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}includedIn(e){let t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}let i,o,a;!function(e){e.RoomCanonicalAlias="m.room.canonical_alias",e.RoomCreate="m.room.create",e.RoomJoinRules="m.room.join_rules",e.RoomMember="m.room.member",e.RoomThirdPartyInvite="m.room.third_party_invite",e.RoomPowerLevels="m.room.power_levels",e.RoomName="m.room.name",e.RoomTopic="m.room.topic",e.RoomAvatar="m.room.avatar",e.RoomPinnedEvents="m.room.pinned_events",e.RoomEncryption="m.room.encryption",e.RoomHistoryVisibility="m.room.history_visibility",e.RoomGuestAccess="m.room.guest_access",e.RoomServerAcl="m.room.server_acl",e.RoomTombstone="m.room.tombstone",e.RoomAliases="m.room.aliases",e.SpaceChild="m.space.child",e.SpaceParent="m.space.parent",e.RoomRedaction="m.room.redaction",e.RoomMessage="m.room.message",e.RoomMessageEncrypted="m.room.encrypted",e.Sticker="m.sticker",e.CallInvite="m.call.invite",e.CallCandidates="m.call.candidates",e.CallAnswer="m.call.answer",e.CallHangup="m.call.hangup",e.CallReject="m.call.reject",e.CallSelectAnswer="m.call.select_answer",e.CallNegotiate="m.call.negotiate",e.CallReplaces="m.call.replaces",e.CallAssertedIdentity="m.call.asserted_identity",e.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",e.KeyVerificationRequest="m.key.verification.request",e.KeyVerificationStart="m.key.verification.start",e.KeyVerificationCancel="m.key.verification.cancel",e.KeyVerificationMac="m.key.verification.mac",e.KeyVerificationDone="m.key.verification.done",e.RoomMessageFeedback="m.room.message.feedback",e.Reaction="m.reaction",e.Typing="m.typing",e.Receipt="m.receipt",e.Presence="m.presence",e.FullyRead="m.fully_read",e.Tag="m.tag",e.SpaceOrder="org.matrix.msc3230.space_order",e.PushRules="m.push_rules",e.Direct="m.direct",e.IgnoredUserList="m.ignored_user_list",e.RoomKey="m.room_key",e.RoomKeyRequest="m.room_key_request",e.ForwardedRoomKey="m.forwarded_room_key",e.Dummy="m.dummy"}(i||(i={})),function(e){e.Annotation="m.annotation",e.Replace="m.replace"}(o||(o={})),function(e){e.Text="m.text",e.Emote="m.emote",e.Notice="m.notice",e.Image="m.image",e.File="m.file",e.Audio="m.audio",e.Location="m.location",e.Video="m.video"}(a||(a={}));const r="type";let c;!function(e){e.Space="m.space"}(c||(c={}));const l=new n("m.room.purpose","org.matrix.msc3088.purpose"),d=new n("m.enabled","org.matrix.msc3088.enabled"),u=new n("m.data_tree","org.matrix.msc3089.data_tree"),h=new n("m.leaf","org.matrix.msc3089.leaf"),m=new n("m.branch","org.matrix.msc3089.branch")},function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i})),s.d(t,"d",(function(){return o})),s.d(t,"c",(function(){return a}));const n={HOME:"Home",END:"End",PAGE_UP:"PageUp",PAGE_DOWN:"PageDown",BACKSPACE:"Backspace",DELETE:"Delete",ARROW_UP:"ArrowUp",ARROW_DOWN:"ArrowDown",ARROW_LEFT:"ArrowLeft",ARROW_RIGHT:"ArrowRight",TAB:"Tab",ESCAPE:"Escape",ENTER:"Enter",ALT:"Alt",CONTROL:"Control",META:"Meta",SHIFT:"Shift",CONTEXT_MENU:"ContextMenu",COMMA:",",PERIOD:".",LESS_THAN:"<",GREATER_THAN:">",BACKTICK:"`",SPACE:" ",SLASH:"/",SQUARE_BRACKET_LEFT:"[",SQUARE_BRACKET_RIGHT:"]",A:"a",B:"b",C:"c",D:"d",E:"e",F:"f",G:"g",H:"h",I:"i",J:"j",K:"k",L:"l",M:"m",N:"n",O:"o",P:"p",Q:"q",R:"r",S:"s",T:"t",U:"u",V:"v",W:"w",X:"x",Y:"y",Z:"z"},i=navigator.platform.toUpperCase().indexOf("MAC")>=0;function o(e){return i?e.metaKey&&!e.altKey&&!e.ctrlKey&&!e.shiftKey:e.ctrlKey&&!e.altKey&&!e.metaKey&&!e.shiftKey}function a(e){return i?e.metaKey&&!e.altKey&&!e.ctrlKey:e.ctrlKey&&!e.altKey&&!e.metaKey}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(108),i=s.n(n),o=s(18),a=s.n(o),r=s(91),c=s.n(r),l=s(101),d=s.n(l),u=s(95),h=s(117);function m(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function p(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?m(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let g=1;class v extends c.a.PureComponent{constructor(e){super(e),a()(this,"id",void 0),a()(this,"input",void 0),a()(this,"validateOnChange",Object(h.debounce)(()=>{this.validate({focused:!0})},200)),a()(this,"onFocus",e=>{this.setState({focused:!0}),this.props.validateOnFocus&&this.validate({focused:!0}),this.props.onFocus&&this.props.onFocus(e)}),a()(this,"onChange",e=>{this.props.validateOnChange&&this.validateOnChange(),this.props.onChange&&this.props.onChange(e)}),a()(this,"onBlur",e=>{this.setState({focused:!1}),this.props.validateOnBlur&&this.validate({focused:!1}),this.props.onBlur&&this.props.onBlur(e)}),this.state={valid:void 0,feedback:void 0,feedbackVisible:!1,focused:!1},this.id=this.props.id||"mx_Field_"+g++}focus(){this.input.focus()}async validate({focused:e,allowEmpty:t=!0}){if(!this.props.onValidate)return;const s=this.input?this.input.value:null,{valid:n,feedback:i}=await this.props.onValidate({value:s,focused:e,allowEmpty:t});return this.state.focused&&i?this.setState({valid:n,feedback:i,feedbackVisible:!0}):this.setState({valid:n,feedbackVisible:!1}),n}render(){const e=this.props,{element:t,prefixComponent:s,postfixComponent:n,className:o,onValidate:a,children:r,tooltipContent:l,forceValidity:h,tooltipClassName:m,list:g,validateOnBlur:v,validateOnChange:f,validateOnFocus:b}=e,y=i()(e,["element","prefixComponent","postfixComponent","className","onValidate","children","tooltipContent","forceValidity","tooltipClassName","list","validateOnBlur","validateOnChange","validateOnFocus"]);y.placeholder=y.placeholder||y.label,y.id=this.id,y.onFocus=this.onFocus,y.onChange=this.onChange,y.onBlur=this.onBlur;const _=p(p({},y),{},{ref:e=>this.input=e,list:g}),E=c.a.createElement(this.props.element,_,r);let S=null;s&&(S=c.a.createElement("span",{className:"mx_Field_prefix"},s));let w=null;n&&(w=c.a.createElement("span",{className:"mx_Field_postfix"},n));const C=null!=h,k=d()("mx_Field","mx_Field_"+this.props.element,o,{mx_Field_labelAlwaysTopLeft:s,mx_Field_valid:C?h:a&&!0===this.state.valid,mx_Field_invalid:C?!h:a&&!1===this.state.valid}),O=u.getComponent("elements.Tooltip");let R;return(l||this.state.feedback)&&(R=c.a.createElement(O,{tooltipClassName:d()("mx_Field_tooltip",m),visible:this.state.focused&&this.props.forceTooltipVisible||this.state.feedbackVisible,label:l||this.state.feedback,alignment:O.Alignment.Right})),c.a.createElement("div",{className:k},S,E,c.a.createElement("label",{htmlFor:this.id},this.props.label),w,R)}}a()(v,"defaultProps",{element:"input",type:"text",validateOnFocus:!0,validateOnBlur:!0,validateOnChange:!0})},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i=s(104),o=s.n(i),a=s(108),r=s.n(a),c=s(18),l=s.n(c),d=s(91),u=s.n(d),h=s(101),m=s.n(h),p=s(100),g=s(185),v=s(93);let f=Object(v.a)("views.elements.AccessibleTooltipButton")(n=class extends u.a.PureComponent{constructor(e){super(e),l()(this,"onMouseOver",()=>{this.props.forceHide||this.setState({hover:!0})}),l()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}componentDidUpdate(e){!e.forceHide&&this.props.forceHide&&this.state.hover&&this.setState({hover:!1})}render(){const e=this.props,{title:t,tooltip:s,children:n,tooltipClassName:i,forceHide:a,yOffset:c,alignment:l}=e,d=r()(e,["title","tooltip","children","tooltipClassName","forceHide","yOffset","alignment"]),h=this.state.hover?u.a.createElement(g.b,{className:"mx_AccessibleTooltipButton_container",tooltipClassName:m()("mx_AccessibleTooltipButton_tooltip",i),label:s||t,yOffset:c,alignment:l}):null;return u.a.createElement(p.a,o()({},d,{onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,"aria-label":t}),n,h)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return h}));var n=s(115),i=s.n(n),o=s(8),a=s(0),r=s(110),c=s(1);let l;!function(e){e.NOT_SENT="not_sent",e.ENCRYPTING="encrypting",e.SENDING="sending",e.QUEUED="queued",e.SENT="sent",e.CANCELLED="cancelled"}(l||(l={}));const d={};function u(e){return d[e]||(d[e]=e),d[e]}class h extends o.EventEmitter{constructor(e={}){super(),this.event=e,i()(this,"pushActions",null),i()(this,"_replacingEvent",null),i()(this,"_localRedactionEvent",null),i()(this,"_isCancelled",!1),i()(this,"clearEvent",{}),i()(this,"senderCurve25519Key",null),i()(this,"claimedEd25519Key",null),i()(this,"forwardingCurve25519KeyChain",[]),i()(this,"untrusted",null),i()(this,"_decryptionPromise",null),i()(this,"retryDecryption",!1),i()(this,"txnId",null),i()(this,"localTimestamp",void 0),i()(this,"sender",null),i()(this,"target",null),i()(this,"status",null),i()(this,"error",null),i()(this,"forwardLooking",!0),i()(this,"verificationRequest",null),["state_key","type","sender","room_id","membership"].forEach(t=>{"string"==typeof e[t]&&(e[t]=u(e[t]))}),["membership","avatar_url","displayname"].forEach(t=>{var s;"string"==typeof(null===(s=e.content)||void 0===s?void 0:s[t])&&(e.content[t]=u(e.content[t]))}),["rel_type"].forEach(t=>{var s,n;"string"==typeof(null===(s=e.content)||void 0===s||null===(n=s["m.relates_to"])||void 0===n?void 0:n[t])&&(e.content["m.relates_to"][t]=u(e.content["m.relates_to"][t]))}),this.txnId=e.txn_id||null,this.localTimestamp=Date.now()-this.getAge()}getId(){return this.event.event_id}getSender(){return this.event.sender||this.event.user_id}getType(){return this.clearEvent.type||this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent.content||this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}getPrevContent(){return this.getUnsigned().prev_content||this.event.prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age||this.event.age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}makeEncrypted(e,t,s,n){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=s,this.claimedEd25519Key=n}isBeingDecrypted(){return null!=this._decryptionPromise}getDecryptionPromise(){return this._decryptionPromise}isDecryptionFailure(){var e,t;return"m.bad.encrypted"===(null===(e=this.clearEvent)||void 0===e||null===(t=e.content)||void 0===t?void 0:t.msgtype)}shouldAttemptDecryption(){return this.isEncrypted()&&!this.isBeingDecrypted()&&null===this.getClearContent()}async attemptDecryption(e,t={}){if("boolean"==typeof t&&(t={isRetry:t}),!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");if(this.clearEvent&&this.clearEvent.content&&"m.bad.encrypted"!==this.clearEvent.content.msgtype)throw new Error("Attempt to decrypt event which has already been decrypted");return this._decryptionPromise?(a.a.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this.retryDecryption=!0,this._decryptionPromise):(this._decryptionPromise=this.decryptionLoop(e,t),this._decryptionPromise)}cancelAndResendKeyRequest(e,t){const s=this.getWireContent();return e.requestRoomKey({algorithm:s.algorithm,room_id:this.getRoomId(),session_id:s.session_id,sender_key:s.sender_key},this.getKeyRequestRecipients(t),!0)}getKeyRequestRecipients(e){const t=this.getWireContent(),s=[{userId:e,deviceId:"*"}],n=this.getSender();return n!==e&&s.push({userId:n,deviceId:t.device_id}),s}async decryptionLoop(e,t={}){for(await Promise.resolve();;){let s,n;this.retryDecryption=!1;try{e?(s=await e.decryptEvent(this),!0===t.isRetry&&a.a.info(`Decrypted event on retry (id=${this.getId()})`)):s=this.badEncryptedMessage("Encryption not enabled")}catch(e){if("DecryptionError"!==e.name){const s=t.isRetry?"re":"";return a.a.error(`Error ${s}decrypting event (id=${this.getId()}): ${e.stack||e}`),this._decryptionPromise=null,void(this.retryDecryption=!1)}if(n=e,this.retryDecryption){a.a.log(`Got error decrypting event (id=${this.getId()}: `+e+"), but retrying");continue}a.a.warn(`Error decrypting event (id=${this.getId()}): ${e.detailedString}`),s=this.badEncryptedMessage(e.message)}return this._decryptionPromise=null,this.retryDecryption=!1,this.setClearData(s),this.setPushActions(null),void(!1!==t.emit&&this.emit("Event.decrypted",this,n))}}badEncryptedMessage(e){return{clearEvent:{type:"m.room.message",content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+e+" **"}}}}setClearData(e){this.clearEvent=e.clearEvent,this.senderCurve25519Key=e.senderCurve25519Key||null,this.claimedEd25519Key=e.claimedEd25519Key||null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1}getClearContent(){const e=this.clearEvent;return e&&e.content?e.content:null}isEncrypted(){return!this.isState()&&"m.room.encrypted"===this.event.type}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return{ed25519:this.claimedEd25519Key}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return this.untrusted}getUnsigned(){return this.event.unsigned||{}}unmarkLocallyRedacted(){const e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=null),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit("Event.beforeRedaction",this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}makeRedacted(e){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");let t;for(t in this._localRedactionEvent=null,this.emit("Event.beforeRedaction",this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event,this.event)this.event.hasOwnProperty(t)&&(m.has(t)||delete this.event[t]);const s=p[this.getType()]||{},n=this.getContent();for(t in n)n.hasOwnProperty(t)&&(s[t]||delete n[t])}isRedacted(){return Boolean(this.getUnsigned().redacted_because)}isRedaction(){return"m.room.redaction"===this.getType()}getRedactionEvent(){return this.isRedacted()?this.clearEvent.unsigned?this.clearEvent.unsigned.redacted_because:this.event.unsigned.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushActions}setPushActions(e){this.pushActions=e}handleRemoteEcho(e){const t=this.getUnsigned(),s=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==s&&this.emit("Event.localEventIdReplaced",this)}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit("Event.status",this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit("Event.localEventIdReplaced",this)}isRelation(e){const t=this.getWireContent(),s=t&&t["m.relates_to"];return s&&s.rel_type&&s.event_id&&(e&&s.rel_type===e||!e)}getRelation(){return this.isRelation()?this.getWireContent()["m.relates_to"]:null}makeReplaced(e){this.isRedacted()&&e||this._replacingEvent!==e&&(this._replacingEvent=e,this.emit("Event.replaced",this))}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){const t=this.getUnsigned()["m.relations"];if(t)return t[e]}replacingEventId(){const e=this.getServerAggregatedRelation(r.c.Replace);return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){const e=this.getServerAggregatedRelation(r.c.Replace);if(e){const t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent)return this._replacingEvent.getDate()}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){const e=this.getRelation();return e?e.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssocation(){return!!this.getAssociatedId()}updateAssociatedId(e){const t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(e=!0){this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){const e=new h(JSON.parse(JSON.stringify(this.event)));for(const[t,s]of Object.entries(this))"event"!==t&&(e[t]=s);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;const t=Object(c.i)(this.event),s=Object(c.i)(e.event);return JSON.stringify(t)===JSON.stringify(s)}toJSON(){const e={type:this.getType(),sender:this.getSender(),content:this.getContent(),event_id:this.getId(),origin_server_ts:this.getTs(),unsigned:this.getUnsigned(),room_id:this.getRoomId()};return this.isRedaction()&&(e.redacts=this.event.redacts),this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setVerificationRequest(e){this.verificationRequest=e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}}const m=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),p={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}}},,function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.AdvancedEncryption="UIFeature.advancedEncryption",e.URLPreviews="UIFeature.urlPreviews",e.Widgets="UIFeature.widgets",e.Voip="UIFeature.voip",e.Feedback="UIFeature.feedback",e.Registration="UIFeature.registration",e.PasswordReset="UIFeature.passwordReset",e.Deactivate="UIFeature.deactivate",e.ShareQRCode="UIFeature.shareQrCode",e.ShareSocial="UIFeature.shareSocial",e.IdentityServer="UIFeature.identityServer",e.ThirdPartyID="UIFeature.thirdPartyId",e.Flair="UIFeature.flair",e.Communities="UIFeature.communities",e.AdvancedSettings="UIFeature.advancedSettings",e.RoomHistorySettings="UIFeature.roomHistorySettings"}(n||(n={}))},,function(e,t,s){"use strict";var n=s(18),i=s.n(n);class o{constructor(){i()(this,"platform",null)}get(){return this.platform}set(e){this.platform=e}}window.mxPlatformPeg||(window.mxPlatformPeg=new o),t.a=window.mxPlatformPeg},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(97),a=s.n(o),r=s(92),c=s(98);const l=({w:e=32,h:t=32,imgClassName:n,message:o})=>{let a;return a=c.b.getValue("feature_new_spinner")?i.a.createElement("img",{src:s(490),width:e,height:t,className:n,"aria-label":Object(r.a)("Loading...")}):i.a.createElement("div",{className:"mx_Spinner_icon",style:{width:e,height:t},"aria-label":Object(r.a)("Loading...")}),i.a.createElement("div",{className:"mx_Spinner"},o&&i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_Spinner_Msg"},o)," "),a)};l.propTypes={w:a.a.number,h:a.a.number,imgClassName:a.a.string,message:a.a.node},t.a=l},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n=s(108),i=s.n(n),o=s(18),a=s.n(o),r=s(186),c=s(92),l=s(118),d=s(102),u=s(94),h=s(149),m=s(133),p=s(103);function g(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function v(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?g(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):g(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}var f;!function(e){e.Landscape="landscape",e.Portrait="portrait"}(f||(f={}));const b=async e=>{const t=(new TextEncoder).encode(e),s=await window.crypto.subtle.digest("sha-256",t);return[...new Uint8Array(s)].map(e=>e.toString(16).padStart(2,"0")).join("")},y=new Set(["register","login","forgot_password","soft_logout","new","settings","welcome","home","start","directory","start_sso","start_cas","groups","complete_security","post_registration","room","user","group"]);const _=e=>{var t,s;const n=u.a.get(),i=null==n?void 0:n.getRoom(e);return{num_users:null==i?void 0:i.getJoinedMemberCount(),is_encrypted:null==n?void 0:n.isRoomEncrypted(e),is_public:"public"===(null==i||null===(t=i.currentState.getStateEvents("m.room.join_rules",""))||void 0===t||null===(s=t.getContent())||void 0===s?void 0:s.join_rule)}};class E{constructor(){a()(this,"baseUrl",null),a()(this,"appKey",null),a()(this,"userKey",null),a()(this,"anonymous",void 0),a()(this,"appPlatform",void 0),a()(this,"appVersion","unknown"),a()(this,"initTime",E.getTimestamp()),a()(this,"firstPage",!0),a()(this,"heartbeatIntervalId",void 0),a()(this,"activityIntervalId",void 0),a()(this,"trackTime",!0),a()(this,"lastBeat",void 0),a()(this,"storedDuration",0),a()(this,"lastView",void 0),a()(this,"lastViewTime",0),a()(this,"lastViewStoredDuration",0),a()(this,"sessionStarted",!1),a()(this,"heartbeatEnabled",!1),a()(this,"inactivityCounter",0),a()(this,"pendingEvents",[]),a()(this,"lastMsTs",0),a()(this,"getOrientation",()=>window.matchMedia("(orientation: landscape)").matches?f.Landscape:f.Portrait),a()(this,"reportOrientation",()=>{this.track("[CLY]_orientation",{mode:this.getOrientation()})}),a()(this,"endSession",()=>{this.sessionStarted&&(window.removeEventListener("resize",this.reportOrientation),this.reportViewDuration(),this.request({end_session:1,session_duration:E.getTimestamp()-this.lastBeat})),this.sessionStarted=!1}),a()(this,"onVisibilityChange",()=>{document.hidden?this.stopTime():this.startTime()}),a()(this,"onUserActivity",()=>{this.inactivityCounter>=20&&this.startTime(),this.inactivityCounter=0})}static get instance(){return E.internalInstance}get disabled(){return!this.baseUrl}canEnable(){var e,t;const s=d.a.get();return Boolean("1"!==navigator.doNotTrack&&(null==s||null===(e=s.countly)||void 0===e?void 0:e.url)&&(null==s||null===(t=s.countly)||void 0===t?void 0:t.appKey))}async changeUserKey(e,t=!1){const s=this.userKey;this.userKey=e,s&&t&&await this.request({old_device_id:s})}async enable(e=!0){if(!this.disabled&&this.anonymous===e)return;if(!this.canEnable())return;this.disabled||this.request();const t=d.a.get();this.baseUrl=new URL("/i",t.countly.url),this.appKey=t.countly.appKey,this.anonymous=e,e?await this.changeUserKey(Object(r.b)(64)):await this.changeUserKey(await b(u.a.get().getUserId()),!0);const s=l.a.get();this.appPlatform=s.getHumanReadableName();try{this.appVersion=await s.getAppVersion()}catch(e){console.warn("Failed to get app version, using 'unknown'")}this.heartbeatIntervalId=setInterval(this.heartbeat.bind(this),5e3),this.trackSessions(),this.trackErrors()}async disable(){this.disabled||(await this.track("Opt-Out"),this.endSession(),window.clearInterval(this.heartbeatIntervalId),window.clearTimeout(this.activityIntervalId),this.baseUrl=null,window.removeEventListener("beforeunload",this.endSession),window.removeEventListener("unload",this.endSession),window.removeEventListener("visibilitychange",this.onVisibilityChange),window.removeEventListener("mousemove",this.onUserActivity),window.removeEventListener("click",this.onUserActivity),window.removeEventListener("keydown",this.onUserActivity),window.removeEventListener("scroll",this.onUserActivity))}reportFeedback(e,t){this.track("[CLY]_star_rating",{rating:e,comment:t},null,{},!0)}trackPageChange(e){this.disabled||this.trackPageView()}async trackPageView(){this.reportViewDuration(),await Object(h.c)(0);const e=await async function(e=!0){const t=Object(r.b)(8),{origin:s,hash:n}=window.location;let{pathname:i}=window.location;s.startsWith("file://")&&(i=`/<redacted_${t}>/`);let[o,a,...c]=n.split("/");y.has(a)||(a=`<redacted_${t}>`);for(let s=0;s<c.length;s++)c[s]=e?`<redacted_${t}>`:await b(c[s]);const l=s+i+`${o}/${a}/${c.join("/")}`,d={};let u="$/"+n;switch(a){case"room":{u="view_room";const e=m.a.getRoomId();u+=" "+c[0],d.room_id=c[0],Object.assign(d,_(e));break}}return{name:u,url:l,meta:d}}(this.anonymous),t=e.name;this.lastView=t,this.lastViewTime=E.getTimestamp();const s=v(v({},e.meta),{},{name:t,visit:1,domain:window.location.hostname,view:e.url,segment:this.appPlatform,start:this.firstPage});this.firstPage&&(this.firstPage=!1),this.track("[CLY]_view",s)}static getTimestamp(){return Math.floor((new Date).getTime()/1e3)}getMsTimestamp(){const e=(new Date).getTime();return this.lastMsTs>=e?this.lastMsTs++:this.lastMsTs=e,this.lastMsTs}async recordError(e,t=!1){if(this.disabled||this.anonymous)return;let s="";"object"==typeof e?void 0!==e.stack?s=e.stack:(void 0!==e.name&&(s+=e.name+":"),void 0!==e.message&&(s+=e.message+"\n"),void 0!==e.fileName&&(s+="in "+e.fileName+"\n"),void 0!==e.lineNumber&&(s+="on "+e.lineNumber),void 0!==e.columnNumber&&(s+=":"+e.columnNumber)):s=e+"",s=await(async(e,t,s)=>{const n=[];e.replace(t,(...e)=>(n.push(s(...e)),""));const i=await Promise.all(n);return e.replace(t,()=>i.shift())})(s,/([!@+#]).+?:[\w:.]+/g,async(e,t)=>t+await b(e.substring(1)));const n=this.getMetrics(),i={_resolution:null==n?void 0:n._resolution,_error:s,_app_version:this.appVersion,_run:E.getTimestamp()-this.initTime,_nonfatal:!t,_view:this.lastView};void 0!==navigator.onLine&&(i._online=navigator.onLine),i._background=document.hasFocus(),this.request({crash:JSON.stringify(i)})}trackErrors(){window.onerror=(e,t,s,n,i)=>{if(void 0!==i)this.recordError(i,!1);else{let i="";void 0!==e&&(i+=e+"\n"),void 0!==t&&(i+="at "+t),void 0!==s&&(i+=":"+s),void 0!==n&&(i+=":"+n),i+="\n";try{const e=[];let t=arguments.callee.caller;for(;t;)e.push(t.name),t=t.caller;i+=e.join("\n")}catch(e){}this.recordError(i,!1)}},window.addEventListener("unhandledrejection",e=>{var t;this.recordError(new Error(`Unhandled rejection (reason: ${(null===(t=e.reason)||void 0===t?void 0:t.stack)||e.reason}).`),!0)})}heartbeat(){const e={};if(this.sessionStarted&&this.trackTime){const t=E.getTimestamp();t-this.lastBeat>=60&&(e.session_duration=t-this.lastBeat,this.lastBeat=t)}(this.pendingEvents.length>0||e.session_duration)&&this.request(e)}async request(e={}){const t=v(v({app_key:this.appKey,device_id:this.userKey},this.getTimeParams()),e);if(this.pendingEvents.length>0){const e=10,s=this.pendingEvents.splice(0,e);t.events=JSON.stringify(s)}const s=new URLSearchParams(t);try{await window.fetch(this.baseUrl.toString(),{method:"POST",mode:"no-cors",cache:"no-cache",redirect:"follow",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s})}catch(e){console.error("Analytics error: ",e)}}getTimeParams(){const e=new Date;return{timestamp:this.getMsTimestamp(),hour:e.getHours(),dow:e.getDay()}}queue(e){const{count:t=1}=e,s=i()(e,["count"]),n=v(v(v({},this.getTimeParams()),s),{},{count:t,platform:this.appPlatform,app_version:this.appVersion});this.pendingEvents.push(n),this.pendingEvents.length>1e3&&this.pendingEvents.shift()}startTime(){this.trackTime||(this.trackTime=!0,this.lastBeat=E.getTimestamp()-this.storedDuration,this.lastViewTime=E.getTimestamp()-this.lastViewStoredDuration,this.lastViewStoredDuration=0)}stopTime(){this.trackTime&&(this.trackTime=!1,this.storedDuration=E.getTimestamp()-this.lastBeat,this.lastViewStoredDuration=E.getTimestamp()-this.lastViewTime)}getMetrics(){if(this.anonymous)return;const e={};return e._app_version=this.appVersion,e._ua=navigator.userAgent,screen.width&&screen.height&&(e._resolution=`${screen.width}x${screen.height}`),window.devicePixelRatio&&(e._density=window.devicePixelRatio),e._locale=Object(c.d)(),e}async beginSession(e=!0){if(!this.sessionStarted){this.reportOrientation(),window.addEventListener("resize",this.reportOrientation),this.lastBeat=E.getTimestamp(),this.sessionStarted=!0,this.heartbeatEnabled=e;const t={custom:{home_server:u.a.get()&&u.a.getHomeserverName(),anonymous:this.anonymous}},s={begin_session:1,user_details:JSON.stringify(t)},n=this.getMetrics();n&&(s.metrics=JSON.stringify(n)),await this.request(s)}}reportViewDuration(){this.lastView&&(this.track("[CLY]_view",{name:this.lastView},null,{dur:this.trackTime?E.getTimestamp()-this.lastViewTime:this.lastViewStoredDuration}),this.lastView=null)}trackSessions(){this.beginSession(),this.startTime(),window.addEventListener("beforeunload",this.endSession),window.addEventListener("unload",this.endSession),window.addEventListener("visibilitychange",this.onVisibilityChange),window.addEventListener("mousemove",this.onUserActivity),window.addEventListener("click",this.onUserActivity),window.addEventListener("keydown",this.onUserActivity),window.addEventListener("scroll",this.onUserActivity,{passive:!0}),this.activityIntervalId=setInterval(()=>{this.inactivityCounter++,this.inactivityCounter>=20&&this.stopTime()},6e4)}trackBeginInvite(e){this.track("begin_invite",{},e)}trackSendInvite(e,t,s){this.track("send_invite",{},t,{dur:E.getTimestamp()-e,sum:s})}async trackRoomCreate(e,t){if(this.disabled)return;let s=E.getTimestamp();const n=u.a.get();n.getRoom(t)||(await new Promise(e=>{const s=i=>{i.roomId===t&&(n.off("Room",s),e())};n.on("Room",s)}),s=E.getTimestamp()),this.track("create_room",{},t,{dur:s-e})}trackRoomJoin(e,t,s){this.track(p.a.JoinRoom,{type:s},t,{dur:E.getTimestamp()-e})}async trackSendMessage(e,t,s,n,i,o){if(this.disabled)return;const a=u.a.get().getRoom(s),r=(await t).event_id;let c=E.getTimestamp();a.findEventById(r)||(await new Promise(e=>{const t=s=>{s.getId()===r&&(a.off("Room.localEchoUpdated",t),e())};a.on("Room.localEchoUpdated",t)}),c=E.getTimestamp()),this.track("send_message",{is_edit:n,is_reply:i,msgtype:o.msgtype,format:o.format},s,{dur:c-e})}trackStartCall(e,t=!1,s=!1){this.track("start_call",{is_video:t,is_jitsi:s},e)}trackJoinCall(e,t=!1,s=!1){this.track("join_call",{is_video:t,is_jitsi:s},e)}trackRoomDirectoryBegin(){this.track("room_directory")}trackRoomDirectory(e){this.track("room_directory_done",{},null,{dur:E.getTimestamp()-e})}trackRoomDirectorySearch(e,t){this.track("room_directory_search",{query_length:t.length,query_num_words:t.split(" ").length},null,{sum:e})}async track(e,t,s,n,i=!1){if(this.disabled&&!i)return;let o=t||{};s&&(o=v(v({room_id:await b(s)},_(s)),t)),this.queue(v({key:e,count:1,segmentation:o},n)),this.disabled&&i&&await this.request({device_id:Object(r.b)(64)})}}a()(E,"internalInstance",new E),window.mxCountlyAnalytics=E},function(e,t,s){"use strict";s.d(t,"c",(function(){return i})),s.d(t,"i",(function(){return o})),s.d(t,"g",(function(){return a})),s.d(t,"h",(function(){return r})),s.d(t,"j",(function(){return c})),s.d(t,"b",(function(){return l})),s.d(t,"e",(function(){return d})),s.d(t,"d",(function(){return u})),s.d(t,"a",(function(){return h})),s.d(t,"k",(function(){return m})),s.d(t,"f",(function(){return p})),s.d(t,"l",(function(){return g}));var n=s(9);function i(e,t){if(e.length===t)return e;const s=[];if(e.length>t){const n=Math.round(e.length/t);for(let t=0;t<e.length;t+=n)s.push(e[t])}else{const n=Math.ceil(t/e.length);for(const t of e)s.push(...r(t,n))}return c(s,t,r(e[e.length-1],t))}function o(e,t){if(e.length===t)return e;let s=[];if(e.length>t){for(;s.length>2*t||0===s.length;){s=[];for(let t=1;t<e.length-1;t+=2){const n=(e[t-1]+e[t+1]+e[t])/3;s.push(n)}e=s}return i(s,t)}return i(e,t)}function a(e,t,s){const i=Math.min(...e),o=Math.max(...e);return e.map(e=>Object(n.d)(Object(n.c)(e,i,o),t,s))}function r(e,t){const s=[];for(let n=0;n<t;n++)s.push(e);return s}function c(e,t,s){return e.length===t?e:e.length>t?e.slice(0,t):e.concat(s.slice(0,t-e.length))}function l(e){return e.slice(0,e.length)}function d(e,t){if(e.length===t.length){for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!0;return!1}return!0}function u(e,t){return e.length!==t.length||(!!t.some(t=>!e.includes(t))||!!e.some(e=>!t.includes(e)))}function h(e,t){return{added:t.filter(t=>!e.includes(t)),removed:e.filter(e=>!t.includes(e))}}function m(e,t){return e.filter(e=>t.includes(e))}function p(...e){return Array.from(e.reduce((e,t)=>(t.forEach(t=>e.add(t)),e),new Set))}function g(e,t,s){const n=Array.from(e),[i]=n.splice(t,1);return n.splice(s,0,i),n}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g})),s.d(t,"e",(function(){return v})),s.d(t,"h",(function(){return f})),s.d(t,"g",(function(){return b})),s.d(t,"f",(function(){return y})),s.d(t,"d",(function(){return _})),s.d(t,"k",(function(){return E})),s.d(t,"l",(function(){return S})),s.d(t,"c",(function(){return w})),s.d(t,"j",(function(){return k})),s.d(t,"i",(function(){return O})),s.d(t,"b",(function(){return j}));var n=s(18),i=s.n(n),o=s(787),a=s.n(o),r=s(1),c=s(110),l=s(94),d=s(501),u=s(502);class h extends u.b{constructor(e){if(super(),i()(this,"elementUrl",void 0),this.elementUrl=e,!this.elementUrl.startsWith("http:")&&!this.elementUrl.startsWith("https:"))throw new Error("Element prefix URL does not appear to be an HTTP(S) URL")}forEvent(e,t,s){return`${this.elementUrl}/#/room/${e}/${t}${this.encodeServerCandidates(s)}`}forRoom(e,t){return`${this.elementUrl}/#/room/${e}${this.encodeServerCandidates(t)}`}forUser(e){return`${this.elementUrl}/#/user/${e}`}forGroup(e){return`${this.elementUrl}/#/group/${e}`}forEntity(e){if("!"===e[0]||"#"===e[0])return this.forRoom(e);if("@"===e[0])return this.forUser(e);if("+"===e[0])return this.forGroup(e);throw new Error("Unrecognized entity")}isPermalinkHost(e){const t=new URL(this.elementUrl);return e===(t.host||t.hostname)}encodeServerCandidates(e){return e&&0!==e.length?"?via="+e.map(e=>encodeURIComponent(e)).join("&via="):""}parsePermalink(e){if(!e||!e.startsWith(this.elementUrl))throw new Error("Does not appear to be a permalink");const t=e.substring((this.elementUrl+"/#/").length);return h.parseAppRoute(t)}static parseAppRoute(e){const t=e.split("/");if(t.length<2)throw new Error("URL is missing parts");const[s]=t.splice(-1,1),[n,i=""]=s.split("?");t.push(n);const o=t[0],a=t[1];if("user"===o)return u.a.forUser(a);if("group"===o)return u.a.forGroup(a);if("room"===o){const e=t.length>2?t.slice(2).join("/"):"",s=i.split(/&?via=/).filter(e=>!!e);return u.a.forEvent(a,e,s)}throw new Error("Unknown entity type in permalink")}}var m=s(361),p=s(102);class g{constructor(e,t=null){if(i()(this,"room",void 0),i()(this,"roomId",void 0),i()(this,"highestPlUserId",void 0),i()(this,"populationMap",void 0),i()(this,"bannedHostsRegexps",void 0),i()(this,"allowedHostsRegexps",void 0),i()(this,"_serverCandidates",void 0),i()(this,"started",void 0),i()(this,"onRoomState",e=>{switch(e.getType()){case c.a.RoomServerAcl:return this.updateAllowedServers(),this.updateHighestPlUser(),this.updatePopulationMap(),void this.updateServerCandidates();case c.a.RoomPowerLevels:return this.updateHighestPlUser(),void this.updateServerCandidates()}}),i()(this,"onMembership",(e,t,s)=>{const n=t.userId,i=t.membership,o=R(n),a="join"!==s&&"join"===i;"join"===s&&"join"!==i?this.populationMap[o]--:a&&this.populationMap[o]++,this.updateHighestPlUser(),this.updateServerCandidates()}),this.room=e,this.roomId=e?e.roomId:t,this.highestPlUserId=null,this.populationMap=null,this.bannedHostsRegexps=null,this.allowedHostsRegexps=null,this._serverCandidates=null,this.started=!1,!this.roomId)throw new Error("Failed to resolve a roomId for the permalink creator to use")}load(){this.room&&this.room.currentState?(this.updateAllowedServers(),this.updateHighestPlUser(),this.updatePopulationMap(),this.updateServerCandidates()):console.warn("Tried to load a permalink creator with no room state")}start(){this.load(),this.room.on("RoomMember.membership",this.onMembership),this.room.on("RoomState.events",this.onRoomState),this.started=!0}stop(){this.room.removeListener("RoomMember.membership",this.onMembership),this.room.removeListener("RoomState.events",this.onRoomState),this.started=!1}get serverCandidates(){return this._serverCandidates}isStarted(){return this.started}forEvent(e){return C().forEvent(this.roomId,e,this._serverCandidates)}forShareableRoom(){if(this.room){const e=this.room.getCanonicalAlias();if(e)return C().forRoom(e)}return C().forRoom(this.roomId,this._serverCandidates)}forRoom(){return C().forRoom(this.roomId,this._serverCandidates)}updateHighestPlUser(){const e=this.room.currentState.getStateEvents("m.room.power_levels","");if(e){const t=e.getContent();if(t){const e=t.users;if(e){const t=Object.entries(e).filter(([e])=>{const t=this.room.getMember(e);if(!t||"join"!==t.membership)return!1;const s=R(e);return!T(s)&&!x(s,this.bannedHostsRegexps)&&x(s,this.allowedHostsRegexps)}).reduce((e,t)=>t[1]>e[1]?t:e,[null,0]),[s,n]=t;if(null!==s&&n>=50)return void(this.highestPlUserId=s)}}}this.highestPlUserId=null}updateAllowedServers(){const e=[];let t=[new RegExp(".*")];if(this.room.currentState){const s=this.room.currentState.getStateEvents("m.room.server_acl","");if(s&&s.getContent()){const n=e=>new RegExp("^"+r.q(e,!1)+"$");(s.getContent().deny||[]).forEach(t=>e.push(n(t)));const i=s.getContent().allow||[];t=[],i.forEach(e=>t.push(n(e)))}}this.bannedHostsRegexps=e,this.allowedHostsRegexps=t}updatePopulationMap(){const e={};for(const t of this.room.getJoinedMembers()){const s=R(t.userId);e[s]||(e[s]=0),e[s]++}this.populationMap=e}updateServerCandidates(){let e=[];this.highestPlUserId&&e.push(R(this.highestPlUserId));const t=Object.keys(this.populationMap).sort((e,t)=>this.populationMap[t]-this.populationMap[e]).filter(t=>!e.includes(t)&&!T(t)&&!x(t,this.bannedHostsRegexps)&&x(t,this.allowedHostsRegexps)).slice(0,3-e.length);e=e.concat(t),this._serverCandidates=e}}function v(e){return C().forEntity(e)}function f(e){return C().forUser(e)}function b(e){if(!e)throw new Error("can't permalink a falsey roomId");if("!"!==e[0])return C().forRoom(e,[]);const t=l.a.get().getRoom(e);if(!t)return C().forRoom(e,[]);const s=new g(t);return s.load(),s.forShareableRoom()}function y(e){return C().forGroup(e)}function _(e){return!!(new d.b).isPermalinkHost(e)||C().isPermalinkHost(e)}function E(e){return e?"#"===e[0]||"!"===e[0]?b(e):"@"===e[0]?f(e):"+"===e[0]?y(e):S(e):null}function S(e){if(!e.startsWith("http:")&&!e.startsWith("https:"))return e;try{const t=decodeURIComponent(e).match(m.a.ELEMENT_URL_PATTERN);if(t)return t[1]}catch(t){return e}try{const t=k(e);if(t)if(t.roomIdOrAlias){const s=t.eventId?"/"+t.eventId:"";e=`#/room/${t.roomIdOrAlias}${s}`,t.viaServers.length>0&&(e+=(new d.b).encodeServerCandidates(t.viaServers))}else t.groupId?e="#/group/"+t.groupId:t.userId&&(e="#/user/"+t.userId)}catch(e){}return e}function w(e){try{let t=k(e);if(!t){const s=e.match(m.a.ELEMENT_URL_PATTERN);if(s){const e=new h("http://localhost"),n=s[1].split("#").slice(1).join("#");t=e.parsePermalink("http://localhost/#"+n)}}if(!t)return null;if(t.userId)return t.userId;if(t.groupId)return t.groupId;if(t.roomIdOrAlias)return t.roomIdOrAlias}catch(e){}return null}function C(){const e=p.a.get().permalinkPrefix;return e&&e!==d.a?new h(e):new d.b}function k(e){const t=p.a.get().permalinkPrefix;return decodeURIComponent(e).startsWith(d.a)?(new d.b).parsePermalink(decodeURIComponent(e)):t&&e.startsWith(t)?new h(t).parsePermalink(e):null}function O(e){try{const t=e.replace("#/","");return h.parseAppRoute(t)}catch(e){}return null}function R(e){return e.split(":").splice(1).join(":")}function I(e){return e?new URL("https://"+e).hostname:null}function x(e,t){if(!(e=I(e)))return!0;if(t.length>0&&!t[0].test)throw new Error(t[0].toString());return t.filter(t=>t.test(e)).length>0}function T(e){return!!(e=I(e))&&(e.startsWith("[")&&e.endsWith("]")&&(e=e.substring(1,e.length-1)),a()(e))}const j=e=>{const t=new g(e);return t.load(),t.serverCandidates}},function(e,t,s){"use strict";s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(18),i=s.n(n),o=s(8),a=s(488),r=s.n(a);const c="update";class l extends o.EventEmitter{constructor(e,t={}){super(),this.dispatcher=e,i()(this,"storeState",void 0),i()(this,"lock",new r.a),i()(this,"dispatcherRef",void 0),this.dispatcherRef=e.register(this.onDispatch.bind(this)),this.storeState=t}get state(){return this.storeState}stop(){this.dispatcherRef&&this.dispatcher.unregister(this.dispatcherRef)}async updateState(e){await this.lock.acquireAsync();try{this.storeState=Object.freeze(Object.assign({},this.storeState,e)),this.emit(c,this)}finally{await this.lock.release()}}async reset(e=null,t=!1){await this.lock.acquireAsync();try{this.storeState=Object.freeze(e||{}),t||this.emit(c,this)}finally{await this.lock.release()}}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(402),u=s.n(d),h=s(97),m=s.n(h),p=s(101),g=s.n(p),v=s(111),f=s(100),b=s(94),y=s(92),_=s(105),E=s(93);let S=Object(E.a)("views.dialogs.BaseDialog")((o=i=class extends l.a.Component{constructor(e){super(e),r()(this,"_onKeyDown",e=>{this.props.onKeyDown&&this.props.onKeyDown(e),this.props.hasCancel&&e.key===v.a.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.props.onFinished(!1))}),r()(this,"_onCancelClick",e=>{this.props.onFinished(!1)}),this._matrixClient=b.a.get()}render(){let e,t;return this.props.hasCancel&&(e=l.a.createElement(f.a,{onClick:this._onCancelClick,className:"mx_Dialog_cancelButton","aria-label":Object(y.a)("Close dialog")})),this.props.headerImage&&(t=l.a.createElement("img",{className:"mx_Dialog_titleImage",src:this.props.headerImage,alt:""})),l.a.createElement(_.a.Provider,{value:this._matrixClient},l.a.createElement(u.a,{returnFocus:!0,lockProps:{onKeyDown:this._onKeyDown,role:"dialog","aria-labelledby":"mx_BaseDialog_title","aria-describedby":this.props.contentId},className:g()({[this.props.className]:!0,mx_Dialog_fixedWidth:this.props.fixedWidth})},l.a.createElement("div",{className:g()("mx_Dialog_header",{mx_Dialog_headerWithButton:!!this.props.headerButton,mx_Dialog_headerWithCancel:!!e})},l.a.createElement("div",{className:g()("mx_Dialog_title",this.props.titleClass),id:"mx_BaseDialog_title"},t,this.props.title),this.props.headerButton,e),this.props.children))}},r()(i,"propTypes",{onFinished:m.a.func.isRequired,hasCancel:m.a.bool,onKeyDown:m.a.func,className:m.a.string,fixedWidth:m.a.bool,title:m.a.node.isRequired,headerImage:m.a.string,children:m.a.node,contentId:m.a.string,titleClass:m.a.oneOfType([m.a.string,m.a.object,m.a.arrayOf(m.a.string)])}),r()(i,"defaultProps",{hasCancel:!0,fixedWidth:!0}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(18),c=s.n(r),l=s(91),d=s.n(l);class u extends d.a.Component{constructor(...e){super(...e),c()(this,"containerRef",d.a.createRef())}componentDidMount(){this.containerRef.current&&this.props.onScroll&&this.containerRef.current.addEventListener("scroll",this.props.onScroll,{passive:!0}),this.props.wrappedRef&&this.props.wrappedRef(this.containerRef.current)}componentWillUnmount(){this.containerRef.current&&this.props.onScroll&&this.containerRef.current.removeEventListener("scroll",this.props.onScroll)}getScrollTop(){return this.containerRef.current.scrollTop}render(){const e=this.props,{className:t,onScroll:s,onWheel:n,style:o,tabIndex:r,wrappedRef:c,children:l}=e,u=a()(e,["className","onScroll","onWheel","style","tabIndex","wrappedRef","children"]);return d.a.createElement("div",i()({},u,{ref:this.containerRef,style:o,className:["mx_AutoHideScrollbar",t].join(" "),onWheel:n,tabIndex:r}),l)}}},function(e,t,s){"use strict";let n;s.d(t,"c",(function(){return n})),s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o})),function(e){e.RoomMemberList="RoomMemberList",e.FilePanel="FilePanel",e.NotificationPanel="NotificationPanel",e.RoomMemberInfo="RoomMemberInfo",e.EncryptionPanel="EncryptionPanel",e.RoomSummary="RoomSummary",e.Widget="Widget",e.PinnedMessages="PinnedMessages",e.Room3pidMemberInfo="Room3pidMemberInfo",e.GroupMemberList="GroupMemberList",e.GroupRoomList="GroupRoomList",e.GroupRoomInfo="GroupRoomInfo",e.GroupMemberInfo="GroupMemberInfo",e.SpaceMemberList="SpaceMemberList",e.SpaceMemberInfo="SpaceMemberInfo",e.Space3pidMemberInfo="Space3pidMemberInfo"}(n||(n={}));const i=[n.RoomSummary,n.NotificationPanel,n.PinnedMessages,n.FilePanel,n.RoomMemberList,n.GroupMemberList,n.GroupRoomList],o=[n.SpaceMemberList,n.Space3pidMemberInfo,n.SpaceMemberInfo]},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(18),i=s.n(n),o=s(117),a=s(94);class r{constructor(e){this.matrixClient=e,i()(this,"roomToUser",null),i()(this,"userToRooms",null),i()(this,"hasSentOutPatchDirectAccountDataPatch",void 0),i()(this,"mDirectEvent",void 0),i()(this,"onAccountData",e=>{"m.direct"==e.getType()&&(this.mDirectEvent=this.matrixClient.getAccountData("m.direct").getContent()||{},this.userToRooms=null,this.roomToUser=null)}),this.hasSentOutPatchDirectAccountDataPatch=!1;const t=e.getAccountData("m.direct");this.mDirectEvent=t?t.getContent():{}}static makeShared(){return r.sharedInstance=new r(a.a.get()),r.sharedInstance}static setShared(e){r.sharedInstance=e}static shared(){return r.sharedInstance}start(){this.populateRoomToUser(),this.matrixClient.on("accountData",this.onAccountData)}stop(){this.matrixClient.removeListener("accountData",this.onAccountData)}patchUpSelfDMs(e){const t=this.matrixClient.getUserId(),s=e[t];if(s){const n=s.map(e=>{const s=this.matrixClient.getRoom(e);if(s){const n=s.guessDMUserId();if(n&&n!==t)return{userId:n,roomId:e}}}).filter(e=>!!e);return!!n.length&&(e[t]=s.filter(e=>!n.some(t=>t.roomId===e)),n.forEach(({userId:t,roomId:s})=>{const n=e[t];n?(n.push(s),e[t]=Object(o.uniq)(n)):e[t]=[s]}),!0)}}getDMRoomsForUserId(e){return this.getUserToRooms()[e]||[]}getDMRoomForIdentifiers(e){let t=this.getDMRoomsForUserId(e[0]);for(let s=1;s<e.length;s++){const n=this.getDMRoomsForUserId(e[s]);t=t.filter(e=>n.includes(e))}return t.map(e=>a.a.get().getRoom(e)).filter(e=>e&&"join"===e.getMyMembership())[0]}getUserIdForRoomId(e){if(null==this.roomToUser&&this.populateRoomToUser(),void 0===this.roomToUser[e]){const t=this.matrixClient.getRoom(e);if(t)return t.getDMInviter()}return this.roomToUser[e]}getUniqueRoomsWithIndividuals(){return this.roomToUser?Object.keys(this.roomToUser).map(e=>({userId:this.getUserIdForRoomId(e),room:this.matrixClient.getRoom(e)})).filter(e=>e.userId&&e.room&&2===e.room.getInvitedAndJoinedMemberCount()).reduce((e,t)=>(e[t.userId]=t.room)&&e,{}):{}}getUserToRooms(){if(!this.userToRooms){const e=this.mDirectEvent,t=e[this.matrixClient.getUserId()];if(t&&t.length){const t=this.patchUpSelfDMs(e);console.warn("Invalid m.direct account data detected (self-chats that shouldn't be), patching it up."),t&&!this.hasSentOutPatchDirectAccountDataPatch&&(this.hasSentOutPatchDirectAccountDataPatch=!0,this.matrixClient.setAccountData("m.direct",e))}this.userToRooms=e}return this.userToRooms}populateRoomToUser(){this.roomToUser={};for(const e of Object.keys(this.getUserToRooms()))for(const t of this.userToRooms[e])this.roomToUser[t]=e}}i()(r,"sharedInstance",void 0)},function(e,t,s){"use strict";var n=s(18),i=s.n(n),o=s(8),a=s.n(o),r=s(357),c=s(170),l=s(94),d=s(96);function u(e){return e.chunk.map(e=>Object(r.c)(e))}function h(e){return e.chunk.map(e=>Object(r.d)(e))}let m=0;const p=[];async function g(e){m>=3&&await new Promise((e,t)=>{p.push(e)}),m++;try{return await e()}catch(e){throw e}finally{m--,function(){const e=p.shift();"function"==typeof e&&e()}()}}class v extends a.a{constructor(){super(),i()(this,"STATE_KEY",{GroupMembers:"GroupMembers",GroupInvitedMembers:"GroupInvitedMembers",Summary:"Summary",GroupRooms:"GroupRooms"}),this._state={},this._state[this.STATE_KEY.Summary]={},this._state[this.STATE_KEY.GroupRooms]={},this._state[this.STATE_KEY.GroupMembers]={},this._state[this.STATE_KEY.GroupInvitedMembers]={},this._ready={},this._ready[this.STATE_KEY.Summary]={},this._ready[this.STATE_KEY.GroupRooms]={},this._ready[this.STATE_KEY.GroupMembers]={},this._ready[this.STATE_KEY.GroupInvitedMembers]={},this._fetchResourcePromise={[this.STATE_KEY.Summary]:{},[this.STATE_KEY.GroupRooms]:{},[this.STATE_KEY.GroupMembers]:{},[this.STATE_KEY.GroupInvitedMembers]:{}},this._resourceFetcher={[this.STATE_KEY.Summary]:e=>g(()=>l.a.get().getGroupSummary(e)),[this.STATE_KEY.GroupRooms]:e=>g(()=>l.a.get().getGroupRooms(e).then(h)),[this.STATE_KEY.GroupMembers]:e=>g(()=>l.a.get().getGroupUsers(e).then(u)),[this.STATE_KEY.GroupInvitedMembers]:e=>g(()=>l.a.get().getGroupInvitedUsers(e).then(u))}}_fetchResource(e,t){if(this._fetchResourcePromise[e][t])return;const s=this._resourceFetcher[e](t);return this._fetchResourcePromise[e][t]=s,s.then(s=>{this._state[e][t]=s,this._ready[e][t]=!0,this._notifyListeners()}).catch(s=>{e===this.STATE_KEY.GroupInvitedMembers&&403===s.httpStatus||(console.error(`Failed to get resource ${e} for ${t}`,s),this.emit("error",s,t,e))}).finally(()=>{delete this._fetchResourcePromise[e][t]}),s}_notifyListeners(){this.emit("update")}registerListener(e,t){return this.on("update",t),this.emit("update"),e&&(this._fetchResource(this.STATE_KEY.Summary,e),this._fetchResource(this.STATE_KEY.GroupRooms,e),this._fetchResource(this.STATE_KEY.GroupMembers,e),this._fetchResource(this.STATE_KEY.GroupInvitedMembers,e)),{unregister:()=>{this.unregisterListener(t)}}}unregisterListener(e){this.removeListener("update",e)}isStateReady(e,t){return this._ready[t][e]}getGroupIdsForRoomId(e){return Object.keys(this._state[this.STATE_KEY.GroupRooms]).filter(t=>(this._state[this.STATE_KEY.GroupRooms][t]||[]).some(t=>t.roomId===e))}getSummary(e){return this._state[this.STATE_KEY.Summary][e]||{}}getGroupRooms(e){return this._state[this.STATE_KEY.GroupRooms][e]||[]}getGroupMembers(e){return this._state[this.STATE_KEY.GroupMembers][e]||[]}getGroupInvitedMembers(e){return this._state[this.STATE_KEY.GroupInvitedMembers][e]||[]}getGroupPublicity(e){return(this._state[this.STATE_KEY.Summary][e]||{}).user?(this._state[this.STATE_KEY.Summary][e]||{}).user.is_publicised:null}isUserPrivileged(e){return(this._state[this.STATE_KEY.Summary][e]||{}).user?(this._state[this.STATE_KEY.Summary][e]||{}).user.is_privileged:null}refreshGroupRooms(e){return this._fetchResource(this.STATE_KEY.GroupRooms,e)}refreshGroupMembers(e){return this._fetchResource(this.STATE_KEY.GroupMembers,e)}addRoomToGroup(e,t,s){return l.a.get().addRoomToGroup(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e))}updateGroupRoomVisibility(e,t,s){return l.a.get().updateGroupRoomVisibility(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e))}removeRoomFromGroup(e,t){return l.a.get().removeRoomFromGroup(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e))}inviteUserToGroup(e,t){return l.a.get().inviteUserToGroup(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.GroupInvitedMembers,e))}acceptGroupInvite(e){return l.a.get().acceptGroupInvite(e).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupMembers,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupInvitedMembers,e))}joinGroup(e){return l.a.get().joinGroup(e).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupMembers,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupInvitedMembers,e))}leaveGroup(e){return d.a.dispatch({action:"deselect_tags",tag:e}),l.a.get().leaveGroup(e).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupMembers,e))}addRoomToGroupSummary(e,t,s){return l.a.get().addRoomToGroupSummary(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}addUserToGroupSummary(e,t,s){return l.a.get().addUserToGroupSummary(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}removeRoomFromGroupSummary(e,t){return l.a.get().removeRoomFromGroupSummary(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}removeUserFromGroupSummary(e,t){return l.a.get().removeUserFromGroupSummary(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}setGroupPublicity(e,t){return l.a.get().setGroupPublicity(e,t).then(()=>{c.a.invalidatePublicisedGroups(l.a.get().credentials.userId)}).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}}let f=null;f||(f=new v),t.a=f},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i,o,a=s(104),r=s.n(a),c=s(108),l=s.n(c),d=s(18),u=s.n(d),h=s(91),m=s.n(h),p=s(130),g=s(474),v=s(94),f=s(99),b=s(194),y=s(93),_=s(107);let E=Object(y.a)("views.avatars.RoomAvatar")((o=i=class e extends m.a.Component{constructor(t){super(t),u()(this,"onRoomStateEvents",t=>{this.props.room&&t.getRoomId()===this.props.room.roomId&&"m.room.avatar"===t.getType()&&this.setState({urls:e.getImageUrls(this.props)})}),u()(this,"onRoomAvatarClick",()=>{const e={src:b.b(this.props.room,null,null,null),name:this.props.room.name};f.a.createDialog(g.a,e,"mx_Dialog_lightbox",null,!0)}),this.state={urls:e.getImageUrls(this.props)}}componentDidMount(){v.a.get().on("RoomState.events",this.onRoomStateEvents)}componentWillUnmount(){const e=v.a.get();e&&e.removeListener("RoomState.events",this.onRoomStateEvents)}static getDerivedStateFromProps(t){return{urls:e.getImageUrls(t)}}static getImageUrls(t){let s=null;return t.oobData.avatarUrl&&(s=Object(_.b)(t.oobData.avatarUrl).getThumbnailOfSourceHttp(t.width,t.height,t.resizeMethod)),[s,e.getRoomAvatarUrl(t)].filter((function(e){return null!==e&&""!==e}))}static getRoomAvatarUrl(e){return e.room?b.b(e.room,e.width,e.height,e.resizeMethod):null}render(){const e=this.props,{room:t,oobData:s,viewAvatarOnClick:n,onClick:i}=e,o=l()(e,["room","oobData","viewAvatarOnClick","onClick"]),a=t?t.name:s.name;return m.a.createElement(p.a,r()({},o,{name:a,idName:t?t.roomId:null,urls:this.state.urls,onClick:n&&this.state.urls[0]?this.onRoomAvatarClick:i}))}},u()(i,"defaultProps",{width:36,height:36,resizeMethod:"crop",oobData:{}}),n=o))||n},function(e,t,s){"use strict";var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(101),d=s.n(l),u=s(194),h=s(98),m=s(100),p=s(187),g=s(105),v=s(131),f=s(298),b=s(92);const y=(e,t,s)=>{let n=[];return s||(n=t||[],e&&(n=[e,...n])),Array.from(new Set(n))};t.a=e=>{const{name:t,idName:s,title:n,url:o,urls:l,width:_=40,height:E=40,resizeMethod:S="crop",defaultToInitialLetter:w=!0,onClick:C,inputRef:k,className:O}=e,R=a()(e,["name","idName","title","url","urls","width","height","resizeMethod","defaultToInitialLetter","onClick","inputRef","className"]),[I,x]=(({url:e,urls:t})=>{const s=Object(r.useContext)(p.a),n=s?s.lowBandwidth:h.b.getValue("lowBandwidth"),[i,o]=Object(r.useState)(y(e,t,n)),[a,c]=Object(r.useState)(0),l=Object(r.useCallback)(()=>{c(e=>e+1)},[]);Object(r.useEffect)(()=>{o(y(e,t,n)),c(0)},[e,JSON.stringify(t)]);const d=Object(r.useContext)(g.a),u=Object(r.useCallback)((e,t)=>{"ERROR"!==e&&t!==e&&c(0)},[]);Object(v.a)(d,"sync",u);return[i[a],l]})({url:o,urls:l});if(!I&&w){const e=u.e(t),o=c.a.createElement("span",{className:"mx_BaseAvatar_initial","aria-hidden":"true",style:{fontSize:Object(f.a)(.65*_),width:Object(f.a)(_),lineHeight:Object(f.a)(E)}},e),a=c.a.createElement("img",{className:"mx_BaseAvatar_image",src:u.d(s||t),alt:"",title:n,onError:x,style:{width:Object(f.a)(_),height:Object(f.a)(E)},"aria-hidden":"true"});return C?c.a.createElement(m.a,i()({"aria-label":Object(b.a)("Avatar")},R,{element:"span",className:d()("mx_BaseAvatar",O),onClick:C,inputRef:k}),o,a):c.a.createElement("span",i()({className:d()("mx_BaseAvatar",O),ref:k},R,{role:"presentation"}),o,a)}return C?c.a.createElement(m.a,i()({className:d()("mx_BaseAvatar mx_BaseAvatar_image",O),element:"img",src:I,onClick:C,onError:x,style:{width:Object(f.a)(_),height:Object(f.a)(E)},title:n,alt:Object(b.a)("Avatar"),inputRef:k},R)):c.a.createElement("img",i()({className:d()("mx_BaseAvatar mx_BaseAvatar_image",O),src:I,onError:x,style:{width:Object(f.a)(_),height:Object(f.a)(E)},title:n,alt:"",ref:k},R))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(91);const i=(e,t,s)=>{const i=Object(n.useRef)(s);Object(n.useEffect)(()=>{i.current=s},[s]),Object(n.useEffect)(()=>{if(!e)return;const s=(...e)=>i.current(...e);return e.on(t,s),()=>{e.removeListener(t,s)}},[t,e])}},function(e,t,s){"use strict";var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(92),c=s(118),l=s(102),d=s(99),u=s(95);function h(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function m(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?h(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):h(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const p=/#\/(groups?|room|user|settings|register|login|forgot_password|home|directory)/,g=/#\/(group|room|user)\/.*$/;function v(){const{origin:e,hash:t}=window.location;let{pathname:s}=window.location;return e.startsWith("file://")&&(s="/<redacted>/"),e+s+function(e){return p.exec(e)?g.test(e)?e.replace(g,"#/$1/<redacted>"):e.replace(p,"#/$1"):(console.warn(`Unexpected hash location "${e}"`),"#/<unexpected hash location>")}(t)}const f={"App Platform":{id:1,expl:Object(r.b)("The platform you're on"),example:"Electron Platform"},"App Version":{id:2,expl:Object(r.b)("The version of %(brand)s"),getTextVariables:()=>({brand:l.a.get().brand}),example:"15.0.0"},"User Type":{id:3,expl:Object(r.b)("Whether or not you're logged in (we don't record your username)"),example:"Logged In"},"Chosen Language":{id:4,expl:Object(r.b)("Your language of choice"),example:"en"},Instance:{id:5,expl:Object(r.b)("Which officially provided instance you are using, if any"),example:"app"},"RTE: Uses Richtext Mode":{id:6,expl:Object(r.b)("Whether or not you're using the Richtext mode of the Rich Text Editor"),example:"off"},"Homeserver URL":{id:7,expl:Object(r.b)("Your homeserver's URL"),example:"https://matrix.org"},"Touch Input":{id:8,expl:Object(r.b)("Whether you're using %(brand)s on a device where touch is the primary input mechanism"),getTextVariables:()=>({brand:l.a.get().brand}),example:"false"},Breadcrumbs:{id:9,expl:Object(r.b)("Whether or not you're using the 'breadcrumbs' feature (avatars above the room list)"),example:"disabled"},"Installed PWA":{id:10,expl:Object(r.b)("Whether you're using %(brand)s as an installed Progressive Web App"),getTextVariables:()=>({brand:l.a.get().brand}),example:"false"}};const b="mx_Riot_Analytics_uid";class y{constructor(){i()(this,"baseUrl",null),i()(this,"siteId",null),i()(this,"visitVariables",{}),i()(this,"firstPage",!0),i()(this,"heartbeatIntervalID",null),i()(this,"creationTs",void 0),i()(this,"lastVisitTs",void 0),i()(this,"visitCount",void 0),i()(this,"showDetailsModal",()=>{let e=[];e=this.disabled?Object.keys(f).map(e=>[e,Object(r.a)("e.g. %(exampleValue)s",{exampleValue:f[e].example})]):Object.values(this.visitVariables);const t=`${window.screen.width}x${window.screen.height}`,s=[{expl:Object(r.b)("Every page you use in the app"),value:Object(r.a)("e.g. <CurrentPageURL>",{},{CurrentPageURL:v})},{expl:Object(r.b)("Your user agent"),value:navigator.userAgent},{expl:Object(r.b)("Your device resolution"),value:t}],n=u.getComponent("dialogs.ErrorDialog");d.a.createTrackedDialog("Analytics Details","",n,{title:Object(r.a)("Analytics"),description:a.a.createElement("div",{className:"mx_AnalyticsModal"},a.a.createElement("div",null,Object(r.a)("The information being sent to us to help make %(brand)s better includes:",{brand:l.a.get().brand})),a.a.createElement("table",null,e.map(e=>a.a.createElement("tr",{key:e[0]},a.a.createElement("td",null,Object(r.a)(f[e[0]].expl,f[e[0]].getTextVariables?f[e[0]].getTextVariables():null)),void 0!==e[1]&&a.a.createElement("td",null,a.a.createElement("code",null,e[1])))),s.map((e,t)=>a.a.createElement("tr",{key:t},a.a.createElement("td",null,Object(r.a)(e.expl)),a.a.createElement("td",null,a.a.createElement("code",null,e.value))))),a.a.createElement("div",null,Object(r.a)("Where this page includes identifiable information, such as a room, user or group ID, that data is removed before being sent to the server.")))})}),this.creationTs=localStorage&&localStorage.getItem("mx_Riot_Analytics_cts"),!this.creationTs&&localStorage&&localStorage.setItem("mx_Riot_Analytics_cts",this.creationTs=String((new Date).getTime())),this.lastVisitTs=localStorage&&localStorage.getItem("mx_Riot_Analytics_lvts"),this.visitCount=localStorage&&localStorage.getItem("mx_Riot_Analytics_vc")||"0",this.visitCount=String(parseInt(this.visitCount,10)+1),localStorage&&localStorage.setItem("mx_Riot_Analytics_vc",this.visitCount)}get disabled(){return!this.baseUrl}canEnable(){const e=l.a.get();return"1"!==navigator.doNotTrack&&e&&e.piwik&&e.piwik.url&&e.piwik.siteId}async enable(){if(!this.disabled)return;if(!this.canEnable())return;const e=l.a.get();this.baseUrl=new URL("piwik.php",e.piwik.url),this.baseUrl.searchParams.set("rec","1"),this.baseUrl.searchParams.set("idsite",e.piwik.siteId),this.baseUrl.searchParams.set("apiv","1"),this.baseUrl.searchParams.set("send_image","0"),this.baseUrl.searchParams.set("_id",function(){try{let e=localStorage&&localStorage.getItem(b);return!e&&localStorage&&localStorage.setItem(b,e=[...Array(16)].map(()=>Math.random().toString(16)[2]).join("")),e}catch(e){return console.error("Analytics error: ",e),""}}()),this.baseUrl.searchParams.set("_idts",this.creationTs),this.baseUrl.searchParams.set("_idvc",this.visitCount),this.lastVisitTs&&this.baseUrl.searchParams.set("_viewts",this.lastVisitTs);const t=c.a.get();this.setVisitVariable("App Platform",t.getHumanReadableName());try{this.setVisitVariable("App Version",await t.getAppVersion())}catch(e){this.setVisitVariable("App Version","unknown")}this.setVisitVariable("Chosen Language",Object(r.d)());const s=window.location.hostname;"riot.im"===s?this.setVisitVariable("Instance",window.location.pathname):s.endsWith(".element.io")&&this.setVisitVariable("Instance",s.replace(".element.io",""));let n="unknown";try{n=String(window.matchMedia("(display-mode: standalone)").matches)}catch(e){}this.setVisitVariable("Installed PWA",n);let i="unknown";try{i=String(window.matchMedia("(pointer: coarse)").matches)}catch(e){}this.setVisitVariable("Touch Input",i),this.heartbeatIntervalID=window.setInterval(this.ping.bind(this),3e4)}disable(){this.disabled||(this.trackEvent("Analytics","opt-out"),window.clearInterval(this.heartbeatIntervalID),this.baseUrl=null,this.visitVariables={},localStorage.removeItem(b),localStorage.removeItem("mx_Riot_Analytics_cts"),localStorage.removeItem("mx_Riot_Analytics_vc"),localStorage.removeItem("mx_Riot_Analytics_lvts"))}async _track(e){if(this.disabled)return;const t=new Date,s=m(m({},e),{},{url:v(),_cvar:JSON.stringify(this.visitVariables),res:`${window.screen.width}x${window.screen.height}`,rand:String(Math.random()).slice(2,8),h:t.getHours(),m:t.getMinutes(),s:t.getSeconds()}),n=new URL(this.baseUrl.toString());for(const e in s)n.searchParams.set(e,s[e]);try{await window.fetch(n.toString(),{method:"GET",mode:"no-cors",cache:"no-cache",redirect:"follow"})}catch(e){console.error("Analytics error: ",e)}}ping(){this._track({ping:"1"}),localStorage.setItem("mx_Riot_Analytics_lvts",String((new Date).getTime()))}trackPageChange(e){this.disabled||(this.firstPage?this.firstPage=!1:("number"!=typeof e&&console.warn("Analytics.trackPageChange: expected generationTimeMs to be a number"),this._track({gt_ms:String(e)})))}trackEvent(e,t,s,n){this.disabled||this._track({e_c:e,e_a:t,e_n:s,e_v:n})}setVisitVariable(e,t){this.disabled||(this.visitVariables[f[e].id]=[e,t])}setLoggedIn(e,t){if(this.disabled)return;const s=l.a.get();if(!s.piwik)return;const n=s.piwik.whitelistedHSUrls||[];var i;this.setVisitVariable("User Type",e?"Guest":"Logged In"),this.setVisitVariable("Homeserver URL",(i=t,n.includes(i)?i:"<redacted>"))}setBreadcrumbs(e){this.disabled||this.setVisitVariable("Breadcrumbs",e?"enabled":"disabled")}}window.mxAnalytics||(window.mxAnalytics=new y),t.a=window.mxAnalytics},function(e,t,s){"use strict";var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(299),c=s(96),l=s(94),d=s(95),u=s(99),h=s(92),m=s(497),p=s(103),g=s(149),v=s(120);function f(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function b(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?f(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):f(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const y={joining:!1,joinError:null,roomId:null,initialEventId:null,initialEventPixelOffset:null,isInitialEventHighlighted:!1,roomAlias:null,roomLoading:!1,roomLoadError:null,quotingEvent:null,replyingToEvent:null,shouldPeek:!1,viaServers:[],wasContextSwitch:!1};class _ extends r.Store{constructor(){super(c.a),i()(this,"state",y)}setState(e){let t=!1;for(const s of Object.keys(e))if(this.state[s]!==e[s]){t=!0;break}t&&(this.state=Object.assign(this.state,e),this.__emitChange())}__onDispatch(e){switch(e.action){case"view_room":this.viewRoom(e);break;case"view_create_group":case"view_welcome_page":case"view_home_page":case"view_my_groups":case"view_group":this.setState({roomId:null,roomAlias:null,viaServers:[],wasContextSwitch:!1});break;case"view_room_error":this.viewRoomError(e);break;case"will_join":this.setState({joining:!0});break;case"cancel_join":this.setState({joining:!1});break;case p.a.JoinRoom:this.joinRoom(e);break;case p.a.JoinRoomError:this.joinRoomError(e);break;case p.a.JoinRoomReady:this.setState({shouldPeek:!1});break;case"on_client_not_viable":case"on_logged_out":this.reset();break;case"reply_to_event":e.event&&e.event.getRoomId()!==this.state.roomId?c.a.dispatch({action:"view_room",room_id:e.event.getRoomId(),replyingToEvent:e.event}):this.setState({replyingToEvent:e.event});break;case"open_room_settings":{const t=d.getComponent("dialogs.RoomSettingsDialog");u.a.createTrackedDialog("Room settings","",t,{roomId:e.room_id||this.state.roomId,initialTabId:e.initial_tab_id},null,!1,!0);break}}}async viewRoom(e){if(e.room_id){const t={roomId:e.room_id,roomAlias:e.room_alias,initialEventId:e.event_id,isInitialEventHighlighted:e.highlighted,roomLoading:!1,roomLoadError:null,shouldPeek:void 0===e.should_peek||e.should_peek,joining:e.joining||!1,replyingToEvent:null,isEditingSettings:!1,viaServers:e.via_servers,wasContextSwitch:e.context_switch};e.replyingToEvent&&e.replyingToEvent.getRoomId()===e.room_id&&(t.replyingToEvent=e.replyingToEvent),this.setState(t),e.auto_join&&c.a.dispatch(b(b({},e),{},{action:p.a.JoinRoom,roomId:e.room_id}))}else if(e.room_alias){let t=Object(m.a)(e.room_alias);if(!t){this.setState({roomId:null,initialEventId:null,initialEventPixelOffset:null,isInitialEventHighlighted:null,roomAlias:e.room_alias,roomLoading:!0,roomLoadError:null,viaServers:e.via_servers,wasContextSwitch:e.context_switch});try{const s=await l.a.get().getRoomIdForAlias(e.room_alias);Object(m.b)(e.room_alias,s.room_id),t=s.room_id}catch(t){return console.error("RVS failed to get room id for alias: ",t),void c.a.dispatch({action:"view_room_error",room_id:null,room_alias:e.room_alias,err:t})}}c.a.dispatch({action:"view_room",room_id:t,event_id:e.event_id,highlighted:e.highlighted,room_alias:e.room_alias,auto_join:e.auto_join,oob_data:e.oob_data,viaServers:e.via_servers,wasContextSwitch:e.context_switch})}}viewRoomError(e){this.setState({roomId:e.room_id,roomAlias:e.room_alias,roomLoading:!1,roomLoadError:e.err})}async joinRoom(e){const t=v.a.getTimestamp();this.setState({joining:!0});const s=l.a.get(),n=this.state.roomAlias||this.state.roomId,i=this.state.viaServers||[];try{await Object(g.b)(()=>s.joinRoom(n,b({viaServers:i},e.opts)),5,e=>504===e.httpStatus),v.a.instance.trackRoomJoin(t,this.state.roomId,e._type),c.a.dispatch({action:p.a.JoinRoomReady,roomId:this.state.roomId})}catch(e){c.a.dispatch({action:p.a.JoinRoomError,roomId:this.state.roomId,err:e})}}getInvitingUserId(e){const t=l.a.get(),s=t.getRoom(e);if(s&&"invite"===s.getMyMembership()){const e=s.getMember(t.getUserId()),n=e?e.events.member:null;return n&&n.getSender()}}joinRoomError(e){this.setState({joining:!1,joinError:e.err});const t=e.err;let s=t.message?t.message:JSON.stringify(t);if(console.log("Failed to join room:",s),"ConnectionError"===t.name)s=Object(h.a)("There was an error joining the room");else if("M_INCOMPATIBLE_ROOM_VERSION"===t.errcode)s=a.a.createElement("div",null,Object(h.a)("Sorry, your homeserver is too old to participate in this room."),a.a.createElement("br",null),Object(h.a)("Please contact your homeserver administrator."));else if(404===t.httpStatus){const e=this.getInvitingUserId(this.state.roomId);e&&(s=e.endsWith(":"+l.a.get().getDomain())?Object(h.a)("The person who invited you already left the room."):Object(h.a)("The person who invited you already left the room, or their server is offline."))}const n=d.getComponent("dialogs.ErrorDialog");u.a.createTrackedDialog("Failed to join room","",n,{title:Object(h.a)("Failed to join room"),description:s})}reset(){this.state=Object.assign({},y)}getRoomId(){return this.state.roomId}getInitialEventId(){return this.state.initialEventId}isInitialEventHighlighted(){return this.state.isInitialEventHighlighted}getRoomAlias(){return this.state.roomAlias}isRoomLoading(){return this.state.roomLoading}getRoomLoadError(){return this.state.roomLoadError}isJoining(){return this.state.joining}getJoinError(){return this.state.joinError}getQuotingEvent(){return this.state.replyingToEvent}shouldPeek(){return this.state.shouldPeek}getWasContextSwitch(){return this.state.wasContextSwitch}}let E=null;E||(E=new _),t.a=E},function(e,t,s){"use strict";s.d(t,"a",(function(){return F})),s.d(t,"j",(function(){return B})),s.d(t,"i",(function(){return V})),s.d(t,"h",(function(){return K})),s.d(t,"d",(function(){return W})),s.d(t,"e",(function(){return G})),s.d(t,"b",(function(){return Y})),s.d(t,"g",(function(){return J})),s.d(t,"f",(function(){return Q})),s.d(t,"c",(function(){return X}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(305),c=s.n(r),l=s(503),d=s.n(l),u=s(829),h=s(834),m=s.n(h),p=s(836),g=s.n(p),v=s(101),f=s.n(v),b=s(530),y=s.n(b),_=s(136),E=s.n(_),S=s(840),w=s.n(S),C=s(375),k=s(361),O=s(98),R=s(122),I=s(267),x=s(234),T=s(107);function j(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function N(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?j(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):j(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}Object(k.a)(u);const P=/([\ud800-\udbff])([\udc00-\udfff])/,D=/([\u2100-\u2bff])/,A=new RegExp("‍| ","g"),M=new RegExp("\\s","g"),U=new RegExp(`^(${y.a.source})+$`,"i"),L=/^#[0-9a-fA-F]{6}$/,F=["http","https","ftp","mailto","magnet"];function B(e){const t=Object(I.e)(e);return t&&t.shortcodes?`:${t.shortcodes[0]}:`:""}function V(e){e=e.slice(1,e.length-1);const t=I.d.get(e);return t?t.unicode:null}function K(e){const t=c()(e,H);return a.a.createElement("div",{dangerouslySetInnerHTML:{__html:t},dir:"auto"})}function W(e){return c()(e,{allowedTags:[],allowedAttributes:{},selfClosing:[],allowedSchemes:[],disallowedTagsMode:"discard"})}function G(e){try{const t=E.a.parse(e);return!!t.protocol&&F.includes(t.protocol.slice(0,-1))}catch(e){return!1}}const q={a:function(e,t){if(t.href){t.target="_blank";const e=Object(R.l)(t.href);(e!==t.href||t.href.match(k.a.ELEMENT_URL_PATTERN))&&(t.href=e,delete t.target)}return t.rel="noreferrer noopener",{tagName:e,attribs:t}},img:function(e,t){if(!t.src||!t.src.startsWith("mxc://")||!O.b.getValue("showImages"))return{tagName:e,attribs:{}};const s=Number(t.width)||800,n=Number(t.height)||600;return t.src=Object(T.b)(t.src).getThumbnailOfSourceHttp(s,n),{tagName:e,attribs:t}},code:function(e,t){if(void 0!==t.class){const e=t.class.split(/\s/).filter((function(e){return e.startsWith("language-")&&!e.startsWith("language-_")}));t.class=e.join(" ")}return{tagName:e,attribs:t}},"*":function(e,t){delete t.style;const s={"data-mx-color":"color","data-mx-bg-color":"background-color"};let n="";return Object.keys(s).forEach(e=>{const i=s[e],o=t[e];o&&"string"==typeof o&&L.test(o)&&(n+=i+":"+o+";",delete t[e])}),n&&(t.style=n),{tagName:e,attribs:t}}},H={allowedTags:["font","del","h1","h2","h3","h4","h5","h6","blockquote","p","a","ul","ol","sup","sub","nl","li","b","i","u","strong","em","strike","code","hr","br","div","table","thead","caption","tbody","tr","th","td","pre","span","img","details","summary"],allowedAttributes:{font:["color","data-mx-bg-color","data-mx-color","style"],span:["data-mx-maths","data-mx-bg-color","data-mx-color","data-mx-spoiler","style"],div:["data-mx-maths"],a:["href","name","target","rel"],img:["src","width","height","alt","title"],ol:["start"],code:["class"]},selfClosing:["img","br","hr","area","base","basefont","input","link","meta"],allowedSchemes:F,allowProtocolRelative:!1,transformTags:q,nestingLimit:50},$=N(N({},H),{},{transformTags:{code:q.code,"*":q["*"]}});class z extends class{constructor(e,t){this.highlightClass=e,this.highlightLink=t}applyHighlights(e,t){let s,n=0,i=[];const o=t[0];for(;(s=e.toLowerCase().indexOf(o.toLowerCase(),n))>=0;){if(s>n){const o=e.substring(n,s);i=i.concat(this.applySubHighlights(o,t))}const a=s+o.length;i.push(this.processSnippet(e.substring(s,a),!0)),n=a}if(n!==e.length){const s=e.substring(n,void 0);i=i.concat(this.applySubHighlights(s,t))}return i}applySubHighlights(e,t){return t[1]?this.applyHighlights(e,t.slice(1)):[this.processSnippet(e,!1)]}}{processSnippet(e,t){if(!t)return e;let s=`<span class="${this.highlightClass}">${e}</span>`;return this.highlightLink&&(s=`<a href="${encodeURI(this.highlightLink)}">${s}</a>`),s}}function Y(e,t,s={}){const n="org.matrix.custom.html"===e.format&&e.formatted_body;let i,o,r,l=!1,u=H;s.forComposerQuote&&(u=$);try{if(t&&t.length>0){const e=new z("mx_EventTile_searchHighlight",s.highlightLink),n=t.map((function(e){return c()(e,u)}));u.textFilter=function(t){return e.applyHighlights(t,n).join("")}}let a="string"==typeof e.formatted_body?e.formatted_body:null;const m="string"==typeof e.body?e.body:"";if(s.stripReplyFallback&&a&&(a=x.a.stripHTMLReply(a)),i=s.stripReplyFallback?x.a.stripPlainReply(m):m,h=n?a:m,l=P.test(h)||D.test(h),n&&(r=!0,o=c()(a,u),O.b.getValue("feature_latex_maths"))){const e=d.a.load(o,{_useHtmlParser2:!0,decodeEntities:!1});e('div, span[data-mx-maths!=""]').replaceWith((function(t,s){return w.a.renderToString(C.AllHtmlEntities.decode(e(s).attr("data-mx-maths")),{throwOnError:!1,displayMode:"div"==s.name,output:"htmlAndMathml"})})),o=e.html()}}finally{delete u.textFilter}var h;const m=r?o:i;if(s.returnString)return m;let p=!1;if(!s.disableBigEmoji&&l){let t=void 0!==m?m.trim():"";t=t.replace(M,""),t=t.replace(A,"");const s=U.exec(t);p=s&&s[0]&&s[0].length===t.length&&(i===o||void 0===e.formatted_body||!e.formatted_body.includes("http:")&&!e.formatted_body.includes("https:"))}const g=f()({mx_EventTile_body:!0,mx_EventTile_bigEmoji:p,"markdown-body":n&&!p});return r?a.a.createElement("span",{key:"body",ref:s.ref,className:g,dangerouslySetInnerHTML:{__html:o}}):a.a.createElement("span",{key:"body",ref:s.ref,className:g},i)}function J(e,t=k.a.options){return m()(e,t)}function Q(e,t=k.a.options){return c()(function(e,t=k.a.options){return g()(e,t)}(e,t),H)}function X(e){switch(e.nodeName){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"PRE":case"BLOCKQUOTE":case"P":case"UL":case"OL":case"LI":case"HR":case"TABLE":case"THEAD":case"TBODY":case"TR":case"TH":case"TD":return!0;case"DIV":return!e.hasAttribute("data-mx-maths");default:return!1}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(95),u=s(92),h=s(93);let m=Object(h.a)("views.dialogs.ErrorDialog")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"onClick",()=>{this.props.onFinished(!0)})}render(){const e=d.getComponent("views.dialogs.BaseDialog");return l.a.createElement(e,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:this.props.title||Object(u.a)("Error"),headerImage:this.props.headerImage,contentId:"mx_Dialog_content"},l.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},this.props.description||Object(u.a)("An error has occurred.")),l.a.createElement("div",{className:"mx_Dialog_buttons"},l.a.createElement("button",{className:"mx_Dialog_primary",onClick:this.onClick,autoFocus:this.props.focus},this.props.button||Object(u.a)("OK"))))}},r()(i,"defaultProps",{focus:!0,title:null,description:null,button:null}),n=o))||n},,function(e,t,s){"use strict";s.d(t,"b",(function(){return E})),s.d(t,"e",(function(){return S})),s.d(t,"a",(function(){return w})),s.d(t,"d",(function(){return C})),s.d(t,"c",(function(){return k})),s.d(t,"f",(function(){return O}));var n=s(110),i=s(94),o=s(99),a=s(95),r=s(92),c=s(96),l=s(242),d=s(127),u=s(214),h=s(243),m=s(128),p=s(120),g=s(188),v=s(153),f=s(145),b=s(280),y=s(103),_=s(241);function E(e){void 0===(e=e||{}).spinner&&(e.spinner=!0),void 0===e.guestAccess&&(e.guestAccess=!0),void 0===e.encryption&&(e.encryption=!1);const t=p.a.getTimestamp(),s=a.getComponent("dialogs.ErrorDialog"),d=a.getComponent("elements.Spinner"),h=i.a.get();if(h.isGuest())return c.a.dispatch({action:"require_registration"}),Promise.resolve(null);const g=e.dmUserId?_.a.TrustedPrivateChat:_.a.PrivateChat,v=e.createOpts||{};if(v.preset=v.preset||g,v.visibility=v.visibility||_.b.Private,e.dmUserId&&void 0===v.invite)switch(Object(u.d)(e.dmUserId)){case"mx-user-id":v.invite=[e.dmUserId];break;case"email":v.invite_3pid=[{id_server:i.a.get().getIdentityServerUrl(!0),medium:"email",address:e.dmUserId}]}let E,S;return e.dmUserId&&void 0===v.is_direct&&(v.is_direct=!0),void 0===e.andView&&(e.andView=!0),v.initial_state=v.initial_state||[],e.guestAccess&&v.initial_state.push({type:"m.room.guest_access",state_key:"",content:{guest_access:"can_join"}}),e.encryption&&v.initial_state.push({type:"m.room.encryption",state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}),e.parentSpace&&(e.createOpts.initial_state.push(Object(b.a)(e.parentSpace,!0)),e.createOpts.initial_state.push({type:n.a.RoomHistoryVisibility,content:{history_visibility:e.createOpts.preset===_.a.PublicChat?"world_readable":"invited"}})),e.spinner&&(E=o.a.createDialog(d,null,"mx_Dialog_spinner")),h.createRoom(v).finally((function(){E&&E.close()})).then((function(t){return S=t.room_id,e.dmUserId?l.c(S,e.dmUserId):Promise.resolve()})).then(()=>e.parentSpace?f.f.instance.addRoomToSpace(e.parentSpace,S,[h.getDomain()],!0):e.associatedWithCommunity?m.a.addRoomToGroup(e.associatedWithCommunity,S,!1):void 0).then((function(){return e.andView&&c.a.dispatch({action:"view_room",room_id:S,should_peek:!1,joining:!0,justCreatedOpts:e}),p.a.instance.trackRoomCreate(t,S),S}),(function(t){if(e.inlineErrors)throw t;c.a.dispatch({action:y.a.JoinRoomError,roomId:S}),console.error("Failed to create room "+S+" "+t);let n=Object(r.a)("Server may be unavailable, overloaded, or you hit a bug.");return"M_UNSUPPORTED_ROOM_VERSION"===t.errcode&&(n=Object(r.a)("The server does not support the room version specified.")),o.a.createTrackedDialog("Failure to create room","",s,{title:Object(r.a)("Failure to create room"),description:n}),null}))}function S(e,t){const s=d.a.shared().getDMRoomsForUserId(t).map(t=>e.getRoom(t)).filter(e=>{if(e&&"join"===e.getMyMembership()){const s=e.currentState.getMembers().filter(e=>Object(g.c)(e.membership));return s.find(e=>e.userId===t)&&2===s.length}return!1}).sort((e,t)=>t.getLastActiveTimestamp()-e.getLastActiveTimestamp());if(s.length)return s[0]}async function w(e,t){try{const s=await e.downloadKeys(t);return Object.values(s).every(e=>Object.keys(e).length>0)}catch(e){return console.error("Error determining if it's possible to encrypt to all users: ",e),!1}}async function C(e,t,s){const n=S(e,t);let i;return i=n?n.roomId:await E({dmUserId:t,spinner:!1,andView:!1,createOpts:{creation_content:{[v.d]:s}}}),i}async function k(e,t){const s=S(e,t);let n;if(s)n=s.roomId;else{let s=void 0;O()&&(s=await w(e,[t])),n=await E({encryption:s,dmUserId:t,spinner:!1,andView:!1}),await async function(e,t,s,n={timeout:1500}){const{timeout:i}=n;let o;return new Promise(n=>{o=function(e,i,o){o.userId===s&&o.roomId===t&&n(!0)},e.on("RoomState.newMember",o),setTimeout(n,i,!1)}).finally(()=>{e.removeListener("RoomState.newMember",o)})}(e,n,t)}return n}function O(){const e=Object(h.b)();if(e){return!(!1===e.default)}return!0}},,function(e,t,s){"use strict";s.r(t),function(e,n){s.d(t,"OLM_ALGORITHM",(function(){return c})),s.d(t,"MEGOLM_ALGORITHM",(function(){return l})),s.d(t,"MEGOLM_BACKUP_ALGORITHM",(function(){return d})),s.d(t,"encryptMessageForDevice",(function(){return u})),s.d(t,"getExistingOlmSessions",(function(){return h})),s.d(t,"ensureOlmSessionsForDevices",(function(){return m})),s.d(t,"verifySignature",(function(){return g})),s.d(t,"pkSign",(function(){return v})),s.d(t,"pkVerify",(function(){return f})),s.d(t,"encodeBase64",(function(){return b})),s.d(t,"encodeUnpaddedBase64",(function(){return y})),s.d(t,"decodeBase64",(function(){return _}));var i=s(0),o=s(1),a=s(311),r=s.n(a);const c="m.olm.v1.curve25519-aes-sha2",l="m.megolm.v1.aes-sha2",d="m.megolm_backup.v1.curve25519-aes-sha2";async function u(e,t,s,n,a,r,c){const l=r.getIdentityKey(),d=await n.getSessionIdForDevice(l);if(null===d)return;i.a.log("Using sessionid "+d+" for device "+a+":"+r.deviceId);const u={sender:t,sender_device:s,keys:{ed25519:n.deviceEd25519Key},recipient:a,recipient_keys:{ed25519:r.getFingerprint()}};o.o(u,c),e[l]=await n.encryptMessage(l,d,JSON.stringify(u))}async function h(e,t,s){const n={},i={},o=[];for(const[t,a]of Object.entries(s))for(const s of a){const a=s.deviceId,r=s.getIdentityKey();o.push((async()=>{const o=await e.getSessionIdForDevice(r,!0);null===o?(n[t]=n[t]||[],n[t].push(s)):(i[t]=i[t]||{},i[t][a]={device:s,sessionId:o})})())}return await Promise.all(o),[n,i]}async function m(e,t,s,n,o,a,r){"number"==typeof n&&(r=a,a=o,o=n,n=!1),r||(r=i.a);const c=[],l={},d={};for(const[,t]of Object.entries(s))for(const s of t){const t=s.getIdentityKey();t!==e.deviceCurve25519Key&&(e._sessionsInProgress[t]||(e._sessionsInProgress[t]=new Promise(s=>{d[t]=(...n)=>{delete e._sessionsInProgress[t],s(...n)}})))}for(const[t,i]of Object.entries(s)){l[t]={};for(const s of i){const i=s.deviceId,o=s.getIdentityKey();if(o===e.deviceCurve25519Key){r.info("Attempted to start session with ourself! Ignoring"),l[t][i]={device:s,sessionId:null};continue}const a=`for ${o} (${t}:${i})`,u=await e.getSessionIdForDevice(o,d[o],r);null!==u&&d[o]&&d[o](),(null===u||n)&&(n?r.info("Forcing new Olm session "+a):r.info("Making new Olm session "+a),c.push([t,i])),l[t][i]={device:s,sessionId:u}}}if(0===c.length)return l;let u,h=`one-time keys for ${c.length} devices`;try{r.debug("Claiming "+h),u=await t.claimOneTimeKeys(c,"signed_curve25519",o),r.debug("Claimed "+h)}catch(e){for(const e of Object.values(d))e();throw r.log("Failed to claim "+h,e,c),e}a&&"failures"in u&&a.push(...Object.keys(u.failures));const m=u.one_time_keys||{},g=[];for(const[t,i]of Object.entries(s)){const s=m[t]||{};for(let o=0;o<i.length;o++){const a=i[o],c=a.deviceId,u=a.getIdentityKey();if(u===e.deviceCurve25519Key)continue;if(l[t][c].sessionId&&!n)continue;const h=s[c]||{};let m=null;for(const e in h)0===e.indexOf("signed_curve25519:")&&(m=h[e]);m?g.push(p(e,m,t,a).then(e=>{d[u]&&d[u](e),l[t][c].sessionId=e},e=>{throw d[u]&&d[u](),e})):(r.warn(`No one-time keys (alg=signed_curve25519) for device ${t}:${c}`),d[u]&&d[u]())}}return h=`Olm sessions for ${g.length} devices`,r.debug("Starting "+h),await Promise.all(g),r.debug("Started "+h),l}async function p(e,t,s,n){const o=n.deviceId;try{await g(e,t,s,o,n.getFingerprint())}catch(e){return i.a.error("Unable to verify signature on one-time key for device "+s+":"+o+":",e),null}let a;try{a=await e.createOutboundSession(n.getIdentityKey(),t.key)}catch(e){return i.a.error("Error starting olm session with device "+s+":"+o+": "+e),null}return i.a.log("Started new olm sessionid "+a+" for device "+s+":"+o),a}async function g(e,t,s,n,i){const o="ed25519:"+n,a=((t.signatures||{})[s]||{})[o];if(!a)throw Error("No signature");const c=Object.assign({},t);delete c.unsigned,delete c.signatures;const l=r.a.stringify(c);e.verifySignature(i,l,a)}function v(t,s,n,i){let o=!1;if(s instanceof Uint8Array){const t=new e.Olm.PkSigning;i=t.init_with_seed(s),s=t,o=!0}const a=t.signatures||{};delete t.signatures;const c=t.unsigned;t.unsigned&&delete t.unsigned;try{const e=a[n]||{};return a[n]=e,e["ed25519:"+i]=s.sign(r.a.stringify(t))}finally{t.signatures=a,c&&(t.unsigned=c),o&&s.free()}}function f(t,s,n){const i="ed25519:"+s;if(!(t.signatures&&t.signatures[n]&&t.signatures[n][i]))throw new Error("No signature");const o=t.signatures[n][i],a=new e.Olm.Utility,c=t.signatures;delete t.signatures;const l=t.unsigned;t.unsigned&&delete t.unsigned;try{a.ed25519_verify(s,r.a.stringify(t),o)}finally{t.signatures=c,l&&(t.unsigned=l),a.free()}}function b(e){return n.from(e).toString("base64")}function y(e){return b(e).replace(/=+$/g,"")}function _(e){return n.from(e,"base64")}}.call(this,s(7),s(36).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(136),i=s(138),o=s(94),a=s(102),r=s(96),c=s(244),l=s(98),d=s(183),u=s(161),h=s(141),m=s(92);class p{static canUserModifyWidgets(e){if(!e)return console.warn("No room ID specified"),!1;const t=o.a.get();if(!t)return console.warn("User must be be logged in"),!1;const s=t.getRoom(e);if(!s)return console.warn(`Room ID ${e} is not recognised`),!1;const n=t.credentials.userId;return n?"join"!==s.getMyMembership()?(console.warn(`User ${n} is not in room ${e}`),!1):s.currentState.maySendStateEvent("im.vector.modular.widgets",n):(console.warn("Failed to get user ID"),!1)}static isScalarUrl(e){if(!e)return console.error("Scalar URL check failed. No URL specified"),!1;const t=n.parse(e);let s=a.a.get().integrations_widgets_urls;if(!s||0===s.length){const e=d.a.sharedInstance().getPrimaryManager();s=e?[e.apiUrl]:[]}for(let e=0;e<s.length;e++){const i=n.parse(s[e]);if(t&&i&&t.protocol===i.protocol&&t.host===i.host&&t.pathname.startsWith(i.pathname))return!0}return!1}static waitForUserWidget(e,t){return new Promise((s,n)=>{function i(s){return!(!s||!s.getContent())&&(t?void 0!==s.getContent()[e]:void 0===s.getContent()[e])}if(i(o.a.get().getAccountData("m.widgets")))return void s();function a(e){i(o.a.get().getAccountData("m.widgets"))&&(o.a.get().removeListener("accountData",a),clearTimeout(r),s())}const r=setTimeout(()=>{o.a.get().removeListener("accountData",a),n(new Error("Timed out waiting for widget ID "+e+" to appear"))},2e4);o.a.get().on("accountData",a)})}static waitForRoomWidget(e,t,s){return new Promise((n,i)=>{function a(t){const n=t.some(t=>t.getContent()&&t.getContent().id===e);return s?n:!n}const r=o.a.get().getRoom(t);if(a(r.currentState.getStateEvents("im.vector.modular.widgets")))return void n();function c(e){if(e.getRoomId()!==t)return;a(r.currentState.getStateEvents("im.vector.modular.widgets"))&&(o.a.get().removeListener("RoomState.events",c),clearTimeout(l),n())}const l=setTimeout(()=>{o.a.get().removeListener("RoomState.events",c),i(new Error("Timed out waiting for widget ID "+e+" to appear"))},2e4);o.a.get().on("RoomState.events",c)})}static setUserWidget(e,t,s,n,i){const a={type:t.preferred,url:s,name:n,data:i},c=o.a.get(),l=Object(h.a)(p.getUserWidgets());try{delete l[e]}catch(e){console.error("$widgetId is non-configurable")}const d=Boolean(s);return d&&(l[e]={content:a,sender:c.getUserId(),state_key:e,type:"m.widget",id:e}),c.setAccountData("m.widgets",l).then(()=>p.waitForUserWidget(e,d)).then(()=>{r.a.dispatch({action:"user_widget_updated"})})}static setRoomWidget(e,t,s,n,i,o){let a;return a=Boolean(n)?{type:s.legacy,url:n,name:i,data:o}:{},p.setRoomWidgetContent(e,t,a)}static setRoomWidgetContent(e,t,s){const n=!!s.url;c.a.setRoomWidgetEcho(e,t,s);return o.a.get().sendStateEvent(e,"im.vector.modular.widgets",s,t).then(()=>p.waitForRoomWidget(t,e,n)).finally(()=>{c.a.removeRoomWidgetEcho(e,t)})}static getRoomWidgets(e){const t=e.currentState.getStateEvents("im.vector.modular.widgets");return t?t.filter(e=>e.getContent().type&&e.getContent().url):[]}static getUserWidgets(){const e=o.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");return t&&t.getContent()?t.getContent():{}}static getUserWidgetsArray(){return Object.values(p.getUserWidgets())}static getStickerpickerWidgets(){return p.getUserWidgetsArray().filter(e=>e.content&&"m.stickerpicker"===e.content.type)}static getIntegrationManagerWidgets(){return p.getUserWidgetsArray().filter(e=>e.content&&"m.integration_manager"===e.content.type)}static getRoomWidgetsOfType(e,t){return(p.getRoomWidgets(e)||[]).filter(e=>{const s=e.getContent();return s.url&&t.matches(s.type)})}static removeIntegrationManagerWidgets(){const e=o.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");if(!t)return;const s=t.getContent()||{};return Object.entries(s).forEach(([e,t])=>{t.content&&"m.integration_manager"===t.content.type&&delete s[e]}),e.setAccountData("m.widgets",s)}static addIntegrationManagerWidget(e,t,s){return p.setUserWidget("integration_manager_"+(new Date).getTime(),u.a.INTEGRATION_MANAGER,t,"Integration Manager: "+e,{api_url:s})}static removeStickerpickerWidgets(){const e=o.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");if(!t)return;const s=t.getContent()||{};return Object.entries(s).forEach(([e,t])=>{t.content&&"m.stickerpicker"===t.content.type&&delete s[e]}),e.setAccountData("m.widgets",s)}static makeAppConfig(e,t,s,n,i){if(!s)throw new Error("Widgets must be created by someone - provide a senderUserId");return t.creatorUserId=s,t.id=e,t.roomId=n,t.eventId=i,t.name=t.name||t.type,t}static getCapWhitelistForAppTypeInRoomId(e,t){const s=l.b.getValue("enableWidgetScreenshots",t)?[i.MatrixCapabilities.Screenshots]:[];return u.a.JITSI.matches(e)&&s.push(i.MatrixCapabilities.AlwaysOnScreen),s}static getLocalJitsiWrapperUrl(e={}){const t=["conferenceDomain=$domain","conferenceId=$conferenceId","isAudioOnly=$isAudioOnly","displayName=$matrix_display_name","avatarUrl=$matrix_avatar_url","userId=$matrix_user_id","roomId=$matrix_room_id","theme=$theme","roomName=$roomName"];e.auth&&t.push("auth="+e.auth);const s=t.join("&");let n=window.location.href;"https:"===window.location.protocol||e.forLocalRender||(n="https://app.element.io/");return new URL("jitsi.html#"+s,n).href}static getWidgetName(e){var t;return(null==e||null===(t=e.name)||void 0===t?void 0:t.trim())||Object(m.a)("Unknown App")}static getWidgetDataTitle(e){var t,s;return(null==e||null===(t=e.data)||void 0===t||null===(s=t.title)||void 0===s?void 0:s.trim())||""}static editWidget(e,t){l.b.getValue("feature_many_integration_managers")?d.a.sharedInstance().openAll(e,"type_"+t.type,t.id):d.a.sharedInstance().getPrimaryManager().open(e,"type_"+t.type,t.id)}static isManagedByManager(e){if(p.isScalarUrl(e.url)){const e=d.a.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();return p.isScalarUrl(t.apiUrl)}}return!1}}},function(e,t,s){"use strict";s.d(t,"c",(function(){return i})),s.d(t,"g",(function(){return o})),s.d(t,"f",(function(){return a})),s.d(t,"d",(function(){return r})),s.d(t,"b",(function(){return c})),s.d(t,"e",(function(){return l})),s.d(t,"a",(function(){return d}));var n=s(121);function i(e,t){const s=new Map(Object.entries(e));for(const e of t)s.delete(e);return Array.from(s.entries()).reduce((e,[t,s])=>(e[t]=s,e),{})}function o(e,t){const s=Object.keys(e),o=Object(n.a)(s,t);return 0===o.removed.length?a(e):i(e,o.removed)}function a(e,t){const s={};for(const[n,i]of Object.entries(e))s[n]=i,t&&(s[n]=t(n,i));return s}function r(e,t){if(e===t)return!1;const s=Object.keys(e),i=Object.keys(t);if(s.length!==i.length)return!0;const o=Object(n.k)(s,i);return o.length!==s.length||o.some(s=>e[s]!==t[s])}function c(e,t){const s=Object.keys(e),i=Object.keys(t),o=Object(n.a)(s,i);return{changed:Object(n.k)(s,i).filter(s=>e[s]!==t[s]),added:o.added,removed:o.removed}}function l(e,t){const s=c(e,t);return Object(n.f)(s.removed,s.added,s.changed)}function d(e){return JSON.parse(JSON.stringify(e))}},function(e,t,s){"use strict";async function n(e){try{if(navigator&&navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(e),!0;{const t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t);const s=document.getSelection(),n=document.createRange();n.selectNode(t),s.removeAllRanges(),s.addRange(n);const i=document.execCommand("copy");return s.removeAllRanges(),document.body.removeChild(t),i}}catch(e){console.error("copyPlaintext failed",e)}return!1}function i(e){const t=document.createRange();t.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(t)}function o(e){return i(e),document.execCommand("copy")}s.d(t,"c",(function(){return n})),s.d(t,"d",(function(){return i})),s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return r}));const a=new Intl.Collator;function r(e,t){return a.compare(e,t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(97),c=s.n(r),l=s(101),d=s.n(l),u=s(95),h=s(92);class m extends a.a.Component{constructor(...e){super(...e),i()(this,"onOk",()=>{this.props.onFinished(!0)}),i()(this,"onCancel",()=>{this.props.onFinished(!1)})}render(){const e=u.getComponent("views.dialogs.BaseDialog"),t=u.getComponent("views.elements.DialogButtons");let s="";return this.props.danger&&(s="danger"),a.a.createElement(e,{className:d()("mx_QuestionDialog",this.props.className),onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content",headerImage:this.props.headerImage,hasCancel:this.props.hasCancelButton,fixedWidth:this.props.fixedWidth},a.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},this.props.description),a.a.createElement(t,{primaryButton:this.props.button||Object(h.a)("OK"),primaryButtonClass:s,primaryDisabled:this.props.buttonDisabled,cancelButton:this.props.cancelButton,hasCancel:this.props.hasCancelButton&&!this.props.quitOnly,onPrimaryButtonClick:this.onOk,focus:this.props.focus,onCancel:this.onCancel},this.props.extraButtons))}}i()(m,"propTypes",{title:c.a.string,description:c.a.node,extraButtons:c.a.node,button:c.a.string,buttonDisabled:c.a.bool,danger:c.a.bool,focus:c.a.bool,onFinished:c.a.func.isRequired,headerImage:c.a.string,quitOnly:c.a.bool,fixedWidth:c.a.bool,className:c.a.string}),i()(m,"defaultProps",{title:"",description:"",extraButtons:null,focus:!0,hasCancelButton:!0,danger:!1,quitOnly:!1})},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(18),i=s.n(n),o=s(8),a=s.n(o);class r extends a.a{constructor(...e){super(...e),i()(this,"toasts",[]),i()(this,"countSeen",0)}static sharedInstance(){return window.mxToastStore||(window.mxToastStore=new r),window.mxToastStore}reset(){this.toasts=[],this.countSeen=0}addOrReplaceToast(e){const t=this.toasts.findIndex(t=>t.key===e.key);if(-1===t){let t=this.toasts.length;for(;t>0&&this.toasts[t-1].priority<e.priority;)--t;this.toasts.splice(t,0,e)}else this.toasts[t]=e;this.emit("update")}dismissToast(e){this.toasts[0]&&this.toasts[0].key===e&&this.countSeen++;const t=this.toasts.length;this.toasts=this.toasts.filter(t=>t.key!==e),t!==this.toasts.length&&(0===this.toasts.length&&(this.countSeen=0),this.emit("update"))}getToasts(){return this.toasts}getCountSeen(){return this.countSeen}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return R})),s.d(t,"b",(function(){return I})),s.d(t,"e",(function(){return x})),s.d(t,"c",(function(){return T})),s.d(t,"d",(function(){return j})),s.d(t,"g",(function(){return M})),s.d(t,"f",(function(){return F}));var n=s(18),i=s.n(n),o=s(117),a=s(110),r=s(156),c=s(96),l=s(159),d=s(98),u=s(127),h=s(203),m=s(121),p=s(219);class g extends p.b{constructor(e,t){super(),this.spaceId=e,this.getRoomFn=t,i()(this,"rooms",[]),i()(this,"states",{}),i()(this,"onRoomNotificationStateUpdate",()=>{this.calculateTotalState()})}get symbol(){return null}setRooms(e){const t=this.rooms,s=Object(m.a)(t,e);this.rooms=e;for(const e of s.removed){const t=this.states[e.roomId];t&&(delete this.states[e.roomId],t.off(p.a,this.onRoomNotificationStateUpdate))}for(const e of s.added){const t=this.getRoomFn(e);t.on(p.a,this.onRoomNotificationStateUpdate),this.states[e.roomId]=t}this.calculateTotalState()}destroy(){super.destroy();for(const e of Object.values(this.states))e.off(p.a,this.onRoomNotificationStateUpdate);this.states={}}calculateTotalState(){const e=this.snapshot();this._count=0,this._color=h.a.None;for(const e of Object.values(this.states))this._count+=e.count,this._color=Math.max(this.color,e.color);this.emitIfUpdated(e)}}var v=s(174),f=s(146),b=s(320),y=s(359),_=s(133),E=s(103),S=s(141),w=s(1);const C=(e,t,s,n=50)=>{var i,o,a,r,c,l;if(t<0||s<0||t>e.length||s>e.length||t===s)return[];const d=e.map((e,t)=>({index:t,order:e})),u=Object(m.l)(d,t,s),h=void 0===(null===(i=u[s-1])||void 0===i?void 0:i.order);let p=s,g=s,v=!0;const f=void 0!==(null===(o=u[s+1])||void 0===o?void 0:o.order)?Object(w.G)(u[s+1].order):BigInt(Number.MAX_VALUE);for(let e=s-1,t=1;e>=0;e--,t++){var b;if(void 0!==(null===(b=u[e])||void 0===b?void 0:b.order)&&f-Object(w.G)(u[e].order)>t)break;p=e}const y=void 0===u[0].order?void 0:Object(w.G)(u[0].order),_=BigInt(s);0===p&&void 0!==y&&f-y<=_&&y<=_&&(v=!1);const E=!h;let S=E;if(E){var C,k;const e=void 0!==(null===(C=u[s-1])||void 0===C?void 0:C.order)?Object(w.G)(null===(k=u[s-1])||void 0===k?void 0:k.order):BigInt(Number.MIN_VALUE);for(let t=s+1,n=1;t<u.length;t++,n++){var O;if(void 0===(null===(O=u[t])||void 0===O?void 0:O.order)||Object(w.G)(u[t].order)-e>n)break;g=t}g===u.length-1&&(u[g]?Object(w.G)(u[g].order):BigInt(Number.MAX_VALUE))-e<=g-s&&(S=!1)}const R=v?s-p:Number.MAX_SAFE_INTEGER,I=S?g-s:Number.MAX_SAFE_INTEGER;h||R<I?g=s:p=s;const x=null!==(a=null===(r=u[p-1])||void 0===r?void 0:r.order)&&void 0!==a?a:"";return function e(t,s,n,i,o=w.a){const a=Math.min(Math.max(t.length,s.length),i),r=Object(w.b)(t,a,o),c=Object(w.b)(s,a,o),l=Object(w.G)(r,o),d=Object(w.G)(c,o);if(d-l-BigInt(1)<n)return a<i?e(Object(w.b)(r,a+1,o),Object(w.b)(c,a+1,o),n,a+1,o):[];const u=(d-l)/BigInt(n+1),h=BigInt(l+u);return Array(n).fill(void 0).map((e,t)=>Object(w.d)(h+BigInt(t)*u,o))}(x,null!==(c=null===(l=u[g+1])||void 0===l?void 0:l.order)&&void 0!==c?c:w.a.charAt(w.a.length-1).repeat(x.length||1),1+g-p,n).map((e,t)=>({index:u[p+t].index,order:e}))};function k(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function O(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?k(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):k(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const R=Symbol("home-space"),I=Symbol("suggested-rooms"),x=Symbol("top-level-spaces"),T=Symbol("invited-spaces"),j=Symbol("selected-space"),N=d.b.getValue("feature_spaces.all_rooms")?"ALL_ROOMS":"HOME_SPACE",P=e=>"mx_space_context_"+((null==e?void 0:e.roomId)||N),D=e=>e.reduce((e,t)=>(e[t.isSpaceRoom()?0:1].push(t),e),[[],[]]),A=e=>{if("string"==typeof e&&e.length<=50&&Array.from(e).every(e=>{const t=e.charCodeAt(0);return t>=32&&t<=126}))return e},M=(e,t,s)=>[A(e),t,s],U=e=>v.a.instance.getRoomState(e);class L extends r.a{constructor(){super(c.a,{}),i()(this,"rootSpaces",[]),i()(this,"orphanedRooms",new Set),i()(this,"parentMap",new b.a),i()(this,"notificationStateMap",new Map),i()(this,"spaceFilteredRooms",new Map),i()(this,"_activeSpace",null),i()(this,"_suggestedRooms",[]),i()(this,"_invitedSpaces",new Set),i()(this,"spaceOrderLocalEchoMap",new Map),i()(this,"fetchSuggestedRooms",async(e,t=20)=>{try{const s=await this.matrixClient.getSpaceSummary(e.roomId,0,!0,!1,t),n=new b.a;return s.events.forEach(e=>{var t;e.type===a.a.SpaceChild&&null!==(t=e.content.via)&&void 0!==t&&t.length&&e.content.via.forEach(t=>{n.getOrCreate(e.state_key,new Set).add(t)})}),s.rooms.filter(e=>{var t;return e.room_type!==a.e.Space&&"join"!==(null===(t=this.matrixClient.getRoom(e.room_id))||void 0===t?void 0:t.getMyMembership())}).map(e=>O(O({},e),{},{viaServers:Array.from(n.get(e.room_id)||[])}))}catch(e){console.error(e)}return[]}),i()(this,"getSpaceFilteredRoomIds",e=>!e&&d.b.getValue("feature_spaces.all_rooms")?new Set(this.matrixClient.getVisibleRooms().map(e=>e.roomId)):this.spaceFilteredRooms.get((null==e?void 0:e.roomId)||R)||new Set),i()(this,"rebuild",Object(o.throttle)(()=>{const[e,t]=D(this.matrixClient.getVisibleRooms()),[s,n]=e.reduce((e,t)=>("join"===t.getMyMembership()?e[0].push(t):"invite"===t.getMyMembership()&&e[1].push(t),e),[[],[]]),i=new Set([...t,...s]),a=new b.a,r=Object(o.sortBy)(s,e=>e.roomId);r.forEach(e=>{this.getChildren(e.roomId).forEach(t=>{i.delete(t),a.getOrCreate(t.roomId,new Set).add(e.roomId)})});const[c,l]=D(Array.from(i)),d=new Set(r),u=(e,t)=>{const s=[e];for(;s.length;){const e=s.pop();t.delete(e),this.getChildSpaces(e.roomId).forEach(e=>{t.has(e)&&s.push(e)})}};c.forEach(e=>{u(e,d)}),Array.from(d).forEach(e=>{d.has(e)&&(d.delete(e),c.push(e),u(e,d))}),this.orphanedRooms=new Set(l.map(e=>e.roomId)),this.rootSpaces=this.sortRootSpaces(c),this.parentMap=a,this._activeSpace&&d.has(this._activeSpace)&&this.setActiveSpace(null,!1),this.onRoomsUpdate(),this.emit(x,this.spacePanelSpaces),this._invitedSpaces=new Set(this.sortRootSpaces(n)),this.emit(T,this.invitedSpaces)},100,{trailing:!0,leading:!0})),i()(this,"onSpaceUpdate",()=>{this.rebuild()}),i()(this,"showInHomeSpace",e=>{var t;return!!d.b.getValue("feature_spaces.all_rooms")||!e.isSpaceRoom()&&(!(null!==(t=this.parentMap.get(e.roomId))&&void 0!==t&&t.size)||u.a.shared().getUserIdForRoomId(e.roomId)||l.b.instance.getTagsForRoom(e).includes(f.a.Favourite))}),i()(this,"onRoomUpdate",e=>{var t;if(this.showInHomeSpace(e))null===(t=this.spaceFilteredRooms.get(R))||void 0===t||t.add(e.roomId),this.emit(R);else if(!this.orphanedRooms.has(e.roomId)){var s;null===(s=this.spaceFilteredRooms.get(R))||void 0===s||s.delete(e.roomId),this.emit(R)}}),i()(this,"onSpaceMembersChange",e=>{u.a.shared().getDMRoomsForUserId(e.getStateKey()).length<1||this.onRoomsUpdate()}),i()(this,"onRoomsUpdate",Object(o.throttle)(()=>{const e=this.matrixClient.getVisibleRooms(),t=this.spaceFilteredRooms;if(this.spaceFilteredRooms=new Map,!d.b.getValue("feature_spaces.all_rooms")){const t=e.filter(e=>!e.isSpaceRoom()&&"invite"===e.getMyMembership());this.spaceFilteredRooms.set(R,new Set(t.map(e=>e.roomId))),e.forEach(e=>{this.showInHomeSpace(e)&&this.spaceFilteredRooms.get(R).add(e.roomId)})}this.rootSpaces.forEach(e=>{const t=(e,s)=>{var n;if(s.has(e))return;if(this.spaceFilteredRooms.has(e))return this.spaceFilteredRooms.get(e);const[i,o]=D(this.getChildren(e)),a=new Set(o.map(e=>e.roomId)),r=null===(n=this.matrixClient)||void 0===n?void 0:n.getRoom(e);d.b.getValue("feature_spaces.space_member_dms")&&(null==r||r.getMembers().forEach(e=>{"join"!==e.membership&&"invite"!==e.membership||u.a.shared().getDMRoomsForUserId(e.userId).forEach(e=>{a.add(e)})}));const c=new Set(s).add(e);return i.forEach(e=>{var s;null===(s=t(e.roomId,c))||void 0===s||s.forEach(e=>{a.add(e)})}),this.spaceFilteredRooms.set(e,a),a};t(e.roomId,new Set)});const s=Object(b.b)(t,this.spaceFilteredRooms),n=s.changed.filter(e=>Object(y.a)(t.get(e),this.spaceFilteredRooms.get(e)));[...s.added,...s.removed,...n].forEach(e=>{this.emit(e)}),this.spaceFilteredRooms.forEach((t,s)=>{var n;null===(n=this.getNotificationState(s))||void 0===n||n.setRooms(e.filter(e=>!!t.has(e.roomId)&&(!(s===R||!d.b.getValue("feature_spaces.space_dm_badges"))||(!u.a.shared().getUserIdForRoomId(e.roomId)||l.b.instance.getTagsForRoom(e).includes(f.a.Favourite)))))})},100,{trailing:!0,leading:!0})),i()(this,"switchToRelatedSpace",e=>{if(this.suggestedRooms.find(t=>t.room_id===e))return;let t=this.getCanonicalParent(e);if(t||(t=this.rootSpaces.find(t=>{var s;return null===(s=this.spaceFilteredRooms.get(t.roomId))||void 0===s?void 0:s.has(e)})),!t){const s=Array.from(this.parentMap.get(e)||[]);for(const e of s){const s=this.matrixClient.getRoom(e);if(s){t=s;break}}}this.setActiveSpace(t||null,!1)}),i()(this,"onRoom",(e,t,s)=>{const n=t||e.getMyMembership();if(e.isSpaceRoom())"invite"===n?(this._invitedSpaces.add(e),this.emit(T,this.invitedSpaces)):"invite"===s&&"join"!==n?(this._invitedSpaces.delete(e),this.emit(T,this.invitedSpaces)):(this.onSpaceUpdate(),this.emit(e.roomId)),"join"===n&&e.roomId===_.a.getRoomId()&&this.setActiveSpace(e,!1);else if(this.onRoomsUpdate(),"join"===n){const s=this._suggestedRooms.length;this._suggestedRooms=this._suggestedRooms.filter(t=>t.room_id!==e.roomId),s!==this._suggestedRooms.length&&this.emit(I,this._suggestedRooms),"join"===t&&e.roomId===_.a.getRoomId()&&this.switchToRelatedSpace(e.roomId)}}),i()(this,"onRoomState",e=>{const t=this.matrixClient.getRoom(e.getRoomId());if(t)switch(e.getType()){case a.a.SpaceChild:t.isSpaceRoom()&&(this.onSpaceUpdate(),this.emit(t.roomId));break;case a.a.SpaceParent:t.isSpaceRoom()?this.onSpaceUpdate():d.b.getValue("feature_spaces.all_rooms")||this.onRoomUpdate(t),this.emit(t.roomId);break;case a.a.RoomMember:t.isSpaceRoom()&&this.onSpaceMembersChange(e)}}),i()(this,"onRoomAccountData",(e,t,s)=>{if(t.isSpaceRoom())if(e.getType()===a.a.SpaceOrder){var n,i;this.spaceOrderLocalEchoMap.delete(t.roomId);(null===(n=e.getContent())||void 0===n?void 0:n.order)!==(null==s||null===(i=s.getContent())||void 0===i?void 0:i.order)&&this.notifyIfOrderChanged()}else if(e.getType()===a.a.Tag&&!d.b.getValue("feature_spaces.all_rooms")){var o,r;const n=(null==s||null===(o=s.getContent())||void 0===o?void 0:o.tags)||{},i=(null===(r=e.getContent())||void 0===r?void 0:r.tags)||{};!!n[f.a.Favourite]!=!!i[f.a.Favourite]&&this.onRoomUpdate(t)}}),i()(this,"onAccountData",(e,t)=>{if(e.getType()===a.a.Direct){const s=t.getContent(),n=e.getContent(),i=Object(S.b)(s,n),o=i.changed.filter(e=>Object(m.d)(s[e],n[e]));new Set([...i.added,...i.removed,...o]).forEach(e=>{var t;const s=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(e);s&&this.onRoomUpdate(s)})}}),i()(this,"getSpaceTagOrdering",e=>{var t,s;return this.spaceOrderLocalEchoMap.has(e.roomId)?this.spaceOrderLocalEchoMap.get(e.roomId):A(null===(t=e.getAccountData(a.a.SpaceOrder))||void 0===t||null===(s=t.getContent())||void 0===s?void 0:s.order)})}get invitedSpaces(){return Array.from(this._invitedSpaces)}get spacePanelSpaces(){return this.rootSpaces}get activeSpace(){return this._activeSpace||null}get suggestedRooms(){return this._suggestedRooms}async setActiveSpace(e,t=!0){if(e!==this.activeSpace&&(!e||null!=e&&e.isSpaceRoom())){if(this._activeSpace=e,this.emit(j,this.activeSpace),this.emit(I,this._suggestedRooms=[]),t){var s,n;const t=window.localStorage.getItem(P(this.activeSpace));"invite"!==(null==e?void 0:e.getMyMembership())&&"join"===(null===(s=this.matrixClient)||void 0===s||null===(n=s.getRoom(t))||void 0===n?void 0:n.getMyMembership())?c.a.dispatch({action:"view_room",room_id:t,context_switch:!0}):e?c.a.dispatch({action:"view_room",room_id:e.roomId,context_switch:!0}):c.a.dispatch({action:"view_home_page"})}if(e?window.localStorage.setItem("mx_active_space",e.roomId):window.localStorage.removeItem("mx_active_space"),e){const t=await this.fetchSuggestedRooms(e);this._activeSpace===e&&(this._suggestedRooms=t,this.emit(I,this._suggestedRooms))}}}addRoomToSpace(e,t,s,n=!1,i=!1){return this.matrixClient.sendStateEvent(e.roomId,a.a.SpaceChild,{via:s,suggested:n,auto_join:i},t)}getChildren(e){var t;const s=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(e),n=null==s?void 0:s.currentState.getStateEvents(a.a.SpaceChild).filter(e=>{var t;return null===(t=e.getContent())||void 0===t?void 0:t.via});return Object(o.sortBy)(n,e=>{var t,s;const n=e.getStateKey(),i=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(n),o=null==i||null===(s=i.currentState.getStateEvents(a.a.RoomCreate,""))||void 0===s?void 0:s.getTs();return M(e.getContent().order,o,n)}).map(e=>this.matrixClient.getRoom(e.getStateKey())).filter(e=>"join"===(null==e?void 0:e.getMyMembership())||"invite"===(null==e?void 0:e.getMyMembership()))||[]}getChildRooms(e){return this.getChildren(e).filter(e=>!e.isSpaceRoom())}getChildSpaces(e){return this.getChildren(e).filter(e=>e.isSpaceRoom()&&"join"===e.getMyMembership())}getParents(e,t=!1){var s;const n=null===(s=this.matrixClient)||void 0===s?void 0:s.getRoom(e);return(null==n?void 0:n.currentState.getStateEvents(a.a.SpaceParent).filter(e=>{var s;const n=e.getContent();return!(null==n||null===(s=n.via)||void 0===s||!s.length)&&!(t&&(null==n||!n.canonical))}).map(e=>this.matrixClient.getRoom(e.getStateKey())).filter(Boolean))||[]}getCanonicalParent(e){var t;const s=this.getParents(e,!0);return(null===(t=Object(o.sortBy)(s,e=>e.roomId))||void 0===t?void 0:t[0])||null}notifyIfOrderChanged(){const e=this.sortRootSpaces(this.rootSpaces);Object(m.e)(this.rootSpaces,e)&&(this.rootSpaces=e,this.emit(x,this.spacePanelSpaces))}async reset(){this.rootSpaces=[],this.orphanedRooms=new Set,this.parentMap=new b.a,this.notificationStateMap=new Map,this.spaceFilteredRooms=new Map,this._activeSpace=null,this._suggestedRooms=[],this._invitedSpaces=new Set}async onNotReady(){d.b.getValue("feature_spaces")&&(this.matrixClient&&(this.matrixClient.removeListener("Room",this.onRoom),this.matrixClient.removeListener("Room.myMembership",this.onRoom),this.matrixClient.removeListener("Room.accountData",this.onRoomAccountData),this.matrixClient.removeListener("RoomState.events",this.onRoomState),d.b.getValue("feature_spaces.all_rooms")||this.matrixClient.removeListener("accountData",this.onAccountData)),await this.reset())}async onReady(){if(!d.b.getValue("feature_spaces"))return;this.matrixClient.on("Room",this.onRoom),this.matrixClient.on("Room.myMembership",this.onRoom),this.matrixClient.on("Room.accountData",this.onRoomAccountData),this.matrixClient.on("RoomState.events",this.onRoomState),d.b.getValue("feature_spaces.all_rooms")||this.matrixClient.on("accountData",this.onAccountData),await this.onSpaceUpdate();const e=window.localStorage.getItem("mx_active_space");e&&this.setActiveSpace(this.matrixClient.getRoom(e))}async onAction(e){if(d.b.getValue("feature_spaces"))switch(e.action){case"view_room":{var t;if(e.context_switch)break;const s=e.room_id,n=null===(t=this.matrixClient)||void 0===t?void 0:t.getRoom(s);null!=n&&n.isSpaceRoom()?this.setActiveSpace(n,!1):d.b.getValue("feature_spaces.all_rooms")&&!this.activeSpace||this.getSpaceFilteredRoomIds(this.activeSpace).has(s)||this.switchToRelatedSpace(s),window.localStorage.setItem(P(this.activeSpace),e.room_id);break}case"after_leave_room":this._activeSpace&&e.room_id===this._activeSpace.roomId&&this.setActiveSpace(null,!1);break;case E.a.SwitchSpace:0===e.num?this.setActiveSpace(null):this.spacePanelSpaces.length>=e.num&&this.setActiveSpace(this.spacePanelSpaces[e.num-1])}}getNotificationState(e){if(this.notificationStateMap.has(e))return this.notificationStateMap.get(e);const t=new g(e,U);return this.notificationStateMap.set(e,t),t}traverseSpace(e,t,s=!1,n){if(n&&n.has(e))return;t(e);const i=new Set(n).add(e),[o,a]=D(this.getChildren(e));s&&a.forEach(e=>t(e.roomId)),o.forEach(e=>this.traverseSpace(e.roomId,t,s,i))}sortRootSpaces(e){return Object(o.sortBy)(e,[this.getSpaceTagOrdering,"roomId"])}async setRootSpaceOrder(e,t){this.spaceOrderLocalEchoMap.set(e.roomId,t);try{await this.matrixClient.setRoomAccountData(e.roomId,a.a.SpaceOrder,{order:t})}catch(s){console.warn("Failed to set root space order",s),this.spaceOrderLocalEchoMap.get(e.roomId)===t&&this.spaceOrderLocalEchoMap.delete(e.roomId)}}moveRootSpace(e,t){const s=this.rootSpaces.map(this.getSpaceTagOrdering);C(s,e,t).forEach(({index:e,order:t})=>{this.setRootSpaceOrder(this.rootSpaces[e],t)}),this.notifyIfOrderChanged()}}class F{static get instance(){return F.internalInstance}}i()(F,"internalInstance",new L),window.mxSpaceStore=F.instance},function(e,t,s){"use strict";function n(e,t){return function(e){const t=Object.keys(e),s=[];for(const n of t){const t=e[n];(Number.isFinite(t)||e[t.toString()]!==Number(n))&&s.push(t)}return s}(e).includes(t)}let i;s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o})),s.d(t,"d",(function(){return a})),s.d(t,"c",(function(){return r})),function(e){e.Invite="im.vector.fake.invite",e.Untagged="im.vector.fake.recent",e.Archived="im.vector.fake.archived",e.LowPriority="m.lowpriority",e.Favourite="m.favourite",e.DM="im.vector.fake.direct",e.Unified="de.spiritcroc.fake.unified",e.ServerNotice="m.server_notice",e.Suggested="im.vector.fake.suggested"}(i||(i={}));const o=[i.Invite,i.Favourite,i.Unified,i.DM,i.Untagged,i.LowPriority,i.ServerNotice,i.Suggested,i.Archived];function a(e){return!n(i,e)}let r;!function(e){e.Timeline="TIMELINE",e.PossibleTagChange="POSSIBLE_TAG_CHANGE",e.ReadReceipt="READ_RECEIPT",e.NewRoom="NEW_ROOM",e.RoomRemoved="ROOM_REMOVED"}(r||(r={}))},,function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i,o,a=s(104),r=s.n(a),c=s(108),l=s.n(c),d=s(18),u=s.n(d),h=s(91),m=s.n(h),p=s(186),g=s(93);let v=Object(g.a)("views.elements.StyledCheckbox")((o=i=class extends m.a.PureComponent{constructor(e){super(e),u()(this,"id",void 0),this.id="checkbox_"+Object(p.b)(10)}render(){const e=this.props,{children:t,className:n}=e,i=l()(e,["children","className"]);return m.a.createElement("span",{className:"mx_Checkbox "+n},m.a.createElement("input",r()({id:this.id},i,{type:"checkbox"})),m.a.createElement("label",{htmlFor:this.id},m.a.createElement("div",{className:"mx_Checkbox_background"},m.a.createElement("img",{src:s(769)})),m.a.createElement("div",null,this.props.children)))}},u()(i,"defaultProps",{className:""}),n=o))||n},function(e,t,s){"use strict";function n(e,t){return new Promise(s=>{setTimeout(s,e,t)})}async function i(e,t,s){const n=new Promise(n=>{const i=setTimeout(n,s,t);e.then(()=>{clearTimeout(i)})});return Promise.race([e,n])}function o(){let e,t;const s=new Promise((s,n)=>{e=s,t=n});return{resolve:e,reject:t,promise:s}}async function a(e,t,s){let n;for(let i=0;i<t;i++)try{return await e()}catch(e){if(s&&!s(e))throw e;n=e}throw n}s.d(t,"c",(function(){return n})),s.d(t,"d",(function(){return i})),s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return a}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"c",(function(){return l})),s.d(t,"b",(function(){return d})),s.d(t,"d",(function(){return u})),s.d(t,"e",(function(){return h})),s.d(t,"f",(function(){return m}));var n=s(92);function i(){return[Object(n.a)("Sun"),Object(n.a)("Mon"),Object(n.a)("Tue"),Object(n.a)("Wed"),Object(n.a)("Thu"),Object(n.a)("Fri"),Object(n.a)("Sat")]}function o(){return[Object(n.a)("Jan"),Object(n.a)("Feb"),Object(n.a)("Mar"),Object(n.a)("Apr"),Object(n.a)("May"),Object(n.a)("Jun"),Object(n.a)("Jul"),Object(n.a)("Aug"),Object(n.a)("Sep"),Object(n.a)("Oct"),Object(n.a)("Nov"),Object(n.a)("Dec")]}function a(e){return(e<10?"0":"")+e}function r(e,t=!1){let s=e.getHours()%12;const i=a(e.getMinutes()),o=e.getHours()>=12?Object(n.a)("PM"):Object(n.a)("AM");if(s=s||12,t){return`${s}:${i}:${a(e.getSeconds())}${o}`}return`${s}:${i}${o}`}function c(e,t=!1){const s=new Date,a=i(),r=o();return e.toDateString()===s.toDateString()?h(e,t):s.getTime()-e.getTime()<5184e5?Object(n.a)("%(weekDayName)s %(time)s",{weekDayName:a[e.getDay()],time:h(e,t)}):s.getFullYear()===e.getFullYear()?Object(n.a)("%(weekDayName)s, %(monthName)s %(day)s %(time)s",{weekDayName:a[e.getDay()],monthName:r[e.getMonth()],day:e.getDate(),time:h(e,t)}):d(e,t)}function l(e){const t=i(),s=o();return Object(n.a)("%(weekDayName)s, %(monthName)s %(day)s %(fullYear)s",{weekDayName:t[e.getDay()],monthName:s[e.getMonth()],day:e.getDate(),fullYear:e.getFullYear()})}function d(e,t=!1,s=!0){const a=i(),r=o();return Object(n.a)("%(weekDayName)s, %(monthName)s %(day)s %(fullYear)s %(time)s",{weekDayName:a[e.getDay()],monthName:r[e.getMonth()],day:e.getDate(),fullYear:e.getFullYear(),time:s?u(e,t):h(e,t)})}function u(e,t=!1){return t?r(e,!0):a(e.getHours())+":"+a(e.getMinutes())+":"+a(e.getSeconds())}function h(e,t=!1){return t?r(e):a(e.getHours())+":"+a(e.getMinutes())}function m(e,t){return!(!t||!e)&&(Math.abs(e.getTime()-t.getTime())>864e5||e.getDay()!==t.getDay())}},,function(e,t,s){"use strict";s.r(t),function(e){s.d(t,"request",(function(){return T})),s.d(t,"getRequest",(function(){return j})),s.d(t,"wrapRequest",(function(){return N})),s.d(t,"setCryptoStoreFactory",(function(){return D})),s.d(t,"createClient",(function(){return A}));var n=s(273),i=s(260),o=s(388),a=s(178);s.d(t,"CRYPTO_ENABLED",(function(){return a.a})),s.d(t,"RoomVersionStability",(function(){return a.c})),s.d(t,"MatrixClient",(function(){return a.b}));var r=s(271);s.d(t,"PREFIX_R0",(function(){return r.h})),s.d(t,"PREFIX_UNSTABLE",(function(){return r.i})),s.d(t,"PREFIX_IDENTITY_V1",(function(){return r.e})),s.d(t,"PREFIX_IDENTITY_V2",(function(){return r.f})),s.d(t,"PREFIX_MEDIA_R0",(function(){return r.g})),s.d(t,"MatrixHttpApi",(function(){return r.d})),s.d(t,"MatrixError",(function(){return r.c})),s.d(t,"ConnectionError",(function(){return r.b})),s.d(t,"AbortError",(function(){return r.a})),s.d(t,"retryNetworkOperation",(function(){return r.j}));var c=s(240);s.d(t,"AutoDiscovery",(function(){return c.a}));var l=s(19);s.d(t,"SyncAccumulator",(function(){return l.a}));var d=s(215);s.d(t,"InvalidStoreError",(function(){return d.b})),s.d(t,"InvalidCryptoStoreError",(function(){return d.a})),s.d(t,"KeySignatureUploadError",(function(){return d.c}));var u=s(114);s.d(t,"EventStatus",(function(){return u.a})),s.d(t,"MatrixEvent",(function(){return u.b}));var h=s(230);s.d(t,"NotificationCountType",(function(){return h.a})),s.d(t,"Room",(function(){return h.b}));var m=s(239);s.d(t,"Group",(function(){return m.a}));var p=s(167);s.d(t,"EventTimeline",(function(){return p.a}));var g=s(350);s.d(t,"EventTimelineSet",(function(){return g.a}));var v=s(168);s.d(t,"RoomMember",(function(){return v.a}));var f=s(353);s.d(t,"RoomState",(function(){return f.a}));var b=s(210);s.d(t,"User",(function(){return b.a})),s.d(t,"MatrixScheduler",(function(){return o.a}));var y=s(294);s.d(t,"Filter",(function(){return y.a}));var _=s(392);s.d(t,"TimelineWindow",(function(){return _.b})),s.d(t,"TimelineIndex",(function(){return _.a}));var E=s(393);s.d(t,"InteractiveAuth",(function(){return E.a}));var S=s(199);s.d(t,"SERVICE_TYPES",(function(){return S.a})),s.d(t,"MemoryStore",(function(){return i.a}));var w=s(319);s.d(t,"IndexedDBStore",(function(){return w.a}));var C=s(394);s.d(t,"WebStorageSessionStore",(function(){return C.a})),s.d(t,"MemoryCryptoStore",(function(){return n.a}));var k=s(160);s.d(t,"IndexedDBCryptoStore",(function(){return k.a}));var O=s(261);s.d(t,"getHttpUriForMxc",(function(){return O.a}));var R=s(318);s.d(t,"ContentHelpers",(function(){return R}));var I=s(158);let x;function T(e){x=e}function j(){return x}function N(e){const t=x;x=function(s,n){return e(t,s,n)}}s.d(t,"createNewMatrixCall",(function(){return I.g})),s.d(t,"setMatrixCallAudioInput",(function(){return I.i})),s.d(t,"setMatrixCallVideoInput",(function(){return I.j}));let P=()=>new n.a;function D(e){P=e}function A(t){return"string"==typeof t&&(t={baseUrl:t}),t.request=t.request||x,t.store=t.store||new i.a({localStorage:e.localStorage}),t.scheduler=t.scheduler||new o.a,t.cryptoStore=t.cryptoStore||P(),new a.b(t)}}.call(this,s(7))},function(e,t,s){"use strict";(function(e){s.d(t,"d",(function(){return L})),s.d(t,"a",(function(){return F})),s.d(t,"c",(function(){return B})),s.d(t,"b",(function(){return V})),s.d(t,"e",(function(){return K}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(94),c=s(118),l=s(99),d=s(92),u=s(96),h=s(140),m=s(244),p=s(98),g=s(401),v=s(161),f=s(106),b=s(572),y=s(143),_=s(135),E=s(217),S=s(245),w=s(5),C=s(158),k=s(132),O=s(120),R=s(116),I=s(0),x=s(573),T=s(103),j=s(584),N=s(969),P=s(186),D=s(8),A=s.n(D),M=s(102),U=s(137);const L="im.vector.is_virtual_room";let F,B,V;!function(e){e.Ring="ringAudio",e.Ringback="ringbackAudio",e.CallEnd="callendAudio",e.Busy="busyAudio"}(F||(F={})),function(e){e.Voice="voice",e.Video="video",e.ScreenSharing="screensharing"}(B||(B={})),function(e){e.CallsChanged="calls_changed",e.CallChangeRoom="call_change_room"}(V||(V={}));class K extends A.a{constructor(...e){super(...e),i()(this,"calls",new Map),i()(this,"transferees",new Map),i()(this,"audioPromises",new Map),i()(this,"dispatcherRef",null),i()(this,"supportsPstnProtocol",null),i()(this,"pstnSupportPrefixed",null),i()(this,"supportsSipNativeVirtual",null),i()(this,"pstnSupportCheckTimer",void 0),i()(this,"invitedRoomsAreVirtual",new Map),i()(this,"invitedRoomCheckInProgress",!1),i()(this,"assertedIdentityNativeUsers",new Map),i()(this,"onCallIncoming",e=>{u.a.dispatch({action:"incoming_call",call:e},!0)}),i()(this,"onAction",e=>{switch(e.action){case"place_call":{if(Object(N.b)())return void Object(N.a)(e.room_id);if(!r.a.get().supportsVoip())return void l.a.createTrackedDialog("Call Handler","VoIP is unsupported",_.a,{title:Object(d.a)("VoIP is unsupported"),description:Object(d.a)("You cannot place VoIP calls in this browser.")});if(this.getAllActiveCalls().length>1)return void l.a.createTrackedDialog("Call Handler","Existing Call",_.a,{title:Object(d.a)("Too Many Calls"),description:Object(d.a)("You've reached the maximum number of simultaneous calls.")});const t=r.a.get().getRoom(e.room_id);if(!t)return void console.error(`Room ${e.room_id} does not exist.`);if(this.getCallForRoom(t.roomId))return void l.a.createTrackedDialog("Call Handler","Existing Call with user",_.a,{title:Object(d.a)("Already in call"),description:Object(d.a)("You're already in a call with this person.")});const s=t.getJoinedMembers();if(s.length<=1)return void l.a.createTrackedDialog("Call Handler","Cannot place call with self",_.a,{description:Object(d.a)("You cannot place a call with yourself.")});2===s.length?(console.info(`Place ${e.type} call in ${e.room_id}`),this.placeCall(e.room_id,e.type,e.transferee)):u.a.dispatch({action:"place_conference_call",room_id:e.room_id,type:e.type})}break;case"place_conference_call":console.info("Place conference call in "+e.room_id),k.a.trackEvent("voip","placeConferenceCall"),O.a.instance.trackStartCall(e.room_id,e.type===B.Video,!0),this.startCallApp(e.room_id,e.type);break;case"end_conference":console.info("Terminating conference call in "+e.room_id),this.terminateCallApp(e.room_id);break;case"hangup_conference":console.info("Leaving conference call in "+e.room_id),this.hangupCallApp(e.room_id);break;case"incoming_call":{if(!r.a.get().supportsVoip())return;const t=e.call,s=K.sharedInstance().roomIdForCall(t);if(this.getCallForRoom(s))return void console.log("Got incoming call for room "+s+" but there's already a call for this room: ignoring");k.a.trackEvent("voip","receiveCall","type",t.type),console.log("Adding call for room ",s),this.calls.set(s,t),this.emit(V.CallsChanged,this.calls),this.setCallListeners(t);const n=r.a.get();n.prepareToEncrypt(n.getRoom(t.roomId))}break;case"hangup":case"reject":if(!this.calls.get(e.room_id))return;"reject"===e.action?this.calls.get(e.room_id).reject():this.calls.get(e.room_id).hangup(C.b.UserHangup,!1);break;case"hangup_all":for(const e of this.calls.values())e.hangup(C.b.UserHangup,!1);break;case"answer":{if(!this.calls.has(e.room_id))return;if(this.getAllActiveCalls().length>1)return void l.a.createTrackedDialog("Call Handler","Existing Call",_.a,{title:Object(d.a)("Too Many Calls"),description:Object(d.a)("You've reached the maximum number of simultaneous calls.")});const t=this.calls.get(e.room_id);t.answer(),this.setActiveCallRoomId(e.room_id),O.a.instance.trackJoinCall(e.room_id,t.type===C.f.Video,!1),u.a.dispatch({action:"view_room",room_id:e.room_id});break}case T.a.DialNumber:this.dialNumber(e.number)}})}static sharedInstance(){return window.mxCallHandler||(window.mxCallHandler=new K),window.mxCallHandler}roomIdForCall(e){if(!e)return null;const t=M.a.get().voip;if(t&&t.obeyAssertedIdentity){const t=this.assertedIdentityNativeUsers[e.callId];if(t){const e=Object(U.e)(r.a.get(),t);if(e)return e.roomId}}return j.a.sharedInstance().nativeRoomForVirtualRoom(e.roomId)||e.roomId}start(){this.dispatcherRef=u.a.register(this.onAction),navigator.mediaSession&&(navigator.mediaSession.setActionHandler("play",(function(){})),navigator.mediaSession.setActionHandler("pause",(function(){})),navigator.mediaSession.setActionHandler("seekbackward",(function(){})),navigator.mediaSession.setActionHandler("seekforward",(function(){})),navigator.mediaSession.setActionHandler("previoustrack",(function(){})),navigator.mediaSession.setActionHandler("nexttrack",(function(){}))),p.b.getValue(R.a.Voip)&&r.a.get().on("Call.incoming",this.onCallIncoming),this.checkProtocols(3)}stop(){const e=r.a.get();e&&e.removeListener("Call.incoming",this.onCallIncoming),null!==this.dispatcherRef&&(u.a.unregister(this.dispatcherRef),this.dispatcherRef=null)}async checkProtocols(e){try{const e=await r.a.get().getThirdpartyProtocols();void 0!==e["m.protocol.pstn"]?(this.supportsPstnProtocol=Boolean(e["m.protocol.pstn"]),this.supportsPstnProtocol&&(this.pstnSupportPrefixed=!1)):void 0!==e["im.vector.protocol.pstn"]?(this.supportsPstnProtocol=Boolean(e["im.vector.protocol.pstn"]),this.supportsPstnProtocol&&(this.pstnSupportPrefixed=!0)):this.supportsPstnProtocol=null,u.a.dispatch({action:T.a.PstnSupportUpdated}),void 0!==e["im.vector.protocol.sip_native"]&&void 0!==e["im.vector.protocol.sip_virtual"]&&(this.supportsSipNativeVirtual=Boolean(e["im.vector.protocol.sip_native"]&&e["im.vector.protocol.sip_virtual"])),u.a.dispatch({action:T.a.VirtualRoomSupportUpdated})}catch(t){1===e?console.log("Failed to check for protocol support and no retries remain: assuming no support",t):(console.log("Failed to check for protocol support: will retry",t),this.pstnSupportCheckTimer=setTimeout(()=>{this.checkProtocols(e-1)},1e4))}}getSupportsPstnProtocol(){return this.supportsPstnProtocol}getSupportsVirtualRooms(){return this.supportsSipNativeVirtual}pstnLookup(e){return r.a.get().getThirdpartyUser(this.pstnSupportPrefixed?"im.vector.protocol.pstn":"m.protocol.pstn",{"m.id.phone":e})}sipVirtualLookup(e){return r.a.get().getThirdpartyUser("im.vector.protocol.sip_virtual",{native_mxid:e})}sipNativeLookup(e){return r.a.get().getThirdpartyUser("im.vector.protocol.sip_native",{virtual_mxid:e})}getCallForRoom(e){return this.calls.get(e)||null}getAnyActiveCall(){for(const e of this.calls.values())if(e.state!==C.e.Ended)return e;return null}getAllActiveCalls(){const e=[];for(const t of this.calls.values())t.state!==C.e.Ended&&t.state!==C.e.Ringing&&e.push(t);return e}getAllActiveCallsNotInRoom(e){const t=[];for(const[s,n]of this.calls.entries())s!==e&&n.state!==C.e.Ended&&t.push(n);return t}getTransfereeForCallId(e){return this.transferees[e]}play(e){const t=document.getElementById(e);if(t){const s=async()=>{try{await t.play()}catch(e){console.log("Unable to play audio clip",e)}};this.audioPromises.has(e)?this.audioPromises.set(e,this.audioPromises.get(e).then(()=>(t.load(),s()))):this.audioPromises.set(e,s())}}pause(e){const t=document.getElementById(e);t&&(this.audioPromises.has(e)?this.audioPromises.set(e,this.audioPromises.get(e).then(()=>t.pause())):t.pause())}matchesCallForThisRoom(e){const t=this.roomIdForCall(e),s=this.getCallForRoom(t);return s&&e.callId===s.callId}setCallListeners(e){let t=K.sharedInstance().roomIdForCall(e);e.on(C.c.Error,t=>{this.matchesCallForThisRoom(e)&&(k.a.trackEvent("voip","callError","error",t.toString()),console.error("Call error:",t),t.code!==C.b.NoUserMedia?0!==r.a.get().getTurnServers().length||null!==p.b.getValue("fallbackICEServerAllowed")?l.a.createTrackedDialog("Call Failed","",_.a,{title:Object(d.a)("Call Failed"),description:t.message}):this.showICEFallbackPrompt():this.showMediaCaptureError(e))}),e.on(C.c.Hangup,()=>{this.matchesCallForThisRoom(e)&&(k.a.trackEvent("voip","callHangup"),this.removeCallForRoom(t))}),e.on(C.c.State,(s,n)=>{if(this.matchesCallForThisRoom(e)){switch(this.setCallState(e,s),n){case C.e.Ringing:this.pause(F.Ring);break;case C.e.InviteSent:this.pause(F.Ringback)}switch(s){case C.e.Ringing:this.play(F.Ring);break;case C.e.InviteSent:this.play(F.Ringback);break;case C.e.Ended:if(k.a.trackEvent("voip","callEnded","hangupReason",e.hangupReason),this.removeCallForRoom(t),n===C.e.InviteSent&&(e.hangupParty===C.d.Remote||e.hangupParty===C.d.Local&&e.hangupReason===C.b.InviteTimeout)){let t,s;this.play(F.Busy),e.hangupReason===C.b.UserHangup?(t=Object(d.a)("Call Declined"),s=Object(d.a)("The other party declined the call.")):e.hangupReason===C.b.UserBusy?(t=Object(d.a)("User Busy"),s=Object(d.a)("The user you called is busy.")):e.hangupReason===C.b.InviteTimeout?(t=Object(d.a)("Call Failed"),s=Object(d.a)("The remote side failed to pick up")+"."):(t=Object(d.a)("Call Failed"),s=Object(d.a)("The call could not be established")),l.a.createTrackedDialog("Call Handler","Call Failed",_.a,{title:t,description:s})}else e.hangupReason===C.b.AnsweredElsewhere&&n===C.e.Connecting?l.a.createTrackedDialog("Call Handler","Call Failed",_.a,{title:Object(d.a)("Answered Elsewhere"),description:Object(d.a)("The call was answered on another device.")}):n!==C.e.Fledgling&&n!==C.e.Ringing&&this.play(F.CallEnd);this.logCallStats(e,t)}}}),e.on(C.c.Replaced,s=>{this.matchesCallForThisRoom(e)&&(console.log(`Call ID ${e.callId} is being replaced by call ID ${s.callId}`),e.state===C.e.Ringing?this.pause(F.Ring):e.state===C.e.InviteSent&&this.pause(F.Ringback),this.calls.set(t,s),this.emit(V.CallsChanged,this.calls),this.setCallListeners(s),this.setCallState(s,s.state))}),e.on(C.c.AssertedIdentityChanged,async()=>{if(!this.matchesCallForThisRoom(e))return;console.log(`Call ID ${e.callId} got new asserted identity:`,e.getRemoteAssertedIdentity());const s=e.getRemoteAssertedIdentity().id;let n=s;if(s){const e=await this.sipNativeLookup(s);e.length&&e[0].fields.lookup_success&&(n=e[0].userid)}if(console.log(`Asserted identity ${s} mapped to ${n}`),n){this.assertedIdentityNativeUsers[e.callId]=n,await Object(U.c)(r.a.get(),n);const s=this.roomIdForCall(e);console.log(`Old room ID: ${t}, new room ID: ${s}`),s!==t&&(this.removeCallForRoom(t),t=s,console.log("Moving call to room "+t),this.calls.set(t,e),this.emit(V.CallChangeRoom,e))}})}async logCallStats(e,t){const s=await e.getCurrentCallStats();if(I.a.debug(`Call completed. Call ID: ${e.callId}, virtual room ID: ${e.roomId}, user-facing room ID: ${t}, direction: ${e.direction}, our Party ID: ${e.ourPartyId}, hangup party: ${e.hangupParty}, hangup reason: `+e.hangupReason),s){I.a.debug("Local candidates:");for(const e of s.filter(e=>"local-candidate"===e.type)){const t=e.address||e.ip;I.a.debug(`${e.id} - type: ${e.candidateType}, address: ${t}, port: ${e.port}, protocol: ${e.protocol}, relay protocol: ${e.relayProtocol}, network type: ${e.networkType}`)}I.a.debug("Remote candidates:");for(const e of s.filter(e=>"remote-candidate"===e.type)){const t=e.address||e.ip;I.a.debug(`${e.id} - type: ${e.candidateType}, address: ${t}, port: ${e.port}, protocol: `+e.protocol)}I.a.debug("Candidate pairs:");for(const e of s.filter(e=>"candidate-pair"===e.type))I.a.debug(`${e.localCandidateId} / ${e.remoteCandidateId} - state: ${e.state}, nominated: ${e.nominated}, requests sent ${e.requestsSent}, requests received  ${e.requestsReceived},  responses received: ${e.responsesReceived}, responses sent: ${e.responsesSent}, bytes received: ${e.bytesReceived}, bytes sent: ${e.bytesSent}, `)}else I.a.debug("Call statistics are undefined. The call has probably failed before a peerConn was established")}setCallState(e,t){const s=K.sharedInstance().roomIdForCall(e);console.log(`Call state in ${s} changed to ${t}`),u.a.dispatch({action:"call_state",room_id:s,state:t})}removeCallForRoom(e){console.log("Removing call for room ",e),this.calls.delete(e),this.emit(V.CallsChanged,this.calls)}showICEFallbackPrompt(){const e=r.a.get(),t=e=>a.a.createElement("code",null,e);l.a.createTrackedDialog("No TURN servers","",y.a,{title:Object(d.a)("Call failed due to misconfigured server"),description:a.a.createElement("div",null,a.a.createElement("p",null,Object(d.a)("Please ask the administrator of your homeserver (<code>%(homeserverDomain)s</code>) to configure a TURN server in order for calls to work reliably.",{homeserverDomain:e.getDomain()},{code:t})),a.a.createElement("p",null,Object(d.a)("Alternatively, you can try to use the public server at <code>turn.matrix.org</code>, but this will not be as reliable, and it will share your IP address with that server. You can also manage this in Settings.",null,{code:t}))),button:Object(d.a)("Try using turn.matrix.org"),cancelButton:Object(d.a)("OK"),onFinished:t=>{p.b.setValue("fallbackICEServerAllowed",null,f.a.DEVICE,t),e.setFallbackICEServerAllowed(t)}},null,!0)}showMediaCaptureError(e){let t,s;e.type===C.f.Voice?(t=Object(d.a)("Unable to access microphone"),s=a.a.createElement("div",null,Object(d.a)("Call failed because microphone could not be accessed. Check that a microphone is plugged in and set up correctly."))):e.type===C.f.Video&&(t=Object(d.a)("Unable to access webcam / microphone"),s=a.a.createElement("div",null,Object(d.a)("Call failed because webcam or microphone could not be accessed. Check that:"),a.a.createElement("ul",null,a.a.createElement("li",null,Object(d.a)("A microphone and webcam are plugged in and set up correctly")),a.a.createElement("li",null,Object(d.a)("Permission is granted to use the webcam")),a.a.createElement("li",null,Object(d.a)("No other application is using the webcam"))))),l.a.createTrackedDialog("Media capture failed","",_.a,{title:t,description:s},null,!0)}async placeCall(e,t,s){k.a.trackEvent("voip","placeCall","type",t),O.a.instance.trackStartCall(e,t===B.Video,!1);const n=await j.a.sharedInstance().getOrCreateVirtualRoomForRoom(e)||e;I.a.debug("Mapped real room "+e+" to room ID "+n);const i=r.a.get().getTurnServersExpiry()-Date.now();console.log("Current turn creds expire in "+i+" ms");const o=r.a.get().createCall(n);if(console.log("Adding call for room ",e),this.calls.set(e,o),this.emit(V.CallsChanged,this.calls),s&&(this.transferees[o.callId]=s),this.setCallListeners(o),this.setActiveCallRoomId(e),t===B.Voice)o.placeVoiceCall();else if("video"===t)o.placeVideoCall();else if(t===B.ScreenSharing){const t=c.a.get().screenCaptureErrorString();if(t)return this.removeCallForRoom(e),console.log("Can't capture screen: "+t),void l.a.createTrackedDialog("Call Handler","Unable to capture screen",_.a,{title:Object(d.a)("Unable to capture screen"),description:t});o.placeScreenSharingCall(async()=>{const{finished:e}=l.a.createDialog(x.a),[t]=await e;return t})}else console.error("Unknown conf call type: "+t)}async dialNumber(e){const t=await this.pstnLookup(e);if(!t||0===t.length||!t[0].userid)return void l.a.createTrackedDialog("","",_.a,{title:Object(d.a)("Unable to look up phone number"),description:Object(d.a)("There was an error looking up the phone number")});const s=t[0].userid;let n;if(this.getSupportsVirtualRooms()){const t=await this.sipNativeLookup(s);n=t.length>0&&t[0].fields.lookup_success?t[0].userid:s,console.log("Looked up "+e+" to "+s+" and mapped to native user "+n)}else n=s;const i=await Object(U.c)(r.a.get(),n);u.a.dispatch({action:"view_room",room_id:i})}setActiveCallRoomId(e){I.a.info("Setting call in room "+e+" active");for(const[t,s]of this.calls.entries())s.state!==C.e.Ended&&(t===e?s.setRemoteOnHold(!1):(I.a.info("Holding call in room "+t+" because another call is being set active"),s.setRemoteOnHold(!0)))}hasAnyUnheldCall(){for(const e of this.calls.values())if(e.state!==C.e.Ended&&!e.isRemoteOnHold())return!0;return!1}async startCallApp(t,s){u.a.dispatch({action:"appsDrawer",show:!0});const n=r.a.get().getRoom(t),i=h.a.getRoomWidgetsOfType(n,v.a.JITSI);if(i.length>0||m.a.roomHasPendingWidgetsOfType(t,i,v.a.JITSI))return void l.a.createTrackedDialog("Call already in progress","",_.a,{title:Object(d.a)("Call in Progress"),description:Object(d.a)("A call is currently being placed!")});const o=g.a.getInstance().preferredDomain,a=await g.a.getInstance().getJitsiAuth();let c;if("openidtoken-jwt"===a)c=b.base32.stringify(e.from(t),{pad:!1});else{c="Jitsi"+(Object(P.c)(1)+Object(P.a)(23))}let p=h.a.getLocalJitsiWrapperUrl({auth:a});const f=new URL(p);f.search="",f.searchParams.set("confId",c),p=f.toString();const y={conferenceId:c,isAudioOnly:"voice"===s,domain:o,auth:a,roomName:n.name},E="jitsi_"+r.a.get().credentials.userId+"_"+Date.now();h.a.setRoomWidget(t,E,v.a.JITSI,p,"Jitsi",y).then(()=>{console.log("Jitsi widget added")}).catch(e=>{"M_FORBIDDEN"===e.errcode&&l.a.createTrackedDialog("Call Failed","",_.a,{title:Object(d.a)("Permission Required"),description:Object(d.a)("You do not have permission to start a conference call in this room")}),console.error(e)})}terminateCallApp(e){l.a.createTrackedDialog("Confirm Jitsi Terminate","",y.a,{hasCancelButton:!0,title:Object(d.a)("End conference"),description:Object(d.a)("This will end the conference for everyone. Continue?"),button:Object(d.a)("End conference"),onFinished:t=>{if(!t)return;E.a.instance.getRoom(e).widgets.filter(e=>v.a.JITSI.matches(e.type)).forEach(t=>{h.a.setRoomWidget(e,t.id)})}})}hangupCallApp(e){const t=E.a.instance.getRoom(e);if(!t)return;t.widgets.filter(e=>v.a.JITSI.matches(e.type)).forEach(e=>{const t=S.a.instance.getMessagingForId(e.id);t&&t.transport.send(w.a.HangupCall,{})})}}}).call(this,s(36).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return d}));var n=s(18),i=s.n(n),o=s(8),a=s.n(o),r=s(479),c=s.n(r);let l;!function(e){e.Resize="resize"}(l||(l={}));class d extends a.a{constructor(){super(),i()(this,"resizeObserver",void 0),i()(this,"uiElementDimensions",new Map),i()(this,"trackedUiElements",new Map),i()(this,"windowWidth",void 0),i()(this,"windowHeight",void 0),i()(this,"resizeObserverCallback",e=>{const t=e.find(e=>e.target===document.body);t&&(this.windowWidth=t.contentRect.width,this.windowHeight=t.contentRect.height),e.forEach(e=>{const t=this.trackedUiElements.get(e.target);t&&(this.uiElementDimensions.set(t,e.contentRect),this.emit(t,l.Resize,e))}),this.emit(l.Resize,e)}),this.windowWidth=window.innerWidth,this.windowHeight=window.innerHeight,this.resizeObserver=new c.a(this.resizeObserverCallback),this.resizeObserver.observe(document.body)}static get instance(){return d._instance||(d._instance=new d),d._instance}static destroy(){d._instance&&(d._instance.resizeObserver.disconnect(),d._instance.removeAllListeners(),d._instance=null)}getElementDimensions(e){return this.uiElementDimensions.get(e)}trackElementDimensions(e,t){this.trackedUiElements.set(t,e),this.resizeObserver.observe(t)}stopTrackingElementDimensions(e){let t;this.trackedUiElements.forEach((s,n)=>{s===e&&(t=n)}),t&&(this.resizeObserver.unobserve(t),this.uiElementDimensions.delete(e),this.trackedUiElements.delete(t))}isTrackingElementDimensions(e){return this.uiElementDimensions.has(e)}}i()(d,"_instance",null),window.mxUIStore=d.instance},function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return a}));var n=s(97),i=s.n(n);let o;!function(e){e.IRC="irc",e.Group="group",e.Bubble="bubble"}(o||(o={}));const a=i.a.oneOf(Object.values(o))},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(18),i=s.n(n),o=s(123),a=s(489);class r extends o.a{constructor(e,t={}){super(e,t),i()(this,"readyStore",void 0);const s=this;this.readyStore=new class extends a.a{get mxClient(){return this.matrixClient}async onReady(){return s.onReady()}async onNotReady(){return s.onNotReady()}}(e)}get matrixClient(){return this.readyStore.mxClient}async onReady(){}async onNotReady(){}async onDispatch(e){await this.onAction(e)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g})),s.d(t,"h",(function(){return v})),s.d(t,"g",(function(){return f})),s.d(t,"f",(function(){return b})),s.d(t,"e",(function(){return y})),s.d(t,"c",(function(){return _})),s.d(t,"b",(function(){return E})),s.d(t,"d",(function(){return S}));var n=s(91),i=s.n(n),o=s(94),a=s(310),r=s(99),c=s(95),l=s(92),d=s(351),u=s(679),h=s(182),m=s(130),p=s(107);function g(e,t){const s=new a.a(e);return s.invite(t).then(e=>Promise.resolve({states:e,inviter:s}))}function v(e=""){const t=c.getComponent("dialogs.InviteDialog");r.a.createTrackedDialog("Start DM","",t,{kind:d.b,initialText:e},null,!1,!0)}function f(e,t=""){r.a.createTrackedDialog("Invite Users","",d.d,{kind:d.c,initialText:t,roomId:e},null,!1,!0)}function b(e,t){r.a.createTrackedDialog("Invite Users to Community","",u.a,{communityName:t,roomId:e},null,!1,!0)}function y(e){const t=h.a.instance.getGeneralChat(e);if(!t)throw new Error("Failed to locate appropriate room to start an invite in");{const s=h.a.instance.getCommunityName(e);b(t.roomId,s)}}function _(e){if(!e||"m.room.third_party_invite"!==e.getType())return!1;const t=["key_validity_url","public_key","display_name"];for(let s=0;s<t.length;++s)if(!e.getContent()[t[s]])return!1;return!0}function E(e,t){return g(e,t).then(t=>{const s=o.a.get().getRoom(e);S(t.states,s,t.inviter)}).catch(e=>{console.error(e.stack);const t=c.getComponent("dialogs.ErrorDialog");r.a.createTrackedDialog("Failed to invite","",t,{title:Object(l.a)("Failed to invite"),description:e&&e.message?e.message:Object(l.a)("Operation failed")})})}function S(e,t,s,n){const a=Object.keys(e).filter(t=>"error"===e[t]);if(1===a.length&&s.fatal){const e=c.getComponent("dialogs.ErrorDialog");return r.a.createTrackedDialog("Failed to invite users to the room","",e,{title:Object(l.a)("Failed to invite users to the room:",{roomName:t.name}),description:s.getErrorText(a[0])}),!1}{const d=[];for(const t of a)if("error"===e[t]){const e=s.getErrorText(t);d.push(t+": "+e)}const u=o.a.get();if(d.length>0){const e=i.a.createElement("div",{className:"mx_InviteDialog_multiInviterError"},i.a.createElement("h4",null,Object(l.a)("We sent the others, but the below people couldn't be invited to <RoomName/>",{},{RoomName:()=>i.a.createElement("b",null,t.name)})),i.a.createElement("div",null,a.map(e=>{var t,o;const a=(null==n?void 0:n.get(e))||u.getUser(e),r=a.name||a.rawDisplayName,c=(null===(t=(o=a).getMxcAvatarUrl)||void 0===t?void 0:t.call(o))||a.avatarUrl;return i.a.createElement("div",{key:e,className:"mx_InviteDialog_multiInviterError_entry"},i.a.createElement("div",{className:"mx_InviteDialog_multiInviterError_entry_userProfile"},i.a.createElement(m.a,{url:c?Object(p.b)(c).getSquareThumbnailHttp(24):null,name:r,idName:a.userId,width:24,height:24}),i.a.createElement("span",{className:"mx_InviteDialog_multiInviterError_entry_name"},r),i.a.createElement("span",{className:"mx_InviteDialog_multiInviterError_entry_userId"},a.userId)),i.a.createElement("div",{className:"mx_InviteDialog_multiInviterError_entry_error"},s.getErrorText(e)))}))),o=c.getComponent("dialogs.ErrorDialog");return r.a.createTrackedDialog("Some invites could not be sent","",o,{title:Object(l.a)("Some invites couldn't be sent"),description:e}),!1}}return!0}},function(e,t,s){"use strict";s.d(t,"e",(function(){return h})),s.d(t,"f",(function(){return m})),s.d(t,"a",(function(){return p})),s.d(t,"d",(function(){return g})),s.d(t,"c",(function(){return v})),s.d(t,"b",(function(){return f})),s.d(t,"h",(function(){return y})),s.d(t,"i",(function(){return R})),s.d(t,"j",(function(){return I})),s.d(t,"g",(function(){return x}));var n=s(115),i=s.n(n),o=s(0),a=s(8),r=s(1),c=s(110),l=s(186);let d;!function(e){e.Usermedia="m.usermedia",e.Screenshare="m.screenshare"}(d||(d={}));var u=s(390);let h,m,p,g,v,f;var b;!function(e){e.Fledgling="fledgling",e.InviteSent="invite_sent",e.WaitLocalMedia="wait_local_media",e.CreateOffer="create_offer",e.CreateAnswer="create_answer",e.Connecting="connecting",e.Connected="connected",e.Ringing="ringing",e.Ended="ended"}(h||(h={})),function(e){e.Voice="voice",e.Video="video"}(m||(m={})),function(e){e.Inbound="inbound",e.Outbound="outbound"}(p||(p={})),function(e){e.Local="local",e.Remote="remote"}(g||(g={})),function(e){e.Hangup="hangup",e.State="state",e.Error="error",e.Replaced="replaced",e.LocalHoldUnhold="local_hold_unhold",e.RemoteHoldUnhold="remote_hold_unhold",e.HoldUnhold="hold_unhold",e.FeedsChanged="feeds_changed",e.AssertedIdentityChanged="asserted_identity_changed"}(v||(v={})),function(e){e.UserHangup="user_hangup",e.LocalOfferFailed="local_offer_failed",e.NoUserMedia="no_user_media",e.UnknownDevices="unknown_devices",e.SendInvite="send_invite",e.CreateAnswer="create_answer",e.SendAnswer="send_answer",e.SetRemoteDescription="set_remote_description",e.SetLocalDescription="set_local_description",e.AnsweredElsewhere="answered_elsewhere",e.IceFailed="ice_failed",e.InviteTimeout="invite_timeout",e.Replaced="replaced",e.SignallingFailed="signalling_timeout",e.UserBusy="user_busy",e.Transfered="transferred"}(f||(f={})),function(e){e.Audio="audio",e.Video="video"}(b||(b={}));function y(){return window.electron.getDesktopCapturerSources({thumbnailSize:{height:176,width:312},types:["screen","window"]})}class _ extends Error{constructor(e,t,s){super(t+": "+s),i()(this,"code",void 0),this.code=e}}function E(){return Date.now().toString()+Object(l.b)(16)}class S extends a.EventEmitter{constructor(e){super(),i()(this,"roomId",void 0),i()(this,"type",void 0),i()(this,"callId",void 0),i()(this,"state",void 0),i()(this,"hangupParty",void 0),i()(this,"hangupReason",void 0),i()(this,"direction",void 0),i()(this,"ourPartyId",void 0),i()(this,"client",void 0),i()(this,"forceTURN",void 0),i()(this,"turnServers",void 0),i()(this,"candidateSendQueue",void 0),i()(this,"candidateSendTries",void 0),i()(this,"sentEndOfCandidates",void 0),i()(this,"peerConn",void 0),i()(this,"feeds",void 0),i()(this,"screenSharingStream",void 0),i()(this,"localAVStream",void 0),i()(this,"inviteOrAnswerSent",void 0),i()(this,"waitForLocalAVStream",void 0),i()(this,"config",void 0),i()(this,"successor",void 0),i()(this,"opponentMember",void 0),i()(this,"opponentVersion",void 0),i()(this,"opponentPartyId",void 0),i()(this,"opponentCaps",void 0),i()(this,"inviteTimeout",void 0),i()(this,"remoteOnHold",void 0),i()(this,"micMuted",void 0),i()(this,"vidMuted",void 0),i()(this,"callStatsAtEnd",void 0),i()(this,"makingOffer",void 0),i()(this,"ignoreOffer",void 0),i()(this,"remoteCandidateBuffer",new Map),i()(this,"remoteAssertedIdentity",void 0),i()(this,"gotUserMediaForInvite",async e=>{if(this.successor)this.successor.gotUserMediaForAnswer(e);else if(this.callHasEnded())this.stopAllMedia();else{this.localAVStream=e,o.a.info("Got local AV stream with id "+this.localAVStream.id),this.setState(h.CreateOffer),o.a.debug("gotUserMediaForInvite -> "+this.type),this.screenSharingStream?(o.a.debug("Setting screen sharing stream to the local video element"),this.pushNewFeed(this.screenSharingStream,this.client.getUserId(),d.Screenshare)):this.pushNewFeed(e,this.client.getUserId(),d.Usermedia),w(e.getAudioTracks(),!0);for(const t of e.getAudioTracks())o.a.info("Adding audio track with id "+t.id),this.peerConn.addTrack(t,e);for(const t of(this.screenSharingStream||e).getVideoTracks())o.a.info("Adding video track with id "+t.id),this.peerConn.addTrack(t,e)}}),i()(this,"gotUserMediaForAnswer",async e=>{if(this.callHasEnded())return;this.pushNewFeed(e,this.client.getUserId(),d.Usermedia),this.localAVStream=e,o.a.info("Got local AV stream with id "+this.localAVStream.id),w(e.getAudioTracks(),!0);for(const t of e.getTracks())this.peerConn.addTrack(t,e);let t;this.setState(h.CreateAnswer);try{t=await this.peerConn.createAnswer()}catch(e){return o.a.debug("Failed to create answer: ",e),void this.terminate(g.Local,f.CreateAnswer,!0)}try{await this.peerConn.setLocalDescription(t),this.setState(h.Connecting),await new Promise(e=>{setTimeout(e,200)}),this.sendAnswer()}catch(e){return o.a.debug("Error setting local description!",e),void this.terminate(g.Local,f.SetLocalDescription,!0)}}),i()(this,"gotLocalIceCandidate",e=>{if(e.candidate){if(o.a.debug("Call "+this.callId+" got local ICE "+e.candidate.sdpMid+" candidate: "+e.candidate.candidate),this.callHasEnded())return;""===e.candidate.candidate&&this.sentEndOfCandidates||(this.queueCandidate(e.candidate),""===e.candidate.candidate&&(this.sentEndOfCandidates=!0))}}),i()(this,"onIceGatheringStateChange",e=>{if(o.a.debug("ice gathering state changed to "+this.peerConn.iceGatheringState),"complete"===this.peerConn.iceGatheringState&&!this.sentEndOfCandidates){const e={candidate:""};this.queueCandidate(e),this.sentEndOfCandidates=!0}}),i()(this,"gotLocalOffer",async e=>{if(o.a.debug("Created offer: ",e),this.callHasEnded())return void o.a.debug("Ignoring newly created offer on call ID "+this.callId+" because the call has ended");try{await this.peerConn.setLocalDescription(e)}catch(e){return o.a.debug("Error setting local description!",e),void this.terminate(g.Local,f.SetLocalDescription,!0)}if("gathering"===this.peerConn.iceGatheringState&&await new Promise(e=>{setTimeout(e,200)}),this.callHasEnded())return;const t=this.state===h.CreateOffer?c.a.CallInvite:c.a.CallNegotiate,s={lifetime:6e4};this.state===h.CreateOffer?s.offer=this.peerConn.localDescription:s.description=this.peerConn.localDescription,this.client.supportsCallTransfer&&(s.capabilities={"m.call.transferee":!0}),o.a.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in offer`),this.candidateSendQueue=[];try{await this.sendVoipEvent(t,s)}catch(e){o.a.error("Failed to send invite",e),e.event&&this.client.cancelPendingEvent(e.event);let t=f.SignallingFailed,s="Signalling failed";return this.state===h.CreateOffer&&(t=f.SendInvite,s="Failed to send invite"),"UnknownDeviceError"==e.name&&(t=f.UnknownDevices,s="Unknown devices present in the room"),this.emit(v.Error,new _(t,s,e)),void this.terminate(g.Local,t,!1)}this.sendCandidateQueue(),this.state===h.CreateOffer&&(this.inviteOrAnswerSent=!0,this.setState(h.InviteSent),this.inviteTimeout=setTimeout(()=>{this.inviteTimeout=null,this.state===h.InviteSent&&this.hangup(f.InviteTimeout,!1)},6e4))}),i()(this,"getLocalOfferFailed",e=>{o.a.error("Failed to get local offer",e),this.emit(v.Error,new _(f.LocalOfferFailed,"Failed to get local offer!",e)),this.terminate(g.Local,f.LocalOfferFailed,!1)}),i()(this,"getUserMediaFailed",e=>{this.successor?this.successor.getUserMediaFailed(e):(o.a.warn("Failed to get user media - ending call",e),this.emit(v.Error,new _(f.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e)),this.terminate(g.Local,f.NoUserMedia,!1))}),i()(this,"onIceConnectionStateChanged",()=>{this.callHasEnded()||(o.a.debug("Call ID "+this.callId+": ICE connection state changed to: "+this.peerConn.iceConnectionState),"connected"==this.peerConn.iceConnectionState?this.setState(h.Connected):"failed"==this.peerConn.iceConnectionState&&this.hangup(f.IceFailed,!1))}),i()(this,"onSignallingStateChanged",()=>{o.a.debug("call "+this.callId+": Signalling state changed to: "+this.peerConn.signalingState)}),i()(this,"onTrack",e=>{var t;if(0===e.streams.length)return void o.a.warn(`Streamless ${e.track.kind} found: ignoring.`);const s=null===(t=this.feeds.find(e=>!e.isLocal()))||void 0===t?void 0:t.stream;if(s&&e.streams[0].id!==s.id)return void o.a.warn(`Ignoring new stream ID ${e.streams[0].id}: we already have stream ID ${s.id}`);s||o.a.info("Got remote stream with id "+e.streams[0].id);const n=e.streams[0];o.a.debug(`Track id ${e.track.id} of kind ${e.track.kind} added`),this.pushNewFeed(n,this.getOpponentMember().userId,d.Usermedia),o.a.info("playing remote. stream active? "+n.active)}),i()(this,"onNegotiationNeeded",async()=>{if(o.a.info("Negotation is needed!"),this.state===h.CreateOffer||0!==this.opponentVersion){this.makingOffer=!0;try{const e=await this.peerConn.createOffer();await this.gotLocalOffer(e)}catch(e){return void this.getLocalOfferFailed(e)}finally{this.makingOffer=!1}}else o.a.info("Opponent does not support renegotiation: ignoring negotiationneeded event")}),i()(this,"onHangupReceived",e=>{o.a.debug("Hangup received for call ID "+this.callId),this.partyIdMatches(e)||this.state===h.Ringing?this.terminate(g.Remote,e.reason||f.UserHangup,!0):o.a.info(`Ignoring message from party ID ${e.party_id}: our partner is ${this.opponentPartyId}`)}),i()(this,"onRejectReceived",e=>{o.a.debug("Reject received for call ID "+this.callId);[h.InviteSent,h.Ringing].includes(this.state)||this.state===h.Fledgling&&this.direction===p.Inbound?this.terminate(g.Remote,e.reason||f.UserHangup,!0):o.a.debug(`Call is in state: ${this.state}: ignoring reject`)}),i()(this,"onAnsweredElsewhere",e=>{o.a.debug("Call ID "+this.callId+" answered elsewhere"),this.terminate(g.Remote,f.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.client=e.client,this.type=null,this.forceTURN=e.forceTURN,this.ourPartyId=this.client.deviceId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:["stun:turn.matrix.org"]});for(const e of this.turnServers)r.e(e,["urls"]);this.callId=E(),this.state=h.Fledgling,this.candidateSendQueue=[],this.candidateSendTries=0,this.sentEndOfCandidates=!1,this.inviteOrAnswerSent=!1,this.makingOffer=!1,this.remoteOnHold=!1,this.micMuted=!1,this.vidMuted=!1,this.feeds=[]}async placeVoiceCall(){o.a.debug("placeVoiceCall"),this.checkForErrorListener();const e=C(b.Audio);this.type=m.Voice,await this.placeCallWithConstraints(e)}async placeVideoCall(){o.a.debug("placeVideoCall"),this.checkForErrorListener();const e=C(b.Video);this.type=m.Video,await this.placeCallWithConstraints(e)}async placeScreenSharingCall(e){o.a.debug("placeScreenSharingCall"),this.checkForErrorListener();try{var t;const s=await async function(e){var t;if(null!==(t=window.electron)&&void 0!==t&&t.getDesktopCapturerSources&&e){o.a.debug("Electron getDesktopCapturerSources() is available...");const t=await e();return t?{audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t.id}}}:null}return o.a.debug("Electron desktopCapturer is not available..."),{audio:!1,video:!0}}(e);if(!s)return void this.terminate(g.Local,f.NoUserMedia,!1);null!==(t=window.electron)&&void 0!==t&&t.getDesktopCapturerSources?(o.a.debug("Getting screen stream using getUserMedia()..."),this.screenSharingStream=await navigator.mediaDevices.getUserMedia(s)):(o.a.debug("Getting screen stream using getDisplayMedia()..."),this.screenSharingStream=await navigator.mediaDevices.getDisplayMedia(s)),o.a.debug("Got screen stream, requesting audio stream...");const n=C(b.Audio);this.placeCallWithConstraints(n)}catch(e){this.emit(v.Error,new _(f.NoUserMedia,"Failed to get screen-sharing stream: ",e)),this.terminate(g.Local,f.NoUserMedia,!1)}this.type=m.Video}getOpponentMember(){return this.opponentMember}opponentCanBeTransferred(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushNewFeed(e,t,s){const n=this.feeds.find(t=>t.stream.id===e.id);n?n.setNewStream(e):(this.feeds.push(new u.a(e,t,s,this.client,this.roomId)),this.emit(v.FeedsChanged,this.feeds))}deleteAllFeeds(){this.feeds=[],this.emit(v.FeedsChanged,this.feeds)}async getCurrentCallStats(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()}async collectCallStats(){if(!this.peerConn)return;const e=await this.peerConn.getStats(),t=[];for(const s of e)t.push(s[1]);return t}async initWithInvite(e){var t;const s=e.getContent();this.direction=p.Inbound;await this.client.checkTurnServers()||o.a.warn("Failed to get TURN credentials! Proceeding with call anyway..."),this.peerConn=this.createPeerConnection(),this.chooseOpponent(e);try{await this.peerConn.setRemoteDescription(s.offer),await this.addBufferedIceCandidates()}catch(e){return o.a.debug("Failed to set remote description",e),void this.terminate(g.Local,f.SetRemoteDescription,!1)}const n=null===(t=this.feeds.find(e=>!e.isLocal()))||void 0===t?void 0:t.stream;if(!n||0===n.getTracks().length)return o.a.error("No remote stream or no tracks after setting remote description!"),void this.terminate(g.Local,f.SetRemoteDescription,!1);this.type=n.getTracks().some(e=>"video"===e.kind)?m.Video:m.Voice,this.setState(h.Ringing),e.getLocalAge()&&setTimeout(()=>{this.state==h.Ringing&&(o.a.debug("Call invite has expired. Hanging up."),this.hangupParty=g.Remote,this.setState(h.Ended),this.stopAllMedia(),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit(v.Hangup))},s.lifetime-e.getLocalAge())}initWithHangup(e){this.setState(h.Ended)}async answer(){if(!this.inviteOrAnswerSent)if(o.a.debug(`Answering call ${this.callId} of type ${this.type}`),this.localAVStream||this.waitForLocalAVStream)this.localAVStream?this.gotUserMediaForAnswer(this.localAVStream):this.waitForLocalAVStream&&this.setState(h.WaitLocalMedia);else{const e=C(this.type==m.Video?b.Video:b.Audio);o.a.log("Getting user media with constraints",e),this.setState(h.WaitLocalMedia),this.waitForLocalAVStream=!0;try{const t=await navigator.mediaDevices.getUserMedia(e);this.waitForLocalAVStream=!1,this.gotUserMediaForAnswer(t)}catch(e){return void this.getUserMediaFailed(e)}}}replacedBy(e){o.a.debug(this.callId+" being replaced by "+e.callId),this.state===h.WaitLocalMedia?(o.a.debug("Telling new call to wait for local media"),e.waitForLocalAVStream=!0):(this.state===h.CreateOffer||this.state===h.InviteSent)&&(o.a.debug("Handing local stream to new call"),e.gotUserMediaForAnswer(this.localAVStream),delete this.localAVStream),this.successor=e,this.emit(v.Replaced,e),this.hangup(f.Replaced,!0)}hangup(e,t){if(this.callHasEnded())return;if(o.a.debug("Ending call "+this.callId),this.terminate(g.Local,e,!t),this.state===h.WaitLocalMedia)return;const s={};e!==f.UserHangup&&(s.reason=e),this.sendVoipEvent(c.a.CallHangup,s)}reject(){if(this.state!==h.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion<1)return o.a.info(`Opponent version is less than 1 (${this.opponentVersion}): sending hangup instead of reject`),void this.hangup(f.UserHangup,!0);o.a.debug("Rejecting call: "+this.callId),this.terminate(g.Local,f.UserHangup,!0),this.sendVoipEvent(c.a.CallReject,{})}setLocalVideoMuted(e){this.vidMuted=e,this.updateMuteStatus()}isLocalVideoMuted(){return this.vidMuted}setMicrophoneMuted(e){this.micMuted=e,this.updateMuteStatus()}isMicrophoneMuted(){return this.micMuted}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(const t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.emit(v.RemoteHoldUnhold,this.remoteOnHold)}}isLocalOnHold(){if(this.state!==h.Connected)return!1;let e=!0;for(const t of this.peerConn.getTransceivers()){["inactive","recvonly"].includes(t.currentDirection)||(e=!1)}return e}sendDtmfDigit(e){for(const t of this.peerConn.getSenders())if("audio"===t.track.kind&&t.dtmf)return void t.dtmf.insertDTMF(e);throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){if(!this.localAVStream)return;const e=this.micMuted||this.remoteOnHold;w(this.localAVStream.getAudioTracks(),!e);const t=this.vidMuted||this.remoteOnHold;w(this.localAVStream.getVideoTracks(),!t)}async sendAnswer(){const e={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type}};this.client.supportsCallTransfer&&(e.capabilities={"m.call.transferee":!0}),o.a.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in answer`),this.candidateSendQueue=[];try{await this.sendVoipEvent(c.a.CallAnswer,e),this.inviteOrAnswerSent=!0}catch(e){this.setState(h.Ringing),this.client.cancelPendingEvent(e.event);let t=f.SendAnswer,s="Failed to send answer";throw"UnknownDeviceError"==e.name&&(t=f.UnknownDevices,s="Unknown devices present in the room"),this.emit(v.Error,new _(t,s,e)),e}this.sendCandidateQueue()}async onRemoteIceCandidatesReceived(e){if(this.callHasEnded())return;const t=e.getContent().candidates;if(!t)return void o.a.info("Ignoring candidates event with no candidates!");const s=0===e.getContent().version?null:e.getContent().party_id||null;if(void 0===this.opponentPartyId){o.a.info(`Bufferring ${t.length} candidates until we pick an opponent`);const e=this.remoteCandidateBuffer.get(s)||[];return e.push(...t),void this.remoteCandidateBuffer.set(s,e)}this.partyIdMatches(e.getContent())?await this.addIceCandidates(t):o.a.info(`Ignoring candidates from party ID ${e.getContent().party_id}: we have chosen party ID `+this.opponentPartyId)}async onAnswerReceived(e){if(o.a.debug(`Got answer for call ID ${this.callId} from party ID ${e.getContent().party_id}`),this.callHasEnded())o.a.debug(`Ignoring answer because call ID ${this.callId} has ended`);else if(void 0===this.opponentPartyId){this.chooseOpponent(e),await this.addBufferedIceCandidates(),this.setState(h.Connecting);try{await this.peerConn.setRemoteDescription(e.getContent().answer)}catch(e){return o.a.debug("Failed to set remote description",e),void this.terminate(g.Local,f.SetRemoteDescription,!1)}if(null!==this.opponentPartyId)try{await this.sendVoipEvent(c.a.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(e){o.a.warn("Failed to send select_answer event",e)}}else o.a.info(`Ignoring answer from party ID ${e.getContent().party_id}: we already have an answer/reject from `+this.opponentPartyId)}async onSelectAnswerReceived(e){if(this.direction!==p.Inbound)return void o.a.warn("Got select_answer for an outbound call: ignoring");const t=e.getContent().selected_party_id;null!=t?t!==this.ourPartyId&&(o.a.info(`Got select_answer for party ID ${t}: we are party ID ${this.ourPartyId}.`),this.terminate(g.Remote,f.AnsweredElsewhere,!0)):o.a.warn("Got nonsensical select_answer with null/undefined selected_party_id: ignoring")}async onNegotiateReceived(e){const t=e.getContent().description;if(!t||!t.sdp||!t.type)return void o.a.info("Ignoring invalid m.call.negotiate event");const s=this.direction===p.Inbound,n="offer"===t.type&&(this.makingOffer||"stable"!=this.peerConn.signalingState);if(this.ignoreOffer=!s&&n,this.ignoreOffer)return void o.a.info("Ignoring colliding negotiate event because we're impolite");const i=this.isLocalOnHold();try{if(await this.peerConn.setRemoteDescription(t),"offer"===t.type){const e=await this.peerConn.createAnswer();await this.peerConn.setLocalDescription(e),this.sendVoipEvent(c.a.CallNegotiate,{description:this.peerConn.localDescription})}}catch(e){o.a.warn("Failed to complete negotiation",e)}const a=this.isLocalOnHold();i!==a&&(this.emit(v.LocalHoldUnhold,a),this.emit(v.HoldUnhold,a))}async onAssertedIdentityReceived(e){e.getContent().asserted_identity&&(this.remoteAssertedIdentity={id:e.getContent().asserted_identity.id,displayName:e.getContent().asserted_identity.display_name},this.emit(v.AssertedIdentityChanged))}callHasEnded(){return this.state===h.Ended}setState(e){const t=this.state;this.state=e,this.emit(v.State,e,t)}sendVoipEvent(e,t){return this.client.sendEvent(this.roomId,e,Object.assign({},t,{version:1,call_id:this.callId,party_id:this.ourPartyId}))}queueCandidate(e){if(this.candidateSendQueue.push(e),this.state===h.Ringing||!this.inviteOrAnswerSent)return;const t=this.direction===p.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout(()=>{this.sendCandidateQueue()},t)}async transfer(e){const t=await this.client.getProfileInfo(e),s=E(),n={replacement_id:E(),target_user:{id:e,display_name:t.display_name,avatar_url:t.avatar_url},create_call:s};await this.sendVoipEvent(c.a.CallReplaces,n),await this.terminate(g.Local,f.Transfered,!0)}async transferToCall(e){const t=await this.client.getProfileInfo(e.getOpponentMember().userId),s=await this.client.getProfileInfo(this.getOpponentMember().userId),n=E(),i={replacement_id:E(),target_user:{id:this.getOpponentMember().userId,display_name:s.display_name,avatar_url:s.avatar_url},await_call:n};await e.sendVoipEvent(c.a.CallReplaces,i);const o={replacement_id:E(),target_user:{id:e.getOpponentMember().userId,display_name:t.display_name,avatar_url:t.avatar_url},create_call:n};await this.sendVoipEvent(c.a.CallReplaces,o),await this.terminate(g.Local,f.Replaced,!0),await e.terminate(g.Local,f.Transfered,!0)}async terminate(e,t,s){this.callHasEnded()||(this.callStatsAtEnd=await this.collectCallStats(),this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=null),t!==f.Replaced&&this.stopAllMedia(),this.deleteAllFeeds(),this.hangupParty=e,this.hangupReason=t,this.setState(h.Ended),this.peerConn&&"closed"!==this.peerConn.signalingState&&this.peerConn.close(),s&&this.emit(v.Hangup,this))}stopAllMedia(){o.a.debug(`stopAllMedia (stream=${this.localAVStream})`);for(const e of this.feeds)for(const t of e.stream.getTracks())t.stop()}checkForErrorListener(){if(0===this.listeners("error").length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}async sendCandidateQueue(){if(0===this.candidateSendQueue.length)return;const e=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;const t={candidates:e};o.a.debug("Attempting to send "+e.length+" candidates");try{await this.sendVoipEvent(c.a.CallCandidates,t)}catch(t){if(t.event&&this.client.cancelPendingEvent(t.event),this.candidateSendQueue.push(...e),this.candidateSendTries>5){o.a.debug("Failed to send candidates on attempt "+this.candidateSendTries+". Giving up on this call.",t);const e=f.SignallingFailed,s="Signalling failed";return this.emit(v.Error,new _(e,s,t)),void this.hangup(e,!1)}const s=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,o.a.debug("Failed to send candidates. Retrying in "+s+"ms",t),setTimeout(()=>{this.sendCandidateQueue()},s)}}async placeCallWithConstraints(e){o.a.log("Getting user media with constraints",e),this.client.callEventHandler.calls.set(this.callId,this),this.setState(h.WaitLocalMedia),this.direction=p.Outbound,this.config=e;await this.client.checkTurnServers()||o.a.warn("Failed to get TURN credentials! Proceeding with call anyway..."),this.peerConn=this.createPeerConnection();try{const t=await navigator.mediaDevices.getUserMedia(e);this.gotUserMediaForInvite(t)}catch(e){return void this.getUserMediaFailed(e)}}createPeerConnection(){const e=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers,iceCandidatePoolSize:this.client.iceCandidatePoolSize});return e.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),e.addEventListener("signalingstatechange",this.onSignallingStateChanged),e.addEventListener("icecandidate",this.gotLocalIceCandidate),e.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),e.addEventListener("track",this.onTrack),e.addEventListener("negotiationneeded",this.onNegotiationNeeded),e}partyIdMatches(e){return(0===e.version?null:e.party_id||null)===this.opponentPartyId}chooseOpponent(e){const t=e.getContent();o.a.debug(`Choosing party ID ${t.party_id} for call ID ${this.callId}`),this.opponentVersion=t.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=t.party_id||null,this.opponentCaps=t.capabilities||{},this.opponentMember=e.sender}async addBufferedIceCandidates(){const e=this.remoteCandidateBuffer.get(this.opponentPartyId);e&&(o.a.info(`Adding ${e.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(e)),this.remoteCandidateBuffer=null}async addIceCandidates(e){for(const t of e)if(null!==t.sdpMid&&void 0!==t.sdpMid||null!==t.sdpMLineIndex&&void 0!==t.sdpMLineIndex){o.a.debug("Call "+this.callId+" got remote ICE "+t.sdpMid+" candidate: "+t.candidate);try{await this.peerConn.addIceCandidate(t)}catch(e){this.ignoreOffer||o.a.info("Failed to add remote ICE candidate",e)}}else o.a.debug("Ignoring remote ICE candidate with no sdpMid or sdpMLineIndex")}}function w(e,t){for(let s=0;s<e.length;s++)e[s].enabled=t}function C(e){const t=!!navigator.webkitGetUserMedia;switch(e){case b.Audio:return{audio:{deviceId:k?{ideal:k}:void 0},video:!1};case b.Video:return{audio:{deviceId:k?{ideal:k}:void 0},video:{deviceId:O?{ideal:O}:void 0,width:t?{exact:640}:{ideal:640},height:t?{exact:360}:{ideal:360}}}}}let k,O;function R(e){k=e}function I(e){O=e}function x(e,t,s){if("undefined"==typeof window||"undefined"==typeof document)return null;try{if(!Boolean(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices))return o.a.error("WebRTC is not supported in this browser / environment"),null}catch(e){return o.a.error("Exception thrown when trying to access WebRTC",e),null}const n=!!s&&s.forceTURN,i={client:e,roomId:t,turnServers:e.getTurnServers(),forceTURN:e.forceTURN||n},a=new S(i);return e.reEmitter.reEmit(a,Object.values(v)),a}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return w})),s.d(t,"b",(function(){return k}));var n=s(18),i=s.n(n),o=s(98),a=s(146),r=s(233),c=s(96),l=s(499),d=s(264),u=s(1321),h=s(133),m=s(1317),p=s(188),g=s(1),v=s(748),f=s(452),b=s(156),y=s(680),_=s(174),E=s(475),S=s(1218);const w="lists_update";class C extends b.a{constructor(){super(c.a),i()(this,"initialListsGenerated",!1),i()(this,"algorithm",new m.a),i()(this,"filterConditions",[]),i()(this,"prefilterConditions",[]),i()(this,"tagWatcher",void 0),i()(this,"spaceWatcher",void 0),i()(this,"updateFn",new f.a(()=>{for(const e of Object.keys(this.orderedLists))_.a.instance.getListState(e).setRooms(this.orderedLists[e]);this.emit(w)})),i()(this,"watchedSettings",["feature_custom_tags","unifiedRoomList","advancedRoomListLogging"]),i()(this,"onAlgorithmListUpdated",()=>{o.b.getValue("advancedRoomListLogging")&&console.log("Underlying algorithm has triggered a list update - marking"),this.updateFn.mark()}),i()(this,"onAlgorithmFilterUpdated",()=>{this.updateFn.trigger()}),i()(this,"onPrefilterUpdated",async()=>{await this.recalculatePrefiltering(),this.updateFn.trigger()}),this.checkLoggingEnabled();for(const e of this.watchedSettings)o.b.monitorSetting(e,null);h.a.addListener(()=>this.handleRVSUpdate({})),this.algorithm.on(m.b,this.onAlgorithmListUpdated),this.algorithm.on(d.a,this.onAlgorithmFilterUpdated),this.setupWatchers()}setupWatchers(){o.b.getValue("feature_spaces")?this.spaceWatcher=new S.a(this):this.tagWatcher=new u.a(this)}get unfilteredLists(){return this.algorithm?this.algorithm.getUnfilteredRooms():{}}get orderedLists(){return this.algorithm?this.algorithm.getOrderedRooms():{}}async resetStore(){await this.reset(),this.filterConditions=[],this.prefilterConditions=[],this.initialListsGenerated=!1,this.setupWatchers(),this.algorithm.off(m.b,this.onAlgorithmListUpdated),this.algorithm.off(d.a,this.onAlgorithmListUpdated),this.algorithm=new m.a,this.algorithm.on(m.b,this.onAlgorithmListUpdated),this.algorithm.on(d.a,this.onAlgorithmListUpdated),await this.reset(null,!0)}async makeReady(e){e&&this.readyStore.useUnitTestClient(e),this.checkLoggingEnabled(),console.log("Regenerating room lists: Startup"),await this.readAndCacheSettingsFromStore(),await this.regenerateAllLists({trigger:!1}),await this.handleRVSUpdate({trigger:!1}),this.updateFn.mark(),this.updateFn.trigger()}checkLoggingEnabled(){o.b.getValue("advancedRoomListLogging")&&console.warn("Advanced room list logging is enabled")}async readAndCacheSettingsFromStore(){const e=o.b.getValue("feature_custom_tags"),t=o.b.getValue("unifiedRoomList");await this.updateState({tagsEnabled:e,unifiedRoomList:t}),await this.updateAlgorithmInstances()}async handleRVSUpdate({trigger:e=!0}){if(!this.matrixClient)return;const t=h.a.getRoomId();if(!t&&this.algorithm.stickyRoom)await this.algorithm.setStickyRoom(null);else if(t){const e=this.matrixClient.getRoom(t);e?e!==this.algorithm.stickyRoom&&(o.b.getValue("advancedRoomListLogging")&&console.log("Changing sticky room to "+t),await this.algorithm.setStickyRoom(e)):(console.warn(t+" is current in RVS but missing from client - clearing sticky room"),await this.algorithm.setStickyRoom(null))}e&&this.updateFn.trigger()}async onReady(){await this.makeReady()}async onNotReady(){await this.resetStore()}async onAction(t){this.matrixClient&&this.initialListsGenerated&&(C.TEST_MODE?await this.onDispatchAsync(t):e(()=>this.onDispatchAsync(t)))}async onDispatchAsync(e){if(this.matrixClient&&this.initialListsGenerated){if("setting_updated"===e.action&&this.watchedSettings.includes(e.settingName)){if("advancedRoomListLogging"===e.settingName){const e=o.b.getValue("advancedRoomListLogging");return void console.warn("Advanced room list logging is enabled? "+e)}console.log("Regenerating room lists: Settings changed"),await this.readAndCacheSettingsFromStore(),await this.regenerateAllLists({trigger:!1}),this.updateFn.trigger()}if(!this.algorithm)throw new Error("Room list store has no algorithm to process dispatcher update with");if("MatrixActions.Room.receipt"===e.action){if(Object(l.a)(e.event,this.matrixClient)){const t=e.room;return t?(o.b.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Got own read receipt in "+t.roomId),await this.handleRoomUpdate(t,a.c.ReadReceipt),void this.updateFn.trigger()):void console.warn("Own read receipt was in unknown room "+t.roomId)}}else if("MatrixActions.Room.tags"===e.action){const t=e;o.b.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Got tag change in "+t.room.roomId),await this.handleRoomUpdate(t.room,a.c.PossibleTagChange),this.updateFn.trigger()}else if("MatrixActions.Room.timeline"===e.action){const t=e;if(!t.isLiveEvent||!e.isLiveUnfilteredRoomTimelineEvent)return;const s=t.event.getRoomId(),n=this.matrixClient.getRoom(s),i=async e=>{if(o.b.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Live timeline event "+t.event.getId()+" in "+e.roomId),"m.room.tombstone"===t.event.getType()&&""===t.event.getStateKey()){o.b.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Got tombstone event - trying to remove now-dead room");if(this.matrixClient.getRoom(t.event.getContent().replacement_room))return}await this.handleRoomUpdate(e,a.c.Timeline),this.updateFn.trigger()};if(!n)return console.warn(`Live timeline event ${t.event.getId()} received without associated room`),console.warn("Queuing failed room update for retry as a result."),void setTimeout(async()=>{const e=this.matrixClient.getRoom(s);await i(e)},100);await i(n)}else if("MatrixActions.Event.decrypted"===e.action){const t=e,s=t.event.getRoomId();if(!s)return;const n=this.matrixClient.getRoom(s);if(!n)return void console.warn(`Event ${t.event.getId()} was decrypted in an unknown room ${s}`);o.b.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Decrypted timeline event ${t.event.getId()} in ${s}`),await this.handleRoomUpdate(n,a.c.Timeline),this.updateFn.trigger()}else if("MatrixActions.accountData"===e.action&&"m.direct"===e.event_type){const t=e;o.b.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Received updated DM map");const s=t.event.getContent();for(const e of Object.keys(s)){const t=s[e];for(const e of t){const t=this.matrixClient.getRoom(e);t?await this.handleRoomUpdate(t,a.c.PossibleTagChange):console.warn(e+" was found in DMs but the room is not in the store")}}this.updateFn.trigger()}else if("MatrixActions.Room.myMembership"===e.action){const t=e,s=Object(p.b)(t.oldMembership),n=Object(p.b)(t.membership);if(s!==p.a.Join&&n===p.a.Join){o.b.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Handling new room "+t.room.roomId);const e=t.room.currentState.getStateEvents("m.room.create","");if(e&&e.getContent().predecessor){o.b.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Room has a predecessor");const t=this.matrixClient.getRoom(e.getContent().predecessor.room_id);if(t){this.algorithm.stickyRoom===t&&(o.b.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Clearing sticky room due to room upgrade"),await this.algorithm.setStickyRoom(null)),o.b.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Removing previous room from room list"),await this.algorithm.handleRoomUpdate(t,a.c.RoomRemoved)}}return o.b.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Adding new room to room list"),await this.handleRoomUpdate(t.room,a.c.NewRoom),void this.updateFn.trigger()}if(s!==p.a.Invite&&n===p.a.Invite)return o.b.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Handling invite to "+t.room.roomId),await this.handleRoomUpdate(t.room,a.c.NewRoom),void this.updateFn.trigger();if(s!==n)return o.b.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Handling membership change in "+t.room.roomId),await this.handleRoomUpdate(t.room,a.c.PossibleTagChange),void this.updateFn.trigger()}}}async handleRoomUpdate(e,t){if(t===a.c.NewRoom&&"invite"===e.getMyMembership()&&await E.a.instance.onNewInvitedRoom(e),!E.a.instance.isRoomVisible(e))return;if((t===a.c.NewRoom||t===a.c.PossibleTagChange)&&!this.prefilterConditions.every(t=>t.isVisible(e)))return;await this.algorithm.handleRoomUpdate(e,t)&&(o.b.getValue("advancedRoomListLogging")&&console.log(`[DEBUG] Room "${e.name}" (${e.roomId}) triggered by ${t} requires list update`),this.updateFn.mark())}async recalculatePrefiltering(){if(!this.algorithm)return;if(!this.algorithm.hasTagSortingMap)return;o.b.getValue("advancedRoomListLogging")&&console.log("Calculating new prefiltered room list"),this.algorithm.updatesInhibited=!0;const e=this.getPlausibleRooms(),t=this.algorithm.stickyRoom,s=t&&e.includes(t);await this.algorithm.setStickyRoom(null),await this.algorithm.setKnownRooms(e),s&&await this.algorithm.setStickyRoom(t),this.updateFn.mark(),this.algorithm.updatesInhibited=!1}async setTagSorting(e,t){await this.setAndPersistTagSorting(e,t),this.updateFn.trigger()}async setAndPersistTagSorting(e,t){await this.algorithm.setTagSorting(e,t),localStorage.setItem("mx_tagSort_"+e,t)}getTagSorting(e){return this.algorithm.getTagSorting(e)}getStoredTagSorting(e){return localStorage.getItem("mx_tagSort_"+e)}calculateTagSorting(e){e===a.a.Invite||a.a.DM;const t=r.b.Recent,s=o.b.getValue("RoomList.orderAlphabetically",null,!1),n=this.getTagSorting(e),i=this.getStoredTagSorting(e);let c=t;return i?c=i:Object(g.t)(s)?n&&(c=n):c=s?r.b.Alphabetic:r.b.Recent,c}async setListOrder(e,t){await this.setAndPersistListOrder(e,t),this.updateFn.trigger()}async setAndPersistListOrder(e,t){await this.algorithm.setListOrdering(e,t),localStorage.setItem("mx_listOrder_"+e,t)}getListOrder(e){return this.algorithm.getListOrdering(e)}getStoredListOrder(e){return localStorage.getItem("mx_listOrder_"+e)}calculateListOrder(e){const t=r.a.Natural,s=o.b.getValue("RoomList.orderByImportance",null,!0),n=this.getListOrder(e),i=this.getStoredListOrder(e);let a=t;return i?a=i:Object(g.t)(s)?n&&(a=n):a=s?r.a.Importance:r.a.Natural,a}async updateAlgorithmInstances(){this.updateFn.mark();for(const e of Object.keys(this.orderedLists)){const t=this.getTagSorting(e),s=this.getListOrder(e),n=this.calculateTagSorting(e),i=this.calculateListOrder(e);n!==t&&await this.setAndPersistTagSorting(e,n),i!==s&&await this.setAndPersistListOrder(e,i)}this.algorithm.setUnifiedRoomList(this.state.unifiedRoomList)}getPlausibleRooms(){if(!this.matrixClient)return[];let e=this.matrixClient.getVisibleRooms().filter(e=>E.a.instance.isRoomVisible(e));return!(this.prefilterConditions.length>0)||o.b.getValue("feature_spaces")&&this.filterConditions.length||(e=e.filter(e=>{for(const t of this.prefilterConditions)if(!t.isVisible(e))return!1;return!0})),e}async regenerateAllLists({trigger:e=!0}){console.warn("Regenerating all room lists");const t=this.getPlausibleRooms(),s=new Set;if(this.state.tagsEnabled)for(const e of t){if(!e.tags)continue;Object.keys(e.tags).filter(e=>Object(a.d)(e)).forEach(e=>s.add(e))}const n={},i={},o=[...a.b,...Array.from(s)];for(const e of o)n[e]=this.calculateTagSorting(e),i[e]=this.calculateListOrder(e),v.a.instance.ensureLayoutExists(e);await this.algorithm.populateTags(n,i),await this.algorithm.setKnownRooms(t),this.initialListsGenerated=!0,e&&this.updateFn.trigger()}async addFilter(e){o.b.getValue("advancedRoomListLogging")&&console.log("Adding filter condition:",e);let t=Promise.resolve();e.kind===d.b.Prefilter?(e.on(d.a,this.onPrefilterUpdated),this.prefilterConditions.push(e),t=this.recalculatePrefiltering()):(this.filterConditions.push(e),o.b.getValue("feature_spaces")&&await this.recalculatePrefiltering(),this.algorithm&&this.algorithm.addFilterCondition(e)),t.then(()=>this.updateFn.trigger())}removeFilter(e){o.b.getValue("advancedRoomListLogging")&&console.log("Removing filter condition:",e);let t=Promise.resolve(),s=this.filterConditions.indexOf(e);s>=0&&(this.filterConditions.splice(s,1),this.algorithm&&this.algorithm.removeFilterCondition(e),o.b.getValue("feature_spaces")&&(t=this.recalculatePrefiltering())),s=this.prefilterConditions.indexOf(e),s>=0&&(e.off(d.a,this.onPrefilterUpdated),this.prefilterConditions.splice(s,1),t=this.recalculatePrefiltering()),t.then(()=>this.updateFn.trigger())}getFirstNameFilterCondition(){for(const e of this.filterConditions)if(e instanceof y.a)return e;return null}getTagsForRoom(e){var t=this.algorithm.getTagsForRoom(e);if(!t)return this.state.unifiedRoomList?[a.a.Unified]:[a.a.Untagged];const s=t.indexOf(a.a.DM);-1!==s&&(t[s]=a.a.Unified);const n=t.indexOf(a.a.Untagged);return-1!==n&&(t[n]=a.a.Unified),t}async manualRoomUpdate(e,t){await this.handleRoomUpdate(e,t),this.updateFn.trigger()}}i()(C,"TEST_MODE",!1);class k{static get instance(){return k.internalInstance||(k.internalInstance=new C),k.internalInstance}}i()(k,"internalInstance",void 0),window.mxRoomListStore=k.instance}).call(this,s(169).setImmediate)},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return l}));var n=s(0),i=s(555),o=s(273),a=s(882),r=s(215),c=s(21);class l{constructor(e,t){this._indexedDB=e,this._dbName=t,this._backendPromise=null,this._backend=null}static exists(e,t){return c.a(e,t)}startup(){return this._backendPromise||(this._backendPromise=new Promise((e,t)=>{if(!this._indexedDB)return void t(new Error("no indexeddb support available"));n.a.log("connecting to indexeddb "+this._dbName);const s=this._indexedDB.open(this._dbName,a.b);s.onupgradeneeded=e=>{const t=e.target.result,s=e.oldVersion;a.c(t,s)},s.onblocked=()=>{n.a.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},s.onerror=e=>{n.a.log("Error connecting to indexeddb",e),t(e.target.error)},s.onsuccess=t=>{const s=t.target.result;n.a.log("connected to indexeddb "+this._dbName),e(new a.a(s))}}).then(e=>e.doTxn("readonly",[l.STORE_INBOUND_GROUP_SESSIONS,l.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(t=>{if("VersionError"===t.name)throw n.a.warn("Crypto DB is too new for us to use!",t),new r.a(r.a.TOO_NEW);n.a.warn("unable to connect to indexeddb "+this._dbName+": falling back to localStorage store: "+t);try{return new i.a(e.localStorage)}catch(t){return n.a.warn("unable to open localStorage: falling back to in-memory store: "+t),new o.a}}).then(e=>{this._backend=e})),this._backendPromise}deleteAllData(){return new Promise((e,t)=>{if(!this._indexedDB)return void t(new Error("no indexeddb support available"));n.a.log("Removing indexeddb instance: "+this._dbName);const s=this._indexedDB.deleteDatabase(this._dbName);s.onblocked=()=>{n.a.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},s.onerror=e=>{n.a.log("Error deleting data from indexeddb",e),t(e.target.error)},s.onsuccess=()=>{n.a.log("Removed indexeddb instance: "+this._dbName),e()}}).catch(e=>{n.a.warn("unable to delete IndexedDBCryptoStore: "+e)})}getOrAddOutgoingRoomKeyRequest(e){return this._backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this._backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this._backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this._backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,s){return this._backend.getOutgoingRoomKeyRequestsByTarget(e,t,s)}updateOutgoingRoomKeyRequest(e,t,s){return this._backend.updateOutgoingRoomKeyRequest(e,t,s)}deleteOutgoingRoomKeyRequest(e,t){return this._backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this._backend.getAccount(e,t)}storeAccount(e,t){this._backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this._backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,s){this._backend.getSecretStorePrivateKey(e,t,s)}storeCrossSigningKeys(e,t){this._backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,s){this._backend.storeSecretStorePrivateKey(e,t,s)}countEndToEndSessions(e,t){this._backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,s,n){this._backend.getEndToEndSession(e,t,s,n)}getEndToEndSessions(e,t,s){this._backend.getEndToEndSessions(e,t,s)}getAllEndToEndSessions(e,t){this._backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,s,n){this._backend.storeEndToEndSession(e,t,s,n)}storeEndToEndSessionProblem(e,t,s){return this._backend.storeEndToEndSessionProblem(e,t,s)}getEndToEndSessionProblem(e,t){return this._backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this._backend.filterOutNotifiedErrorDevices(e)}getEndToEndInboundGroupSession(e,t,s,n){this._backend.getEndToEndInboundGroupSession(e,t,s,n)}getAllEndToEndInboundGroupSessions(e,t){this._backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,s,n){this._backend.addEndToEndInboundGroupSession(e,t,s,n)}storeEndToEndInboundGroupSession(e,t,s,n){this._backend.storeEndToEndInboundGroupSession(e,t,s,n)}storeEndToEndInboundGroupSessionWithheld(e,t,s,n){this._backend.storeEndToEndInboundGroupSessionWithheld(e,t,s,n)}storeEndToEndDeviceData(e,t){this._backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this._backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,s){this._backend.storeEndToEndRoom(e,t,s)}getEndToEndRooms(e,t){this._backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this._backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this._backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this._backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this._backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,s,n){this._backend.addSharedHistoryInboundGroupSession(e,t,s,n)}getSharedHistoryInboundGroupSessions(e,t){return this._backend.getSharedHistoryInboundGroupSessions(e,t)}doTxn(e,t,s,n){return this._backend.doTxn(e,t,s,n)}}l.STORE_ACCOUNT="account",l.STORE_SESSIONS="sessions",l.STORE_INBOUND_GROUP_SESSIONS="inbound_group_sessions",l.STORE_INBOUND_GROUP_SESSIONS_WITHHELD="inbound_group_sessions_withheld",l.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS="shared_history_inbound_group_sessions",l.STORE_DEVICE_DATA="device_data",l.STORE_ROOMS="rooms",l.STORE_BACKUP="sessions_needing_backup"}).call(this,s(7))},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(18),i=s.n(n);class o{constructor(e,t){this.preferred=e,this.legacy=t}matches(e){return e===this.preferred||e===this.legacy}static fromString(e){const t=Object.values(o).filter(e=>e instanceof o).find(t=>t.matches(e));return t||new o(e,e)}}i()(o,"JITSI",new o("m.jitsi","jitsi")),i()(o,"STICKERPICKER",new o("m.stickerpicker","m.stickerpicker")),i()(o,"INTEGRATION_MANAGER",new o("m.integration_manager","m.integration_manager")),i()(o,"CUSTOM",new o("m.custom","m.custom"))},function(e,t,s){"use strict";s.d(t,"c",(function(){return i})),s.d(t,"d",(function(){return o})),s.d(t,"a",(function(){return a})),s.d(t,"e",(function(){return r})),s.d(t,"f",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(92);function i(e){return e<1e3?e.toString():e<1e4?(e/1e3).toFixed(1)+"K":e<1e5?(e/1e3).toFixed(0)+"K":e<1e7?(e/1e6).toFixed(1)+"M":e<1e8?(e/1e6).toFixed(0)+"M":(e/1e9).toFixed(1)+"B"}function o(e){return(new Intl.NumberFormat).format(e)}function a(e,t=2){if(0===e)return"0 Bytes";const s=t<0?0:t,n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(s))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][n]}function r(e){return e.match(/.{1,4}/g).join(" ")}function c(e){return"mx_Username_color"+(function(e){let t,s,n=0;if(0===e.length)return n;for(t=0;t<e.length;t++)s=e.charCodeAt(t),n=(n<<5)-n+s,n|=0;return Math.abs(n)}(e)%8+1)}function l(e,t){const s=void 0===t?0:Math.max(e.length-t,0);if(0===e.length)return"";if(1===e.length)return e[0];if(s>0)return e=e.slice(0,t),Object(n.a)("%(items)s and %(count)s others",{items:e.join(", "),count:s});{const t=e.pop();return Object(n.a)("%(items)s and %(lastItem)s",{items:e.join(", "),lastItem:t})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(91),i=s.n(n),o=s(101),a=s.n(o);function r({description:e,hideDescriptionIfValid:t,deriveData:s,rules:n}){return async function({value:o,focused:r,allowEmpty:c=!0}){if(!o&&c)return{valid:null,feedback:null};const l={value:o,allowEmpty:c},d=s?await s(l):void 0,u=[];let h,m,p,g=!0;if(n&&n.length)for(const e of n){if(!e.key||!e.test)continue;if(!g&&e.final)continue;if(e.skip&&e.skip.call(this,l,d))continue;const t=await e.test.call(this,l,d);if(g=g&&t,t&&e.valid){const t=e.valid.call(this,d);if(!t)continue;u.push({key:e.key,valid:!0,text:t})}else if(!t&&e.invalid){const t=e.invalid.call(this,d);if(!t)continue;u.push({key:e.key,valid:!1,text:t})}}if(!r)return{valid:g,feedback:null};if(u&&u.length&&(h=i.a.createElement("ul",{className:"mx_Validation_details"},u.map(e=>{const t=a()({mx_Validation_detail:!0,mx_Validation_valid:e.valid,mx_Validation_invalid:!e.valid});return i.a.createElement("li",{key:e.key,className:t},e.text)}))),e&&(h||!t)){const t=e.call(this,d);m=i.a.createElement("div",{className:"mx_Validation_description"},t)}return(m||h)&&(p=i.a.createElement("div",{className:"mx_Validation"},m,h)),{valid:g,feedback:p}}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{getValueOverride(e,t,s,n){return null}onChange(e,t,s){}get settingDisabled(){return!1}}},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(100);t.a=({description:e,detail:t,acceptLabel:s,rejectLabel:n,onAccept:a,onReject:r})=>{const c=t?i.a.createElement("div",{className:"mx_Toast_detail"},t):null;return i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Toast_description"},e,c),i.a.createElement("div",{className:"mx_Toast_buttons","aria-live":"off"},r&&n&&i.a.createElement(o.a,{kind:"danger_outline",onClick:r},n),i.a.createElement(o.a,{onClick:a,kind:"primary"},s)))}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(353);function i(e){this._eventTimelineSet=e,this._roomId=e.room?e.room.roomId:null,this._events=[],this._baseIndex=0,this._startState=new n.a(this._roomId),this._startState.paginationToken=null,this._endState=new n.a(this._roomId),this._endState.paginationToken=null,this._prevTimeline=null,this._nextTimeline=null,this._paginationRequests={b:null,f:null},this._name=this._roomId+":"+(new Date).toISOString()}i.BACKWARDS="b",i.FORWARDS="f",i.prototype.initialiseState=function(e){if(this._events.length>0)throw new Error("Cannot initialise state after events are added");for(const t of e)Object.freeze(t);this._startState.setStateEvents(e),this._endState.setStateEvents(e)},i.prototype.forkLive=function(e){const t=this.getState(e),s=new i(this._eventTimelineSet);return s._startState=t.clone(),s._endState=t,this._endState=t.clone(),s},i.prototype.fork=function(e){const t=this.getState(e),s=new i(this._eventTimelineSet);return s._startState=t.clone(),s._endState=t.clone(),s},i.prototype.getRoomId=function(){return this._roomId},i.prototype.getFilter=function(){return this._eventTimelineSet.getFilter()},i.prototype.getTimelineSet=function(){return this._eventTimelineSet},i.prototype.getBaseIndex=function(){return this._baseIndex},i.prototype.getEvents=function(){return this._events},i.prototype.getState=function(e){if(e==i.BACKWARDS)return this._startState;if(e==i.FORWARDS)return this._endState;throw new Error("Invalid direction '"+e+"'")},i.prototype.getPaginationToken=function(e){return this.getState(e).paginationToken},i.prototype.setPaginationToken=function(e,t){this.getState(t).paginationToken=e},i.prototype.getNeighbouringTimeline=function(e){if(e==i.BACKWARDS)return this._prevTimeline;if(e==i.FORWARDS)return this._nextTimeline;throw new Error("Invalid direction '"+e+"'")},i.prototype.setNeighbouringTimeline=function(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==i.BACKWARDS)this._prevTimeline=e;else{if(t!=i.FORWARDS)throw new Error("Invalid direction '"+t+"'");this._nextTimeline=e}this.setPaginationToken(null,t)},i.prototype.addEvent=function(e,t){const s=t?this._startState:this._endState,n=this.getTimelineSet();let o;n.room&&n.room.getUnfilteredTimelineSet()===n&&(i.setEventMetadata(e,s,t),e.isState()&&(s.setStateEvents([e]),e.sender&&("m.room.member"!==e.getType()||t)||i.setEventMetadata(e,s,t))),o=t?0:this._events.length,this._events.splice(o,0,e),t&&this._baseIndex++},i.setEventMetadata=function(e,t,s){e.sender=t.getSentinelMember(e.getSender()),"m.room.member"===e.getType()&&(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&s&&(e.forwardLooking=!1)},i.prototype.removeEvent=function(e){for(let t=this._events.length-1;t>=0;t--){const s=this._events[t];if(s.getId()==e)return this._events.splice(t,1),t<this._baseIndex&&this._baseIndex--,s}return null},i.prototype.toString=function(){return this._name}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(115),i=s.n(n),o=s(8),a=s(261),r=s(1);class c extends o.EventEmitter{constructor(e,t){super(),this.roomId=e,this.userId=t,i()(this,"_isOutOfBand",!1),i()(this,"_modified",void 0),i()(this,"typing",!1),i()(this,"name",void 0),i()(this,"rawDisplayName",void 0),i()(this,"powerLevel",0),i()(this,"powerLevelNorm",0),i()(this,"user",null),i()(this,"membership",null),i()(this,"disambiguate",!1),i()(this,"events",{member:null}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){const s=e.getDirectionalContent().displayname;if("m.room.member"!==e.getType())return;this._isOutOfBand=!1,this.events.member=e;const n=this.membership;this.membership=e.getDirectionalContent().membership,this.disambiguate=function(e,t,s){if(!t||t===e)return!1;if(!r.D(t))return!1;if(!s)return!1;if(l.test(t))return!0;if(d.test(t))return!0;return!!s.getUserIdsWithDisplayName(t).some(t=>t!==e)}(this.userId,s,t);const i=this.name;this.name=function(e,t,s,n){return n?t+" ("+e+")":t&&t!==e&&r.D(t)?t:e}(this.userId,s,0,this.disambiguate),this.rawDisplayName=e.getDirectionalContent().displayname||this.userId,n!==this.membership&&(this.updateModifiedTime(),this.emit("RoomMember.membership",e,this,n)),i!==this.name&&(this.updateModifiedTime(),this.emit("RoomMember.name",e,this,i))}setPowerLevelEvent(e){if("m.room.power_levels"!==e.getType())return;const t=e.getDirectionalContent();let s=t.users_default||0;const n=t.users||{};Object.values(n).forEach((function(e){s=Math.max(s,e)}));const i=this.powerLevel,o=this.powerLevelNorm;void 0!==n[this.userId]?this.powerLevel=n[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,s>0&&(this.powerLevelNorm=100*this.powerLevel/s),i===this.powerLevel&&o===this.powerLevelNorm||(this.updateModifiedTime(),this.emit("RoomMember.powerLevel",e,this))}setTypingEvent(e){if("m.typing"!==e.getType())return;const t=this.typing;this.typing=!1;const s=e.getContent().user_ids;Array.isArray(s)&&(-1!==s.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit("RoomMember.typing",e,this)))}updateModifiedTime(){this._modified=Date.now()}getLastModifiedTime(){return this._modified}isKicked(){return"leave"===this.membership&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){const e=this.events.member;let t=e.getContent(),s=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),s=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return s}}getAvatarUrl(e,t,s,n,i=!0,o){const r=this.getMxcAvatarUrl();if(!r&&!i)return null;const c=Object(a.a)(e,r,t,s,n,o);return c||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:null}}const l=/@.+:.+/,d=/[\u200E\u200F\u202A-\u202F]/},,function(e,t,s){"use strict";(function(e){var n=s(8),i=s.n(n);let o=!0;class a extends i.a{constructor(e){super(),this._matrixClient=e,this._userGroups={},this._groupProfiles={},this._groupProfilesPromise={},this._usersPending={},this._usersInFlight={},this._debounceTimeoutID=null}groupSupport(){return o}invalidatePublicisedGroups(e){delete this._userGroups[e]}cachedPublicisedGroups(e){return this._userGroups[e]}getPublicisedGroupsCached(e,t){return this._userGroups[t]?Promise.resolve(this._userGroups[t]):this._usersPending[t]?this._usersPending[t].prom:this._usersInFlight[t]?this._usersInFlight[t].prom:(this._usersPending[t]={},this._usersPending[t].prom=new Promise((e,s)=>{this._usersPending[t].resolve=e,this._usersPending[t].reject=s}).then(e=>(this._userGroups[t]=e,setTimeout(()=>{delete this._userGroups[t]},18e5),this._userGroups[t])).catch(e=>{if("M_UNRECOGNIZED"===e.errcode)return console.warn("Cannot display flair, server does not support groups"),void(o=!1);throw console.error("Could not get groups for user",t,e),e}).finally(()=>{delete this._usersInFlight[t]}),this._debounceTimeoutID&&clearTimeout(this._debounceTimeoutID),this._debounceTimeoutID=setTimeout(()=>{this._batchedGetPublicGroups(e)},200),this._usersPending[t].prom)}async _batchedGetPublicGroups(e){this._usersInFlight=this._usersPending,this._usersPending={};let t={users:[]};try{t=await e.getPublicisedGroups(Object.keys(this._usersInFlight))}catch(e){return void Object.keys(this._usersInFlight).forEach(t=>{this._usersInFlight[t]&&this._usersInFlight[t].reject(e)})}const s=t.users;Object.keys(this._usersInFlight).forEach(e=>{this._usersInFlight[e]&&this._usersInFlight[e].resolve(s[e]||[])})}getGroupProfileCachedFast(e,t){return e&&t?this._groupProfiles[t]?this._groupProfiles[t]:(this.getGroupProfileCached(e,t),null):null}async getGroupProfileCached(e,t){if(this._groupProfiles[t])return this._groupProfiles[t];if(this._groupProfilesPromise[t]){try{await this._groupProfilesPromise[t]}catch(e){return null}return this._groupProfiles[t]}let s;console.log("FlairStore: Request group profile of "+t),this._groupProfilesPromise[t]=e.getGroupProfile(t);try{s=await this._groupProfilesPromise[t]}catch(e){return console.log("FlairStore: Failed to get group profile for "+t,e),delete this._groupProfilesPromise[t],null}return this._groupProfiles[t]={groupId:t,avatarUrl:s.avatar_url,name:s.name,shortDescription:s.short_description},delete this._groupProfilesPromise[t],console.log("FlairStore: Emit updateGroupProfile for "+t),this.emit("updateGroupProfile"),setTimeout(()=>{this.refreshGroupProfile(e,t)},18e5),this._groupProfiles[t]}refreshGroupProfile(e,t){return delete this._groupProfiles[t],this.getGroupProfileCached(e,t)}}void 0===e.singletonFlairStore&&(e.singletonFlairStore=new a),t.a=e.singletonFlairStore}).call(this,s(7))},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i,o,a=s(104),r=s.n(a),c=s(108),l=s.n(c),d=s(18),u=s.n(d),h=s(91),m=s.n(h),p=s(96),g=s(103),v=s(130),f=s(93),b=s(107);let y=Object(f.a)("views.avatars.MemberAvatar")((o=i=class e extends m.a.Component{constructor(t){super(t),this.state=e.getState(t)}static getDerivedStateFromProps(t){return e.getState(t)}static getState(e){var t;if(null!==(t=e.member)&&void 0!==t&&t.name){let t=null;return e.member.getMxcAvatarUrl()&&(t=Object(b.b)(e.member.getMxcAvatarUrl()).getThumbnailOfSourceHttp(e.width,e.height,e.resizeMethod)),{name:e.member.name,title:e.title||e.member.userId,imageUrl:t}}if(e.fallbackUserId)return{name:e.fallbackUserId,title:e.fallbackUserId};console.error("MemberAvatar called somehow with null member or fallbackUserId")}render(){let e=this.props,{member:t,fallbackUserId:s,onClick:n,viewUserOnClick:i}=e,o=l()(e,["member","fallbackUserId","onClick","viewUserOnClick"]);const a=t?t.userId:s;return i&&(n=()=>{p.a.dispatch({action:g.a.ViewUser,member:this.props.member})}),m.a.createElement(v.a,r()({},o,{name:this.state.name,title:this.state.title,idName:a,url:this.state.imageUrl,onClick:n}))}},u()(i,"defaultProps",{width:40,height:40,resizeMethod:"crop",viewUserOnClick:!1}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n,i=s(91),o=s.n(i),a=s(92),r=s(98),c=s(93);let l=Object(c.a)("views.elements.InlineSpinner")(n=class extends o.a.Component{render(){const e=this.props.w||16,t=this.props.h||16,n=this.props.imgClassName||"";let i;return i=r.b.getValue("feature_new_spinner")?o.a.createElement("img",{src:s(490),width:e,height:t,className:n,"aria-label":Object(a.a)("Loading...")}):o.a.createElement("div",{className:"mx_InlineSpinner_icon mx_Spinner_icon",style:{width:this.props.w,height:this.props.h},"aria-label":Object(a.a)("Loading...")}),o.a.createElement("div",{className:"mx_InlineSpinner"},i)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n,i=s(91),o=s.n(i),a=s(333),r=s(93);let c=Object(r.a)("views.elements.LabelledToggleSwitch")(n=class extends o.a.PureComponent{render(){let e=o.a.createElement("span",{className:"mx_SettingsFlag_label"},this.props.label),t=o.a.createElement(a.a,{checked:this.props.value,disabled:this.props.disabled,onChange:this.props.onChange,"aria-label":this.props.label});if(this.props.toggleInFront){const s=e;e=t,t=s}const s="mx_SettingsFlag "+(this.props.className||"");return o.a.createElement("div",{className:s},e,t)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n=s(18),i=s.n(n),o=s(156),a=s(96),r=s(146),c=s(203),l=s(121),d=s(219);class u extends d.b{constructor(e=!1,t,s){super(),this.byTileCount=e,this.tagId=t,this.getRoomFn=s,i()(this,"rooms",[]),i()(this,"states",{}),i()(this,"onRoomNotificationStateUpdate",()=>{this.calculateTotalState()})}get symbol(){return null}setRooms(e){if(this.byTileCount)return this.rooms=e,void this.calculateTotalState();const t=this.rooms,s=Object(l.a)(t,e);this.rooms=e;for(const e of s.removed){const t=this.states[e.roomId];t&&(delete this.states[e.roomId],t.off(d.a,this.onRoomNotificationStateUpdate))}for(const e of s.added){const t=this.getRoomFn(e);t.on(d.a,this.onRoomNotificationStateUpdate),this.states[e.roomId]=t}this.calculateTotalState()}getForRoom(e){const t=this.states[e.roomId];if(!t)throw new Error("Unknown room for notification state");return t}destroy(){super.destroy();for(const e of Object.values(this.states))e.off(d.a,this.onRoomNotificationStateUpdate);this.states={}}calculateTotalState(){const e=this.snapshot();if(this.byTileCount)this._color=c.a.Red,this._count=this.rooms.length;else{this._count=0,this._color=c.a.None;for(const e of Object.values(this.states))this._count+=e.count,this._color=Math.max(this.color,e.color)}this.emitIfUpdated(e)}}var h=s(94),m=s(188),p=s(499),g=s(300),v=s(500);class f extends d.b{constructor(e){super(),this.room=e,i()(this,"handleReadReceipt",(e,t)=>{Object(p.a)(e,h.a.get())&&t.roomId===this.room.roomId&&this.updateNotificationState()}),i()(this,"handleMembershipUpdate",()=>{this.updateNotificationState()}),i()(this,"handleRoomEventUpdate",e=>{e.getRoomId()===this.room.roomId&&this.updateNotificationState()}),i()(this,"handleAccountDataUpdate",e=>{"m.push_rules"===e.getType()&&this.updateNotificationState()}),this.room.on("Room.receipt",this.handleReadReceipt),this.room.on("Room.timeline",this.handleRoomEventUpdate),this.room.on("Room.redaction",this.handleRoomEventUpdate),this.room.on("Room.myMembership",this.handleMembershipUpdate),h.a.get().on("Event.decrypted",this.handleRoomEventUpdate),h.a.get().on("accountData",this.handleAccountDataUpdate),this.updateNotificationState()}get roomIsInvite(){return Object(m.b)(this.room.getMyMembership())===m.a.Invite}destroy(){super.destroy(),this.room.removeListener("Room.receipt",this.handleReadReceipt),this.room.removeListener("Room.timeline",this.handleRoomEventUpdate),this.room.removeListener("Room.redaction",this.handleRoomEventUpdate),this.room.removeListener("Room.myMembership",this.handleMembershipUpdate),h.a.get()&&(h.a.get().removeListener("Event.decrypted",this.handleRoomEventUpdate),h.a.get().removeListener("accountData",this.handleAccountDataUpdate))}updateNotificationState(){const e=this.snapshot();if(g.f(this.room.roomId)===g.d)this._color=c.a.None,this._symbol=null,this._count=0;else if(this.roomIsInvite)this._color=c.a.Red,this._symbol="!",this._count=1;else{const e=g.g(this.room,"highlight"),t=g.g(this.room,"total"),s=t||(e||0);if(e>0)this._color=c.a.Red,this._count=s,this._symbol=null;else if(t>0)this._color=c.a.Grey,this._count=s,this._symbol=null;else{const e=v.a(this.room);this._color=e?c.a.Bold:c.a.None,this._count=0,this._symbol=null}}this.emitIfUpdated(e)}}class b extends d.b{constructor(){super(),i()(this,"totalStatesWithUnread",0),this._symbol=null,this._count=0,this._color=c.a.None}get numUnreadStates(){return this.totalStatesWithUnread}add(e,t=!1){e.symbol&&t&&(this._symbol=e.symbol),e.count&&(this._count+=e.count),e.color>this.color&&(this._color=e.color),e.hasUnreadCount&&this.totalStatesWithUnread++}}var y=s(475);class _ extends o.a{constructor(){super(a.a,{}),i()(this,"roomMap",new Map),i()(this,"listMap",new Map)}get globalState(){if(!this.matrixClient)return new b;const e=new b;for(const t of this.matrixClient.getVisibleRooms())y.a.instance.isRoomVisible(t)&&e.add(this.getRoomState(t));return e}getListState(e){if(this.listMap.has(e))return this.listMap.get(e);const t=e===r.a.Invite,s=new u(t,e,e=>this.getRoomState(e));return this.listMap.set(e,s),s}getRoomState(e){return this.roomMap.has(e)||this.roomMap.set(e,new f(e)),this.roomMap.get(e)}static get instance(){return _.internalInstance}async onNotReady(){for(const e of this.roomMap.values())e.destroy()}async onAction(e){return Promise.resolve()}}i()(_,"internalInstance",new _)},function(e,t,s){"use strict";s.d(t,"c",(function(){return E})),s.d(t,"e",(function(){return S})),s.d(t,"d",(function(){return c})),s.d(t,"a",(function(){return p})),s.d(t,"b",(function(){return g.a}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(111);const c=({children:e,inputRef:t})=>{const[s,n,i]=S(t);return e({onFocus:s,isActive:n,ref:i})};var l=s(104),d=s.n(l),u=s(108),h=s.n(u),m=s(100);const p=e=>{let{inputRef:t}=e,s=h()(e,["inputRef"]);const[n,i,o]=S(t);return a.a.createElement(m.a,d()({},s,{onFocus:n,inputRef:o,tabIndex:i?0:-1}))};var g=s(453);function v(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function f(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?v(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):v(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const b=Object(o.createContext)({state:{activeRef:null,refs:[]},dispatch:()=>{}});var y;b.displayName="RovingTabIndexContext",function(e){e.Register="REGISTER",e.Unregister="UNREGISTER",e.SetFocus="SET_FOCUS"}(y||(y={}));const _=(e,t)=>{switch(t.type){case y.Register:{if(0===e.refs.length)return f(f({},e),{},{activeRef:t.payload.ref,refs:[t.payload.ref]});if(e.refs.includes(t.payload.ref))return e;let s=e.refs.findIndex(e=>2&e.current.compareDocumentPosition(t.payload.ref.current));return s<0&&(s=e.refs.length),f(f({},e),{},{refs:[...e.refs.slice(0,s),t.payload.ref,...e.refs.slice(s)]})}case y.Unregister:{const s=e.refs.filter(e=>e!==t.payload.ref);if(s.length===e.refs.length)return e;if(e.activeRef===t.payload.ref){const n=e.refs.findIndex(e=>e===t.payload.ref);return f(f({},e),{},{activeRef:n>=s.length?s[s.length-1]:s[n],refs:s})}return f(f({},e),{},{refs:s})}case y.SetFocus:return f(f({},e),{},{activeRef:t.payload.ref});default:return e}},E=({children:e,handleHomeEnd:t,onKeyDown:s})=>{const[n,i]=Object(o.useReducer)(_,{activeRef:null,refs:[]}),c=Object(o.useMemo)(()=>({state:n,dispatch:i}),[n]),l=Object(o.useCallback)(e=>{let n=!1;if(t&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName)switch(e.key){case r.a.HOME:n=!0,c.state.refs.length>0&&c.state.refs[0].current.focus();break;case r.a.END:n=!0,c.state.refs.length>0&&c.state.refs[c.state.refs.length-1].current.focus()}if(n)e.preventDefault(),e.stopPropagation();else if(s)return s(e,c.state)},[c.state,s,t]);return a.a.createElement(b.Provider,{value:c},e({onKeyDownHandler:l}))},S=e=>{const t=Object(o.useContext)(b);let s=Object(o.useRef)(null);e&&(s=e),Object(o.useLayoutEffect)(()=>(t.dispatch({type:y.Register,payload:{ref:s}}),()=>{t.dispatch({type:y.Unregister,payload:{ref:s}})}),[]);return[Object(o.useCallback)(()=>{t.dispatch({type:y.SetFocus,payload:{ref:s}})},[s,t]),t.state.activeRef===s,s]}},function(e,t,s){"use strict";s.d(t,"d",(function(){return h})),s.d(t,"a",(function(){return m})),s.d(t,"b",(function(){return p})),s.d(t,"c",(function(){return g}));var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(101),d=s.n(l),u=s(109);const h=e=>{let{label:t,iconClassName:s,active:n,className:o}=e,r=a()(e,["label","iconClassName","active","className"]);return c.a.createElement(u.h,i()({},r,{className:d()(o,{mx_IconizedContextMenu_active:n}),active:n,label:t}),c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",s)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t),n&&c.a.createElement("span",{className:"mx_IconizedContextMenu_icon mx_IconizedContextMenu_checked"}))},m=e=>{let{label:t,iconClassName:s,active:n,className:o}=e,r=a()(e,["label","iconClassName","active","className"]);return c.a.createElement(u.g,i()({},r,{className:d()(o,{mx_IconizedContextMenu_active:n}),active:n,label:t}),c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",s)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t),n&&c.a.createElement("span",{className:"mx_IconizedContextMenu_icon mx_IconizedContextMenu_checked"}))},p=e=>{let{label:t,iconClassName:s}=e,n=a()(e,["label","iconClassName"]);return c.a.createElement(u.f,i()({},n,{label:t}),s&&c.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",s)}),c.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t))},g=({first:e,red:t,className:s,children:n})=>{const i=d()("mx_IconizedContextMenu_optionList",s,{mx_IconizedContextMenu_optionList_notFirst:!e,mx_IconizedContextMenu_optionList_red:t});return c.a.createElement("div",{className:i},n)};t.e=e=>{let{className:t,children:s,compact:n}=e,o=a()(e,["className","children","compact"]);const r=d()("mx_IconizedContextMenu",t,{mx_IconizedContextMenu_compact:n});return c.a.createElement(u.b,i()({chevronFace:u.a.None},o),c.a.createElement("div",{className:r},s))}},function(e,t,s){"use strict";(function(e){var n=s(299),i=s(96),o=s(128),a=s(132),r=s(300),c=s(94),l=s(98);const d={orderedTags:null,orderedTagsAccountData:null,hasSynced:!1,joinedGroupIds:null,selectedTags:[],anchorTag:null};class u extends n.Store{constructor(){super(i.a),this._state=Object.assign({},d),l.b.monitorSetting("TagPanel.enableTagPanel",null)}_setState(e){this._state=Object.assign(this._state,e),this.__emitChange()}__onDispatch(e){switch(e.action){case"view_room":{const t=o.a.getGroupIdsForRoomId(e.room_id);this._updateBadges(t);break}case"MatrixActions.sync":{if("SYNCING"!==e.state&&"PREPARED"!==e.state||this._updateBadges(),"PREPARED"===e.prevState||"PREPARED"!==e.state)break;const t=e.matrixClient.getAccountData("im.vector.web.tag_ordering"),s=t?t.getContent():{};this._setState({orderedTagsAccountData:s.tags||null,removedTagsAccountData:s.removedTags||null,hasSynced:!0}),this._updateOrderedTags();break}case"MatrixActions.accountData":if("im.vector.web.tag_ordering"!==e.event_type)break;if(e.event_content._storeId===this.getStoreId())break;this._setState({orderedTagsAccountData:e.event_content?e.event_content.tags:null,removedTagsAccountData:e.event_content?e.event_content.removedTags:null}),this._updateOrderedTags();break;case"GroupActions.fetchJoinedGroups.success":this._setState({joinedGroupIds:e.result.groups.sort(),hasFetchedJoinedGroups:!0}),this._updateOrderedTags();break;case"TagOrderActions.moveTag.pending":this._setState({orderedTags:e.request.tags,removedTagsAccountData:e.request.removedTags});break;case"TagOrderActions.removeTag.pending":this._setState({removedTagsAccountData:e.request.removedTags}),this._updateOrderedTags();break;case"select_tag":{const t=!l.b.getValue("feature_communities_v2_prototypes");let s=[];if(e.shiftKey&&t){let t=this._state.orderedTags.indexOf(this._state.anchorTag),n=this._state.orderedTags.indexOf(e.tag);if(-1===t&&(t=n),t>n){const e=t;t=n,n=e}s=e.ctrlOrCmdKey?this._state.selectedTags:[],s=[...new Set(this._state.orderedTags.slice(t,n+1).concat(s))]}else s=e.ctrlOrCmdKey&&t?this._state.selectedTags.includes(e.tag)?this._state.selectedTags.filter(t=>t!==e.tag):[...this._state.selectedTags,e.tag]:1===this._state.selectedTags.length&&this._state.selectedTags.includes(e.tag)?[]:[e.tag],this._state.selectedTags.includes(e.tag)||this._setState({anchorTag:e.tag});this._setState({selectedTags:s}),a.a.trackEvent("FilterStore","select_tag")}break;case"deselect_tags":e.tag?this._setState({selectedTags:this._state.selectedTags.filter(t=>t!==e.tag)}):this._setState({selectedTags:[]}),a.a.trackEvent("FilterStore","deselect_tags");break;case"on_client_not_viable":case"on_logged_out":this._state=Object.assign({},d);break;case"setting_updated":"TagPanel.enableTagPanel"!==e.settingName||e.newValue||(this._setState({selectedTags:[]}),a.a.trackEvent("FilterStore","disable_tags"))}}_updateBadges(e=this._state.joinedGroupIds){if(e&&e.length){const t=c.a.get(),s={};e.forEach(e=>{const n=o.a.getGroupRooms(e).map(e=>t.getRoom(e.roomId)).filter(e=>null!=e),i=n&&r.e(n);s[e]=i&&0!==i.count?i:void 0});const n=Object.assign({},this._state.badges,s);this._setState({badges:n})}}_updateOrderedTags(){this._setState({orderedTags:this._state.hasSynced&&this._state.hasFetchedJoinedGroups?this._mergeGroupsAndTags():null})}_mergeGroupsAndTags(){const e=this._state.joinedGroupIds||[],t=this._state.orderedTagsAccountData||[],s=new Set(this._state.removedTagsAccountData||[]),n=t.filter(t=>("+"!==t[0]||e.includes(t))&&!s.has(t)),i=e.filter(e=>!t.includes(e)&&!s.has(e));return n.concat(i)}getGroupBadge(e){const t=this._state.badges;return t&&t[e]}getOrderedTags(){return this._state.orderedTags}getRemovedTagsAccountData(){return this._state.removedTagsAccountData}getStoreId(){return this._id||(this._id=Math.random().toString(16).slice(2,10)),this._id}getSelectedTags(){return this._state.selectedTags}}void 0===e.singletonGroupFilterOrderStore&&(e.singletonGroupFilterOrderStore=new u),t.a=e.singletonGroupFilterOrderStore}).call(this,s(7))},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return W})),s.d(t,"c",(function(){return G})),s.d(t,"b",(function(){return q}));var n=s(115),i=s.n(n),o=s(8),a=s(878),r=s(114),c=s(879),l=s(158),d=s(294),u=s(880),h=s(1),m=s(167),p=s(263),g=s(240),v=s(139),f=s(389),b=s(881),y=s(0),_=s(199),E=s(271),S=s(312),w=s(317),C=s(316),k=s(210),O=s(261),R=s(1319),I=s(558),x=s(152),T=s(894),j=s(318),N=s(895),P=s(110),D=s(241),A=s(896),M=s(136),U=s.n(M),L=s(186),F=s(559),B=s(1320);function V(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function K(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?V(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):V(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const W=Object(S.c)();let G;!function(e){e.Stable="stable",e.Unstable="unstable"}(G||(G={}));class q extends o.EventEmitter{constructor(e){super(),i()(this,"reEmitter",new f.a(this)),i()(this,"olmVersion",null),i()(this,"usingExternalCrypto",!1),i()(this,"store",void 0),i()(this,"deviceId",void 0),i()(this,"credentials",void 0),i()(this,"pickleKey",void 0),i()(this,"scheduler",void 0),i()(this,"clientRunning",!1),i()(this,"timelineSupport",!1),i()(this,"urlPreviewCache",{}),i()(this,"unstableClientRelationAggregation",!1),i()(this,"identityServer",void 0),i()(this,"sessionStore",void 0),i()(this,"http",void 0),i()(this,"crypto",void 0),i()(this,"cryptoCallbacks",void 0),i()(this,"callEventHandler",void 0),i()(this,"supportsCallTransfer",!1),i()(this,"forceTURN",!1),i()(this,"iceCandidatePoolSize",0),i()(this,"idBaseUrl",void 0),i()(this,"baseUrl",void 0),i()(this,"canSupportVoip",!1),i()(this,"peekSync",null),i()(this,"isGuestAccount",!1),i()(this,"ongoingScrollbacks",{}),i()(this,"notifTimelineSet",null),i()(this,"cryptoStore",void 0),i()(this,"verificationMethods",void 0),i()(this,"fallbackICEServerAllowed",!1),i()(this,"roomList",void 0),i()(this,"syncApi",void 0),i()(this,"pushRules",void 0),i()(this,"syncLeftRoomsPromise",void 0),i()(this,"syncedLeftRooms",!1),i()(this,"clientOpts",void 0),i()(this,"clientWellKnownIntervalID",void 0),i()(this,"canResetTimelineCallback",void 0),i()(this,"pushProcessor",new p.a(this)),i()(this,"serverVersionsPromise",void 0),i()(this,"cachedCapabilities",void 0),i()(this,"clientWellKnown",void 0),i()(this,"clientWellKnownPromise",void 0),i()(this,"turnServers",[]),i()(this,"turnServersExpiry",0),i()(this,"checkTurnServersIntervalID",void 0),i()(this,"exportedOlmDeviceToImport",void 0),i()(this,"txnCtr",0),i()(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(this.callEventHandler.start(),this.off("sync",this.startCallEventHandler))}),e.baseUrl=h.m(e.baseUrl),e.idBaseUrl=h.m(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.usingExternalCrypto=e.usingExternalCrypto,this.store=e.store||new c.a,this.deviceId=e.deviceId||null;const t=e.userId||null;this.credentials={userId:t},this.http=new E.d(this,{baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,request:e.request,prefix:E.h,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader}),e.deviceToImport?this.deviceId?y.a.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?y.a.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):y.a.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(async e=>{const t=this.getRoom(e.getRoomId());e.status!==r.a.SENDING&&this.updatePendingEventStatus(t,e,r.a.SENDING);const s=await this.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,r.a.SENT,s.event_id),s});Object(l.g)(this,void 0,void 0)&&(this.callEventHandler=new u.a(this),this.canSupportVoip=!0,this.on("sync",this.startCallEventHandler)),this.timelineSupport=Boolean(e.timelineSupport),this.unstableClientRelationAggregation=!!e.unstableClientRelationAggregation,this.cryptoStore=e.cryptoStore,this.sessionStore=e.sessionStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.roomList=new b.a(this.cryptoStore),this.on("Event.decrypted",e=>{const t=e.getPushActions(),s=this.pushProcessor.actionsForEvent(e);e.setPushActions(s);const n=this.getRoom(e.getRoomId());if(!n)return;const i=n.getUnreadNotificationCount(x.NotificationCountType.Highlight),o=!(!t||!t.tweaks)&&!!t.tweaks.highlight,a=!(!s||!s.tweaks)&&!!s.tweaks.highlight;if((o!==a||i>0)&&!n.hasUserReadEvent(this.getUserId(),e.getId())){let e=i;a&&!o&&e++,!a&&o&&e--,n.setUnreadNotificationCount(x.NotificationCountType.Highlight,e);n.getUnreadNotificationCount(x.NotificationCountType.Total)<e&&n.setUnreadNotificationCount(x.NotificationCountType.Total,e)}}),this.on("Room.receipt",(e,t)=>{if(t&&this.isRoomEncrypted(t.roomId)){const s=e.getContent();if(!(Object.keys(s).filter(e=>Object.keys(s[e]["m.read"]).includes(this.getUserId())).length>0))return;const n=20,i=t.getLiveTimeline().getEvents();let o=0;for(let e=i.length-1;e>=0;e--){if(e===i.length-n)return;const s=i[e];if(t.hasUserReadEvent(this.getUserId(),s.getId()))break;const a=this.getPushActionsForEvent(s);o+=a.tweaks&&a.tweaks.highlight?1:0}t.setUnreadNotificationCount("highlight",o)}})}async startClient(e){if(this.clientRunning)return;this.clientRunning=!0,"number"==typeof e&&(e={initialSyncLimit:e});const t=this.getUserId();t&&this.store.storeUser(new k.a(t)),this.crypto&&(this.crypto.uploadDeviceKeys(),this.crypto.start()),this.canSupportVoip&&(this.checkTurnServersIntervalID=setInterval(()=>{this.checkTurnServers()},6e5),this.checkTurnServers()),this.syncApi&&(y.a.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop()),this.clientOpts=Object.assign({},e),this.clientOpts.crypto=this.crypto,this.clientOpts.canResetEntireTimeline=e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e),this.syncApi=new a.a(this,this.clientOpts),this.syncApi.sync(),void 0!==this.clientOpts.clientWellKnownPollPeriod&&(this.clientWellKnownIntervalID=setInterval(()=>{this.fetchClientWellKnown()},1e3*this.clientOpts.clientWellKnownPollPeriod),this.fetchClientWellKnown())}stopClient(){var t,s,n,i;y.a.log("stopping MatrixClient"),this.clientRunning=!1,null===(t=this.syncApi)||void 0===t||t.stop(),this.syncApi=null,null===(s=this.crypto)||void 0===s||s.stop(),null===(n=this.peekSync)||void 0===n||n.stopPeeking(),null===(i=this.callEventHandler)||void 0===i||i.stop(),this.callEventHandler=null,e.clearInterval(this.checkTurnServersIntervalID),void 0!==this.clientWellKnownIntervalID&&e.clearInterval(this.clientWellKnownIntervalID)}async rehydrateDevice(){if(this.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(!this.cryptoCallbacks.getDehydrationKey)return;const t=await this.getDehydratedDevice();if(!t)return;if(!t.device_data||!t.device_id)return void y.a.info("no dehydrated device found");const s=new e.Olm.Account;try{const e=t.device_data;if(e.algorithm!==I.a)return void y.a.warn("Wrong algorithm for dehydrated device");y.a.log("unpickling dehydrated device");const n=await this.cryptoCallbacks.getDehydrationKey(e,t=>{s.unpickle(new Uint8Array(t),e.account)});s.unpickle(n,e.account),y.a.log("unpickled device");if(!0===(await this.http.authedRequest(void 0,"POST","/dehydrated_device/claim",void 0,{device_id:t.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).success){this.deviceId=t.device_id,y.a.info("using dehydrated device");const e=this.pickleKey||"DEFAULT_KEY";return this.exportedOlmDeviceToImport={pickledAccount:s.pickle(e),sessions:[],pickleKey:e},s.free(),this.deviceId}return s.free(),void y.a.info("not using dehydrated device")}catch(e){s.free(),y.a.warn("could not unpickle",e)}}async getDehydratedDevice(){try{return await this.http.authedRequest(void 0,"GET","/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(e){return void y.a.info("could not get dehydrated device",e.toString())}}async setDehydrationKey(e,t,s){if(this.crypto)return await this.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,s);y.a.warn("not dehydrating device if crypto is not enabled")}async createDehydratedDevice(e,t,s){if(this.crypto)return await this.crypto.dehydrationManager.setKey(e,t,s),await this.crypto.dehydrationManager.dehydrateDevice();y.a.warn("not dehydrating device if crypto is not enabled")}async exportDevice(){if(this.crypto)return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:await this.crypto.olmDevice.export()};y.a.warn("not exporting device if crypto is not enabled")}clearStores(){if(this.clientRunning)throw new Error("Cannot clear stores while client is running");const e=[];return e.push(this.store.deleteAllData()),this.cryptoStore&&e.push(this.cryptoStore.deleteAllData()),Promise.all(e).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}supportsVoip(){return this.canSupportVoip}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}createCall(e){return Object(l.g)(this,e)}getSyncState(){return this.syncApi?this.syncApi.getSyncState():null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){const e=this.getSyncState();return!!e&&(e===T.a.Prepared||e===T.a.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){return this.syncApi.retryImmediately()}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(e=!1){const t=(new Date).getTime();return this.cachedCapabilities&&!e&&t<this.cachedCapabilities.expiration?(y.a.log("Returning cached capabilities"),Promise.resolve(this.cachedCapabilities.capabilities)):this.http.authedRequest(void 0,"GET","/capabilities").catch(e=>(y.a.error(e),null)).then(e=>{e||(e={});const s=e.capabilities||{},n=Object.keys(s).length?216e5:6e4+5e3*Math.random();return this.cachedCapabilities={capabilities:s,expiration:t+n},y.a.log("Caching capabilities: ",s),s})}async initCrypto(){if(!Object(S.c)())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this.crypto)return void y.a.warn("Attempt to re-initialise e2e encryption on MatrixClient");if(!this.sessionStore)throw new Error("Cannot enable encryption: no sessionStore provided");if(!this.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");y.a.log("Crypto: Starting up crypto store..."),await this.cryptoStore.startup(),y.a.log("Crypto: initialising roomlist..."),await this.roomList.init();const e=this.getUserId();if(null===e)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const t=new S.a(this,this.sessionStore,e,this.deviceId,this.store,this.cryptoStore,this.roomList,this.verificationMethods);this.reEmitter.reEmit(t,["crypto.keyBackupFailed","crypto.keyBackupSessionsRemaining","crypto.roomKeyRequest","crypto.roomKeyRequestCancellation","crypto.warning","crypto.devicesUpdated","crypto.willUpdateDevices","deviceVerificationChanged","userTrustStatusChanged","crossSigning.keysChanged"]),y.a.log("Crypto: initialising crypto object..."),await t.init({exportedOlmDevice:this.exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this.exportedOlmDeviceToImport,this.olmVersion=S.a.getOlmVersion(),t.registerEventHandlers(this),this.crypto=t}isCryptoEnabled(){return!!this.crypto}getDeviceEd25519Key(){return this.crypto?this.crypto.getDeviceEd25519Key():null}getDeviceCurve25519Key(){return this.crypto?this.crypto.getDeviceCurve25519Key():null}async uploadKeys(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.uploadDeviceKeys()}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t,s=!0){const n=this.setDeviceVerification(e,t,s,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),n}setDeviceBlocked(e,t,s=!0){return this.setDeviceVerification(e,t,null,s,null)}setDeviceKnown(e,t,s=!0){return this.setDeviceVerification(e,t,null,null,s)}async setDeviceVerification(e,t,s,n,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.setDeviceVerification(e,t,s,n,i)}requestVerificationDM(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,s)}checkSecretStorageKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStorageKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setGlobalBlacklistUnverifiedDevices(e)}getGlobalBlacklistUnverifiedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getGlobalBlacklistUnverifiedDevices()}setGlobalErrorOnUnknownDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setGlobalErrorOnUnknownDevices(e)}getGlobalErrorOnUnknownDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getGlobalErrorOnUnknownDevices()}getCrossSigningId(e=N.a.Master){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkDeviceTrust(e,t)}checkOwnCrossSigningTrust(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,s)}prepareToEncrypt(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.prepareToEncrypt(e)}isCrossSigningReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCryptoTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setCryptoTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.addSecretStorageKey(e,t,s)}hasSecretStorageKey(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.hasSecretStorageKey(e)}storeSecret(e,t,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.storeSecret(e,t,s)}getSecret(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getSecret(e)}isSecretStored(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStored(e,t)}requestSecret(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getDefaultSecretStorageKeyId()}setDefaultSecretStorageKeyId(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setDefaultSecretStorageKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}async getEventSenderDeviceInfo(e){return this.crypto?this.crypto.getEventSenderDeviceInfo(e):null}async isEventSenderVerified(e){const t=await this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()}cancelAndResendEventRoomKeyRequest(e){return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){const t=this.getRoom(e);if(!t)return!1;return!!t.currentState.getStateEvents("m.room.encryption","")||this.roomList.isRoomEncrypted(e)}forceDiscardSession(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");this.crypto.forceDiscardSession(e)}exportRoomKeys(){return this.crypto?this.crypto.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.importRoomKeys(e,t)}checkKeyBackup(){return this.crypto.backupManager.checkKeyBackup()}getKeyBackupVersion(){return this.http.authedRequest(void 0,"GET","/room_keys/version",void 0,void 0,{prefix:E.i}).then(e=>{if(e.algorithm!==v.MEGOLM_BACKUP_ALGORITHM){const t="Unknown backup algorithm: "+e.algorithm;return Promise.reject(t)}if("object"==typeof e.auth_data&&e.auth_data.public_key)return e;{const e="Invalid backup data returned";return Promise.reject(e)}}).catch(e=>{if("M_NOT_FOUND"===e.errcode)return null;throw e})}isKeyBackupTrusted(e){return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}async prepareKeyBackupVersion(e,t={secureSecretStorage:!1}){if(!this.crypto)throw new Error("End-to-end encryption disabled");const{algorithm:s,auth_data:n,recovery_key:i,privateKey:o}=await this.crypto.backupManager.prepareKeyBackupVersion(e);return t.secureSecretStorage&&(await this.storeSecret("m.megolm_backup.v1",Object(v.encodeBase64)(o)),y.a.info("Key backup private key stored in secret storage")),{algorithm:s,auth_data:n,recovery_key:i}}isKeyBackupKeyStored(){return Promise.resolve(this.isSecretStored("m.megolm_backup.v1",!1))}async createKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.createKeyBackupVersion(e);const t={algorithm:e.algorithm,auth_data:e.auth_data};await this.crypto.signObject(t.auth_data),this.cryptoCallbacks.getCrossSigningKey&&this.crypto.crossSigningInfo.getId()&&await this.crypto.crossSigningInfo.signObject(t.auth_data,"master");const s=await this.http.authedRequest(void 0,"POST","/room_keys/version",void 0,t,{prefix:E.i});return await this.checkKeyBackup(),this.getKeyBackupEnabled()||y.a.error("Key backup not usable even though we just created it"),s}deleteKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.version&&this.crypto.backupManager.disableKeyBackup();const t=h.l("/room_keys/version/$version",{$version:e});return this.http.authedRequest(void 0,"DELETE",t,void 0,void 0,{prefix:E.i})}makeKeyBackupPath(e,t,s){let n;n=void 0!==t?h.l("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?h.l("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys";return{path:n,queryData:void 0===s?void 0:{version:s}}}sendKeyBackup(e,t,s,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");const i=this.makeKeyBackupPath(e,t,s);return this.http.authedRequest(void 0,"PUT",i.path,i.queryData,n,{prefix:E.i})}async scheduleAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.scheduleAllGroupSessionsForBackup()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return Object(w.a)(e),!0}catch(e){return!1}}keyBackupKeyFromPassword(e,t){return Object(C.b)(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return Object(w.a)(e)}async restoreKeyBackupWithPassword(e,t,s,n,i){const o=await Object(C.b)(n.auth_data,e);return this.restoreKeyBackup(o,t,s,n,i)}async restoreKeyBackupWithSecretStorage(e,t,s,n){const i=await this.getSecret("m.megolm_backup.v1"),o=Object(S.b)(i);if(o){const[e]=await this.crypto.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",o,[e])}const a=Object(v.decodeBase64)(o||i);return this.restoreKeyBackup(a,t,s,e,n)}restoreKeyBackupWithRecoveryKey(e,t,s,n,i){const o=Object(w.a)(e);return this.restoreKeyBackup(o,t,s,n,i)}async restoreKeyBackupWithCache(e,t,s,n){const i=await this.crypto.getSessionBackupPrivateKey();if(!i)throw new Error("Couldn't get key");return this.restoreKeyBackup(i,e,t,s,n)}async restoreKeyBackup(e,t,s,n,i){const o=null==i?void 0:i.cacheCompleteCallback,a=null==i?void 0:i.progressCallback;if(!this.crypto)throw new Error("End-to-end encryption disabled");let r=0,c=[];const l=this.makeKeyBackupPath(t,s,n.version),d=await F.a.makeAlgorithm(n,async()=>e);try{if(!await d.keyMatches(e))return Promise.reject(new E.c({errcode:q.RESTORE_BACKUP_ERROR_BAD_KEY}));this.crypto.storeSessionBackupPrivateKey(e).catch(e=>{y.a.warn("Error caching session backup key:",e)}).then(o),a&&a({stage:"fetch"});const n=await this.http.authedRequest(void 0,"GET",l.path,l.queryData,void 0,{prefix:E.i});if(n.rooms)for(const[e,t]of Object.entries(n.rooms)){if(!t.sessions)continue;r+=Object.keys(t.sessions).length;const s=await d.decryptSessions(t.sessions);for(const t of s)t.room_id=e,c.push(t)}else if(n.sessions){r=Object.keys(n.sessions).length,c=await d.decryptSessions(n.sessions);for(const e of c)e.room_id=t}else{r=1;try{const[e]=await d.decryptSessions({[s]:n});e.room_id=t,e.session_id=s,c.push(e)}catch(e){y.a.log("Failed to decrypt megolm session from backup",e)}}}finally{d.free()}return await this.importRoomKeys(c,{progressCallback:a,untrusted:!0,source:"backup"}),await this.checkKeyBackup(),{total:r,imported:c.length}}deleteKeysFromBackup(e,t,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");const n=this.makeKeyBackupPath(e,t,s);return this.http.authedRequest(void 0,"DELETE",n.path,n.queryData,void 0,{prefix:E.i})}async sendSharedHistoryKeys(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");const s=this.roomList.getRoomEncryption(e);if(!s)return void y.a.error("Unknown room.  Not sharing decryption keys");const n=await this.crypto.downloadKeys(t),i={};for(const[e,t]of Object.entries(n))i[e]=Object.values(t);const o=this.crypto.getRoomDecryptor(e,s.algorithm);o.sendSharedHistoryInboundSessions?await o.sendSharedHistoryInboundSessions(i):y.a.warn("Algorithm does not support sharing previous keys",s.algorithm)}getGroup(e){return this.store.getGroup(e)}getGroups(){return this.store.getGroups()}getMediaConfig(e){return this.http.authedRequest(e,"GET","/config",void 0,void 0,{prefix:E.g})}getRoom(e){return this.store.getRoom(e)}getRooms(){return this.store.getRooms()}getVisibleRooms(){const e=this.store.getRooms(),t=new Set;for(const s of e){const e=s.currentState.getStateEvents("m.room.create","");if(e){const s=e.getContent().predecessor;s&&s.room_id&&t.add(s.room_id)}}return e.filter(e=>!e.currentState.getStateEvents("m.room.tombstone","")||!t.has(e.roomId))}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t,s){const n=h.l("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e}),i=Object(E.j)(5,()=>this.http.authedRequest(void 0,"PUT",n,void 0,t));return s&&i.then(e=>s(null,e),s),i}getAccountData(e){return this.store.getAccountData(e)}async getAccountDataFromServer(e){if(this.isInitialSyncComplete()){const t=this.store.getAccountData(e);return t?t.getContent():null}const t=h.l("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this.http.authedRequest(void 0,"GET",t,void 0)}catch(e){if(e.data&&"M_NOT_FOUND"===e.data.errcode)return null;throw e}}getIgnoredUsers(){const e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e,t){const s={ignored_users:{}};return e.map(e=>s.ignored_users[e]={}),this.setAccountData("m.ignored_user_list",s,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}async joinRoom(e,t,s){if(h.s(t))throw new Error("Expected 'opts' object, got function.");void 0===(t=t||{}).syncRoom&&(t.syncRoom=!0);const n=this.getRoom(e);if(n&&n.hasMembershipState(this.credentials.userId,"join"))return Promise.resolve(n);let i=Promise.resolve();t.inviteSignUrl&&(i=this.http.requestOtherUrl(void 0,"POST",t.inviteSignUrl,{mxid:this.credentials.userId}));const o={};t.viaServers&&(o.server_name=t.viaServers);const r={qsStringifyOptions:{arrayFormat:"repeat"}};try{const n={},c=await i;c&&(n.third_party_signed=c);const l=h.l("/join/$roomid",{$roomid:e}),d=(await this.http.authedRequest(void 0,"POST",l,o,n,r)).room_id,u=new a.a(this,this.clientOpts).createRoom(d);return t.syncRoom,null==s||s(null,u),u}catch(e){throw null==s||s(e),e}}resendEvent(e,t){return this.updatePendingEventStatus(t,e,r.a.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if([r.a.QUEUED,r.a.NOT_SENT].indexOf(e.status)<0)throw new Error("cannot cancel an event with status "+e.status);this.scheduler&&this.scheduler.removeEventFromQueue(e);const t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,r.a.CANCELLED)}setRoomName(e,t,s){return this.sendStateEvent(e,"m.room.name",{name:t},void 0,s)}setRoomTopic(e,t,s){return this.sendStateEvent(e,"m.room.topic",{topic:t},void 0,s)}getRoomTags(e,t){const s=h.l("/user/$userId/rooms/$roomId/tags/",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(t,"GET",s,void 0)}setRoomTag(e,t,s,n){const i=h.l("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(n,"PUT",i,void 0,s)}deleteRoomTag(e,t,s){const n=h.l("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(s,"DELETE",n,void 0,void 0)}setRoomAccountData(e,t,s,n){const i=h.l("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(n,"PUT",i,void 0,s)}setPowerLevel(e,t,s,n,i){let o={users:{}};n&&"m.room.power_levels"===n.getType()&&(o=h.h(n.getContent())),o.users[t]=s;const a=h.l("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this.http.authedRequest(i,"PUT",a,void 0,o)}sendEvent(e,t,s,n,i){return this.sendCompleteEvent(e,{type:t,content:s},n,i)}sendCompleteEvent(e,t,s,n){h.s(s)&&(n=s,s=void 0),s||(s=this.makeTxnId());const i=new r.b(Object.assign(t,{event_id:"~"+e+":"+s,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),o=this.getRoom(e),a=i.getAssociatedId();if(a&&a.startsWith("~")){const e=o.getPendingEvents().find(e=>e.getId()===a);e.once("Event.localEventIdReplaced",()=>{i.updateAssociatedId(e.getId())})}const c=i.getType();return y.a.log(`sendEvent of type ${c} in ${e} with txnId ${s}`),i.setTxnId(s),i.setStatus(r.a.SENDING),o&&o.addPendingEvent(i,s),i.status===r.a.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(o,i,n)}encryptAndSendEvent(e,t,s){return Promise.resolve().then(()=>{const s=this.encryptEventIfNeeded(t,e);return s?(this.updatePendingEventStatus(e,t,r.a.ENCRYPTING),s.then(()=>this.updatePendingEventStatus(e,t,r.a.SENDING))):null}).then(()=>{let s;return this.scheduler&&(s=this.scheduler.queueEvent(t),s&&this.scheduler.getQueueForEvent(t).length>1&&this.updatePendingEventStatus(e,t,r.a.QUEUED)),s||(s=this.sendEventHttpRequest(t),e&&(s=s.then(s=>(e.updatePendingEvent(t,r.a.SENT,s.event_id),s)))),s}).then(e=>(null==s||s(null,e),e)).catch(n=>{y.a.error("Error sending event",n.stack||n);try{t.error=n,this.updatePendingEventStatus(e,t,r.a.NOT_SENT),n.event=t,null==s||s(n)}catch(e){y.a.error("Exception in error handler!",e.stack||n)}throw n})}encryptEventIfNeeded(e,t){if(e.isEncrypted())return null;if(!this.isRoomEncrypted(e.getRoomId()))return null;if(!this.crypto&&this.usingExternalCrypto)return null;if(e.getType()===P.a.Reaction)return null;if(!this.crypto)throw new Error("This room is configured to use encryption, but your client does not support encryption.");return this.crypto.encryptEvent(e,t)}getEncryptedIfNeededEventType(e,t){return t===P.a.Reaction?t:this.isRoomEncrypted(e)?P.a.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,s){e?e.updatePendingEvent(t,s):t.setStatus(s)}sendEventHttpRequest(e){let t=e.getTxnId();t||(t=this.makeTxnId(),e.setTxnId(t));const s={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:t};let n;if(e.isState()){let t="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(t="/rooms/$roomId/state/$eventType/$stateKey"),n=h.l(t,s)}else if(e.isRedaction()){const t="/rooms/$roomId/redact/$redactsEventId/$txnId";n=h.l(t,Object.assign({$redactsEventId:e.event.redacts},s))}else n=h.l("/rooms/$roomId/send/$eventType/$txnId",s);return this.http.authedRequest(void 0,"PUT",n,void 0,e.getWireContent()).then(t=>(y.a.log(`Event sent to ${e.getRoomId()} with event id ${t.event_id}`),t))}redactEvent(e,t,s,n){const i=("object"==typeof n?n:{}).reason,o="function"==typeof n?n:void 0;return this.sendCompleteEvent(e,{type:P.a.RoomRedaction,content:{reason:i},redacts:t},s,o)}sendMessage(e,t,s,n){return h.s(s)&&(n=s,s=void 0),this.sendEvent(e,"m.room.message",t,s,n)}sendTextMessage(e,t,s,n){const i=j.makeTextMessage(t);return this.sendMessage(e,i,s,n)}sendNotice(e,t,s,n){const i=j.makeNotice(t);return this.sendMessage(e,i,s,n)}sendEmoteMessage(e,t,s,n){const i=j.makeEmoteMessage(t);return this.sendMessage(e,i,s,n)}sendImageMessage(e,t,s,n="Image",i){h.s(n)&&(i=n,n=void 0);const o={msgtype:"m.image",url:t,info:s,body:n};return this.sendMessage(e,o,void 0,i)}sendStickerMessage(e,t,s,n="Sticker",i){h.s(n)&&(i=n,n=void 0);const o={url:t,info:s,body:n};return this.sendEvent(e,P.a.Sticker,o,void 0,i)}sendHtmlMessage(e,t,s,n){const i=j.makeHtmlMessage(t,s);return this.sendMessage(e,i,void 0,n)}sendHtmlNotice(e,t,s,n){const i=j.makeHtmlNotice(t,s);return this.sendMessage(e,i,void 0,n)}sendHtmlEmote(e,t,s,n){const i=j.makeHtmlEmote(t,s);return this.sendMessage(e,i,void 0,n)}sendReceipt(e,t,s,n){if("function"==typeof s&&(n=s,s={}),this.isGuest())return Promise.resolve({});const i=h.l("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),o=this.http.authedRequest(n,"POST",i,void 0,s||{}),a=this.getRoom(e.getRoomId());return a&&a.addLocalEchoReceipt(this.credentials.userId,e,t),o}async sendReadReceipt(e,t,s){"function"==typeof t&&(s=t,t={}),t||(t={});const n=e.getId(),i=this.getRoom(e.getRoomId());if(i&&i.hasPendingEvent(n))throw new Error(`Cannot set read receipt to a pending event (${n})`);const o={"m.hidden":Boolean(t.hidden)};return this.sendReceipt(e,"m.read",o,s)}async setRoomReadMarkers(e,t,s,n){const i=this.getRoom(e);if(i&&i.hasPendingEvent(t))throw new Error(`Cannot set read marker to a pending event (${t})`);let o;if(s){if(o=s.getId(),i&&i.hasPendingEvent(o))throw new Error(`Cannot set read receipt to a pending event (${o})`);i&&i.addLocalEchoReceipt(this.credentials.userId,s,"m.read")}return this.setRoomReadMarkersHttpRequest(e,t,o,n)}getUrlPreview(e,t,s){const n=(t=6e4*Math.floor(t/6e4))+"_"+e,i=this.urlPreviewCache[n];if(i)return s&&i.then(s).catch(s),i;const o=this.http.authedRequest(s,"GET","/preview_url",{url:e,ts:t},void 0,{prefix:E.g});return this.urlPreviewCache[n]=o,o}sendTyping(e,t,s,n){if(this.isGuest())return Promise.resolve({});const i=h.l("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.credentials.userId}),o={typing:t};return t&&(o.timeout=s||2e4),this.http.authedRequest(n,"PUT",i,void 0,o)}getRoomUpgradeHistory(e,t=!1){let s=this.getRoom(e);if(!s)return[];const n=[s];let i=s.currentState.getStateEvents("m.room.create","");for(;i;){y.a.log("Looking at "+i.getId());const e=i.getContent().predecessor;if(!e||!e.room_id)break;{y.a.log("Looking at predecessor "+e.room_id);const s=this.getRoom(e.room_id);if(!s)break;if(t){const e=s.currentState.getStateEvents("m.room.tombstone","");if(!e||e.getContent().replacement_room!==s.roomId)break}n.splice(0,0,s),i=s.currentState.getStateEvents("m.room.create","")}}let o=s.currentState.getStateEvents("m.room.tombstone","");for(;o;){const e=this.getRoom(o.getContent().replacement_room);if(!e)break;if(e.roomId===s.roomId)break;if(t){if(i=e.currentState.getStateEvents("m.room.create",""),!i||!i.getContent().predecessor)break;if(i.getContent().predecessor.room_id!==s.roomId)break}n.push(e);if(new Set(n.map(e=>e.roomId)).size<n.length)return n.slice(0,n.length-1);s=e,o=s.currentState.getStateEvents("m.room.tombstone","")}return n}invite(e,t,s,n){return this.membershipChange(e,t,"invite",n,s)}inviteByEmail(e,t,s){return this.inviteByThreePid(e,"email",t,s)}async inviteByThreePid(e,t,s,n){const i=h.l("/rooms/$roomId/invite",{$roomId:e}),o=this.getIdentityServerUrl(!0);if(!o)return Promise.reject(new E.c({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const a={id_server:o,medium:t,address:s};if(this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(a.id_access_token=e)}return this.http.authedRequest(n,"POST",i,void 0,a)}leave(e,t){return this.membershipChange(e,void 0,"leave",void 0,t)}leaveRoomChain(e,t=!0){const s=this.getRoomUpgradeHistory(e);let n=s;if(!t){n=[];for(const t of s)if(n.push(t),t.roomId===e)break}const i={},o=[],a=e=>this.leave(e).then(()=>{i[e]=null}).catch(t=>(i[e]=t,null));for(const e of n)o.push(a(e.roomId));return Promise.all(o).then(()=>i)}ban(e,t,s,n){return this.membershipChange(e,t,"ban",s,n)}forget(e,t,s){void 0===t&&(t=!0);const n=this.membershipChange(e,void 0,"forget",void 0,s);return t?n.then(t=>(this.store.removeRoom(e),this.emit("deleteRoom",e),t)):n}unban(e,t,s){const n=h.l("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this.http.authedRequest(s,"POST",n,void 0,i)}kick(e,t,s,n){return this.setMembershipState(e,t,"leave",s,n)}setMembershipState(e,t,s,n,i){h.s(n)&&(i=n,n=void 0);const o=h.l("/rooms/$roomId/state/m.room.member/$userId",{$roomId:e,$userId:t});return this.http.authedRequest(i,"PUT",o,void 0,{membership:s,reason:n})}membershipChange(e,t,s,n,i){h.s(n)&&(i=n,n=void 0);const o=h.l("/rooms/$room_id/$membership",{$room_id:e,$membership:s});return this.http.authedRequest(i,"POST",o,void 0,{user_id:t,reason:n})}getPushActionsForEvent(e){return e.getPushActions()||e.setPushActions(this.pushProcessor.actionsForEvent(e)),e.getPushActions()}setProfileInfo(e,t,s){const n=h.l("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(s,"PUT",n,void 0,t)}async setDisplayName(e,t){const s=await this.setProfileInfo("displayname",{displayname:e},t),n=this.getUser(this.getUserId());return n&&(n.displayName=e,n.emit("User.displayName",n.events.presence,n)),s}async setAvatarUrl(e,t){const s=await this.setProfileInfo("avatar_url",{avatar_url:e},t),n=this.getUser(this.getUserId());return n&&(n.avatarUrl=e,n.emit("User.avatarUrl",n.events.presence,n)),s}mxcUrlToHttp(e,t,s,n,i){return Object(O.a)(this.baseUrl,e,t,s,n,i)}_unstable_setStatusMessage(e){const t="im.vector.user_status";return Promise.all(this.getRooms().map(s=>{const n="join"===s.getMyMembership(),i=2===s.getInvitedAndJoinedMemberCount();if(!n||!i)return Promise.resolve();return s.currentState.mayClientSendStateEvent(t,this)?this.sendStateEvent(s.roomId,t,{status:e},this.getUserId()):Promise.resolve()})).then()}setPresence(e,t){const s=h.l("/presence/$userId/status",{$userId:this.credentials.userId});"string"==typeof e&&(e={presence:e});if(-1===["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);return this.http.authedRequest(t,"PUT",s,void 0,e)}getPresence(e,t){const s=h.l("/presence/$userId/status",{$userId:e});return this.http.authedRequest(t,"GET",s,void 0,void 0)}scrollback(e,t,s){h.s(t)&&(s=t,t=void 0),t=t||30;let n=0,i=this.ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){const e=Date.now()-i.errorTs;n=Math.max(3e3-e,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);const o=this.store.scrollback(e,t).length;if(o===t)return Promise.resolve(e);t-=o;const a=new Promise((i,o)=>{Object(h.F)(n).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,"b")).then(t=>{var n;const o=t.chunk.map(this.getEventMapper());if(t.state){const s=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(s)}e.addEventsToTimeline(o,!0,e.getLiveTimeline()),e.oldState.paginationToken=t.end,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,o,t.end,!0),this.ongoingScrollbacks[e.roomId]=null,null===(n=s)||void 0===n||n(null,e),i(e)}).catch(t=>{var n;this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},null===(n=s)||void 0===n||n(t),o(t)})});return i={promise:a,errorTs:null},this.ongoingScrollbacks[e.roomId]=i,a}getEventMapper(e){return Object(A.a)(this,e||{})}getEventTimeline(e,t){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(e.getTimelineForEvent(t))return Promise.resolve(e.getTimelineForEvent(t));const s=h.l("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});let n=void 0;this.clientOpts.lazyLoadMembers&&(n={filter:JSON.stringify(d.a.LAZY_LOADING_MESSAGES_FILTER)});return this.http.authedRequest(void 0,"GET",s,n).then(s=>{if(!s.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);s.events_after.reverse();const n=s.events_after.concat([s.event]).concat(s.events_before).map(this.getEventMapper());let i=e.getTimelineForEvent(n[0].getId());if(i){const e=s.state.map(this.getEventMapper());i.getState(m.a.BACKWARDS).setUnknownStateEvents(e)}else i=e.addTimeline(),i.initialiseState(s.state.map(this.getEventMapper())),i.getState(m.a.FORWARDS).paginationToken=s.end;return e.addEventsToTimeline(n,!0,i,s.start),e.getTimelineForEvent(t)||i})}createMessagesRequest(e,t,s,n,i){const o=h.l("/rooms/$roomId/messages",{$roomId:e});void 0===s&&(s=30);const a={from:t,limit:s,dir:n};let r=null;var c;(this.clientOpts.lazyLoadMembers&&(r=Object.assign({},d.a.LAZY_LOADING_MESSAGES_FILTER)),i)&&(r=r||{},Object.assign(r,null===(c=i.getRoomTimelineFilterComponent())||void 0===c?void 0:c.toJSON()));return r&&(a.filter=JSON.stringify(r)),this.http.authedRequest(void 0,"GET",o,a)}paginateEventTimeline(e,t){const s=e.getTimelineSet()===this.notifTimelineSet,n=(t=t||{}).backwards||!1;if(s&&!n)throw new Error("paginateNotifTimeline can only paginate backwards");const i=n?m.a.BACKWARDS:m.a.FORWARDS,o=e.getPaginationToken(i);if(!o)return Promise.resolve(!1);const a=e._paginationRequests[i];if(a)return a;let r,c,l;if(s)r="/notifications",c={limit:"limit"in t?t.limit:30,only:"highlight"},o&&"end"!==o&&(c.from=o),l=this.http.authedRequest(void 0,"GET","/notifications",c,void 0).then(t=>{const s=t.next_token,o=[];for(let e=0;e<t.notifications.length;e++){const s=t.notifications[e],n=this.getEventMapper()(s.event);n.setPushActions(p.a.actionListToActionsObject(s.actions)),n.event.room_id=s.room_id,o[e]=n}return e.getTimelineSet().addEventsToTimeline(o,n,e,s),n&&!t.next_token&&e.setPaginationToken(null,i),!!t.next_token}).finally(()=>{e._paginationRequests[i]=null}),e._paginationRequests[i]=l;else{if(!this.getRoom(e.getRoomId()))throw new Error("Unknown room "+e.getRoomId());l=this.createMessagesRequest(e.getRoomId(),o,t.limit,i,e.getFilter()),l.then(t=>{if(t.state){const s=e.getState(i),n=t.state.map(this.getEventMapper());s.setUnknownStateEvents(n)}const s=t.end,o=t.chunk.map(this.getEventMapper());return e.getTimelineSet().addEventsToTimeline(o,n,e,s),n&&t.end==t.start&&e.setPaginationToken(null,i),t.end!=t.start}).finally(()=>{e._paginationRequests[i]=null}),e._paginationRequests[i]=l}return l}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end",null)}peekInRoom(e){return this.peekSync&&this.peekSync.stopPeeking(),this.peekSync=new a.a(this,this.clientOpts),this.peekSync.peek(e)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){const s=this.sendStateEvent(e,"m.room.guest_access",{guest_access:t.allowJoin?"can_join":"forbidden"},"");let n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,"m.room.history_visibility",{history_visibility:"world_readable"},"")),Promise.all([n,s]).then()}requestRegisterEmailToken(e,t,s,n){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:s,next_link:n})}requestRegisterMsisdnToken(e,t,s,n,i){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:s,send_attempt:n,next_link:i})}requestAdd3pidEmailToken(e,t,s,n){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:s,next_link:n})}requestAdd3pidMsisdnToken(e,t,s,n,i){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:s,send_attempt:n,next_link:i})}requestPasswordEmailToken(e,t,s,n){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:s,next_link:n})}requestPasswordMsisdnToken(e,t,s,n,i){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:s,send_attempt:n,next_link:i})}async requestTokenFromEndpoint(e,t){const s=Object.assign({},t);if(!await this.doesServerSupportSeparateAddAndBind()&&this.idBaseUrl){const e=U.a.parse(this.idBaseUrl);if(!e.host)throw new Error("Invalid ID server URL: "+this.idBaseUrl);if(s.id_server=e.host,this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(s.id_access_token=e)}}return this.http.request(void 0,"POST",e,void 0,s)}getRoomPushRule(e,t){if(!this.pushRules)throw new Error("SyncApi.sync() must be done before accessing to push rules.");for(let s=0;s<this.pushRules[e].room.length;s++){const n=this.pushRules[e].room[s];if(n.rule_id===t)return n}}setRoomMutePushRule(e,t,s){let n,i;const o=this.getRoomPushRule(e,t);if(o&&0<=o.actions.indexOf("dont_notify")&&(i=!0),s?o?i||(n=h.j(),this.deletePushRule(e,"room",o.rule_id).then(()=>{this.addPushRule(e,"room",t,{actions:["dont_notify"]}).then(()=>{n.resolve()}).catch(e=>{n.reject(e)})}).catch(e=>{n.reject(e)}),n=n.promise):n=this.addPushRule(e,"room",t,{actions:["dont_notify"]}):i&&(n=this.deletePushRule(e,"room",o.rule_id)),n)return new Promise((e,t)=>{n.then(()=>{this.getPushRules().then(t=>{this.pushRules=t,e()}).catch(e=>{t(e)})}).catch(e=>{this.getPushRules().then(s=>{this.pushRules=s,t(e)}).catch(s=>{t(e)})})})}searchMessageText(e,t){const s={search_term:e.query};return"keys"in e&&(s.keys=e.keys),this.search({body:{search_categories:{room_events:s}}},t)}searchRoomEvents(e){const t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:"recent",event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},s={_query:t,results:[],highlights:[]};return this.search({body:t}).then(e=>this.processRoomEventsSearch(s,e))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;const t={body:e._query,next_batch:e.next_batch},s=this.search(t).then(t=>this.processRoomEventsSearch(e,t)).finally(()=>{e.pendingRequest=null});return e.pendingRequest=s,s}processRoomEventsSearch(e,t){const s=t.search_categories.room_events;e.count=s.count,e.next_batch=s.next_batch;const n={};s.highlights.forEach(e=>{n[e]=1}),e.highlights.forEach(e=>{n[e]=1}),e.highlights=Object.keys(n);const i=s.results?s.results.length:0;for(let t=0;t<i;t++){const n=R.a.fromJson(s.results[t],this.getEventMapper());e.results.push(n)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;const e=new a.a(this,this.clientOpts);return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(e=>{y.a.log("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=null}),this.syncLeftRoomsPromise}createFilter(e){const t=h.l("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(void 0,"POST",t,void 0,e).then(t=>{const s=d.a.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(s),s})}getFilter(e,t,s){if(s){const s=this.store.getFilter(e,t);if(s)return Promise.resolve(s)}const n=h.l("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(void 0,"GET",n,void 0,void 0).then(s=>{const n=d.a.fromJson(e,t,s);return this.store.storeFilter(n),n})}async getOrCreateFilter(e,t){const s=this.store.getFilterIdByName(e);let n=void 0;if(s){try{const e=await this.getFilter(this.credentials.userId,s,!0);if(e){const i=e.getDefinition(),o=t.getDefinition();h.g(i,o)&&(n=s)}}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}n||this.store.setFilterIdByName(e,void 0)}if(n)return n;const i=await this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,i.filterId),i.filterId}getOpenIdToken(){const e=h.l("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(void 0,"POST",e,void 0,{})}turnServer(e){return this.http.authedRequest(e,"GET","/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}async checkTurnServers(){if(!this.canSupportVoip)return;let t=!1;const s=this.turnServersExpiry-Date.now();if(s>6e5)y.a.debug("TURN creds are valid for another "+s+" ms: not fetching new ones."),t=!0;else{y.a.debug("Fetching new TURN credentials");try{const e=await this.turnServer();if(e.uris){y.a.log("Got TURN URIs: "+e.uris+" refresh in "+e.ttl+" secs");const s={urls:e.uris,username:e.username,credential:e.password};this.turnServers=[s],this.turnServersExpiry=Date.now()+1e3*e.ttl,t=!0}}catch(t){y.a.error("Failed to get TURN URIs",t),403===t.httpStatus&&(y.a.info("TURN access unavailable for this account: stopping credentials checks"),null!==this.checkTurnServersIntervalID&&e.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=null)}}return t}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){const e=h.l("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(void 0,"GET",e,void 0,void 0,{prefix:""}).then(e=>e.admin)}whoisSynapseUser(e){const t=h.l("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(void 0,"GET",t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){const t=h.l("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(void 0,"POST",t,void 0,void 0,{prefix:""})}async fetchClientWellKnown(){this.clientWellKnownPromise=g.a.getRawClientConfig(this.getDomain()),this.clientWellKnown=await this.clientWellKnownPromise,this.emit("WellKnown.client",this.clientWellKnown)}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){return this.clientWellKnownPromise}storeClientOptions(){const e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(([t,s])=>e.includes(typeof s)).reduce((e,[t,s])=>(e[t]=s,e),{});return this.store.storeClientOptions(t)}async _unstable_getSharedRooms(e){if(!await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666"))throw Error("Server does not support shared_rooms API");const t=h.l("/uk.half-shot.msc2666/user/shared_rooms/$userId",{$userId:e});return(await this.http.authedRequest(void 0,"GET",t,void 0,void 0,{prefix:E.i})).joined}getVersions(){return this.serverVersionsPromise||(this.serverVersionsPromise=this.http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(e=>{throw this.serverVersionsPromise=null,e})),this.serverVersionsPromise}async isVersionSupported(e){const{versions:t}=await this.getVersions();return t&&t.includes(e)}async doesServerSupportLazyLoading(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,s=e.unstable_features;return t&&t.includes("r0.5.0")||s&&s["m.lazy_load_members"]}async doesServerRequireIdServerParam(){const e=await this.getVersions();if(!e)return!0;const t=e.versions;if(t&&t.includes("r0.6.0"))return!1;const s=e.unstable_features;return!s||(void 0===s["m.require_identity_server"]||s["m.require_identity_server"])}async doesServerAcceptIdentityAccessToken(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,s=e.unstable_features;return t&&t.includes("r0.6.0")||s&&s["m.id_access_token"]}async doesServerSupportSeparateAddAndBind(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,s=e.unstable_features;return t&&t.includes("r0.6.0")||s&&s["m.separate_add_and_bind"]}async doesServerSupportUnstableFeature(e){const t=await this.getVersions();if(!t)return!1;const s=t.unstable_features;return s&&!!s[e]}async doesServerForceEncryptionForPreset(e){const t=await this.getVersions();if(!t)return!1;const s=t.unstable_features,n=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return s&&!!s["io.element.e2ee_forced."+n]}hasLazyLoadMembersEnabled(){return!!this.clientOpts.lazyLoadMembers}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}async relations(e,t,s,n,i){const o=this.getEncryptedIfNeededEventType(e,n),a=await this.fetchRelations(e,t,s,o,i),r=this.getEventMapper();let c;a.original_event&&(c=r(a.original_event));let l=a.chunk.map(r);if("m.room.encrypted"===o){const e=c?l.concat(c):l;await Promise.all(e.map(e=>new Promise(t=>e.once("Event.decrypted",t)))),l=l.filter(e=>e.getType()===n)}return c&&"m.replace"===s&&(l=l.filter(e=>e.getSender()===c.getSender())),{originalEvent:c,events:l,nextBatch:a.next_batch}}getCrossSigningCacheCallbacks(){var e;return null===(e=this.crypto)||void 0===e?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return Object(L.b)(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&e.attemptDecryption(this.crypto,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case _.a.IS:return t+E.f+"/terms";case _.a.IM:return t+"/_matrix/integrations/v1/terms";default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(e=!1){return e&&(this.idBaseUrl.startsWith("http://")||this.idBaseUrl.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=h.m(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+(new Date).getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(void 0,"GET","/register/available",{username:e}).then(e=>e.available)}register(e,t,s,n,i,o,a,r){!0===i?i={email:!0}:null==i&&(i={}),"function"==typeof a&&(r=a,a=void 0),s&&(n.session=s);const c={auth:n};return null!=e&&(c.username=e),null!=t&&(c.password=t),i.email&&(c.bind_email=!0),i.msisdn&&(c.bind_msisdn=!0),null!=o&&(c.guest_access_token=o),null!=a&&(c.inhibit_login=a),null!=t&&(c.x_show_msisdn=!0),this.registerRequest(c,void 0,r)}registerGuest(e,t){return(e=e||{}).body=e.body||{},this.registerRequest(e.body,"guest",t)}registerRequest(e,t,s){const n={};return t&&(n.kind=t),this.http.request(s,"POST","/register",n,e)}loginFlows(e){return this.http.request(e,"GET","/login")}login(e,t,s){const n={type:e};return h.o(n,t),this.http.authedRequest((e,t)=>{t&&t.access_token&&t.user_id&&(this.http.opts.accessToken=t.access_token,this.credentials={userId:t.user_id}),s&&s(e,t)},"POST","/login",void 0,n)}loginWithPassword(e,t,s){return this.login("m.login.password",{user:e,password:t},s)}loginWithSAML2(e,t){return this.login("m.login.saml2",{relay_state:e},t)}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e,t="sso",s){let n="/login/"+t+"/redirect";return s&&(n+="/"+s),this.http.getUrl(n,{redirectUrl:e},E.h)}loginWithToken(e,t){return this.login("m.login.token",{token:e},t)}logout(e){return this.http.authedRequest(e,"POST","/logout")}deactivateAccount(e,t){if("function"==typeof t)throw new Error("deactivateAccount no longer accepts a callback parameter");const s={};return e&&(s.auth=e),void 0!==t&&(s.erase=t),this.http.authedRequest(void 0,"POST","/account/deactivate",void 0,s)}getFallbackAuthUrl(e,t){const s=h.l("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(s,{session:t},E.h)}async createRoom(e,t){const s=(e.invite_3pid||[]).filter(e=>!e.id_access_token);if(s.length>0&&this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();if(e)for(const t of s)t.id_access_token=e}return this.http.authedRequest(t,"POST","/createRoom",void 0,e)}async fetchRelations(e,t,s,n,i){const o={};i.from&&(o.from=i.from);const a=h.k(o),r=h.l("/rooms/$roomId/relations/$eventId/$relationType/$eventType?"+a,{$roomId:e,$eventId:t,$relationType:s,$eventType:n});return await this.http.authedRequest(void 0,"GET",r,null,null,{prefix:E.i})}roomState(e,t){const s=h.l("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(t,"GET",s)}fetchRoomEvent(e,t,s){const n=h.l("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(s,"GET",n)}members(e,t,s,n,i){const o={};t&&(o.membership=t),s&&(o.not_membership=s),n&&(o.at=n);const a=h.k(o),r=h.l("/rooms/$roomId/members?"+a,{$roomId:e});return this.http.authedRequest(i,"GET",r)}upgradeRoom(e,t){const s=h.l("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(void 0,"POST",s,void 0,{new_version:t})}getStateEvent(e,t,s,n){const i={$roomId:e,$eventType:t,$stateKey:s};let o=h.l("/rooms/$roomId/state/$eventType",i);return void 0!==s&&(o=h.l(o+"/$stateKey",i)),this.http.authedRequest(n,"GET",o)}sendStateEvent(e,t,s,n="",i){const o={$roomId:e,$eventType:t,$stateKey:n};let a=h.l("/rooms/$roomId/state/$eventType",o);return void 0!==n&&(a=h.l(a+"/$stateKey",o)),this.http.authedRequest(i,"PUT",a,void 0,s)}roomInitialSync(e,t,s){h.s(t)&&(s=t,t=void 0);const n=h.l("/rooms/$roomId/initialSync",{$roomId:e});return t||(t=30),this.http.authedRequest(s,"GET",n,{limit:t})}setRoomReadMarkersHttpRequest(e,t,s,n){const i=h.l("/rooms/$roomId/read_markers",{$roomId:e}),o={"m.fully_read":t,"m.read":s,"m.hidden":Boolean(!!n&&n.hidden)};return this.http.authedRequest(void 0,"POST",i,void 0,o)}getJoinedRooms(){const e=h.l("/joined_rooms",{});return this.http.authedRequest(void 0,"GET",e)}getJoinedRoomMembers(e){const t=h.l("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(void 0,"GET",t)}publicRooms(e,t){"function"==typeof e&&(t=e,e={}),void 0===e&&(e={});const s={};return e.server&&(s.server=e.server,delete e.server),0===Object.keys(e).length&&0===Object.keys(s).length?this.http.authedRequest(t,"GET","/publicRooms"):this.http.authedRequest(t,"POST","/publicRooms",s,e)}createAlias(e,t,s){const n=h.l("/directory/room/$alias",{$alias:e}),i={room_id:t};return this.http.authedRequest(s,"PUT",n,void 0,i)}deleteAlias(e,t){const s=h.l("/directory/room/$alias",{$alias:e});return this.http.authedRequest(t,"DELETE",s,void 0,void 0)}unstableGetLocalAliases(e,t){const s=h.l("/rooms/$roomId/aliases",{$roomId:e}),n=E.i+"/org.matrix.msc2432";return this.http.authedRequest(t,"GET",s,null,null,{prefix:n})}getRoomIdForAlias(e,t){const s=h.l("/directory/room/$alias",{$alias:e});return this.http.authedRequest(t,"GET",s)}resolveRoomAlias(e,t){const s=h.l("/directory/room/$alias",{$alias:e});return this.http.request(t,"GET",s)}getRoomDirectoryVisibility(e,t){const s=h.l("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(t,"GET",s)}setRoomDirectoryVisibility(e,t,s){const n=h.l("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(s,"PUT",n,void 0,{visibility:t})}setRoomDirectoryVisibilityAppService(e,t,s,n){const i=h.l("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this.http.authedRequest(n,"PUT",i,void 0,{visibility:s})}searchUserDirectory(e){const t={search_term:e.term};return void 0!==e.limit&&(t.limit=e.limit),this.http.authedRequest(void 0,"POST","/user_directory/search",void 0,t)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t,s){h.s(t)&&(s=t,t=void 0);const n=t?h.l("/profile/$userId/$info",{$userId:e,$info:t}):h.l("/profile/$userId",{$userId:e});return this.http.authedRequest(s,"GET",n)}getThreePids(e){return this.http.authedRequest(e,"GET","/account/3pid",void 0,void 0)}addThreePid(e,t,s){const n={threePidCreds:e,bind:t};return this.http.authedRequest(s,"POST","/account/3pid",null,n)}async addThreePidOnly(e){const t=await this.isVersionSupported("r0.6.0")?E.h:E.i;return this.http.authedRequest(void 0,"POST","/account/3pid/add",null,e,{prefix:t})}async bindThreePid(e){const t=await this.isVersionSupported("r0.6.0")?E.h:E.i;return this.http.authedRequest(void 0,"POST","/account/3pid/bind",null,e,{prefix:t})}async unbindThreePid(e,t){const s={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)},n=await this.isVersionSupported("r0.6.0")?E.h:E.i;return this.http.authedRequest(void 0,"POST","/account/3pid/unbind",null,s,{prefix:n})}deleteThreePid(e,t){const s={medium:e,address:t};return this.http.authedRequest(void 0,"POST","/account/3pid/delete",null,s)}setPassword(e,t,s){const n={auth:e,new_password:t};return this.http.authedRequest(s,"POST","/account/password",null,n)}getDevices(){return this.http.authedRequest(void 0,"GET","/devices",void 0,void 0)}getDevice(e){const t=h.l("/devices/$device_id",{$device_id:e});return this.http.authedRequest(void 0,"GET",t,void 0,void 0)}setDeviceDetails(e,t){const s=h.l("/devices/$device_id",{$device_id:e});return this.http.authedRequest(void 0,"PUT",s,void 0,t)}deleteDevice(e,t){const s=h.l("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this.http.authedRequest(void 0,"DELETE",s,void 0,n)}deleteMultipleDevices(e,t){const s={devices:e};t&&(s.auth=t);return this.http.authedRequest(void 0,"POST","/delete_devices",void 0,s)}getPushers(e){return this.http.authedRequest(e,"GET","/pushers",void 0,void 0)}setPusher(e,t){return this.http.authedRequest(t,"POST","/pushers/set",null,e)}getPushRules(e){return this.http.authedRequest(e,"GET","/pushrules/").then(e=>p.a.rewriteDefaultRules(e))}addPushRule(e,t,s,n,i){const o=h.l("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:s});return this.http.authedRequest(i,"PUT",o,void 0,n)}deletePushRule(e,t,s,n){const i=h.l("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:s});return this.http.authedRequest(n,"DELETE",i)}setPushRuleEnabled(e,t,s,n,i){const o=h.l("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:s});return this.http.authedRequest(i,"PUT",o,void 0,{enabled:n})}setPushRuleActions(e,t,s,n,i){const o=h.l("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:s});return this.http.authedRequest(i,"PUT",o,void 0,{actions:n})}search(e,t){const s={};return e.next_batch&&(s.next_batch=e.next_batch),this.http.authedRequest(t,"POST","/search",s,e.body)}uploadKeysRequest(e,t,s){return this.http.authedRequest(s,"POST","/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(void 0,"POST","/keys/signatures/upload",void 0,e,{prefix:E.i})}downloadKeysForUsers(e,t){if(h.s(t))throw new Error("downloadKeysForUsers no longer accepts a callback parameter");const s={device_keys:{}};return"token"in(t=t||{})&&(s.token=t.token),e.forEach(e=>{s.device_keys[e]=[]}),this.http.authedRequest(void 0,"POST","/keys/query",void 0,s)}claimOneTimeKeys(e,t="signed_curve25519",s){const n={};void 0===t&&(t="signed_curve25519");for(let s=0;s<e.length;++s){const i=e[s][0],o=e[s][1],a=n[i]||{};n[i]=a,a[o]=t}const i={one_time_keys:n};s&&(i.timeout=s);return this.http.authedRequest(void 0,"POST","/keys/claim",void 0,i)}getKeyChanges(e,t){const s={from:e,to:t};return this.http.authedRequest(void 0,"GET","/keys/changes",s,void 0)}uploadDeviceSigningKeys(e,t){const s=Object.assign({},t);return e&&Object.assign(s,{auth:e}),this.http.authedRequest(void 0,"POST","/keys/device_signing/upload",void 0,s,{prefix:E.i})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No Identity Server base URL set");const t=this.idBaseUrl+E.f+"/account/register";return this.http.requestOtherUrl(void 0,"POST",t,null,e)}async requestEmailToken(e,t,s,n,i,o){const a={client_secret:t,email:e,send_attempt:s,next_link:n};return await this.http.idServerRequest(i,"POST","/validate/email/requestToken",a,E.f,o)}async requestMsisdnToken(e,t,s,n,i,o,a){const r={client_secret:s,country:e,phone_number:t,send_attempt:n,next_link:i};return await this.http.idServerRequest(o,"POST","/validate/msisdn/requestToken",r,E.f,a)}async submitMsisdnToken(e,t,s,n){const i={sid:e,client_secret:t,token:s};return await this.http.idServerRequest(void 0,"POST","/validate/msisdn/submitToken",i,E.f,n)}submitMsisdnTokenOtherUrl(e,t,s,n){const i={sid:t,client_secret:s,token:n};return this.http.requestOtherUrl(void 0,"POST",e,void 0,i)}getIdentityHashDetails(e){return this.http.idServerRequest(void 0,"GET","/hash_details",null,E.f,e)}async identityHashedLookup(t,s){const n={},i=await this.getIdentityHashDetails(s);if(!i||!i.lookup_pepper||!i.algorithms)throw new Error("Unsupported identity server: bad response");n.pepper=i.lookup_pepper;const o={};if(i.algorithms.includes("sha256")){const s=new e.Olm.Utility;n.addresses=t.map(e=>{const t=e[0].toLowerCase(),i=e[1].toLowerCase(),a=s.sha256(`${t} ${i} ${n.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return o[a]=e[0],a}),n.algorithm="sha256"}else{if(!i.algorithms.includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");n.addresses=t.map(e=>{const t=`${e[0].toLowerCase()} ${e[1].toLowerCase()}`;return o[t]=e[0],t}),n.algorithm="none"}const a=await this.http.idServerRequest(void 0,"POST","/lookup",n,E.f,s);if(!a||!a.mappings)return[];const r=[];for(const e of Object.keys(a.mappings)){const t=a.mappings[e],s=o[e];if(!s)throw new Error("Identity server returned more results than expected");r.push({address:s,mxid:t})}return r}async lookupThreePid(e,t,s,n){const i=(await this.identityHashedLookup([[t,e]],n)).find(e=>e.address===t);if(!i)return s&&s(null,{}),{};const o={address:t,medium:e,mxid:i.mxid};return s&&s(null,o),o}async bulkLookupThreePids(e,t){const s=await this.identityHashedLookup(e.map(e=>[e[1],e[0]]),t),n=[];for(const t of s){const s=e.find(e=>e[1]===t.address);if(!s)throw new Error("Identity sever returned unexpected results");n.push([s[0],t.address,t.mxid])}return{threepids:n}}getIdentityAccount(e){return this.http.idServerRequest(void 0,"GET","/account",void 0,E.f,e)}sendToDevice(e,t,s){const n=h.l("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:s||this.makeTxnId()}),i={messages:t},o=Object.keys(t).reduce((e,s)=>(e[s]=Object.keys(t[s]),e),{});return y.a.log("PUT "+n,o),this.http.authedRequest(void 0,"PUT",n,void 0,i)}getThirdpartyProtocols(){return this.http.authedRequest(void 0,"GET","/thirdparty/protocols",void 0,void 0).then(e=>{if(!e||"object"!=typeof e)throw new Error("/thirdparty/protocols did not return an object: "+e);return e})}getThirdpartyLocation(e,t){const s=h.l("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(void 0,"GET",s,t,void 0)}getThirdpartyUser(e,t){const s=h.l("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(void 0,"GET",s,t,void 0)}getTerms(e,t){const s=this.termsUrlForService(e,t);return this.http.requestOtherUrl(void 0,"GET",s)}agreeToTerms(e,t,s,n){const i=this.termsUrlForService(e,t),o={Authorization:"Bearer "+s};return this.http.requestOtherUrl(void 0,"POST",i,null,{user_accepts:n},{headers:o})}reportEvent(e,t,s,n){const i=h.l("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(void 0,"POST",i,null,{score:s,reason:n})}getSpaceSummary(e,t,s,n,i,o){const a=h.l("/rooms/$roomId/spaces",{$roomId:e});return this.http.authedRequest(void 0,"POST",a,null,{max_rooms_per_space:t,suggested_only:s,auto_join_only:n,limit:i,batch:o},{prefix:"/_matrix/client/unstable/org.matrix.msc2946"})}async unstableCreateFileTree(e){const{room_id:t}=await this.createRoom({name:e,preset:D.a.PrivateChat,power_level_content_override:K(K({},B.a),{},{users:{[this.getUserId()]:100}}),creation_content:{[P.d]:P.e.Space},initial_state:[{type:P.g.name,state_key:P.j.name,content:{[P.f.name]:!0}},{type:P.a.RoomEncryption,state_key:"",content:{algorithm:v.MEGOLM_ALGORITHM}}]});return new B.b(this,t)}unstableGetFileTreeSpace(e){var t,s;const n=this.getRoom(e);if(!n)return null;const i=n.currentState.getStateEvents(P.a.RoomCreate,""),o=n.currentState.getStateEvents(P.g.name,P.j.name);if(!i)throw new Error("Expected single room create event");return null!=o&&null!==(t=o.getContent())&&void 0!==t&&t[P.f.name]?(null===(s=i.getContent())||void 0===s?void 0:s[P.d])!==P.e.Space?null:new B.b(this,e):null}getGroupSummary(e){const t=h.l("/groups/$groupId/summary",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}getGroupProfile(e){const t=h.l("/groups/$groupId/profile",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}setGroupProfile(e,t){const s=h.l("/groups/$groupId/profile",{$groupId:e});return this.http.authedRequest(void 0,"POST",s,void 0,t)}setGroupJoinPolicy(e,t){const s=h.l("/groups/$groupId/settings/m.join_policy",{$groupId:e});return this.http.authedRequest(void 0,"PUT",s,void 0,{"m.join_policy":t})}getGroupUsers(e){const t=h.l("/groups/$groupId/users",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}getGroupInvitedUsers(e){const t=h.l("/groups/$groupId/invited_users",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}getGroupRooms(e){const t=h.l("/groups/$groupId/rooms",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}inviteUserToGroup(e,t){const s=h.l("/groups/$groupId/admin/users/invite/$userId",{$groupId:e,$userId:t});return this.http.authedRequest(void 0,"PUT",s,void 0,{})}removeUserFromGroup(e,t){const s=h.l("/groups/$groupId/admin/users/remove/$userId",{$groupId:e,$userId:t});return this.http.authedRequest(void 0,"PUT",s,void 0,{})}addUserToGroupSummary(e,t,s){const n=h.l(s?"/groups/$groupId/summary/$roleId/users/$userId":"/groups/$groupId/summary/users/$userId",{$groupId:e,$roleId:s,$userId:t});return this.http.authedRequest(void 0,"PUT",n,void 0,{})}removeUserFromGroupSummary(e,t){const s=h.l("/groups/$groupId/summary/users/$userId",{$groupId:e,$userId:t});return this.http.authedRequest(void 0,"DELETE",s,void 0,{})}addRoomToGroupSummary(e,t,s){const n=h.l(s?"/groups/$groupId/summary/$categoryId/rooms/$roomId":"/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$categoryId:s,$roomId:t});return this.http.authedRequest(void 0,"PUT",n,void 0,{})}removeRoomFromGroupSummary(e,t){const s=h.l("/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$roomId:t});return this.http.authedRequest(void 0,"DELETE",s,void 0,{})}addRoomToGroup(e,t,s){void 0===s&&(s=!0);const n=h.l("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this.http.authedRequest(void 0,"PUT",n,void 0,{"m.visibility":{type:s?"public":"private"}})}updateGroupRoomVisibility(e,t,s){const n=h.l("/groups/$groupId/admin/rooms/$roomId/config/m.visibility",{$groupId:e,$roomId:t});return this.http.authedRequest(void 0,"PUT",n,void 0,{type:s?"public":"private"})}removeRoomFromGroup(e,t){const s=h.l("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this.http.authedRequest(void 0,"DELETE",s,void 0,{})}acceptGroupInvite(e,t=null){const s=h.l("/groups/$groupId/self/accept_invite",{$groupId:e});return this.http.authedRequest(void 0,"PUT",s,void 0,t||{})}joinGroup(e){const t=h.l("/groups/$groupId/self/join",{$groupId:e});return this.http.authedRequest(void 0,"PUT",t,void 0,{})}leaveGroup(e){const t=h.l("/groups/$groupId/self/leave",{$groupId:e});return this.http.authedRequest(void 0,"PUT",t,void 0,{})}getJoinedGroups(){const e=h.l("/joined_groups",{});return this.http.authedRequest(void 0,"GET",e)}createGroup(e){const t=h.l("/create_group",{});return this.http.authedRequest(void 0,"POST",t,void 0,e)}getPublicisedGroups(e){const t=h.l("/publicised_groups",{});return this.http.authedRequest(void 0,"POST",t,void 0,{user_ids:e})}setGroupPublicity(e,t){const s=h.l("/groups/$groupId/self/update_publicity",{$groupId:e});return this.http.authedRequest(void 0,"PUT",s,void 0,{publicise:t})}}i()(q,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY")}).call(this,s(7))},,function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i=s(104),o=s.n(i),a=s(108),r=s.n(a),c=s(18),l=s.n(c),d=s(91),u=s.n(d),h=s(101),m=s.n(h),p=s(162),g=s(98),v=s(100),f=s(219),b=s(93);let y=Object(b.a)("views.rooms.NotificationBadge")(n=class extends u.a.PureComponent{constructor(e){super(e),l()(this,"countWatcherRef",void 0),l()(this,"countPreferenceChanged",()=>{this.setState({showCounts:g.b.getValue("Notifications.alwaysShowBadgeCounts",this.roomId)})}),l()(this,"onNotificationUpdate",()=>{this.forceUpdate()}),this.props.notification.on(f.a,this.onNotificationUpdate),this.state={showCounts:g.b.getValue("Notifications.alwaysShowBadgeCounts",this.roomId)},this.countWatcherRef=g.b.watchSetting("Notifications.alwaysShowBadgeCounts",this.roomId,this.countPreferenceChanged)}get roomId(){return this.props.roomId||null}componentWillUnmount(){g.b.unwatchSetting(this.countWatcherRef),this.props.notification.off(f.a,this.onNotificationUpdate)}componentDidUpdate(e){e.notification&&e.notification.off(f.a,this.onNotificationUpdate),this.props.notification.on(f.a,this.onNotificationUpdate)}render(){const e=this.props,{notification:t,forceCount:s,roomId:n,onClick:i}=e,a=r()(e,["notification","forceCount","roomId","onClick"]);if(t.isIdle)return null;let c=!(t.symbol||t.count>0)||!t.hasUnreadCount;if(s&&(c=!1,!t.hasUnreadCount))return null;let l=t.symbol||Object(p.c)(t.count);c&&(l="");const d=m()({mx_NotificationBadge:!0,mx_NotificationBadge_visible:!!c||t.hasUnreadCount,mx_NotificationBadge_highlighted:t.hasMentions,mx_NotificationBadge_dot:c,mx_NotificationBadge_2char:l.length>0&&l.length<3,mx_NotificationBadge_3char:l.length>2});return i?u.a.createElement(v.a,o()({},a,{className:d,onClick:i}),u.a.createElement("span",{className:"mx_NotificationBadge_count"},l)):u.a.createElement("div",{className:d},u.a.createElement("span",{className:"mx_NotificationBadge_count"},l))}})||n},function(e,t,s){"use strict";s.d(t,"d",(function(){return E})),s.d(t,"a",(function(){return S})),s.d(t,"c",(function(){return O})),s.d(t,"e",(function(){return R})),s.d(t,"b",(function(){return I})),s.d(t,"f",(function(){return x}));var n=s(99),i=s(95),o=s(94),a=s(316),r=s(317),c=s(92),l=s(139),d=s(243),u=s(594),h=s(250),m=s(98),p=s(221);let g={},v={},f=!1,b=!1,y={};function _(){return f}function E(){return f}class S extends Error{constructor(){super("Secret storage access canceled")}}async function w(){const e=i.getComponent("dialogs.QuestionDialog"),[t]=await n.a.createDialog(e,{title:Object(c.a)("Cancel entering passphrase?"),description:Object(c.a)("Are you sure you want to cancel entering passphrase?"),danger:!1,button:Object(c.a)("Go Back"),cancelButton:Object(c.a)("Cancel")}).finished;return!t}function C(e){return async({passphrase:t,recoveryKey:s})=>t?Object(a.a)(t,e.passphrase.salt,e.passphrase.iterations):Object(r.a)(s)}function k(e,t,s){_()&&(g[e]=s,v[e]=t)}const O={getSecretStorageKey:async function({keys:e},t){var s;const i=o.a.get();let a,r=await i.getDefaultSecretStorageKeyId();if(r&&(a=e[r],a||(r=void 0)),!r){const t=Object.entries(e);if(t.length>1)throw new Error("Multiple storage key requests not implemented");[r,a]=t[0]}if(_()&&g[r])return[r,g[r]];if(y.key&&await o.a.get().checkSecretStorageKey(y.key,a))return k(r,a,y.key),[r,y.key];const c=null===(s=p.a.getSecretStorageKey)||void 0===s?void 0:s.call(p.a);if(c)return console.log("Using key from security customisations (secret storage)"),k(r,a,c),[r,c];if(b)throw new Error("Could not unlock non-interactively");const l=C(a),{finished:d}=n.a.createTrackedDialog("Access Secret Storage dialog","",u.a,{keyInfo:a,checkPrivateKey:async e=>{const t=await l(e);return await o.a.get().checkSecretStorageKey(t,a)}},null,!1,!1,{onBeforeClose:async e=>"backgroundClick"!==e||w()}),[h]=await d;if(!h)throw new S;const m=await l(h);return k(r,a,m),[r,m]},cacheSecretStorageKey:k,onSecretRequested:async function(e,t,s,n,i){console.log("onSecretRequested",e,t,s,n,i);const a=o.a.get();if(e===a.getUserId())if(i&&i.isVerified()){if("m.cross_signing.master"===n||"m.cross_signing.self_signing"===n||"m.cross_signing.user_signing"===n){const e=a.getCrossSigningCacheCallbacks();if(!e.getCrossSigningKeyCache)return;const s=n.replace("m.cross_signing.",""),i=await e.getCrossSigningKeyCache(s);return i||console.log(`${s} requested by ${t}, but not found in cache`),i&&Object(l.encodeBase64)(i)}if("m.megolm_backup.v1"===n){const e=await a.crypto.getSessionBackupPrivateKey();return e||console.log(`session backup key requested by ${t}, but not found in cache`),e&&Object(l.encodeBase64)(e)}console.warn("onSecretRequested didn't recognise the secret named ",n)}else console.log("Ignoring secret request from untrusted device "+t)},getDehydrationKey:async function(e,t){var s;const i=null===(s=p.a.getSecretStorageKey)||void 0===s?void 0:s.call(p.a);if(i)return console.log("Using key from security customisations (dehydration)"),i;const o=C(e),{finished:a}=n.a.createTrackedDialog("Access Secret Storage dialog","",u.a,{keyInfo:e,checkPrivateKey:async e=>{const s=await o(e);try{return t(s),!0}catch(e){return!1}}},null,!1,!1,{onBeforeClose:async e=>"backgroundClick"!==e||w()}),[r]=await a;if(!r)throw new S;const c=await o(r);return y={key:new Uint8Array(c),keyInfo:e},c}};async function R(){let e;const{finished:t}=n.a.createTrackedDialog("Restore Backup","",h.a,{showSummary:!1,keyCallback:t=>e=t},null,!1,!0);if(!await t)throw new Error("Key backup prompt cancelled");return e}async function I(e=(async()=>{}),t=!1){const a=o.a.get();f=!0;try{if(!await a.hasSecretStorageKey()||t){const{finished:e}=n.a.createTrackedDialogAsync("Create Secret Storage dialog","",s.e(27).then(s.bind(null,1305)),{forceReset:t},null,!1,!0,{onBeforeClose:async e=>"backgroundClick"!==e||!Object(d.d)()}),[i]=await e;if(!i)throw new Error("Secret storage creation canceled")}else{const e=i.getComponent("dialogs.InteractiveAuthDialog");await a.bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const{finished:s}=n.a.createTrackedDialog("Cross-signing keys dialog","",e,{title:Object(c.a)("Setting up keys"),matrixClient:a,makeRequest:t}),[i]=await s;if(!i)throw new Error("Cross-signing key upload auth canceled")}}),await a.bootstrapSecretStorage({getKeyBackupPassphrase:R});const t=Object.keys(g)[0];if(t&&m.b.getValue("feature_dehydration")){let e={};v[t]&&v[t].passphrase&&(e={passphrase:v[t].passphrase}),console.log("Setting dehydration key"),await a.setDehydrationKey(g[t],e,"Backup device")}else t?console.log("Not setting dehydration key: feature disabled"):console.warn("Not setting dehydration key: no SSSS key found")}return await e()}catch(e){var r;throw null===(r=p.a.catchAccessSecretStorageError)||void 0===r||r.call(p.a,e),console.error(e),e}finally{f=!1,_()||(g={},v={})}}async function x(e){const t=y.key;let s=!1;if(t&&await e.isSecretStorageReady()){console.log("Trying to set up cross-signing using dehydration key"),f=!0,b=!0;try{await e.checkOwnCrossSigningTrust();let n={};y.keyInfo&&y.keyInfo.passphrase&&(n={passphrase:y.keyInfo.passphrase}),await e.setDehydrationKey(t,n,"Backup device");const i=await e.getKeyBackupVersion();i&&(s=!0,e.restoreKeyBackupWithSecretStorage(i).finally(()=>{f=!1,b=!1,_()||(g={},v={})}))}finally{y={},s||(f=!1,b=!1,_()||(g={},v={}))}}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(18),i=s.n(n),o=s(156),a=s(96),r=s(188),c=s(98),l=s(1),d=s(123),u=s(170),h=s(177),m=s(128);class p extends o.a{constructor(){super(a.a,{})}static get instance(){return p.internalInstance}static getUpdateEventName(e){return`${d.b}:${e}`}getSelectedCommunityId(){return c.b.getValue("feature_communities_v2_prototypes")?h.a.getSelectedTags()[0]:null}getSelectedCommunityName(){return p.instance.getCommunityName(this.getSelectedCommunityId())}getSelectedCommunityGeneralChat(){const e=this.getSelectedCommunityId();if(e)return this.getGeneralChat(e)}getCommunityName(e){const t=u.a.getGroupProfileCachedFast(this.matrixClient,e);return(null==t?void 0:t.name)||e}getCommunityProfile(e){return u.a.getGroupProfileCachedFast(this.matrixClient,e)}getGeneralChat(e){const t=m.a.getGroupRooms(e).map(e=>this.matrixClient.getRoom(e.roomId)).filter(e=>!!e);let s=t.find(t=>{const s=t.currentState.getStateEvents("im.vector.general_chat","");return!(!s||s.getContent().groupId!==e)});return s||(s=t[0]),s}isAdminOf(e){const t=m.a.getGroupMembers(e).find(e=>e.userId===this.matrixClient.getUserId());return null==t?void 0:t.isPrivileged}canInviteTo(e){const t=this.getGeneralChat(e);if(!t)return this.isAdminOf(e);const s=t.getMember(this.matrixClient.getUserId());if(!s)return this.isAdminOf(e);const n=t.currentState.getStateEvents("m.room.power_levels","");if(!n)return this.isAdminOf(e);const i=n.getContent();return(Object(l.t)(i.invite)?50:Number(i.invite))<=s.powerLevel}async onAction(e){if(this.matrixClient&&c.b.getValue("feature_communities_v2_prototypes"))if("MatrixActions.Room.myMembership"===e.action){const t=e.room,s=Object(r.b)(e.membership);if(s===Object(r.b)(e.oldMembership))return;if(s===r.a.Invite)try{const e=l.l("/rooms/$roomId/group_info",{$roomId:t.roomId}),s=await this.matrixClient.http.authedRequest(void 0,"GET",e,void 0,void 0,{prefix:"/_matrix/client/unstable/im.vector.custom"});await this.matrixClient.setAccountData("im.vector.group_info."+t.roomId,s)}catch(e){console.warn("Non-fatal error getting group information for invite:",e)}}else if("MatrixActions.accountData"===e.action){if(e.event_type.startsWith("im.vector.group_info.")){const t=e.event_type.substring("im.vector.group_info.".length);this.emit(p.getUpdateEventName(t),t)}}else if("select_tag"===e.action){const t=this.getGeneralChat(e.tag);t&&a.a.dispatch({action:"view_room",room_id:t.roomId})}}getInviteProfile(e){if(!this.matrixClient)return{displayName:null,avatarMxc:null};const t=this.matrixClient.getRoom(e);if(c.b.getValue("feature_communities_v2_prototypes")){const t=this.matrixClient.getAccountData("im.vector.group_info."+e);if(t&&t.getContent())return{displayName:t.getContent().name,avatarMxc:t.getContent().avatar_url}}return{displayName:t.name,avatarMxc:t.getMxcAvatarUrl()}}async onReady(){for(const e of this.matrixClient.getRooms()){const t=e.currentState.getMembers().find(e=>e.userId===this.matrixClient.getUserId());t&&(Object(r.b)(t.membership)===r.a.Invite&&this.emit(p.getUpdateEventName(e.roomId),e.roomId))}}}i()(p,"internalInstance",new p)},function(e,t,s){"use strict";s.d(t,"a",(function(){return k}));var n=s(18),i=s.n(n),o=s(102),a=s(99),r=s(136),c=s.n(r),l=s(98),d=s(277),u=s(94),h=s(296),m=s.n(h),p=s(199);class g{constructor(e,t){this.apiUrl=e,this.uiUrl=t,i()(this,"scalarToken",void 0),i()(this,"termsInteractionCallback",void 0),i()(this,"isDefaultManager",void 0),this.scalarToken=null,this.termsInteractionCallback=void 0;const s=o.a.get().integrations_rest_url,n=o.a.get().integrations_ui_url;this.isDefaultManager=e===s&&n===t}writeTokenToStore(){window.localStorage.setItem("mx_scalar_token_at_"+this.apiUrl,this.scalarToken),this.isDefaultManager&&window.localStorage.removeItem("mx_scalar_token")}readTokenFromStore(){let e=window.localStorage.getItem("mx_scalar_token_at_"+this.apiUrl);return!e&&this.isDefaultManager&&(e=window.localStorage.getItem("mx_scalar_token")),e}readToken(){return this.scalarToken?this.scalarToken:this.readTokenFromStore()}setTermsInteractionCallback(e){this.termsInteractionCallback=e}connect(){return this.getScalarToken().then(e=>{this.scalarToken=e})}hasCredentials(){return null!=this.scalarToken}getScalarToken(){const e=this.readToken();return e?this.checkToken(e).catch(e=>{if(e instanceof d.b)throw e;return this.registerForToken()}):this.registerForToken()}getAccountName(e){const t=this.apiUrl+"/account";return new Promise((function(s,n){m()({method:"GET",uri:t,qs:{scalar_token:e,v:"1.1"},json:!0},(e,t,i)=>{e?n(e):i&&"M_TERMS_NOT_SIGNED"===i.errcode?n(new d.b):t.statusCode/100!=2?n(i):i&&i.user_id?s(i.user_id):n(new Error("Missing user_id in response"))})}))}checkToken(e){return this.getAccountName(e).then(t=>{const s=u.a.get().getUserId();if(t!==s)throw new Error("Scalar token is owned by someone else: "+s);return e}).catch(t=>{if(t instanceof d.b){console.log("Integration manager requires new terms to be agreed to");const t=c.a.parse(this.apiUrl);return t.path="",t.pathname="",Object(d.d)([new d.a(p.a.IM,c.a.format(t),e)],this.termsInteractionCallback).then(()=>e)}throw t})}registerForToken(){return u.a.get().getOpenIdToken().then(e=>this.exchangeForScalarToken(e)).then(e=>this.checkToken(e)).then(e=>(this.scalarToken=e,this.writeTokenToStore(),e))}exchangeForScalarToken(e){const t=this.apiUrl;return new Promise((function(s,n){m()({method:"POST",uri:t+"/register",qs:{v:"1.1"},body:e,json:!0},(e,t,i)=>{e?n(e):t.statusCode/100!=2?n(new Error("Scalar request failed: "+t.statusCode)):i&&i.scalar_token?s(i.scalar_token):n(new Error("Missing scalar_token in response"))})}))}getScalarPageTitle(e){let t=this.apiUrl+"/widgets/title_lookup";return t=this.getStarterLink(t),t+="&curl="+encodeURIComponent(e),new Promise((function(e,s){m()({method:"GET",uri:t,json:!0},(t,n,i)=>{if(t)s(t);else if(n.statusCode/100!=2)s(new Error("Scalar request failed: "+n.statusCode));else if(i){let t="";i.page_title_cache_item&&i.page_title_cache_item.cached_title&&(t=i.page_title_cache_item.cached_title),e(t)}else s(new Error("Missing page title in response"))})}))}disableWidgetAssets(e,t){let s=this.apiUrl+"/widgets/set_assets_state";return s=this.getStarterLink(s),new Promise((n,i)=>{m()({method:"GET",uri:s,json:!0,qs:{widget_type:e.preferred,widget_id:t,state:"disable"}},(e,t,s)=>{e?i(e):t.statusCode/100!=2?i(new Error("Scalar request failed: "+t.statusCode)):s?n():i(new Error("Failed to set widget assets state"))})})}getScalarInterfaceUrlForRoom(e,t,s){const n=e.roomId,i=e.name;let o=this.uiUrl;return o+="?scalar_token="+encodeURIComponent(this.scalarToken),o+="&room_id="+encodeURIComponent(n),o+="&room_name="+encodeURIComponent(i),o+="&theme="+encodeURIComponent(l.b.getValue("theme")),s&&(o+="&integ_id="+encodeURIComponent(s)),t&&(o+="&screen="+encodeURIComponent(t)),o}getStarterLink(e){return e+"?scalar_token="+encodeURIComponent(this.scalarToken)}}var v=s(567);let f;!function(e){e.Account="account",e.Config="config",e.Homeserver="homeserver"}(f||(f={}));class b{constructor(e,t,s=t,n){i()(this,"apiUrl",void 0),i()(this,"uiUrl",void 0),i()(this,"kind",void 0),i()(this,"id",void 0),this.kind=e,this.apiUrl=t,this.uiUrl=s,this.id=n}get name(){return c.a.parse(this.uiUrl).host}get trimmedApiUrl(){const e=c.a.parse(this.apiUrl);return e.pathname="",e.path="",c.a.format(e)}getScalarClient(){return new g(this.apiUrl,this.uiUrl)}async open(e=null,t=null,s=null){if(!l.b.getValue("integrationProvisioning"))return k.sharedInstance().showDisabledDialog();const n=a.a.createTrackedDialog("Integration Manager","",v.a,{loading:!0},"mx_IntegrationManager"),i=this.getScalarClient();i.setTermsInteractionCallback((e,t)=>Object(d.c)(e,t,"mx_TermsDialog_forIntegrationManager"));const o={};try{await i.connect(),i.hasCredentials()?o.url=i.getScalarInterfaceUrlForRoom(e,t,s):o.connected=!1}catch(e){if(e instanceof d.b)return void n.close();console.error(e),o.connected=!1}n.close(),a.a.createTrackedDialog("Integration Manager","",v.a,o,"mx_IntegrationManager")}}var y=s(568),_=s(569),E=s(571),S=s(140),w=s(142);const C=[f.Account,f.Homeserver,f.Config];class k{static sharedInstance(){return k.instance||(k.instance=new k),k.instance}constructor(){i()(this,"managers",[]),i()(this,"client",void 0),i()(this,"primaryManager",void 0),i()(this,"setupHomeserverManagers",async e=>{if(console.log("Updating homeserver-configured integration managers..."),e&&e["m.integrations"]){let t=e["m.integrations"].managers;Array.isArray(t)||(t=[]),console.log(`Homeserver has ${t.length} integration managers`),this.managers=this.managers.filter(e=>e.kind!==f.Homeserver);for(const e of t)e.api_url&&this.managers.push(new b(f.Homeserver,e.api_url,e.ui_url));this.primaryManager=null}else console.log("Homeserver has no integration managers")}),i()(this,"onAccountData",e=>{"m.widgets"===e.getType()&&this.compileManagers()}),this.compileManagers()}startWatching(){this.stopWatching(),this.client=u.a.get(),this.client.on("accountData",this.onAccountData),this.client.on("WellKnown.client",this.setupHomeserverManagers),this.compileManagers()}stopWatching(){this.client&&(this.client.removeListener("accountData",this.onAccountData),this.client.removeListener("WellKnown.client",this.setupHomeserverManagers))}compileManagers(){this.managers=[],this.setupConfiguredManager(),this.setupAccountManagers()}setupConfiguredManager(){const e=o.a.get().integrations_rest_url,t=o.a.get().integrations_ui_url;e&&t&&(this.managers.push(new b(f.Config,e,t)),this.primaryManager=null)}setupAccountManagers(){if(!this.client||!this.client.getUserId())return;S.a.getIntegrationManagerWidgets().forEach(e=>{const t=e.content.data;if(!t)return;const s=e.content.url,n=t.api_url;if(!n||!s)return;const i=new b(f.Account,n,s,e.id||e.state_key||"");this.managers.push(i)}),this.primaryManager=null}hasManager(){return this.managers.length>0}getOrderedManagers(){const e=[];for(const t of C){const s=this.managers.filter(e=>e.kind===t);s&&s.length&&(t===f.Account&&s.sort((e,t)=>Object(w.a)(e.id,t.id)),e.push(...s))}return e}getPrimaryManager(){return this.hasManager()?(this.primaryManager||(this.primaryManager=this.getOrderedManagers()[0]),this.primaryManager):null}openNoManagerDialog(){a.a.createTrackedDialog("Integrations impossible","",y.a)}openAll(e=null,t=null,s=null){return l.b.getValue("integrationProvisioning")?0===this.managers.length?this.openNoManagerDialog():void a.a.createTrackedDialog("Tabbed Integration Manager","",_.a,{room:e,screen:t,integrationId:s},"mx_TabbedIntegrationManagerDialog"):this.showDisabledDialog()}showDisabledDialog(){a.a.createTrackedDialog("Integrations disabled","",E.a)}async overwriteManagerOnAccount(e){await S.a.removeIntegrationManagerWidgets(),await S.a.addIntegrationManagerWidget(e.name,e.uiUrl,e.apiUrl)}async tryDiscoverManager(e){let t;console.log("Looking up integration manager via .well-known"),(e.startsWith("http:")||e.startsWith("https:"))&&(e=c.a.parse(e).host);try{const s=await fetch(`https://${e}/.well-known/matrix/integrations`);t=await s.json()}catch(e){return console.error(e),console.warn("Failed to locate integration manager"),null}if(!t||!t["m.integrations_widget"])return console.warn("Missing integrations widget on .well-known response"),null;const s=t["m.integrations_widget"];if(!s.url||!s.data||!s.data.api_url)return console.warn("Malformed .well-known response for integrations widget"),null;const n=new b(f.Account,s.data.api_url,s.url);return console.log("Got an integration manager (untested)"),n}}i()(k,"instance",void 0),window.mxIntegrationManagers=k},function(e,t,s){"use strict";s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l})),s.d(t,"e",(function(){return d})),s.d(t,"d",(function(){return u})),s.d(t,"c",(function(){return h})),s.d(t,"f",(function(){return g}));var n=s(18),i=s.n(n),o=s(111),a=s(98);const r={getMessageComposerBindings:()=>{const e=[{action:c.SelectPrevSendHistory,keyCombo:{key:o.a.ARROW_UP,altKey:!0,ctrlKey:!0}},{action:c.SelectNextSendHistory,keyCombo:{key:o.a.ARROW_DOWN,altKey:!0,ctrlKey:!0}},{action:c.EditPrevMessage,keyCombo:{key:o.a.ARROW_UP}},{action:c.EditNextMessage,keyCombo:{key:o.a.ARROW_DOWN}},{action:c.CancelEditing,keyCombo:{key:o.a.ESCAPE}},{action:c.FormatBold,keyCombo:{key:o.a.B,ctrlOrCmd:!0}},{action:c.FormatItalics,keyCombo:{key:o.a.I,ctrlOrCmd:!0}},{action:c.FormatQuote,keyCombo:{key:o.a.GREATER_THAN,ctrlOrCmd:!0,shiftKey:!0}},{action:c.EditUndo,keyCombo:{key:o.a.Z,ctrlOrCmd:!0}},{action:c.MoveCursorToStart,keyCombo:{key:o.a.HOME,ctrlOrCmd:!0}},{action:c.MoveCursorToEnd,keyCombo:{key:o.a.END,ctrlOrCmd:!0}}];return o.b?e.push({action:c.EditRedo,keyCombo:{key:o.a.Z,ctrlOrCmd:!0,shiftKey:!0}}):e.push({action:c.EditRedo,keyCombo:{key:o.a.Y,ctrlOrCmd:!0}}),a.b.getValue("MessageComposerInput.ctrlEnterToSend")?(e.push({action:c.Send,keyCombo:{key:o.a.ENTER,ctrlOrCmd:!0}}),e.push({action:c.NewLine,keyCombo:{key:o.a.ENTER}})):(e.push({action:c.Send,keyCombo:{key:o.a.ENTER}}),e.push({action:c.NewLine,keyCombo:{key:o.a.ENTER,shiftKey:!0}}),o.b&&e.push({action:c.NewLine,keyCombo:{key:o.a.ENTER,altKey:!0}})),e},getAutocompleteBindings:()=>[{action:l.CompleteOrNextSelection,keyCombo:{key:o.a.TAB}},{action:l.CompleteOrNextSelection,keyCombo:{key:o.a.TAB,ctrlKey:!0}},{action:l.CompleteOrPrevSelection,keyCombo:{key:o.a.TAB,shiftKey:!0}},{action:l.CompleteOrPrevSelection,keyCombo:{key:o.a.TAB,ctrlKey:!0,shiftKey:!0}},{action:l.Cancel,keyCombo:{key:o.a.ESCAPE}},{action:l.PrevSelection,keyCombo:{key:o.a.ARROW_UP}},{action:l.NextSelection,keyCombo:{key:o.a.ARROW_DOWN}}],getRoomListBindings:()=>[{action:d.ClearSearch,keyCombo:{key:o.a.ESCAPE}},{action:d.PrevRoom,keyCombo:{key:o.a.ARROW_UP}},{action:d.NextRoom,keyCombo:{key:o.a.ARROW_DOWN}},{action:d.SelectRoom,keyCombo:{key:o.a.ENTER}},{action:d.CollapseSection,keyCombo:{key:o.a.ARROW_LEFT}},{action:d.ExpandSection,keyCombo:{key:o.a.ARROW_RIGHT}}],getRoomBindings:()=>{const e=[{action:u.ScrollUp,keyCombo:{key:o.a.PAGE_UP}},{action:u.RoomScrollDown,keyCombo:{key:o.a.PAGE_DOWN}},{action:u.DismissReadMarker,keyCombo:{key:o.a.ESCAPE}},{action:u.JumpToOldestUnread,keyCombo:{key:o.a.PAGE_UP,shiftKey:!0}},{action:u.UploadFile,keyCombo:{key:o.a.U,ctrlOrCmd:!0,shiftKey:!0}},{action:u.JumpToFirstMessage,keyCombo:{key:o.a.HOME,ctrlKey:!0}},{action:u.JumpToLatestMessage,keyCombo:{key:o.a.END,ctrlKey:!0}}];return a.b.getValue("ctrlFForSearch")&&e.push({action:u.FocusSearch,keyCombo:{key:o.a.F,ctrlOrCmd:!0}}),e},getNavigationBindings:()=>[{action:h.FocusRoomSearch,keyCombo:{key:o.a.K,ctrlOrCmd:!0}},{action:h.ToggleRoomSidePanel,keyCombo:{key:o.a.PERIOD,ctrlOrCmd:!0}},{action:h.ToggleUserMenu,keyCombo:{key:o.a.BACKTICK,ctrlOrCmd:!0}},{action:h.ToggleShortCutDialog,keyCombo:{key:o.a.SLASH,ctrlOrCmd:!0}},{action:h.ToggleShortCutDialog,keyCombo:{key:o.a.SLASH,ctrlOrCmd:!0,shiftKey:!0}},{action:h.GoToHome,keyCombo:{key:o.a.H,ctrlKey:!0,altKey:!o.b,shiftKey:o.b}},{action:h.SelectPrevRoom,keyCombo:{key:o.a.ARROW_UP,altKey:!0}},{action:h.SelectNextRoom,keyCombo:{key:o.a.ARROW_DOWN,altKey:!0}},{action:h.SelectPrevUnreadRoom,keyCombo:{key:o.a.ARROW_UP,altKey:!0,shiftKey:!0}},{action:h.SelectNextUnreadRoom,keyCombo:{key:o.a.ARROW_DOWN,altKey:!0,shiftKey:!0}}]};let c,l,d,u,h;function m(e,t,s){var n,i,o,a,r,c,l,d;if(void 0!==t.key)if(e.shiftKey){if(e.key.toLowerCase()!==t.key.toLowerCase())return!1}else if(e.key!==t.key)return!1;const u=null!==(n=t.ctrlKey)&&void 0!==n&&n,h=null!==(i=t.altKey)&&void 0!==i&&i,m=null!==(o=t.shiftKey)&&void 0!==o&&o,p=null!==(a=t.metaKey)&&void 0!==a&&a,g=null!==(r=e.ctrlKey)&&void 0!==r&&r,v=null!==(c=e.altKey)&&void 0!==c&&c,f=null!==(l=e.shiftKey)&&void 0!==l&&l,b=null!==(d=e.metaKey)&&void 0!==d&&d;if(t.ctrlOrCmd){if(s){if(!b||g!==u||v!==h||f!==m)return!1}else if(!g||b!==p||v!==h||f!==m)return!1;return!0}return b===p&&g===u&&v===h&&f===m}!function(e){e.Send="Send",e.SelectPrevSendHistory="SelectPrevSendHistory",e.SelectNextSendHistory="SelectNextSendHistory",e.EditPrevMessage="EditPrevMessage",e.EditNextMessage="EditNextMessage",e.CancelEditing="CancelEditing",e.FormatBold="FormatBold",e.FormatItalics="FormatItalics",e.FormatQuote="FormatQuote",e.EditUndo="EditUndo",e.EditRedo="EditRedo",e.NewLine="NewLine",e.MoveCursorToStart="MoveCursorToStart",e.MoveCursorToEnd="MoveCursorToEnd"}(c||(c={})),function(e){e.CompleteOrPrevSelection="ApplySelection",e.CompleteOrNextSelection="CompleteOrNextSelection",e.PrevSelection="PrevSelection",e.NextSelection="NextSelection",e.Cancel="Cancel"}(l||(l={})),function(e){e.ClearSearch="ClearSearch",e.PrevRoom="PrevRoom",e.NextRoom="NextRoom",e.SelectRoom="SelectRoom",e.CollapseSection="CollapseSection",e.ExpandSection="ExpandSection"}(d||(d={})),function(e){e.ScrollUp="ScrollUp",e.RoomScrollDown="RoomScrollDown",e.DismissReadMarker="DismissReadMarker",e.JumpToOldestUnread="JumpToOldestUnread",e.UploadFile="UploadFile",e.FocusSearch="FocusSearch",e.JumpToFirstMessage="JumpToFirstMessage",e.JumpToLatestMessage="JumpToLatestMessage"}(u||(u={})),function(e){e.FocusRoomSearch="FocusRoomSearch",e.ToggleRoomSidePanel="ToggleRoomSidePanel",e.ToggleUserMenu="ToggleUserMenu",e.ToggleShortCutDialog="ToggleShortCutDialog",e.GoToHome="GoToHome",e.SelectPrevRoom="SelectPrevRoom",e.SelectNextRoom="SelectNextRoom",e.SelectPrevUnreadRoom="SelectPrevUnreadRoom",e.SelectNextUnreadRoom="SelectNextUnreadRoom"}(h||(h={}));const p=new class{constructor(){i()(this,"bindingsProviders",[r])}getAction(e,t){for(const s of e){const e=s().find(e=>m(t,e.keyCombo,o.b));if(e)return e.action}}getMessageComposerAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getMessageComposerBindings),e)}getAutocompleteAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getAutocompleteBindings),e)}getRoomListAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getRoomListBindings),e)}getRoomAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getRoomBindings),e)}getNavigationAction(e){return this.getAction(this.bindingsProviders.map(e=>e.getNavigationBindings),e)}};function g(){return p}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v})),s.d(t,"b",(function(){return f}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(147),u=s.n(d),h=s(101),m=s.n(h),p=s(93),g=s(154);let v;!function(e){e[e.Natural=0]="Natural",e[e.Left=1]="Left",e[e.Right=2]="Right",e[e.Top=3]="Top",e[e.Bottom=4]="Bottom"}(v||(v={}));let f=Object(p.a)("views.elements.Tooltip")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"tooltipContainer",void 0),r()(this,"tooltip",void 0),r()(this,"parent",void 0),r()(this,"renderTooltip",()=>{const e=this.updatePosition({});e.display=this.props.visible?"block":"none";const t=m()("mx_Tooltip",this.props.tooltipClassName,{mx_Tooltip_visible:this.props.visible,mx_Tooltip_invisible:!this.props.visible}),s=l.a.createElement("div",{className:t,style:e},l.a.createElement("div",{className:"mx_Tooltip_chevron"}),this.props.label);this.tooltip=u.a.render(s,this.tooltipContainer)})}componentDidMount(){this.tooltipContainer=document.createElement("div"),this.tooltipContainer.className="mx_Tooltip_wrapper",document.body.appendChild(this.tooltipContainer),window.addEventListener("scroll",this.renderTooltip,{passive:!0,capture:!0}),this.parent=u.a.findDOMNode(this).parentNode,this.renderTooltip()}componentDidUpdate(){this.renderTooltip()}componentWillUnmount(){u.a.unmountComponentAtNode(this.tooltipContainer),document.body.removeChild(this.tooltipContainer),window.removeEventListener("scroll",this.renderTooltip,{capture:!0})}updatePosition(e){const t=this.parent.getBoundingClientRect();let s=0;s=t.height>25?Math.floor((t.height-25)/2):Math.floor(t.height-25);const n=g.b.instance.windowWidth,i=t.top-2+this.props.yOffset+window.pageYOffset,o=i+s,a=n-t.right-window.pageXOffset-16,r=t.right+window.pageXOffset+6,c=t.right-window.pageXOffset-t.width/2;switch(this.props.alignment){case v.Natural:if(t.right>n/2){e.right=a,e.top=o;break}case v.Right:e.left=r,e.top=o;break;case v.Left:e.right=a,e.top=o;break;case v.Top:e.top=i-16,e.left=c;break;case v.Bottom:e.top=i+t.height,e.left=c}return e}render(){return l.a.createElement("div",{className:this.props.className})}},r()(i,"Alignment",v),r()(i,"defaultProps",{visible:!0,yOffset:0,alignment:v.Natural}),n=o))||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i})),s.d(t,"c",(function(){return o}));function n(e){return a(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789")}function i(e){return a(e,"abcdefghijklmnopqrstuvwxyz")}function o(e){return a(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZ")}function a(e,t){let s="";for(let n=0;n<e;++n)s+=t.charAt(Math.floor(Math.random()*t.length));return s}},function(e,t,s){"use strict";var n=s(91),i=s(155);const o=Object(n.createContext)({roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!1,numUnreadMessages:0,draggingFile:!1,searching:!1,guestsCanJoin:!1,canPeek:!1,showApps:!1,isPeeking:!1,showRightPanel:!0,joining:!1,atEndOfLiveTimeline:!0,atEndOfLiveTimelineInit:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canReply:!1,layout:i.a.Group,singleSideBubbles:!1,adaptiveSideBubbles:!1,lowBandwidth:!1,showReadReceipts:!0,showRedactions:!0,showJoinLeaves:!0,showAvatarChanges:!0,showDisplaynameChanges:!0,matrixClientIsReady:!1,dragCounter:0});o.displayName="RoomContext",t.a=o},function(e,t,s){"use strict";s.d(t,"a",(function(){return u})),s.d(t,"e",(function(){return h})),s.d(t,"b",(function(){return m})),s.d(t,"c",(function(){return p})),s.d(t,"d",(function(){return g}));var n=s(94),i=s(92),o=s(99),a=s(135),r=s(91),c=s.n(r),l=s(96),d=s(133);let u;function h(e){const t={[u.Invite]:[],[u.Join]:[],[u.Leave]:[]};for(const s of e)t[m(s.getMyMembership())].push(s);return t}function m(e){return"invite"===e?u.Invite:"join"===e?u.Join:u.Leave}function p(e){const t=m(e);return t===u.Join||t===u.Invite}async function g(e){let t=!0;const s=await n.a.get().getRoomUpgradeHistory(e);if(s&&s.length>0){s[s.length-1].roomId!==e&&(t=!1)}let r={};if(t)r=await n.a.get().leaveRoomChain(e);else try{await n.a.get().leave(e)}catch(t){if(t&&t.data&&t.data.errcode){const s=t.data.error||Object(i.a)("Unexpected server error trying to leave the room");r[e]=Object.assign(new Error(s),{errcode:t.data.errcode})}else r[e]=t||new Error("Failed to leave room for unknown causes")}const u=Object.entries(r).filter(e=>!!e[1]);if(u.length>0){const t=[];for(const s of u){const n=s[1];let l=Object(i.a)("Unexpected server error trying to leave the room");if(n.errcode&&n.message){if("M_CANNOT_LEAVE_SERVER_NOTICE_ROOM"===n.errcode)return void o.a.createTrackedDialog("Error Leaving Room","",a.a,{title:Object(i.a)("Can't leave Server Notices room"),description:Object(i.a)("This room is used for important messages from the Homeserver, so you cannot leave it.")});l=r[e].message}t.push(l,c.a.createElement("BR"))}o.a.createTrackedDialog("Error Leaving Room","",a.a,{title:Object(i.a)("Error leaving room"),description:t})}else d.a.getRoomId()===e&&l.a.dispatch({action:"view_home_page"})}!function(e){e.Join="JOIN",e.Invite="INVITE",e.Leave="LEAVE"}(u||(u={}))},,function(e,t,s){"use strict";s.d(t,"c",(function(){return f})),s.d(t,"a",(function(){return b})),s.d(t,"b",(function(){return y})),s.d(t,"d",(function(){return _}));var n=s(18),i=s.n(n),o=s(98),a=s(217),r=s(161),c=s(9),l=s(96),d=s(489),u=s(106),h=s(121),m=s(123),p=s(142);function g(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function v(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?g(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):g(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const f="io.element.widgets.layout";let b;!function(e){e.Top="top",e.Right="right"}(b||(b={}));const y=3;class _ extends d.a{constructor(){super(l.a),i()(this,"byRoom",{}),i()(this,"pinnedRef",void 0),i()(this,"layoutRef",void 0),i()(this,"updateAllRooms",()=>{this.byRoom={};for(const e of this.matrixClient.getVisibleRooms())this.recalculateRoom(e)}),i()(this,"updateFromWidgetStore",e=>{if(e){const t=this.matrixClient.getRoom(e);t&&this.recalculateRoom(t)}else this.updateAllRooms()}),i()(this,"updateRoomFromState",e=>{if(e.getType()!==f)return;const t=this.matrixClient.getRoom(e.getRoomId());t&&this.recalculateRoom(t)}),i()(this,"updateFromSettings",(e,t)=>{if(t){const e=this.matrixClient.getRoom(t);e&&this.recalculateRoom(e)}else this.updateAllRooms()})}static get instance(){return _.internalInstance||(_.internalInstance=new _),_.internalInstance}static emissionForRoom(e){return"update_"+e.roomId}emitFor(e){this.emit(_.emissionForRoom(e))}async onReady(){this.updateAllRooms(),this.matrixClient.on("RoomState.events",this.updateRoomFromState),this.pinnedRef=o.b.watchSetting("Widgets.pinned",null,this.updateFromSettings),this.layoutRef=o.b.watchSetting("Widgets.layout",null,this.updateFromSettings),a.a.instance.on(m.b,this.updateFromWidgetStore)}async onNotReady(){this.byRoom={},o.b.unwatchSetting(this.pinnedRef),o.b.unwatchSetting(this.layoutRef),a.a.instance.off(m.b,this.updateFromWidgetStore)}recalculateRoom(e){const t=a.a.instance.getApps(e.roomId);if(null==t||!t.length)return this.byRoom[e.roomId]={},void this.emitFor(e);const s=JSON.stringify(this.byRoom[e.roomId]),n=e.currentState.getStateEvents(f,""),i=o.b.getValue("Widgets.pinned",e.roomId);let l=o.b.getValue("Widgets.layout",e.roomId);n&&l&&l.overrides!==n.getId()&&(l=null);const d=n?n.getContent():null,u=[],h=[];for(const e of t){var m,g,v,_,E;const t=null==d||null===(m=d.widgets)||void 0===m||null===(g=m[e.id])||void 0===g?void 0:g.container,s=null===(v=l)||void 0===v||null===(_=v.widgets)||void 0===_||null===(E=_[e.id])||void 0===E?void 0:E.container,n=!(null==i||!i[e.id]),o=r.a.JITSI.matches(e.type)?b.Top:b.Right;s===b.Right?h.push(e):s===b.Top||t===b.Top||n&&!t?u.push(e):(o===b.Top?u:h).push(e)}const S=u.slice(y);h.push(...S),u.sort((e,t)=>{var s,n,i,o,a,u;const h=null==d||null===(s=d.widgets)||void 0===s?void 0:s[e.id],m=null==d||null===(n=d.widgets)||void 0===n?void 0:n[t.id],g=null===(i=l)||void 0===i||null===(o=i.widgets)||void 0===o?void 0:o[e.id],v=null===(a=l)||void 0===a||null===(u=a.widgets)||void 0===u?void 0:u[t.id],f=r.a.JITSI.matches(e.type)?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,b=r.a.JITSI.matches(t.type)?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,y=Object(c.b)(null==g?void 0:g.index,Object(c.b)(null==h?void 0:h.index,f)),_=Object(c.b)(null==v?void 0:v.index,Object(c.b)(null==m?void 0:m.index,b));return y===_?Object(p.a)(e.id,t.id):y-_});const w=[];let C=null,k=!0;for(let e=0;e<u.length;e++){var O,R,I;const t=u[e],s=null==d||null===(O=d.widgets)||void 0===O?void 0:O[t.id],n=null===(R=l)||void 0===R||null===(I=R.widgets)||void 0===I?void 0:I[t.id];if(Number.isFinite(null==n?void 0:n.width)||Number.isFinite(null==s?void 0:s.width)){const e=(null==n?void 0:n.width)||(null==s?void 0:s.width),t=Object(c.a)(e,10,100);w.push(t),k=!1}else w.push(100);if(null!=s&&s.height||null!=n&&n.height){const e=Object(c.b)(null==s?void 0:s.height,2),t=Object(c.b)(null==n?void 0:n.height,e);C=Math.max(C,Object(c.a)(t,2,100))}}if(k)for(let e=0;e<w.length;e++)w[e]=100/w.length;else{const e=Object(c.e)(...w)-100;if(e<0)for(let t=0;t<w.length;t++)w[t]+=Math.abs(e)/w.length;else if(e>0){for(let t=0;t<w.length;t++)w[t]=Object(c.a)(w[t]-e/w.length,10,100);const t=Object(c.e)(...w)-100;if(t>0){const e=w.map((e,t)=>[t,e]).filter(e=>e[1]>10).map(e=>e[0]);for(const s of e)w[s]-=t/e.length}}}this.byRoom[e.roomId]={},u.length&&(this.byRoom[e.roomId][b.Top]={ordered:u,distributions:w,height:C}),h.length&&(this.byRoom[e.roomId][b.Right]={ordered:h});JSON.stringify(this.byRoom[e.roomId])!==s&&this.emitFor(e)}getContainerWidgets(e,t){var s,n;return(null===(s=this.byRoom[null==e?void 0:e.roomId])||void 0===s||null===(n=s[t])||void 0===n?void 0:n.ordered)||[]}isInContainer(e,t,s){return this.getContainerWidgets(e,s).some(e=>e.id===t.id)}canAddToContainer(e,t){return this.getContainerWidgets(e,t).length<y}getResizerDistributions(e,t){var s,n;let i=null===(s=this.byRoom[e.roomId])||void 0===s||null===(n=s[t])||void 0===n?void 0:n.distributions;return!i||i.length<2?[]:(2===i.length&&(i=[i[0]]),3===i.length&&(i=[i[0],i[2]]),i.map(e=>e.toFixed(1)+"%"))}setResizerDistributions(e,t,s){if(t!==b.Top)return;const n=s.map(e=>Number(Number(e.substring(0,e.length-1)).toFixed(1))),i=this.getContainerWidgets(e,t),o=100-Object(c.e)(...n);2===n.length&&n.splice(1,0,o),1===n.length&&n.push(o);const a={};i.forEach((s,i)=>{var o,r;a[s.id]={container:t,width:n[i],index:i,height:(null===(o=this.byRoom[e.roomId])||void 0===o||null===(r=o[t])||void 0===r?void 0:r.height)||2}}),this.updateUserLayout(e,a)}getContainerHeight(e,t){var s,n;return null===(s=this.byRoom[e.roomId])||void 0===s||null===(n=s[t])||void 0===n?void 0:n.height}setContainerHeight(e,t,s){var n,i;const o=this.getContainerWidgets(e,t),a=null===(n=this.byRoom[e.roomId])||void 0===n||null===(i=n[t])||void 0===i?void 0:i.distributions,r={};o.forEach((e,n)=>{r[e.id]={container:t,width:a[n],index:n,height:s}}),this.updateUserLayout(e,r)}moveWithinContainer(e,t,s,n){var i,o,a,r;const l=Object(h.b)(this.getContainerWidgets(e,t)),d=l.findIndex(e=>e.id===s.id);if(d<0)return;l.splice(d,1);const u=Object(c.a)(d+n,0,l.length);l.splice(u,0,s);const m=null===(i=this.byRoom[e.roomId])||void 0===i||null===(o=i[t])||void 0===o?void 0:o.distributions,p=null===(a=this.byRoom[e.roomId])||void 0===a||null===(r=a[t])||void 0===r?void 0:r.height,g={};l.forEach((e,s)=>{g[e.id]={container:t,width:m[s],index:s,height:p}}),this.updateUserLayout(e,g)}moveToContainer(e,t,s){this.getAllWidgets(e).some(([e])=>e.id===t.id)&&this.updateUserLayout(e,{[t.id]:{container:s}})}canCopyLayoutToRoom(e){return!!this.matrixClient&&e.currentState.maySendStateEvent(f,this.matrixClient.getUserId())}copyLayoutToRoom(e){const t=this.getAllWidgets(e),s={widgets:{}};for(const[r,c]of t)if(s.widgets[r.id]={container:c},c===b.Top){var n,i,o,a;const t=this.getContainerWidgets(e,c).findIndex(e=>e.id===r.id),l=null===(n=this.byRoom[e.roomId])||void 0===n||null===(i=n[c])||void 0===i?void 0:i.distributions,d=null===(o=this.byRoom[e.roomId])||void 0===o||null===(a=o[c])||void 0===a?void 0:a.height;s.widgets[r.id]=v(v({},s.widgets[r.id]),{},{height:d?Math.round(d):null,width:l[t]?Math.round(l[t]):null,index:t})}this.matrixClient.sendStateEvent(e.roomId,f,s,"")}getAllWidgets(e){const t=this.byRoom[e.roomId];if(!t)return[];const s=[];for(const e of Object.keys(t)){const n=t[e].ordered;for(const t of n)s.push([t,e])}return s}updateUserLayout(e,t){const s=this.getAllWidgets(e);for(const[o,c]of s){var n,i;const s=this.getContainerWidgets(e,c).findIndex(e=>e.id===o.id),l=null===(n=this.byRoom[e.roomId])||void 0===n||null===(i=n[c])||void 0===i?void 0:i.distributions;var a,r;if(!t[o.id])t[o.id]={container:c,index:s,height:null===(a=this.byRoom[e.roomId])||void 0===a||null===(r=a[c])||void 0===r?void 0:r.height,width:null==l?void 0:l[s]}}const c=e.currentState.getStateEvents(f,"");o.b.setValue("Widgets.layout",e.roomId,u.a.ROOM_ACCOUNT,{overrides:null==c?void 0:c.getId(),widgets:t}).catch(()=>this.recalculateRoom(e)),this.recalculateRoom(e)}}i()(_,"internalInstance",void 0),window.mxWidgetLayoutStore=_.instance},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(131);t.a=({room:e,children:t})=>{const[s,a]=Object(n.useState)(null==e?void 0:e.name);return Object(o.a)(e,"Room.name",()=>{a(null==e?void 0:e.name)}),Object(n.useEffect)(()=>{a(null==e?void 0:e.name)},[e]),t?t(s):i.a.createElement(i.a.Fragment,null,s||"")}},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(92),m=s(93);let p=Object(m.a)("views.elements.DialogButtons")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"_onCancelClick",()=>{this.props.onCancel()})}render(){let e,t="mx_Dialog_primary";this.props.primaryButtonClass&&(t+=" "+this.props.primaryButtonClass),(this.props.cancelButton||this.props.hasCancel)&&(e=l.a.createElement("button",{type:"button",onClick:this._onCancelClick,className:this.props.cancelButtonClass,disabled:this.props.disabled},this.props.cancelButton||Object(h.a)("Cancel")));let s=null;return this.props.additive&&(s=l.a.createElement("div",{className:"mx_Dialog_buttons_additive"},this.props.additive)),l.a.createElement("div",{className:"mx_Dialog_buttons"},s,e,this.props.children,l.a.createElement("button",{type:this.props.primaryIsSubmit?"submit":"button",className:t,onClick:this.props.onPrimaryButtonClick,autoFocus:this.props.focus,disabled:this.props.disabled||this.props.primaryDisabled},this.props.primaryButton))}},r()(i,"propTypes",{primaryButton:u.a.node.isRequired,cancelButton:u.a.node,primaryIsSubmit:u.a.bool,onPrimaryButtonClick:u.a.func,hasCancel:u.a.bool,cancelButtonClass:u.a.node,onCancel:u.a.func,focus:u.a.bool,disabled:u.a.bool,primaryDisabled:u.a.bool,additive:u.a.element}),r()(i,"defaultProps",{hasCancel:!0,disabled:!1}),n=o))||n},,function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"c",(function(){return r})),s.d(t,"d",(function(){return l})),s.d(t,"e",(function(){return d})),s.d(t,"b",(function(){return u}));var n=s(127),i=s(107),o=s(98);function a(e,t,s,n){let o;return null!=e&&e.getMxcAvatarUrl()&&(o=Object(i.b)(e.getMxcAvatarUrl()).getThumbnailOfSourceHttp(t,s,n)),o||(o=l(e?e.userId:"")),o}function r(e,t,s,n){return e.avatarUrl?Object(i.b)(e.avatarUrl).getThumbnailOfSourceHttp(t,s,n):null}const c=new Map;function l(e){if(!e)return"";const t=["#8BC34A","#368bd6","#ac3ba8"];let s=0;for(let t=0;t<e.length;++t)s+=e.charCodeAt(t);const n=s%t.length,i="--avatar-background-colors_"+n,o=document.body.style.getPropertyValue(i)||t[n];let a=c.get(o);return a||(!function(e){return"string"==typeof e&&(7===e.length||9===e.length)&&"#"===e.charAt(0)&&!e.substr(1).split("").some(e=>isNaN(parseInt(e,16)))}(o)?a="":(a=function(e){const t=document.createElement("canvas");t.width=40,t.height=40;const s=t.getContext("2d");return s?(s.fillStyle=e,s.fillRect(0,0,40,40),t.toDataURL()):""}(o),c.set(o,a))),a}function d(e){if(!e)return void console.trace("`name` argument to `getInitialLetter` not supplied");if(e.length<1)return;let t=0;const s=e[0];"@"!==s&&"#"!==s&&"+"!==s||!e[1]||t++;let n=1;const i=e.charCodeAt(t);if(i>=55296&&i<=56319&&e[t+1]){const s=e.charCodeAt(t+1);s>=56320&&s<=57343&&n++}return e.substring(t,t+n).toUpperCase()}function u(e,t,s,a){var r;if(!e)return null;if(e.getMxcAvatarUrl())return Object(i.b)(e.getMxcAvatarUrl()).getThumbnailOfSourceHttp(t,s,a);if(o.b.getValue("feature_spaces")&&e.isSpaceRoom())return null;let c=null;const l=n.a.shared().getUserIdForRoomId(e.roomId);return c=l?e.getMember(l):e.getAvatarFallbackMember(),null!==(r=c)&&void 0!==r&&r.getMxcAvatarUrl()?Object(i.b)(c.getMxcAvatarUrl()).getThumbnailOfSourceHttp(t,s,a):null}},function(e,t,s){"use strict";s.d(t,"a",(function(){return K})),s.d(t,"b",(function(){return q}));var n,i,o,a=s(18),r=s.n(a),c=s(104),l=s.n(c),d=s(91),u=s.n(d),h=s(101),m=s.n(h),p=s(110),g=s(114),v=s(234),f=s(92),b=s(309),y=s(95),_=s(96),E=s(98),S=s(155),w=s(150),C=s(94),k=s(349),O=s(105),R=s(206),I=s(298),x=s(161),T=s(129),j=s(190),N=s(141),P=s(93),D=s(185),A=s(247),M=s(180),U=s(103);const L={[p.a.RoomMessage]:"messages.MessageEvent",[p.a.Sticker]:"messages.MessageEvent",[p.a.KeyVerificationCancel]:"messages.MKeyVerificationConclusion",[p.a.KeyVerificationDone]:"messages.MKeyVerificationConclusion",[p.a.CallInvite]:"messages.TextualEvent",[p.a.CallAnswer]:"messages.TextualEvent",[p.a.CallHangup]:"messages.TextualEvent",[p.a.CallReject]:"messages.TextualEvent"},F={[p.a.RoomEncryption]:"messages.EncryptionEvent",[p.a.RoomCanonicalAlias]:"messages.TextualEvent",[p.a.RoomCreate]:"messages.RoomCreate",[p.a.RoomMember]:"messages.TextualEvent",[p.a.RoomName]:"messages.TextualEvent",[p.a.RoomAvatar]:"messages.RoomAvatarEvent",[p.a.RoomThirdPartyInvite]:"messages.TextualEvent",[p.a.RoomHistoryVisibility]:"messages.TextualEvent",[p.a.RoomTopic]:"messages.TextualEvent",[p.a.RoomPowerLevels]:"messages.TextualEvent",[p.a.RoomPinnedEvents]:"messages.TextualEvent",[p.a.RoomServerAcl]:"messages.TextualEvent","im.vector.modular.widgets":"messages.TextualEvent",[j.c]:"messages.TextualEvent",[p.a.RoomTombstone]:"messages.TextualEvent",[p.a.RoomJoinRules]:"messages.TextualEvent",[p.a.RoomGuestAccess]:"messages.TextualEvent","m.room.related_groups":"messages.TextualEvent"},B=new Set([p.a.RoomEncryption,p.a.RoomCanonicalAlias,p.a.RoomCreate,p.a.RoomName,p.a.RoomAvatar,p.a.RoomHistoryVisibility,p.a.RoomTopic,p.a.RoomPowerLevels,p.a.RoomPinnedEvents,p.a.RoomServerAcl,j.c,p.a.RoomTombstone,p.a.RoomJoinRules,p.a.RoomGuestAccess,"m.room.related_groups"]);for(const e of k.a)F[e]="messages.TextualEvent";function V(e){const t=e.getType();if("m.room.message"===t){const t=e.getContent();if(t&&"m.key.verification.request"===t.msgtype){const s=C.a.get(),n=s&&s.getUserId();return e.getSender()!==n&&t.to!==n?void 0:"messages.MKeyVerificationRequest"}}if("m.key.verification.done"===t){const t=C.a.get(),s=t&&t.getUserId();if(e.getSender()!==s)return}if("m.key.verification.cancel"===t||"m.key.verification.done"===t){if(!y.getComponent("messages.MKeyVerificationConclusion").prototype._shouldRender.call(null,e,e.request))return}if("im.vector.modular.widgets"===t){let t=e.getContent().type;if(t||(t=e.getPrevContent().type),x.a.JITSI.matches(t))return"messages.MJitsiWidgetEvent"}if(e.isState()){if(B.has(t)&&""!==e.getStateKey())return;return F[t]}return L[t]}let K=Object(P.a)("views.rooms.EventTile")((o=i=class extends u.a.Component{constructor(e,t){super(e,t),r()(this,"suppressReadReceiptAnimation",void 0),r()(this,"isListeningForReceipts",void 0),r()(this,"ref",void 0),r()(this,"tile",u.a.createRef()),r()(this,"replyThread",u.a.createRef()),r()(this,"onRoomReceipt",(e,t)=>{t===C.a.get().getRoom(this.props.mxEvent.getRoomId())&&(this.shouldShowSentReceipt||this.shouldShowSendingReceipt||this.isListeningForReceipts)&&this.forceUpdate(()=>{this.shouldShowSentReceipt||this.shouldShowSendingReceipt||(this.context.removeListener("Room.receipt",this.onRoomReceipt),this.isListeningForReceipts=!1)})}),r()(this,"onDecrypted",()=>{this.verifyEvent(this.props.mxEvent),this.forceUpdate()}),r()(this,"onDeviceVerificationChanged",(e,t)=>{e===this.props.mxEvent.getSender()&&this.verifyEvent(this.props.mxEvent)}),r()(this,"onUserVerificationChanged",(e,t)=>{e===this.props.mxEvent.getSender()&&this.verifyEvent(this.props.mxEvent)}),r()(this,"toggleAllReadAvatars",()=>{this.setState({allReadAvatars:!this.state.allReadAvatars})}),r()(this,"onSenderProfileClick",e=>{const t=this.props.mxEvent;_.a.dispatch({action:U.a.ComposerInsert,userId:t.getSender()})}),r()(this,"onRequestKeysClick",()=>{this.setState({previouslyRequestedKeys:!0}),this.context.cancelAndResendEventRoomKeyRequest(this.props.mxEvent)}),r()(this,"onPermalinkClicked",e=>{e.preventDefault(),_.a.dispatch({action:"view_room",event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId()})}),r()(this,"onActionBarFocusChange",e=>{this.setState({actionBarFocused:e})}),r()(this,"getTile",()=>this.tile.current),r()(this,"getReplyThread",()=>this.replyThread.current),r()(this,"getReactions",()=>{if(!this.props.showReactions||!this.props.getRelationsForEvent)return null;const e=this.props.mxEvent.getId();return this.props.getRelationsForEvent(e,"m.annotation","m.reaction")}),r()(this,"onReactionsCreated",(e,t)=>{"m.annotation"===e&&"m.reaction"===t&&(this.props.mxEvent.removeListener("Event.relationsCreated",this.onReactionsCreated),this.setState({reactions:this.getReactions()}))}),this.state={actionBarFocused:!1,allReadAvatars:!1,verified:null,previouslyRequestedKeys:!1,reactions:this.getReactions(),hover:!1},this.suppressReadReceiptAnimation=!0,this.isListeningForReceipts=!1,this.ref=u.a.createRef()}get isEligibleForSpecialReceipt(){if(this.props.readReceipts&&this.props.readReceipts.length>0)return!1;if(!this.props.mxEvent)return!1;if(!this.context.getRoom(this.props.mxEvent.getRoomId()))return!1;const e=C.a.get().getUserId();if(this.props.mxEvent.getSender()!==e)return!1;return!![p.a.Sticker,p.a.RoomMessage,p.a.RoomMessageEncrypted].includes(this.props.mxEvent.getType())}get shouldShowSentReceipt(){if(!this.isEligibleForSpecialReceipt)return!1;if(!this.props.lastSuccessful)return!1;if(this.props.eventSendStatus&&"sent"!==this.props.eventSendStatus)return!1;const e=this.props.readReceipts||[],t=C.a.get().getUserId();return!e.some(e=>e.userId!==t)}get shouldShowSendingReceipt(){return!!this.isEligibleForSpecialReceipt&&!(!this.props.eventSendStatus||"sent"===this.props.eventSendStatus)}UNSAFE_componentWillMount(){this.verifyEvent(this.props.mxEvent)}componentDidMount(){this.suppressReadReceiptAnimation=!1;const e=this.context;e.on("deviceVerificationChanged",this.onDeviceVerificationChanged),e.on("userTrustStatusChanged",this.onUserVerificationChanged),this.props.mxEvent.on("Event.decrypted",this.onDecrypted),this.props.showReactions&&this.props.mxEvent.on("Event.relationsCreated",this.onReactionsCreated),(this.shouldShowSentReceipt||this.shouldShowSendingReceipt)&&(e.on("Room.receipt",this.onRoomReceipt),this.isListeningForReceipts=!0)}UNSAFE_componentWillReceiveProps(e){e.eventSendStatus!==this.props.eventSendStatus&&this.verifyEvent(e.mxEvent)}shouldComponentUpdate(e,t){return!!Object(N.d)(this.state,t)||!this.propsEqual(this.props,e)}componentWillUnmount(){const e=this.context;e.removeListener("deviceVerificationChanged",this.onDeviceVerificationChanged),e.removeListener("userTrustStatusChanged",this.onUserVerificationChanged),e.removeListener("Room.receipt",this.onRoomReceipt),this.isListeningForReceipts=!1,this.props.mxEvent.removeListener("Event.decrypted",this.onDecrypted),this.props.showReactions&&this.props.mxEvent.removeListener("Event.relationsCreated",this.onReactionsCreated)}componentDidUpdate(e,t,s){this.isListeningForReceipts||!this.shouldShowSentReceipt&&!this.shouldShowSendingReceipt||(this.context.on("Room.receipt",this.onRoomReceipt),this.isListeningForReceipts=!0)}async verifyEvent(e){if(!e.isEncrypted())return;const t=this.context.getEventEncryptionInfo(e),s=e.getSender(),n=this.context.checkUserTrust(s);if(t.mismatchedSender)return void this.setState({verified:R.a.WARNING},this.props.onHeightChanged);if(!n.isCrossSigningVerified())return void this.setState({verified:R.a.NORMAL},this.props.onHeightChanged);const i=t.sender&&this.context.checkDeviceTrust(s,t.sender.deviceId);i?i.isVerified()?t.authenticated?this.setState({verified:R.a.VERIFIED},this.props.onHeightChanged):this.setState({verified:R.a.UNAUTHENTICATED},this.props.onHeightChanged):this.setState({verified:R.a.WARNING},this.props.onHeightChanged):this.setState({verified:R.a.UNKNOWN},this.props.onHeightChanged)}propsEqual(e,t){const s=Object.keys(e),n=Object.keys(t);if(s.length!==n.length)return!1;for(let n=0;n<s.length;n++){const i=s[n];if(!t.hasOwnProperty(i))return!1;if("readReceipts"===i){const s=e[i],n=t[i];if(s===n)continue;if(!s||!n)return!1;if(s.length!==n.length)return!1;for(let e=0;e<s.length;e++){if(s[e].userId!==n[e].userId)return!1;if(s[e].roomMember!==n[e].roomMember)return!1}}else if(e[i]!==t[i])return!1}return!0}shouldHighlight(){const e=this.context.getPushActionsForEvent(this.props.mxEvent.replacingEvent()||this.props.mxEvent);if(!e||!e.tweaks)return!1;if(this.props.mxEvent.getSender()===this.context.credentials.userId)return!1;const t=this.context.getRoom(this.props.mxEvent.getRoomId());return(!t||2!==t.currentState.getJoinedMemberCount())&&e.tweaks.highlight}getReadAvatars(){if(this.shouldShowSentReceipt||this.shouldShowSendingReceipt)return u.a.createElement(X,{messageState:this.props.mxEvent.getAssociatedStatus()});if(!this.props.readReceipts||0===this.props.readReceipts.length)return u.a.createElement("span",{className:"mx_EventTile_readAvatars"});const e=y.getComponent("rooms.ReadReceiptMarker"),t=[];let s=0;const n=this.props.readReceipts;for(let i=0;i<n.length;++i){const o=n[i];let a=!0;(i<5||this.state.allReadAvatars)&&(a=!1),s=this.props.layout===S.a.Bubble?15*(a?4:i):-15*(a?4:i);const r=o.userId;let c;this.props.readReceiptMap&&(c=this.props.readReceiptMap[r],c||(c={},this.props.readReceiptMap[r]=c)),t.unshift(u.a.createElement(e,{key:r,member:o.roomMember,fallbackUserId:r,leftOffset:s,hidden:a,readReceiptInfo:c,checkUnmounting:this.props.checkUnmounting,suppressAnimation:this.suppressReadReceiptAnimation,onClick:this.toggleAllReadAvatars,timestamp:o.ts,showTwelveHour:this.props.isTwelveHour}))}let i;if(!this.state.allReadAvatars){const e=n.length-5;let t;t=this.props.layout===S.a.Bubble?{left:"calc("+Object(I.b)(s)+" + 15px)"}:{right:"calc("+Object(I.b)(-s)+" + 15px)"},e>0&&(i=u.a.createElement("span",{className:"mx_EventTile_readAvatarRemainder",onClick:this.toggleAllReadAvatars,style:t},e,"+"))}return u.a.createElement("span",{className:"mx_EventTile_readAvatars"},i,t)}renderE2EPadlock(){const e=this.props.mxEvent;if("m.bad.encrypted"===e.getContent().msgtype)return u.a.createElement(H,null);if(e.isEncrypted())return this.state.verified===R.a.NORMAL||this.state.verified===R.a.VERIFIED?void 0:this.state.verified===R.a.UNAUTHENTICATED?u.a.createElement(J,null):this.state.verified===R.a.UNKNOWN?u.a.createElement(Y,null):u.a.createElement($,null);if(this.context.isRoomEncrypted(e.getRoomId())){if(e.status===g.a.ENCRYPTING)return;if(e.status===g.a.NOT_SENT)return;if(e.isState())return;return u.a.createElement(z,null)}return null}render(){const e=y.getComponent("messages.MessageTimestamp"),t=y.getComponent("messages.SenderProfile"),s=y.getComponent("avatars.MemberAvatar"),n=this.props.mxEvent.getContent().msgtype,i=this.props.mxEvent.getType();let o=V(this.props.mxEvent),a=i.startsWith("m.key.verification")||i===p.a.RoomMessage&&n&&n.startsWith("m.key.verification")||i===p.a.RoomCreate||i===p.a.RoomEncryption||"messages.MJitsiWidgetEvent"===o,r=!a&&i!==p.a.RoomMessage&&i!==p.a.Sticker&&i!==p.a.RoomCreate;if(E.b.getValue("showHiddenEventsInTimeline")&&!q(this.props.mxEvent)&&(o="messages.ViewSourceEvent",a=!1,r=!0),!o){const{mxEvent:e}=this.props;return console.warn(`Event type not supported: type:${e.getType()} isState:${e.isState()}`),u.a.createElement("div",{className:"mx_EventTile mx_EventTile_info mx_MNoticeBody"},u.a.createElement("div",{className:"mx_EventTile_line"},Object(f.a)("This event could not be displayed")))}const c=y.getComponent(o),l=-1!==["sending","queued","encrypting"].indexOf(this.props.eventSendStatus),d=G(this.props.mxEvent)&&this.props.isRedacted,h=this.props.mxEvent.isDecryptionFailure(),g=C.a.get(),b=g&&g.getUserId(),_=this.props.layout==S.a.Bubble&&"reply_preview"!==this.props.tileShape&&"reply"!==this.props.tileShape&&"notif"!==this.props.tileShape&&"file_grid"!==this.props.tileShape,k=b===this.props.mxEvent.getSender(),O=k&&!this.props.singleSideBubbles,I=!k||this.props.singleSideBubbles,x=!!this.props.editState,j=m()({mx_EventTile_bubbleContainer:a&&this.props.layout!=S.a.Bubble,mx_EventTile:!0,mx_EventTile_isEditing:x,mx_EventTile_info:r&&this.props.layout!==S.a.Bubble,mx_EventTile_12hr:this.props.isTwelveHour,mx_EventTile_sending:!x&&l,mx_EventTile_highlight:"notif"!==this.props.tileShape&&this.shouldHighlight(),mx_EventTile_selected:this.props.isSelectedEvent,mx_EventTile_continuation:!r&&!a&&(this.props.tileShape?"":this.props.continuation),mx_EventTile_last:this.props.last,mx_EventTile_lastInSection:this.props.lastInSection,mx_EventTile_contextual:this.props.contextual,mx_EventTile_actionBarFocused:this.state.actionBarFocused,mx_EventTile_verified:!a&&this.state.verified===R.a.VERIFIED,mx_EventTile_unverified:!a&&this.state.verified===R.a.WARNING,mx_EventTile_unknown:!a&&this.state.verified===R.a.UNKNOWN,mx_EventTile_bad:h,mx_EventTile_emote:"m.emote"===n,sc_EventTile_bubbleContainer:_}),N=null!==this.props.eventSendStatus?"off":void 0;let P="#";this.props.permalinkCreator&&(P=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const D=this.props.mxEvent.status?void 0:this.props.mxEvent.getId();let A,M,U,L;if(!r&&_&&O?(U=0,L=!1):"notif"===this.props.tileShape?(U=24,L=!0):"messages.RoomCreate"===o||a?(U=0,L=!1):r?(U=14,L=!1):this.props.layout==S.a.IRC?(U=14,L=!0):this.props.continuation&&"file_grid"!==this.props.tileShape?(U=0,L=!1):(U=30,L=!0),this.props.mxEvent.sender&&U){let e;e=this.props.mxEvent.getContent().third_party_invite?this.props.mxEvent.target:this.props.mxEvent.sender,A=u.a.createElement("div",{className:"mx_EventTile_avatar"},u.a.createElement(s,{member:e,width:U,height:U,viewUserOnClick:!0}))}L&&(M=this.props.tileShape&&"reply"!==this.props.tileShape&&"reply_preview"!==this.props.tileShape?u.a.createElement(t,{mxEvent:this.props.mxEvent,enableFlair:this.props.enableFlair}):u.a.createElement(t,{onClick:this.onSenderProfileClick,mxEvent:this.props.mxEvent,enableFlair:this.props.enableFlair}));const F=y.getComponent("messages.MessageActionBar"),B=x?void 0:u.a.createElement(F,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,permalinkCreator:this.props.permalinkCreator,getTile:this.getTile,getReplyThread:this.getReplyThread,onFocusChange:this.onActionBarFocusChange}),K=this.props.mxEvent.getTs()&&(_||this.props.alwaysShowTimestamps||this.props.last||this.state.hover||this.state.actionBarFocused)?u.a.createElement(e,{showTwelveHour:this.props.isTwelveHour,ts:this.props.mxEvent.getTs()}):null,W=u.a.createElement("div",{className:"mx_EventTile_keyRequestInfo_tooltip_contents"},u.a.createElement("p",null,this.state.previouslyRequestedKeys?Object(f.a)("Your key share request has been sent - please check your other sessions for key share requests."):Object(f.a)("Key share requests are sent to your other sessions automatically. If you rejected or dismissed the key share request on your other sessions, click here to request the keys for this session again.")),u.a.createElement("p",null,Object(f.a)("If your other sessions do not have the key for this message you will not be able to decrypt them."))),H=this.state.previouslyRequestedKeys?Object(f.a)("Key request sent."):Object(f.a)("<requestLink>Re-request encryption keys</requestLink> from your other sessions.",{},{requestLink:e=>u.a.createElement("a",{onClick:this.onRequestKeysClick},e)}),$=y.getComponent("elements.TooltipButton"),z=h&&!d?u.a.createElement("div",{className:"mx_EventTile_keyRequestInfo"},u.a.createElement("span",{className:"mx_EventTile_keyRequestInfo_text"},H),u.a.createElement($,{helpText:W})):null;let Y;if(!d){const e=y.getComponent("messages.ReactionsRow");Y=u.a.createElement(e,{mxEvent:this.props.mxEvent,reactions:this.state.reactions})}const J=u.a.createElement("a",{className:"sc_LinkedTimestamp",href:P,onClick:this.onPermalinkClicked,"aria-label":Object(w.e)(new Date(this.props.mxEvent.getTs()),this.props.isTwelveHour)},K),Q=u.a.createElement("span",{className:"sc_PlaceholderTimestamp"},K),X=this.props.layout==S.a.IRC,Z=X?null:J,ee=X?J:null,te=!X&&!a&&this.renderE2EPadlock(),se=X&&!a&&this.renderE2EPadlock(),ne=m()("mx_EventTile_msgOption",{sc_readReceipts_empty:!(this.props.readReceipts&&0!==this.props.readReceipts.length||this.shouldShowSentReceipt||this.shouldShowSendingReceipt)});let ie;if(this.props.showReadReceipts){const e=this.getReadAvatars();ie=u.a.createElement("div",{className:ne},e)}switch(this.props.tileShape){case"notif":{const e=this.context.getRoom(this.props.mxEvent.getRoomId());return u.a.createElement(this.props.as||"li",{className:j,"aria-live":N,"aria-atomic":!0,"data-scroll-tokens":D},[u.a.createElement("div",{className:"mx_EventTile_roomName",key:"mx_EventTile_roomName"},u.a.createElement(T.a,{room:e,width:28,height:28}),u.a.createElement("a",{href:P,onClick:this.onPermalinkClicked},e?e.name:"")),u.a.createElement("div",{className:"mx_EventTile_senderDetails",key:"mx_EventTile_senderDetails"},A,u.a.createElement("a",{href:P,onClick:this.onPermalinkClicked},M,K)),u.a.createElement("div",{className:"mx_EventTile_line",key:"mx_EventTile_line"},u.a.createElement(c,{ref:this.tile,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,onHeightChanged:this.props.onHeightChanged}))])}case"file_grid":return u.a.createElement(this.props.as||"li",{className:j,"aria-live":N,"aria-atomic":!0,"data-scroll-tokens":D},[u.a.createElement("div",{className:"mx_EventTile_line",key:"mx_EventTile_line"},u.a.createElement(c,{ref:this.tile,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,tileShape:this.props.tileShape,onHeightChanged:this.props.onHeightChanged})),u.a.createElement("a",{className:"mx_EventTile_senderDetailsLink",key:"mx_EventTile_senderDetailsLink",href:P,onClick:this.onPermalinkClicked},u.a.createElement("div",{className:"mx_EventTile_senderDetails"},M,K))]);case"reply":case"reply_preview":{let e;return"reply_preview"===this.props.tileShape&&(e=v.a.makeThread(this.props.mxEvent,this.props.onHeightChanged,this.props.permalinkCreator,this.replyThread,null,this.props.alwaysShowTimestamps||this.state.hover)),u.a.createElement(this.props.as||"li",{className:j,"aria-live":N,"aria-atomic":!0,"data-scroll-tokens":D},[ee,A,M,se,u.a.createElement("div",{className:"mx_EventTile_reply",key:"mx_EventTile_reply"},Z,te,e,u.a.createElement(c,{ref:this.tile,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,replacingEventId:this.props.replacingEventId,showUrlPreview:!1,maxImageHeight:150}))])}default:{const e=v.a.makeThread(this.props.mxEvent,this.props.onHeightChanged,this.props.permalinkCreator,this.replyThread,this.props.layout,this.props.alwaysShowTimestamps||this.state.hover);if(_){const t=r||a,s=["m.image","m.video"],n=["m.sticker"];let i=!1,o=!1,l=!1;const d=this.props.mxEvent.getContent(),h=this.props.mxEvent.getType(),p=d.msgtype;p&&-1!=s.indexOf(p)&&(i=!0),h&&-1!=n.indexOf(h)&&(i=!0,o=!0),p&&"m.notice"==p&&(l=!0);const g=m()("mx_EventTile_line","sc_EventTile_bubbleLine",{sc_EventTile_bubbleLine_info:t}),v=m()("sc_EventTile_bubbleArea",{sc_EventTile_bubbleArea_right:!t&&O,sc_EventTile_bubbleArea_left:!t&&I,sc_EventTile_bubbleArea_center:t,sc_EventTile_bubbleArea_info:t}),f=m()({sc_EventTile_bubble:!i,sc_EventTile_bubble_media:i,sc_EventTile_bubble_info:t,sc_EventTile_bubble_self:!t&&k,sc_EventTile_bubble_right:!t&&O,sc_EventTile_bubble_left:!t&&I,sc_EventTile_bubble_center:t,sc_EventTile_bubble_tail:!t&&!this.props.continuation,sc_EventTile_bubble_notice:l,sc_EventTile_bubble_sticker:o});return u.a.createElement(this.props.as||"li",{ref:this.ref,className:j,tabIndex:-1,"aria-live":N,"aria-atomic":"true","data-scroll-tokens":D,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},[u.a.createElement("div",{className:g,key:"mx_EventTile_line"},te,u.a.createElement("div",{className:v},u.a.createElement("div",{className:f},M,e,t?A:null,u.a.createElement(c,{ref:this.tile,mxEvent:this.props.mxEvent,replacingEventId:this.props.replacingEventId,editState:this.props.editState,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,onHeightChanged:this.props.onHeightChanged,scBubble:!0,scBubbleActionBar:i?B:null,scBubbleGroupTimestamp:u.a.createElement(u.a.Fragment,null,Q,Z)}),i?null:B),z,Y)),t?null:A,ie])}return u.a.createElement(this.props.as||"li",{ref:this.ref,className:j,tabIndex:-1,"aria-live":N,"aria-atomic":"true","data-scroll-tokens":D,onMouseEnter:()=>this.setState({hover:!0}),onMouseLeave:()=>this.setState({hover:!1})},[ee,M,se,u.a.createElement("div",{className:"mx_EventTile_line",key:"mx_EventTile_line"},Z,te,e,u.a.createElement(c,{ref:this.tile,mxEvent:this.props.mxEvent,replacingEventId:this.props.replacingEventId,editState:this.props.editState,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,permalinkCreator:this.props.permalinkCreator,onHeightChanged:this.props.onHeightChanged}),z,Y,B),ie,A])}}}},r()(i,"defaultProps",{onHeightChanged:function(){}}),r()(i,"contextType",O.a),n=o))||n;const W=["m.room.message","m.sticker"];function G(e){return W.includes(e.getType())}function q(e){if(e.isRedacted()&&!G(e))return!1;if(e.isRelation("m.replace"))return!1;const t=V(e);return void 0!==t&&("messages.TextualEvent"===t?Object(b.a)(e):"messages.RoomCreate"!==t||Boolean(e.getContent().predecessor))}function H(e){return u.a.createElement(Q,l()({title:Object(f.a)("This message cannot be decrypted"),icon:"undecryptable"},e))}function $(e){return u.a.createElement(Q,l()({title:Object(f.a)("Encrypted by an unverified session"),icon:"unverified"},e))}function z(e){return u.a.createElement(Q,l()({title:Object(f.a)("Unencrypted"),icon:"unencrypted"},e))}function Y(e){return u.a.createElement(Q,l()({title:Object(f.a)("Encrypted by a deleted session"),icon:"unknown"},e))}function J(e){return u.a.createElement(Q,l()({title:Object(f.a)("The authenticity of this encrypted message can't be guaranteed on this device."),icon:"unauthenticated"},e))}class Q extends u.a.Component{constructor(e){super(e),r()(this,"onHoverStart",()=>{this.setState({hover:!0})}),r()(this,"onHoverEnd",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){let e=null;this.state.hover&&(e=u.a.createElement(D.b,{className:"mx_EventTile_e2eIcon_tooltip",label:this.props.title}));const t="mx_EventTile_e2eIcon mx_EventTile_e2eIcon_"+this.props.icon;return u.a.createElement("div",{className:t,onMouseEnter:this.onHoverStart,onMouseLeave:this.onHoverEnd},e)}}class X extends u.a.PureComponent{constructor(e){super(e),r()(this,"onHoverStart",()=>{this.setState({hover:!0})}),r()(this,"onHoverEnd",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const e=!this.props.messageState||"sent"===this.props.messageState,t="not_sent"===this.props.messageState,s=m()({mx_EventTile_receiptSent:e,mx_EventTile_receiptSending:!e&&!t});let n=null;t&&(n=u.a.createElement(M.a,{notification:A.a.RED_EXCLAMATION}));let i=null;if(this.state.hover){let s=Object(f.a)("Sending your message...");"encrypting"===this.props.messageState?s=Object(f.a)("Encrypting your message..."):e?s=Object(f.a)("Your message was sent"):t&&(s=Object(f.a)("Failed to send")),i=u.a.createElement(D.b,{className:"mx_EventTile_readAvatars_receiptTooltip",label:s,yOffset:20})}return u.a.createElement("span",{className:"mx_EventTile_readAvatars"},u.a.createElement("span",{className:s,onMouseEnter:this.onHoverStart,onMouseLeave:this.onHoverEnd},n,i))}}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const n=new RegExp("^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$","i");function i(e){return n.test(e)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));const n=Object.freeze({IS:"SERVICE_TYPE_IS",IM:"SERVICE_TYPE_IM"})},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(199),i=s(152),o=s(94),a=s(99),r=s(95),c=s(92),l=s(277),d=s(272),u=s(238);class h extends Error{}class m{constructor(e=null){this.accessToken=null,this.authEnabled=!0,this.tempClient=e?Object(i.createClient)({baseUrl:"",idBaseUrl:e}):null}get _matrixClient(){return this.tempClient?this.tempClient:o.a.get()}_writeToken(){this.tempClient||window.localStorage.setItem("mx_is_access_token",this.accessToken)}_readToken(){return this.tempClient?null:window.localStorage.getItem("mx_is_access_token")}hasCredentials(){return null!=this.accessToken}async getAccessToken({check:e=!0}={}){if(!this.authEnabled)return null;let t=this.accessToken;if(t||(t=this._readToken()),!t)return t=await this.registerForToken(e),t&&(this.accessToken=t,this._writeToken()),t;if(e)try{await this._checkToken(t)}catch(e){if(e instanceof l.b||e instanceof h)throw e;t=await this.registerForToken(),t&&(this.accessToken=t,this._writeToken())}return t}async _checkToken(e){const t=this._matrixClient.getIdentityServerUrl();try{await this._matrixClient.getIdentityAccount(e)}catch(s){if("M_TERMS_NOT_SIGNED"===s.errcode)return console.log("Identity Server requires new terms to be agreed to"),void await Object(l.d)([new l.a(n.a.IS,t,e)]);throw s}if(!this.tempClient&&!Object(d.a)()&&!await Object(d.b)(t)){const e=r.getComponent("dialogs.QuestionDialog"),{finished:s}=a.a.createTrackedDialog("Default identity server terms warning","",e,{title:Object(c.a)("Identity server has no terms of service"),description:React.createElement("div",null,React.createElement("p",null,Object(c.a)("This action requires accessing the default identity server <server /> to validate an email address or phone number, but the server does not have any terms of service.",{},{server:()=>React.createElement("b",null,Object(u.a)(t))})),React.createElement("p",null,Object(c.a)("Only continue if you trust the owner of the server."))),button:Object(c.a)("Trust")}),[n]=await s;if(!n)throw new h("User aborted identity server action without terms");Object(d.d)()}}async registerForToken(e=!0){const t=await o.a.get().getOpenIdToken(),{access_token:s,token:n}=await this._matrixClient.registerWithIdentityServer(t),i=n||s;return e&&await this._checkToken(i),i}}},,,function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e[e.None=0]="None",e[e.Bold=1]="Bold",e[e.Grey=2]="Grey",e[e.Red=3]="Red"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(91),i=s.n(n),o=s(101),a=s.n(o),r=s(125),c=s(92),l=s(100),d=s(96),u=s(103);const h=({className:e,title:t,children:s})=>i.a.createElement("div",{className:a()("mx_BaseCard_Group",e)},i.a.createElement("h1",null,t),s);t.b=({closeLabel:e,onClose:t,className:s,header:n,footer:o,withoutScrollContainer:h,previousPhase:m,children:p,refireParams:g})=>{let v,f;if(m){const e=()=>{d.a.dispatch({action:u.a.SetRightPanelPhase,phase:m,refireParams:g})};v=i.a.createElement(l.a,{className:"mx_BaseCard_back",onClick:e,title:Object(c.a)("Back")})}return t&&(f=i.a.createElement(l.a,{className:"mx_BaseCard_close",onClick:t,title:e||Object(c.a)("Close")})),h||(p=i.a.createElement(r.a,null,p)),i.a.createElement("div",{className:a()("mx_BaseCard",s)},i.a.createElement("div",{className:"mx_BaseCard_header"},v,f,n),p,o&&i.a.createElement("div",{className:"mx_BaseCard_footer"},o))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i,o,a=s(104),r=s.n(a),c=s(108),l=s.n(c),d=s(18),u=s.n(d),h=s(91),m=s.n(h),p=s(97),g=s.n(p),v=s(95),f=s(93);let b=Object(f.a)("views.elements.TextWithTooltip")((o=i=class extends m.a.Component{constructor(){super(),u()(this,"onMouseOver",()=>{this.setState({hover:!0})}),u()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const e=v.getComponent("elements.Tooltip"),t=this.props,{class:s,children:n,tooltip:i,tooltipClass:o,tooltipProps:a}=t,c=l()(t,["class","children","tooltip","tooltipClass","tooltipProps"]);return m.a.createElement("span",r()({},c,{onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,className:s}),n,this.state.hover&&m.a.createElement(e,r()({},a,{label:i,tooltipClassName:o,className:"mx_TextWithTooltip_tooltip"})))}},u()(i,"propTypes",{class:g.a.string,tooltipClass:g.a.string,tooltip:g.a.node.isRequired,tooltipProps:g.a.object}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(91),i=s.n(n),o=s(97),a=s.n(o),r=s(101),c=s.n(r),l=s(92),d=s(100),u=s(185);const h={VERIFIED:"verified",WARNING:"warning",UNKNOWN:"unknown",NORMAL:"normal",UNAUTHENTICATED:"unauthenticated"},m={[h.WARNING]:Object(l.b)("This user has not verified all of their sessions."),[h.NORMAL]:Object(l.b)("You have not verified this user."),[h.VERIFIED]:Object(l.b)("You have verified this user. This user has verified all of their sessions.")},p={[h.WARNING]:Object(l.b)("Someone is using an unknown session"),[h.NORMAL]:Object(l.b)("This room is end-to-end encrypted"),[h.VERIFIED]:Object(l.b)("Everyone in this room is verified")},g=({isUser:e,status:t,className:s,size:o,onClick:a,hideTooltip:r,bordered:g})=>{const[v,f]=Object(n.useState)(!1),b=c()({mx_E2EIcon:!0,mx_E2EIcon_bordered:g,mx_E2EIcon_warning:t===h.WARNING,mx_E2EIcon_normal:t===h.NORMAL,mx_E2EIcon_verified:t===h.VERIFIED},s);let y,_;y=e?m[t]:p[t],o&&(_={width:o+"px",height:o+"px"});const E=()=>f(!0),S=()=>f(!1);let w;return v&&!r&&(w=i.a.createElement(u.b,{label:y?Object(l.a)(y):""})),a?i.a.createElement(d.a,{onClick:a,onMouseOver:E,onMouseLeave:S,className:b,style:_},w):i.a.createElement("div",{onMouseOver:E,onMouseLeave:S,className:b,style:_},w)};g.propTypes={isUser:a.a.bool,status:a.a.oneOf(Object.values(h)),className:a.a.string,size:a.a.number,onClick:a.a.func},t.b=g},function(e,t,s){"use strict";s.r(t),s.d(t,"CHAT_EFFECTS",(function(){return i}));var n=s(92);const i=[{emojis:["🎊","🎉"],msgType:"nic.custom.confetti",command:"confetti",description:()=>Object(n.b)("Sends the given message with confetti"),fallbackMessage:()=>Object(n.a)("sends confetti")+" 🎉",options:{maxCount:150,speed:3,frameInterval:15,alpha:1,gradient:!1}},{emojis:["🎆"],msgType:"nic.custom.fireworks",command:"fireworks",description:()=>Object(n.b)("Sends the given message with fireworks"),fallbackMessage:()=>Object(n.a)("sends fireworks")+" 🎆",options:{maxCount:500,gravity:.05}},{emojis:["❄","🌨"],msgType:"io.element.effect.snowfall",command:"snowfall",description:()=>Object(n.b)("Sends the given message with snowfall"),fallbackMessage:()=>Object(n.a)("sends snowfall")+" ❄",options:{maxCount:200,gravity:.05,maxDrift:5}},{emojis:["👾","🌌"],msgType:"io.element.effects.space_invaders",command:"spaceinvaders",description:()=>Object(n.b)("Sends the given message with a space themed effect"),fallbackMessage:()=>Object(n.a)("sends space invaders")+" 👾",options:{maxCount:50,gravity:.01}}]},function(e,t,s){"use strict";s.d(t,"a",(function(){return k})),s.d(t,"b",(function(){return O}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(326),l=s(92),d=s(619),u=s(98),h=s(642),m=s(649),p=s(652),g=s(655),v=s(656),f=s(657),b=s(658),y=s(660),_=s(95),E=s(102),S=s(662),w=s(116),C=s(93);let k;!function(e){e.General="USER_GENERAL_TAB",e.Appearance="USER_APPEARANCE_TAB",e.Flair="USER_FLAIR_TAB",e.Notifications="USER_NOTIFICATIONS_TAB",e.Preferences="USER_PREFERENCES_TAB",e.Voice="USER_VOICE_TAB",e.Security="USER_SECURITY_TAB",e.Labs="USER_LABS_TAB",e.Mjolnir="USER_MJOLNIR_TAB",e.Help="USER_HELP_TAB"}(k||(k={}));let O=Object(C.a)("views.dialogs.UserSettingsDialog")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"mjolnirWatcher",void 0),o()(this,"mjolnirChanged",(e,t,s,n)=>{this.setState({mjolnirEnabled:n})}),this.state={mjolnirEnabled:u.b.getValue("feature_mjolnir")}}componentDidMount(){this.mjolnirWatcher=u.b.watchSetting("feature_mjolnir",null,this.mjolnirChanged)}componentWillUnmount(){u.b.unwatchSetting(this.mjolnirWatcher)}_getTabs(){const e=[];return e.push(new c.a(k.General,Object(l.b)("General"),"mx_UserSettingsDialog_settingsIcon",r.a.createElement(d.a,{closeSettingsFn:this.props.onFinished}))),e.push(new c.a(k.Appearance,Object(l.b)("Appearance"),"mx_UserSettingsDialog_appearanceIcon",r.a.createElement(m.a,null))),u.b.getValue(w.a.Flair)&&e.push(new c.a(k.Flair,Object(l.b)("Flair"),"mx_UserSettingsDialog_flairIcon",r.a.createElement(y.a,null))),e.push(new c.a(k.Notifications,Object(l.b)("Notifications"),"mx_UserSettingsDialog_bellIcon",r.a.createElement(g.a,null))),e.push(new c.a(k.Preferences,Object(l.b)("Preferences"),"mx_UserSettingsDialog_preferencesIcon",r.a.createElement(v.a,null))),u.b.getValue(w.a.Voip)&&e.push(new c.a(k.Voice,Object(l.b)("Voice & Video"),"mx_UserSettingsDialog_voiceIcon",r.a.createElement(f.a,null))),e.push(new c.a(k.Security,Object(l.b)("Security & Privacy"),"mx_UserSettingsDialog_securityIcon",r.a.createElement(p.a,{closeSettingsFn:this.props.onFinished}))),(E.a.get().showLabsSettings||u.b.getFeatureSettingNames().some(e=>u.b.getBetaInfo(e)))&&e.push(new c.a(k.Labs,Object(l.b)("Labs"),"mx_UserSettingsDialog_labsIcon",r.a.createElement(h.a,null))),this.state.mjolnirEnabled&&e.push(new c.a(k.Mjolnir,Object(l.b)("Ignored users"),"mx_UserSettingsDialog_mjolnirIcon",r.a.createElement(S.a,null))),e.push(new c.a(k.Help,Object(l.b)("Help & About"),"mx_UserSettingsDialog_helpIcon",r.a.createElement(b.a,{closeSettingsFn:()=>this.props.onFinished(!0)}))),e}render(){const e=_.getComponent("views.dialogs.BaseDialog");return r.a.createElement(e,{className:"mx_UserSettingsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("Settings")},r.a.createElement("div",{className:"mx_SettingsDialog_content"},r.a.createElement(c.b,{tabs:this._getTabs(),initialTabId:this.props.initialTabId})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return M})),s.d(t,"b",(function(){return U})),s.d(t,"c",(function(){return K})),s.d(t,"d",(function(){return G}));var n,i,o,a,r,c,l,d,u,h,m,p,g,v,f,b,y,_,E,S,w=s(18),C=s.n(w),k=s(91),O=s.n(k),R=s(101),I=s.n(R),x=s(95),T=s(92),j=s(98),N=s(100),P=s(119),D=s(120),A=s(93);!function(e){e.Password="m.login.password",e.Recaptcha="m.login.recaptcha",e.Terms="m.login.terms",e.Email="m.login.email.identity",e.Msisdn="m.login.msisdn",e.Sso="m.login.sso",e.SsoUnstable="org.matrix.login.sso"}(S||(S={}));const M=0;let U=Object(A.a)("views.auth.PasswordAuthEntry")((o=i=class extends O.a.Component{constructor(e){super(e),C()(this,"onSubmit",e=>{e.preventDefault(),this.props.busy||this.props.submitAuthDict({type:S.Password,user:this.props.matrixClient.credentials.userId,identifier:{type:"m.id.user",user:this.props.matrixClient.credentials.userId},password:this.state.password})}),C()(this,"onPasswordFieldChange",e=>{this.setState({password:e.target.value})}),this.state={password:""}}componentDidMount(){this.props.onPhaseChange(M)}render(){const e=I()({error:this.props.errorText});let t,s;if(this.props.busy){const e=x.getComponent("elements.Spinner");t=O.a.createElement(e,null)}else t=O.a.createElement("input",{type:"submit",className:"mx_Dialog_primary",disabled:!this.state.password,value:Object(T.a)("Continue")});this.props.errorText&&(s=O.a.createElement("div",{className:"error",role:"alert"},this.props.errorText));const n=x.getComponent("elements.Field");return O.a.createElement("div",null,O.a.createElement("p",null,Object(T.a)("Confirm your identity by entering your account password below.")),O.a.createElement("form",{onSubmit:this.onSubmit,className:"mx_InteractiveAuthEntryComponents_passwordSection"},O.a.createElement(n,{className:e,type:"password",name:"passwordField",label:Object(T.a)("Password"),autoFocus:!0,value:this.state.password,onChange:this.onPasswordFieldChange}),O.a.createElement("div",{className:"mx_button_row"},t)),s)}},C()(i,"LOGIN_TYPE",S.Password),n=o))||n,L=Object(A.a)("views.auth.RecaptchaAuthEntry")((c=r=class extends O.a.Component{constructor(...e){super(...e),C()(this,"onCaptchaResponse",e=>{D.a.instance.track("onboarding_grecaptcha_submit"),this.props.submitAuthDict({type:S.Recaptcha,response:e})})}componentDidMount(){this.props.onPhaseChange(M)}render(){if(this.props.busy){const e=x.getComponent("elements.Spinner");return O.a.createElement(e,null)}let e=this.props.errorText;const t=x.getComponent("views.auth.CaptchaForm");let s,n;return this.props.stageParams&&this.props.stageParams.public_key?s=this.props.stageParams.public_key:e=Object(T.a)("Missing captcha public key in homeserver configuration. Please report this to your homeserver administrator."),e&&(n=O.a.createElement("div",{className:"error",role:"alert"},e)),O.a.createElement("div",null,O.a.createElement(t,{sitePublicKey:s,onCaptchaResponse:this.onCaptchaResponse}),n)}},C()(r,"LOGIN_TYPE",S.Recaptcha),a=c))||a,F=Object(A.a)("views.auth.TermsAuthEntry")((u=d=class extends O.a.Component{constructor(e){super(e),C()(this,"tryContinue",()=>{this.trySubmit()}),C()(this,"trySubmit",()=>{let e=!0;for(const t of this.state.policies){const s=this.state.toggledPolicies[t.id];e=e&&s}e?(this.props.submitAuthDict({type:S.Terms}),D.a.instance.track("onboarding_terms_complete")):this.setState({errorText:Object(T.a)("Please review and accept all of the homeserver's policies")})});const t=this.props.stageParams.policies||{},s=j.b.getValue("language"),n={},i=[];for(const e of Object.keys(t)){const o=t[e];let a=o[s];if(a||(a=o.en),!a){a=o[Object.keys(o).find(e=>"version"!==e)]}if(!a)throw new Error("Failed to find a policy to show the user");n[e]=!1,i.push({id:e,name:a.name,url:a.url})}this.state={toggledPolicies:n,policies:i},D.a.instance.track("onboarding_terms_begin")}componentDidMount(){this.props.onPhaseChange(M)}togglePolicy(e){const t={};for(const s of this.state.policies){let n=this.state.toggledPolicies[s.id];s.id===e&&(n=!n),t[s.id]=n}this.setState({toggledPolicies:t})}render(){if(this.props.busy){const e=x.getComponent("elements.Spinner");return O.a.createElement(e,null)}const e=[];let t,s,n=!0;for(const t of this.state.policies){const s=this.state.toggledPolicies[t.id];n=n&&s,e.push(O.a.createElement("label",{key:"policy_checkbox_"+t.id,className:"mx_InteractiveAuthEntryComponents_termsPolicy"},O.a.createElement("input",{type:"checkbox",onChange:()=>this.togglePolicy(t.id),checked:s}),O.a.createElement("a",{href:t.url,target:"_blank",rel:"noreferrer noopener"},t.name)))}return(this.props.errorText||this.state.errorText)&&(t=O.a.createElement("div",{className:"error",role:"alert"},this.props.errorText||this.state.errorText)),!1!==this.props.showContinue&&(s=O.a.createElement("button",{className:"mx_InteractiveAuthEntryComponents_termsSubmit mx_GeneralButton",onClick:this.trySubmit,disabled:!n},Object(T.a)("Accept"))),O.a.createElement("div",null,O.a.createElement("p",null,Object(T.a)("Please review and accept the policies of this homeserver:")),e,t,s)}},C()(d,"LOGIN_TYPE",S.Terms),l=u))||l,B=Object(A.a)("views.auth.EmailIdentityAuthEntry")((p=m=class extends O.a.Component{componentDidMount(){this.props.onPhaseChange(M)}render(){var e;return void 0===this.props.inputs.emailAddress||null!==(e=this.props.stageState)&&void 0!==e&&e.emailSid?O.a.createElement(P.a,null):O.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_emailWrapper"},O.a.createElement("p",null,Object(T.a)("A confirmation email has been sent to %(emailAddress)s",{emailAddress:O.a.createElement("b",null,this.props.inputs.emailAddress)})),O.a.createElement("p",null,Object(T.a)("Open the link in the email to continue registration.")))}},C()(m,"LOGIN_TYPE",S.Email),h=p))||h,V=Object(A.a)("views.auth.MsisdnAuthEntry")((f=v=class extends O.a.Component{constructor(e){super(e),C()(this,"submitUrl",void 0),C()(this,"sid",void 0),C()(this,"msisdn",void 0),C()(this,"onTokenChange",e=>{this.setState({token:e.target.value})}),C()(this,"onFormSubmit",async e=>{if(e.preventDefault(),""!=this.state.token){this.setState({errorText:null});try{let e;if(!this.submitUrl)throw new Error("The registration with MSISDN flow is misconfigured");if(e=await this.props.matrixClient.submitMsisdnTokenOtherUrl(this.submitUrl,this.sid,this.props.clientSecret,this.state.token),e.success){const e={sid:this.sid,client_secret:this.props.clientSecret};this.props.submitAuthDict({type:S.Msisdn,threepid_creds:e,threepidCreds:e})}else this.setState({errorText:Object(T.a)("Token incorrect")})}catch(e){this.props.fail(e),console.log("Failed to submit msisdn token")}}}),this.state={token:"",requestingToken:!1,errorText:""}}componentDidMount(){this.props.onPhaseChange(M),this.setState({requestingToken:!0}),this.requestMsisdnToken().catch(e=>{this.props.fail(e)}).finally(()=>{this.setState({requestingToken:!1})})}requestMsisdnToken(){return this.props.matrixClient.requestRegisterMsisdnToken(this.props.inputs.phoneCountry,this.props.inputs.phoneNumber,this.props.clientSecret,1).then(e=>{this.submitUrl=e.submit_url,this.sid=e.sid,this.msisdn=e.msisdn})}render(){if(this.state.requestingToken){const e=x.getComponent("elements.Spinner");return O.a.createElement(e,null)}{const e=Boolean(this.state.token),t=I()({mx_InteractiveAuthEntryComponents_msisdnSubmit:!0,mx_GeneralButton:!0});let s;return this.state.errorText&&(s=O.a.createElement("div",{className:"error",role:"alert"},this.state.errorText)),O.a.createElement("div",null,O.a.createElement("p",null,Object(T.a)("A text message has been sent to %(msisdn)s",{msisdn:O.a.createElement("i",null,this.msisdn)})),O.a.createElement("p",null,Object(T.a)("Please enter the code it contains:")),O.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_msisdnWrapper"},O.a.createElement("form",{onSubmit:this.onFormSubmit},O.a.createElement("input",{type:"text",className:"mx_InteractiveAuthEntryComponents_msisdnEntry",value:this.state.token,onChange:this.onTokenChange,"aria-label":Object(T.a)("Code")}),O.a.createElement("br",null),O.a.createElement("input",{type:"submit",value:Object(T.a)("Submit"),className:t,disabled:!e})),s))}}},C()(v,"LOGIN_TYPE",S.Msisdn),g=f))||g,K=Object(A.a)("views.auth.SSOAuthEntry")((_=y=class e extends O.a.Component{constructor(t){super(t),C()(this,"ssoUrl",void 0),C()(this,"popupWindow",void 0),C()(this,"attemptFailed",()=>{this.setState({attemptFailed:!0})}),C()(this,"onReceiveMessage",e=>{"authDone"===e.data&&e.origin===this.props.matrixClient.getHomeserverUrl()&&this.popupWindow&&(this.popupWindow.close(),this.popupWindow=null)}),C()(this,"onStartAuthClick",()=>{this.popupWindow=window.open(this.ssoUrl,"_blank"),this.setState({phase:e.PHASE_POSTAUTH}),this.props.onPhaseChange(e.PHASE_POSTAUTH)}),C()(this,"onConfirmClick",()=>{this.props.submitAuthDict({})}),this.ssoUrl=t.matrixClient.getFallbackAuthUrl(this.props.loginType,this.props.authSessionId),this.popupWindow=null,window.addEventListener("message",this.onReceiveMessage),this.state={phase:e.PHASE_PREAUTH,attemptFailed:!1}}componentDidMount(){this.props.onPhaseChange(e.PHASE_PREAUTH)}componentWillUnmount(){window.removeEventListener("message",this.onReceiveMessage),this.popupWindow&&(this.popupWindow.close(),this.popupWindow=null)}render(){let t=null;const s=O.a.createElement(N.a,{onClick:this.props.onCancel,kind:this.props.continueKind?this.props.continueKind+"_outline":"primary_outline"},Object(T.a)("Cancel"));let n;return t=this.state.phase===e.PHASE_PREAUTH?O.a.createElement(N.a,{onClick:this.onStartAuthClick,kind:this.props.continueKind||"primary"},this.props.continueText||Object(T.a)("Single Sign On")):O.a.createElement(N.a,{onClick:this.onConfirmClick,kind:this.props.continueKind||"primary"},this.props.continueText||Object(T.a)("Confirm")),this.props.errorText?n=O.a.createElement("div",{className:"error",role:"alert"},this.props.errorText):this.state.attemptFailed&&(n=O.a.createElement("div",{className:"error",role:"alert"},Object(T.a)("Something went wrong in confirming your identity. Cancel and try again."))),O.a.createElement(O.a.Fragment,null,n,O.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_sso_buttons"},s,t))}},C()(y,"LOGIN_TYPE",S.Sso),C()(y,"UNSTABLE_LOGIN_TYPE",S.SsoUnstable),C()(y,"PHASE_PREAUTH",1),C()(y,"PHASE_POSTAUTH",2),b=_))||b,W=Object(A.a)("views.auth.FallbackAuthEntry")(E=class extends O.a.Component{constructor(e){super(e),C()(this,"popupWindow",void 0),C()(this,"fallbackButton",Object(k.createRef)()),C()(this,"focus",()=>{this.fallbackButton.current&&this.fallbackButton.current.focus()}),C()(this,"onShowFallbackClick",e=>{e.preventDefault(),e.stopPropagation();const t=this.props.matrixClient.getFallbackAuthUrl(this.props.loginType,this.props.authSessionId);this.popupWindow=window.open(t,"_blank")}),C()(this,"onReceiveMessage",e=>{"authDone"===e.data&&e.origin===this.props.matrixClient.getHomeserverUrl()&&this.props.submitAuthDict({})}),this.popupWindow=null,window.addEventListener("message",this.onReceiveMessage)}componentDidMount(){this.props.onPhaseChange(M)}componentWillUnmount(){window.removeEventListener("message",this.onReceiveMessage),this.popupWindow&&this.popupWindow.close()}render(){let e;return this.props.errorText&&(e=O.a.createElement("div",{className:"error",role:"alert"},this.props.errorText)),O.a.createElement("div",null,O.a.createElement("a",{href:"",ref:this.fallbackButton,onClick:this.onShowFallbackClick},Object(T.a)("Start authentication")),e)}})||E;function G(e){switch(e){case S.Password:return U;case S.Recaptcha:return L;case S.Email:return B;case S.Msisdn:return V;case S.Terms:return F;case S.Sso:case S.SsoUnstable:return K;default:return W}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(115),i=s.n(n),o=s(8);class a extends o.EventEmitter{constructor(e){super(),this.userId=e,i()(this,"modified",void 0),i()(this,"displayName",void 0),i()(this,"rawDisplayName",void 0),i()(this,"avatarUrl",void 0),i()(this,"presenceStatusMsg",null),i()(this,"presence","offline"),i()(this,"lastActiveAgo",0),i()(this,"lastPresenceTs",0),i()(this,"currentlyActive",!1),i()(this,"events",{presence:null,profile:null}),i()(this,"unstable_statusMessage",""),this.displayName=e,this.rawDisplayName=e,this.avatarUrl=null,this.updateModifiedTime()}setPresenceEvent(e){if("m.presence"!==e.getType())return;const t=null===this.events.presence;this.events.presence=e;const s=[];(e.getContent().presence!==this.presence||t)&&s.push("User.presence"),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&s.push("User.avatarUrl"),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&s.push("User.displayName"),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&s.push("User.currentlyActive"),this.presence=e.getContent().presence,s.push("User.lastPresenceTs"),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(let t=0;t<s.length;t++)this.emit(s[t],e,this)}setDisplayName(e){const t=this.displayName;this.displayName="string"==typeof e?e:void 0,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName="string"==typeof e?e:void 0}setAvatarUrl(e){const t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}unstable_updateStatusMessage(e){e.getContent()?this.unstable_statusMessage=e.getContent().status:this.unstable_statusMessage="",this.updateModifiedTime(),this.emit("User.unstable_statusMessage",this)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i,o,a=s(104),r=s.n(a),c=s(108),l=s.n(c),d=s(18),u=s.n(d),h=s(91),m=s.n(h),p=s(101),g=s.n(p),v=s(93);let f=Object(v.a)("views.elements.StyledRadioButton")((o=i=class extends m.a.PureComponent{render(){const e=this.props,{children:t,className:s,disabled:n,outlined:i}=e,o=l()(e,["children","className","disabled","outlined"]),a=g()("mx_RadioButton",s,{mx_RadioButton_disabled:n,mx_RadioButton_enabled:!n,mx_RadioButton_checked:this.props.checked,mx_RadioButton_outlined:i});return m.a.createElement("label",{className:a},m.a.createElement("input",r()({type:"radio",disabled:n},o)),m.a.createElement("div",null,m.a.createElement("div",null)),m.a.createElement("div",{className:"mx_RadioButton_content"},t),m.a.createElement("div",{className:"mx_RadioButton_spacer"}))}},u()(i,"defaultProps",{className:""}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(18),i=s.n(n),o=s(156),a=s(96),r=s(117),c=s(94),l=s(92),d=s(107);class u extends o.a{constructor(){super(a.a,{displayName:window.localStorage.getItem("mx_profile_displayname"),avatarUrl:window.localStorage.getItem("mx_profile_avatar_url")}),i()(this,"monitoredUser",void 0),i()(this,"onProfileUpdate",async()=>{const e=await this.matrixClient.getProfileInfo(this.matrixClient.getUserId());e.displayname?window.localStorage.setItem("mx_profile_displayname",e.displayname):window.localStorage.removeItem("mx_profile_displayname"),e.avatar_url?window.localStorage.setItem("mx_profile_avatar_url",e.avatar_url):window.localStorage.removeItem("mx_profile_avatar_url"),await this.updateState({displayName:e.displayname,avatarUrl:e.avatar_url})}),i()(this,"onStateEvents",Object(r.throttle)(async e=>{const t=c.a.get().getUserId();"m.room.member"===e.getType()&&e.getSender()===t&&e.getStateKey()===t&&await this.onProfileUpdate()},200,{trailing:!0,leading:!0}))}static get instance(){return u.internalInstance}get displayName(){return this.matrixClient?this.matrixClient.isGuest()?Object(l.a)("Guest"):this.state.displayName?this.state.displayName:this.matrixClient.getUserId():this.state.displayName||null}get avatarMxc(){return this.state.avatarUrl||null}getHttpAvatarUrl(e=0){if(!this.avatarMxc)return null;const t=Object(d.b)(this.avatarMxc);return!e||e<=0?t.srcHttp:t.getSquareThumbnailHttp(e)}async onNotReady(){this.monitoredUser&&(this.monitoredUser.removeListener("User.displayName",this.onProfileUpdate),this.monitoredUser.removeListener("User.avatarUrl",this.onProfileUpdate)),this.matrixClient&&this.matrixClient.removeListener("RoomState.events",this.onStateEvents),await this.reset({})}async onReady(){const e=this.matrixClient.getUserId();this.monitoredUser=this.matrixClient.getUser(e),this.monitoredUser&&(this.monitoredUser.on("User.displayName",this.onProfileUpdate),this.monitoredUser.on("User.avatarUrl",this.onProfileUpdate)),this.matrixClient.on("RoomState.events",this.onStateEvents),await this.onProfileUpdate()}async onAction(e){}}i()(u,"internalInstance",new u)},,function(e,t,s){"use strict";s.d(t,"c",(function(){return c})),s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return d})),s.d(t,"d",(function(){return u}));var n=s(97),i=s.n(n);const o=/^\S+@\S+\.\S+$/,a=/^@\S+:\S+$/,r=/^!\S+:\S+$/,c=["mx-user-id","mx-room-id","email"];let l;!function(e){e.Email="email",e.MatrixUserId="mx-user-id",e.MatrixRoomId="mx-room-id"}(l||(l={}));const d=i.a.shape({addressType:i.a.oneOf(c).isRequired,address:i.a.string.isRequired,displayName:i.a.string,avatarMxc:i.a.string,isKnown:i.a.bool});function u(e){return o.test(e)?l.Email:a.test(e)?l.MatrixUserId:r.test(e)?l.MatrixRoomId:null}},function(e,t,s){"use strict";function n(e,t){const s=`Store is invalid because ${e}, please stop the client, delete all data and start the client again`,n=Reflect.construct(Error,[s]);return Reflect.setPrototypeOf(n,Reflect.getPrototypeOf(this)),n.reason=e,n.value=t,n}function i(e){const t=`Crypto store is invalid because ${e}, please stop the client, delete all data and start the client again`,s=Reflect.construct(Error,[t]);return Reflect.setPrototypeOf(s,Reflect.getPrototypeOf(this)),s.reason=e,s.name="InvalidCryptoStoreError",s}s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i})),s.d(t,"c",(function(){return o})),n.TOGGLED_LAZY_LOADING="TOGGLED_LAZY_LOADING",n.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(n,Error),i.TOO_NEW="TOO_NEW",i.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(i,Error);class o extends Error{constructor(e,t){super(e),this.value=t}}},function(e,t,s){"use strict";s.d(t,"i",(function(){return d})),s.d(t,"j",(function(){return u})),s.d(t,"a",(function(){return h})),s.d(t,"h",(function(){return m})),s.d(t,"g",(function(){return p})),s.d(t,"e",(function(){return g})),s.d(t,"d",(function(){return v})),s.d(t,"f",(function(){return f})),s.d(t,"b",(function(){return b})),s.d(t,"c",(function(){return y})),s.d(t,"k",(function(){return _}));var n=s(115),i=s.n(n),o=s(0),a=s(8),r=s(276),c=s(275);const l="m.key.verification.",d=l+"request",u=l+"start",h=l+"cancel",m=l+"ready",p=1,g=2,v=3,f=4,b=5,y=6;class _ extends a.EventEmitter{constructor(e,t,s){super(),i()(this,"_cancelOnTimeout",()=>{try{this.initiatedByMe?this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){o.a.error("Error while cancelling verification request",e)}}),this.channel=e,this.channel._request=this,this._verificationMethods=t,this._client=s,this._commonMethods=[],this._setPhase(p,!1),this._eventsByUs=new Map,this._eventsByThem=new Map,this._observeOnly=!1,this._timeoutTimer=null,this._accepting=!1,this._declining=!1,this._verifierHasFinished=!1,this._cancelled=!1,this._chosenMethod=null,this._qrCodeData=null,this._requestReceivedAt=null}static validateEvent(e,t,s){const n=t.getContent();return!(!e||!e.startsWith(l))&&(n?e!==d&&e!==m||Array.isArray(n.methods)?e!==d&&e!==m&&e!==u||"string"==typeof n.from_device&&0!==n.from_device.length||(o.a.log("VerificationRequest: validateEvent: fail because from_device"),!1):(o.a.log("VerificationRequest: validateEvent: fail because methods"),!1):(o.a.log("VerificationRequest: validateEvent: no content"),!1))}get invalid(){return this.phase===p}get requested(){return this.phase===g}get cancelled(){return this.phase===b}get ready(){return this.phase===v}get started(){return this.phase===f}get done(){return this.phase===y}get methods(){return this._commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){let t=this.channel.getTimestamp(e)+6e5;if(this._requestReceivedAt&&!this.initiatedByMe&&this.phase<=g){const e=this._requestReceivedAt+12e4;t=Math.min(t,e)}return Math.max(0,t-Date.now())}get timeout(){const e=this._getEventByEither(d);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this._getEventByEither(d)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return this.phase<v&&!this._accepting&&!this._declining}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==y&&this._phase!==b}get qrCodeData(){return this._qrCodeData}otherPartySupportsMethod(e,t=!1){if(!t&&!this.ready&&!this.started)return!1;const s=this._eventsByThem.get(d)||this._eventsByThem.get(m);if(!s){if(this.started&&this.initiatedByMe){const t=this._eventsByUs.get(u),s=t&&t.getContent();return e==(s&&s.method)}return!1}const n=s.getContent();if(!n)return!1;const{methods:i}=n;return!!Array.isArray(i)&&i.includes(e)}get initiatedByMe(){const e=this._eventsByUs.size+this._eventsByThem.size===0;if(this._phase===p&&e)return!0;const t=this._eventsByUs.has(d),s=this._eventsByThem.has(d);if(t&&!s)return!0;if(!t&&s)return!1;const n=this._eventsByUs.has(u),i=this._eventsByThem.has(u);return!(!n||i)}get requestingUserId(){return this.initiatedByMe?this._client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this._client.getUserId()}get otherUserId(){return this.channel.userId}get isSelfVerification(){return this._client.getUserId()===this.otherUserId}get cancellingUserId(){const e=this._eventsByUs.get(h),t=this._eventsByThem.get(h);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}get cancellationCode(){const e=this._getEventByEither(h);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){const e=(this._eventsByThem.get(d)||this._eventsByThem.get(m)||this._eventsByThem.get(u)).getContent().from_device;return{userId:this.otherUserId,deviceId:e}}beginKeyVerification(e,t=null){if(!this.observeOnly&&!this._verifier){if(this.phase===g||this.phase===v||this.phase===p&&this.channel.constructor.canCreateRequest(u)){if(this._commonMethods.length&&!this._commonMethods.includes(e))throw Object(r.g)();if(this._verifier=this._createVerifier(e,null,t),!this._verifier)throw Object(r.g)();this._chosenMethod=e}}return this._verifier}async sendRequest(){if(!this.observeOnly&&this._phase===p){const e=[...this._verificationMethods.keys()];await this.channel.send(d,{methods:e})}}async cancel({reason:e="User declined",code:t="m.user"}={}){if(!this.observeOnly&&this._phase!==b){if(this._declining=!0,this.emit("change"),this._verifier)return this._verifier.cancel(Object(r.a)(t,e)());this._cancellingUserId=this._client.getUserId(),await this.channel.send(h,{code:t,reason:e})}}async accept(){if(!this.observeOnly&&this.phase===g&&!this.initiatedByMe){const e=[...this._verificationMethods.keys()];this._accepting=!0,this.emit("change"),await this.channel.send(m,{methods:e})}}waitFor(e){return new Promise((t,s)=>{const n=()=>{let i=!1;return e(this)?(t(this),i=!0):this.cancelled&&(s(new Error("cancelled")),i=!0),i&&this.off("change",n),i};n()||this.on("change",n)})}_setPhase(e,t=!0){this._phase=e,t&&this.emit("change")}_getEventByEither(e){return this._eventsByThem.get(e)||this._eventsByUs.get(e)}_getEventBy(e,t){return t?this._eventsByThem.get(e):this._eventsByUs.get(e)}_calculatePhaseTransitions(){const e=[{phase:p}],t=()=>e[e.length-1].phase,s=this._eventsByThem.has(d),n=this._getEventBy(d,s);n&&e.push({phase:g,event:n});const i=n&&this._getEventBy(m,!s);let o;if(i&&t()===g&&e.push({phase:v,event:i}),i||!n){const e=this._eventsByThem.get(u),t=this._eventsByUs.get(u);o=e&&t?e.getSender()<t.getSender()?e:t:e||t}else o=this._getEventBy(u,!s);if(o){const s=t()===g&&n.getSender()!==o.getSender(),i=t()===p&&this.channel.constructor.canCreateRequest(u);(s||t()===v||i)&&e.push({phase:f,event:o})}const a=this._eventsByUs.get("m.key.verification.done");(this._verifierHasFinished||a&&t()===f)&&e.push({phase:y});const r=this._getEventByEither(h);return(this._cancelled||r)&&t()!==y?(e.push({phase:b,event:r}),e):e}_transitionToPhase(e){const{phase:t,event:s}=e;if((t===g||t===v)&&!this._wasSentByOwnDevice(s)){const e=s.getContent();this._commonMethods=e.methods.filter(e=>this._verificationMethods.has(e))}if(this.observeOnly||t!==g&&t!==f&&t!==v||this.channel.receiveStartFromOtherDevices&&this._wasSentByOwnUser(s)&&!this._wasSentByOwnDevice(s)&&(this._observeOnly=!0),t===f){const{method:e}=s.getContent();this._verifier||this.observeOnly||(this._verifier=this._createVerifier(e,s),this._verifier?this._chosenMethod=e:this.cancel({code:"m.unknown_method",reason:"Unknown method: "+e}))}}_applyPhaseTransitions(){const e=this._calculatePhaseTransitions(),t=e.findIndex(e=>e.phase===this.phase),s=e.slice(t+1);for(const e of s)this._transitionToPhase(e);return s}_isWinningStartRace(e){if(e.getType()!==u)return!1;const t=this._verifier.startEvent;let s,n;if(this.isSelfVerification)if(t){const e=t.getContent();s=e&&e.from_device}else s=this._client.getDeviceId();else s=t?t.getSender():this._client.getUserId();if(this.isSelfVerification){const t=e.getContent();n=t&&t.from_device}else n=e.getSender();return n<s}hasEventId(e){for(const t of this._eventsByUs.values())if(t.getId()===e)return!0;for(const t of this._eventsByThem.values())if(t.getId()===e)return!0;return!1}async handleEvent(e,t,s,n,i){if(this.done||this.cancelled)return;const a=this._observeOnly;if(this._adjustObserveOnly(t,s),!this.observeOnly&&!n&&await this._cancelOnError(e,t))return;if(i?this._eventsByUs.has(e):this._eventsByThem.has(e))return;const r=this.phase;this._addEvent(e,t,i);const l=this._applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){const s=this._isWinningStartRace(t);this._verifier.canSwitchStartEvent(t)&&s?this._verifier.switchStartEvent(t):n||(e===h||this._verifier.events&&this._verifier.events.includes(e))&&this._verifier.handleEvent(t)}if(l.length){if(s&&l.some(e=>e.phase===v)){this.otherPartySupportsMethod(c.c,!0)&&(this._qrCodeData=await c.a.create(this,this._client))}const e=l[l.length-1],{phase:t}=e;this._setupTimeout(t),this._setPhase(t)}else this._observeOnly!==a&&this.emit("change")}finally{o.a.log(`Verification request ${this.channel.transactionId}: ${e} event with id:${t.getId()}, content:${JSON.stringify(t.getContent())} deviceId:${this.channel.deviceId}, sender:${t.getSender()}, isSentByUs:${i}, isLiveEvent:${s}, isRemoteEcho:${n}, phase:${r}=>${this.phase}, observeOnly:${a}=>${this._observeOnly}`)}}_setupTimeout(e){if(!this._timeoutTimer&&!this.observeOnly&&e===g&&(this._timeoutTimer=setTimeout(this._cancelOnTimeout,this.timeout)),this._timeoutTimer){(e===f||e===v||e===y||e===b)&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null)}}async _cancelOnError(e,t){if(e===u){const e=t.getContent().method;if(!this._verificationMethods.has(e))return await this.cancel(Object(r.b)(Object(r.g)())),!0}const s=e===d&&this.phase!==p,n=e===m&&this.phase!==g;if(this.phase!==p&&(s||n)){o.a.warn(`Cancelling, unexpected ${e} verification event from `+t.getSender());const s=`Unexpected ${e} event in phase ${this.phase}`;return await this.cancel(Object(r.b)(Object(r.f)({reason:s}))),!0}return!1}_adjustObserveOnly(e,t){t||(this._observeOnly=!0),this.calculateEventTimeout(e)<3e3&&(this._observeOnly=!0)}_addEvent(e,t,s){if(s?this._eventsByUs.set(e,t):this._eventsByThem.set(e,t),e===d){for(const[e,t]of this._eventsByThem.entries())t.getSender()!==this.otherUserId&&this._eventsByThem.delete(e);this._requestReceivedAt=Date.now()}}_createVerifier(e,t=null,s=null){s||(s=this.targetDevice);const{userId:n,deviceId:i}=s,a=this._verificationMethods.get(e);if(a)return new a(this.channel,this._client,n,i,t,this);o.a.warn("could not find verifier constructor for method",e)}_wasSentByOwnUser(e){return e.getSender()===this._client.getUserId()}_wasSentByOwnDevice(e){if(!this._wasSentByOwnUser(e))return!1;const t=e.getContent();return!(!t||t.from_device!==this._client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;const e=this._applyPhaseTransitions();e.length&&this._setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send("m.key.verification.done",{}),this._verifierHasFinished=!0;const e=this._applyPhaseTransitions();e.length&&this._setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this._eventsByThem.get(e)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(18),i=s.n(n),o=s(156),a=s(96),r=s(244),c=s(278),l=s(140),d=s(161),u=s(123),h=s(94);function m(e){var t;return`${null!==(t=e.roomId)&&void 0!==t?t:h.a.get().getUserId()}::${e.id}`}class p extends o.a{constructor(){super(a.a,{}),i()(this,"widgetMap",new Map),i()(this,"roomMap",new Map),i()(this,"onWidgetEchoStoreUpdate",(e,t)=>{this.initRoom(e),this.loadRoomWidgets(this.matrixClient.getRoom(e)),this.emit(u.b,e)}),i()(this,"onRoom",e=>{this.initRoom(e.roomId),this.loadRoomWidgets(e),this.emit(u.b,e.roomId)}),i()(this,"onRoomStateEvents",e=>{if("im.vector.modular.widgets"!==e.getType())return;const t=e.getRoomId();this.initRoom(t),this.loadRoomWidgets(this.matrixClient.getRoom(t)),this.emit(u.b,t)}),i()(this,"getRoom",(e,t=!1)=>(t&&this.initRoom(e),this.roomMap.get(e))),r.a.on("update",this.onWidgetEchoStoreUpdate)}static get instance(){return p.internalInstance}initRoom(e){this.roomMap.has(e)||this.roomMap.set(e,{widgets:[]})}async onReady(){this.matrixClient.on("Room",this.onRoom),this.matrixClient.on("RoomState.events",this.onRoomStateEvents),this.matrixClient.getRooms().forEach(e=>{this.loadRoomWidgets(e)}),this.emit(u.b,null)}async onNotReady(){this.matrixClient.off("Room",this.onRoom),this.matrixClient.off("RoomState.events",this.onRoomStateEvents),this.widgetMap=new Map,this.roomMap=new Map,await this.reset({})}async onAction(e){}generateApps(e){return r.a.getEchoedRoomWidgets(e.roomId,l.a.getRoomWidgets(e)).map(e=>l.a.makeAppConfig(e.getStateKey(),e.getContent(),e.getSender(),e.getRoomId(),e.getId()))}loadRoomWidgets(e){if(!e)return;const t=this.roomMap.get(e.roomId)||{};t.widgets=[],Array.from(this.widgetMap.values()).forEach(t=>{t.roomId===e.roomId&&this.widgetMap.delete(m(t))});let s=!1;this.generateApps(e).forEach(e=>{const n=this.widgetMap.get(m(e));n&&console.warn(`Possible widget ID conflict for ${e.id} - wants to store in room ${e.roomId} but is currently stored as ${n.roomId} - letting the want win`),this.widgetMap.set(m(e),e),t.widgets.push(e),s=!0}),s&&!this.roomMap.has(e.roomId)&&this.roomMap.set(e.roomId,t),this.emit(e.roomId)}getApps(e){const t=this.getRoom(e);return(null==t?void 0:t.widgets)||[]}doesRoomHaveConference(e){const t=this.getRoom(e.roomId);if(!t)return!1;const s=t.widgets.filter(e=>d.a.JITSI.matches(e.type)),n=r.a.roomHasPendingWidgetsOfType(e.roomId,[],d.a.JITSI);return s.length>0||n}isJoinedToConferenceIn(e){const t=this.getRoom(e.roomId);if(!t)return!1;return t.widgets.filter(e=>d.a.JITSI.matches(e.type)).some(e=>c.a.getWidgetPersistence(e.id))}}i()(p,"internalInstance",new p),window.mxWidgetStore=p.instance},,function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return c}));var n=s(18),i=s.n(n),o=s(8),a=s(203);const r="update";class c extends o.EventEmitter{constructor(...e){super(...e),i()(this,"_symbol",void 0),i()(this,"_count",void 0),i()(this,"_color",void 0)}get symbol(){return this._symbol}get count(){return this._count}get color(){return this._color}get isIdle(){return this.color<=a.a.None}get isUnread(){return this.color>=a.a.Bold}get hasUnreadCount(){return this.color>=a.a.Grey&&(!!this.count||!!this.symbol)}get hasMentions(){return this.color>=a.a.Red}emitIfUpdated(e){e.isDifferentFrom(this)&&this.emit(r)}snapshot(){return new l(this)}destroy(){this.removeAllListeners(r)}}class l{constructor(e){i()(this,"symbol",void 0),i()(this,"count",void 0),i()(this,"color",void 0),this.symbol=e.symbol,this.count=e.count,this.color=e.color}isDifferentFrom(e){const t={count:this.count,symbol:this.symbol,color:this.color},s={count:e.count,symbol:e.symbol,color:e.color};return JSON.stringify(t)!==JSON.stringify(s)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(18),i=s.n(n),o=s(117),a=s(1);function r(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function c(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?r(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):r(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class l{constructor(e,t={keys:[]}){i()(this,"_options",void 0),i()(this,"_items",void 0),this._options=t,this.setObjects(e),void 0===this._options.shouldMatchWordsOnly&&(this._options.shouldMatchWordsOnly=!0)}setObjects(e){this._items=new Map;for(const t of e){const e=Object(o.at)(t,this._options.keys);if(this._options.funcs)for(const s of this._options.funcs){const n=s(t);Array.isArray(n)?e.push(...n):e.push(n)}for(const[s,n]of Object.entries(e)){if(!n)continue;const e=this.processQuery(n);this._items.has(e)||this._items.set(e,[]),this._items.get(e).push({keyWeight:Number(s),object:t})}}}match(e,t=-1){if(e=this.processQuery(e),this._options.shouldMatchWordsOnly&&(e=e.replace(/[^\w]/g,"")),0===e.length)return[];const s=[];for(const[t,n]of this._items.entries()){let i=t;this._options.shouldMatchWordsOnly&&(i=i.replace(/[^\w]/g,""));const o=i.indexOf(e);-1!==o&&s.push(...n.map(e=>c({index:o},e)))}s.sort((e,t)=>{if(e.index<t.index)return-1;if(e.index===t.index){if(e.keyWeight<t.keyWeight)return-1;if(e.keyWeight===t.keyWeight)return 0}return 1});const n=Object(o.uniq)(s.map(e=>e.object)),i=-1===t?n.length:t;return n.slice(0,i)}processQuery(e){return!1!==this._options.fuzzy?Object(a.D)(e.toLowerCase()).toLowerCase():e.toLowerCase()}}},function(e,t,s){"use strict";t.a={SHOW_ENCRYPTION_SETUP_UI:!0}},,,function(e,t){e.exports="img/warning.05cc423.svg"},,function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(97),c=s.n(r),l=s(95),d=s(92),u=s(101),h=s.n(u);class m extends a.a.Component{constructor(...e){super(...e),i()(this,"onFinished",()=>{this.props.onFinished()})}render(){const e=l.getComponent("views.dialogs.BaseDialog"),t=l.getComponent("views.elements.DialogButtons");return a.a.createElement(e,{className:"mx_InfoDialog",onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content",hasCancel:this.props.hasCloseButton,onKeyDown:this.props.onKeyDown,fixedWidth:this.props.fixedWidth},a.a.createElement("div",{className:h()("mx_Dialog_content",this.props.className),id:"mx_Dialog_content"},this.props.description),!1!==this.props.button&&a.a.createElement(t,{primaryButton:this.props.button||Object(d.a)("OK"),onPrimaryButtonClick:this.onFinished,hasCancel:!1}))}}i()(m,"propTypes",{className:c.a.string,title:c.a.string,description:c.a.node,button:c.a.oneOfType([c.a.string,c.a.bool]),onFinished:c.a.func,hasCloseButton:c.a.bool,onKeyDown:c.a.func,fixedWidth:c.a.bool}),i()(m,"defaultProps",{title:"",description:"",hasCloseButton:!1})},,function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(101),a=s.n(o);const r=Object(n.forwardRef)(({className:e,title:t,subtitle:s,children:n},o)=>i.a.createElement("div",{className:a()("mx_EventTileBubble",e),ref:o},i.a.createElement("div",{className:"mx_EventTileBubble_title"},t),s&&i.a.createElement("div",{className:"mx_EventTileBubble_subtitle"},s),n));t.a=r},,function(e,t,s){"use strict";s.d(t,"a",(function(){return E})),s.d(t,"b",(function(){return S}));var n=s(115),i=s.n(n),o=s(8),a=s(350),r=s(167),c=s(261),l=s(1),d=s(114),u=s(168);class h{constructor(e,t){this.roomId=e}}var m=s(0),p=s(389),g=s(110),v=s(178);function f(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function b(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?f(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):f(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const y=["1","2","3","4","5","6"];function _(e,t,s){const n={content:{},type:"m.receipt",room_id:t.getRoomId()};return n.content[t.getId()]={},n.content[t.getId()][s]={},n.content[t.getId()][s][e]={ts:t.getTs()},new d.b(n)}let E;!function(e){e.Highlight="highlight",e.Total="total"}(E||(E={}));class S extends o.EventEmitter{constructor(e,t,s,n={}){if(super(),this.roomId=e,this.client=t,this.myUserId=s,this.opts=n,i()(this,"reEmitter",void 0),i()(this,"txnToEvent",{}),i()(this,"receipts",{}),i()(this,"receiptCacheByEventId",{}),i()(this,"realReceipts",{}),i()(this,"notificationCounts",{}),i()(this,"timelineSets",void 0),i()(this,"filteredTimelineSets",{}),i()(this,"pendingEventList",void 0),i()(this,"blacklistUnverifiedDevices",null),i()(this,"selfMembership",null),i()(this,"summaryHeroes",null),i()(this,"getTypeWarning",!1),i()(this,"getVersionWarning",!1),i()(this,"membersPromise",void 0),i()(this,"name",void 0),i()(this,"normalizedName",void 0),i()(this,"tags",{}),i()(this,"accountData",{}),i()(this,"summary",null),i()(this,"storageToken",void 0),i()(this,"timeline",void 0),i()(this,"oldState",void 0),i()(this,"currentState",void 0),this.setMaxListeners(100),this.reEmitter=new p.a(this),n.pendingEventOrdering=n.pendingEventOrdering||"chronological",-1===["chronological","detached"].indexOf(n.pendingEventOrdering))throw new Error("opts.pendingEventOrdering MUST be either 'chronological' or 'detached'. Got: '"+n.pendingEventOrdering+"'");if(this.name=e,this.timelineSets=[new a.a(this,n)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),["Room.timeline","Room.timelineReset"]),this.fixUpLegacyTimelineFields(),"detached"==this.opts.pendingEventOrdering){this.pendingEventList=[];const e=t.sessionStore.store.getItem(w(this.roomId));e&&JSON.parse(e).forEach(async e=>{const t=new d.b(e);t.getType()===g.a.RoomMessageEncrypted&&await t.attemptDecryption(this.client.crypto),t.setStatus(d.a.NOT_SENT),this.addPendingEvent(t,t.getTxnId())})}this.opts.lazyLoadMembers?this.membersPromise=null:this.membersPromise=Promise.resolve(!1)}decryptCriticalEvents(){const e=this.getEventReadUpTo(this.client.getUserId(),!0),t=this.getLiveTimeline().getEvents(),s=t.findIndex(t=>t.event.event_id===e),n=t.slice(s).filter(e=>e.shouldAttemptDecryption()).reverse().map(e=>e.attemptDecryption(this.client.crypto,{isRetry:!0}));return Promise.allSettled(n)}decryptAllEvents(){const e=this.getUnfilteredTimelineSet().getLiveTimeline().getEvents().filter(e=>e.shouldAttemptDecryption()).reverse().map(e=>e.attemptDecryption(this.client.crypto,{isRetry:!0}));return Promise.allSettled(e)}getVersion(){const e=this.currentState.getStateEvents(g.a.RoomCreate,"");if(!e)return this.getVersionWarning||(m.a.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1";const t=e.getContent().room_version;return void 0===t?"1":t}shouldUpgradeToVersion(){return y.includes(this.getVersion())?null:"6"}async getRecommendedVersion(){let e=(await this.client.getCapabilities())["m.room_versions"];if(!e){e={default:"6",available:{}};for(const t of y)e.available[t]=v.c.Stable}let t=this.checkVersionAgainstCapability(e);if(t.urgent&&t.needsUpgrade){m.a.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");if(e=(await this.client.getCapabilities(!0))["m.room_versions"],!e)return m.a.warn("No room version capability - assuming upgrade required."),t;t=this.checkVersionAgainstCapability(e)}return t}checkVersionAgainstCapability(e){const t=this.getVersion();m.a.log(`[${this.roomId}] Current version: ${t}`),m.a.log(`[${this.roomId}] Version capability: `,e);const s={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return s;return Object.keys(e.available).filter(t=>"stable"===e.available[t]).includes(t)||(s.version=e.default,s.needsUpgrade=!0,s.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),s.urgent?m.a.warn("URGENT upgrade required on "+this.roomId):m.a.warn("Non-urgent upgrade required on "+this.roomId)),s}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(g.a.RoomTombstone,e)}getPendingEvents(){if("detached"!==this.opts.pendingEventOrdering)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if("detached"!==this.opts.pendingEventOrdering)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);const t=l.C(this.pendingEventList,(function(t){return t.getId()==e}),!1);return this.savePendingEvents(),t}hasPendingEvent(e){return"detached"===this.opts.pendingEventOrdering&&this.pendingEventList.some(t=>t.getId()===e)}getPendingEvent(e){return"detached"!==this.opts.pendingEventOrdering?null:this.pendingEventList.find(t=>t.getId()===e)}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}getLastActiveTimestamp(){const e=this.getLiveTimeline().getEvents();if(e.length){return e[e.length-1].getTs()}return Number.MIN_SAFE_INTEGER}getMyMembership(){return this.selfMembership}getDMInviter(){if(this.myUserId){const e=this.getMember(this.myUserId);if(e)return e.getDMInviter()}if("invite"===this.selfMembership){if(2==this.getInvitedAndJoinedMemberCount()&&this.summaryHeroes.length)return this.summaryHeroes[0]}}guessDMUserId(){const e=this.getMember(this.myUserId);if(e){const t=e.getDMInviter();if(t)return t}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];const t=this.currentState.getMembers().find(e=>e.userId!==this.myUserId);return t?t.userId:this.myUserId}getAvatarFallbackMember(){if(this.getInvitedAndJoinedMemberCount()>2)return;const e=Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length;if(e){const e=this.summaryHeroes.map(e=>this.getMember(e)).find(e=>!!e);if(e)return e}const t=this.currentState.getMembers();if(t.length<=2){const e=t.find(e=>e.userId!==this.myUserId);if(e)return e}if(e){const e=this.summaryHeroes.map(e=>this.client.getUser(e)).find(e=>!!e);if(e){const t=new u.a(this.roomId,e.userId);return t.user=e,t}}}updateMyMembership(e){const t=this.selfMembership;this.selfMembership=e,t!==e&&("leave"===e&&this.cleanupAfterLeaving(),this.emit("Room.myMembership",this,e,t))}async loadMembersFromServer(){const e=this.client.store.getSyncToken(),t=l.k({not_membership:"leave",at:e}),s=l.l("/rooms/$roomId/members?"+t,{$roomId:this.roomId}),n=this.client.http;return(await n.authedRequest(void 0,"GET",s)).chunk}async loadMembers(){let e=!1,t=await this.client.store.getOutOfBandMembers(this.roomId);null===t&&(e=!0,t=await this.loadMembersFromServer(),m.a.log(`LL: got ${t.length} members from server for room `+this.roomId));return{memberEvents:t.map(this.client.getEventMapper()),fromServer:e}}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();const e=this.loadMembers().then(e=>(this.currentState.setOutOfBandMembers(e.memberEvents),this.client.isCryptoEnabled()&&this.client.isRoomEncrypted(this.roomId)&&this.client.crypto.trackRoomDevices(this.roomId),e.fromServer)).catch(e=>{throw this.membersPromise=null,this.currentState.markOutOfBandMembersFailed(),e});return e.then(e=>{if(e){const e=this.currentState.getMembers().filter(e=>e.isOutOfBand()).map(e=>e.events.member.event);m.a.log("LL: telling store to write "+e.length+" members for room "+this.roomId);return this.client.store.setOutOfBandMembers(this.roomId,e).catch(e=>{m.a.log("LL: storing OOB room members failed, oh well",e)})}}).catch(e=>{m.a.error(e)}),this.membersPromise=e,this.membersPromise}async clearLoadedMembersIfNeeded(){this.opts.lazyLoadMembers&&this.membersPromise&&(await this.loadMembersIfNeeded(),await this.client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this.membersPromise=null)}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{m.a.error(`error after clearing loaded members from room ${this.roomId} after leaving`),m.a.log(e)})}resetLiveTimeline(e,t){for(let s=0;s<this.timelineSets.length;s++)this.timelineSets[s].resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(r.a.BACKWARDS),this.currentState=this.getLiveTimeline().getState(r.a.FORWARDS)}async hasUnverifiedDevices(){if(!this.client.isRoomEncrypted(this.roomId))return!1;const e=await this.getEncryptionTargetMembers();for(const t of e){if(this.client.getStoredDevicesForUser(t.userId).some(e=>e.isUnverified()))return!0}return!1}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){return this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}findEventById(e){return this.getUnfilteredTimelineSet().findEventById(e)}getUnreadNotificationCount(e=E.Total){return this.notificationCounts[e]}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t}setSummary(e){const t=e["m.heroes"],s=e["m.joined_member_count"],n=e["m.invited_member_count"];Number.isInteger(s)&&this.currentState.setJoinedMemberCount(s),Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),Array.isArray(t)&&(this.summaryHeroes=t.filter(e=>e!==this.myUserId))}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices}getAvatarUrl(e,t,s,n,i=!0){const o=this.currentState.getStateEvents(g.a.RoomAvatar,"");if(!o&&!i)return null;const a=o?o.getContent().url:null;return a?Object(c.a)(e,a,t,s,n):null}getMxcAvatarUrl(){var e,t;return(null===(e=this.currentState.getStateEvents(g.a.RoomAvatar,""))||void 0===e||null===(t=e.getContent())||void 0===t?void 0:t.url)||null}getAliases(){const e=[],t=this.currentState.getStateEvents(g.a.RoomAliases);if(t)for(let s=0;s<t.length;++s){const n=t[s];if(Array.isArray(n.getContent().aliases)){const t=n.getContent().aliases.filter(e=>"string"==typeof e&&("#"===e[0]&&!!e.endsWith(":"+n.getStateKey())));Array.prototype.push.apply(e,t)}}return e}getCanonicalAlias(){const e=this.currentState.getStateEvents(g.a.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){const e=this.currentState.getStateEvents(g.a.RoomCanonicalAlias,"");return e&&e.getContent().alt_aliases||[]}addEventsToTimeline(e,t,s,n){s.getTimelineSet().addEventsToTimeline(e,t,s,n)}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership("join")}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter((function(t){return t.membership===e}))}async getEncryptionTargetMembers(){await this.loadMembersIfNeeded();let e=this.getMembersWithMembership("join");return this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership("invite"))),e}shouldEncryptForInvitedMembers(){var e;const t=this.currentState.getStateEvents(g.a.RoomHistoryVisibility,"");return"joined"!==(null==t||null===(e=t.getContent())||void 0===e?void 0:e.history_visibility)}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){const s=this.getMember(e);return!!s&&s.membership===t}getOrCreateFilteredTimelineSet(e){if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];const t=Object.assign({filter:e},this.opts),s=new a.a(this,t);this.reEmitter.reEmit(s,["Room.timeline","Room.timelineReset"]),this.filteredTimelineSets[e.filterId]=s,this.timelineSets.push(s);const n=this.getLiveTimeline();n.getEvents().forEach((function(e){s.addLiveEvent(e)}));let i=n;for(;i.getNeighbouringTimeline(r.a.BACKWARDS);)i=i.getNeighbouringTimeline(r.a.BACKWARDS);return s.getLiveTimeline().setPaginationToken(i.getPaginationToken(r.a.BACKWARDS),r.a.BACKWARDS),s}removeFilteredTimelineSet(e){const t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];const s=this.timelineSets.indexOf(t);s>-1&&this.timelineSets.splice(s,1)}addLiveEvent(e,t,s=!1){if(e.isRedaction()){const t=e.event.redacts,s=this.getUnfilteredTimelineSet().findEventById(t);if(s){if(s.makeRedacted(e),s.getStateKey()){this.currentState.getStateEvents(s.getType(),s.getStateKey()).getId()===s.getId()&&this.currentState.setStateEvents([s])}this.emit("Room.redaction",e,this)}}if(e.getUnsigned().transaction_id){const t=this.txnToEvent[e.getUnsigned().transaction_id];if(t)return void this.handleRemoteEcho(e,t)}for(let n=0;n<this.timelineSets.length;n++)this.timelineSets[n].addLiveEvent(e,t,s);e.sender&&e.getType()!==g.a.RoomRedaction&&this.addReceipt(_(e.sender.userId,e,"m.read"),!0)}addPendingEvent(e,t){if(e.status!==d.a.SENDING&&e.status!==d.a.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent[t])throw new Error("addPendingEvent called on an event with known txnId "+t);if(r.a.setEventMetadata(e,this.getLiveTimeline().getState(r.a.FORWARDS),!1),this.txnToEvent[t]=e,"detached"==this.opts.pendingEventOrdering){if(this.pendingEventList.some(e=>e.status===d.a.NOT_SENT)&&(m.a.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(d.a.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){const t=e.event.redacts;let s=this.pendingEventList&&this.pendingEventList.find(e=>e.getId()===t);s||(s=this.getUnfilteredTimelineSet().findEventById(t)),s&&(s.markLocallyRedacted(e),this.emit("Room.redaction",e,this))}}else for(let t=0;t<this.timelineSets.length;t++){const s=this.timelineSets[t];s.getFilter()?s.getFilter().filterRoomTimeline([e]).length&&s.addEventToTimeline(e,s.getLiveTimeline(),!1):s.addEventToTimeline(e,s.getLiveTimeline(),!1)}this.emit("Room.localEchoUpdated",e,this,null,null)}savePendingEvents(){if(this.pendingEventList){const e=this.pendingEventList.map(e=>b(b({},e.event),{},{txn_id:e.getTxnId()})).filter(e=>{const t=e.type===g.a.RoomMessageEncrypted,s=this.client.isRoomEncrypted(this.roomId);return t||!s}),{store:t}=this.client.sessionStore;this.pendingEventList.length>0?t.setItem(w(this.roomId),JSON.stringify(e)):t.removeItem(w(this.roomId))}}aggregateNonLiveRelation(e){for(let t=0;t<this.timelineSets.length;t++){const s=this.timelineSets[t];s.getFilter()?s.getFilter().filterRoomTimeline([e]).length&&s.aggregateRelations(e):s.aggregateRelations(e)}}handleRemoteEcho(e,t){const s=t.getId(),n=e.getId(),i=t.status;m.a.debug(`Got remote echo for event ${s} -> ${n} old status `+i),delete this.txnToEvent[e.getUnsigned().transaction_id],this.pendingEventList&&this.removePendingEvent(s),t.handleRemoteEcho(e.event);for(let e=0;e<this.timelineSets.length;e++){this.timelineSets[e].handleRemoteEcho(t,s,n)}this.emit("Room.localEchoUpdated",t,this,s,i)}updatePendingEvent(e,t,s){if(m.a.log(`setting pendingEvent status to ${t} in ${e.getRoomId()} event ID ${e.getId()} -> ${s}`),t==d.a.SENT&&!s)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==d.a.SENT){if(this.getUnfilteredTimelineSet().eventIdToTimeline(s))return}const n=e.status,i=e.getId();if(!n)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");const o=C[n];if(!o||o.indexOf(t)<0)throw new Error("Invalid EventStatus transition "+n+"->"+t);if(e.setStatus(t),t==d.a.SENT){e.replaceLocalEventId(s);for(let e=0;e<this.timelineSets.length;e++)this.timelineSets[e].replaceEventId(i,s)}else if(t==d.a.CANCELLED){if(this.pendingEventList){const e=this.pendingEventList.findIndex(e=>e.getId()===i);if(-1!==e){const[t]=this.pendingEventList.splice(e,1);t.isRedaction()&&this.revertRedactionLocalEcho(t)}}this.removeEvent(i)}this.savePendingEvents(),this.emit("Room.localEchoUpdated",e,this,i,n)}revertRedactionLocalEcho(e){const t=e.event.redacts;if(!t)return;const s=this.getUnfilteredTimelineSet().findEventById(t);s&&(s.unmarkLocallyRedacted(),this.emit("Room.redactionCancelled",e,this),s.isRelation()&&this.aggregateNonLiveRelation(s))}addLiveEvents(e,t,s=!1){let n;if(t&&-1===["replace","ignore"].indexOf(t))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(n=0;n<this.timelineSets.length;n++){const e=this.timelineSets[n].getLiveTimeline();if(e.getPaginationToken(r.a.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a pagination token ("+e.getPaginationToken(r.a.FORWARDS)+")");if(e.getNeighbouringTimeline(r.a.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a neighbouring timeline")}for(n=0;n<e.length;n++)this.addLiveEvent(e[n],t,s)}addEphemeralEvents(e){for(const t of e)"m.typing"===t.getType()?this.currentState.setTypingEvent(t):"m.receipt"===t.getType()&&this.addReceipt(t)}removeEvents(e){for(let t=0;t<e.length;++t)this.removeEvent(e[t])}removeEvent(e){let t=!1;for(let s=0;s<this.timelineSets.length;s++){const n=this.timelineSets[s].removeEvent(e);n&&(n.isRedaction()&&this.revertRedactionLocalEcho(n),t=!0)}return t}recalculate(){const e=this.currentState.getStateEvents(g.a.RoomMember,this.myUserId);if(e&&"invite"===e.getContent().membership){(e.getUnsigned().invite_room_state||[]).forEach(e=>{this.currentState.getStateEvents(e.type,e.state_key)||this.currentState.setStateEvents([new d.b({type:e.type,state_key:e.state_key,content:e.content,event_id:"$fake"+Date.now(),room_id:this.roomId,user_id:this.myUserId})])})}const t=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=Object(l.x)(this.name),this.summary=new h(this.roomId,{title:this.name}),t!==this.name&&this.emit("Room.name",this)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter((function(e){return"m.read"===e.type})).map((function(e){return e.userId}))}getEventReadUpTo(e,t=!1){let s=this.receipts;return t&&(s=this.realReceipts),void 0===s["m.read"]||void 0===s["m.read"][e]?null:s["m.read"][e].eventId}hasUserReadEvent(e,t){const s=this.getEventReadUpTo(e,!1);if(s===t)return!0;if(this.timeline.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===e)return!0;for(let e=this.timeline.length-1;e>=0;--e){const n=this.timeline[e];if(n.getId()===t)return!1;if(n.getId()===s)return!0}return!1}getReceiptsForEvent(e){return this.receiptCacheByEventId[e.getId()]||[]}addReceipt(e,t=!1){t||this.addReceiptsToStructure(e,this.realReceipts),this.addReceiptsToStructure(e,this.receipts),this.receiptCacheByEventId=this.buildReceiptCache(this.receipts),this.emit("Room.receipt",e,this)}addReceiptsToStructure(e,t){const s=e.getContent();Object.keys(s).forEach(e=>{Object.keys(s[e]).forEach(n=>{Object.keys(s[e][n]).forEach(i=>{const o=s[e][n][i];t[n]||(t[n]={});const a=t[n][i];if(a){const t=this.getUnfilteredTimelineSet().compareEventOrdering(a.eventId,e);if(null!==t&&t>=0)return}else t[n][i]={};t[n][i]={eventId:e,data:o}})})})}buildReceiptCache(e){const t={};return Object.keys(e).forEach((function(s){Object.keys(e[s]).forEach((function(n){const i=e[s][n];t[i.eventId]||(t[i.eventId]=[]),t[i.eventId].push({userId:n,type:s,data:i.data})}))})),t}addLocalEchoReceipt(e,t,s){this.addReceipt(_(e,t,s),!0)}addTags(e){this.tags=e.getContent().tags||{},this.emit("Room.tags",e,this)}addAccountData(e){for(let t=0;t<e.length;t++){const s=e[t];"m.tag"===s.getType()&&this.addTags(s);const n=this.accountData[s.getType()];this.accountData[s.getType()]=s,this.emit("Room.accountData",s,this,n)}}getAccountData(e){return this.accountData[e]}maySendMessage(){return"join"===this.getMyMembership()&&this.currentState.maySendEvent(g.a.RoomMessage,this.myUserId)}canInvite(e){let t="join"===this.getMyMembership();const s=this.currentState.getStateEvents(g.a.RoomPowerLevels,""),n=s&&s.getContent(),i=this.getMember(e);return n&&i&&n.invite>i.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getType(){const e=this.currentState.getStateEvents(g.a.RoomCreate,"");if(e)return e.getContent()[g.d];this.getTypeWarning||(m.a.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0)}isSpaceRoom(){return this.getType()===g.e.Space}calculateRoomName(e,t=!1){if(!t){const e=this.currentState.getStateEvents(g.a.RoomName,"");if(e&&e.getContent()&&e.getContent().name)return e.getContent().name}let s=this.getCanonicalAlias();if(!s){const e=this.getAltAliases();e.length&&(s=e[0])}if(s)return s;const n=this.currentState.getJoinedMemberCount()+this.currentState.getInvitedMemberCount()-1;let i=null;if(this.summaryHeroes)i=this.summaryHeroes.map(e=>{const t=this.getMember(e);return t?t.name:e});else{let t=this.currentState.getMembers().filter(t=>t.userId!==e&&("invite"===t.membership||"join"===t.membership));t.sort((e,t)=>e.userId.localeCompare(t.userId)),t=t.slice(0,5),i=t.map(e=>e.name)}if(n)return k(i,n);if("join"==this.getMyMembership()){const e=this.currentState.getStateEvents(g.a.RoomThirdPartyInvite);if(e&&e.length){return"Inviting "+k(e.map(e=>e.getContent().display_name))}}let o=i;return o.length||(o=this.currentState.getMembers().filter(t=>t.userId!==e&&"invite"!==t.membership&&"join"!==t.membership).map(e=>e.name)),o.length?`Empty room (was ${k(o)})`:"Empty room"}}function w(e){return"mx_pending_events_"+e}const C={};function k(e,t=e.length+1){const s=t-1;if(e.length){if(1===e.length&&s<=1)return e[0];if(2===e.length&&s<=2)return`${e[0]} and ${e[1]}`;return s>1?`${e[0]} and ${s} others`:e[0]+" and 1 other"}return"Empty room"}C[d.a.ENCRYPTING]=[d.a.SENDING,d.a.NOT_SENT],C[d.a.SENDING]=[d.a.ENCRYPTING,d.a.QUEUED,d.a.NOT_SENT,d.a.SENT],C[d.a.QUEUED]=[d.a.SENDING,d.a.CANCELLED],C[d.a.SENT]=[],C[d.a.NOT_SENT]=[d.a.SENDING,d.a.QUEUED,d.a.CANCELLED],C[d.a.CANCELLED]=[]},function(e,t,s){"use strict";var n=s(18),i=s.n(n),o=s(118),a=s(8),r=s(168),c=s(167),l=s(94),d=s(149),u=s(98),h=s(106);class m extends a.EventEmitter{constructor(...e){super(...e),i()(this,"crawlerCheckpoints",[]),i()(this,"crawler",null),i()(this,"currentCheckpoint",null),i()(this,"onSync",async(e,t,s)=>{const n=o.a.get().getEventIndexingManager();if("PREPARED"===t&&"SYNCING"===e){return await n.isEventIndexEmpty()&&await this.addInitialCheckpoints(),void this.startCrawler()}"SYNCING"!==t||"SYNCING"!==e||await n.commitLiveEvents()}),i()(this,"onRoomTimeline",async(e,t,s,n,i)=>{const o=l.a.get();o.isRoomEncrypted(t.roomId)&&!s&&i&&i.liveEvent&&!e.isRedacted()&&(await o.decryptEventIfNeeded(e),await this.addLiveEventToIndex(e))}),i()(this,"onRoomStateEvent",async(e,t)=>{l.a.get().isRoomEncrypted(t.roomId)&&("m.room.encryption"!==e.getType()||await this.isRoomIndexed(t.roomId)||(console.log("EventIndex: Adding a checkpoint for a newly encrypted room",t.roomId),this.addRoomCheckpoint(t.roomId,!0)))}),i()(this,"onEventDecrypted",async(e,t)=>{t||await this.addLiveEventToIndex(e)}),i()(this,"onRedaction",async(e,t)=>{if(!l.a.get().isRoomEncrypted(t.roomId))return;const s=o.a.get().getEventIndexingManager();try{await s.deleteEvent(e.getAssociatedId())}catch(e){console.log("EventIndex: Error deleting event from index",e)}}),i()(this,"onTimelineReset",async(e,t,s)=>{null!==e&&l.a.get().isRoomEncrypted(e.roomId)&&(console.log("EventIndex: Adding a checkpoint because of a limited timeline",e.roomId),this.addRoomCheckpoint(e.roomId,!1))})}async init(){const e=o.a.get().getEventIndexingManager();this.crawlerCheckpoints=await e.loadCheckpoints(),console.log("EventIndex: Loaded checkpoints",this.crawlerCheckpoints),this.registerListeners()}registerListeners(){const e=l.a.get();e.on("sync",this.onSync),e.on("Room.timeline",this.onRoomTimeline),e.on("Event.decrypted",this.onEventDecrypted),e.on("Room.timelineReset",this.onTimelineReset),e.on("Room.redaction",this.onRedaction),e.on("RoomState.events",this.onRoomStateEvent)}removeListeners(){const e=l.a.get();null!==e&&(e.removeListener("sync",this.onSync),e.removeListener("Room.timeline",this.onRoomTimeline),e.removeListener("Event.decrypted",this.onEventDecrypted),e.removeListener("Room.timelineReset",this.onTimelineReset),e.removeListener("Room.redaction",this.onRedaction),e.removeListener("RoomState.events",this.onRoomStateEvent))}async addInitialCheckpoints(){const e=o.a.get().getEventIndexingManager(),t=l.a.get(),s=t.getRooms().filter(e=>t.isRoomEncrypted(e.roomId));console.log("EventIndex: Adding initial crawler checkpoints"),await Promise.all(s.map(async t=>{const s=t.getLiveTimeline().getPaginationToken("b"),n={roomId:t.roomId,token:s,direction:"b",fullCrawl:!0},i={roomId:t.roomId,token:s,direction:"f"};try{n.token&&(await e.addCrawlerCheckpoint(n),this.crawlerCheckpoints.push(n)),i.token&&(await e.addCrawlerCheckpoint(i),this.crawlerCheckpoints.push(i))}catch(e){console.log("EventIndex: Error adding initial checkpoints for room",t.roomId,n,i,e)}}))}isValidEvent(e){const t=["m.room.message","m.room.name","m.room.topic"].includes(e.getType())&&!e.isRedacted()&&!e.isDecryptionFailure();let s=!0,n=!0;if("m.room.message"!==e.getType()||e.isRedacted())"m.room.topic"!==e.getType()||e.isRedacted()?"m.room.name"!==e.getType()||e.isRedacted()||e.getContent().name||(n=!1):e.getContent().topic||(n=!1);else{const t=e.getContent().msgtype;s=!!t&&!t.startsWith("m.key.verification"),e.getContent().body||(n=!1)}return t&&s&&n}eventToJson(e){const t=e.toJSON(),s=e.isEncrypted()?t.decrypted:t;return e.isEncrypted()?(s.curve25519Key=e.getSenderKey(),s.ed25519Key=e.getClaimedEd25519Key(),s.algorithm=e.getWireContent().algorithm,s.forwardingCurve25519KeyChain=e.getForwardingCurve25519KeyChain()):(delete s.curve25519Key,delete s.ed25519Key,delete s.algorithm,delete s.forwardingCurve25519KeyChain),s}async addLiveEventToIndex(e){const t=o.a.get().getEventIndexingManager();if(!this.isValidEvent(e))return;const s=this.eventToJson(e),n={displayname:e.sender.rawDisplayName,avatar_url:e.sender.getMxcAvatarUrl()};await t.addEventToIndex(s,n)}emitNewCheckpoint(){this.emit("changedCheckpoint",this.currentRoom())}async addEventsFromLiveTimeline(e){const t=e.getEvents();for(let e=0;e<t.length;e++){const s=t[e];await this.addLiveEventToIndex(s)}}async addRoomCheckpoint(e,t=!1){const s=o.a.get().getEventIndexingManager(),n=l.a.get().getRoom(e);if(!n)return;const i=n.getLiveTimeline(),a=i.getPaginationToken("b");if(!a)return void await this.addEventsFromLiveTimeline(i);const r={roomId:n.roomId,token:a,fullCrawl:t,direction:"b"};console.log("EventIndex: Adding checkpoint",r);try{await s.addCrawlerCheckpoint(r)}catch(e){console.log("EventIndex: Error adding new checkpoint for room",n.roomId,r,e)}this.crawlerCheckpoints.push(r)}async crawlerFunc(){let e=!1;const t=l.a.get(),s=o.a.get().getEventIndexingManager();this.crawler={cancel:()=>{e=!0}};let n=!1;for(;!e;){let i=u.b.getValueAt(h.a.DEVICE,"crawlerSleepTime");if(i=Math.max(i,100),n&&(i=5e3),null!==this.currentCheckpoint&&(this.currentCheckpoint=null,this.emitNewCheckpoint()),await Object(d.c)(i),e)break;const o=this.crawlerCheckpoints.shift();if(void 0===o){n=!0;continue}this.currentCheckpoint=o,this.emitNewCheckpoint(),n=!1;const a=t.getEventMapper({preventReEmit:!0});let r;try{r=await t.createMessagesRequest(o.roomId,o.token,100,o.direction)}catch(e){if(403===e.httpStatus){console.log("EventIndex: Removing checkpoint as we don't have ","permissions to fetch messages from this room.",o);try{await s.removeCrawlerCheckpoint(o)}catch(e){console.log("EventIndex: Error removing checkpoint",o,e)}continue}console.log("EventIndex: Error crawling using checkpoint:",o,",",e),this.crawlerCheckpoints.push(o);continue}if(e){this.crawlerCheckpoints.push(o);break}if(0===r.chunk.length){console.log("EventIndex: Done with the checkpoint",o);try{await s.removeCrawlerCheckpoint(o)}catch(e){console.log("EventIndex: Error removing checkpoint",o,e)}continue}const c=r.chunk.map(a);let l=[];void 0!==r.state&&(l=r.state.map(a));const m={};l.forEach(e=>{e.event.content&&"join"===e.event.content.membership&&(m[e.event.sender]={displayname:e.event.content.displayname,avatar_url:e.event.content.avatar_url})});const p=c.filter(e=>e.isEncrypted()).map(e=>t.decryptEventIfNeeded(e,{isRetry:!0,emit:!1}));await Promise.all(p);const g=c.filter(this.isValidEvent),v=c.filter(e=>"m.room.redaction"===e.getType()),f=g.map(e=>{const t=this.eventToJson(e);let s={};t.sender in m&&(s=m[t.sender]);return{event:t,profile:s}});let b;r.end&&(b={roomId:o.roomId,token:r.end,fullCrawl:o.fullCrawl,direction:o.direction});try{for(let e=0;e<v.length;e++){const t=v[e],n=t.getAssociatedId();n?await s.deleteEvent(n):console.warn("EventIndex: Redaction event doesn't contain a valid associated event id",t)}const e=await s.addHistoricEvents(f,b,o);if(!b){console.log("EventIndex: The server didn't return a valid ","new checkpoint, not continuing the crawl.",o);continue}!0===e&&!0!==b.fullCrawl?(console.log("EventIndex: Checkpoint had already all events","added, stopping the crawl",o),await s.removeCrawlerCheckpoint(b)):(!0===e&&console.log("EventIndex: Checkpoint had already all events","added, but continuing due to a full crawl",o),this.crawlerCheckpoints.push(b))}catch(e){console.log("EventIndex: Error durring a crawl",e),this.crawlerCheckpoints.push(o)}}this.crawler=null}startCrawler(){null===this.crawler&&this.crawlerFunc()}stopCrawler(){null!==this.crawler&&this.crawler.cancel()}async close(){const e=o.a.get().getEventIndexingManager();this.removeListeners(),this.stopCrawler(),await e.closeEventIndex()}async search(e){return o.a.get().getEventIndexingManager().searchEventIndex(e)}async loadFileEvents(e,t=10,s=null,n=c.a.BACKWARDS){const i=l.a.get(),a=o.a.get().getEventIndexingManager(),d={roomId:e.roomId,limit:t};let u;s&&(d.fromEvent=s,d.direction=n);try{u=await a.loadFileEvents(d)}catch(e){return console.log("EventIndex: Error getting file events",e),[]}const h=i.getEventMapper();return u.map(t=>{const s=h(t.event),n=new r.a(e.roomId,s.getSender());n.name=t.profile.displayname+" ("+s.getSender()+")";const i=h({content:{membership:"join",avatar_url:t.profile.avatar_url,displayname:t.profile.displayname},type:"m.room.member",event_id:s.getId()+":eventIndex",room_id:s.getRoomId(),sender:s.getSender(),origin_server_ts:s.getTs(),state_key:s.getSender()});return n.events.member=i,s.sender=n,s})}async populateFileTimeline(e,t,s,n=10,i=null,o=c.a.BACKWARDS){const a=await this.loadFileEvents(s,n,i,o);null===i&&(a.reverse(),o=o==c.a.BACKWARDS?c.a.FORWARDS:c.a.BACKWARDS),a.forEach(s=>{e.eventIdToTimeline(s.getId())||e.addEventToTimeline(s,t,o==c.a.BACKWARDS)});let r=!1,l="";return a.length>0&&(l=a[a.length-1].getId(),r=!0),console.log("EventIndex: Populating file panel with",a.length,"events and setting the pagination token to",l),t.setPaginationToken(l,c.a.BACKWARDS),r}paginateTimelineWindow(e,t,s,n){const i=t.getTimelineIndex(s);if(!i)return Promise.resolve(!1);if(i.pendingPaginate)return i.pendingPaginate;if(t.extend(s,n))return Promise.resolve(!0);const o=(async(e,t,s,n,i)=>{const o=e._timelineSet,a=t.timeline.getPaginationToken(n),r=await this.populateFileTimeline(o,t.timeline,s,i,a,n);return t.pendingPaginate=null,e.extend(n,i),r})(t,i,e,s,n);return i.pendingPaginate=o,o}async getStats(){return o.a.get().getEventIndexingManager().getStats()}async isRoomIndexed(e){return o.a.get().getEventIndexingManager().isRoomIndexed(e)}currentRoom(){if(null===this.currentCheckpoint&&0===this.crawlerCheckpoints.length)return null;const e=l.a.get();return null!==this.currentCheckpoint?e.getRoom(this.currentCheckpoint.roomId):e.getRoom(this.crawlerCheckpoints[0].roomId)}crawlingRooms(){const e=new Set,t=new Set;this.crawlerCheckpoints.forEach((e,s)=>{t.add(e.roomId)}),null!==this.currentCheckpoint&&t.add(this.currentCheckpoint.roomId);const s=l.a.get();return s.getRooms().filter(e=>s.isRoomEncrypted(e.roomId)).forEach((t,s)=>{e.add(t.roomId)}),{crawlingRooms:t,totalRooms:e}}}class p{constructor(){i()(this,"index",null),i()(this,"error",null),i()(this,"_supportIsInstalled",!1)}async init(){const e=o.a.get().getEventIndexingManager();return e?(this._supportIsInstalled=await e.supportsEventIndexing(),this.supportIsInstalled()?u.b.getValueAt(h.a.DEVICE,"enableEventIndexing")?this.initEventIndex():(console.log("EventIndex: Event indexing is disabled, not initializing"),!1):(console.log("EventIndex: Event indexing isn't installed for the platform, not initializing."),!1)):(console.log("EventIndex: Platform doesn't support event indexing, not initializing."),!1)}async initEventIndex(){const e=new m,t=o.a.get().getEventIndexingManager(),s=l.a.get(),n=s.getUserId(),i=s.getDeviceId();try{await t.initEventIndex(n,i);const s=await t.getUserVersion(),o=await t.isEventIndexEmpty();o?await t.setUserVersion(1):0!==s||o||(await t.closeEventIndex(),await this.deleteEventIndex(),await t.initEventIndex(n,i),await t.setUserVersion(1)),console.log("EventIndex: Successfully initialized the event index"),await e.init()}catch(e){return console.log("EventIndex: Error initializing the event index",e),this.error=e,!1}return this.index=e,!0}platformHasSupport(){return null!==o.a.get().getEventIndexingManager()}supportIsInstalled(){return this._supportIsInstalled}get(){return this.index}start(){null!==this.index&&this.index.startCrawler()}stop(){null!==this.index&&this.index.stopCrawler()}async unset(){null!==this.index&&(await this.index.close(),this.index=null)}async deleteEventIndex(){const e=o.a.get().getEventIndexingManager();null!==e&&(await this.unset(),console.log("EventIndex: Deleting event index."),await e.deleteEventIndex())}}window.mxEventIndexPeg||(window.mxEventIndexPeg=new p);t.a=window.mxEventIndexPeg},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{}},function(e,t,s){"use strict";let n,i;s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i})),function(e){e.Manual="MANUAL",e.Alphabetic="ALPHABETIC",e.Recent="RECENT"}(n||(n={})),function(e){e.Importance="IMPORTANCE",e.Natural="NATURAL"}(i||(i={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return x}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(95),u=s(92),h=s(97),m=s.n(h),p=s(96),g=s(150),v=s(114),f=s(122),b=s(98),y=s(155),_=s(789),E=s.n(_),S=s(105),w=s(103),C=s(305),k=s.n(C),O=s(116),R=s(134),I=s(93);let x=Object(I.a)("views.elements.ReplyThread")((o=i=class e extends l.a.Component{constructor(e,t){super(e,t),r()(this,"updateForEventId",e=>{this.state.events.some(t=>t.getId()===e)&&this.forceUpdate()}),r()(this,"onEventReplaced",e=>{this.unmounted||this.updateForEventId(e.getId())}),r()(this,"onRoomRedaction",e=>{if(this.unmounted)return;const t=e.getAssociatedId();t&&this.updateForEventId(t)}),this.state={events:[],loadedEv:null,loading:!0,err:!1},this.unmounted=!1,this.context.on("Event.replaced",this.onEventReplaced),this.room=this.context.getRoom(this.props.parentEv.getRoomId()),this.room.on("Room.redaction",this.onRoomRedaction),this.room.on("Room.redactionCancelled",this.onRoomRedaction),this.onQuoteClick=this.onQuoteClick.bind(this),this.canCollapse=this.canCollapse.bind(this),this.collapse=this.collapse.bind(this)}static getParentEventId(e){if(!e||e.isRedacted())return;const t=e.getWireContent()["m.relates_to"];if(t&&t["m.in_reply_to"]){const e=t["m.in_reply_to"];if(e&&e.event_id)return e.event_id}}static stripPlainReply(e){const t=e.split("\n");for(;t.length&&t[0].startsWith("> ");)t.shift();return""===t[0]&&t.shift(),t.join("\n")}static stripHTMLReply(e){return k()(e,{allowedTags:!1,allowedAttributes:!1,allowedSchemes:[...R.a,"mxc"],exclusiveFilter:e=>"mx-reply"===e.tag})}static getNestedReplyText(e,t){if(!e)return null;let{body:s,formatted_body:n}=e.getContent();this.getParentEventId(e)&&s&&(s=this.stripPlainReply(s)),s||(s=""),n=n?this.stripHTMLReply(n):E()(s).replace(/\n/g,"<br/>");const i=t.forEvent(e.getId()),o=Object(f.h)(e.getSender()),a=e.getSender();switch(e.getContent().msgtype){case"m.text":case"m.notice":{n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${o}">${a}</a><br>${n}</blockquote></mx-reply>`;const e=s.trim().split("\n");e.length>0&&(e[0]=`<${a}> ${e[0]}`,s=e.map(e=>"> "+e).join("\n")+"\n\n");break}case"m.image":n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${o}">${a}</a><br>sent an image.</blockquote></mx-reply>`,s=`> <${a}> sent an image.\n\n`;break;case"m.video":n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${o}">${a}</a><br>sent a video.</blockquote></mx-reply>`,s=`> <${a}> sent a video.\n\n`;break;case"m.audio":n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${o}">${a}</a><br>sent an audio file.</blockquote></mx-reply>`,s=`> <${a}> sent an audio file.\n\n`;break;case"m.file":n=`<mx-reply><blockquote><a href="${i}">In reply to</a> <a href="${o}">${a}</a><br>sent a file.</blockquote></mx-reply>`,s=`> <${a}> sent a file.\n\n`;break;case"m.emote":{n=`<mx-reply><blockquote><a href="${i}">In reply to</a> * <a href="${o}">${a}</a><br>${n}</blockquote></mx-reply>`;const e=s.trim().split("\n");e.length>0&&(e[0]=`* <${a}> ${e[0]}`,s=e.map(e=>"> "+e).join("\n")+"\n\n");break}default:return null}return{body:s,html:n}}static makeReplyMixIn(e){return e?{"m.relates_to":{"m.in_reply_to":{event_id:e.getId()}}}:{}}static makeThread(t,s,n,i,o,a){return e.getParentEventId(t)?l.a.createElement(e,{parentEv:t,onHeightChanged:s,ref:i,permalinkCreator:n,layout:o,alwaysShowTimestamps:a}):null}componentDidMount(){this.initialize()}componentDidUpdate(){this.props.onHeightChanged()}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("Event.replaced",this.onEventReplaced),this.room&&(this.room.removeListener("Room.redaction",this.onRoomRedaction),this.room.removeListener("Room.redactionCancelled",this.onRoomRedaction))}async initialize(){const{parentEv:t}=this.props,s=await this.getEvent(e.getParentEventId(t));if(!this.unmounted)if(s){const e=await this.getNextEvent(s);this.setState({events:[s],loadedEv:e,loading:!1})}else this.setState({err:!0})}async getNextEvent(t){try{const s=e.getParentEventId(t);return await this.getEvent(s)}catch(e){return null}}async getEvent(e){if(!e)return null;const t=this.room.findEventById(e);if(t)return t;try{await this.context.getEventTimeline(this.room.getUnfilteredTimelineSet(),e)}catch(e){return null}return this.room.findEventById(e)}canCollapse(){return this.state.events.length>1}collapse(){this.initialize()}async onQuoteClick(){const e=[this.state.loadedEv,...this.state.events];let t=null;e.length>0&&(t=await this.getNextEvent(e[0])),this.setState({loadedEv:t,events:e}),p.a.fire(w.a.FocusComposer)}render(){let e=null;if(this.state.err)e=l.a.createElement("blockquote",{className:"mx_ReplyThread mx_ReplyThread_error"},Object(u.a)("Unable to load event that was replied to, it either does not exist or you do not have permission to view it."));else if(this.state.loadedEv){const t=this.state.loadedEv,s=d.getComponent("elements.Pill"),n=this.context.getRoom(t.getRoomId());e=l.a.createElement("blockquote",{className:"mx_ReplyThread"},Object(u.a)("<a>In reply to</a> <pill>",{},{a:e=>l.a.createElement("a",{onClick:this.onQuoteClick,className:"mx_ReplyThread_show"},e),pill:l.a.createElement(s,{type:s.TYPE_USER_MENTION,room:n,url:Object(f.h)(t.getSender()),shouldShowPillAvatar:b.b.getValue("Pill.shouldShowPillAvatar")})}))}else if(this.state.loading){const t=d.getComponent("elements.Spinner");e=l.a.createElement(t,{w:16,h:16})}const t=d.getComponent("views.rooms.EventTile"),s=d.getComponent("messages.DateSeparator"),n=this.state.events.map(e=>{let n=null;return Object(g.f)(this.props.parentEv.getDate(),e.getDate())&&(n=l.a.createElement("a",{href:this.props.url},l.a.createElement(s,{ts:e.getTs()}))),l.a.createElement("blockquote",{className:"mx_ReplyThread",key:e.getId()},n,l.a.createElement(t,{mxEvent:e,tileShape:"reply",onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator,isRedacted:e.isRedacted(),isTwelveHour:b.b.getValue("showTwelveHourTimestamps"),layout:this.props.layout,alwaysShowTimestamps:this.props.alwaysShowTimestamps,enableFlair:b.b.getValue(O.a.Flair),replacingEventId:e.replacingEventId(),as:"div"}))});return l.a.createElement("div",{className:"mx_ReplyThread_wrapper"},l.a.createElement("div",null,e),l.a.createElement("div",null,n))}},r()(i,"propTypes",{parentEv:m.a.instanceOf(v.b),onHeightChanged:m.a.func.isRequired,permalinkCreator:m.a.instanceOf(f.a).isRequired,layout:y.b,alwaysShowTimestamps:m.a.bool}),r()(i,"contextType",S.a),n=o))||n},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return a}));var n=s(136),i=s.n(n);function o(e){if(!e)return"";const t=i.a.parse(e);return t&&"/"===t.path?t.host:e}function a(e){if(!e)return"";let t=e;e.startsWith("https://")||(t="https://"+e);return null===i.a.parse(t).hostname?e:t}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(1),i=s(8);function o(e){this.groupId=e,this.name=null,this.avatarUrl=null,this.myMembership=null,this.inviter=null}n.r(o,i.EventEmitter),o.prototype.setProfile=function(e,t){this.name===e&&this.avatarUrl===t||(this.name=e||this.groupId,this.avatarUrl=t,this.emit("Group.profile",this))},o.prototype.setMyMembership=function(e){this.myMembership!==e&&(this.myMembership=e,this.emit("Group.myMembership",this))},o.prototype.setInviter=function(e){this.inviter=e}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(0),i=s(136);class o{static get ERROR_INVALID(){return"Invalid homeserver discovery response"}static get ERROR_GENERIC_FAILURE(){return"Failed to get autodiscovery configuration from server"}static get ERROR_INVALID_HS_BASE_URL(){return"Invalid base_url for m.homeserver"}static get ERROR_INVALID_HOMESERVER(){return"Homeserver URL does not appear to be a valid Matrix homeserver"}static get ERROR_INVALID_IS_BASE_URL(){return"Invalid base_url for m.identity_server"}static get ERROR_INVALID_IDENTITY_SERVER(){return"Identity server URL does not appear to be a valid identity server"}static get ERROR_INVALID_IS(){return"Invalid identity server discovery response"}static get ERROR_MISSING_WELLKNOWN(){return"No .well-known JSON file found"}static get ERROR_INVALID_JSON(){return"Invalid JSON"}static get ALL_ERRORS(){return[o.ERROR_INVALID,o.ERROR_GENERIC_FAILURE,o.ERROR_INVALID_HS_BASE_URL,o.ERROR_INVALID_HOMESERVER,o.ERROR_INVALID_IS_BASE_URL,o.ERROR_INVALID_IDENTITY_SERVER,o.ERROR_INVALID_IS,o.ERROR_MISSING_WELLKNOWN,o.ERROR_INVALID_JSON]}static get FAIL_ERROR(){return"FAIL_ERROR"}static get FAIL_PROMPT(){return"FAIL_PROMPT"}static get PROMPT(){return"PROMPT"}static get SUCCESS(){return"SUCCESS"}static async fromDiscoveryConfig(e){const t={"m.homeserver":{state:o.FAIL_ERROR,error:o.ERROR_INVALID,base_url:null},"m.identity_server":{state:o.PROMPT,error:null,base_url:null}};if(!e||!e["m.homeserver"])return n.a.error("No m.homeserver key in config"),t["m.homeserver"].state=o.FAIL_PROMPT,t["m.homeserver"].error=o.ERROR_INVALID,Promise.resolve(t);if(!e["m.homeserver"].base_url)return n.a.error("No m.homeserver base_url in config"),t["m.homeserver"].state=o.FAIL_PROMPT,t["m.homeserver"].error=o.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const s=this._sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!s)return n.a.error("Invalid base_url for m.homeserver"),t["m.homeserver"].error=o.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const i=await this._fetchWellKnownObject(s+"/_matrix/client/versions");if(!i||!i.raw.versions)return n.a.error("Invalid /versions response"),t["m.homeserver"].error=o.ERROR_INVALID_HOMESERVER,t["m.homeserver"].base_url=s,Promise.resolve(t);t["m.homeserver"]={state:o.SUCCESS,error:null,base_url:s};let a="";if(e["m.identity_server"]){const s={"m.homeserver":t["m.homeserver"],"m.identity_server":{state:o.FAIL_PROMPT,error:o.ERROR_INVALID_IS,base_url:null}};if(a=this._sanitizeWellKnownUrl(e["m.identity_server"].base_url),!a)return n.a.error("Invalid base_url for m.identity_server"),s["m.identity_server"].error=o.ERROR_INVALID_IS_BASE_URL,Promise.resolve(s);const i=await this._fetchWellKnownObject(a+"/_matrix/identity/api/v1");if(!i||!i.raw||"SUCCESS"!==i.action)return n.a.error("Invalid /api/v1 response"),s["m.identity_server"].error=o.ERROR_INVALID_IDENTITY_SERVER,s["m.identity_server"].base_url=a,Promise.resolve(s)}return a&&a.length>0&&(t["m.identity_server"]={state:o.SUCCESS,error:null,base_url:a}),Object.keys(e).map(s=>{if("m.homeserver"===s||"m.identity_server"===s){const n=["error","state","base_url"];for(const i of Object.keys(e[s]))n.includes(i)||(t[s][i]=e[s][i])}else t[s]=e[s]}),Promise.resolve(t)}static async findClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t={"m.homeserver":{state:o.FAIL_ERROR,error:o.ERROR_INVALID,base_url:null},"m.identity_server":{state:o.PROMPT,error:null,base_url:null}},s=await this._fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return s&&"SUCCESS"===s.action?o.fromDiscoveryConfig(s.raw):(n.a.error("No response or error when parsing .well-known"),s.reason&&n.a.error(s.reason),"IGNORE"===s.action?t["m.homeserver"]={state:o.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=o.FAIL_PROMPT,t["m.homeserver"].error=o.ERROR_INVALID),Promise.resolve(t))}static async getRawClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t=await this._fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return t&&t.raw||{}}static _sanitizeWellKnownUrl(e){if(!e)return!1;try{let t=null;try{t=i.URL?new i.URL(e):new URL(e)}catch(s){t=new URL(e)}if(!t||!t.hostname)return!1;if("http:"!==t.protocol&&"https:"!==t.protocol)return!1;const s=t.port?":"+t.port:"",n=t.pathname?t.pathname:"";let o=`${t.protocol}//${t.hostname}${s}${n}`;return o.endsWith("/")&&(o=o.substring(0,o.length-1)),o}catch(e){return n.a.error(e),!1}}static async _fetchWellKnownObject(e){return new Promise((function(t,n){const i=s(152).getRequest();if(!i)throw new Error("No request library available");i({method:"GET",uri:e,timeout:5e3},(e,s,n)=>{if(e||s&&(s.statusCode<200||s.statusCode>=300)){let n="FAIL_PROMPT",i=(e?e.message:null)||"General failure";return s&&404===s.statusCode&&(n="IGNORE",i=o.ERROR_MISSING_WELLKNOWN),void t({raw:{},action:n,reason:i,error:e})}try{t({raw:JSON.parse(n),action:"SUCCESS"})}catch(e){let s=o.ERROR_INVALID;"SyntaxError"===e.name&&(s=o.ERROR_INVALID_JSON),t({raw:{},action:"FAIL_PROMPT",reason:s,error:e})}})}))}}},function(e,t,s){"use strict";let n,i;s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i})),function(e){e.Public="public",e.Private="private"}(n||(n={})),function(e){e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat"}(i||(i={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o})),s.d(t,"c",(function(){return a}));var n=s(94);function i(e){return e.getCanonicalAlias()||e.getAltAliases()[0]}function o(e,t){let s;if(t){s=function(e,t){let s,n;for(const i of e.getJoinedMembers())i.userId!=t&&(void 0===s||i.events.member&&i.events.member.getTs()<s)&&(n=i,s=i.events.member.getTs());if(n)return n.userId;for(const i of e.currentState.getMembers())i.userId!=t&&(void 0===s||i.events.member&&i.events.member.getTs()<s)&&(n=i,s=i.events.member.getTs());return void 0===n?t:n.userId}(e,n.a.get().getUserId())}else s=null;return a(e.roomId,s)}function a(e,t){if(n.a.get().isGuest())return Promise.resolve();const s=n.a.get().getAccountData("m.direct");let i={};void 0!==s&&(i=s.getContent());for(const s of Object.keys(i)){const n=i[s];if(s!=t){const t=n.indexOf(e);t>-1&&n.splice(t,1)}}if(t){const s=i[t]||[];-1==s.indexOf(e)&&s.push(e),i[t]=s}return n.a.get().setAccountData("m.direct",i)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o})),s.d(t,"d",(function(){return a})),s.d(t,"c",(function(){return c}));var n=s(94);function i(){const e=n.a.get().getClientWellKnown();return null==e?void 0:e["io.element.call_behaviour"]}function o(){const e=n.a.get().getClientWellKnown();return e&&e["io.element.e2ee"]?e["io.element.e2ee"]:e&&e["im.vector.riot.e2ee"]?e["im.vector.riot.e2ee"]:null}function a(){const e=o();return e&&!0===e.secure_backup_required}let r;function c(){const e=o();return e&&e.secure_backup_setup_methods&&e.secure_backup_setup_methods.length&&(e.secure_backup_setup_methods.includes(r.Key)||e.secure_backup_setup_methods.includes(r.Passphrase))?e.secure_backup_setup_methods:[r.Key,r.Passphrase]}!function(e){e.Key="key",e.Passphrase="passphrase"}(r||(r={}))},function(e,t,s){"use strict";var n=s(18),i=s.n(n),o=s(8),a=s.n(o);class r extends a.a{constructor(){super(),i()(this,"roomWidgetEcho",void 0),this.roomWidgetEcho={}}getEchoedRoomWidgets(e,t){const s=[],n=Object.assign({},this.roomWidgetEcho[e]);for(const e of t){const t=e.getStateKey();n[t]&&0===Object.keys(n[t]).length||s.push(e),delete n[t]}return s}roomHasPendingWidgetsOfType(e,t,s){const n=Object.assign({},this.roomWidgetEcho[e]);for(const e of t){delete n[e.getStateKey()]}return void 0===s?Object.keys(n).length>0:Object.values(n).some(e=>s.matches(e.type))}roomHasPendingWidgets(e,t){return this.roomHasPendingWidgetsOfType(e,t)}setRoomWidgetEcho(e,t,s){void 0===this.roomWidgetEcho[e]&&(this.roomWidgetEcho[e]={}),this.roomWidgetEcho[e][t]=s,this.emit("update",e,t)}removeRoomWidgetEcho(e,t){delete this.roomWidgetEcho[e][t],0===Object.keys(this.roomWidgetEcho[e]).length&&delete this.roomWidgetEcho[e],this.emit("update",e,t)}}let c=null;c||(c=new r),t.a=c},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(18),i=s.n(n),o=s(156),a=s(96),r=s(320);class c extends o.a{constructor(){super(a.a),i()(this,"widgetMap",new r.a)}static get instance(){return c.internalInstance}async onAction(e){}async onReady(){this.widgetMap.clear()}storeMessaging(e,t){this.stopMessaging(e),this.widgetMap.set(e.id,t)}stopMessaging(e){var t;null===(t=this.widgetMap.remove(e.id))||void 0===t||t.stop()}getMessaging(e){return this.widgetMap.get(e.id)}stopMessagingById(e){var t;null===(t=this.widgetMap.remove(e))||void 0===t||t.stop()}getMessagingForId(e){return this.widgetMap.get(e)}}i()(c,"internalInstance",new c)},function(e,t,s){"use strict";s.d(t,"c",(function(){return a})),s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return c}));var n=s(114),i=s(94),o=s(265);function a(e){const{status:t}=e;if((!t||t===n.a.SENT)&&!e.isRedacted())if("m.room.message"===e.getType()){const t=e.getContent();if(t.msgtype&&"m.bad.encrypted"!==t.msgtype&&t.hasOwnProperty("body"))return!0}else if("m.sticker"===e.getType())return!0;return!1}function r(e){if(e.status===n.a.CANCELLED||"m.room.message"!==e.getType()||e.isRedacted())return!1;const t=e.getOriginalContent(),{msgtype:s}=t;return("m.text"===s||"m.emote"===s)&&t.body&&"string"==typeof t.body&&e.getSender()===i.a.get().getUserId()}function c(e,t,s){const n=e.getLiveTimeline().getEvents().concat(e.getPendingEvents()),i=n.length-1,a=t?1:-1,c=t?0:i;let l=t?i:0;s||(l=Math.min(Math.max(0,c+100*a),i));let d=!s;for(let e=c;e!==l+a;e+=a){const t=n[e];if(d||t.getId()!==s){if(d&&!Object(o.a)(t)&&r(t))return t}else d=!0,l=Math.min(Math.max(0,e+100*a),i)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(18),i=s.n(n),o=s(203),a=s(219);class r extends a.b{constructor(e,t,s){super(),this._symbol=e,this._count=t,this._color=s}static forCount(e,t){return new r(null,e,t)}static forSymbol(e,t){return new r(e,0,t)}}i()(r,"RED_EXCLAMATION",r.forSymbol("!",o.a.Red))},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(117);function i(e,t){const s=Object(n.throttle)(e,t,{leading:!0,trailing:!0}),i=s.bind;return s.bind=function(){const e=i.apply(s,arguments);return e.cancelPendingCall=s.cancelPendingCall,e},s.cancelPendingCall=function(){s.cancel()},s}},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(18),i=s.n(n),o=s(96),a=s(593),r=s(299),c=s(98),l=s(126),d=s(103),u=s(106),h=s(133);function m(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}const p={showRoomPanel:c.b.getValue("showRightPanelInRoom"),showGroupPanel:c.b.getValue("showRightPanelInGroup"),lastRoomPhase:c.b.getValue("lastRightPanelPhaseForRoom"),lastGroupPhase:c.b.getValue("lastRightPanelPhaseForGroup"),lastRoomPhaseParams:{}},g=[l.c.GroupMemberList,l.c.GroupRoomList,l.c.GroupRoomInfo,l.c.GroupMemberInfo],v=[l.c.RoomMemberInfo,l.c.Room3pidMemberInfo,l.c.EncryptionPanel];class f extends r.Store{constructor(){super(o.a),i()(this,"state",void 0),this.state=p}get isOpenForRoom(){return this.state.showRoomPanel}get isOpenForGroup(){return this.state.showGroupPanel}get roomPanelPhase(){return this.state.lastRoomPhase}get groupPanelPhase(){return this.state.lastGroupPhase}get previousPhase(){return l.a.includes(this.state.previousPhase)?this.state.previousPhase:null}get visibleRoomPanelPhase(){return this.isOpenForRoom?this.roomPanelPhase:null}get visibleGroupPanelPhase(){return this.isOpenForGroup?this.groupPanelPhase:null}get roomPanelPhaseParams(){return this.state.lastRoomPhaseParams||{}}setState(e){this.state=Object.assign(this.state,e),c.b.setValue("showRightPanelInRoom",null,u.a.DEVICE,this.state.showRoomPanel),c.b.setValue("showRightPanelInGroup",null,u.a.DEVICE,this.state.showGroupPanel),l.a.includes(this.state.lastRoomPhase)&&c.b.setValue("lastRightPanelPhaseForRoom",null,u.a.DEVICE,this.state.lastRoomPhase),l.a.includes(this.state.lastGroupPhase)&&c.b.setValue("lastRightPanelPhaseForGroup",null,u.a.DEVICE,this.state.lastGroupPhase),this.__emitChange()}__onDispatch(e){switch(e.action){case"view_room":case"view_group":if(e.room_id===h.a.getRoomId())break;v.includes(this.state.lastRoomPhase)&&this.setState({lastRoomPhase:l.c.RoomMemberList,lastRoomPhaseParams:{}}),this.state.lastGroupPhase===l.c.GroupMemberInfo&&this.setState({lastGroupPhase:l.c.GroupMemberList});break;case d.a.SetRightPanelPhase:{var t;let s=e.phase,n=e.refireParams;const r=null===(t=e.allowClose)||void 0===t||t;if(s===l.c.RoomMemberInfo&&e.refireParams){const{member:t}=e.refireParams,i=Object(a.b)(t);i&&(s=l.c.EncryptionPanel,n={verificationRequest:i,member:t})}if(!l.c[s])return void console.warn("Tried to switch right panel to unknown phase: "+s);g.includes(s)?s===this.state.lastGroupPhase?this.setState({showGroupPanel:!this.state.showGroupPanel,previousPhase:null}):this.setState({lastGroupPhase:s,showGroupPanel:!0,previousPhase:this.state.lastGroupPhase}):s===this.state.lastRoomPhase&&!n&&r?this.setState({showRoomPanel:!this.state.showRoomPanel,previousPhase:null}):this.setState({lastRoomPhase:s,showRoomPanel:!0,lastRoomPhaseParams:n||{},previousPhase:this.state.lastRoomPhase}),o.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?m(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({action:d.a.AfterRightPanelPhaseChange,phase:s},n||{}));break}case d.a.ToggleRightPanel:"room"===e.type?this.setState({showRoomPanel:!this.state.showRoomPanel}):this.setState({showGroupPanel:!this.state.showGroupPanel})}}static getSharedInstance(){return f.instance||(f.instance=new f),f.instance}}i()(f,"instance",void 0),window.mxRightPanelStore=f.getSharedInstance()},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(97),c=s.n(r),l=s(95),d=s(94),u=s(178),h=s(92),m=s(181);class p extends a.a.PureComponent{constructor(e){super(e),i()(this,"_onCancel",()=>{this.props.onFinished(!1)}),i()(this,"_onDone",()=>{this.props.onFinished(!0)}),i()(this,"_onUseRecoveryKeyClick",()=>{this.setState({forceRecoveryKey:!0})}),i()(this,"_progressCallback",e=>{this.setState({progress:e})}),i()(this,"_onResetRecoveryClick",()=>{this.props.onFinished(!1),Object(m.b)(()=>{},!0)}),i()(this,"_onRecoveryKeyChange",e=>{this.setState({recoveryKey:e.target.value,recoveryKeyValid:d.a.get().isValidRecoveryKey(e.target.value)})}),i()(this,"_onPassPhraseNext",async()=>{this.setState({loading:!0,restoreError:null,restoreType:0});try{const e=await d.a.get().restoreKeyBackupWithPassword(this.state.passPhrase,void 0,void 0,this.state.backupInfo,{progressCallback:this._progressCallback});if(this.props.keyCallback){const e=await d.a.get().keyBackupKeyFromPassword(this.state.passPhrase,this.state.backupInfo);this.props.keyCallback(e)}if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){console.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}),i()(this,"_onRecoveryKeyNext",async()=>{if(this.state.recoveryKeyValid){this.setState({loading:!0,restoreError:null,restoreType:1});try{const e=await d.a.get().restoreKeyBackupWithRecoveryKey(this.state.recoveryKey,void 0,void 0,this.state.backupInfo,{progressCallback:this._progressCallback});if(this.props.keyCallback){const e=d.a.get().keyBackupKeyFromRecoveryKey(this.state.recoveryKey);this.props.keyCallback(e)}if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){console.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}}),i()(this,"_onPassPhraseChange",e=>{this.setState({passPhrase:e.target.value})}),this.state={backupInfo:null,backupKeyStored:null,loading:!1,loadError:null,restoreError:null,recoveryKey:"",recoverInfo:null,recoveryKeyValid:!1,forceRecoveryKey:!1,passPhrase:"",restoreType:null,progress:{stage:"prefetch"}}}componentDidMount(){this._loadBackupStatus()}async _restoreWithSecretStorage(){this.setState({loading:!0,restoreError:null,restoreType:2});try{const e=await Object(m.b)(async()=>d.a.get().restoreKeyBackupWithSecretStorage(this.state.backupInfo,void 0,void 0,{progressCallback:this._progressCallback}));this.setState({loading:!1,recoverInfo:e})}catch(e){console.log("Error restoring backup",e),this.setState({restoreError:e,loading:!1})}}async _restoreWithCachedKey(e){if(!e)return!1;try{const t=await d.a.get().restoreKeyBackupWithCache(void 0,void 0,e,{progressCallback:this._progressCallback});return this.setState({recoverInfo:t}),!0}catch(e){return console.log("restoreWithCachedKey failed:",e),!1}}async _loadBackupStatus(){this.setState({loading:!0,loadError:null});try{const e=d.a.get(),t=await e.getKeyBackupVersion(),s=await e.hasSecretStorageKey()&&await e.isKeyBackupKeyStored();this.setState({backupInfo:t,backupKeyStored:s});if(await this._restoreWithCachedKey(t))return console.log("RestoreKeyBackupDialog: found cached backup key"),void this.setState({loading:!1});if(s)return this._restoreWithSecretStorage();this.setState({loadError:null,loading:!1})}catch(e){console.log("Error loading backup status",e),this.setState({loadError:e,loading:!1})}}render(){const e=l.getComponent("views.dialogs.BaseDialog"),t=l.getComponent("elements.Spinner"),s=this.state.backupInfo&&this.state.backupInfo.auth_data&&this.state.backupInfo.auth_data.private_key_salt&&this.state.backupInfo.auth_data.private_key_iterations;let n,i;if(this.state.loading){let e;if(i=Object(h.a)("Restoring keys from backup"),"fetch"===this.state.progress.stage)e=Object(h.a)("Fetching keys from server...");else if("load_keys"===this.state.progress.stage){const{total:t,successes:s,failures:n}=this.state.progress;e=Object(h.a)("%(completed)s of %(total)s keys restored",{total:t,completed:s+n})}else"prefetch"===this.state.progress.stage&&(e=Object(h.a)("Fetching keys from server..."));n=a.a.createElement("div",null,a.a.createElement("div",null,e),a.a.createElement(t,null))}else if(this.state.loadError)i=Object(h.a)("Error"),n=Object(h.a)("Unable to load backup status");else if(this.state.restoreError)this.state.restoreError.errcode===u.b.RESTORE_BACKUP_ERROR_BAD_KEY?1===this.state.restoreType?(i=Object(h.a)("Security Key mismatch"),n=a.a.createElement("div",null,a.a.createElement("p",null,Object(h.a)("Backup could not be decrypted with this Security Key: please verify that you entered the correct Security Key.")))):(i=Object(h.a)("Incorrect Security Phrase"),n=a.a.createElement("div",null,a.a.createElement("p",null,Object(h.a)("Backup could not be decrypted with this Security Phrase: please verify that you entered the correct Security Phrase.")))):(i=Object(h.a)("Error"),n=Object(h.a)("Unable to restore backup"));else if(null===this.state.backupInfo)i=Object(h.a)("Error"),n=Object(h.a)("No backup found!");else if(this.state.recoverInfo){const e=l.getComponent("views.elements.DialogButtons");let t;i=Object(h.a)("Keys restored"),this.state.recoverInfo.total>this.state.recoverInfo.imported&&(t=a.a.createElement("p",null,Object(h.a)("Failed to decrypt %(failedCount)s sessions!",{failedCount:this.state.recoverInfo.total-this.state.recoverInfo.imported}))),n=a.a.createElement("div",null,a.a.createElement("p",null,Object(h.a)("Successfully restored %(sessionCount)s keys",{sessionCount:this.state.recoverInfo.imported})),t,a.a.createElement(e,{primaryButton:Object(h.a)("OK"),onPrimaryButtonClick:this._onDone,hasCancel:!1,focus:!0}))}else if(s&&!this.state.forceRecoveryKey){const e=l.getComponent("views.elements.DialogButtons"),t=l.getComponent("elements.AccessibleButton");i=Object(h.a)("Enter Security Phrase"),n=a.a.createElement("div",null,a.a.createElement("p",null,Object(h.a)("<b>Warning</b>: you should only set up key backup from a trusted computer.",{},{b:e=>a.a.createElement("b",null,e)})),a.a.createElement("p",null,Object(h.a)("Access your secure message history and set up secure messaging by entering your Security Phrase.")),a.a.createElement("form",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},a.a.createElement("input",{type:"password",className:"mx_RestoreKeyBackupDialog_passPhraseInput",onChange:this._onPassPhraseChange,value:this.state.passPhrase,autoFocus:!0}),a.a.createElement(e,{primaryButton:Object(h.a)("Next"),onPrimaryButtonClick:this._onPassPhraseNext,primaryIsSubmit:!0,hasCancel:!0,onCancel:this._onCancel,focus:!1})),Object(h.a)("If you've forgotten your Security Phrase you can <button1>use your Security Key</button1> or <button2>set up new recovery options</button2>",{},{button1:e=>a.a.createElement(t,{className:"mx_linkButton",element:"span",onClick:this._onUseRecoveryKeyClick},e),button2:e=>a.a.createElement(t,{className:"mx_linkButton",element:"span",onClick:this._onResetRecoveryClick},e)}))}else{i=Object(h.a)("Enter Security Key");const e=l.getComponent("views.elements.DialogButtons"),t=l.getComponent("elements.AccessibleButton");let s;s=0===this.state.recoveryKey.length?a.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"}):this.state.recoveryKeyValid?a.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👍 ",Object(h.a)("This looks like a valid Security Key!")):a.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👎 ",Object(h.a)("Not a valid Security Key")),n=a.a.createElement("div",null,a.a.createElement("p",null,Object(h.a)("<b>Warning</b>: You should only set up key backup from a trusted computer.",{},{b:e=>a.a.createElement("b",null,e)})),a.a.createElement("p",null,Object(h.a)("Access your secure message history and set up secure messaging by entering your Security Key.")),a.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},a.a.createElement("input",{className:"mx_RestoreKeyBackupDialog_recoveryKeyInput",onChange:this._onRecoveryKeyChange,value:this.state.recoveryKey,autoFocus:!0}),s,a.a.createElement(e,{primaryButton:Object(h.a)("Next"),onPrimaryButtonClick:this._onRecoveryKeyNext,hasCancel:!0,onCancel:this._onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid})),Object(h.a)("If you've forgotten your Security Key you can <button>set up new recovery options</button>",{},{button:e=>a.a.createElement(t,{className:"mx_linkButton",element:"span",onClick:this._onResetRecoveryClick},e)}))}return a.a.createElement(e,{className:"mx_RestoreKeyBackupDialog",onFinished:this.props.onFinished,title:i},a.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_content"},n))}}i()(p,"propTypes",{showSummary:c.a.bool,keyCallback:c.a.func}),i()(p,"defaultProps",{showSummary:!0})},,function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return c})),s.d(t,"c",(function(){return u})),s.d(t,"d",(function(){return h}));var n=s(92),i=s(335),o=s(98),a=s(334);const r="light";function c(){const e={light:Object(n.a)("Light"),dark:Object(n.a)("Dark")},t=o.b.getValue("custom_themes"),s={};for(const{name:e}of t)s["custom-"+e]=e;return Object.assign({},s,e)}const l=["font-display","font-family","font-stretch","font-style","font-weight","font-variant","font-feature-settings","font-variation-settings","src","unicode-range"];function d(e){const{style:t}=document.body;function s(e,s,n=!0){t.setProperty("--"+e,s),n&&(t.setProperty(`--${e}-0pct`,s+"00"),t.setProperty(`--${e}-15pct`,s+"26"),t.setProperty(`--${e}-50pct`,s+"7F"))}if(e.colors)for(const[t,n]of Object.entries(e.colors))if(Array.isArray(n))for(let e=0;e<n.length;e+=1)s(`${t}_${e}`,n[e],!1);else s(t,n);if(e.fonts){const{fonts:s}=e;if(s.faces){const e=s.faces.map(e=>{const t=e.src&&e.src.map(e=>{let t;return e.format&&(t=`format("${e.format}")`),e.url?`url("${e.url}") ${t}`:e.local?`local("${e.local}") ${t}`:""}).join(", ");return`@font-face {${Object.keys(e).filter(e=>l.includes(e)).map(s=>{let n;return n="src"===s?t:"font-family"===s?`"${e[s]}"`:e[s],`${s}: ${n}`}).join(";")}}`}).join("\n"),t=document.createElement("style");t.setAttribute("title","custom-theme-font-faces"),t.setAttribute("type","text/css"),t.appendChild(document.createTextNode(e)),document.head.appendChild(t)}s.general&&t.setProperty("--font-family",s.general),s.monospace&&t.setProperty("--font-family-monospace",s.monospace)}}function u(e){const t=o.b.getValue("custom_themes");if(!t)throw new Error(`No custom themes set, can't set custom theme "${e}"`);const s=t.find(t=>t.name===e);if(!s){const s=t.map(e=>e.name).join(", ");throw new Error(`Can't find custom theme "${e}", only know ${s}`)}return s}async function h(t){if(!t){const e=new a.a;t=e.getEffectiveTheme()}!function(){const e=Object.values(document.body.style);for(const t of e)t.startsWith("--")&&document.body.style.removeProperty(t);const t=document.querySelector("head > style[title='custom-theme-font-faces']");t&&t.remove()}();let s=t;if(t.startsWith("custom-")){const e=u(t.substr(7));s=e.is_dark?"dark-custom":"light-custom",d(e)}const n=Object.create(null);let o;for(let e=0;o=document.getElementsByTagName("link")[e];e++){const e=o.getAttribute("href"),t=e&&e.match(/^bundles\/.*\/theme-(.*)\.css$/);t&&(n[t[1]]=o)}if(!(s in n))throw new Error("Unknown theme "+s);return n[s].disabled=!1,new Promise(o=>{const a=function(){n[s].disabled=!1,Object.values(n).forEach(e=>{e!=n[s]&&(e.disabled=!0)});const a=e.getComputedStyle(document.body);a.backgroundColor&&(document.querySelector('meta[name="theme-color"]').content=a.backgroundColor),i.a.setTheme(t),o()};let r=!1;n[s].onload=()=>{a()};for(let e=0;e<document.styleSheets.length;e++){const t=document.styleSheets[e];if(t&&t.href===n[s].href){r=!0;break}}r&&(n[s].onload=void 0,a())})}}).call(this,s(7))},function(e,t,s){"use strict";s.r(t),function(e){s.d(t,"Notifier",(function(){return E}));var n=s(94),i=s(102),o=s(118),a=s(309),r=s(132),c=s(194),l=s(96),d=s(95),u=s(92),h=s(99),m=s(98),p=s(428),g=s(106),v=s(629),f=s(133),b=s(429),y=s(107);const _={"m.key.verification.request":e=>{const t=(e.sender||{}).name;return Object(u.a)("%(name)s is requesting verification",{name:t})}},E={notifsByRoom:{},pendingEncryptedEventIds:[],notificationMessageForEvent:function(e){return _.hasOwnProperty(e.getContent().msgtype)?_[e.getContent().msgtype](e):a.b(e)},_displayPopupNotification:function(t,s){const n=o.a.get();if(!n)return;if(!n.supportsNotifications()||!n.maySendNotifications())return;if(e.document.hasFocus())return;let i,a=this.notificationMessageForEvent(t);if(!a)return;t.sender&&s.name!==t.sender.name?"m.room.member"===t.getType()?i=s.name:t.sender&&(i=t.sender.name+" ("+s.name+")",t.getContent().body&&!_.hasOwnProperty(t.getContent().msgtype)&&(a=t.getContent().body)):(i=s.name,t.getContent().body&&!_.hasOwnProperty(t.getContent().msgtype)&&(a=t.getContent().body)),this.isBodyEnabled()||(a="");let r=null;t.sender&&!m.b.getValue("lowBandwidth")&&(r=c.a(t.sender,40,40,"crop"));const l=n.displayNotification(i,a,r,s);l&&(void 0===this.notifsByRoom[t.getRoomId()]&&(this.notifsByRoom[t.getRoomId()]=[]),this.notifsByRoom[t.getRoomId()].push(l))},getSoundForRoom:function(e){const t=m.b.getValue("notificationSound",e);return t?t.url?t.url.startsWith("mxc://")?{url:Object(y.b)(t.url).srcHttp,name:t.name,type:t.type,size:t.size}:(console.warn(e+" has custom notification sound event, but url is not a mxc url"),null):(console.warn(e+" has custom notification sound event, but no url key"),null):null},_playAudioNotification:async function(e,t){const s=this.getSoundForRoom(t.roomId);console.log(`Got sound ${s&&s.name||"default"} for ${t.roomId}`);try{const e=document.querySelector(s?`audio[src='${s.url}']`:"#messageAudio");let t=e;if(!e){if(!s)return void console.error("No audio element or sound to play for notification");t=new Audio(s.url),s.type&&(t.type=s.type),document.body.appendChild(t)}await t.play()}catch(e){console.warn("Caught error when trying to fetch room notification sound:",e)}},start:function(){this.boundOnEvent=this.boundOnEvent||this.onEvent.bind(this),this.boundOnSyncStateChange=this.boundOnSyncStateChange||this.onSyncStateChange.bind(this),this.boundOnRoomReceipt=this.boundOnRoomReceipt||this.onRoomReceipt.bind(this),this.boundOnEventDecrypted=this.boundOnEventDecrypted||this.onEventDecrypted.bind(this),n.a.get().on("event",this.boundOnEvent),n.a.get().on("Room.receipt",this.boundOnRoomReceipt),n.a.get().on("Event.decrypted",this.boundOnEventDecrypted),n.a.get().on("sync",this.boundOnSyncStateChange),this.toolbarHidden=!1,this.isSyncing=!1},stop:function(){n.a.get()&&(n.a.get().removeListener("Event",this.boundOnEvent),n.a.get().removeListener("Room.receipt",this.boundOnRoomReceipt),n.a.get().removeListener("Event.decrypted",this.boundOnEventDecrypted),n.a.get().removeListener("sync",this.boundOnSyncStateChange)),this.isSyncing=!1},supportsDesktopNotifications:function(){const e=o.a.get();return e&&e.supportsNotifications()},setEnabled:function(e,t){const s=o.a.get();s&&(r.a.trackEvent("Notifier","Set Enabled",String(e)),m.b.isLevelSupported(g.a.DEVICE)&&m.b.setValue("audioNotificationsEnabled",null,g.a.DEVICE,this.isEnabled()),e?s.requestNotificationPermission().then(e=>{if("granted"===e)t&&t(),l.a.dispatch({action:"notifier_enabled",value:!0});else{const t=i.a.get().brand,s="denied"===e?Object(u.a)("%(brand)s does not have permission to send you notifications - please check your browser settings",{brand:t}):Object(u.a)("%(brand)s was not given permission to send notifications - please try again",{brand:t}),n=d.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Unable to enable Notifications",e,n,{title:Object(u.a)("Unable to enable Notifications"),description:s})}}):l.a.dispatch({action:"notifier_enabled",value:!1}),this.setPromptHidden(!0))},isEnabled:function(){return this.isPossible()&&m.b.getValue("notificationsEnabled")},isPossible:function(){const e=o.a.get();return!!e&&(!!e.supportsNotifications()&&!!e.maySendNotifications())},isBodyEnabled:function(){return this.isEnabled()&&m.b.getValue("notificationBodyEnabled")},isAudioEnabled:function(){return m.b.getValue("audioNotificationsEnabled")},setPromptHidden:function(t,s=!0){this.toolbarHidden=t,r.a.trackEvent("Notifier","Set Toolbar Hidden",String(t)),Object(p.a)(),s&&e.localStorage&&e.localStorage.setItem("notifications_hidden",String(t))},shouldShowPrompt:function(){const e=n.a.get();if(!e)return!1;return!e.isGuest()&&this.supportsDesktopNotifications()&&!Object(v.c)()&&!this.isEnabled()&&!this._isPromptHidden()},_isPromptHidden:function(){return e.localStorage?"true"===e.localStorage.getItem("notifications_hidden"):this.toolbarHidden},onSyncStateChange:function(e){"SYNCING"===e?this.isSyncing=!0:"STOPPED"!==e&&"ERROR"!==e||(this.isSyncing=!1)},onEvent:function(e){if(this.isSyncing&&(!e.sender||e.sender.userId!==n.a.get().credentials.userId))if(n.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()||e.isDecryptionFailure())for(this.pendingEncryptedEventIds.push(e.getId());this.pendingEncryptedEventIds.length>20;)this.pendingEncryptedEventIds.shift();else this._evaluateEvent(e)},onEventDecrypted:function(e){if(e.isDecryptionFailure())return;const t=this.pendingEncryptedEventIds.indexOf(e.getId());-1!==t&&(this.pendingEncryptedEventIds.splice(t,1),this._evaluateEvent(e))},onRoomReceipt:function(e,t){if(0===t.getUnreadNotificationCount()){const e=o.a.get();if(!e)return;if(void 0===this.notifsByRoom[t.roomId])return;for(const s of this.notifsByRoom[t.roomId])e.clearNotification(s);delete this.notifsByRoom[t.roomId]}},_evaluateEvent:function(e){const t=n.a.get().getRoom(e.getRoomId()),s=n.a.get().getPushActionsForEvent(e);if(s&&s.notify){if(f.a.getRoomId()===t.roomId&&b.a.sharedInstance().userActiveRecently())return;if(m.b.getValue("doNotDisturb"))return;this.isEnabled()&&this._displayPopupNotification(e,t),s.tweaks.sound&&this.isAudioEnabled()&&(o.a.get().loudNotification(e,t),this._playAudioNotification(e,t))}}};window.mxNotifier||(window.mxNotifier=E),t.default=window.mxNotifier}.call(this,s(7))},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(18),i=s.n(n);class o{constructor(e){this.timeout=e,i()(this,"timerHandle",void 0),i()(this,"startTs",void 0),i()(this,"promise",void 0),i()(this,"resolve",void 0),i()(this,"reject",void 0),i()(this,"onTimeout",()=>{const e=Date.now()-this.startTs;if(e>=this.timeout)this.resolve(),this.setNotStarted();else{const t=this.timeout-e;this.timerHandle=setTimeout(this.onTimeout,t)}}),this.setNotStarted()}setNotStarted(){this.timerHandle=null,this.startTs=null,this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t}).finally(()=>{this.timerHandle=null})}changeTimeout(e){if(e===this.timeout)return;const t=e<this.timeout;this.timeout=e,this.isRunning()&&t&&(clearTimeout(this.timerHandle),this.onTimeout())}start(){return this.isRunning()||(this.startTs=Date.now(),this.timerHandle=setTimeout(this.onTimeout,this.timeout)),this}restart(){return this.isRunning()?(this.startTs=Date.now(),this):this.start()}abort(){return this.isRunning()&&(clearTimeout(this.timerHandle),this.reject(new Error("Timer was aborted.")),this.setNotStarted()),this}finished(){return this.promise}isRunning(){return null!==this.timerHandle}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u})),s.d(t,"c",(function(){return h})),s.d(t,"b",(function(){return m})),s.d(t,"d",(function(){return p})),s.d(t,"e",(function(){return g}));var n=s(18),i=s.n(n),o=s(139),a=s(96),r=s(103),c=s(435),l=s(94),d=s(337);const u="mx_sso_hs_url",h="mx_sso_is_url",m="mx_sso_idp_id";let p;!function(e){e.Checking="CHECKING",e.Error="ERROR",e.NotAvailable="NOTAVAILABLE",e.Downloading="DOWNLOADING",e.Ready="READY"}(p||(p={}));class g{constructor(){i()(this,"notificationCount",0),i()(this,"errorDidOccur",!1),i()(this,"onAction",e=>{switch(e.action){case"on_client_not_viable":case"on_logged_out":this.setNotificationCount(0)}}),a.a.register(this.onAction),this.startUpdateCheck=this.startUpdateCheck.bind(this)}setNotificationCount(e){this.notificationCount=e}setErrorStatus(e){this.errorDidOccur=e}async canSelfUpdate(){return!1}startUpdateCheck(){Object(c.a)(),localStorage.removeItem("mx_defer_update"),a.a.dispatch({action:r.a.CheckUpdates,status:p.Checking})}installUpdate(){}shouldShowUpdate(e){if(l.a.userRegisteredWithinLastHours(24))return!1;try{const[t,s]=JSON.parse(localStorage.getItem("mx_defer_update"));return e!==t||Date.now()>s}catch(e){return!0}}deferUpdate(e){const t=new Date(Date.now()+864e5);t.setHours(8,0,0,0),localStorage.setItem("mx_defer_update",JSON.stringify([e,t.getTime()])),Object(c.a)()}supportsMultiLanguageSpellCheck(){return!1}supportsNotifications(){return!1}maySendNotifications(){return!1}loudNotification(e,t){}clearNotification(e){e.close&&e.close()}screenCaptureErrorString(){return"Not implemented"}supportsAutoLaunch(){return!1}async getAutoLaunchEnabled(){return!1}async setAutoLaunchEnabled(e){throw new Error("Unimplemented")}supportsWarnBeforeExit(){return!1}async shouldWarnBeforeExit(){return!1}async setWarnBeforeExit(e){throw new Error("Unimplemented")}supportsAutoHideMenuBar(){return!1}async getAutoHideMenuBarEnabled(){return!1}async setAutoHideMenuBarEnabled(e){throw new Error("Unimplemented")}supportsMinimizeToTray(){return!1}async getMinimizeToTrayEnabled(){return!1}async setMinimizeToTrayEnabled(e){throw new Error("Unimplemented")}getEventIndexingManager(){return null}async setLanguage(e){}setSpellCheckLanguages(e){}getSpellCheckLanguages(){return null}getAvailableSpellCheckLanguages(){return null}getSSOCallbackUrl(e){const t=new URL(window.location.href);return t.hash=e||"",t}startSingleSignOn(e,t,s,n){localStorage.setItem(u,e.getHomeserverUrl()),e.getIdentityServerUrl()&&localStorage.setItem(h,e.getIdentityServerUrl()),n&&localStorage.setItem(m,n);const i=this.getSSOCallbackUrl(s);window.location.href=e.getSsoLoginUrl(i.toString(),t,n)}onKeyDown(e){return!1}async getPickleKey(e,t){if(!window.crypto||!window.crypto.subtle)return null;let s;try{s=await Object(d.c)("pickleKey",[e,t])}catch(e){}if(!s)return null;if(!s.encrypted||!s.iv||!s.cryptoKey)return console.error("Badly formatted pickle key"),null;const n=new Uint8Array(e.length+t.length+1);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);n[e.length]=124;for(let s=0;s<t.length;s++)n[e.length+1+s]=t.charCodeAt(s);try{const e=await crypto.subtle.decrypt({name:"AES-GCM",iv:s.iv,additionalData:n},s.cryptoKey,s.encrypted);return Object(o.encodeUnpaddedBase64)(e)}catch(e){return console.error("Error decrypting pickle key"),null}}async createPickleKey(e,t){if(!window.crypto||!window.crypto.subtle)return null;const s=window.crypto,n=new Uint8Array(32);s.getRandomValues(n);const i=await s.subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),a=new Uint8Array(32);s.getRandomValues(a);const r=new Uint8Array(e.length+t.length+1);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t);r[e.length]=124;for(let s=0;s<t.length;s++)r[e.length+1+s]=t.charCodeAt(s);const c=await s.subtle.encrypt({name:"AES-GCM",iv:a,additionalData:r},i,n);try{await Object(d.d)("pickleKey",[e,t],{encrypted:c,iv:a,cryptoKey:i})}catch(e){return null}return Object(o.encodeUnpaddedBase64)(n)}async destroyPickleKey(e,t){try{await Object(d.b)("pickleKey",[e,t])}catch(e){}}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return O})),s.d(t,"a",(function(){return R}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(96),c=s(94),l=s(95),d=s(92),u=s(99),h=s(133),m=s(711),p=s.n(m),g=s(1263),v=s.n(g),f=s(119),b=s(103),y=s(120);const _=[0,0,22,37,0,0,22,37,1];class E extends Error{}function S(e,t,s,n){return new Promise(i=>{let o=t,a=s;a>600&&(o=Math.floor(o*(600/a)),a=600),o>800&&(a=Math.floor(a*(800/o)),o=800);const r=document.createElement("canvas");r.width=o,r.height=a,r.getContext("2d").drawImage(e,0,0,o,a),r.toBlob((function(e){i({info:{thumbnail_info:{w:o,h:a,mimetype:e.type,size:e.size},w:t,h:s},thumbnail:e})}),n)})}function w(e,t,s){let n,i="image/png";return"image/jpeg"===s.type&&(i="image/jpeg"),async function(e){const t=document.createElement("img"),s=URL.createObjectURL(e),n=new Promise((e,n)=>{t.onload=function(){URL.revokeObjectURL(s),e(t)},t.onerror=function(e){n(e)}});let i;if(t.src=s,"image/png"===e.type){i=k(e).then(e=>{const t=new Uint8Array(e),s=v()(t);for(const e of s)if("pHYs"===e.name){if(e.data.byteLength!==_.length)return;return e.data.every((e,t)=>e===_[t])}return!1})}const[o]=await Promise.all([i,n]);return{width:o?t.width>>1:t.width,height:o?t.height>>1:t.height,img:t}}(s).then(e=>S(e.img,e.width,e.height,i)).then(s=>(n=s.info,O(e,t,s.thumbnail))).then(e=>(n.thumbnail_url=e.url,n.thumbnail_file=e.file,n))}function C(e,t,s){let n;return function(e){return new Promise((t,s)=>{const n=document.createElement("video"),i=new FileReader;i.onload=function(e){n.src=e.target.result,n.onloadeddata=function(){t(n)},n.onerror=function(e){s(e)}},i.onerror=function(e){s(e)},i.readAsDataURL(e)})}(s).then(e=>S(e,e.videoWidth,e.videoHeight,"image/jpeg")).then(s=>(n=s.info,O(e,t,s.thumbnail))).then(e=>(n.thumbnail_url=e.url,n.thumbnail_file=e.file,n))}function k(e){return new Promise((t,s)=>{const n=new FileReader;n.onload=function(e){t(e.target.result)},n.onerror=function(e){s(e)},n.readAsArrayBuffer(e)})}function O(e,t,s,n){let i=!1;if(e.isRoomEncrypted(t)){let t,o;const a=k(s).then((function(e){if(i)throw new E;return p.a.encryptAttachment(e)})).then((function(s){if(i)throw new E;o=s.info;const a=new Blob([s.data]);return t=e.uploadContent(a,{progressHandler:n,includeFilename:!1}),t})).then((function(e){if(i)throw new E;return o.url=e,s.type&&(o.mimetype=s.type),{file:o}}));return a.abort=()=>{i=!0,t&&c.a.get().cancelUpload(t)},a}{const t=e.uploadContent(s,{progressHandler:n}),o=t.then((function(e){if(i)throw new E;return{url:e}}));return o.abort=()=>{i=!0,c.a.get().cancelUpload(t)},o}}class R{constructor(){i()(this,"inprogress",[]),i()(this,"mediaConfig",null)}sendStickerContentToRoom(e,t,s,n,i){const o=y.a.getTimestamp(),a=c.a.get().sendStickerMessage(t,e,s,n).catch(s=>{throw console.warn(`Failed to send content with URL ${e} to room ${t}`,s),s});return y.a.instance.trackSendMessage(o,a,t,!1,!1,{msgtype:"m.sticker"}),a}getUploadLimit(){return null!==this.mediaConfig&&void 0!==this.mediaConfig["m.upload.size"]?this.mediaConfig["m.upload.size"]:null}async sendContentListToRoom(e,t,s){if(s.isGuest())return void r.a.dispatch({action:"require_registration"});if(Boolean(h.a.getQuotingEvent())){const e=l.getComponent("dialogs.QuestionDialog"),{finished:t}=u.a.createTrackedDialog("Upload Reply Warning","",e,{title:Object(d.a)("Replying With Files"),description:a.a.createElement("div",null,Object(d.a)("At this time it is not possible to reply with a file. Would you like to upload this file without replying?")),hasCancelButton:!0,button:Object(d.a)("Continue")}),[s]=await t;if(!s)return}if(!this.mediaConfig){const e=u.a.createDialog(f.a,null,"mx_Dialog_spinner");await this.ensureMediaConfigFetched(),e.close()}const n=[],i=[];for(let t=0;t<e.length;++t)this.isFileSizeAcceptable(e[t])?i.push(e[t]):n.push(e[t]);if(n.length>0){const t=l.getComponent("dialogs.UploadFailureDialog"),{finished:s}=u.a.createTrackedDialog("Upload Failure","",t,{badFiles:n,totalFiles:e.length,contentMessages:this}),[i]=await s;if(!i)return}const o=l.getComponent("dialogs.UploadConfirmDialog");let c=!1,m=Promise.resolve();for(let e=0;e<i.length;++e){const n=i[e];if(!c){const{finished:t}=u.a.createTrackedDialog("Upload Files confirmation","",o,{file:n,currentIndex:e,totalFiles:i.length}),[s,a]=await t;if(!s)break;a&&(c=!0)}m=this.sendContentToRoom(n,t,s,m)}}getCurrentUploads(){return this.inprogress.filter(e=>!e.canceled)}cancelUpload(e){let t;for(let s=0;s<this.inprogress.length;++s)if(this.inprogress[s].promise===e){t=this.inprogress[s];break}t&&(t.canceled=!0,c.a.get().cancelUpload(t.promise),r.a.dispatch({action:b.a.UploadCanceled,upload:t}))}sendContentToRoom(e,t,s,n){const i=y.a.getTimestamp(),o={body:e.name||"Attachment",info:{size:e.size},msgtype:""};e.type&&(o.info.mimetype=e.type);const a=new Promise(n=>{0===e.type.indexOf("image/")?(o.msgtype="m.image",w(s,t,e).then(e=>{Object.assign(o.info,e),n()},e=>{console.error(e),o.msgtype="m.file",n()})):0===e.type.indexOf("audio/")?(o.msgtype="m.audio",n()):0===e.type.indexOf("video/")?(o.msgtype="m.video",C(s,t,e).then(e=>{Object.assign(o.info,e),n()},e=>{o.msgtype="m.file",n()})):(o.msgtype="m.file",n())});a.abort=()=>{c.canceled=!0};const c={fileName:e.name||"Attachment",roomId:t,total:e.size,loaded:0,promise:a};function h(e){c.total=e.total,c.loaded=e.loaded,r.a.dispatch({action:b.a.UploadProgress,upload:c})}let m;return this.inprogress.push(c),r.a.dispatch({action:b.a.UploadStarted,upload:c}),r.a.fire(b.a.FocusComposer),a.then((function(){if(c.canceled)throw new E;return c.promise=O(s,t,e,h),c.promise.then((function(e){o.file=e.file,o.url=e.url}))})).then(()=>n).then((function(){if(c.canceled)throw new E;const e=s.sendMessage(t,o);return y.a.instance.trackSendMessage(i,e,t,!1,!1,o),e}),(function(e){if(m=e,!c.canceled){let t=Object(d.a)("The file '%(fileName)s' failed to upload.",{fileName:c.fileName});413===e.http_status&&(t=Object(d.a)("The file '%(fileName)s' exceeds this homeserver's size limit for uploads",{fileName:c.fileName}));const s=l.getComponent("dialogs.ErrorDialog");u.a.createTrackedDialog("Upload failed","",s,{title:Object(d.a)("Upload Failed"),description:t})}})).finally(()=>{for(let e=0;e<this.inprogress.length;++e)if(this.inprogress[e].promise===c.promise){this.inprogress.splice(e,1);break}m?(m&&413===m.http_status&&(this.mediaConfig=null),r.a.dispatch({action:b.a.UploadFailed,upload:c,error:m})):(r.a.dispatch({action:b.a.UploadFinished,upload:c}),r.a.dispatch({action:"message_sent"}))})}isFileSizeAcceptable(e){return!(null!==this.mediaConfig&&void 0!==this.mediaConfig["m.upload.size"]&&e.size>this.mediaConfig["m.upload.size"])}ensureMediaConfigFetched(){if(null===this.mediaConfig)return console.log("[Media Config] Fetching"),c.a.get().getMediaConfig().then(e=>(console.log("[Media Config] Fetched config:",e),e)).catch(()=>(console.log("[Media Config] Could not fetch config, so not limiting uploads."),{})).then(e=>{this.mediaConfig=e})}static sharedInstance(){return void 0===window.mxContentMessages&&(window.mxContentMessages=new R),window.mxContentMessages}}},function(e,t,s){"use strict";var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(101),u=s.n(d),h=s(102),m=s(163),p=s(92),g=s(112),v=s(93);let f=Object(v.a)("views.auth.PassphraseField")((o=i=class extends c.PureComponent{constructor(...e){super(...e),r()(this,"validate",Object(m.a)({description:function(e){const t=e?e.score:0;return l.a.createElement("progress",{className:"mx_PassphraseField_progress",max:4,value:t})},deriveData:async({value:e})=>{if(!e)return null;const{scorePassword:t}=await Promise.all([s.e(26),s.e(33)]).then(s.bind(null,1308));return t(e)},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(p.a)(this.props.labelEnterPassword)},{key:"complexity",test:async function({value:e},t){if(!e)return!1;const s=t.score>=this.props.minScore;return h.a.get().dangerously_allow_unsafe_and_insecure_passwords||s},valid:function(e){return e.score>=this.props.minScore?Object(p.a)(this.props.labelStrongPassword):Object(p.a)(this.props.labelAllowedButUnsafe)},invalid:function(e){if(!e)return null;const{feedback:t}=e;return t.warning||t.suggestions[0]||Object(p.a)("Keep going...")}}]})),r()(this,"onValidate",async e=>{const t=await this.validate(e);return this.props.onValidate(t),t})}render(){return l.a.createElement(g.a,{id:this.props.id,autoFocus:this.props.autoFocus,className:u()("mx_PassphraseField",this.props.className),ref:this.props.fieldRef,type:"password",autoComplete:"new-password",label:Object(p.a)(this.props.label),value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate})}},r()(i,"defaultProps",{label:Object(p.b)("Password"),labelEnterPassword:Object(p.b)("Enter password"),labelStrongPassword:Object(p.b)("Nice, strong password!"),labelAllowedButUnsafe:Object(p.b)("Password is allowed, but unsafe")}),n=o))||n;t.a=f},function(e,t,s){"use strict";s.d(t,"a",(function(){return u})),s.d(t,"b",(function(){return h}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(240),c=s(92);var l=s(102);const d=[r.a.ERROR_INVALID_HOMESERVER,r.a.ERROR_INVALID_IDENTITY_SERVER];class u{constructor(){i()(this,"hsUrl",void 0),i()(this,"hsName",void 0),i()(this,"hsNameIsDifferent",void 0),i()(this,"isUrl",void 0),i()(this,"isDefault",void 0),i()(this,"isNameResolvable",void 0),i()(this,"warning",void 0)}}class h{static isLivelinessError(e){return!!e&&!!d.find(t=>"string"==typeof e?t===e:t===e.message)}static authComponentStateForError(e,t="login"){if(!e)return{serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:null};let s=Object(c.a)("Cannot reach homeserver"),n=Object(c.a)("Ensure you have a stable internet connection, or get in touch with the server admin");if(!h.isLivelinessError(e)){const e=l.a.get().brand;s=Object(c.a)("Your %(brand)s is misconfigured",{brand:e}),n=Object(c.a)("Ask your %(brand)s admin to check <a>your config</a> for incorrect or duplicate entries.",{brand:e},{a:e=>a.a.createElement("a",{href:"https://github.com/vector-im/element-web/blob/master/docs/config.md",target:"_blank",rel:"noreferrer noopener"},e)})}let i=!0;return("string"==typeof e?e:e.message)===r.a.ERROR_INVALID_IDENTITY_SERVER&&(i=!1,s=Object(c.a)("Cannot reach identity server"),n="register"===t?Object(c.a)("You can register, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin."):"reset_password"===t?Object(c.a)("You can reset your password, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin."):Object(c.a)("You can log in, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin.")),{serverIsAlive:!1,serverErrorIsFatal:i,serverDeadError:a.a.createElement("div",null,a.a.createElement("strong",null,s),a.a.createElement("div",null,n))}}static async validateServerConfigWithStaticUrls(e,t,s=!1){if(!e)throw Object(c.h)(Object(c.b)("No homeserver URL provided"));const n={"m.homeserver":{base_url:e}};t&&(n["m.identity_server"]={base_url:t});const i=await r.a.fromDiscoveryConfig(n),o=new URL(e).hostname;return h.buildValidatedConfigFromDiscovery(o,i,s,!0)}static async validateServerName(e){const t=await r.a.findClientConfig(e);return h.buildValidatedConfigFromDiscovery(e,t)}static buildValidatedConfigFromDiscovery(e,t,s=!1,n=!1){if(!t||!t["m.homeserver"])throw console.error("Ended up in a state of not knowing which homeserver to connect to."),Object(c.h)(Object(c.b)("Unexpected error resolving homeserver configuration"));const i=t["m.homeserver"],o=t["m.identity_server"],a=l.a.get().validated_server_config;let d=a&&a.isUrl;if(o&&o.state===r.a.SUCCESS)d=o.base_url;else if(o&&o.state!==r.a.PROMPT){if(console.error("Error determining preferred identity server URL:",o),o.state===r.a.FAIL_ERROR){if(-1!==r.a.ALL_ERRORS.indexOf(o.error))throw Object(c.h)(o.error);throw Object(c.h)(Object(c.b)("Unexpected error resolving identity server configuration"))}i.error=r.a.ERROR_INVALID_IDENTITY_SERVER,o.base_url&&(d=o.base_url)}if(i.state!==r.a.SUCCESS&&(console.error("Error processing homeserver config:",i),!s||!h.isLivelinessError(i.error))){if(-1!==r.a.ALL_ERRORS.indexOf(i.error))throw Object(c.h)(i.error);throw Object(c.h)(Object(c.b)("Unexpected error resolving homeserver configuration"))}const m=i.base_url;let p=e||i.server_name;const g=new URL(m);if(p||(p=g.hostname),!p)throw console.error("Failed to parse homeserver name from homeserver URL"),Object(c.h)(Object(c.b)("Unexpected error resolving homeserver configuration"));return function(e,t){const s=new e;return Object.assign(s,t),s}(u,{hsUrl:m,hsName:p,hsNameIsDifferent:g.hostname!==p,isUrl:d,isDefault:!1,warning:i.error,isNameResolvable:!n})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(101),c=s.n(r),l=s(129),d=s(180),u=s(174),h=s(94),m=s(102);var p,g,v=s(92),f=s(205),b=s(127),y=s(93);function _(e){switch(e){case g.Globe:return Object(v.a)("This room is public");case g.PresenceOnline:return Object(v.a)("Online");case g.PresenceAway:return Object(v.a)("Away");case g.PresenceOffline:return Object(v.a)("Offline")}}!function(e){e.None="NONE",e.Globe="GLOBE",e.PresenceOnline="ONLINE",e.PresenceAway="AWAY",e.PresenceOffline="OFFLINE"}(g||(g={}));let E=Object(y.a)("views.avatars.DecoratedRoomAvatar")(p=class extends a.a.PureComponent{constructor(e){super(e),i()(this,"_dmUser",void 0),i()(this,"isUnmounted",!1),i()(this,"isWatchingTimeline",!1),i()(this,"onRoomTimeline",(e,t)=>{if(!this.isUnmounted&&t&&this.props.room.roomId===t.roomId&&("m.room.join_rules"===e.getType()||"m.room.member"===e.getType())){const e=this.calculateIcon();e!==this.state.icon&&this.setState({icon:e})}}),i()(this,"onPresenceUpdate",()=>{if(this.isUnmounted)return;const e=this.getPresenceIcon();e!==this.state.icon&&this.setState({icon:e})}),this.state={notificationState:u.a.instance.getRoomState(this.props.room),icon:this.calculateIcon()}}componentWillUnmount(){this.isUnmounted=!0,this.isWatchingTimeline&&this.props.room.off("Room.timeline",this.onRoomTimeline),this.dmUser=null}get isPublicRoom(){const e=this.props.room.currentState.getStateEvents("m.room.join_rules","");return"public"===(e&&e.getContent().join_rule)}get dmUser(){return this._dmUser}set dmUser(e){const t=this._dmUser;this._dmUser=e,t&&t!==this._dmUser&&(t.off("User.currentlyActive",this.onPresenceUpdate),t.off("User.presence",this.onPresenceUpdate)),this._dmUser&&t!==this._dmUser&&(this._dmUser.on("User.currentlyActive",this.onPresenceUpdate),this._dmUser.on("User.presence",this.onPresenceUpdate))}getPresenceIcon(){if(!this.dmUser)return g.None;let e=g.None;return this.dmUser.currentlyActive||"online"===this.dmUser.presence?e=g.PresenceOnline:"offline"===this.dmUser.presence?e=g.PresenceOffline:"unavailable"===this.dmUser.presence&&(e=g.PresenceAway),e}calculateIcon(){let e=g.None;const t=b.a.shared().getUserIdForRoomId(this.props.room.roomId);return t&&2===this.props.room.getJoinedMemberCount()?function(){const e=h.a.get().baseUrl,t=m.a.get().enable_presence_by_hs_url;return!t||!(!t[e]&&void 0!==t[e])}()&&t&&(this.dmUser=h.a.get().getUser(t),e=this.getPresenceIcon()):(e=this.isPublicRoom?g.Globe:g.None,this.isWatchingTimeline||(this.props.room.on("Room.timeline",this.onRoomTimeline),this.isWatchingTimeline=!0)),e}render(){let e,t;this.props.displayBadge&&(e=a.a.createElement(d.a,{notification:this.state.notificationState,forceCount:this.props.forceCount,roomId:this.props.room.roomId})),this.state.icon!==g.None&&(t=a.a.createElement(f.a,{tooltip:_(this.state.icon),class:"mx_DecoratedRoomAvatar_icon mx_DecoratedRoomAvatar_icon_"+this.state.icon.toLowerCase()}));const s=c()("mx_DecoratedRoomAvatar",{mx_DecoratedRoomAvatar_cutout:t});return a.a.createElement("div",{className:s},a.a.createElement(l.a,{room:this.props.room,width:this.props.avatarSize,height:this.props.avatarSize,oobData:this.props.oobData,viewAvatarOnClick:this.props.viewAvatarOnClick}),t,e)}})||p},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(115),i=s.n(n),o=s(210);function a(e){return"string"==typeof e&&!!e&&"undefined"!==e&&"null"!==e||"number"==typeof e}class r{constructor(e={}){i()(this,"rooms",{}),i()(this,"groups",{}),i()(this,"users",{}),i()(this,"syncToken",null),i()(this,"filters",{}),i()(this,"accountData",{}),i()(this,"localStorage",void 0),i()(this,"oobMembers",{}),i()(this,"clientOptions",{}),i()(this,"onRoomMember",(e,t,s)=>{if("invite"===s.membership)return;const n=this.users[s.userId]||new o.a(s.userId);s.name&&(n.setDisplayName(s.name),s.events.member&&n.setRawDisplayName(s.events.member.getDirectionalContent().displayname)),s.events.member&&s.events.member.getContent().avatar_url&&n.setAvatarUrl(s.events.member.getContent().avatar_url),this.users[n.userId]=n}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeGroup(e){this.groups[e.groupId]=e}getGroup(e){return this.groups[e]||null}getGroups(){return Object.values(this.groups)}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on("RoomState.members",this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].removeListener("RoomState.members",this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map((function(e){return e.summary}))}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,s,n){}storeFilter(e){e&&(this.filters[e.userId]||(this.filters[e.userId]={}),this.filters[e.userId][e.filterId]=e)}getFilter(e,t){return this.filters[e]&&this.filters[e][t]?this.filters[e][t]:null}getFilterIdByName(e){if(!this.localStorage)return null;const t="mxjssdk_memory_filter_"+e;try{const e=this.localStorage.getItem(t);if(a(e))return e}catch(e){}return null}setFilterIdByName(e,t){if(!this.localStorage)return;const s="mxjssdk_memory_filter_"+e;try{a(t)?this.localStorage.setItem(s,t):this.localStorage.removeItem(s)}catch(e){}}storeAccountDataEvents(e){e.forEach(e=>{this.accountData[e.getType()]=e})}getAccountData(e){return this.accountData[e]}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers[e]||null)}setOutOfBandMembers(e,t){return this.oobMembers[e]=t,Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers={},Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(1);function i(e,t,s,i,o,a=!1){if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return a?t:"";let r=t.slice(6),c="/_matrix/media/r0/download/";const l={};s&&(l.width=Math.round(s)),i&&(l.height=Math.round(i)),o&&(l.method=o),Object.keys(l).length>0&&(c="/_matrix/media/r0/thumbnail/");const d=r.indexOf("#");let u="";d>=0&&(u=r.substr(d),r=r.substr(0,d));return e+c+r+(0===Object.keys(l).length?"":"?"+n.k(l))+u}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(113);const d=e=>{let{isExpanded:t,children:s,onClick:n,onContextMenu:o}=e,r=a()(e,["isExpanded","children","onClick","onContextMenu"]);return c.a.createElement(l.a,i()({},r,{onClick:n,onContextMenu:o||n,"aria-haspopup":!0,"aria-expanded":t}),s)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(1),i=s(0);const o=["override","content","room","sender","underride"],a=[{rule_id:".m.rule.tombstone",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.room.tombstone"},{kind:"event_match",key:"state_key",pattern:""}],actions:["notify",{set_tweak:"highlight",value:!0}]},{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.reaction"}],actions:["dont_notify"]}];function r(e){const t={},s=(e,t)=>{for(let s=0;s<o.length;++s){const n=o[s],a=t[n];if(a)for(let t=0;t<a.length;++t){const s=a[t];if(!s.enabled)continue;const o=i(n,s);if(o&&this.ruleMatchesEvent(o,e))return s.kind=n,s}}return null},i=function(e,t){const s={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case"underride":case"override":s.conditions=t.conditions;break;case"room":if(!t.rule_id)return null;s.conditions.push({kind:"event_match",key:"room_id",value:t.rule_id});break;case"sender":if(!t.rule_id)return null;s.conditions.push({kind:"event_match",key:"user_id",value:t.rule_id});break;case"content":if(!t.pattern)return null;s.conditions.push({kind:"event_match",key:"content.body",pattern:t.pattern})}return s},a=function(e,t){const s={event_match:u,contains_display_name:d,room_member_count:l,sender_notification_permission:c};return!!s[e.kind]&&s[e.kind](e,t)},c=function(t,s){const n=t.key;if(!n)return!1;const i=e.getRoom(s.getRoomId());return!(!i||!i.currentState)&&i.currentState.mayTriggerNotifOfType(n,s.getSender())},l=function(t,s){if(!t.is)return!1;const n=e.getRoom(s.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;const i=n.currentState.getJoinedMemberCount(),o=t.is.match(/^([=<>]*)([0-9]*)$/);if(!o)return!1;const a=o[1],r=parseInt(o[2]);if(isNaN(r))return!1;switch(a){case"":case"==":return i==r;case"<":return i<r;case">":return i>r;case"<=":return i<=r;case">=":return i>=r;default:return!1}},d=function(t,s){let i=s.getContent();if(s.isEncrypted()&&s.getClearContent()&&(i=s.getClearContent()),!i||!i.body||"string"!=typeof i.body)return!1;const o=e.getRoom(s.getRoomId());if(!(o&&o.currentState&&o.currentState.members&&o.currentState.getMember(e.credentials.userId)))return!1;const a=o.currentState.getMember(e.credentials.userId).name,r=new RegExp("(^|\\W)"+Object(n.n)(a)+"(\\W|$)","i");return i.body.search(r)>-1},u=function(e,t){if(!e.key)return!1;const s=m(e.key,t);if("string"!=typeof s)return!1;if(e.value)return e.value===s;if("string"!=typeof e.pattern)return!1;let n;return n="content.body"==e.key?h("(^|\\W)",e.pattern,"(\\W|$)"):h("^",e.pattern,"$"),!!s.match(n)},h=function(e,s,i){return t[s]||(t[s]=new RegExp(e+Object(n.q)(s)+i,"i")),t[s]},m=function(e,t){const s=e.split(".");let i;const o=s[0];for("content"===o?(i=t.getContent(),s.shift()):"type"===o?(i=t.getType(),s.shift()):i=t.event;s.length>0;){const e=s.shift();if(Object(n.t)(i[e]))return null;i=i[e]}return i},p=function(t,n){const i=function(t,n){return n?t.getSender()===e.credentials.userId?null:s(t,n.global):null}(t,n);if(!i)return{};const o=r.actionListToActionsObject(i.actions);return void 0===o.tweaks.highlight&&(o.tweaks.highlight="content"==i.kind),o};this.ruleMatchesEvent=function(e,t){let s=!0;for(let n=0;n<e.conditions.length;++n){const i=e.conditions[n];s&=a(i,t)}return s},this.actionsForEvent=function(t){return p(t,e.pushRules)},this.getPushRuleById=function(t){for(const s of["global"])if(void 0!==e.pushRules[s])for(const n of o)if(void 0!==e.pushRules[s][n])for(const i of e.pushRules[s][n])if(i.rule_id===t)return i;return null}}r.actionListToActionsObject=function(e){const t={notify:!1,tweaks:{}};for(let s=0;s<e.length;++s){const n=e[s];"notify"===n?t.notify=!0:"object"==typeof n&&(void 0===n.value&&(n.value=!0),t.tweaks[n.set_tweak]=n.value)}return t},r.rewriteDefaultRules=function(e){let t=JSON.parse(JSON.stringify(e));t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]);const s=t.global.override;for(const e of a){const t=s.find(t=>t.rule_id===e.rule_id);if(t)t.default=e.default,t.conditions=e.conditions,t.actions=e.actions;else{const t=e.rule_id;i.a.warn("Adding default global override for "+t),s.push(e)}}return t}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i}));const n="filter_changed";let i;!function(e){e[e.Prefilter=0]="Prefilter",e[e.Runtime=1]="Runtime"}(i||(i={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(98);function i(e,t){const s=t?e=>t[e]:t=>n.b.getValue(t,e.getRoomId());if(e.isRedacted()&&!s("showRedactions"))return!0;if(e.isRelation("m.replace"))return!0;const i=function(e){const t={isMemberEvent:"m.room.member"===e.getType()};if(!t.isMemberEvent)return t;const s=e.getContent(),n=e.getPrevContent(),i=s.membership!==n.membership;t.isJoin=i&&"join"===s.membership,t.isPart=i&&"leave"===s.membership&&e.getStateKey()===e.getSender();const o=!i&&"join"===s.membership;return t.isDisplaynameChange=o&&s.displayname!==n.displayname,t.isAvatarChange=o&&s.avatar_url!==n.avatar_url,t}(e);if(i.isMemberEvent){if((i.isJoin||i.isPart)&&!s("showJoinLeaves"))return!0;if(i.isAvatarChange&&!s("showAvatarChanges"))return!0;if(i.isDisplaynameChange&&!s("showDisplaynameChanges"))return!0}return!1}},,function(e,t,s){"use strict";s.d(t,"c",(function(){return o})),s.d(t,"d",(function(){return a})),s.d(t,"e",(function(){return r})),s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return u}));var n=s(844);const i=new Map,o=new Map,a=new Map,r=e=>i.get(d(e)),c=["people","people","control","nature","foods","places","activity","objects","symbols","flags"],l={people:[],nature:[],foods:[],places:[],activity:[],objects:[],symbols:[],flags:[]};function d(e){return e.replace(/[\uFE00-\uFE0F]$/,"")}n.forEach(e=>{const t=c[e.group];l.hasOwnProperty(t)&&l[t].push(e),e.filterString=(`${e.annotation}\n${e.shortcodes.join("\n")}}\n${e.emoticon||""}\n`+e.unicode.split("‍").join("\n")).toLowerCase(),i.set(d(e.unicode),e),e.emoticon&&o.set(e.emoticon,e),e.shortcodes&&e.shortcodes.forEach(t=>{a.set(t,e)})});const u=n},,,,function(e,t,s){"use strict";(function(e){s.d(t,"h",(function(){return u})),s.d(t,"i",(function(){return h})),s.d(t,"e",(function(){return m})),s.d(t,"f",(function(){return p})),s.d(t,"g",(function(){return g})),s.d(t,"d",(function(){return v})),s.d(t,"c",(function(){return b})),s.d(t,"b",(function(){return y})),s.d(t,"a",(function(){return _})),s.d(t,"j",(function(){return E}));var n=s(115),i=s.n(n),o=s(876),a=s(1),r=s(0),c=s(877);function l(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function d(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?l(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):l(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const u="/_matrix/client/r0",h="/_matrix/client/unstable",m="/_matrix/identity/api/v1",p="/_matrix/identity/v2",g="/_matrix/media/r0";function v(e,t){a.e(t,["baseUrl","request","prefix"]),t.onlyData=t.onlyData||!1,this.event_emitter=e,this.opts=t,this.useAuthorizationHeader=Boolean(t.useAuthorizationHeader),this.uploads=[]}v.prototype={setIdBaseUrl:function(e){this.opts.idBaseUrl=e},getContentUri:function(){const e={access_token:this.opts.accessToken};return{base:this.opts.baseUrl,path:"/_matrix/media/r0/upload",params:e}},uploadContent:function(t,s){a.s(s)?s={callback:s}:void 0===s&&(s={});const n=!1!==s.includeFilename,i=s.type||t.type||"application/octet-stream",o=s.name||t.name;let l=t;l.stream&&"function"!=typeof l.stream&&(r.a.warn("Using `file.stream` as the content to upload. Future versions of the js-sdk will change this to expect `file` to be the content directly."),l=l.stream);let d=s.rawResponse;void 0===d&&(e.XMLHttpRequest?d=!1:(r.a.warn("Returning the raw JSON from uploadContent(). Future versions of the js-sdk will change this default, to return the parsed object. Set opts.rawResponse=false to change this behaviour now."),d=!0));let u=s.onlyContentUri;d||void 0!==u||(e.XMLHttpRequest?(r.a.warn("Returning only the content-uri from uploadContent(). Future versions of the js-sdk will change this default, to return the whole response object. Set opts.onlyContentUri=false to change this behaviour now."),u=!0):u=!1);const h={loaded:0,total:0};let m,p=null;if(d||(p=function(e){let t=JSON.parse(e);if(u&&(t=t.content_uri,void 0===t))throw Error("Bad response");return t}),e.XMLHttpRequest){const t=a.j(),r=new e.XMLHttpRequest;h.xhr=r;const d=f(t,s.callback,this.opts.onlyData),u=function(){r.abort(),d(new Error("Timeout"))};r.timeout_timer=c.b(u,3e4),r.onreadystatechange=function(){let t;switch(r.readyState){case e.XMLHttpRequest.DONE:c.a(r.timeout_timer);try{if(0===r.status)throw new _;if(!r.responseText)throw new Error("No response body.");t=r.responseText,p&&(t=p(t))}catch(e){return e.http_status=r.status,void d(e)}d(void 0,r,t)}},r.upload.addEventListener("progress",(function(e){c.a(r.timeout_timer),h.loaded=e.loaded,h.total=e.total,r.timeout_timer=c.b(u,3e4),s.progressHandler&&s.progressHandler({loaded:e.loaded,total:e.total})}));let g=this.opts.baseUrl+"/_matrix/media/r0/upload";const v=[];n&&o&&v.push("filename="+encodeURIComponent(o)),this.useAuthorizationHeader||v.push("access_token="+encodeURIComponent(this.opts.accessToken)),v.length>0&&(g+="?"+v.join("&")),r.open("POST",g),this.useAuthorizationHeader&&r.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),r.setRequestHeader("Content-Type",i),r.send(l),m=t.promise,m.abort=r.abort.bind(r)}else{const e={};n&&o&&(e.filename=o),m=this.authedRequest(s.callback,"POST","/upload",e,l,{prefix:"/_matrix/media/r0",headers:{"Content-Type":i},json:!1,bodyParser:p})}const g=this,v=m.finally((function(){for(let e=0;e<g.uploads.length;++e)if(g.uploads[e]===h)return void g.uploads.splice(e,1)}));return v.abort=m.abort,h.promise=v,this.uploads.push(h),v},cancelUpload:function(e){return!!e.abort&&(e.abort(),!0)},getCurrentUploads:function(){return this.uploads},idServerRequest:function(e,t,s,n,i,o){if(!this.opts.idBaseUrl)throw new Error("No Identity Server base URL set");const r=this.opts.idBaseUrl+i+s;if(void 0!==e&&!a.s(e))throw Error("Expected callback to be a function but got "+typeof e);const c={uri:r,method:t,withCredentials:!1,json:!0,_matrix_opts:this.opts,headers:{}};"GET"===t?c.qs=n:"object"==typeof n&&(c.json=n),o&&(c.headers.Authorization="Bearer "+o);const l=a.j();return this.opts.request(c,f(l,e,this.opts.onlyData)),l.promise},authedRequest:function(e,t,s,n,i,o){n||(n={}),this.useAuthorizationHeader?(isFinite(o)&&(o={localTimeoutMs:o}),o||(o={}),o.headers||(o.headers={}),o.headers.Authorization||(o.headers.Authorization="Bearer "+this.opts.accessToken),n.access_token&&delete n.access_token):n.access_token||(n.access_token=this.opts.accessToken);const a=this.request(e,t,s,n,i,o),r=this;return a.catch((function(e){"M_UNKNOWN_TOKEN"==e.errcode?r.event_emitter.emit("Session.logged_out",e):"M_CONSENT_NOT_GIVEN"==e.errcode&&r.event_emitter.emit("no_consent",e.message,e.data.consent_uri)})),a},request:function(e,t,s,n,i,o){const a=void 0!==(o=o||{}).prefix?o.prefix:this.opts.prefix,r=this.opts.baseUrl+a+s;return this.requestOtherUrl(e,t,r,n,i,o)},requestOtherUrl:function(e,t,s,n,i,o){return null==o?o={}:isFinite(o)&&(o={localTimeoutMs:o}),this._request(e,t,s,n,i,o)},getUrl:function(e,t,s){let n="";return t&&(n="?"+a.k(t)),this.opts.baseUrl+s+e+n},_request:function(e,t,s,n,i,o){if(void 0!==e&&!a.s(e))throw Error("Expected callback to be a function but got "+typeof e);o=o||{};const r=this;this.opts.extraParams&&(n=d(d({},n),this.opts.extraParams));const l=a.o({},o.headers||{}),u=void 0===o.json||o.json;let h=o.bodyParser;u&&(i&&(i=JSON.stringify(i),l["content-type"]="application/json"),l.accept||(l.accept="application/json"),void 0===h&&(h=function(e){return JSON.parse(e)}));const m=a.j();let p,g,v=!1;const y=o.localTimeoutMs||this.opts.localTimeoutMs,_=()=>{y&&(p&&c.a(p),p=c.b((function(){v=!0,g&&g.abort&&g.abort(),m.reject(new b({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:y}))}),y))};_();const E=m.promise;try{g=this.opts.request({uri:s,method:t,withCredentials:!1,qs:n,qsStringifyOptions:o.qsStringifyOptions,useQuerystring:!0,body:i,json:!1,timeout:y,headers:l||{},_matrix_opts:this.opts},(function(t,s,n){if(y&&(c.a(p),v))return;f(m,e,r.opts.onlyData,h)(t,s,n)})),g&&("onprogress"in g&&(g.onprogress=e=>{_()}),g.abort&&(E.abort=g.abort.bind(g)))}catch(t){m.reject(t),e&&e(t)}return E}};const f=function(e,t,s,n){return t=t||function(){},function(i,a,r){if(i){"AbortError"===i.name||"aborted"===i||i instanceof b||(i=new y("request failed",i))}if(!i)try{(a.status||a.statusCode)>=400?i=function(e,t){const s=e.status||e.statusCode,n=function(e){let t;e.getResponseHeader?t=e.getResponseHeader("Content-Type"):e.headers&&(t=e.headers["content-type"]||null);if(!t)return null;try{return Object(o.parse)(t)}catch(e){throw new Error(`Error parsing Content-Type '${t}': ${e}`)}}(e);let i;if(n)if("application/json"===n.type){const e="object"==typeof t?t:JSON.parse(t);i=new b(e)}else"text/plain"===n.type&&(i=new Error(`Server returned ${s} error: ${t}`));i||(i=new Error(`Server returned ${s} error`));return i.httpStatus=s,i}(a,r):n&&(r=n(r))}catch(e){i=new Error("Error parsing server response: "+e)}if(i)e.reject(i),t(i);else{const n={code:a.status||a.statusCode,headers:a.headers,data:r};e.resolve(s?r:n),t(null,s?r:n)}}};class b extends Error{constructor(e){super("MatrixError: "+(e=e||{}).errcode),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.message=e.error||"Unknown message",this.data=e}}class y extends Error{constructor(e,t){super(e+(t?": "+t.message:"")),this._cause=t}get name(){return"ConnectionError"}get cause(){return this._cause}}class _ extends Error{constructor(){super("Operation aborted")}get name(){return"AbortError"}}async function E(e,t){let s=0,n=null;for(;s<e;)try{if(s>0){const e=1e3*Math.pow(2,s);r.a.log(`network operation failed ${s} times, retrying in ${e}ms...`),await new Promise(t=>setTimeout(t,e))}return await t()}catch(e){if(!(e instanceof y))throw e;s+=1,n=e}throw n}}).call(this,s(7))},function(e,t,s){"use strict";s.d(t,"c",(function(){return a})),s.d(t,"d",(function(){return r})),s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(199),i=s(102),o=s(94);function a(){return i.a.get().validated_server_config.isUrl}function r(){const e=a();o.a.get().setAccountData("m.identity_server",{base_url:e})}async function c(e){let t;try{t=await o.a.get().getTerms(n.a.IS,e)}catch(e){if(console.error(e),"rejected"!==e.cors&&404!==e.httpStatus)throw e;t=null}return t&&t.policies&&Object.keys(t.policies).length>0}function l(){const e=o.a.get().getAccountData("m.identity_server");return e&&e.getContent()&&e.getContent().base_url}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(115),i=s.n(n),o=s(0),a=s(1);function r(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function c(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?r(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):r(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class l{constructor(){this._outgoingRoomKeyRequests=[],this._account=null,this._crossSigningKeys=null,this._privateKeys={},this._backupKeys={},this._sessions={},this._sessionProblems={},this._notifiedErrorDevices={},this._inboundGroupSessions={},this._inboundGroupSessionsWithheld={},this._deviceData=null,this._rooms={},this._sessionsNeedingBackup={},this._sharedHistoryInboundGroupSessions={}}async startup(){return this}deleteAllData(){return Promise.resolve()}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return a.B(()=>{const s=this._getOutgoingRoomKeyRequest(t);return s?(o.a.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),s):(o.a.log(`enqueueing key request for ${t.room_id} / `+t.session_id),this._outgoingRoomKeyRequests.push(e),e)})}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(const t of this._outgoingRoomKeyRequests)if(a.g(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(const t of this._outgoingRoomKeyRequests)for(const s of e)if(t.state===s)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this._outgoingRoomKeyRequests.filter(t=>t.state==e))}getOutgoingRoomKeyRequestsByTarget(e,t,s){const n=[];for(const i of this._outgoingRoomKeyRequests)for(const o of s)i.state===o&&i.recipients.includes({userId:e,deviceId:t})&&n.push(i);return Promise.resolve(n)}updateOutgoingRoomKeyRequest(e,t,s){for(const n of this._outgoingRoomKeyRequests)if(n.requestId===e)return n.state!=t?(o.a.warn(`Cannot update room key request from ${t} as it was already updated to `+n.state),Promise.resolve(null)):(Object.assign(n,s),Promise.resolve(n));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let s=0;s<this._outgoingRoomKeyRequests.length;s++){const n=this._outgoingRoomKeyRequests[s];if(n.requestId===e)return n.state!=t?(o.a.warn(`Cannot delete room key request in state ${n.state} (expected ${t})`),Promise.resolve(null)):(this._outgoingRoomKeyRequests.splice(s,1),Promise.resolve(n))}return Promise.resolve(null)}getAccount(e,t){t(this._account)}storeAccount(e,t){this._account=t}getCrossSigningKeys(e,t){t(this._crossSigningKeys)}getSecretStorePrivateKey(e,t,s){return t(this._privateKeys[s]||null)}storeCrossSigningKeys(e,t){this._crossSigningKeys=t}storeSecretStorePrivateKey(e,t,s){this._privateKeys[t]=s}countEndToEndSessions(e,t){return Object.keys(this._sessions).length}getEndToEndSession(e,t,s,n){n((this._sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,s){s(this._sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this._sessions).forEach(([e,s])=>{Object.entries(s).forEach(([s,n])=>{t(c(c({},n),{},{deviceKey:e,sessionId:s}))})})}storeEndToEndSession(e,t,s,n){let i=this._sessions[e];void 0===i&&(i={},this._sessions[e]=i),i[t]=s}async storeEndToEndSessionProblem(e,t,s){const n=this._sessionProblems[e]=this._sessionProblems[e]||[];n.push({type:t,fixed:s,time:Date.now()}),n.sort((e,t)=>e.time-t.time)}async getEndToEndSessionProblem(e,t){const s=this._sessionProblems[e]||[];if(!s.length)return null;const n=s[s.length-1];for(const e of s)if(e.time>t)return Object.assign({},e,{fixed:n.fixed});return n.fixed?null:n}async filterOutNotifiedErrorDevices(e){const t=this._notifiedErrorDevices,s=[];for(const n of e){const{userId:e,deviceInfo:i}=n;e in t?i.deviceId in t[e]||(s.push(n),t[e][i.deviceId]=!0):(s.push(n),t[e]={[i.deviceId]:!0})}return s}getEndToEndInboundGroupSession(e,t,s,n){const i=e+"/"+t;n(this._inboundGroupSessions[i]||null,this._inboundGroupSessionsWithheld[i]||null)}getAllEndToEndInboundGroupSessions(e,t){for(const e of Object.keys(this._inboundGroupSessions))t({senderKey:e.substr(0,43),sessionId:e.substr(44),sessionData:this._inboundGroupSessions[e]});t(null)}addEndToEndInboundGroupSession(e,t,s,n){const i=e+"/"+t;void 0===this._inboundGroupSessions[i]&&(this._inboundGroupSessions[i]=s)}storeEndToEndInboundGroupSession(e,t,s,n){this._inboundGroupSessions[e+"/"+t]=s}storeEndToEndInboundGroupSessionWithheld(e,t,s,n){const i=e+"/"+t;this._inboundGroupSessionsWithheld[i]=s}getEndToEndDeviceData(e,t){t(this._deviceData)}storeEndToEndDeviceData(e,t){this._deviceData=e}storeEndToEndRoom(e,t,s){this._rooms[e]=t}getEndToEndRooms(e,t){t(this._rooms)}getSessionsNeedingBackup(e){const t=[];for(const s in this._sessionsNeedingBackup)if(this._inboundGroupSessions[s]&&(t.push({senderKey:s.substr(0,43),sessionId:s.substr(44),sessionData:this._inboundGroupSessions[s]}),e&&s.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this._sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;delete this._sessionsNeedingBackup[e]}return Promise.resolve()}markSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;this._sessionsNeedingBackup[e]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,s){const n=this._sharedHistoryInboundGroupSessions[e]||[];n.push([t,s]),this._sharedHistoryInboundGroupSessions[e]=n}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this._sharedHistoryInboundGroupSessions[e]||[])}doTxn(e,t,s){return Promise.resolve(s(null))}}},function(e,t,s){"use strict";(function(e){s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return d}));var n=s(1),i=s(139);const o="undefined"!=typeof window&&window.crypto?window.crypto.subtle||window.crypto.webkitSubtle:null,a=new Uint8Array(8);function r(t,s){const i=Object(n.p)(),o=i.createHmac("sha256",a).update(t).digest(),r=e.alloc(1,1),c=i.createHmac("sha256",o).update(s,"utf-8").update(r).digest();r[0]=2;return[c,i.createHmac("sha256",o).update(c).update(s,"utf-8").update(r).digest()]}async function c(e,t){const s=await o.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),n=await o.deriveBits({name:"HKDF",salt:a,info:(new TextEncoder).encode(t),hash:"SHA-256"},s,512),i=n.slice(0,32),r=n.slice(32),c=o.importKey("raw",i,{name:"AES-CTR"},!1,["encrypt","decrypt"]),l=o.importKey("raw",r,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return await Promise.all([c,l])}function l(...e){return o?async function(e,t,s,n){let a;n?a=Object(i.decodeBase64)(n):(a=new Uint8Array(16),window.crypto.getRandomValues(a)),a[8]&=127;const[r,l]=await c(t,s),d=(new TextEncoder).encode(e),u=await o.encrypt({name:"AES-CTR",counter:a,length:64},r,d),h=await o.sign({name:"HMAC"},l,u);return{iv:Object(i.encodeBase64)(a),ciphertext:Object(i.encodeBase64)(u),mac:Object(i.encodeBase64)(h)}}(...e):async function(e,t,s,o){const a=Object(n.p)();if(!a)throw new Error("No usable crypto implementation");let c;c=o?Object(i.decodeBase64)(o):a.randomBytes(16),c[8]&=127;const[l,d]=r(t,s),u=a.createCipheriv("aes-256-ctr",l,c),h=u.update(e,"utf-8","base64")+u.final("base64"),m=a.createHmac("sha256",d).update(h,"base64").digest("base64");return{iv:Object(i.encodeBase64)(c),ciphertext:h,mac:m}}(...e)}function d(...e){return o?async function(e,t,s){const[n,a]=await c(t,s),r=Object(i.decodeBase64)(e.ciphertext);if(!await o.verify({name:"HMAC"},a,Object(i.decodeBase64)(e.mac),r))throw new Error(`Error decrypting secret ${s}: bad MAC`);const l=await o.decrypt({name:"AES-CTR",counter:Object(i.decodeBase64)(e.iv),length:64},n,r);return(new TextDecoder).decode(new Uint8Array(l))}(...e):async function(e,t,s){const o=Object(n.p)();if(!o)throw new Error("No usable crypto implementation");const[a,c]=r(t,s);if(o.createHmac("sha256",c).update(e.ciphertext,"base64").digest("base64").replace(/=+$/g,"")!==e.mac.replace(/=+$/g,""))throw new Error(`Error decrypting secret ${s}: bad MAC`);const l=o.createDecipheriv("aes-256-ctr",a,Object(i.decodeBase64)(e.iv));return l.update(e.ciphertext,"base64","utf-8")+l.final("utf-8")}(...e)}}).call(this,s(36).Buffer)},function(e,t,s){"use strict";(function(e,n){s.d(t,"d",(function(){return c})),s.d(t,"c",(function(){return l})),s.d(t,"b",(function(){return d})),s.d(t,"a",(function(){return p}));var i=s(391),o=s(276),a=s(139),r=s(0);const c="m.qr_code.show.v1",l="m.qr_code.scan.v1";class d extends i.b{static factory(...e){return new d(...e)}static get NAME(){return"m.reciprocate.v1"}async _doVerification(){if(!this.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");const{qrCodeData:e}=this.request;if(this.startEvent.getContent().secret!==e.encodedSharedSecret)throw Object(o.d)();await new Promise((e,t)=>{this.reciprocateQREvent={confirm:e,cancel:()=>t(Object(o.h)())},this.emit("show_reciprocate_qr",this.reciprocateQREvent)});const t={};switch(e.mode){case u:{const s=e.otherUserMasterKey;t["ed25519:"+s]=s;break}case h:{const s=this.request.targetDevice.deviceId;t["ed25519:"+s]=e.otherDeviceKey;break}case m:{const s=e.myMasterKey;t["ed25519:"+s]=s;break}}await this._verifyKeys(this.userId,t,(e,s,n)=>{const i=t[e];if(!i)throw Object(o.d)();if(n!==i)throw r.a.error("key ID from key info does not match"),Object(o.d)();for(const e in s.keys){if(!e.startsWith("ed25519"))continue;const n=t[e];if(!n)throw Object(o.d)();if(s.keys[e]!==n)throw r.a.error("master key does not match"),Object(o.d)()}})}}const u=0,h=1,m=2;class p{constructor(e,t,s,n,i,o){this._sharedSecret=t,this._mode=e,this._otherUserMasterKey=s,this._otherDeviceKey=n,this._myMasterKey=i,this._buffer=o}static async create(e,t){const s=p._generateSharedSecret(),n=p._determineMode(e,t);let i=null,o=null,a=null;if(n===u){i=t.getStoredCrossSigningForUser(e.otherUserId).getId("master")}else if(n===h)o=await p._getOtherDeviceKey(e,t);else if(n===m){const e=t.getUserId();a=t.getStoredCrossSigningForUser(e).getId("master")}const r=p._generateQrData(e,t,n,s,i,o,a),c=p._generateBuffer(r);return new p(n,s,i,o,a,c)}get buffer(){return this._buffer}get mode(){return this._mode}get otherDeviceKey(){return this._otherDeviceKey}get otherUserMasterKey(){return this._otherUserMasterKey}get myMasterKey(){return this._myMasterKey}get encodedSharedSecret(){return this._sharedSecret}static _generateSharedSecret(){const t=new Uint8Array(11);return e.crypto.getRandomValues(t),Object(a.encodeUnpaddedBase64)(t)}static async _getOtherDeviceKey(e,t){const s=t.getUserId(),n=e.targetDevice,i=n?n.deviceId:null,o=t.getStoredDevice(s,i);if(!o)throw new Error("could not find device "+i);return o.getFingerprint()}static _determineMode(e,t){const s=t.getUserId(),n=e.otherUserId;let i=u;if(s===n){i=t.checkUserTrust(s).isCrossSigningVerified()?h:m}return i}static _generateQrData(e,t,s,n,i,o,a){const r=t.getUserId(),c={prefix:"MATRIX",version:2,mode:s,transactionId:e.channel.transactionId,firstKeyB64:"",secondKeyB64:"",secretB64:n},l=t.getStoredCrossSigningForUser(r);return s===u?(c.firstKeyB64=l.getId("master"),c.secondKeyB64=i):s===h?(c.firstKeyB64=l.getId("master"),c.secondKeyB64=o):s===m&&(c.firstKeyB64=t.getDeviceEd25519Key(),c.secondKeyB64=a),c}static _generateBuffer(e){let t=n.alloc(0);const s=e=>{const s=n.from([e]);t=n.concat([t,s])},i=(e,s,i=!0)=>{const o=n.from(e,s);i&&(e=>{const s=n.alloc(2);s.writeInt16BE(e,0),t=n.concat([t,s])})(o.byteLength),t=n.concat([t,o])},o=e=>{const s=Object(a.decodeBase64)(e),i=n.from(s);t=n.concat([t,i])};return i(e.prefix,"ascii",!1),s(e.version),s(e.mode),i(e.transactionId,"utf-8"),o(e.firstKeyB64),o(e.secondKeyB64),o(e.secretB64),t}}}).call(this,s(7),s(36).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"h",(function(){return o})),s.d(t,"e",(function(){return a})),s.d(t,"g",(function(){return r})),s.d(t,"f",(function(){return c})),s.d(t,"d",(function(){return l})),s.d(t,"c",(function(){return d})),s.d(t,"b",(function(){return u}));var n=s(114);function i(e,t){return function(s){return function(e,t,s){const i=Object.assign({},{code:e,reason:t},s);return new n.b({type:"m.key.verification.cancel",content:i})}(e,t,s)}}const o=i("m.user","Cancelled by user"),a=i("m.timeout","Timed out"),r=(i("m.unknown_transaction","Unknown transaction"),i("m.unknown_method","Unknown method")),c=i("m.unexpected_message","Unexpected message"),l=i("m.key_mismatch","Key mismatch"),d=(i("m.user_error","User mismatch"),i("m.invalid_message","Invalid message"));function u(e){const t=e.getContent();if(t){const{code:e,reason:s}=t;return{code:e,reason:s}}return{code:"Unknown error",reason:"m.unknown"}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l})),s.d(t,"d",(function(){return d})),s.d(t,"c",(function(){return u}));var n=s(101),i=s.n(n),o=s(94),a=s(95),r=s(99);class c extends Error{}class l{constructor(e,t,s){this.serviceType=e,this.baseUrl=t,this.accessToken=s}}async function d(e,t=u){const s=e.map(e=>o.a.get().getTerms(e.serviceType,e.baseUrl)),n=(await Promise.all(s)).map((t,s)=>({service:e[s],policies:t.policies})),i=await o.a.get().getAccountData("m.accepted_terms");let a;a=i&&i.getContent()&&i.getContent().accepted?new Set(i.getContent().accepted):new Set;const r=[];for(const{service:e,policies:t}of n){const s={};for(const[e,n]of Object.entries(t)){let t=!1;for(const e of Object.keys(n))if("version"!==e&&a.has(n[e].url)){t=!0;break}t||(s[e]=n)}Object.keys(s).length>0&&r.push({service:e,policies:s})}const c=a.size;if(r.length>0){const e=await t(r,[...a]);console.log("User has agreed to URLs",e),e.forEach(e=>a.add(e))}else console.log("User has already agreed to all required policies");if(a.size!==c){const e={accepted:Array.from(a)};await o.a.get().setAccountData("m.accepted_terms",e)}const l=n.map(e=>{const t=Array.from(a).filter(t=>{for(const s of Object.values(e.policies))for(const e of Object.keys(s))if("version"!==e&&s[e].url===t)return!0;return!1});return 0===t.length?Promise.resolve():o.a.get().agreeToTerms(e.service.serviceType,e.service.baseUrl,e.service.accessToken,t)});return Promise.all(l)}function u(e,t,s){return new Promise((n,o)=>{console.log("Terms that need agreement",e);const l=a.getComponent("views.dialogs.TermsDialog");r.a.createTrackedDialog("Terms of Service","",l,{policiesAndServicePairs:e,agreedUrls:t,onFinished:(e,t)=>{e?n(t):o(new c)}},i()("mx_TermsDialog",s))})}},function(e,t,s){"use strict";(function(e){var n=s(8),i=s.n(n),o=s(94),a=s(245);class r extends i.a{constructor(){super(),this._persistentWidgetId=null,this._roomIdByWidgetId={},this.onRoomStateEvents=this.onRoomStateEvents.bind(this),this.dispatcherRef=null}start(){o.a.get().on("RoomState.events",this.onRoomStateEvents)}stop(){o.a.get()&&o.a.get().removeListener("RoomState.events",this.onRoomStateEvents),this._roomIdByWidgetId={}}onRoomStateEvents(e,t){"im.vector.modular.widgets"===e.getType()&&e.getStateKey()===this._persistentWidgetId&&this.destroyPersistentWidget(this._persistentWidgetId)}destroyPersistentWidget(e){if(e!==this._persistentWidgetId)return;const t=this._persistentWidgetId;a.a.instance.stopMessagingById(e),this.setWidgetPersistence(t,!1),this.delRoomId(t)}setWidgetPersistence(e,t){this._persistentWidgetId!==e||t?this._persistentWidgetId!==e&&t&&(this._persistentWidgetId=e):this._persistentWidgetId=null,this.emit("update")}getWidgetPersistence(e){return this._persistentWidgetId===e}getPersistentWidgetId(){return this._persistentWidgetId}getRoomId(e){return this._roomIdByWidgetId[e]}setRoomId(e,t){this._roomIdByWidgetId[e]=t,this.emit("update")}delRoomId(e){delete this._roomIdByWidgetId[e],this.emit("update")}}void 0===e.singletonActiveWidgetStore&&(e.singletonActiveWidgetStore=new r),t.a=e.singletonActiveWidgetStore}).call(this,s(7))},,function(e,t,s){"use strict";s.d(t,"b",(function(){return v})),s.d(t,"a",(function(){return f})),s.d(t,"f",(function(){return b})),s.d(t,"c",(function(){return y})),s.d(t,"d",(function(){return _})),s.d(t,"e",(function(){return E}));var n=s(91),i=s.n(n),o=s(110),a=s(122),r=s(99),c=s(585),l=s(446),d=s(676),u=s(137),h=s(92),m=s(445),p=s(226),g=s(157);const v=(e,t)=>{const s=e.getUserId();return"join"===t.getMyMembership()&&(t.currentState.maySendStateEvent(o.a.RoomAvatar,s)||t.currentState.maySendStateEvent(o.a.RoomName,s)||t.currentState.maySendStateEvent(o.a.RoomTopic,s)||t.currentState.maySendStateEvent(o.a.RoomJoinRules,s))},f=(e,t=!1)=>({type:o.a.SpaceParent,content:{via:Object(a.b)(e),canonical:t},state_key:e.roomId}),b=(e,t)=>{r.a.createTrackedDialog("Space Settings","",c.a,{matrixClient:e,space:t},null,!1,!0)},y=async(e,t)=>r.a.createTrackedDialog("Space Landing","Add Existing",l.b,{matrixClient:e,onCreateRoomClick:_,space:t},"mx_AddExistingToSpaceDialog_wrapper").finished,_=async(e,t)=>{const s=r.a.createTrackedDialog("Space Landing","Create Room",d.a,{defaultPublic:"public"===t.getJoinRule(),parentSpace:t}),[n,i]=await s.finished;return n&&await Object(u.b)(i),n},E=(e,t="")=>{if("public"===e.getJoinRule()){const t=r.a.createTrackedDialog("Space Invite","User Menu",p.a,{title:Object(h.a)("Invite to %(spaceName)s",{spaceName:e.name}),description:i.a.createElement(i.a.Fragment,null,i.a.createElement("span",null,Object(h.a)("Share your public space")),i.a.createElement(m.a,{space:e,onFinished:()=>t.close()})),fixedWidth:!1,button:!1,className:"mx_SpacePanel_sharePublicSpace",hasCloseButton:!0})}else Object(g.g)(e.roomId,t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(111),m=s(96),p=s(117),g=s(100),v=s(101),f=s.n(v),b=s(93);let y=Object(b.a)("structures.SearchBox")((o=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onAction",e=>{if(this.props.enableRoomSearchFocus)switch(e.action){case"view_room":this._search.current&&e.clear_search&&this._clearSearch();break;case"focus_room_filter":this._search.current&&this._search.current.focus()}}),r()(this,"onChange",()=>{this._search.current&&(this.setState({searchTerm:this._search.current.value}),this.onSearch())}),r()(this,"onSearch",Object(p.throttle)(()=>{this.props.onSearch(this._search.current.value)},200,{trailing:!0,leading:!0})),r()(this,"_onKeyDown",e=>{switch(e.key){case h.a.ESCAPE:this._clearSearch("keyboard")}this.props.onKeyDown&&this.props.onKeyDown(e)}),r()(this,"_onFocus",e=>{this.setState({blurred:!1}),e.target.select(),this.props.onFocus&&this.props.onFocus(e)}),r()(this,"_onBlur",e=>{this.setState({blurred:!0}),this.props.onBlur&&this.props.onBlur(e)}),this._search=Object(c.createRef)(),this.state={searchTerm:this.props.initialValue||"",blurred:!0}}componentDidMount(){this.dispatcherRef=m.a.register(this.onAction)}componentWillUnmount(){m.a.unregister(this.dispatcherRef)}_clearSearch(e){this._search.current.value="",this.onChange(),this.props.onCleared&&this.props.onCleared(e)}render(){if(this.props.collapsed)return null;const e=!this.state.blurred||this.state.searchTerm?l.a.createElement(g.a,{key:"button",tabIndex:-1,className:"mx_SearchBox_closeButton",onClick:()=>{this._clearSearch("button")}}):void 0,t=this.state.blurred&&this.props.blurredPlaceholder||this.props.placeholder,s=this.props.className||"";return l.a.createElement("div",{className:f()("mx_SearchBox","mx_textinput",{mx_SearchBox_blurred:this.state.blurred})},l.a.createElement("input",{key:"searchfield",type:"text",ref:this._search,className:"mx_textinput_icon mx_textinput_search "+s,value:this.state.searchTerm,onFocus:this._onFocus,onChange:this.onChange,onKeyDown:this._onKeyDown,onBlur:this._onBlur,placeholder:t,autoComplete:"off",autoFocus:this.props.autoFocus}),e)}},r()(i,"propTypes",{onSearch:u.a.func,onCleared:u.a.func,onKeyDown:u.a.func,className:u.a.string,placeholder:u.a.string.isRequired,autoFocus:u.a.bool,initialValue:u.a.string,enableRoomSearchFocus:u.a.bool}),r()(i,"defaultProps",{enableRoomSearchFocus:!1}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b})),s.d(t,"b",(function(){return E}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(100),u=s(92),h=s(101),m=s.n(h),p=s(206),g=s(93),v=s(130),f=s(411);let b;!function(e){e.Admin="admin",e.Moderator="moderator"}(b||(b={}));const y={[b.Admin]:Object(u.b)("Admin"),[b.Moderator]:Object(u.b)("Mod")},_={offline:"mx_EntityTile_offline",online:"mx_EntityTile_online",unavailable:"mx_EntityTile_unavailable"};let E=Object(g.a)("views.rooms.EntityTile")((o=i=class extends l.a.PureComponent{constructor(e){super(e),this.state={hover:!1}}render(){const e={mx_EntityTile:!0,mx_EntityTile_noHover:this.props.suppressOnHover};this.props.className&&(e[this.props.className]=!0);var t,n;let i;e[(t=this.props.presenceState,n=this.props.presenceLastActiveAgo,!1===this.props.showPresence?"mx_EntityTile_online_beenactive":"offline"===t?n?_.offline+"_beenactive":_.offline+"_neveractive":t?_[t]:_.offline+"_neveractive")]=!0;const{name:o}=this.props;if(this.props.suppressOnHover)i=this.props.subtextLabel?l.a.createElement("div",{className:"mx_EntityTile_details"},l.a.createElement("div",{className:"mx_EntityTile_name",dir:"auto"},o),l.a.createElement("span",{className:"mx_EntityTile_subtext"},this.props.subtextLabel)):l.a.createElement("div",{className:"mx_EntityTile_name",dir:"auto"},o);else{const e=this.props.presenceLastActiveAgo?Date.now()-(this.props.presenceLastTs-this.props.presenceLastActiveAgo):-1;let t=null;this.props.showPresence&&(t=l.a.createElement(f.a,{activeAgo:e,currentlyActive:this.props.presenceCurrentlyActive,presenceState:this.props.presenceState})),this.props.subtextLabel&&(t=l.a.createElement("span",{className:"mx_EntityTile_subtext"},this.props.subtextLabel)),i=l.a.createElement("div",{className:"mx_EntityTile_details"},l.a.createElement("div",{className:"mx_EntityTile_name",dir:"auto"},o),t)}let a,r;this.props.showInviteButton&&(a=l.a.createElement("div",{className:"mx_EntityTile_invite"},l.a.createElement("img",{src:s(971),width:"16",height:"16"})));const c=this.props.powerStatus;if(c){const e=y[c];r=l.a.createElement("div",{className:"mx_EntityTile_power"},e)}let u;const{e2eStatus:h}=this.props;h&&(u=l.a.createElement(p.b,{status:h,isUser:!0,bordered:!0}));const g=this.props.avatarJsx||l.a.createElement(v.a,{name:this.props.name,width:36,height:36,"aria-hidden":"true"});return l.a.createElement("div",null,l.a.createElement(d.a,{className:m()(e),title:this.props.title,onClick:this.props.onClick},l.a.createElement("div",{className:"mx_EntityTile_avatar"},g,u),i,r,a))}},r()(i,"defaultProps",{onClick:()=>{},presenceState:"offline",presenceLastActiveAgo:0,presenceLastTs:0,showInviteButton:!1,suppressOnHover:!1,showPresence:!0}),n=o))||n},function(e,t){e.exports="img/ellipsis.c2118e5.svg"},,function(e,t,s){"use strict";s.d(t,"a",(function(){return D}));var n,i=s(104),o=s.n(i),a=s(18),r=s.n(a),c=s(136),l=s.n(c),d=s(91),u=s.n(d),h=s(97),m=s.n(h),p=s(94),g=s(100),v=s(92),f=s(602),b=s(603),y=s(119),_=s(96),E=s(278),S=s(101),w=s.n(S),C=s(98),k=s(109),O=s(332),R=s(161),I=s(747),x=s(5),T=s(138),j=s(352),N=s(419),P=s(93);let D=Object(P.a)("views.elements.AppTile")(n=class extends u.a.Component{constructor(e){super(e),r()(this,"hasPermissionToLoad",e=>{if(this._usingLocalWidget())return!0;if(!e.room)return!0;const t=C.b.getValue("allowedWidgets",e.room.roomId);return void 0===t[e.app.eventId]?e.userId===e.creatorUserId:!!t[e.app.eventId]}),r()(this,"onAllowedWidgetsChange",()=>{const e=this.hasPermissionToLoad(this.props);this.state.hasPermissionToLoad&&!e&&(E.a.destroyPersistentWidget(this.props.app.id),O.a.destroyElement(this._persistKey),this._sgWidget&&this._sgWidget.stop()),this.setState({hasPermissionToLoad:e})}),r()(this,"_iframeRefChange",e=>{this.iframe=e,e?this._sgWidget&&this._sgWidget.start(e):this._resetWidget(this.props)}),r()(this,"_onWidgetPrepared",()=>{this.setState({loading:!1})}),r()(this,"_onWidgetReady",()=>{R.a.JITSI.matches(this.props.app.type)&&this._sgWidget.widgetApi.transport.send(x.a.ClientReady,{})}),r()(this,"_onAction",e=>{if(e.widgetId===this.props.app.id)switch(e.action){case"m.sticker":this._sgWidget.widgetApi.hasCapability(T.MatrixCapabilities.StickerSending)?_.a.dispatch({action:"post_sticker_message",data:e.data}):console.warn("Ignoring sticker message. Invalid capability")}}),r()(this,"_grantWidgetPermission",()=>{const e=this.props.room.roomId;console.info("Granting permission for widget to load: "+this.props.app.eventId);const t=C.b.getValue("allowedWidgets",e);t[this.props.app.eventId]=!0;const s=C.b.firstSupportedLevel("allowedWidgets");C.b.setValue("allowedWidgets",e,s,t).then(()=>{this.setState({hasPermissionToLoad:!0}),this._startWidget()}).catch(e=>{console.error(e)})}),r()(this,"_onPopoutWidgetClick",()=>{R.a.JITSI.matches(this.props.app.type)&&this._endWidgetActions().then(()=>{this.iframe&&(this.iframe.src=this._sgWidget.embedUrl,this.setState({}))}),Object.assign(document.createElement("a"),{target:"_blank",href:this._sgWidget.popoutUrl,rel:"noreferrer noopener"}).click()}),r()(this,"_onContextMenuClick",()=>{this.setState({menuDisplayed:!0})}),r()(this,"_closeContextMenu",()=>{this.setState({menuDisplayed:!1})}),this._persistKey=Object(O.b)(this.props.app.id);try{this._sgWidget=new I.b(this.props),this._sgWidget.on("preparing",this._onWidgetPrepared),this._sgWidget.on("ready",this._onWidgetReady)}catch(e){console.log("Failed to construct widget",e),this._sgWidget=null}this.iframe=null,this.state=this._getNewState(e),this._contextMenuButton=Object(d.createRef)(),this._allowedWidgetsWatchRef=C.b.watchSetting("allowedWidgets",null,this.onAllowedWidgetsChange)}_getNewState(e){return{initialising:!0,loading:this.props.waitForIframeLoad&&!O.a.isMounted(this._persistKey),hasPermissionToLoad:this.hasPermissionToLoad(e),error:null,widgetPageTitle:e.widgetPageTitle,menuDisplayed:!1}}isMixedContent(){const e=window.location.protocol,t=l.a.parse(this.props.app.url).protocol;return"https:"===e&&"https:"!==t&&(console.warn("Refusing to load mixed-content app:",e,t,window.location,this.props.app.url),!0)}componentDidMount(){this._sgWidget&&this.state.hasPermissionToLoad&&this._startWidget(),this.dispatcherRef=_.a.register(this._onAction)}componentWillUnmount(){this.dispatcherRef&&_.a.unregister(this.dispatcherRef),E.a.getWidgetPersistence(this.props.app.id)||(E.a.destroyPersistentWidget(this.props.app.id),O.a.destroyElement(this._persistKey)),this._sgWidget&&this._sgWidget.stop(),C.b.unwatchSetting(this._allowedWidgetsWatchRef)}_resetWidget(e){this._sgWidget&&this._sgWidget.stop();try{this._sgWidget=new I.b(e),this._sgWidget.on("preparing",this._onWidgetPrepared),this._sgWidget.on("ready",this._onWidgetReady),this._startWidget()}catch(e){console.log("Failed to construct widget",e),this._sgWidget=null}}_startWidget(){this._sgWidget.prepare().then(()=>{this.setState({initialising:!1})})}UNSAFE_componentWillReceiveProps(e){e.app.url!==this.props.app.url&&(this._getNewState(e),this.state.hasPermissionToLoad&&this._resetWidget(e)),e.widgetPageTitle!==this.props.widgetPageTitle&&this.setState({widgetPageTitle:e.widgetPageTitle})}async _endWidgetActions(){this.iframe&&(this.iframe.src="about:blank"),R.a.JITSI.matches(this.props.app.type)&&_.a.dispatch({action:"hangup_conference"}),O.a.destroyElement(this._persistKey),this._sgWidget&&this._sgWidget.stop({forceDestroy:!0})}formatAppTileName(){let e="No name";return this.props.app.name&&this.props.app.name.trim()&&(e=this.props.app.name.trim()),e}_usingLocalWidget(){return R.a.JITSI.matches(this.props.app.type)}_getTileTitle(){const e=this.formatAppTileName(),t=u.a.createElement("span",null," - ");let s="";return this.state.widgetPageTitle&&this.state.widgetPageTitle!==this.formatAppTileName()&&(s=this.state.widgetPageTitle),u.a.createElement("span",null,u.a.createElement(N.a,{app:this.props.app}),u.a.createElement("b",null,e),u.a.createElement("span",null,s?t:"",s))}render(){let e;const t="mx_AppTileBody"+(this.props.miniMode?"_mini  ":" "),s={};this.props.pointerEvents&&(s["pointer-events"]=this.props.pointerEvents);const n=u.a.createElement("div",{className:"mx_AppLoading_spinner_fadeIn"},u.a.createElement(y.a,{message:Object(v.a)("Loading...")}));if(null===this._sgWidget)e=u.a.createElement("div",{className:t,style:s},u.a.createElement(b.a,{errorMsg:Object(v.a)("Error loading Widget")}));else if(this.state.hasPermissionToLoad)this.state.initialising?e=u.a.createElement("div",{className:t+(this.state.loading?"mx_AppLoading":""),style:s},n):this.isMixedContent()?e=u.a.createElement("div",{className:t,style:s},u.a.createElement(b.a,{errorMsg:Object(v.a)("Error - Mixed content")})):(e=u.a.createElement("div",{className:t+(this.state.loading?"mx_AppLoading":""),style:s},this.state.loading&&n,u.a.createElement("iframe",{allow:"microphone; camera; encrypted-media; autoplay; display-capture; clipboard-write;",ref:this._iframeRefChange,src:this._sgWidget.embedUrl,allowFullScreen:!0,sandbox:"allow-forms allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-presentation"})),this.props.userWidget||(e=u.a.createElement("div",{className:"mx_AppTile_persistedWrapper"},u.a.createElement(O.a,{persistKey:this._persistKey},e))));else{const n=p.a.get().isRoomEncrypted(this.props.room.roomId);e=u.a.createElement("div",{className:t,style:s},u.a.createElement(f.a,{roomId:this.props.room.roomId,creatorUserId:this.props.creatorUserId,url:this._sgWidget.embedUrl,isRoomEncrypted:n,onPermissionGranted:this._grantWidgetPermission}))}let i,a;return i=this.props.miniMode?{mx_AppTile_mini:!0}:this.props.fullWidth?{mx_AppTileFullWidth:!0}:{mx_AppTile:!0},i=w()(i),this.state.menuDisplayed&&(a=u.a.createElement(j.a,o()({},Object(k.k)(this._contextMenuButton.current.getBoundingClientRect(),null),{app:this.props.app,onFinished:this._closeContextMenu,showUnpin:!this.props.userWidget,userWidget:this.props.userWidget,onEditClick:this.props.onEditClick,onDeleteClick:this.props.onDeleteClick}))),u.a.createElement(u.a.Fragment,null,u.a.createElement("div",{className:i,id:this.props.app.id},this.props.showMenubar&&u.a.createElement("div",{className:"mx_AppTileMenuBar"},u.a.createElement("span",{className:"mx_AppTileMenuBarTitle",style:{pointerEvents:!!this.props.handleMinimisePointerEvents&&"all"}},this.props.showTitle&&this._getTileTitle()),u.a.createElement("span",{className:"mx_AppTileMenuBarWidgets"},this.props.showPopout&&u.a.createElement(g.a,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_popout",title:Object(v.a)("Popout widget"),onClick:this._onPopoutWidgetClick}),u.a.createElement(k.c,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_menu",label:Object(v.a)("Options"),isExpanded:this.state.menuDisplayed,inputRef:this._contextMenuButton,onClick:this._onContextMenuClick}))),e),a)}})||n;D.displayName="AppTile",D.propTypes={app:m.a.object.isRequired,room:m.a.object,fullWidth:m.a.bool,miniMode:m.a.bool,userId:m.a.string.isRequired,creatorUserId:m.a.string,waitForIframeLoad:m.a.bool,showMenubar:m.a.bool,onEditClick:m.a.func,onDeleteClick:m.a.func,onMinimiseClick:m.a.func,showTitle:m.a.bool,handleMinimisePointerEvents:m.a.bool,showPopout:m.a.bool,userWidget:m.a.bool,pointerEvents:m.a.string},D.defaultProps={waitForIframeLoad:!0,showMenubar:!0,showTitle:!0,showPopout:!0,handleMinimisePointerEvents:!1,userWidget:!1,miniMode:!1}},function(e,t,s){"use strict";s.r(t),s.d(t,"containsEmoji",(function(){return n}));const n=(e,t)=>t.some(t=>e.body&&e.body.includes(t))},function(e,t,s){"use strict";(function(e){s.d(t,"h",(function(){return M})),s.d(t,"b",(function(){return U})),s.d(t,"a",(function(){return L})),s.d(t,"d",(function(){return F})),s.d(t,"c",(function(){return B})),s.d(t,"k",(function(){return W})),s.d(t,"l",(function(){return G})),s.d(t,"e",(function(){return q})),s.d(t,"i",(function(){return J})),s.d(t,"m",(function(){return Q})),s.d(t,"g",(function(){return X})),s.d(t,"f",(function(){return Z})),s.d(t,"j",(function(){return te})),s.d(t,"n",(function(){return ne}));var n=s(152),i=s(215),o=s(274),a=s(94),r=s(221),c=s(231),l=s(628),d=s(132),u=s(253),h=s(429),m=s(1007),p=s(96),g=s(127),v=s(99),f=s(95),b=s(278),y=s(118),_=s(288),E=s(337),S=s(98),w=s(630),C=s(144),k=s(183),O=s(409),R=s(1318),I=s(401),x=s(255),T=s(637),j=s(120),N=s(153),P=s(1011),D=s(135),A=s(92);async function M(e={}){try{let t=e.enableGuest||!1;const s=e.guestHsUrl,i=e.guestIsUrl,o=e.fragmentQueryParams||{},a=e.defaultDeviceDisplayName;if(t&&!s&&(console.warn("Cannot enable guest access: can't determine HS URL to use"),t=!1),t&&o.guest_user_id&&o.guest_access_token)return console.log("Using guest access credentials"),H({userId:o.guest_user_id,accessToken:o.guest_access_token,homeserverUrl:s,identityServerUrl:i,guest:!0},!0).then(()=>!0);return!!await W({ignoreGuest:Boolean(e.ignoreGuest)})||!!t&&function(e,t,s){console.log("Doing guest login on "+e);return Object(n.createClient)({baseUrl:e}).registerGuest({body:{initial_device_display_name:s}}).then(s=>(console.log("Registered as guest: "+s.user_id),H({userId:s.user_id,deviceId:s.device_id,accessToken:s.access_token,homeserverUrl:e,identityServerUrl:t,guest:!0},!0).then(()=>!0)),e=>(console.error("Failed to register as guest",e),!1))}(s,i,a)}catch(e){return!(e instanceof $)&&async function(e){console.error("Unable to load session",e);const t=f.getComponent("views.dialogs.SessionRestoreErrorDialog"),s=v.a.createTrackedDialog("Session Restore Error","",t,{error:e.message}),[n]=await s.finished;if(n)return await se(),!1;return M()}(e)}}async function U(){const{hsUrl:e,userId:t,hasAccessToken:s,isGuest:n}=await B();return e&&t&&s?[t,n]:[null,null]}function L(e,t,s){if(!e.loginToken)return Promise.resolve(!1);const i=localStorage.getItem(x.a),o=localStorage.getItem(x.c);return i?Object(_.c)(i,o,"m.login.token",{token:e.loginToken,initial_device_display_name:t}).then((function(e){return console.log("Logged in with token"),se().then(async()=>(await z(e),sessionStorage.setItem("mx_fresh_login",String(!0)),!0))})).catch(e=>(v.a.createTrackedDialog("SSO","Token Rejected",D.a,{title:Object(A.a)("We couldn't log you in"),description:"ConnectionError"===e.name?Object(A.a)("Your homeserver was unreachable and was not able to log you in. Please try again. If this continues, please contact your homeserver administrator."):Object(A.a)("Your homeserver rejected your log in attempt. This could be due to things just taking too long. Please try again. If this continues, please contact your homeserver administrator."),button:Object(A.a)("Try again"),onFinished:e=>{if(e){const e=Object(n.createClient)({baseUrl:i,idBaseUrl:o}),t=localStorage.getItem(x.b)||void 0;y.a.get().startSingleSignOn(e,"sso",s,t)}}}),console.error("Failed to log in with login token:"),console.error(e),!1)):(console.warn("Cannot log in with token: can't determine HS URL to use"),v.a.createTrackedDialog("SSO","Unknown HS",D.a,{title:Object(A.a)("We couldn't log you in"),description:Object(A.a)("We asked the browser to remember which homeserver you use to let you sign in, but unfortunately your browser has forgotten it. Go to the sign in page and try again."),button:Object(A.a)("Try again")}),Promise.resolve(!1))}function F(e){if(e.reason===i.b.TOGGLED_LAZY_LOADING)return Promise.resolve().then(()=>{if(e.value){const e=f.getComponent("views.dialogs.LazyLoadingResyncDialog");return new Promise(t=>{v.a.createDialog(e,{onFinished:t})})}{const e=f.getComponent("views.dialogs.LazyLoadingDisabledDialog");return new Promise(t=>{v.a.createDialog(e,{onFinished:t,host:window.location.host})})}}).then(()=>a.a.get().store.deleteAllData()).then(()=>{y.a.get().reload()})}async function B(){const e=localStorage.getItem("mx_hs_url"),t=localStorage.getItem("mx_is_url");let s;try{s=await E.c("account","mx_access_token")}catch(e){}if(!s&&(s=localStorage.getItem("mx_access_token"),s))try{await E.d("account","mx_access_token",s),localStorage.removeItem("mx_access_token")}catch(e){}const n="true"===localStorage.getItem("mx_has_access_token")||!!s,i=localStorage.getItem("mx_user_id"),o=localStorage.getItem("mx_device_id");let a;return a=null!==localStorage.getItem("mx_is_guest")?"true"===localStorage.getItem("mx_is_guest"):"true"===localStorage.getItem("matrix-is-guest"),{hsUrl:e,isUrl:t,hasAccessToken:n,accessToken:s,userId:i,deviceId:o,isGuest:a}}async function V(e){const t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);const s=await window.crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveBits"]);return t.fill(0),new Uint8Array(await window.crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(32),info:new Uint8Array(0)},s,256))}async function K(){if(await function(){const e=f.getComponent("views.dialogs.StorageEvictedDialog");return new Promise(t=>{v.a.createTrackedDialog("Storage evicted","",e,{onFinished:t})})}())throw await se(),new $("Aborting login in progress because of storage inconsistency")}async function W(e){const t=null==e?void 0:e.ignoreGuest;if(!localStorage)return!1;const{hsUrl:s,isUrl:n,hasAccessToken:i,accessToken:a,userId:r,deviceId:c,isGuest:l}=await B();if(i&&!a&&K(),a&&r&&s){if(t&&l)return console.log("Ignoring stored guest account: "+r),!1;let e=a;const i=await y.a.get().getPickleKey(r,c);if(i){if(console.log("Got pickle key"),"string"!=typeof a){const t=await V(i);e=await Object(o.a)(a,t,"access_token"),t.fill(0)}}else console.log("No pickle key available");const d="true"===sessionStorage.getItem("mx_fresh_login");return sessionStorage.removeItem("mx_fresh_login"),console.log("Restoring session for "+r),await H({userId:r,deviceId:c,accessToken:e,homeserverUrl:s,identityServerUrl:n,guest:l,pickleKey:i,freshLogin:d},!1),!0}return console.log("No previous session found."),!1}async function G(e){e.freshLogin=!0,ne();const t=e.userId&&e.deviceId?await y.a.get().createPickleKey(e.userId,e.deviceId):null;return t?console.log("Created pickle key"):console.log("Pickle key not created"),H(Object.assign({},e,{pickleKey:t}),!0)}function q(e){const t=a.a.get().getUserId(),s=a.a.get().getDeviceId();ne(),localStorage.removeItem("mx_soft_logout"),Y=!1;const n=e.userId!==t||e.deviceId!==s;return n&&console.warn("Clearing all data: Old session belongs to a different user/session"),H(e,n)}async function H(e,t){e.guest=Boolean(e.guest);const s=X();console.log("setLoggedIn: mxid: "+e.userId+" deviceId: "+e.deviceId+" guest: "+e.guest+" hs: "+e.homeserverUrl+" softLogout: "+s," freshLogin: "+e.freshLogin),p.a.dispatch({action:"on_logging_in"},!0),t&&await se();const n=await E.a();n.dataInLocalStorage&&n.cryptoInited&&!n.dataInCryptoStore&&await K(),d.a.setLoggedIn(e.guest,e.homeserverUrl),a.a.replaceUsingCreds(e);const i=a.a.get();if(e.freshLogin&&S.b.getValue("feature_dehydration")){const t=await i.rehydrateDevice();t&&(e.deviceId=t),delete e.freshLogin}if(localStorage)try{await z(e),sessionStorage.removeItem("mx_fresh_login")}catch(e){console.warn("Error using local storage: can't persist session!",e)}else console.warn("No local storage available: can't persist session!");return p.a.dispatch({action:"on_logged_in"}),await ee(!s),i}class $ extends Error{}async function z(e){var t;if(localStorage.setItem("mx_hs_url",e.homeserverUrl),e.identityServerUrl&&localStorage.setItem("mx_is_url",e.identityServerUrl),localStorage.setItem("mx_user_id",e.userId),localStorage.setItem("mx_is_guest",JSON.stringify(e.guest)),e.accessToken?localStorage.setItem("mx_has_access_token","true"):localStorage.deleteItem("mx_has_access_token"),e.pickleKey){let t;try{const s=await V(e.pickleKey);t=await Object(o.b)(e.accessToken,s,"access_token"),s.fill(0)}catch(e){console.warn("Could not encrypt access token",e)}try{await E.d("account","mx_access_token",t||e.accessToken)}catch(t){localStorage.setItem("mx_access_token",e.accessToken)}localStorage.setItem("mx_has_pickle_key",String(!0))}else{try{await E.d("account","mx_access_token",e.accessToken)}catch(t){localStorage.setItem("mx_access_token",e.accessToken)}localStorage.getItem("mx_has_pickle_key")&&console.error("Expected a pickle key, but none provided.  Encryption may not work.")}e.deviceId&&localStorage.setItem("mx_device_id",e.deviceId),null===(t=r.a.persistCredentials)||void 0===t||t.call(r.a,e),console.log("Session persisted for "+e.userId)}let Y=!1;function J(){if(!a.a.get())return;if(j.a.instance.disabled||j.a.instance.enable(!0),a.a.get().isGuest())return void e(()=>te());Y=!0;const t=a.a.get();y.a.get().destroyPickleKey(t.getUserId(),t.getDeviceId()),t.logout().then(te,e=>{console.log("Failed to call logout API: token will not be invalidated"),te()})}function Q(){a.a.get()&&(localStorage.setItem("mx_soft_logout","true"),console.log("Soft logout initiated"),Y=!0,p.a.dispatch({action:"on_client_not_viable"}),ne(!1))}function X(){return"true"===localStorage.getItem("mx_soft_logout")}function Z(){return Y}async function ee(e=!0){console.log("Lifecycle: Starting MatrixClient"),p.a.dispatch({action:"will_start_client"},!0),w.a.sharedInstance().reset(),C.a.sharedInstance().reset(),u.default.start(),h.a.sharedInstance().start(),g.a.makeShared().start(),k.a.sharedInstance().startWatching(),b.a.start(),N.e.sharedInstance().start(),O.a.sharedInstance().start(),e?(await c.a.init(),await a.a.start()):(console.warn("Caller requested only auxiliary services be started"),await a.a.assign()),R.a.sharedInstance().start(),S.b.getValue("lowBandwidth")||m.a.start(),await I.a.getInstance().start(),p.a.dispatch({action:"client_started"}),X()&&Q()}async function te(){var e;Y=!1,p.a.dispatch({action:"on_logged_out"},!0),ne(),await se({deleteEverything:!0}),null===(e=P.a.onLoggedOutAndStorageCleared)||void 0===e||e.call(P.a)}async function se(e){if(d.a.disable(),window.localStorage){const t=T.a.instance.getWireInvites();window.localStorage.clear();try{await E.b("account","mx_access_token")}catch(e){}null!=e&&e.deleteEverything||t.forEach(e=>{const t=e.roomId;delete e.roomId,T.a.instance.storeInvite(t,e)})}window.sessionStorage&&window.sessionStorage.clear();const t=Object(l.a)({baseUrl:""});await c.a.deleteEventIndex(),await t.clearStores()}function ne(e=!0){u.default.stop(),N.e.sharedInstance().stop(),h.a.sharedInstance().stop(),w.a.sharedInstance().reset(),m.a.stop(),b.a.stop(),k.a.sharedInstance().stopWatching(),O.a.sharedInstance().stop(),R.a.sharedInstance().stop(),g.a.shared()&&g.a.shared().stop(),c.a.stop();const t=a.a.get();t&&(t.stopClient(),t.removeAllListeners(),e&&(a.a.unset(),c.a.unset()))}}).call(this,s(169).setImmediate)},function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return c})),s.d(t,"c",(function(){return l}));var n=s(18),i=s.n(n),o=s(152),a=s(221);let r;!function(e){e.Gitlab="gitlab",e.Github="github",e.Apple="apple",e.Google="google",e.Facebook="facebook",e.Twitter="twitter"}(r||(r={}));class c{constructor(e,t,s,n){i()(this,"hsUrl",void 0),i()(this,"isUrl",void 0),i()(this,"fallbackHsUrl",void 0),i()(this,"flows",void 0),i()(this,"defaultDeviceDisplayName",void 0),i()(this,"tempClient",void 0),this.hsUrl=e,this.isUrl=t,this.fallbackHsUrl=s,this.flows=[],this.defaultDeviceDisplayName=n.defaultDeviceDisplayName,this.tempClient=null}getHomeserverUrl(){return this.hsUrl}getIdentityServerUrl(){return this.isUrl}setHomeserverUrl(e){this.tempClient=null,this.hsUrl=e}setIdentityServerUrl(e){this.tempClient=null,this.isUrl=e}createTemporaryClient(){return this.tempClient?this.tempClient:this.tempClient=Object(o.createClient)({baseUrl:this.hsUrl,idBaseUrl:this.isUrl})}async getFlows(){const e=this.createTemporaryClient(),{flows:t}=await e.loginFlows();return this.flows=t,this.flows}loginViaPassword(e,t,s,n){const i=e.indexOf("@")>0;let o;o=t&&s?{type:"m.id.phone",country:t,phone:s,number:s}:i?{type:"m.id.thirdparty",medium:"email",address:e}:{type:"m.id.user",user:e};const a={password:n,identifier:o,initial_device_display_name:this.defaultDeviceDisplayName},r=e=>l(this.fallbackHsUrl,this.isUrl,"m.login.password",a).catch(t=>{throw console.log("fallback HS login failed",t),e});let c=null;return l(this.hsUrl,this.isUrl,"m.login.password",a).catch(e=>{if(c=e,403===e.httpStatus&&this.fallbackHsUrl)return r(c);throw c}).catch(e=>{throw console.log("Login failed",e),e})}}async function l(e,t,s,n){var i;const r=Object(o.createClient)({baseUrl:e,idBaseUrl:t}),c=await r.login(s,n),l=c.well_known;l&&(l["m.homeserver"]&&l["m.homeserver"].base_url&&(e=l["m.homeserver"].base_url,console.log(`Overrode homeserver setting with ${e} from login response`)),l["m.identity_server"]&&l["m.identity_server"].base_url&&(t=l["m.identity_server"].base_url,console.log(`Overrode IS setting with ${t} from login response`)));const d={homeserverUrl:e,identityServerUrl:t,userId:c.user_id,deviceId:c.device_id,accessToken:c.access_token};return null===(i=a.a.examineLoginResponse)||void 0===i||i.call(a.a,c,d),d}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return r}));var n=s(91),i=s.n(n),o=s(92);function a(e,t,s,n){let a=s[e];void 0===a&&(a=s[""]);const r=e=>t?i.a.createElement("a",{href:t,target:"_blank",rel:"noreferrer noopener"},e):e;return a.includes("<a>")?Object(o.a)(a,{},Object.assign({a:r},n)):Object(o.a)(a,{},n)}function r(e){if("M_RESOURCE_LIMIT_EXCEEDED"===e.errcode){const t=a(e.data.limit_type,e.data.admin_contact,{monthly_active_user:Object(o.b)("This homeserver has hit its Monthly Active User limit."),hs_blocked:Object(o.b)("This homeserver has been blocked by its administrator."),"":Object(o.b)("This homeserver has exceeded one of its resource limits.")}),s=a(e.data.limit_type,e.data.admin_contact,{"":Object(o.b)("Please <a>contact your service administrator</a> to continue using the service.")});return i.a.createElement("div",null,i.a.createElement("div",null,t),i.a.createElement("div",null,s))}return i.a.createElement("div",null,Object(o.a)("Unable to connect to Homeserver. Retrying..."))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(91),i=s.n(n),o=s(101),a=s.n(o),r=s(92),c=s(100),l=s(98),d=s(106),u=s(205),h=s(99),m=s(437),p=s(102),g=s(441);const v=({onClick:e})=>e?i.a.createElement(u.a,{class:a()("mx_BetaCard_betaPill",{mx_BetaCard_betaPill_clickable:!!e}),tooltip:i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Tooltip_title"},Object(r.a)("Spaces is a beta feature")),i.a.createElement("div",{className:"mx_Tooltip_sub"},Object(r.a)("Tap for more info"))),onClick:e,tooltipProps:{yOffset:-10}},Object(r.a)("Beta")):i.a.createElement("span",{className:a()("mx_BetaCard_betaPill",{mx_BetaCard_betaPill_clickable:!!e}),onClick:e},Object(r.a)("Beta"));t.b=({title:e,featureId:t})=>{const s=l.b.getBetaInfo(t);if(!s)return null;const{title:n,caption:o,disclaimer:a,image:u,feedbackLabel:f,feedbackSubheading:b,extraSettings:y}=s,_=l.b.getValue(t);let E;return _&&f&&b&&p.a.get().bug_report_endpoint_url&&(E=i.a.createElement(c.a,{onClick:()=>{h.a.createTrackedDialog("Beta Feedback",t,m.a,{featureId:t})},kind:"primary"},Object(r.a)("Feedback"))),i.a.createElement("div",{className:"mx_BetaCard"},i.a.createElement("div",{className:"mx_BetaCard_columns"},i.a.createElement("div",null,i.a.createElement("h3",{className:"mx_BetaCard_title"},e||Object(r.a)(n),i.a.createElement(v,null)),i.a.createElement("span",{className:"mx_BetaCard_caption"},Object(r.a)(o)),i.a.createElement("div",{className:"mx_BetaCard_buttons"},E,i.a.createElement(c.a,{onClick:()=>l.b.setValue(t,null,d.a.DEVICE,!_),kind:E?"primary_outline":"primary"},_?Object(r.a)("Leave the beta"):Object(r.a)("Join the beta"))),a&&i.a.createElement("div",{className:"mx_BetaCard_disclaimer"},a(_))),i.a.createElement("img",{src:u,alt:""})),y&&i.a.createElement("div",{className:"mx_BetaCard_relatedSettings"},y.map(e=>i.a.createElement(g.a,{key:e,name:e,level:d.a.DEVICE}))))}},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(101),a=s.n(o),r=s(211);t.a=function({name:e,definitions:t,value:s,className:n,outlined:o,disabled:c,onChange:l}){const d=e=>{l(e.target.value)};return i.a.createElement(i.a.Fragment,null,t.map(t=>i.a.createElement(i.a.Fragment,{key:t.value},i.a.createElement(r.a,{className:a()(n,t.className),onChange:d,checked:void 0!==t.checked?t.checked:t.value===s,name:e,value:t.value,disabled:c||t.disabled,outlined:o},t.label),t.description?i.a.createElement("span",null,t.description):null)))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d})),s.d(t,"b",(function(){return u}));var n=s(18),i=s.n(n),o=s(98),a=s(106),r=s(152),c=s(8),l=s.n(c);let d;!function(e){e.AudioOutputChanged="audio_output_changed"}(d||(d={}));class u extends l.a{static get instance(){return u.internalInstance||(u.internalInstance=new u),u.internalInstance}static async hasAnyLabeledDevices(){return(await navigator.mediaDevices.enumerateDevices()).some(e=>Boolean(e.label))}static async getDevices(){try{const e=await navigator.mediaDevices.enumerateDevices(),t=[],s=[],n=[];return e.forEach(e=>{switch(e.kind){case"audiooutput":t.push(e);break;case"audioinput":s.push(e);break;case"videoinput":n.push(e)}}),{audioOutput:t,audioInput:s,videoInput:n}}catch(e){console.warn("Unable to refresh WebRTC Devices: ",e)}}static loadDevices(){const e=o.b.getValue("webrtc_audioinput"),t=o.b.getValue("webrtc_videoinput");Object(r.setMatrixCallAudioInput)(e),Object(r.setMatrixCallVideoInput)(t)}setAudioOutput(e){o.b.setValue("webrtc_audiooutput",null,a.a.DEVICE,e),this.emit(d.AudioOutputChanged,e)}setAudioInput(e){o.b.setValue("webrtc_audioinput",null,a.a.DEVICE,e),Object(r.setMatrixCallAudioInput)(e)}setVideoInput(e){o.b.setValue("webrtc_videoinput",null,a.a.DEVICE,e),Object(r.setMatrixCallVideoInput)(e)}static getAudioOutput(){return o.b.getValueAt(a.a.DEVICE,"webrtc_audiooutput")}static getAudioInput(){return o.b.getValueAt(a.a.DEVICE,"webrtc_audioinput")}static getVideoInput(){return o.b.getValueAt(a.a.DEVICE,"webrtc_videoinput")}}i()(u,"internalInstance",void 0)},,function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(115),i=s.n(n);class o{constructor(e){this.filterJson=e}check(e){return this.checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null}}checkFields(e,t,s,n){const i={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){const s=t.slice(0,-1);return e.substr(0,s.length)===s}return e===t}(s,e)}};for(let e=0;e<Object.keys(i).length;e++){const t=Object.keys(i)[e],s=i[t],n="not_"+t,o=this.filterJson[n];if(null!=o&&o.some(s))return!1;const a=this.filterJson[t];if(a&&!a.some(s))return!1}const o=this.filterJson.contains_url;return void 0===o||o===n}filter(e){return e.filter(this.check,this)}limit(){return void 0!==this.filterJson.limit?this.filterJson.limit:10}}function a(e,t,s){const n=t.split(".");let i=e;for(let e=0;e<n.length-1;e++)i[n[e]]||(i[n[e]]={}),i=i[n[e]];i[n[n.length-1]]=s}class r{static fromJson(e,t,s){const n=new r(e,t);return n.setDefinition(s),n}constructor(e,t){this.userId=e,this.filterId=t,i()(this,"definition",{}),i()(this,"roomFilter",void 0),i()(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;const t=e.room,s={};t&&(t.rooms&&(s.rooms=t.rooms),t.rooms&&(s.not_rooms=t.not_rooms)),this.roomFilter=new o(s),this.roomTimelineFilter=new o((null==t?void 0:t.timeline)||{})}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomTimelineFilter.filter(this.roomFilter.filter(e))}setTimelineLimit(e){a(this.definition,"room.timeline.limit",e)}setLazyLoadMembers(e){a(this.definition,"room.state.lazy_load_members",!!e)}setIncludeLeaveRooms(e){a(this.definition,"room.include_leave",e)}}i()(r,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0})},function(e,t,s){"use strict";s.d(t,"a",(function(){return Q})),s.d(t,"b",(function(){return ue}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(110),c=s(241),l=s(105),d=s(129),u=s(92),h=s(100),m=s(191),p=s(329),g=s(172),v=s(157),f=s(412),b=s(137),y=s(112),_=s(131),E=s(163),S=s(198),w=s(96),C=s(103),k=s(330),O=s(413),R=s(331),I=s(249),x=s(126);const T=(e,t)=>{const[s,n]=Object(o.useState)(()=>Array.isArray(t)?t:new Array(e).fill(t));return[s,(e,t)=>n(s=>{const n=[...s];return n[e]=t,n})]};var j,N=s(445),P=s(280),D=s(668),A=s(171),M=s(338),U=s(145),L=s(669),F=s(446),B=s(109),V=s(176),K=s(113),W=s(290),G=s(208),q=s(98),H=s(99),$=s(437),z=s(102),Y=s(188),J=s(339);!function(e){e[e.Landing=0]="Landing",e[e.PublicCreateRooms=1]="PublicCreateRooms",e[e.PublicShare=2]="PublicShare",e[e.PrivateScope=3]="PrivateScope",e[e.PrivateInvite=4]="PrivateInvite",e[e.PrivateCreateRooms=5]="PrivateCreateRooms",e[e.PrivateExistingRooms=6]="PrivateExistingRooms"}(j||(j={}));const Q=({onClick:e})=>z.a.get().bug_report_endpoint_url?a.a.createElement("div",{className:"mx_SpaceFeedbackPrompt"},a.a.createElement("hr",null),a.a.createElement("div",null,a.a.createElement("span",{className:"mx_SpaceFeedbackPrompt_text"},Object(u.a)("Spaces are a beta feature.")),a.a.createElement(h.a,{kind:"link",onClick:()=>{e&&e(),H.a.createTrackedDialog("Beta Feedback","feature_spaces",$.a,{featureId:"feature_spaces"})}},Object(u.a)("Feedback")))):null,X=({room:e,children:t})=>{const s=Object(f.b)(e).length;return t?t(s):s},Z=e=>{const[t,s]=Object(o.useState)(e.getMyMembership());return Object(_.a)(e,"Room.myMembership",()=>{s(e.getMyMembership())}),t},ee=({space:e})=>{const t=e.getJoinRule();let s;return s="public"===t?a.a.createElement("span",{className:"mx_SpaceRoomView_info_public"},Object(u.a)("Public space")):a.a.createElement("span",{className:"mx_SpaceRoomView_info_private"},Object(u.a)("Private space")),a.a.createElement("div",{className:"mx_SpaceRoomView_info"},s,"public"===t&&a.a.createElement(X,{room:e},t=>t>0?a.a.createElement(h.a,{kind:"link",onClick:()=>{w.a.dispatch({action:C.a.SetRightPanelPhase,phase:x.c.RoomMemberList,refireParams:{space:e}})}},Object(u.a)("%(count)s members",{count:t})):null))},te=()=>{w.a.dispatch({action:C.a.ViewUserSettings,initialTabId:G.a.Labs})},se=({space:e,onJoinButtonClicked:t,onRejectButtonClicked:s})=>{const n=Object(o.useContext)(l.a),i=Z(e),[r,c]=Object(o.useState)(!1),v=q.b.getValue("feature_spaces"),f=Object(Y.b)(i)===Y.a.Leave&&e.getJoinRule()!==J.c.Public;let b,y,_;if("join"===i)y=a.a.createElement(h.a,{kind:"danger_outline",onClick:()=>{w.a.dispatch({action:"leave_room",room_id:e.roomId})}},Object(u.a)("Leave"));else if("invite"===i){var E,S;const i=null===(E=e.getMember(n.getUserId()))||void 0===E||null===(S=E.events.member)||void 0===S?void 0:S.getSender(),o=i&&e.getMember(i);i&&(b=a.a.createElement("div",{className:"mx_SpaceRoomView_preview_inviter"},a.a.createElement(A.a,{member:o,width:32,height:32}),a.a.createElement("div",null,a.a.createElement("div",{className:"mx_SpaceRoomView_preview_inviter_name"},Object(u.a)("<inviter/> invites you",{},{inviter:()=>a.a.createElement("b",null,o.name||i)})),o?a.a.createElement("div",{className:"mx_SpaceRoomView_preview_inviter_mxid"},i):null))),y=a.a.createElement(a.a.Fragment,null,a.a.createElement(h.a,{kind:"secondary",onClick:()=>{c(!0),s()}},Object(u.a)("Reject")),a.a.createElement(h.a,{kind:"primary",onClick:()=>{c(!0),t()},disabled:!v},Object(u.a)("Accept")))}else y=a.a.createElement(h.a,{kind:"primary",onClick:()=>{c(!0),t()},disabled:!v||f},Object(u.a)("Join"));return r&&(y=a.a.createElement(g.a,null)),v?f&&(_=a.a.createElement("div",{className:"mx_SpaceRoomView_preview_spaceBetaPrompt"},Object(u.a)("To view %(spaceName)s, you need an invite",{spaceName:e.name}))):_=a.a.createElement("div",{className:"mx_SpaceRoomView_preview_spaceBetaPrompt"},"join"===i?Object(u.a)("To view %(spaceName)s, turn on the <a>Spaces beta</a>",{spaceName:e.name},{a:e=>a.a.createElement(h.a,{onClick:te,kind:"link"},e)}):Object(u.a)("To join %(spaceName)s, turn on the <a>Spaces beta</a>",{spaceName:e.name},{a:e=>a.a.createElement(h.a,{onClick:te,kind:"link"},e)})),a.a.createElement("div",{className:"mx_SpaceRoomView_preview"},a.a.createElement(W.a,{onClick:te}),b,a.a.createElement(d.a,{room:e,height:80,width:80,viewAvatarOnClick:!0}),a.a.createElement("h1",{className:"mx_SpaceRoomView_preview_name"},a.a.createElement(m.a,{room:e})),a.a.createElement(ee,{space:e}),a.a.createElement(p.a,{room:e},(e,t)=>a.a.createElement("div",{className:"mx_SpaceRoomView_preview_topic",ref:t},e)),"public"===e.getJoinRule()&&a.a.createElement(L.a,{room:e}),a.a.createElement("div",{className:"mx_SpaceRoomView_preview_joinButtons"},y),_)},ne=({space:e,onNewRoomAdded:t})=>{const s=Object(o.useContext)(l.a),[n,i,r,c]=Object(B.q)();let d;if(n){const n=i.current.getBoundingClientRect();d=a.a.createElement(V.e,{left:n.left+window.pageXOffset+0,top:n.bottom+window.pageYOffset+8,chevronFace:B.a.None,onFinished:c,className:"mx_RoomTile_contextMenu",compact:!0},a.a.createElement(V.c,{first:!0},a.a.createElement(V.b,{label:Object(u.a)("Create new room"),iconClassName:"mx_RoomList_iconPlus",onClick:async n=>{n.preventDefault(),n.stopPropagation(),c(),await Object(P.d)(s,e)&&t()}}),a.a.createElement(V.b,{label:Object(u.a)("Add existing room"),iconClassName:"mx_RoomList_iconHash",onClick:async n=>{n.preventDefault(),n.stopPropagation(),c();const[i]=await Object(P.c)(s,e);i&&t()}})))}return a.a.createElement(a.a.Fragment,null,a.a.createElement(B.c,{kind:"primary",inputRef:i,onClick:r,isExpanded:n,label:Object(u.a)("Add")},Object(u.a)("Add")),d)},ie=({space:e})=>{const t=Object(o.useContext)(l.a),s=Z(e),n=t.getUserId();let i;"join"===s&&e.canInvite(n)&&(i=a.a.createElement(h.a,{kind:"primary",className:"mx_SpaceRoomView_landing_inviteButton",onClick:()=>{Object(v.g)(e.roomId)}},Object(u.a)("Invite")));const c="join"===s&&e.currentState.maySendStateEvent(r.a.SpaceChild,n),[g,f]=Object(M.a)(!1);let b,y;c&&(b=a.a.createElement(ne,{space:e,onNewRoomAdded:f})),Object(P.b)(t,e)&&(y=a.a.createElement(K.a,{className:"mx_SpaceRoomView_landing_settingsButton",onClick:()=>{Object(P.f)(t,e)},title:Object(u.a)("Settings")}));return a.a.createElement("div",{className:"mx_SpaceRoomView_landing"},a.a.createElement(d.a,{room:e,height:80,width:80,viewAvatarOnClick:!0}),a.a.createElement("div",{className:"mx_SpaceRoomView_landing_name"},a.a.createElement(m.a,{room:e},e=>{const t={name:()=>a.a.createElement("div",{className:"mx_SpaceRoomView_landing_nameRow"},a.a.createElement("h1",null,e))};return Object(u.a)("Welcome to <name/>",{},t)})),a.a.createElement("div",{className:"mx_SpaceRoomView_landing_info"},a.a.createElement(ee,{space:e}),a.a.createElement(L.a,{room:e,onlyKnownUsers:!1,numShown:7,onClick:()=>{w.a.dispatch({action:C.a.SetRightPanelPhase,phase:x.c.RoomMemberList,refireParams:{space:e}})}}),i,y),a.a.createElement(p.a,{room:e},(e,t)=>a.a.createElement("div",{className:"mx_SpaceRoomView_landing_topic",ref:t},e)),a.a.createElement(Q,null),a.a.createElement("hr",null),a.a.createElement(D.a,{space:e,showRoom:D.c,refreshToken:g,additionalButtons:b}))},oe=({space:e,title:t,description:s,onFinished:n})=>{const[i,r]=Object(o.useState)(!1),[l,d]=Object(o.useState)(""),m=[Object(u.a)("General"),Object(u.a)("Random"),Object(u.a)("Support")],[p,g]=T(3,[Object(u.a)("General"),Object(u.a)("Random"),""]),v=new Array(3).fill(0).map((e,t)=>{const s="roomName"+t;return a.a.createElement(y.a,{key:s,name:s,type:"text",label:Object(u.a)("Room name"),placeholder:m[t],value:p[t],onChange:e=>g(t,e.target.value),autoFocus:2===t,disabled:i})}),f=async t=>{if(t.preventDefault(),!i){d(""),r(!0);try{const t=p.map(e=>e.trim()).filter(Boolean);await Promise.all(t.map(t=>Object(b.b)({createOpts:{preset:"public"===e.getJoinRule()?c.a.PublicChat:c.a.PrivateChat,name:t},spinner:!1,encryption:!1,andView:!1,inlineErrors:!0,parentSpace:e}))),n(t.length>0)}catch(e){console.error("Failed to create initial space rooms",e),d(Object(u.a)("Failed to create initial space rooms"))}r(!1)}};let _=e=>{e.preventDefault(),n(!1)},E=Object(u.a)("Skip for now");return p.some(e=>e.trim())&&(_=f,E=i?Object(u.a)("Creating rooms..."):Object(u.a)("Continue")),a.a.createElement("div",null,a.a.createElement("h1",null,t),a.a.createElement("div",{className:"mx_SpaceRoomView_description"},s),l&&a.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},l),a.a.createElement("form",{onSubmit:_,id:"mx_SpaceSetupFirstRooms"},v),a.a.createElement("div",{className:"mx_SpaceRoomView_buttons"},a.a.createElement(h.a,{kind:"primary",disabled:i,onClick:_,element:"input",type:"submit",form:"mx_SpaceSetupFirstRooms",value:E})),a.a.createElement(Q,null))},ae=({space:e,onFinished:t})=>a.a.createElement("div",null,a.a.createElement("h1",null,Object(u.a)("What do you want to organise?")),a.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(u.a)("Pick rooms or conversations to add. This is just a space for you, no one will be informed. You can add more later.")),a.a.createElement(F.a,{space:e,emptySelectionButton:a.a.createElement(h.a,{kind:"primary",onClick:t},Object(u.a)("Skip for now")),onFinished:t}),a.a.createElement("div",{className:"mx_SpaceRoomView_buttons"}),a.a.createElement(Q,null)),re=({justCreatedOpts:e,space:t,onFinished:s,createdRooms:n})=>{var i;return a.a.createElement("div",{className:"mx_SpaceRoomView_publicShare"},a.a.createElement("h1",null,Object(u.a)("Share %(name)s",{name:(null==e||null===(i=e.createOpts)||void 0===i?void 0:i.name)||t.name})),a.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(u.a)("It's just you at the moment, it will be even better with others.")),a.a.createElement(N.a,{space:t}),a.a.createElement("div",{className:"mx_SpaceRoomView_buttons"},a.a.createElement(h.a,{kind:"primary",onClick:s},n?Object(u.a)("Go to my first room"):Object(u.a)("Go to my space"))),a.a.createElement(Q,null))},ce=({space:e,justCreatedOpts:t,onFinished:s})=>{var n;return a.a.createElement("div",{className:"mx_SpaceRoomView_privateScope"},a.a.createElement("h1",null,Object(u.a)("Who are you working with?")),a.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(u.a)("Make sure the right people have access to %(name)s",{name:(null==t||null===(n=t.createOpts)||void 0===n?void 0:n.name)||e.name})),a.a.createElement(h.a,{className:"mx_SpaceRoomView_privateScope_justMeButton",onClick:()=>{s(!1)}},a.a.createElement("h3",null,Object(u.a)("Just me")),a.a.createElement("div",null,Object(u.a)("A private space to organise your rooms"))),a.a.createElement(h.a,{className:"mx_SpaceRoomView_privateScope_meAndMyTeammatesButton",onClick:()=>{s(!0)}},a.a.createElement("h3",null,Object(u.a)("Me and my teammates")),a.a.createElement("div",null,Object(u.a)("A private space for you and your teammates"))),a.a.createElement("div",{className:"mx_SpaceRoomView_betaWarning"},a.a.createElement("h3",null,Object(u.a)("Teammates might not be able to view or join any private rooms you make.")),a.a.createElement("p",null,Object(u.a)("We're working on this as part of the beta, but just want to let you know."))),a.a.createElement(Q,null))},le=Object(E.a)({rules:[{key:"email",test:({value:e})=>!e||S.a(e),invalid:()=>Object(u.a)("Doesn't look like a valid email address")}]}),de=({space:e,onFinished:t})=>{const[s,n]=Object(o.useState)(!1),[i,r]=Object(o.useState)(""),c=[Object(o.useRef)(),Object(o.useRef)(),Object(o.useRef)()],[l,d]=T(3,""),m=new Array(3).fill(0).map((e,t)=>{const n="emailAddress"+t;return a.a.createElement(y.a,{key:n,name:n,type:"text",label:Object(u.a)("Email address"),placeholder:Object(u.a)("Email"),value:l[t],onChange:e=>d(t,e.target.value),ref:c[t],onValidate:le,autoFocus:0===t,disabled:s})}),p=async i=>{if(i.preventDefault(),s)return;r("");for(let e=0;e<c.length;e++){const t=c[e];if(!1===await t.current.validate({allowEmpty:!0}))return t.current.focus(),void t.current.validate({allowEmpty:!0,focused:!0})}n(!0);const o=l.map(e=>e.trim()).filter(Boolean);try{const s=await Object(v.a)(e.roomId,o),n=Object.keys(s.states).filter(e=>"error"===s.states[e]);n.length>0?(console.log("Failed to invite users to space: ",s),r(Object(u.a)("Failed to invite the following users to your space: %(csvUsers)s",{csvUsers:n.join(", ")}))):t()}catch(e){console.error("Failed to invite users to space: ",e),r(Object(u.a)("We couldn't invite those users. Please check the users you want to invite and try again."))}n(!1)};let g=e=>{e.preventDefault(),t()},f=Object(u.a)("Skip for now");return l.some(e=>e.trim())&&(g=p,f=s?Object(u.a)("Inviting..."):Object(u.a)("Continue")),a.a.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates"},a.a.createElement("h1",null,Object(u.a)("Invite your teammates")),a.a.createElement("div",{className:"mx_SpaceRoomView_description"},Object(u.a)("Make sure the right people have access. You can invite more later.")),a.a.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates_betaDisclaimer"},a.a.createElement(W.a,{onClick:te}),Object(u.a)("<b>This is an experimental feature.</b> For now, new users receiving an invite will have to open the invite on <link/> to actually join.",{},{b:e=>a.a.createElement("b",null,e),link:()=>a.a.createElement("a",{href:"https://app.element.io/",rel:"noreferrer noopener",target:"_blank"},"app.element.io")})),i&&a.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},i),a.a.createElement("form",{onSubmit:g,id:"mx_SpaceSetupPrivateInvite"},m),a.a.createElement("div",{className:"mx_SpaceRoomView_inviteTeammates_buttons"},a.a.createElement(h.a,{className:"mx_SpaceRoomView_inviteTeammates_inviteDialogButton",onClick:()=>Object(v.g)(e.roomId)},Object(u.a)("Invite by username"))),a.a.createElement("div",{className:"mx_SpaceRoomView_buttons"},a.a.createElement(h.a,{kind:"primary",disabled:s,onClick:g,element:"input",type:"submit",form:"mx_SpaceSetupPrivateInvite",value:f})),a.a.createElement(Q,null))};class ue extends a.a.PureComponent{constructor(e,t){var s;super(e,t),i()(this,"creator",void 0),i()(this,"dispatcherRef",void 0),i()(this,"rightPanelStoreToken",void 0),i()(this,"onMyMembership",(e,t)=>{e.roomId===this.props.space.roomId&&this.setState({myMembership:t})}),i()(this,"onRightPanelStoreUpdate",()=>{this.setState({showRightPanel:I.a.getSharedInstance().isOpenForRoom})}),i()(this,"onAction",e=>{e.action!==C.a.ViewUser&&"view_3pid_invite"!==e.action||(e.action===C.a.ViewUser&&e.member?w.a.dispatch({action:C.a.SetRightPanelPhase,phase:x.c.SpaceMemberInfo,refireParams:{space:this.props.space,member:e.member}}):"view_3pid_invite"===e.action&&e.event?w.a.dispatch({action:C.a.SetRightPanelPhase,phase:x.c.Space3pidMemberInfo,refireParams:{space:this.props.space,event:e.event}}):w.a.dispatch({action:C.a.SetRightPanelPhase,phase:x.c.SpaceMemberList,refireParams:{space:this.props.space}}))}),i()(this,"goToFirstRoom",async()=>{const e=U.f.instance.getChildRooms(this.props.space.roomId);if(e.length){const t=e[0];return void w.a.dispatch({action:"view_room",room_id:t.roomId})}let t=U.f.instance.suggestedRooms;if(U.f.instance.activeSpace!==this.props.space&&(t=await U.f.instance.fetchSuggestedRooms(this.props.space,1)),t.length){var s,n;const e=t[0];w.a.dispatch({action:"view_room",room_id:e.room_id,room_alias:e.canonical_alias||(null===(s=e.aliases)||void 0===s?void 0:s[0]),via_servers:e.viaServers,oobData:{avatarUrl:e.avatar_url,name:e.name||e.canonical_alias||(null===(n=e.aliases)||void 0===n?void 0:n[0])||Object(u.a)("Empty room")}})}else this.setState({phase:j.Landing})});let n=j.Landing;this.creator=null===(s=this.props.space.currentState.getStateEvents(r.a.RoomCreate,""))||void 0===s?void 0:s.getSender();this.props.justCreatedOpts&&this.context.getUserId()===this.creator&&(n=this.props.justCreatedOpts.createOpts.preset===c.a.PublicChat?j.PublicCreateRooms:j.PrivateScope),this.state={phase:n,showRightPanel:I.a.getSharedInstance().isOpenForRoom,myMembership:this.props.space.getMyMembership()},this.dispatcherRef=w.a.register(this.onAction),this.rightPanelStoreToken=I.a.getSharedInstance().addListener(this.onRightPanelStoreUpdate),this.context.on("Room.myMembership",this.onMyMembership)}componentWillUnmount(){w.a.unregister(this.dispatcherRef),this.rightPanelStoreToken.remove(),this.context.off("Room.myMembership",this.onMyMembership)}renderBody(){var e,t;switch(this.state.phase){case j.Landing:return"join"===this.state.myMembership&&q.b.getValue("feature_spaces")?a.a.createElement(ie,{space:this.props.space}):a.a.createElement(se,{space:this.props.space,onJoinButtonClicked:this.props.onJoinButtonClicked,onRejectButtonClicked:this.props.onRejectButtonClicked});case j.PublicCreateRooms:return a.a.createElement(oe,{space:this.props.space,title:Object(u.a)("What are some things you want to discuss in %(spaceName)s?",{spaceName:(null===(e=this.props.justCreatedOpts)||void 0===e||null===(t=e.createOpts)||void 0===t?void 0:t.name)||this.props.space.name}),description:Object(u.a)("Let's create a room for each of them.")+"\n"+Object(u.a)("You can add more later too, including already existing ones."),onFinished:e=>this.setState({phase:j.PublicShare,createdRooms:e})});case j.PublicShare:return a.a.createElement(re,{justCreatedOpts:this.props.justCreatedOpts,space:this.props.space,onFinished:this.goToFirstRoom,createdRooms:this.state.createdRooms});case j.PrivateScope:return a.a.createElement(ce,{space:this.props.space,justCreatedOpts:this.props.justCreatedOpts,onFinished:e=>{this.setState({phase:e?j.PrivateInvite:j.PrivateExistingRooms})}});case j.PrivateInvite:return a.a.createElement(de,{space:this.props.space,onFinished:()=>this.setState({phase:j.PrivateCreateRooms})});case j.PrivateCreateRooms:return a.a.createElement(oe,{space:this.props.space,title:Object(u.a)("What projects are you working on?"),description:Object(u.a)("We'll create rooms for each of them. You can add more later too, including already existing ones."),onFinished:e=>this.setState({phase:j.Landing,createdRooms:e})});case j.PrivateExistingRooms:return a.a.createElement(ae,{space:this.props.space,onFinished:()=>this.setState({phase:j.Landing})})}}render(){const e=this.state.showRightPanel&&this.state.phase===j.Landing?a.a.createElement(R.a,{room:this.props.space,resizeNotifier:this.props.resizeNotifier}):null;return a.a.createElement("main",{className:"mx_SpaceRoomView"},a.a.createElement(O.a,null,a.a.createElement(k.a,{panel:e,resizeNotifier:this.props.resizeNotifier},this.renderBody())))}}i()(ue,"contextType",l.a)},,,function(e,t,s){"use strict";function n(e){return e/10+"rem"}function i(e){return e+"px"}s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return i}))},,function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return a})),s.d(t,"c",(function(){return r})),s.d(t,"d",(function(){return c})),s.d(t,"e",(function(){return m})),s.d(t,"f",(function(){return p})),s.d(t,"h",(function(){return g})),s.d(t,"g",(function(){return v}));var n=s(94),i=s(263);const o="all_messages_loud",a="all_messages",r="mentions_only",c="mute",l=[a,o],d=[...l,r];function u(e){return l.includes(e)}function h(e){return d.includes(e)}function m(e){return e.reduce((e,t)=>{const s=p(t.roomId),n=t.getUnreadNotificationCount("highlight")>0,i=v(t),o=i>0&&u(s),a=n&&h(s);return(o||a)&&(e.count+=i,n&&(e.highlight=!0)),e},{count:0,highlight:!1})}function p(e){if(n.a.get().isGuest())return a;if(f(e))return c;let t=null;try{t=n.a.get().getRoomPushRule("global",e)}catch(e){return null}if(!t||!t.enabled)return a;if(y(t))return r;return i.a.actionListToActionsObject(t.actions).tweaks.sound?o:null}function g(e,t){return t===c?function(e){const t=n.a.get(),s=[],i=t.getRoomPushRule("global",e);i&&s.push(t.deletePushRule("global","room",i.rule_id));return s.push(t.addPushRule("global","override",e,{conditions:[{kind:"event_match",key:"room_id",pattern:e}],actions:["dont_notify"]})),Promise.all(s)}(e):function(e,t){const s=n.a.get(),i=[],o=f(e);o&&i.push(s.deletePushRule("global","override",o.rule_id));if("all_messages"===t){const t=s.getRoomPushRule("global",e);t&&i.push(s.deletePushRule("global","room",t.rule_id))}else"mentions_only"===t?(i.push(s.addPushRule("global","room",e,{actions:["dont_notify"]})),i.push(s.setPushRuleEnabled("global","room",e,!0))):(i.push(s.addPushRule("global","room",e,{actions:["notify",{set_tweak:"sound",value:"default"}]})),i.push(s.setPushRuleEnabled("global","room",e,!0)));return Promise.all(i)}(e,t)}function v(e,t=null){let s=e.getUnreadNotificationCount(t);const i=e.currentState.getStateEvents("m.room.create","");if(i&&i.getContent().predecessor){const e=i.getContent().predecessor.room_id,t=n.a.get().getRoom(e);t&&(s+=t.getUnreadNotificationCount("highlight"))}return s}function f(e){const t=n.a.get();if(!t.pushRules||!t.pushRules.global||!t.pushRules.global.override)return null;for(const s of t.pushRules.global.override)if(b(e,s)&&y(s)&&s.enabled)return s;return null}function b(e,t){if(1!==t.conditions.length)return!1;const s=t.conditions[0];return"event_match"===s.kind&&"room_id"===s.key&&s.pattern===e}function y(e){return 1===e.actions.length&&"dont_notify"===e.actions[0]}},,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return y})),s.d(t,"b",(function(){return _}));var n=s(91),i=s.n(n),o=s(94),a=s(92),r=s(387),c=s(157),l=s(98),d=s(349),u=s(190),h=s(126),m=s(103),p=s(96);const g=()=>{p.a.dispatch({action:m.a.SetRightPanelPhase,phase:h.c.PinnedMessages,allowClose:!1})};function v(e){const t=e.getSender(),{entity:s}=e.getPrevContent(),{entity:n,recommendation:i,reason:o}=e.getContent();return n?i&&o?n===s?d.g.includes(e.getType())?()=>Object(a.a)("%(senderName)s updated the rule banning users matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):d.c.includes(e.getType())?()=>Object(a.a)("%(senderName)s updated the rule banning rooms matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):d.f.includes(e.getType())?()=>Object(a.a)("%(senderName)s updated the rule banning servers matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):()=>Object(a.a)("%(senderName)s updated a ban rule matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):s?d.g.includes(e.getType())?()=>Object(a.a)("%(senderName)s changed a rule that was banning users matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:o}):d.c.includes(e.getType())?()=>Object(a.a)("%(senderName)s changed a rule that was banning rooms matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:o}):d.f.includes(e.getType())?()=>Object(a.a)("%(senderName)s changed a rule that was banning servers matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:o}):()=>Object(a.a)("%(senderName)s updated a ban rule that was matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:o}):d.g.includes(e.getType())?()=>Object(a.a)("%(senderName)s created a rule banning users matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):d.c.includes(e.getType())?()=>Object(a.a)("%(senderName)s created a rule banning rooms matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):d.f.includes(e.getType())?()=>Object(a.a)("%(senderName)s created a rule banning servers matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):()=>Object(a.a)("%(senderName)s created a ban rule matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):()=>Object(a.a)("%(senderName)s updated an invalid ban rule",{senderName:t}):d.g.includes(e.getType())?()=>Object(a.a)("%(senderName)s removed the rule banning users matching %(glob)s",{senderName:t,glob:s}):d.c.includes(e.getType())?()=>Object(a.a)("%(senderName)s removed the rule banning rooms matching %(glob)s",{senderName:t,glob:s}):d.f.includes(e.getType())?()=>Object(a.a)("%(senderName)s removed the rule banning servers matching %(glob)s",{senderName:t,glob:s}):()=>Object(a.a)("%(senderName)s removed a ban rule matching %(glob)s",{senderName:t,glob:s})}const f={"m.room.message":function(e){return()=>{const t=e.sender&&e.sender.name?e.sender.name:e.getSender();let s=t+": "+e.getContent().body;return"m.emote"===e.getContent().msgtype?s="* "+t+" "+s:"m.image"===e.getContent().msgtype&&(s=Object(a.a)("%(senderDisplayName)s sent an image.",{senderDisplayName:t})),s}},"m.call.invite":function(e){const t=()=>e.sender?e.sender.name:Object(a.a)("Someone");let s=!0;e.getContent().offer&&e.getContent().offer.sdp&&-1!==e.getContent().offer.sdp.indexOf("m=video")&&(s=!1);const n=o.a.get().supportsVoip();return s&&n?()=>Object(a.a)("%(senderName)s placed a voice call.",{senderName:t()}):s&&!n?()=>Object(a.a)("%(senderName)s placed a voice call. (not supported by this browser)",{senderName:t()}):!s&&n?()=>Object(a.a)("%(senderName)s placed a video call.",{senderName:t()}):s||n?void 0:()=>Object(a.a)("%(senderName)s placed a video call. (not supported by this browser)",{senderName:t()})},"m.call.answer":function(e){return()=>{const t=e.sender?e.sender.name:Object(a.a)("Someone"),s=o.a.get().supportsVoip()?"":Object(a.a)("(not supported by this browser)");return Object(a.a)("%(senderName)s answered the call.",{senderName:t})+" "+s}},"m.call.hangup":function(e){const t=e.getContent();let s=()=>"";return o.a.get().supportsVoip()?t.reason&&(s="ice_failed"===t.reason?()=>Object(a.a)("(could not connect media)"):"ice_timeout"===t.reason?()=>Object(a.a)("(connection failed)"):"user_media_failed"===t.reason?()=>Object(a.a)("(their device couldn't start the camera / microphone)"):"unknown_error"===t.reason?()=>Object(a.a)("(an error occurred)"):"invite_timeout"===t.reason?()=>Object(a.a)("(no answer)"):"user hangup"===t.reason||"user_hangup"===t.reason?()=>"":()=>Object(a.a)("(unknown failure: %(reason)s)",{reason:t.reason})):s=()=>Object(a.a)("(not supported by this browser)"),()=>Object(a.a)("%(senderName)s ended the call.",{senderName:e.sender?e.sender.name:Object(a.a)("Someone")})+" "+s()},"m.call.reject":function(e){return()=>{const t=e.sender?e.sender.name:Object(a.a)("Someone");return Object(a.a)("%(senderName)s declined the call.",{senderName:t})}}},b={"m.room.canonical_alias":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender(),s=e.getPrevContent().alias,n=e.getPrevContent().alt_aliases||[],i=e.getContent().alias,o=e.getContent().alt_aliases||[],r=n.filter(e=>!o.includes(e)),c=o.filter(e=>!n.includes(e));if(r.length||c.length){if(i!==s)return()=>Object(a.a)("%(senderName)s changed the main and alternative addresses for this room.",{senderName:t});if(c.length&&!r.length)return()=>Object(a.a)("%(senderName)s added the alternative addresses %(addresses)s for this room.",{senderName:t,addresses:c.join(", "),count:c.length});if(r.length&&!c.length)return()=>Object(a.a)("%(senderName)s removed the alternative addresses %(addresses)s for this room.",{senderName:t,addresses:r.join(", "),count:r.length});if(r.length&&c.length)return()=>Object(a.a)("%(senderName)s changed the alternative addresses for this room.",{senderName:t})}else{if(i)return()=>Object(a.a)("%(senderName)s set the main address for this room to %(address)s.",{senderName:t,address:e.getContent().alias});if(s)return()=>Object(a.a)("%(senderName)s removed the main address for this room.",{senderName:t})}return()=>Object(a.a)("%(senderName)s changed the addresses for this room.",{senderName:t})},"m.room.name":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return e.getContent().name&&0!==e.getContent().name.trim().length?e.getPrevContent().name?()=>Object(a.a)("%(senderDisplayName)s changed the room name from %(oldRoomName)s to %(newRoomName)s.",{senderDisplayName:t,oldRoomName:e.getPrevContent().name,newRoomName:e.getContent().name}):()=>Object(a.a)("%(senderDisplayName)s changed the room name to %(roomName)s.",{senderDisplayName:t,roomName:e.getContent().name}):()=>Object(a.a)("%(senderDisplayName)s removed the room name.",{senderDisplayName:t})},"m.room.topic":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return()=>Object(a.a)('%(senderDisplayName)s changed the topic to "%(topic)s".',{senderDisplayName:t,topic:e.getContent().topic})},"m.room.member":function(e){const t=e.sender?e.sender.name:e.getSender(),s=e.target?e.target.name:e.getStateKey(),n=e.getPrevContent(),i=e.getContent(),o=i.reason;switch(i.membership){case"invite":{const e=i.third_party_invite;return e?e.display_name?()=>Object(a.a)("%(targetName)s accepted the invitation for %(displayName)s",{targetName:s,displayName:e.display_name}):()=>Object(a.a)("%(targetName)s accepted an invitation",{targetName:s}):()=>Object(a.a)("%(senderName)s invited %(targetName)s",{senderName:t,targetName:s})}case"ban":return()=>o?Object(a.a)("%(senderName)s banned %(targetName)s: %(reason)s",{senderName:t,targetName:s,reason:o}):Object(a.a)("%(senderName)s banned %(targetName)s",{senderName:t,targetName:s});case"join":return n&&"join"===n.membership?n.displayname&&i.displayname&&n.displayname!==i.displayname?()=>Object(a.a)("%(oldDisplayName)s changed their display name to %(displayName)s",{oldDisplayName:n.displayname,displayName:i.displayname}):!n.displayname&&i.displayname?()=>Object(a.a)("%(senderName)s set their display name to %(displayName)s",{senderName:e.getSender(),displayName:i.displayname}):n.displayname&&!i.displayname?()=>Object(a.a)("%(senderName)s removed their display name (%(oldDisplayName)s)",{senderName:t,oldDisplayName:n.displayname}):n.avatar_url&&!i.avatar_url?()=>Object(a.a)("%(senderName)s removed their profile picture",{senderName:t}):n.avatar_url&&i.avatar_url&&n.avatar_url!==i.avatar_url?()=>Object(a.a)("%(senderName)s changed their profile picture",{senderName:t}):!n.avatar_url&&i.avatar_url?()=>Object(a.a)("%(senderName)s set a profile picture",{senderName:t}):l.b.getValue("showHiddenEventsInTimeline")?()=>Object(a.a)("%(senderName)s made no change",{senderName:t}):null:(e.target||console.warn("Join message has no target! -- "+e.getContent().state_key),()=>Object(a.a)("%(targetName)s joined the room",{targetName:s}));case"leave":return e.getSender()===e.getStateKey()?"invite"===n.membership?()=>Object(a.a)("%(targetName)s rejected the invitation",{targetName:s}):()=>o?Object(a.a)("%(targetName)s left the room: %(reason)s",{targetName:s,reason:o}):Object(a.a)("%(targetName)s left the room",{targetName:s}):"ban"===n.membership?()=>Object(a.a)("%(senderName)s unbanned %(targetName)s",{senderName:t,targetName:s}):"invite"===n.membership?()=>o?Object(a.a)("%(senderName)s withdrew %(targetName)s's invitation: %(reason)s",{senderName:t,targetName:s,reason:o}):Object(a.a)("%(senderName)s withdrew %(targetName)s's invitation",{senderName:t,targetName:s}):"join"===n.membership?()=>o?Object(a.a)("%(senderName)s kicked %(targetName)s: %(reason)s",{senderName:t,targetName:s,reason:o}):Object(a.a)("%(senderName)s kicked %(targetName)s",{senderName:t,targetName:s}):null}},"m.room.third_party_invite":function(e){const t=e.sender?e.sender.name:e.getSender();return Object(c.c)(e)?()=>Object(a.a)("%(senderName)s sent an invitation to %(targetDisplayName)s to join the room.",{senderName:t,targetDisplayName:e.getContent().display_name}):()=>Object(a.a)("%(senderName)s revoked the invitation for %(targetDisplayName)s to join the room.",{senderName:t,targetDisplayName:e.getPrevContent().display_name||Object(a.a)("Someone")})},"m.room.history_visibility":function(e){const t=e.sender?e.sender.name:e.getSender();switch(e.getContent().history_visibility){case"invited":return()=>Object(a.a)("%(senderName)s made future room history visible to all room members, from the point they are invited.",{senderName:t});case"joined":return()=>Object(a.a)("%(senderName)s made future room history visible to all room members, from the point they joined.",{senderName:t});case"shared":return()=>Object(a.a)("%(senderName)s made future room history visible to all room members.",{senderName:t});case"world_readable":return()=>Object(a.a)("%(senderName)s made future room history visible to anyone.",{senderName:t});default:return()=>Object(a.a)("%(senderName)s made future room history visible to unknown (%(visibility)s).",{senderName:t,visibility:e.getContent().history_visibility})}},"m.room.power_levels":function(e){const t=e.sender?e.sender.name:e.getSender();if(!(e.getPrevContent()&&e.getPrevContent().users&&e.getContent()&&e.getContent().users))return null;const s=e.getContent().users_default||0,n=[];Object.keys(e.getContent().users).forEach(e=>{-1===n.indexOf(e)&&n.push(e)}),Object.keys(e.getPrevContent().users).forEach(e=>{-1===n.indexOf(e)&&n.push(e)});const i=[];return n.forEach(t=>{const s=e.getPrevContent().users[t],n=e.getContent().users[t];n!==s&&i.push({userId:t,from:s,to:n})}),i.length?()=>Object(a.a)("%(senderName)s changed the power level of %(powerLevelDiffText)s.",{senderName:t,powerLevelDiffText:i.map(e=>Object(a.a)("%(userId)s from %(fromPowerLevel)s to %(toPowerLevel)s",{userId:e.userId,fromPowerLevel:r.b(e.from,s),toPowerLevel:r.b(e.to,s)})).join(", ")}):null},"m.room.pinned_events":function(e,t){if(!l.b.getValue("feature_pinning"))return null;const s=e.sender?e.sender.name:e.getSender();return t?()=>i.a.createElement("span",null,Object(a.a)("%(senderName)s changed the <a>pinned messages</a> for the room.",{senderName:s},{a:e=>i.a.createElement("a",{onClick:g}," ",e," ")})):()=>Object(a.a)("%(senderName)s changed the pinned messages for the room.",{senderName:s})},"m.room.server_acl":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender(),s=e.getPrevContent(),n=e.getContent(),i=Array.isArray(s.deny)?s.deny:[],o=Array.isArray(s.allow)?s.allow:[];s.allow_ip_literals;let r=null;return r=0===i.length&&0===o.length?()=>Object(a.a)("%(senderDisplayName)s set the server ACLs for this room.",{senderDisplayName:t}):()=>Object(a.a)("%(senderDisplayName)s changed the server ACLs for this room.",{senderDisplayName:t}),Array.isArray(n.allow)||(n.allow=[]),0===n.allow.length?()=>r()+" "+Object(a.a)("🎉 All servers are banned from participating! This room can no longer be used."):r},"m.room.tombstone":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return()=>Object(a.a)("%(senderDisplayName)s upgraded this room.",{senderDisplayName:t})},"m.room.join_rules":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();switch(e.getContent().join_rule){case"public":return()=>Object(a.a)("%(senderDisplayName)s made the room public to whoever knows the link.",{senderDisplayName:t});case"invite":return()=>Object(a.a)("%(senderDisplayName)s made the room invite only.",{senderDisplayName:t});default:return()=>Object(a.a)("%(senderDisplayName)s changed the join rule to %(rule)s",{senderDisplayName:t,rule:e.getContent().join_rule})}},"m.room.guest_access":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();switch(e.getContent().guest_access){case"can_join":return()=>Object(a.a)("%(senderDisplayName)s has allowed guests to join the room.",{senderDisplayName:t});case"forbidden":return()=>Object(a.a)("%(senderDisplayName)s has prevented guests from joining the room.",{senderDisplayName:t});default:return()=>Object(a.a)("%(senderDisplayName)s changed guest access to %(rule)s",{senderDisplayName:t,rule:e.getContent().guest_access})}},"m.room.related_groups":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender(),s=e.getContent().groups||[],n=e.getPrevContent().groups||[],i=s.filter(e=>!n.includes(e)),o=n.filter(e=>!s.includes(e));return i.length&&!o.length?()=>Object(a.a)("%(senderDisplayName)s enabled flair for %(groups)s in this room.",{senderDisplayName:t,groups:i.join(", ")}):!i.length&&o.length?()=>Object(a.a)("%(senderDisplayName)s disabled flair for %(groups)s in this room.",{senderDisplayName:t,groups:o.join(", ")}):i.length&&o.length?()=>Object(a.a)("%(senderDisplayName)s enabled flair for %(newGroups)s and disabled flair for %(oldGroups)s in this room.",{senderDisplayName:t,newGroups:i.join(", "),oldGroups:o.join(", ")}):null},"im.vector.modular.widgets":function(e){const t=e.getSender(),{name:s,type:n,url:i}=e.getPrevContent(),{name:o,type:r,url:c}=e.getContent()||{};let l=o||s||r||n||"";return l&&l.length>0&&(l=l[0].toUpperCase()+l.slice(1)),c?i?()=>Object(a.a)("%(widgetName)s widget modified by %(senderName)s",{widgetName:l,senderName:t}):()=>Object(a.a)("%(widgetName)s widget added by %(senderName)s",{widgetName:l,senderName:t}):()=>Object(a.a)("%(widgetName)s widget removed by %(senderName)s",{widgetName:l,senderName:t})},[u.c]:function(e){var t;const s=(null===(t=e.sender)||void 0===t?void 0:t.name)||e.getSender();return()=>Object(a.a)("%(senderName)s has updated the widget layout",{senderName:s})}};for(const e of d.a)b[e]=v;function y(e){const t=(e.isState()?b:f)[e.getType()];return Boolean(null==t?void 0:t(e))}function _(e,t=!1){var s;const n=(e.isState()?b:f)[e.getType()];return(null==n||null===(s=n(e,t))||void 0===s?void 0:s())||""}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(18),i=s.n(n),o=s(271),a=s(94),r=s(214),c=s(128),l=s(92),d=s(99),u=s(98),h=s(149),m=s(554);let p;!function(e){e.Invited="invited",e.Error="error"}(p||(p={}));const g=["M_NOT_FOUND","M_USER_NOT_FOUND","M_PROFILE_UNDISCLOSED","M_PROFILE_NOT_FOUND"];class v{constructor(e){i()(this,"roomId",void 0),i()(this,"groupId",void 0),i()(this,"canceled",!1),i()(this,"addresses",[]),i()(this,"busy",!1),i()(this,"_fatal",!1),i()(this,"completionStates",{}),i()(this,"errors",{}),i()(this,"deferred",null),i()(this,"reason",null),"+"===e[0]?(this.roomId=null,this.groupId=e):(this.roomId=e,this.groupId=null)}get fatal(){return this._fatal}invite(e,t){if(this.addresses.length>0)throw new Error("Already inviting/invited");this.addresses.push(...e),this.reason=t;for(const e of this.addresses)null===Object(r.d)(e)&&(this.completionStates[e]=p.Error,this.errors[e]={errcode:"M_INVALID",errorText:Object(l.a)("Unrecognised address")});return this.deferred=Object(h.a)(),this.inviteMore(0),this.deferred.promise}cancel(){this.busy&&(this.canceled=!0,this.deferred.reject(new Error("canceled")))}getCompletionState(e){return this.completionStates[e]}getErrorText(e){return this.errors[e]?this.errors[e].errorText:null}async inviteToRoom(e,t,s=!1){const n=Object(r.d)(t);if(n===r.a.Email)return a.a.get().inviteByEmail(e,t);if(n===r.a.MatrixUserId){const n=a.a.get().getRoom(e);if(!n)throw new Error("Room not found");const i=n.getMember(t);if(i&&["join","invite"].includes(i.membership))throw new new o.c({errcode:"RIOT.ALREADY_IN_ROOM",error:"Member already invited"});if(!s&&u.b.getValue("promptBeforeInviteUnknownUsers",this.roomId)){if(!await a.a.get().getProfileInfo(t))throw new Error("User has no profile")}return a.a.get().invite(e,t,void 0,this.reason)}throw new Error("Unsupported address")}doInvite(e,t=!1){return new Promise((s,n)=>{let i;console.log("Inviting "+e),i=null!==this.groupId?c.a.inviteUserToGroup(this.groupId,e):this.inviteToRoom(this.roomId,e,t),i.then(()=>{this.canceled||(this.completionStates[e]=p.Invited,delete this.errors[e],s())}).catch(i=>{if(this.canceled)return;let o;console.error(i);let a=!1;if("M_FORBIDDEN"===i.errcode)a=!0,o=Object(l.a)("You do not have permission to invite people to this room.");else if("RIOT.ALREADY_IN_ROOM"===i.errcode)o=Object(l.a)("User %(userId)s is already in the room",{userId:e});else{if("M_LIMIT_EXCEEDED"===i.errcode)return void setTimeout(()=>{this.doInvite(e,t).then(s,n)},5e3);["M_NOT_FOUND","M_USER_NOT_FOUND"].includes(i.errcode)?o=Object(l.a)("User %(user_id)s does not exist",{user_id:e}):"M_PROFILE_UNDISCLOSED"===i.errcode?o=Object(l.a)("User %(user_id)s may or may not exist",{user_id:e}):"M_PROFILE_NOT_FOUND"!==i.errcode||t?o="M_BAD_STATE"===i.errcode?Object(l.a)("The user must be unbanned before they can be invited."):"M_UNSUPPORTED_ROOM_VERSION"===i.errcode?Object(l.a)("The user's homeserver does not support the version of the room."):Object(l.a)("Unknown server error"):(console.warn(`User ${e} does not have a profile - inviting anyways automatically`),this.doInvite(e,!0).then(s,n))}this.completionStates[e]=p.Error,this.errors[e]={errorText:o,errcode:i.errcode},this.busy=!a,this._fatal=a,a?n(i):s()})})}inviteMore(e,t=!1){if(this.canceled)return;if(e===this.addresses.length){if(this.busy=!1,Object.keys(this.errors).length>0&&!this.groupId){const e=Object.keys(this.errors).filter(e=>g.includes(this.errors[e].errcode));if(e.length>0){const t=()=>{const t=e.map(e=>this.doInvite(e,!0));Promise.all(t).then(()=>this.deferred.resolve(this.completionStates))};return u.b.getValue("promptBeforeInviteUnknownUsers",this.roomId)?(console.log("Showing failed to invite dialog..."),void d.a.createTrackedDialog("Failed to invite","",m.a,{unknownProfileUsers:e.map(e=>({userId:e,errorText:this.errors[e].errorText})),onInviteAnyways:()=>t(),onGiveUp:()=>{for(const t of e)this.completionStates[t]=p.Invited;this.deferred.resolve(this.completionStates)}})):void t()}}return void this.deferred.resolve(this.completionStates)}const s=this.addresses[e];null!==Object(r.d)(s)&&this.completionStates[s]!==p.Invited?this.doInvite(s,t).then(()=>{this.inviteMore(e+1,t)}).catch(()=>this.deferred.resolve(this.completionStates)):this.inviteMore(e+1)}}},,function(e,t,s){"use strict";(function(e,n){s.d(t,"d",(function(){return M})),s.d(t,"c",(function(){return U})),s.d(t,"a",(function(){return L})),s.d(t,"b",(function(){return F}));var i=s(115),o=s.n(i),a=s(311),r=s.n(a),c=s(8),l=s(389),d=s(0),u=s(556),h=s(139),m=s(883),p=s(313),g=s(744),v=s(315),f=s(884),b=s(885),y=s(886),_=s(160),E=s(275),S=s(887),w=s(316),C=s(317),k=s(216),O=s(891),R=s(892),I=s(893),x=s(215),T=s(274),j=s(558),N=s(559),P=s(114);const D=p.a.DeviceVerification,A={[E.b.NAME]:E.b,[S.a.NAME]:S.a,[E.d]:I.a,[E.c]:I.a},M={RECIPROCATE_QR_CODE:E.b.NAME,SAS:S.a.NAME};function U(){return Boolean(e.Olm)}class L extends c.EventEmitter{static getOlmVersion(){return u.a.getOlmVersion()}constructor(e,t,s,n,i,a,r,c){if(super(),this.baseApis=e,this.sessionStore=t,this.userId=s,this.deviceId=n,this.clientStore=i,this.cryptoStore=a,this.roomList=r,o()(this,"backupManager",void 0),o()(this,"crossSigningInfo",void 0),o()(this,"olmDevice",void 0),o()(this,"deviceList",void 0),o()(this,"dehydrationManager",void 0),o()(this,"secretStorage",void 0),o()(this,"reEmitter",void 0),o()(this,"verificationMethods",void 0),o()(this,"supportedAlgorithms",void 0),o()(this,"outgoingRoomKeyRequestManager",void 0),o()(this,"toDeviceVerificationRequests",void 0),o()(this,"inRoomVerificationRequests",void 0),o()(this,"trustCrossSignedDevices",!0),o()(this,"lastOneTimeKeyCheck",null),o()(this,"oneTimeKeyCheckInProgress",!1),o()(this,"roomEncryptors",{}),o()(this,"roomDecryptors",{}),o()(this,"deviceKeys",{}),o()(this,"globalBlacklistUnverifiedDevices",!1),o()(this,"globalErrorOnUnknownDevices",!0),o()(this,"receivedRoomKeyRequests",[]),o()(this,"receivedRoomKeyRequestCancellations",[]),o()(this,"processingRoomKeyRequests",!1),o()(this,"lazyLoadMembers",!1),o()(this,"roomDeviceTrackingState",{}),o()(this,"lastNewSessionForced",{}),o()(this,"sendKeyRequestsImmediately",!1),o()(this,"oneTimeKeyCount",void 0),o()(this,"needsNewFallback",void 0),o()(this,"onDeviceListUserCrossSigningUpdated",async e=>{if(e===this.userId){const t=this.deviceList.getStoredCrossSigningForUser(e),s=t?t.getId():null,n=this.crossSigningInfo.getId(),i=n!==s;n&&s&&!i?await this.checkOwnCrossSigningTrust():(this.storeTrustedSelfKeys(null),this.emit("crossSigning.keysChanged",{}),this.emit("userTrustStatusChanged",this.userId,this.checkUserTrust(e)))}else{await this.checkDeviceVerifications(e);const t=this.deviceList.getStoredCrossSigningForUser(e);t&&(t.updateCrossSigningVerifiedBefore(this.checkUserTrust(e).isCrossSigningVerified()),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage())),this.emit("userTrustStatusChanged",e,this.checkUserTrust(e))}}),o()(this,"onToDeviceEvent",e=>{try{d.a.log(`received to_device ${e.getType()} from: ${e.getSender()} id: ${e.getId()}`),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this.onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this.onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this.secretStorage._onRequestReceived(e):"m.secret.send"===e.getType()?this.secretStorage._onSecretReceived(e):"org.matrix.room_key.withheld"===e.getType()?this.onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this.onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this.onToDeviceBadEncrypted(e):(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&(e.isBeingDecrypted()||e.attemptDecryption(this),e.once("Event.decrypted",e=>{this.onToDeviceEvent(e)}))}catch(e){d.a.error("Error handling toDeviceEvent:",e)}}),o()(this,"onTimelineEvent",(e,t,s,n,{liveEvent:i=!0}={})=>{if(!O.a.validateEvent(e,this.baseApis))return;this.handleVerificationEvent(e,this.inRoomVerificationRequests,e=>{const t=new O.a(this.baseApis,e.getRoomId());return new k.k(t,this.verificationMethods,this.baseApis)},i)}),this.reEmitter=new l.a(this),c){this.verificationMethods=new Map;for(const e of c)"string"==typeof e?A[e]&&this.verificationMethods.set(e,A[e]):e.NAME?this.verificationMethods.set(e.NAME,e):d.a.warn("Excluding unknown verification method "+e)}else this.verificationMethods=A;this.backupManager=new N.a(e,async()=>{const e=await this.getSessionBackupPrivateKey();if(e)return e;const t=await this.getSecret("m.megolm_backup.v1");if(t){const e=F(t);if(e){const[t]=await this.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",e,[t])}return h.decodeBase64(e||t)}if(this.baseApis.cryptoCallbacks&&this.baseApis.cryptoCallbacks.getBackupKey)return await this.baseApis.cryptoCallbacks.getBackupKey();throw new Error("Unable to get private key")}),this.olmDevice=new u.a(a),this.deviceList=new m.a(e,a,this.olmDevice),this.deviceList.on("userCrossSigningUpdated",this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,["crypto.devicesUpdated","crypto.willUpdateDevices"]),this.supportedAlgorithms=Object.keys(g.a),this.outgoingRoomKeyRequestManager=new y.a(e,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new R.b,this.inRoomVerificationRequests=new O.b;const p=this.baseApis.cryptoCallbacks||{},f=Object(v.d)(a,this.olmDevice);this.crossSigningInfo=new v.a(s,p,f),this.secretStorage=new b.b(e,p),this.dehydrationManager=new j.b(this),!p.getCrossSigningKey&&p.getSecretStorageKey&&(p.getCrossSigningKey=async e=>v.a.getFromSecretStorage(e,this.secretStorage))}async init({exportedOlmDevice:t,pickleKey:s}={}){d.a.log("Crypto: initialising Olm..."),await e.Olm.init(),d.a.log(t?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),await this.olmDevice.init({fromExportedDevice:t,pickleKey:s}),d.a.log("Crypto: loading device list..."),await this.deviceList.load(),this.deviceKeys["ed25519:"+this.deviceId]=this.olmDevice.deviceEd25519Key,this.deviceKeys["curve25519:"+this.deviceId]=this.olmDevice.deviceCurve25519Key,d.a.log("Crypto: fetching own devices...");let n=this.deviceList.getRawStoredDevicesForUser(this.userId);if(n||(n={}),!n[this.deviceId]){d.a.log("Crypto: adding this device to the store...");const e={keys:this.deviceKeys,algorithms:this.supportedAlgorithms,verified:D.VERIFIED,known:!0};n[this.deviceId]=e,this.deviceList.storeDevicesForUser(this.userId,n),this.deviceList.saveIfDirty()}await this.cryptoStore.doTxn("readonly",[_.a.STORE_ACCOUNT],e=>{this.cryptoStore.getCrossSigningKeys(e,e=>{e&&0!==Object.keys(e).length&&(d.a.log("Loaded cross-signing public keys from crypto store"),this.crossSigningInfo.setKeys(e))})}),this.deviceList.startTrackingDeviceList(this.userId),d.a.log("Crypto: checking for key backup..."),this.backupManager.checkAndStart()}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setCryptoTrustCrossSignedDevices(e){this.trustCrossSignedDevices=e;for(const e of this.deviceList.getKnownUserIds()){const t=this.deviceList.getRawStoredDevicesForUser(e);for(const s of Object.keys(t)){const t=this.checkDeviceTrust(e,s);if(!t.isLocallyVerified()&&t.isCrossSigningVerified()){const t=this.deviceList.getStoredDevice(e,s);this.emit("deviceVerificationChanged",e,s,t)}}}}async createRecoveryKeyFromPassphrase(t){const s=new e.Olm.PkDecryption;try{const e={};if(t){const n=await Object(w.c)(t);e.passphrase={algorithm:"m.pbkdf2",iterations:n.iterations,salt:n.salt},e.pubkey=s.init_with_private_key(n.key)}else e.pubkey=s.generate_key();const n=s.get_private_key();return{keyInfo:e,encodedPrivateKey:Object(C.b)(n),privateKey:n}}finally{s&&s.free()}}async isCrossSigningReady(){const e=this.crossSigningInfo.getId(),t=await this.crossSigningInfo.isStoredInKeyCache()||await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage);return!(!e||!t)}async isSecretStorageReady(){const e=await this.secretStorage.hasKey(),t=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),s=!this.backupManager.getKeyBackupEnabled()||await this.baseApis.isKeyBackupKeyStored();return!!(e&&t&&s)}async bootstrapCrossSigning({authUploadDeviceSigningKeys:e,setupNewCrossSigning:t}={}){d.a.log("Bootstrapping cross-signing");const s=this.baseApis.cryptoCallbacks,n=new f.a(this.baseApis.store.accountData,s),i=new v.a(this.userId,n.crossSigningCallbacks,n.crossSigningCallbacks),o=async()=>{i.resetKeys(),await this.signObject(i.keys.master),n.addCrossSigningKeys(e,i.keys);const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),s=await i.signDevice(this.userId,t);n.addKeySignature(this.userId,this.deviceId,s),this.backupManager.backupInfo&&(await i.signObject(this.backupManager.backupInfo.auth_data,"master"),n.addSessionBackup(this.backupManager.backupInfo))},a=this.crossSigningInfo.getId(),r=await this.crossSigningInfo.isStoredInKeyCache(),c=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),l=r||c;d.a.log({setupNewCrossSigning:t,publicKeysOnDevice:a,privateKeysInCache:r,privateKeysInStorage:c,privateKeysExistSomewhere:l}),!l||t?(d.a.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),await o()):a&&r?d.a.log("Cross-signing public keys trusted and private keys found locally"):c&&(d.a.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),await this.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));const u=n.crossSigningCallbacks.privateKeys;if(u.size&&!this.baseApis.cryptoCallbacks.saveCrossSigningKeys){const e=new b.b(n.accountDataClientAdapter,n.ssssCryptoCallbacks);await e.hasKey()&&(d.a.log("Storing new cross-signing private keys in secret storage"),await v.a.storeInSecretStorage(u,e))}const h=n.buildOperation();await h.apply(this),await n.persist(this),d.a.log("Cross-signing ready")}async bootstrapSecretStorage({createSecretStorageKey:e=(async()=>({})),keyBackupInfo:t,setupNewKeyBackup:s,setupNewSecretStorage:n,getKeyBackupPassphrase:i}={}){d.a.log("Bootstrapping Secure Secret Storage");const o=this.baseApis.cryptoCallbacks,a=new f.a(this.baseApis.store.accountData,o),r=new b.b(a.accountDataClientAdapter,a.ssssCryptoCallbacks);let c=null;const l=async(e,t)=>{e=e||{},t&&(e.key=t);const{keyId:s,keyInfo:n}=await r.addKey(b.a,e);return t&&a.ssssCryptoCallbacks.addPrivateKey(s,n,t),await r.setDefaultKeyId(s),s},u=async(e,t)=>{if(!t.mac){const s=await this.baseApis.cryptoCallbacks.getSecretStorageKey({keys:{[e]:t}},"");if(s){const n=s[1];a.ssssCryptoCallbacks.addPrivateKey(e,t,n);const{iv:i,mac:o}=await b.b._calculateKeyCheck(n);t.iv=i,t.mac=o,await a.setAccountData("m.secret_storage.key."+e,t)}}},m=async e=>{if(this.crossSigningInfo.getId()&&await this.crossSigningInfo.isStoredInKeyCache("master"))try{d.a.log("Adding cross-signing signature to key backup"),await this.crossSigningInfo.signObject(e,"master")}catch(e){d.a.error("Signing key backup with cross-signing keys failed",e)}else d.a.warn("Cross-signing keys not available, skipping signature on key backup")},p=await this.getSecretStorageKey(),[g,y]=p||[null,null],_=!n&&y&&y.algorithm===b.a;if(d.a.log({keyBackupInfo:t,setupNewKeyBackup:s,setupNewSecretStorage:n,storageExists:_,oldKeyInfo:y}),_||t)if(!_&&t){d.a.log("Secret storage does not exist, using key backup key");const e=await this.getSessionBackupPrivateKey()||await i(),s={};t.auth_data.private_key_salt&&t.auth_data.private_key_iterations&&(s.passphrase={algorithm:"m.pbkdf2",iterations:t.auth_data.private_key_iterations,salt:t.auth_data.private_key_salt,bits:256}),c=await l(s,e),await r.store("m.megolm_backup.v1",h.encodeBase64(e),[c]),await m(t.auth_data),a.addSessionBackup(t)}else d.a.log("Secret storage exists"),y&&y.algorithm===b.a&&await u(g,y);else{d.a.log("Secret storage does not exist, creating new storage key");const{keyInfo:t,privateKey:s}=await e();c=await l(t,s)}if(!this.baseApis.cryptoCallbacks.saveCrossSigningKeys&&await this.isCrossSigningReady()&&(c||!await this.crossSigningInfo.isStoredInSecretStorage(r))){d.a.log("Copying cross-signing private keys from cache to secret storage");const e=await this.crossSigningInfo.getCrossSigningKeysFromCache();await v.a.storeInSecretStorage(e,r)}if(s&&!t){d.a.log("Creating new message key backup version");const e=await this.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),t=Object(C.a)(e.recovery_key);await r.store("m.megolm_backup.v1",h.encodeBase64(t));const s={algorithm:e.algorithm,auth_data:e.auth_data};await m(s.auth_data),await this.signObject(s.auth_data),a.addSessionBackup(s)}const E=await r.get("m.megolm_backup.v1");if(E){d.a.info("Got session backup key from secret storage: caching");const e=F(E);e&&await r.store("m.megolm_backup.v1",e,[c||g]);const t=new Uint8Array(h.decodeBase64(e||E));await a.addSessionBackupPrivateKeyToCache(t)}const S=a.buildOperation();await S.apply(this),await a.persist(this),d.a.log("Secure Secret Storage ready")}addSecretStorageKey(e,t,s){return this.secretStorage.addKey(e,t,s)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}getSecretStorageKey(e){return this.secretStorage.getKey(e)}storeSecret(e,t,s){return this.secretStorage.store(e,t,s)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e,t){return this.secretStorage.isStored(e,t)}requestSecret(e,t){return t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}checkSecretStoragePrivateKey(t,s){let n=null;try{n=new e.Olm.PkDecryption;return n.init_with_private_key(t)===s}finally{n&&n.free()}}async getSessionBackupPrivateKey(){let e=await new Promise(e=>{this.cryptoStore.doTxn("readonly",[_.a.STORE_ACCOUNT],t=>{this.cryptoStore.getSecretStorePrivateKey(t,e,"m.megolm_backup.v1")})});if(e&&"string"==typeof e&&(e=new Uint8Array(h.decodeBase64(F(e)||e)),await this.storeSessionBackupPrivateKey(e)),e&&e.ciphertext){const t=n.from(this.olmDevice._pickleKey),s=await Object(T.a)(e,t,"m.megolm_backup.v1");e=h.decodeBase64(s)}return e}async storeSessionBackupPrivateKey(e){if(!(e instanceof Uint8Array))throw new Error("storeSessionBackupPrivateKey expects Uint8Array, got "+e);const t=n.from(this.olmDevice._pickleKey);return e=await Object(T.b)(h.encodeBase64(e),t,"m.megolm_backup.v1"),this.cryptoStore.doTxn("readwrite",[_.a.STORE_ACCOUNT],t=>{this.cryptoStore.storeSecretStorePrivateKey(t,"m.megolm_backup.v1",e)})}checkCrossSigningPrivateKey(t,s){let n=null;try{n=new e.Olm.PkSigning;return n.init_with_seed(t)===s}finally{n&&n.free()}}async afterCrossSigningLocalKeyChange(){d.a.info("Starting cross-signing key change post-processing");const e=this.deviceList.getStoredDevice(this.userId,this.deviceId),t=await this.crossSigningInfo.signDevice(this.userId,e);d.a.info("Starting background key sig upload for "+this.deviceId);const s=({shouldEmit:e})=>this.baseApis.uploadKeySignatures({[this.userId]:{[this.deviceId]:t}}).then(t=>{const{failures:n}=t||{};if(Object.keys(n||[]).length>0)throw e&&this.baseApis.emit("crypto.keySignatureUploadFailure",n,"afterCrossSigningLocalKeyChange",s),new x.c("Key upload failed",{failures:n});d.a.info("Finished background key sig upload for "+this.deviceId)}).catch(e=>{d.a.error("Error during background key sig upload for "+this.deviceId,e)});s({shouldEmit:!0});const n=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(n){d.a.info("Starting device verification upgrade");const e={};for(const[t,s]of Object.entries(this.deviceList.crossSigningInfo)){const n=await this.checkForDeviceVerificationUpgrade(t,v.a.fromStorage(s,t));n&&(e[t]=n)}if(Object.keys(e).length>0){d.a.info(`Found ${Object.keys(e).length} verif users to upgrade`);try{const t=await n({users:e});if(t)for(const s of t)s in e&&await this.baseApis.setDeviceVerified(s,e[s].crossSigningInfo.getId())}catch(e){d.a.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",e)}}d.a.info("Finished device verification upgrade")}d.a.info("Finished cross-signing key change post-processing")}async checkForDeviceVerificationUpgrade(e,t){const s=this.crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!s.isVerified()){const s=this.deviceList.getRawStoredDevicesForUser(e),n=await this.checkForValidDeviceSignature(e,t.keys.master,s);if(n.length)return{devices:n.map(e=>p.a.fromStorage(s[e],e)),crossSigningInfo:t}}}async checkForValidDeviceSignature(e,t,s){const n=[];if(s&&t.signatures&&t.signatures[e])for(const i of Object.keys(t.signatures[e])){const[,o]=i.split(":",2);if(o in s&&s[o].verified===D.VERIFIED)try{await h.verifySignature(this.olmDevice,t,e,o,s[o].keys[i]),n.push(o)}catch(e){}}return n}getCrossSigningId(e){return this.crossSigningInfo.getId(e)}getStoredCrossSigningForUser(e){return this.deviceList.getStoredCrossSigningForUser(e)}checkUserTrust(e){const t=this.deviceList.getStoredCrossSigningForUser(e);return t?this.crossSigningInfo.checkUserTrust(t):new v.c(!1,!1,!1)}checkDeviceTrust(e,t){const s=this.deviceList.getStoredDevice(e,t);return this.checkDeviceInfoTrust(e,s)}checkDeviceInfoTrust(e,t){const s=!(!t||!t.isVerified()),n=this.deviceList.getStoredCrossSigningForUser(e);if(t&&n){const i=this.trustCrossSignedDevices||e===this.userId;return this.crossSigningInfo.checkDeviceTrust(n,t,s,i)}return new v.b(!1,!1,s,!1)}async checkOwnCrossSigningTrust({allowPrivateKeyRequests:e=!1}={}){const t=this.userId;await this.downloadKeys([this.userId]);const s=await this.crossSigningInfo.getCrossSigningKeysFromCache(),n=this.deviceList.getStoredCrossSigningForUser(t);if(!n)return void d.a.error("Got cross-signing update event for user "+t+" but no new cross-signing information found!");const i=n.getId(),o=this.crossSigningInfo.getId()!==i,a=n.getId()&&!s.has("master");if(o&&d.a.info("Got new master public key",i),e&&(o||a)){d.a.info("Attempting to retrieve cross-signing master private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("master",i))[1],d.a.info("Got cross-signing master private key")}finally{e&&e.free()}}const r=this.crossSigningInfo.getId("self_signing"),c=this.crossSigningInfo.getId("user_signing");this.storeTrustedSelfKeys(n.keys);const l=r!==n.getId("self_signing"),u=c!==n.getId("user_signing"),h=n.getId("self_signing")&&!s.has("self_signing"),m=n.getId("user_signing")&&!s.has("user_signing"),p={};if(l&&d.a.info("Got new self-signing key",n.getId("self_signing")),e&&(l||h)){d.a.info("Attempting to retrieve cross-signing self-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("self_signing",n.getId("self_signing")))[1],d.a.info("Got cross-signing self-signing private key")}finally{e&&e.free()}const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),s=await this.crossSigningInfo.signDevice(this.userId,t);p[this.deviceId]=s}if(u&&d.a.info("Got new user-signing key",n.getId("user_signing")),e&&(u||m)){d.a.info("Attempting to retrieve cross-signing user-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("user_signing",n.getId("user_signing")))[1],d.a.info("Got cross-signing user-signing private key")}finally{e&&e.free()}}if(o){const e=this.crossSigningInfo.keys.master;await this.signObject(e);const t=e.signatures[this.userId]["ed25519:"+this.deviceId];p[this.crossSigningInfo.getId()]=Object.assign({},e,{signatures:{[this.userId]:{["ed25519:"+this.deviceId]:t}}})}const g=Object.keys(p);if(g.length){const e=({shouldEmit:t})=>(d.a.info("Starting background key sig upload for "+g),this.baseApis.uploadKeySignatures({[this.userId]:p}).then(s=>{const{failures:n}=s||{};if(d.a.info("Finished background key sig upload for "+g),Object.keys(n||[]).length>0)throw t&&this.baseApis.emit("crypto.keySignatureUploadFailure",n,"checkOwnCrossSigningTrust",e),new x.c("Key upload failed",{failures:n})}).catch(e=>{d.a.error("Error during background key sig upload for "+g,e)}));e({shouldEmit:!0})}this.emit("userTrustStatusChanged",t,this.checkUserTrust(t)),o&&(this.baseApis.emit("crossSigning.keysChanged",{}),await this.afterCrossSigningLocalKeyChange()),await this.backupManager.checkKeyBackup()}async storeTrustedSelfKeys(e){e?this.crossSigningInfo.setKeys(e):this.crossSigningInfo.clearKeys(),await this.cryptoStore.doTxn("readwrite",[_.a.STORE_ACCOUNT],e=>{this.cryptoStore.storeCrossSigningKeys(e,this.crossSigningInfo.keys)})}async checkDeviceVerifications(e){const t=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(t){if(d.a.info("Starting device verification upgrade for "+e),this.crossSigningInfo.keys.user_signing){const s=this.deviceList.getStoredCrossSigningForUser(e);if(s){const n=await this.checkForDeviceVerificationUpgrade(e,s);if(n){(await t({users:{[e]:n}})).includes(e)&&await this.baseApis.setDeviceVerified(e,s.getId())}}}d.a.info("Finished device verification upgrade for "+e)}}async setTrustedBackupPubKey(e){this.sessionStore.setLocalTrustedBackupPubKey(e),await this.backupManager.checkKeyBackup()}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(e){e.on("RoomMember.membership",(e,t,s)=>{try{this.onRoomMembership(e,t,s)}catch(e){d.a.error("Error handling membership change:",e)}}),e.on("toDeviceEvent",this.onToDeviceEvent),e.on("Room.timeline",this.onTimelineEvent),e.on("Event.decrypted",this.onTimelineEvent)}start(){this.outgoingRoomKeyRequestManager.start()}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}setGlobalBlacklistUnverifiedDevices(e){this.globalBlacklistUnverifiedDevices=e}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){this.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){return this.globalErrorOnUnknownDevices}uploadDeviceKeys(){const e={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(e).then(()=>this.baseApis.uploadKeysRequest({device_keys:e}))}updateOneTimeKeyCount(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this.oneTimeKeyCount=e}setNeedsNewFallback(e){this.needsNewFallback=!!e}getNeedsNewFallback(){return this.needsNewFallback}maybeUploadOneTimeKeys(){if(this.oneTimeKeyCheckInProgress)return;const e=Date.now();if(null!==this.lastOneTimeKeyCheck&&e-this.lastOneTimeKeyCheck<6e4)return;this.lastOneTimeKeyCheck=e;const t=this.olmDevice.maxNumberOfOneTimeKeys(),s=Math.floor(t/2),n=async e=>{for(;s>e||this.getNeedsNewFallback();){if(s>e){d.a.info("generating oneTimeKeys");const t=Math.min(s-e,5);await this.olmDevice.generateOneTimeKeys(t)}this.getNeedsNewFallback()&&(d.a.info("generating fallback key"),await this.olmDevice.generateFallbackKey()),d.a.info("calling uploadOneTimeKeys");const t=await this.uploadOneTimeKeys();if(!t.one_time_key_counts||!t.one_time_key_counts.signed_curve25519)throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519");e=t.one_time_key_counts.signed_curve25519}};this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then(()=>void 0!==this.oneTimeKeyCount?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then(e=>e.one_time_key_counts.signed_curve25519||0)).then(e=>n(e)).catch(e=>{d.a.error("Error uploading one-time keys",e.stack||e)}).finally(()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1})}async uploadOneTimeKeys(){const e=[],t={};if(this.getNeedsNewFallback()){const s=await this.olmDevice.getFallbackKey();for(const[n,i]of Object.entries(s.curve25519)){const s={key:i,fallback:!0};t["signed_curve25519:"+n]=s,e.push(this.signObject(s))}this.setNeedsNewFallback(!1)}const s=await this.olmDevice.getOneTimeKeys(),n={};for(const t in s.curve25519)if(s.curve25519.hasOwnProperty(t)){const i={key:s.curve25519[t]};n["signed_curve25519:"+t]=i,e.push(this.signObject(i))}await Promise.all(e);const i=await this.baseApis.uploadKeysRequest({one_time_keys:n,"org.matrix.msc2732.fallback_keys":t});return await this.olmDevice.markKeysAsPublished(),i}downloadKeys(e,t){return this.deviceList.downloadKeys(e,t)}getStoredDevicesForUser(e){return this.deviceList.getStoredDevicesForUser(e)}getStoredDevice(e,t){return this.deviceList.getStoredDevice(e,t)}saveDeviceList(e){return this.deviceList.saveIfDirty(e)}async setDeviceVerification(e,t,s,n,i){void 0===s&&(s=null),void 0===n&&(n=null),void 0===i&&(i=null);const o=this.deviceList.getStoredCrossSigningForUser(e);if(o&&o.getId()===t){if(null!==n||null!==i)throw new Error("Cannot set blocked or known for a cross-signing key");if(!s)throw new Error("Cannot set a cross-signing key as unverified");if(this.crossSigningInfo.getId()||e!==this.crossSigningInfo.userId||(this.storeTrustedSelfKeys(o.keys),this.emit("userTrustStatusChanged",this.userId,this.checkUserTrust(e))),e!==this.userId){d.a.info("Master key "+o.getId()+" for "+e+" marked verified. Signing...");const s=await this.crossSigningInfo.signUser(o);if(s){const n=async({shouldEmit:i})=>{d.a.info("Uploading signature for "+e+"...");const o=await this.baseApis.uploadKeySignatures({[e]:{[t]:s}}),{failures:a}=o||{};if(Object.keys(a||[]).length>0)throw i&&this.baseApis.emit("crypto.keySignatureUploadFailure",a,"setDeviceVerification",n),new x.c("Key upload failed",{failures:a})};await n({shouldEmit:!0})}return s}return o}const a=this.deviceList.getRawStoredDevicesForUser(e);if(!a||!a[t])throw new Error("Unknown device "+e+":"+t);const r=a[t];let c=r.verified;s?c=D.VERIFIED:null!==s&&c==D.VERIFIED&&(c=D.UNVERIFIED),n?c=D.BLOCKED:null!==n&&c==D.BLOCKED&&(c=D.UNVERIFIED);let l=r.known;if(null!==i&&(l=i),r.verified===c&&r.known===l||(r.verified=c,r.known=l,this.deviceList.storeDevicesForUser(e,a),this.deviceList.saveIfDirty()),s&&e===this.userId){let s;d.a.info("Own device "+t+" marked verified: signing");if(this.checkDeviceTrust(e,t).isCrossSigningVerified()?d.a.log(`Own device ${t} already cross-signing verified`):s=await this.crossSigningInfo.signDevice(e,p.a.fromStorage(r,t)),s){const n=async({shouldEmit:i})=>{d.a.info("Uploading signature for "+t);const o=await this.baseApis.uploadKeySignatures({[e]:{[t]:s}}),{failures:a}=o||{};if(Object.keys(a||[]).length>0)throw i&&this.baseApis.emit("crypto.keySignatureUploadFailure",a,"setDeviceVerification",n),new x.c("Key upload failed",{failures:a})};await n({shouldEmit:!0})}}const u=p.a.fromStorage(r,t);return this.emit("deviceVerificationChanged",e,t,u),u}findVerificationRequestDMInProgress(e){return this.inRoomVerificationRequests.findRequestInProgress(e)}getVerificationRequestsToDeviceInProgress(e){return this.toDeviceVerificationRequests.getRequestsInProgress(e)}requestVerificationDM(e,t){const s=this.inRoomVerificationRequests.findRequestInProgress(t);if(s)return Promise.resolve(s);const n=new O.a(this.baseApis,t,e);return this.requestVerificationWithChannel(e,n,this.inRoomVerificationRequests)}requestVerification(e,t){t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(e)));const s=this.toDeviceVerificationRequests.findRequestInProgress(e,t);if(s)return Promise.resolve(s);const n=new R.a(this.baseApis,e,t,R.a.makeTransactionId());return this.requestVerificationWithChannel(e,n,this.toDeviceVerificationRequests)}async requestVerificationWithChannel(e,t,s){let n=new k.k(t,this.verificationMethods,this.baseApis);t.transactionId&&s.setRequestByChannel(t,n),await n.sendRequest();const i=s.getRequestByChannel(t);return i?n=i:(d.a.log(`Crypto: adding new request to requestsByTxnId with id ${t.transactionId} ${t.roomId}`),s.setRequestByChannel(t,n)),n}beginKeyVerification(e,t,s,n=null){let i;if(n){if(i=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,n),!i)throw new Error(`No request found for user ${t} with transactionId `+n)}else{n=R.a.makeTransactionId();const e=new R.a(this.baseApis,t,[s],n,s);i=new k.k(e,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,n,i)}return i.beginKeyVerification(e,{userId:t,deviceId:s})}async legacyDeviceVerification(e,t,s){const n=R.a.makeTransactionId(),i=new R.a(this.baseApis,e,[t],n,t),o=new k.k(i,this.verificationMethods,this.baseApis);this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,n,o);const a=o.beginKeyVerification(s,{userId:e,deviceId:t});return await Promise.race([a.verify(),o.waitFor(e=>e.started)]),o}async getOlmSessionsForUser(e){const t=this.getStoredDevicesForUser(e)||[],s={};for(let e=0;e<t.length;++e){const n=t[e],i=n.getIdentityKey(),o=await this.olmDevice.getSessionInfoForDevice(i);s[n.deviceId]={deviceIdKey:i,sessions:o}}return s}getEventSenderDeviceInfo(e){const t=e.getSenderKey(),s=e.getWireContent().algorithm;if(!t||!s)return null;if(e.getForwardingCurve25519KeyChain().length>0)return null;if(e.isKeySourceUntrusted())return null;const n=this.deviceList.getDeviceByIdentityKey(s,t);if(null===n)return null;const i=e.getClaimedEd25519Key();return i?i!==n.getFingerprint()?(d.a.warn("Event "+e.getId()+" claims ed25519 key "+i+" but sender device has key "+n.getFingerprint()),null):n:(d.a.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(e){const t={};if(t.senderKey=e.getSenderKey(),t.algorithm=e.getWireContent().algorithm,!t.senderKey||!t.algorithm)return t.encrypted=!1,t;t.encrypted=!0;e.getForwardingCurve25519KeyChain().length>0||e.isKeySourceUntrusted()?t.authenticated=!1:t.authenticated=!0,t.sender=this.deviceList.getDeviceByIdentityKey(t.algorithm,t.senderKey);const s=e.getClaimedEd25519Key();return s||(d.a.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),t.mismatchedSender=!0),t.sender&&s!==t.sender.getFingerprint()&&(d.a.warn("Event "+e.getId()+" claims ed25519 key "+s+"but sender device has key "+t.sender.getFingerprint()),t.mismatchedSender=!0),t}forceDiscardSession(e){const t=this.roomEncryptors[e];if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");t.forceDiscardSession()}async setRoomEncryption(e,t,s){if(!t.algorithm)return void d.a.log("Ignoring setRoomEncryption with no algorithm");const n=this.roomList.getRoomEncryption(e);if(n&&JSON.stringify(n)!=JSON.stringify(t))return void d.a.error("Ignoring m.room.encryption event which requests a change of config in "+e);if(this.roomEncryptors[e])return;let i=null;n||(i=this.roomList.setRoomEncryption(e,t));const o=g.c[t.algorithm];if(!o)throw new Error("Unable to encrypt with "+t.algorithm);const a=new o({userId:this.userId,deviceId:this.deviceId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:e,config:t});this.roomEncryptors[e]=a,i&&await i,this.lazyLoadMembers?d.a.log("Enabling encryption in "+e):(d.a.log("Enabling encryption in "+e+"; starting to track device lists for all users therein"),await this.trackRoomDevices(e),s||this.deviceList.refreshOutdatedDeviceLists())}trackRoomDevices(e){const t=async()=>{if(!this.roomEncryptors[e])return;const t=this.clientStore.getRoom(e);if(!t)throw new Error("Unable to start tracking devices in unknown room "+e);d.a.log(`Starting to track devices for room ${e} ...`);(await t.getEncryptionTargetMembers()).forEach(e=>{this.deviceList.startTrackingDeviceList(e.userId)})};let s=this.roomDeviceTrackingState[e];return s||(s=t(),this.roomDeviceTrackingState[e]=s.catch(t=>{throw this.roomDeviceTrackingState[e]=null,t})),s}ensureOlmSessionsForUsers(e){const t={};for(let s=0;s<e.length;++s){const n=e[s];t[n]=[];const i=this.getStoredDevicesForUser(n)||[];for(let e=0;e<i.length;++e){const s=i[e];s.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(s.verified!=D.BLOCKED&&t[n].push(s))}}return h.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,t)}async exportRoomKeys(){const e=[];return await this.cryptoStore.doTxn("readonly",[_.a.STORE_INBOUND_GROUP_SESSIONS],t=>{this.cryptoStore.getAllEndToEndInboundGroupSessions(t,t=>{if(null===t)return;const s=this.olmDevice.exportInboundGroupSession(t.senderKey,t.sessionId,t.sessionData);delete s.first_known_index,s.algorithm=h.MEGOLM_ALGORITHM,e.push(s)})}),e}importRoomKeys(e,t={}){let s=0,n=0;const i=e.length;function o(){t.progressCallback({stage:"load_keys",successes:s,failures:n,total:i})}return Promise.all(e.map(e=>{if(!e.room_id||!e.algorithm)return d.a.warn("ignoring room key entry with missing fields",e),n++,t.progressCallback&&o(),null;return this.getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e,t).finally(()=>{s++,t.progressCallback&&o()})}))}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(e){const t=this.roomEncryptors[e.roomId];t&&t.prepareToEncrypt(e)}async encryptEvent(e,t){if(!t)throw new Error("Cannot send encrypted messages in unknown rooms");const s=e.getRoomId(),n=this.roomEncryptors[s];if(!n)throw new Error("Room was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");this.roomDeviceTrackingState[s]||this.trackRoomDevices(s),await this.roomDeviceTrackingState[s];let i=e.getContent();const o=i["m.relates_to"];o&&(i=Object.assign({},i),delete i["m.relates_to"]);const a=await n.encryptMessage(t,e.getType(),i);o&&(a["m.relates_to"]=o),e.makeEncrypted("m.room.encrypted",a,this.olmDevice.deviceCurve25519Key,this.olmDevice.deviceEd25519Key)}async decryptEvent(e){if(e.isRedacted()){const t=new P.b(e.getUnsigned().redacted_because),s=await this.decryptEvent(t);return{clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:s.clearEvent}}}}{const t=e.getWireContent(),s=this.getRoomDecryptor(e.getRoomId(),t.algorithm);return await s.decryptEvent(e)}}async handleDeviceListChanges(e,t){e.oldSyncToken&&await this.evalDeviceListChanges(t)}requestRoomKey(e,t,s=!1){return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,s).then(()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()}).catch(e=>{d.a.error("Error requesting key for event",e)})}cancelRoomKeyRequest(e){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch(e=>{d.a.warn("Error clearing pending room key requests",e)})}cancelAndResendAllOutgoingKeyRequests(){return this.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()}async onCryptoEvent(e){const t=e.getRoomId(),s=e.getContent();try{await this.setRoomEncryption(t,s,!0)}catch(e){d.a.error("Error configuring encryption in room "+t+":",e)}}async onSyncWillProcess(e){e.oldSyncToken||(d.a.log("Initial sync performed - resetting device tracking state"),this.deviceList.stopTrackingAllDeviceLists(),this.deviceList.startTrackingDeviceList(this.userId),this.roomDeviceTrackingState={}),this.sendKeyRequestsImmediately=!1}async onSyncCompleted(e){this.deviceList.setSyncToken(e.nextSyncToken),this.deviceList.saveIfDirty(),this.deviceList.startTrackingDeviceList(this.userId),this.deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(this.maybeUploadOneTimeKeys(),this.processReceivedRoomKeyRequests(),this.outgoingRoomKeyRequestManager.sendQueuedRequests(),this.sendKeyRequestsImmediately=!0)}async evalDeviceListChanges(e){if(e.changed&&Array.isArray(e.changed)&&e.changed.forEach(e=>{this.deviceList.invalidateUserDeviceList(e)}),e.left&&Array.isArray(e.left)&&e.left.length){const t=new Set(await this.getTrackedE2eUsers());e.left.forEach(e=>{t.has(e)||this.deviceList.stopTrackingDeviceList(e)})}}async getTrackedE2eUsers(){const e=[];for(const t of this.getTrackedE2eRooms()){const s=await t.getEncryptionTargetMembers();for(const t of s)e.push(t.userId)}return e}getTrackedE2eRooms(){return this.clientStore.getRooms().filter(e=>{if(!this.roomEncryptors[e.roomId])return!1;if(!this.roomDeviceTrackingState[e.roomId])return!1;const t=e.getMyMembership();return"join"===t||"invite"===t})}onRoomKeyEvent(e){const t=e.getContent();if(!t.room_id||!t.algorithm)return void d.a.error("key event is missing fields");this.backupManager.checkedForBackup||this.backupManager.checkAndStart();this.getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)}onRoomKeyWithheldEvent(e){const t=e.getContent();if(!(("m.no_olm"===t.code||t.room_id&&t.session_id)&&t.algorithm&&t.sender_key))return void d.a.error("key withheld event is missing fields");d.a.info(`Got room key withheld event from ${e.getSender()} (${t.sender_key}) for ${t.algorithm}/${t.room_id}/${t.session_id} with reason ${t.code} (${t.reason})`);const s=this.getRoomDecryptor(t.room_id,t.algorithm);if(s.onRoomKeyWithheldEvent&&s.onRoomKeyWithheldEvent(e),!t.room_id){const e=this.getRoomDecryptors(t.algorithm);for(const s of e)s.retryDecryptionFromSender(t.sender_key)}}onKeyVerificationMessage(e){if(!R.a.validateEvent(e,this.baseApis))return;this.handleVerificationEvent(e,this.toDeviceVerificationRequests,e=>{if(!R.a.canCreateRequest(R.a.getEventType(e)))return;const t=e.getContent(),s=t&&t.from_device;if(!s)return;const n=e.getSender(),i=new R.a(this.baseApis,n,[s]);return new k.k(i,this.verificationMethods,this.baseApis)})}async handleVerificationEvent(e,t,s,n=!0){let i=t.getRequest(e),o=!1;if(!i){if(i=s(e),!i)return void d.a.log("Crypto: could not find VerificationRequest for "+e.getType()+", and could not create one, so ignoring.");o=!0,t.setRequest(e,i)}e.setVerificationRequest(i);try{await i.channel.handleEvent(e,i,n)}catch(e){d.a.error("error while handling verification event: "+e.message)}o&&!i.initiatedByMe&&!i.invalid&&!i.observeOnly&&this.baseApis.emit("crypto.verification.request",i)}async onToDeviceBadEncrypted(e){const t=e.getWireContent(),s=e.getSender(),n=t.algorithm,i=t.sender_key,o=()=>{const e=this.getRoomDecryptors(h.MEGOLM_ALGORITHM);for(const t of e)t.retryDecryptionFromSender(i)};if(void 0===s||void 0===i||void 0===i)return;this.lastNewSessionForced[s]=this.lastNewSessionForced[s]||{};const a=this.lastNewSessionForced[s][i]||0;if(a+36e5>Date.now())return d.a.debug("New session already forced with device "+s+":"+i+" at "+a+": not forcing another"),await this.olmDevice.recordSessionProblem(i,"wedged",!0),void o();let r=this.deviceList.getDeviceByIdentityKey(n,i);if(!r&&(await this.downloadKeys([s],!1),r=this.deviceList.getDeviceByIdentityKey(n,i),!r))return d.a.info("Couldn't find device for identity key "+i+": not re-establishing session"),await this.olmDevice.recordSessionProblem(i,"wedged",!1),void o();const c={};c[s]=[r],await h.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,c,!0),this.lastNewSessionForced[s][i]=Date.now();const l={algorithm:h.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}};await h.encryptMessageForDevice(l.ciphertext,this.userId,this.deviceId,this.olmDevice,s,r,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(i,"wedged",!0),o(),await this.baseApis.sendToDevice("m.room.encrypted",{[s]:{[r.deviceId]:l}});const u=await this.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(s,r.deviceId);for(const e of u)this.requestRoomKey(e.requestBody,e.recipients,!0)}onRoomMembership(e,t,s){const n=t.roomId,i=this.roomEncryptors[n];i&&(this.roomDeviceTrackingState[n]&&("join"==t.membership?(d.a.log("Join event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId)):"invite"==t.membership&&this.clientStore.getRoom(n).shouldEncryptForInvitedMembers()&&(d.a.log("Invite event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId))),i.onRoomMembership(e,t,s))}onRoomKeyRequestEvent(e){const t=e.getContent();if("request"===t.action){const t=new B(e);this.receivedRoomKeyRequests.push(t)}else if("request_cancellation"===t.action){const t=new V(e);this.receivedRoomKeyRequestCancellations.push(t)}}async processReceivedRoomKeyRequests(){if(!this.processingRoomKeyRequests){this.processingRoomKeyRequests=!0;try{const e=this.receivedRoomKeyRequests;this.receivedRoomKeyRequests=[];const t=this.receivedRoomKeyRequestCancellations;this.receivedRoomKeyRequestCancellations=[],await Promise.all(e.map(e=>this.processReceivedRoomKeyRequest(e))),await Promise.all(t.map(e=>this.processReceivedRoomKeyRequestCancellation(e)))}catch(e){d.a.error("Error processing room key requsts: "+e)}finally{this.processingRoomKeyRequests=!1}}}async processReceivedRoomKeyRequest(e){const t=e.userId,s=e.deviceId,n=e.requestBody,i=n.room_id,o=n.algorithm;if(d.a.log(`m.room_key_request from ${t}:${s} for ${i} / ${n.session_id} (id ${e.requestId})`),t!==this.userId){if(!this.roomEncryptors[i])return void d.a.debug("room key request for unencrypted room "+i);const e=this.roomEncryptors[i],o=this.deviceList.getStoredDevice(t,s);if(!o)return void d.a.debug(`Ignoring keyshare for unknown device ${t}:${s}`);try{await e.reshareKeyWithDevice(n.sender_key,n.session_id,t,o)}catch(e){d.a.warn("Failed to re-share keys for session "+n.session_id+" with device "+t+":"+o.deviceId,e)}return}if(s===this.deviceId)return void d.a.log("Ignoring room key request from ourselves");if(!this.roomDecryptors[i])return void d.a.log("room key request for unencrypted room "+i);const a=this.roomDecryptors[i][o];if(a)if(await a.hasKeysForKeyRequest(e)){if(e.share=()=>{a.shareKeysWithDevice(e)},this.checkDeviceTrust(t,s).isVerified())return d.a.log("device is already verified: sharing keys"),void e.share();this.emit("crypto.roomKeyRequest",e)}else d.a.log(`room key request for unknown session ${i} / `+n.session_id);else d.a.log(`room key request for unknown alg ${o} in room ${i}`)}async processReceivedRoomKeyRequestCancellation(e){d.a.log(`m.room_key_request cancellation for ${e.userId}:${e.deviceId} (id ${e.requestId})`),this.emit("crypto.roomKeyRequestCancellation",e)}getRoomDecryptor(e,t){let s,n;if((e=e||null)&&(s=this.roomDecryptors[e],s||(this.roomDecryptors[e]=s={}),n=s[t],n))return n;const i=g.a[t];if(!i)throw new g.b("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+t+'".');return n=new i({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:e}),s&&(s[t]=n),n}getRoomDecryptors(e){const t=[];for(const s of Object.values(this.roomDecryptors))e in s&&t.push(s[e]);return t}async signObject(e){const t=e.signatures||{},s=e.unsigned;delete e.signatures,delete e.unsigned,t[this.userId]=t[this.userId]||{},t[this.userId]["ed25519:"+this.deviceId]=await this.olmDevice.sign(r.a.stringify(e)),e.signatures=t,void 0!==s&&(e.unsigned=s)}}function F(e){if("string"!=typeof e||e.indexOf(",")<0)return null;const t=Uint8Array.from(e.split(","),e=>parseInt(e));return h.encodeBase64(t)}class B{constructor(e){o()(this,"userId",void 0),o()(this,"deviceId",void 0),o()(this,"requestId",void 0),o()(this,"requestBody",void 0),o()(this,"share",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class V{constructor(e){o()(this,"userId",void 0),o()(this,"deviceId",void 0),o()(this,"requestId",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}}).call(this,s(7),s(36).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n,i=s(115),o=s.n(i);!function(e){e[e.Blocked=-1]="Blocked",e[e.Unverified=0]="Unverified",e[e.Verified=1]="Verified"}(n||(n={}));class a{static fromStorage(e,t){const s=new a(t);for(const t in e)e.hasOwnProperty(t)&&(s[t]=e[t]);return s}constructor(e){this.deviceId=e,o()(this,"algorithms",void 0),o()(this,"keys",{}),o()(this,"verified",n.Unverified),o()(this,"known",!1),o()(this,"unsigned",{}),o()(this,"signatures",{})}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==n.Blocked}isVerified(){return this.verified==n.Verified}isUnverified(){return this.verified==n.Unverified}isKnown(){return!0===this.known}}o()(a,"DeviceVerification",{VERIFIED:n.Verified,UNVERIFIED:n.Unverified,BLOCKED:n.Blocked})},function(e,t,s){"use strict";s.d(t,"d",(function(){return n})),s.d(t,"a",(function(){return i})),s.d(t,"e",(function(){return o})),s.d(t,"b",(function(){return a})),s.d(t,"c",(function(){return r})),s.d(t,"f",(function(){return c})),s.d(t,"g",(function(){return l}));const n={},i={};class o{constructor(e){this._userId=e.userId,this._deviceId=e.deviceId,this._crypto=e.crypto,this._olmDevice=e.olmDevice,this._baseApis=e.baseApis,this._roomId=e.roomId}prepareToEncrypt(e){}onRoomMembership(e,t,s){}}class a{constructor(e){this._userId=e.userId,this._crypto=e.crypto,this._olmDevice=e.olmDevice,this._baseApis=e.baseApis,this._roomId=e.roomId}onRoomKeyEvent(e){}importRoomKey(e){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){}}class r extends Error{constructor(e,t,s){super(t),this.code=e,this.name="DecryptionError",this.detailedString=function(e,t){let s=e.name+"[msg: "+e.message;t&&(s+=", "+Object.keys(t).map(e=>e+": "+t[e]).join(", "));return s+="]",s}(this,s)}}class c extends Error{constructor(e,t){super(e),this.name="UnknownDeviceError",this.devices=t}}function l(e,t,s){n[e]=t,i[e]=s}},function(e,t,s){"use strict";(function(e,n){s.d(t,"a",(function(){return h})),s.d(t,"c",(function(){return p})),s.d(t,"b",(function(){return g})),s.d(t,"d",(function(){return v})),s.d(t,"e",(function(){return f}));var i=s(115),o=s.n(i),a=s(8),r=s(139),c=s(0),l=s(160),d=s(274);function u(e){return Object.values(e.keys)[0]}class h extends a.EventEmitter{constructor(e,t={},s={}){super(),this.userId=e,this.callbacks=t,this.cacheCallbacks=s,o()(this,"keys",{}),o()(this,"firstUse",!0),o()(this,"crossSigningVerifiedBefore",!1)}static fromStorage(e,t){const s=new h(t);for(const t in e)e.hasOwnProperty(t)&&(s[t]=e[t]);return s}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async getCrossSigningKey(t,s){const n=["master","self_signing","user_signing"].indexOf(t)>=0;if(!this.callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");function i(t){if(!t)return;const n=new e.Olm.PkSigning,i=n.init_with_seed(t);if(i===s)return[i,n];n.free()}let o;void 0===s&&(s=this.getId(t)),this.cacheCallbacks.getCrossSigningKeyCache&&n&&(o=await this.cacheCallbacks.getCrossSigningKeyCache(t,s));const a=i(o);if(a)return a;o=await this.callbacks.getCrossSigningKey(t,s);const r=i(o);if(r)return this.cacheCallbacks.storeCrossSigningKeyCache&&n&&await this.cacheCallbacks.storeCrossSigningKeyCache(t,o),r;if(!o)throw new Error("getCrossSigningKey callback for "+t+" returned falsey");throw new Error("Key type "+t+" from getCrossSigningKey callback did not match")}async isStoredInSecretStorage(e){const t=await e.isStored("m.cross_signing.master",!1)||{};function s(e){for(const s of Object.keys(t))e[s]||delete t[s]}for(const t of["self_signing","user_signing"])s(await e.isStored("m.cross_signing."+t,!1)||{});return Object.keys(t).length?t:null}static async storeInSecretStorage(e,t){for(const[s,n]of e){const e=Object(r.encodeBase64)(n);await t.store("m.cross_signing."+s,e)}}static async getFromSecretStorage(e,t){const s=await t.get("m.cross_signing."+e);return s?Object(r.decodeBase64)(s):null}async isStoredInKeyCache(e){const t=this.cacheCallbacks;if(!t)return!1;const s=e?[e]:["master","self_signing","user_signing"];for(const e of s)if(!await t.getCrossSigningKeyCache(e))return!1;return!0}async getCrossSigningKeysFromCache(){const e=new Map,t=this.cacheCallbacks;if(!t)return e;for(const s of["master","self_signing","user_signing"]){const n=await t.getCrossSigningKeyCache(s);n&&e.set(s,n)}return e}getId(e="master"){if(!this.keys[e])return null;return u(this.keys[e])}async resetKeys(t){if(!this.callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(void 0===t||t&m.MASTER||!this.keys.master)t=m.MASTER|m.USER_SIGNING|m.SELF_SIGNING;else if(0===t)return;const s={},n={};let i,o;try{if(t&m.MASTER?(i=new e.Olm.PkSigning,s.master=i.generate_seed(),o=i.init_with_seed(s.master),n.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+o]:o}}):[o,i]=await this.getCrossSigningKey("master"),t&m.SELF_SIGNING){const t=new e.Olm.PkSigning;try{s.self_signing=t.generate_seed();const e=t.init_with_seed(s.self_signing);n.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+e]:e}},Object(r.pkSign)(n.self_signing,i,this.userId,o)}finally{t.free()}}if(t&m.USER_SIGNING){const t=new e.Olm.PkSigning;try{s.user_signing=t.generate_seed();const e=t.init_with_seed(s.user_signing);n.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+e]:e}},Object(r.pkSign)(n.user_signing,i,this.userId,o)}finally{t.free()}}Object.assign(this.keys,n),this.callbacks.saveCrossSigningKeys(s)}finally{i&&i.free()}}clearKeys(){this.keys={}}setKeys(e){const t={};if(e.master){if(e.master.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw c.a.error(t),new Error(t)}this.keys.master?u(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}const s=u(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw c.a.error(t),new Error(t)}try{Object(r.pkVerify)(e.user_signing,s,this.userId)}catch(e){throw c.a.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw c.a.error(t),new Error(t)}try{Object(r.pkVerify)(e.self_signing,s,this.userId)}catch(e){throw c.a.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,this.keys.self_signing=null,this.keys.user_signing=null),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}async signObject(e,t){if(!this.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");const[s,n]=await this.getCrossSigningKey(t);try{return Object(r.pkSign)(e,n,this.userId,s),e}finally{n.free()}}async signUser(e){if(this.keys.user_signing)return this.signObject(e.keys.master,"user_signing");c.a.info("No user signing key: not signing user")}async signDevice(e,t){if(e!==this.userId)throw new Error(`Trying to sign ${e}'s device; can only sign our own device`);if(this.keys.self_signing)return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing");c.a.info("No self signing key: not signing device")}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new p(!0,!0,this.firstUse);if(!this.keys.user_signing)return new p(!1,!1,e.firstUse);let t;const s=e.keys.master,n=this.getId("user_signing");try{Object(r.pkVerify)(s,n,this.userId),t=!0}catch(e){t=!1}return new p(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,s,n){const i=this.checkUserTrust(e),o=e.keys.self_signing;if(!o)return new g(!1,!1,s,n);const a=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return Object(r.pkVerify)(o,e.getId(),e.userId),Object(r.pkVerify)(a,u(o),e.userId),g.fromUserTrustLevel(i,s,n)}catch(e){return new g(!1,!1,s,n)}}getCacheCallbacks(){return this.cacheCallbacks}}let m;!function(e){e[e.MASTER=4]="MASTER",e[e.USER_SIGNING=2]="USER_SIGNING",e[e.SELF_SIGNING=1]="SELF_SIGNING"}(m||(m={}));class p{constructor(e,t,s){this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=s}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class g{constructor(e,t,s,n){this.crossSigningVerified=e,this.tofu=t,this.localVerified=s,this.trustCrossSignedDevices=n}static fromUserTrustLevel(e,t,s){return new g(e.isCrossSigningVerified(),e.isTofu(),t,s)}isVerified(){return Boolean(this.isLocallyVerified()||this.trustCrossSignedDevices&&this.isCrossSigningVerified())}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}function v(e,t){return{getCrossSigningKeyCache:async function(s,i){const o=await new Promise(t=>e.doTxn("readonly",[l.a.STORE_ACCOUNT],n=>{e.getSecretStorePrivateKey(n,t,s)}));if(o&&o.ciphertext){const e=n.from(t._pickleKey),i=await Object(d.a)(o,e,s);return Object(r.decodeBase64)(i)}return o},storeCrossSigningKeyCache:async function(s,i){if(!(i instanceof Uint8Array))throw new Error("storeCrossSigningKeyCache expects Uint8Array, got "+i);const o=n.from(t._pickleKey);return i=await Object(d.b)(Object(r.encodeBase64)(i),o,s),e.doTxn("readwrite",[l.a.STORE_ACCOUNT],t=>{e.storeSecretStorePrivateKey(t,s,i)})}}}async function f(e,t,s){if(e.getUserId()===t)return c.a.log("Cross-signing: Self-verification done; requesting keys"),new Promise((t,n)=>{const i=e,o=i.crypto.crossSigningInfo,a=new h(o.userId,{getCrossSigningKey:async e=>{c.a.debug("Cross-signing: requesting secret",e,s);const{promise:t}=i.requestSecret("m.cross_signing."+e,[s]),n=await t,o=Object(r.decodeBase64)(n);return Uint8Array.from(o)}},o.getCacheCallbacks());a.keys=o.keys;const l=new Promise((e,t)=>{setTimeout(e,6e4,new Error("Timeout"))}),d=new Promise(async e=>{if(!await i.crypto.getSessionBackupPrivateKey()){c.a.info("No cached backup key found. Requesting...");const e=i.requestSecret("m.megolm_backup.v1",[s]),t=await e.promise;c.a.info("Got key backup key, decoding...");const n=Object(r.decodeBase64)(t);c.a.info("Decoded backup key, storing..."),i.crypto.storeSessionBackupPrivateKey(Uint8Array.from(n)),c.a.info("Backup key stored. Starting backup restore...");const o=await i.getKeyBackupVersion();i.restoreKeyBackupWithCache(void 0,void 0,o).then(()=>{c.a.info("Backup restored.")})}e()});return Promise.race([Promise.all([a.getCrossSigningKey("master"),a.getCrossSigningKey("self_signing"),a.getCrossSigningKey("user_signing"),d]),l]).then(t,n)}).catch(e=>{c.a.warn("Cross-signing: failure while requesting keys:",e)})}}).call(this,s(7),s(36).Buffer)},function(e,t,s){"use strict";(function(e){s.d(t,"b",(function(){return i})),s.d(t,"c",(function(){return o})),s.d(t,"a",(function(){return a}));var n=s(186);async function i(t,s){if(!e.Olm)throw new Error("Olm is not available");if(!t.private_key_salt||!t.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return await a(s,t.private_key_salt,t.private_key_iterations,t.private_key_bits||256)}async function o(t){if(!e.Olm)throw new Error("Olm is not available");const s=Object(n.b)(32);return{key:await a(t,s,5e5,256),salt:s,iterations:5e5}}async function a(t,s,n,i=256){const o=e.crypto.subtle,a=e.TextEncoder;if(!o||!a)throw new Error("Password-based backup is not avaiable on this platform");const r=await o.importKey("raw",(new a).encode(t),{name:"PBKDF2"},!1,["deriveBits"]),c=await o.deriveBits({name:"PBKDF2",salt:(new a).encode(s),iterations:n,hash:"SHA-512"},r,i);return new Uint8Array(c)}}).call(this,s(7))},function(e,t,s){"use strict";(function(e,n){s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return c}));var i=s(888),o=s.n(i);const a=[139,1];function r(t){const s=new e(a.length+t.length+1);s.set(a,0),s.set(t,a.length);let n=0;for(let e=0;e<s.length-1;++e)n^=s[e];s[s.length-1]=n;return o.a.encode(s).match(/.{1,4}/g).join(" ")}function c(e){const t=o.a.decode(e.replace(/ /g,""));let s=0;for(const e of t)s^=e;if(0!==s)throw new Error("Incorrect parity");for(let e=0;e<a.length;++e)if(t[e]!==a[e])throw new Error("Incorrect prefix");if(t.length!==a.length+n.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return Uint8Array.from(t.slice(a.length,a.length+n.Olm.PRIVATE_KEY_LENGTH))}}).call(this,s(36).Buffer,s(7))},function(e,t,s){"use strict";function n(e,t){return{msgtype:"m.text",format:"org.matrix.custom.html",body:e,formatted_body:t}}function i(e,t){return{msgtype:"m.notice",format:"org.matrix.custom.html",body:e,formatted_body:t}}function o(e,t){return{msgtype:"m.emote",format:"org.matrix.custom.html",body:e,formatted_body:t}}function a(e){return{msgtype:"m.text",body:e}}function r(e){return{msgtype:"m.notice",body:e}}function c(e){return{msgtype:"m.emote",body:e}}s.r(t),s.d(t,"makeHtmlMessage",(function(){return n})),s.d(t,"makeHtmlNotice",(function(){return i})),s.d(t,"makeHtmlEmote",(function(){return o})),s.d(t,"makeTextMessage",(function(){return a})),s.d(t,"makeNotice",(function(){return r})),s.d(t,"makeEmoteMessage",(function(){return c}))},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return h}));var n=s(115),i=s.n(n),o=s(8),a=s(260),r=s(23),c=s(897),l=s(210),d=s(114),u=s(0);class h extends a.a{static exists(e,t){return r.a.exists(e,t)}constructor(t){if(super(t),i()(this,"backend",void 0),i()(this,"startedUp",!1),i()(this,"syncTs",0),i()(this,"userModifiedMap",{}),i()(this,"emitter",new o.EventEmitter),i()(this,"on",this.emitter.on.bind(this.emitter)),i()(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),i()(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),i()(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),i()(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{u.a.log("Deleted indexeddb data.")},e=>{throw u.a.error("Failed to delete indexeddb data: "+e),e})))),i()(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();const e=[];for(const t of this.getUsers())this.userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this.userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)})),i()(this,"setSyncData",this.degradable(e=>this.backend.setSyncData(e),"setSyncData")),i()(this,"getOutOfBandMembers",this.degradable(e=>this.backend.getOutOfBandMembers(e),"getOutOfBandMembers")),i()(this,"setOutOfBandMembers",this.degradable((e,t)=>(super.setOutOfBandMembers(e,t),this.backend.setOutOfBandMembers(e,t)),"setOutOfBandMembers")),i()(this,"clearOutOfBandMembers",this.degradable(e=>(super.clearOutOfBandMembers(e),this.backend.clearOutOfBandMembers(e)),"clearOutOfBandMembers")),i()(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),i()(this,"storeClientOptions",this.degradable(e=>(super.storeClientOptions(e),this.backend.storeClientOptions(e)),"storeClientOptions")),!t.indexedDB)throw new Error("Missing required option: indexedDB");if(t.workerScript){let s=t.workerApi;s||(s=e.Worker),this.backend=new c.a(t.workerScript,t.dbName,s)}else this.backend=new r.a(t.indexedDB,t.dbName)}startup(){return this.startedUp?(u.a.log("IndexedDBStore.startup: already started"),Promise.resolve()):(u.a.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect().then(()=>(u.a.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{u.a.log("IndexedDBStore.startup: processing presence events"),e.forEach(([e,t])=>{const s=new l.a(e);t&&s.setPresenceEvent(new d.b(t)),this.userModifiedMap[s.userId]=s.getLastModifiedTime(),this.storeUser(s)})}))}wantsSave(){return Date.now()-this.syncTs>3e5}save(e=!1){return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){const s=super[t];return async(...t)=>{try{return e.call(this,...t)}catch(e){u.a.error("IndexedDBStore failure, degrading to MemoryStore",e),this.emitter.emit("degraded",e);try{u.a.log("IndexedDBStore trying to delete degraded data"),await this.backend.clearDatabase(),u.a.log("IndexedDBStore delete after degrading succeeded")}catch(e){u.a.warn("IndexedDBStore delete after degrading failed",e)}if(s)return s(...t)}}}}}).call(this,s(7))},function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return o}));var n=s(121);function i(e,t){const s=[...e.keys()],i=[...t.keys()],o=Object(n.a)(s,i);return{changed:Object(n.k)(s,i).filter(s=>e.get(s)!==t.get(s)),added:o.added,removed:o.removed}}class o extends Map{constructor(e){super(e)}getOrCreate(e,t){return this.has(e)?this.get(e):(this.set(e,t),t)}remove(e){const t=this.get(e);return this.delete(e),t}}},,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return d}));var n,i=s(91),o=s(92),a=s(95),r=s(125),c=s(93);class l{constructor(e,t,s,n){this.id=e,this.label=t,this.icon=s,this.body=n}}let d=Object(c.a)("structures.TabbedView")(n=class extends i.Component{constructor(e){super(e);let t=0;if(e.initialTabId){const s=e.tabs.findIndex(t=>t.id===e.initialTabId);s>=0&&(t=s)}this.state={activeTabIndex:t}}_getActiveTabIndex(){return this.state&&this.state.activeTabIndex?this.state.activeTabIndex:0}_setActiveTab(e){const t=this.props.tabs.indexOf(e);-1!==t?this.setState({activeTabIndex:t}):console.error("Could not find tab "+e.label+" in tabs")}_renderTabLabel(e){const t=a.getComponent("elements.AccessibleButton");let s="mx_TabbedView_tabLabel ";this.props.tabs.indexOf(e)===this._getActiveTabIndex()&&(s+="mx_TabbedView_tabLabel_active");let n=null;e.icon&&(n=i.createElement("span",{className:"mx_TabbedView_maskedIcon "+e.icon}));const r=Object(o.a)(e.label);return i.createElement(t,{className:s,key:"tab_label_"+e.label,onClick:()=>this._setActiveTab(e)},n,i.createElement("span",{className:"mx_TabbedView_tabLabel_text"},r))}_renderTabPanel(e){return i.createElement("div",{className:"mx_TabbedView_tabPanel",key:"mx_tabpanel_"+e.label},i.createElement(r.a,{className:"mx_TabbedView_tabPanelContent"},e.body))}render(){const e=this.props.tabs.map(e=>this._renderTabLabel(e)),t=this._renderTabPanel(this.props.tabs[this._getActiveTabIndex()]);return i.createElement("div",{className:"mx_TabbedView"},i.createElement("div",{className:"mx_TabbedView_tabLabels"},e),t)}})||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return a}));var n=s(91),i=s(98);const o=(e,t=null,s=!1)=>{const[o,a]=Object(n.useState)(i.b.getValue(e,t,s));return Object(n.useEffect)(()=>{const n=i.b.watchSetting(e,t,()=>{a(i.b.getValue(e,t,s))});return()=>{i.b.unwatchSetting(n)}},[e,t,s]),o},a=(e,t=null)=>{const[s,o]=Object(n.useState)(i.b.getValue(e,t));return Object(n.useEffect)(()=>{const s=i.b.watchSetting(e,t,()=>{o(i.b.getValue(e,t))});return()=>{i.b.unwatchSetting(s)}},[e,t]),s}},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(92),u=s(93);let h=Object(u.a)("views.elements.TruncatedList")((o=i=class extends l.a.Component{getChildren(e,t){return this.props.getChildren&&this.props.getChildCount?this.props.getChildren(e,t):l.a.Children.toArray(this.props.children).filter(e=>null!=e).slice(e,t)}getChildCount(){return this.props.getChildren&&this.props.getChildCount?this.props.getChildCount():l.a.Children.toArray(this.props.children).filter(e=>null!=e).length}render(){let e=null;const t=this.getChildCount();let s=t;if(this.props.truncateAt>=0){const n=t-this.props.truncateAt;n>1&&(e=this.props.createOverflowElement(n,t),s=this.props.truncateAt)}const n=this.getChildren(0,s);return l.a.createElement("div",{className:this.props.className},n,e)}},r()(i,"defaultProps",{truncateAt:2,createOverflowElement:(e,t)=>l.a.createElement("div",null,Object(d.a)("And %(count)s more...",{count:e}))}),n=o))||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return c}));var n=s(91),i=s.n(n),o=s(110),a=s(131),r=s(134);const c=e=>{var t,s,n;return null==e||null===(t=e.currentState)||void 0===t||null===(s=t.getStateEvents(o.a.RoomTopic,""))||void 0===s||null===(n=s.getContent())||void 0===n?void 0:n.topic};t.a=({room:e,children:t})=>{const[s,o]=Object(n.useState)(c(e));Object(a.a)(e.currentState,"RoomState.events",()=>{o(c(e))}),Object(n.useEffect)(()=>{o(c(e))},[e]);const l=e=>e&&Object(r.g)(e);return t?t(s,l):i.a.createElement("span",{ref:l},s)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(284),l=s(93);let d=Object(l.a)("structures.MainSplit")(n=class extends r.a.Component{constructor(...e){super(...e),o()(this,"_onResizeStart",()=>{this.props.resizeNotifier.startResizing()}),o()(this,"_onResize",()=>{this.props.resizeNotifier.notifyRightHandleResized()}),o()(this,"_onResizeStop",(e,t,s,n)=>{this.props.resizeNotifier.stopResizing(),window.localStorage.setItem("mx_rhs_size",this._loadSidePanelSize().width+n.width)})}_loadSidePanelSize(){let e=parseInt(window.localStorage.getItem("mx_rhs_size"),10);return isNaN(e)&&(e=350),{height:"100%",width:e}}render(){const e=r.a.Children.only(this.props.children),t=this.props.panel;let s;return!this.props.collapsedRhs&&t&&(s=r.a.createElement(c.Resizable,{defaultSize:this._loadSidePanelSize(),minWidth:264,maxWidth:"50%",enable:{top:!1,right:!1,bottom:!1,left:!0,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this._onResizeStart,onResize:this._onResize,onResizeStop:this._onResizeStop,className:"mx_RightPanel_ResizeWrapper",handleClasses:{left:"mx_RightPanel_ResizeHandle"}},t)),r.a.createElement("div",{className:"mx_MainSplit"},e,s)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return N}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(96),u=s(248),h=s(128),m=s(126),p=s(249),g=s(105),v=s(103),f=s(414),b=s(601),y=s(93),_=s(98),E=s(611),S=s(613),w=s(614),C=s(615),k=s(616),O=s(665),R=s(666),I=s(667),x=s(348);function T(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function j(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?T(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):T(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let N=Object(y.a)("structures.RightPanel")((o=i=class extends l.a.Component{constructor(e,t){super(e,t),r()(this,"delayedUpdate",void 0),r()(this,"dispatcherRef",void 0),r()(this,"onGroupStoreUpdated",()=>{this.setState({isUserPrivilegedInGroup:h.a.isUserPrivileged(this.props.groupId)})}),r()(this,"onRoomStateMember",(e,t,s)=>{this.props.room&&s.roomId===this.props.room.roomId&&(this.state.phase===m.c.RoomMemberList&&s.roomId===this.props.room.roomId||this.state.phase===m.c.RoomMemberInfo&&s.roomId===this.props.room.roomId&&s.userId===this.state.member.userId)&&this.delayedUpdate()}),r()(this,"onAction",e=>{e.action===v.a.AfterRightPanelPhaseChange&&this.setState({phase:e.phase,groupRoomId:e.groupRoomId,groupId:e.groupId,member:e.member,event:e.event,verificationRequest:e.verificationRequest,verificationRequestPromise:e.verificationRequestPromise,widgetId:e.widgetId,space:e.space})}),r()(this,"onClose",()=>{this.props.user?d.a.dispatch({action:"view_home_page"}):this.state.phase===m.c.EncryptionPanel&&this.state.verificationRequest&&this.state.verificationRequest.pending?this.state.verificationRequest.cancel():d.a.dispatch({action:v.a.ToggleRightPanel,type:this.props.groupId?"group":"room"})}),this.state=j(j({},p.a.getSharedInstance().roomPanelPhaseParams),{},{phase:this.getPhaseFromProps(),isUserPrivilegedInGroup:null,member:this.getUserForPanel()}),this.delayedUpdate=new u.a(()=>{this.forceUpdate()},500)}getUserForPanel(){if(this.state&&this.state.member)return this.state.member;const e=p.a.getSharedInstance().roomPanelPhaseParams;return this.props.user||e.member}getPhaseFromProps(){var e;const t=p.a.getSharedInstance(),s=this.getUserForPanel();return this.props.groupId?m.a.includes(t.groupPanelPhase)?t.groupPanelPhase:(d.a.dispatch({action:v.a.SetRightPanelPhase,phase:m.c.GroupMemberList}),m.c.GroupMemberList):_.b.getValue("feature_spaces")&&null!==(e=this.props.room)&&void 0!==e&&e.isSpaceRoom()&&!m.b.includes(t.roomPanelPhase)?m.c.SpaceMemberList:s?t.roomPanelPhaseParams.member&&s.userId===t.roomPanelPhaseParams.member.userId&&t.roomPanelPhaseParams.verificationRequest?t.roomPanelPhase:m.c.RoomMemberInfo:t.roomPanelPhase}componentDidMount(){this.dispatcherRef=d.a.register(this.onAction);this.context.on("RoomState.members",this.onRoomStateMember),this.initGroupStore(this.props.groupId)}componentWillUnmount(){d.a.unregister(this.dispatcherRef),this.context&&this.context.removeListener("RoomState.members",this.onRoomStateMember),this.unregisterGroupStore()}UNSAFE_componentWillReceiveProps(e){e.groupId!==this.props.groupId&&(this.unregisterGroupStore(),this.initGroupStore(e.groupId))}initGroupStore(e){e&&h.a.registerListener(e,this.onGroupStoreUpdated)}unregisterGroupStore(){h.a.unregisterListener(this.onGroupStoreUpdated)}render(){let e=l.a.createElement("div",null);const t=this.props.room?this.props.room.roomId:void 0;switch(this.state.phase){case m.c.RoomMemberList:t&&(e=l.a.createElement(E.a,{roomId:t,key:t,onClose:this.onClose}));break;case m.c.SpaceMemberList:e=l.a.createElement(E.a,{roomId:this.state.space?this.state.space.roomId:t,key:this.state.space?this.state.space.roomId:t,onClose:this.onClose});break;case m.c.GroupMemberList:this.props.groupId&&(e=l.a.createElement(S.a,{groupId:this.props.groupId,key:this.props.groupId}));break;case m.c.GroupRoomList:e=l.a.createElement(w.a,{groupId:this.props.groupId,key:this.props.groupId});break;case m.c.RoomMemberInfo:case m.c.SpaceMemberInfo:case m.c.EncryptionPanel:e=l.a.createElement(k.a,{user:this.state.member,room:this.state.phase===m.c.SpaceMemberInfo?this.state.space:this.props.room,key:t||this.state.member.userId,onClose:this.onClose,phase:this.state.phase,verificationRequest:this.state.verificationRequest,verificationRequestPromise:this.state.verificationRequestPromise});break;case m.c.Room3pidMemberInfo:case m.c.Space3pidMemberInfo:e=l.a.createElement(O.a,{event:this.state.event,key:t});break;case m.c.GroupMemberInfo:e=l.a.createElement(k.a,{user:this.state.member,groupId:this.props.groupId,key:this.state.member.userId,phase:this.state.phase,onClose:this.onClose});break;case m.c.GroupRoomInfo:e=l.a.createElement(C.a,{groupRoomId:this.state.groupRoomId,groupId:this.props.groupId,key:this.state.groupRoomId});break;case m.c.NotificationPanel:e=l.a.createElement(I.a,{onClose:this.onClose});break;case m.c.PinnedMessages:_.b.getValue("feature_pinning")&&(e=l.a.createElement(x.b,{room:this.props.room,onClose:this.onClose}));break;case m.c.FilePanel:e=l.a.createElement(R.a,{roomId:t,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose});break;case m.c.RoomSummary:e=l.a.createElement(f.a,{room:this.props.room,onClose:this.onClose});break;case m.c.Widget:e=l.a.createElement(b.a,{room:this.props.room,widgetId:this.state.widgetId,onClose:this.onClose})}return l.a.createElement("aside",{className:"mx_RightPanel dark-panel",id:"mx_RightPanel"},e)}},r()(i,"contextType",g.a),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return w})),s.d(t,"b",(function(){return C}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(147),u=s.n(d),h=s(97),m=s.n(h),p=s(117),g=s(479),v=s.n(g),f=s(96),b=s(105),y=s(94),_=s(1),E=s(93);function S(e){return document.getElementById(e)}let w=Object(E.a)("views.elements.PersistedElement")((o=i=class e extends l.a.Component{constructor(){super(),r()(this,"updateChildPosition",Object(p.throttle)((e,t)=>{if(!e||!t)return;const s=t.getBoundingClientRect();Object.assign(e.style,{zIndex:Object(_.t)(this.props.zIndex)?9:this.props.zIndex,position:"absolute",top:s.top+"px",left:s.left+"px",width:s.width+"px",height:s.height+"px"})},100,{trailing:!0,leading:!0})),this.collectChildContainer=this.collectChildContainer.bind(this),this.collectChild=this.collectChild.bind(this),this._repositionChild=this._repositionChild.bind(this),this._onAction=this._onAction.bind(this),this.resizeObserver=new v.a(this._repositionChild),window.addEventListener("resize",this._repositionChild),this._dispatcherRef=f.a.register(this._onAction)}static destroyElement(e){const t=S("mx_persistedElement_"+e);t&&t.remove()}static isMounted(e){return Boolean(S("mx_persistedElement_"+e))}collectChildContainer(e){this.childContainer&&this.resizeObserver.unobserve(this.childContainer),this.childContainer=e,e&&this.resizeObserver.observe(e)}collectChild(e){this.child=e,this.updateChild()}componentDidMount(){this.updateChild(),this.renderApp()}componentDidUpdate(){this.updateChild(),this.renderApp()}componentWillUnmount(){this.updateChildVisibility(this.child,!1),this.resizeObserver.disconnect(),window.removeEventListener("resize",this._repositionChild),f.a.unregister(this._dispatcherRef)}_onAction(t){"timeline_resize"===t.action?this._repositionChild():"logout"===t.action&&e.destroyElement(this.props.persistKey)}_repositionChild(){this.updateChildPosition(this.child,this.childContainer)}updateChild(){this.updateChildPosition(this.child,this.childContainer),this.updateChildVisibility(this.child,!0)}renderApp(){const e=l.a.createElement(b.a.Provider,{value:y.a.get()},l.a.createElement("div",{ref:this.collectChild,style:this.props.style},this.props.children));u.a.render(e,function(e){let t=S(e);return t||(t=document.createElement("div"),t.id=e,document.body.appendChild(t)),t}("mx_persistedElement_"+this.props.persistKey))}updateChildVisibility(e,t){e&&(e.style.display=t?"block":"none")}render(){return l.a.createElement("div",{ref:this.collectChildContainer})}},r()(i,"propTypes",{persistKey:m.a.string.isRequired,zIndex:m.a.number}),n=o))||n;const C=e=>"widget_"+e},function(e,t,s){"use strict";var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(101),d=s.n(l),u=s(95);t.a=e=>{let{checked:t,disabled:s=!1,onChange:n}=e,o=a()(e,["checked","disabled","onChange"]);const r=d()({mx_ToggleSwitch:!0,mx_ToggleSwitch_on:t,mx_ToggleSwitch_enabled:!s}),l=u.getComponent("elements.AccessibleButton");return c.a.createElement(l,i()({},o,{className:r,onClick:()=>{s||n(!t)},role:"switch","aria-checked":t,"aria-disabled":s}),c.a.createElement("div",{className:"mx_ToggleSwitch_ball"}))}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return u}));var n=s(18),i=s.n(n),o=s(98),a=s(96),r=s(103),c=s(421),l=s(252),d=s(106);class u{constructor(){i()(this,"themeWatchRef",void 0),i()(this,"systemThemeWatchRef",void 0),i()(this,"dispatcherRef",void 0),i()(this,"preferDark",void 0),i()(this,"preferLight",void 0),i()(this,"currentTheme",void 0),i()(this,"onChange",()=>{this.recheck()}),i()(this,"onAction",e=>{e.action===r.a.RecheckTheme&&this.recheck(e.forceTheme)}),this.themeWatchRef=null,this.systemThemeWatchRef=null,this.dispatcherRef=null,this.preferDark=e.matchMedia("(prefers-color-scheme: dark)"),this.preferLight=e.matchMedia("(prefers-color-scheme: light)"),this.currentTheme=this.getEffectiveTheme()}start(){this.themeWatchRef=o.b.watchSetting("theme",null,this.onChange),this.systemThemeWatchRef=o.b.watchSetting("use_system_theme",null,this.onChange),this.preferDark.addEventListener&&(this.preferDark.addEventListener("change",this.onChange),this.preferLight.addEventListener("change",this.onChange)),this.dispatcherRef=a.a.register(this.onAction)}stop(){this.preferDark.addEventListener&&(this.preferDark.removeEventListener("change",this.onChange),this.preferLight.removeEventListener("change",this.onChange)),o.b.unwatchSetting(this.systemThemeWatchRef),o.b.unwatchSetting(this.themeWatchRef),a.a.unregister(this.dispatcherRef)}recheck(e){const t=this.currentTheme;this.currentTheme=void 0===e?this.getEffectiveTheme():e,t!==this.currentTheme&&Object(l.d)(this.currentTheme)}getEffectiveTheme(){if(c.a.isLogin)return"light";if(o.b.getValueAt(d.a.DEVICE,"use_system_theme",null,!1,!0)){if(console.log("returning explicit system theme"),this.preferDark.matches)return"dark";if(this.preferLight.matches)return"light"}const e=o.b.getValueAt(d.a.DEVICE,"theme",null,!1,!0);if(e)return console.log("returning explicit theme: "+e),e;if(o.b.getValue("use_system_theme")){if(this.preferDark.matches)return"dark";if(this.preferLight.matches)return"light"}return console.log("returning theme value"),o.b.getValue("theme")}isSystemThemeSupported(){return this.preferDark.matches||this.preferLight.matches}}}).call(this,s(7))},function(e,t,s){"use strict";(function(e){class s{constructor(){this.keyRgb=["rgb(118, 207, 166)","rgb(234, 245, 240)","rgb(211, 239, 225)"],this.keyHex=["#76CFA6","#EAF5F0","#D3EFE1","#FFFFFF","#000000"],this.colors=[this.keyHex[0],this.keyHex[1],this.keyHex[2],this.keyHex[3],this.keyHex[4]],this.currentTint=[void 0,void 0,void 0,void 0,void 0],this.cssFixups=[],this.cssAttrs=["color","backgroundColor","borderColor","borderTopColor","borderBottomColor","borderLeftColor"],this.svgAttrs=["fill","stroke"],this.tintables=[],this.theme=void 0,this.forceTint=!1}registerTintable(e){this.tintables.push(e),e()}getKeyRgb(){return this.keyRgb}tint(e,t,s){}tintSvgWhite(e){this.currentTint[3]=e,e||(e=this.colors[3]),this.colors[3]!==e&&(this.colors[3]=e,this.tintables.forEach((function(e){e()})))}tintSvgBlack(e){this.currentTint[4]=e,e||(e=this.colors[4]),this.colors[4]!==e&&(this.colors[4]=e,this.tintables.forEach((function(e){e()})))}setTheme(e){this.theme=e,document.getElementById("mx_theme_accentColor")&&(this.keyRgb[0]=window.getComputedStyle(document.getElementById("mx_theme_accentColor")).color),document.getElementById("mx_theme_secondaryAccentColor")&&(this.keyRgb[1]=window.getComputedStyle(document.getElementById("mx_theme_secondaryAccentColor")).color),document.getElementById("mx_theme_tertiaryAccentColor")&&(this.keyRgb[2]=window.getComputedStyle(document.getElementById("mx_theme_tertiaryAccentColor")).color),this.calcCssFixups(),this.forceTint=!0,this.tint(this.currentTint[0],this.currentTint[1],this.currentTint[2]),"dark"===e?(this.tintSvgWhite("#2d2d2d"),this.tintSvgBlack("#dddddd")):(this.tintSvgWhite("#ffffff"),this.tintSvgBlack("#000000"))}calcCssFixups(){if(!this.cssFixups[this.theme]){0,this.cssFixups[this.theme]=[];for(let e=0;e<document.styleSheets.length;e++){const t=document.styleSheets[e];try{if(!t)continue;if(!t.href||!t.href.match(new RegExp("/theme-"+this.theme+".css$")))continue;if(t.disabled)continue;if(!t.cssRules)continue;0;for(let e=0;e<t.cssRules.length;e++){const s=t.cssRules[e];if(s.style&&(!s.selectorText||!s.selectorText.match(/#mx_theme/)))for(let e=0;e<this.cssAttrs.length;e++){const t=this.cssAttrs[e];for(let e=0;e<this.keyRgb.length;e++)s.style[t]===this.keyRgb[e]&&this.cssFixups[this.theme].push({style:s.style,attr:t,index:e})}}}catch(e){console.log("Failed to calculate CSS fixups for a stylesheet: "+t.href,e)}}0}}applyCssFixups(){for(let e=0;e<this.cssFixups[this.theme].length;e++){const t=this.cssFixups[this.theme][e];try{t.style[t.attr]=this.colors[t.index]}catch(e){console.error("Failed to apply cssFixup in Tinter! ",e.name)}}}calcSvgFixups(e){const t=[];for(let s=0;s<e.length;s++){let n;try{n=e[s].contentDocument}catch(t){let n="Failed to get svg.contentDocument of "+e[s].toString();t.message&&(n+=t.message),t.stack&&(n+=" | stack: "+t.stack),console.error(n)}if(!n)continue;const i=n.getElementsByTagName("*");for(let e=0;e<i.length;e++){const s=i[e];for(let e=0;e<this.svgAttrs.length;e++){const n=this.svgAttrs[e];for(let e=0;e<this.keyHex.length;e++)s.getAttribute(n)&&s.getAttribute(n).toUpperCase()===this.keyHex[e]&&t.push({node:s,attr:n,index:e})}}}return t}applySvgFixups(e){for(let t=0;t<e.length;t++){const s=e[t];s.node.setAttribute(s.attr,this.colors[s.index])}}}void 0===e.singletonTinter&&(e.singletonTinter=new s),t.a=e.singletonTinter}).call(this,s(7))},function(e,t){e.exports="img/cancel.4b9715b.svg"},function(e,t,s){"use strict";s.d(t,"g",(function(){return h})),s.d(t,"a",(function(){return m})),s.d(t,"f",(function(){return p})),s.d(t,"e",(function(){return g})),s.d(t,"c",(function(){return b})),s.d(t,"d",(function(){return y})),s.d(t,"b",(function(){return _}));var n=s(555),i=s(132),o=s(319),a=s(160);const r=window.localStorage;let c;try{c=window.indexedDB}catch(e){}function l(e){console.log("StorageManager: "+e)}function d(e,...t){console.error("StorageManager: "+e,...t)}function u(e){i.a.trackEvent("StorageManager",e)}function h(){navigator.storage&&navigator.storage.persist?navigator.storage.persist().then(e=>{console.log("StorageManager: Persistent?",e)}):document.requestStorageAccess?document.requestStorageAccess().then(()=>console.log("StorageManager: Persistent?",!0),()=>console.log("StorageManager: Persistent?",!1)):console.log("StorageManager: Persistence unsupported")}async function m(){l("Checking storage consistency"),l("Local storage supported? "+!!r),l("IndexedDB supported? "+!!c);let e=!1,t=!1,s=!1,i=!0;if(r?(e=r.length>0,l("Local storage contains data? "+e),s=!!r.getItem("mx_crypto_initialised"),l("Crypto initialised? "+s)):(i=!1,d("Local storage cannot be used on this browser"),u("Local storage disabled")),c&&r){(await async function(){let e=!1;try{return e=await o.a.exists(c,"riot-web-sync"),l("Sync store using IndexedDB contains data? "+e),{exists:e,healthy:!0}}catch(e){d("Sync store using IndexedDB inaccessible",e),u("Sync store using IndexedDB inaccessible")}return l("Sync store using memory only"),{exists:e,healthy:!1}}()).healthy||(i=!1)}else i=!1,d("Sync store cannot be used on this browser"),u("Sync store disabled");if(c){const e=await async function(){let e=!1;try{return e=await a.a.exists(c,"matrix-js-sdk:crypto"),l("Crypto store using IndexedDB contains data? "+e),{exists:e,healthy:!0}}catch(e){d("Crypto store using IndexedDB inaccessible",e),u("Crypto store using IndexedDB inaccessible")}try{return e=await n.a.exists(r),l("Crypto store using local storage contains data? "+e),{exists:e,healthy:!0}}catch(e){d("Crypto store using local storage inaccessible",e),u("Crypto store using local storage inaccessible")}return l("Crypto store using memory only"),{exists:e,healthy:!1}}();t=e.exists,e.healthy||(i=!1)}else i=!1,d("Crypto store cannot be used on this browser"),u("Crypto store disabled");return e&&s&&!t&&(i=!1,d("Data exists in local storage and crypto is marked as initialised  but no data found in crypto store. IndexedDB storage has likely been evicted by the browser!"),u("Crypto store evicted")),i?(l("Storage consistency checks passed"),u("Consistency checks passed")):(d("Storage consistency checks failed"),u("Consistency checks failed")),{dataInLocalStorage:e,dataInCryptoStore:t,cryptoInited:s,healthy:i}}function p(e){e.store&&e.store.on&&e.store.on("degraded",()=>{u("Sync store using IndexedDB degraded to memory")})}function g(e){r.setItem("mx_crypto_initialised",e)}let v=null;async function f(){if(!c)throw new Error("IndexedDB not available");v=await new Promise((e,t)=>{const s=c.open("matrix-react-sdk",1);s.onerror=t,s.onsuccess=t=>{e(s.result)},s.onupgradeneeded=e=>{const t=s.result;t.createObjectStore("pickleKey"),t.createObjectStore("account")}})}async function b(e,t){return v||await f(),new Promise((s,n)=>{const i=v.transaction([e],"readonly");i.onerror=n;const o=i.objectStore(e).get(t);o.onerror=n,o.onsuccess=e=>{s(o.result)}})}async function y(e,t,s){return v||await f(),new Promise((n,i)=>{const o=v.transaction([e],"readwrite");o.onerror=i;const a=o.objectStore(e).put(s,t);a.onerror=i,a.onsuccess=e=>{n()}})}async function _(e,t){return v||await f(),new Promise((s,n)=>{const i=v.transaction([e],"readwrite");i.onerror=n;const o=i.objectStore(e).delete(t);o.onerror=n,o.onsuccess=e=>{s()}})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(91);const i=(e=!1)=>{const[t,s]=Object(n.useState)(e);return[t,()=>{s(!t)},s]}},function(e,t,s){"use strict";s.d(t,"c",(function(){return y})),s.d(t,"a",(function(){return _})),s.d(t,"b",(function(){return E})),s.d(t,"d",(function(){return S}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(94),d=s(95),u=s(173),h=s(99),m=s(143),p=s(291),g=s(106),v=s(98),f=s(116),b=s(93);let y,_,E;!function(e){e.Public="public",e.Knock="knock",e.Invite="invite",e.Private="private"}(y||(y={})),function(e){e.CanJoin="can_join",e.Forbidden="forbidden"}(_||(_={})),function(e){e.Invited="invited",e.Joined="joined",e.Shared="shared",e.WorldReadable="world_readable"}(E||(E={}));let S=Object(b.a)("views.settings.tabs.room.SecurityRoomSettingsTab")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"onStateEvent",e=>{["m.room.join_rules","m.room.guest_access","m.room.history_visibility","m.room.encryption"].includes(e.getType())&&this.forceUpdate()}),o()(this,"onEncryptionChange",()=>{h.a.createTrackedDialog("Enable encryption","",m.a,{title:Object(c.a)("Enable encryption?"),description:Object(c.a)("Once enabled, encryption for a room cannot be disabled. Messages sent in an encrypted room cannot be seen by the server, only by the participants of the room. Enabling encryption may prevent many bots and bridges from working correctly. <a>Learn more about encryption.</a>",{},{a:e=>r.a.createElement("a",{href:"https://element.io/help#encryption",rel:"noreferrer noopener",target:"_blank"},e)}),onFinished:e=>{if(!e)return void this.setState({encrypted:!1});const t=this.state.encrypted;this.setState({encrypted:!0}),l.a.get().sendStateEvent(this.props.roomId,"m.room.encryption",{algorithm:"m.megolm.v1.aes-sha2"}).catch(e=>{console.error(e),this.setState({encrypted:t})})}})}),o()(this,"fixGuestAccess",e=>{e.preventDefault(),e.stopPropagation();const t=y.Invite,s=_.CanJoin,n=this.state.joinRule,i=this.state.guestAccess;this.setState({joinRule:t,guestAccess:s});const o=l.a.get();o.sendStateEvent(this.props.roomId,"m.room.join_rules",{join_rule:t},"").catch(e=>{console.error(e),this.setState({joinRule:n})}),o.sendStateEvent(this.props.roomId,"m.room.guest_access",{guest_access:s},"").catch(e=>{console.error(e),this.setState({guestAccess:i})})}),o()(this,"onRoomAccessRadioToggle",e=>{let t=y.Invite,s=_.CanJoin;switch(e){case"invite_only":break;case"public_no_guests":t=y.Public,s=_.Forbidden;break;case"public_with_guests":t=y.Public,s=_.CanJoin}const n=this.state.joinRule,i=this.state.guestAccess;this.setState({joinRule:t,guestAccess:s});const o=l.a.get();o.sendStateEvent(this.props.roomId,"m.room.join_rules",{join_rule:t},"").catch(e=>{console.error(e),this.setState({joinRule:n})}),o.sendStateEvent(this.props.roomId,"m.room.guest_access",{guest_access:s},"").catch(e=>{console.error(e),this.setState({guestAccess:i})})}),o()(this,"onHistoryRadioToggle",e=>{const t=this.state.history;this.setState({history:e}),l.a.get().sendStateEvent(this.props.roomId,"m.room.history_visibility",{history_visibility:e},"").catch(e=>{console.error(e),this.setState({history:t})})}),o()(this,"updateBlacklistDevicesFlag",e=>{l.a.get().getRoom(this.props.roomId).setBlacklistUnverifiedDevices(e)}),this.state={joinRule:y.Invite,guestAccess:_.CanJoin,history:E.Shared,hasAliases:!1,encrypted:!1}}async UNSAFE_componentWillMount(){l.a.get().on("RoomState.events",this.onStateEvent);const e=l.a.get().getRoom(this.props.roomId).currentState,t=this.pullContentPropertyFromEvent(e.getStateEvents("m.room.join_rules",""),"join_rule",y.Invite),s=this.pullContentPropertyFromEvent(e.getStateEvents("m.room.guest_access",""),"guest_access",_.Forbidden),n=this.pullContentPropertyFromEvent(e.getStateEvents("m.room.history_visibility",""),"history_visibility",E.Shared),i=l.a.get().isRoomEncrypted(this.props.roomId);this.setState({joinRule:t,guestAccess:s,history:n,encrypted:i});const o=await this.hasAliases();this.setState({hasAliases:o})}pullContentPropertyFromEvent(e,t,s){return e&&e.getContent()&&e.getContent()[t]||s}componentWillUnmount(){l.a.get().removeListener("RoomState.events",this.onStateEvent)}async hasAliases(){const e=l.a.get();if(await e.doesServerSupportUnstableFeature("org.matrix.msc2432")){const t=(await e.unstableGetLocalAliases(this.props.roomId)).aliases;return Array.isArray(t)&&0!==t.length}return!!(e.getRoom(this.props.roomId).currentState.getStateEvents("m.room.aliases")||[]).find(e=>(e.getContent().aliases||[]).length>0)}renderRoomAccess(){const e=l.a.get(),t=e.getRoom(this.props.roomId),n=this.state.joinRule,i=this.state.guestAccess,o=t.currentState.mayClientSendStateEvent("m.room.join_rules",e)&&t.currentState.mayClientSendStateEvent("m.room.guest_access",e);let a=null;"public"!==n&&"forbidden"===i&&(a=r.a.createElement("div",{className:"mx_SecurityRoomSettingsTab_warning"},r.a.createElement("img",{src:s(224),width:15,height:15}),r.a.createElement("span",null,Object(c.a)("Guests cannot join this room even if explicitly invited.")," ",r.a.createElement("a",{href:"",onClick:this.fixGuestAccess},Object(c.a)("Click here to fix")))));let d=null;return"public"!==n||this.state.hasAliases||(d=r.a.createElement("div",{className:"mx_SecurityRoomSettingsTab_warning"},r.a.createElement("img",{src:s(224),width:15,height:15}),r.a.createElement("span",null,Object(c.a)("To link to this room, please add an address.")))),r.a.createElement("div",null,a,d,r.a.createElement(p.a,{name:"roomVis",value:n,onChange:this.onRoomAccessRadioToggle,definitions:[{value:"invite_only",disabled:!o,label:Object(c.a)("Only people who have been invited"),checked:"public"!==n},{value:"public_no_guests",disabled:!o,label:Object(c.a)("Anyone who knows the room's link, apart from guests"),checked:"public"===n&&"can_join"!==i},{value:"public_with_guests",disabled:!o,label:Object(c.a)("Anyone who knows the room's link, including guests"),checked:"public"===n&&"can_join"===i}]}))}renderHistory(){const e=l.a.get(),t=this.state.history,s=e.getRoom(this.props.roomId).currentState.mayClientSendStateEvent("m.room.history_visibility",e);return r.a.createElement("div",null,r.a.createElement("div",null,Object(c.a)("Changes to who can read history will only apply to future messages in this room. The visibility of existing history will be unchanged.")),r.a.createElement(p.a,{name:"historyVis",value:t,onChange:this.onHistoryRadioToggle,definitions:[{value:E.WorldReadable,disabled:!s,label:Object(c.a)("Anyone")},{value:E.Shared,disabled:!s,label:Object(c.a)("Members only (since the point in time of selecting this option)")},{value:E.Invited,disabled:!s,label:Object(c.a)("Members only (since they were invited)")},{value:E.Joined,disabled:!s,label:Object(c.a)("Members only (since they joined)")}]}))}render(){const e=d.getComponent("elements.SettingsFlag"),t=l.a.get(),s=t.getRoom(this.props.roomId),n=this.state.encrypted,i=s.currentState.mayClientSendStateEvent("m.room.encryption",t),o=!n&&i;let a=null;n&&v.b.isEnabled("blacklistUnverifiedDevices")&&(a=r.a.createElement(e,{name:"blacklistUnverifiedDevices",level:g.a.ROOM_DEVICE,onChange:this.updateBlacklistDevicesFlag,roomId:this.props.roomId}));let h=r.a.createElement(r.a.Fragment,null,r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Who can read history?")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},this.renderHistory()));return v.b.getValue(f.a.RoomHistorySettings)||(h=null),r.a.createElement("div",{className:"mx_SettingsTab mx_SecurityRoomSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Security & Privacy")),r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Encryption")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SecurityRoomSettingsTab_encryptionSection"},r.a.createElement("div",null,r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},r.a.createElement("span",null,Object(c.a)("Once enabled, encryption cannot be disabled."))),r.a.createElement(u.a,{value:n,onChange:this.onEncryptionChange,label:Object(c.a)("Encrypted"),disabled:!o})),a),r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Who can access this room?")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},this.renderRoomAccess()),h)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(163),d=s(94),u=s(93),h=s(112);let m=Object(u.a)("views.elements.RoomAliasField")(n=class extends r.a.PureComponent{constructor(e,t){super(e,t),o()(this,"fieldRef",Object(a.createRef)()),o()(this,"onChange",e=>{this.props.onChange&&this.props.onChange(this.asFullAlias(e.target.value))}),o()(this,"onValidate",async e=>{const t=await this.validationRules(e);return this.setState({isValid:t.valid}),t}),o()(this,"validationRules",Object(l.a)({rules:[{key:"safeLocalpart",test:async({value:e})=>{if(!e)return!0;const t=this.asFullAlias(e);return!e.includes("#")&&!e.includes(":")&&!e.includes(",")&&encodeURI(t)===t},invalid:()=>Object(c.a)("Some characters not allowed")},{key:"required",test:async({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Please provide an address")},{key:"taken",final:!0,test:async({value:e})=>{if(!e)return!0;const t=d.a.get();try{return await t.getRoomIdForAlias(this.asFullAlias(e)),!1}catch(e){return!!e.errcode}},valid:()=>Object(c.a)("This address is available to use"),invalid:()=>Object(c.a)("This address is already in use")}]})),this.state={isValid:!0}}asFullAlias(e){return`#${e}:${this.props.domain}`}render(){const e=r.a.createElement("span",null,"#"),t=":"+this.props.domain,s=r.a.createElement("span",{title:t},t),n=255-this.props.domain.length-2;return r.a.createElement(h.a,{label:this.props.label||Object(c.a)("Room address"),className:"mx_RoomAliasField",prefixComponent:e,postfixComponent:s,ref:this.fieldRef,onValidate:this.onValidate,placeholder:this.props.placeholder||Object(c.a)("e.g. my-room"),onChange:this.onChange,value:this.props.value.substring(1,this.props.value.length-this.props.domain.length-1),maxLength:n})}get isValid(){return this.state.isValid}validate(e){var t;return null===(t=this.fieldRef.current)||void 0===t?void 0:t.validate(e)}focus(){var e;null===(e=this.fieldRef.current)||void 0===e||e.focus()}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(18),i=s.n(n),o=s(696),a=s(697);class r{static createItem(e,t,s){return new o.a(e,t,s)}static createSizer(e,t,s){return new a.a(e,t,s)}constructor(e){this.item=e,i()(this,"beforeOffset",void 0),this.beforeOffset=e.offset()}get size(){return this.item.getSize()}set size(e){this.item.setRawSize(e)}resize(e){this.item.setSize(e)}resizeFromContainerOffset(e){this.resize(e-this.beforeOffset)}start(){this.item.start()}finish(){this.item.finish()}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(18),i=s.n(n),o=s(232);class a extends o.a{static set matrixClient(e){const t=a._matrixClient;a._matrixClient=e;for(const s of a.instances)s.initMatrixClient(t,e)}constructor(){super(),a.instances.push(this)}get client(){return a._matrixClient}initMatrixClient(e,t){console.warn("initMatrixClient not overridden")}}i()(a,"_matrixClient",void 0),i()(a,"instances",[])},,,,,function(e,t,s){"use strict";s.d(t,"c",(function(){return g})),s.d(t,"a",(function(){return v})),s.d(t,"d",(function(){return f}));var n=s(91),i=s.n(n),o=s(114),a=s(110),r=s(92),c=s(204),l=s(119),d=s(105),u=s(131);var h=s(408),m=s(588);const p=e=>e,g=e=>{const[t,s]=Object(n.useState)([]),i=Object(n.useCallback)(t=>{var n,i;e&&(t&&t.getType()!==a.a.RoomPinnedEvents||s((null===(n=e.currentState.getStateEvents(a.a.RoomPinnedEvents,""))||void 0===n||null===(i=n.getContent())||void 0===i?void 0:i.pinned)||[]))},[e]);return Object(u.a)(null==e?void 0:e.currentState,"RoomState.events",i),Object(n.useEffect)(()=>(i(),()=>{s([])}),[i]),t},v="im.vector.room.read_pins",f=e=>{const[t,s]=Object(n.useState)(new Set),i=Object(n.useCallback)(t=>{var n,i;if(!e)return;if(t&&t.getType()!==v)return;const o=null===(n=e.getAccountData(v))||void 0===n||null===(i=n.getContent())||void 0===i?void 0:i.event_ids;s(new Set(o||[]))},[e]);return Object(u.a)(e,"Room.accountData",i),Object(n.useEffect)(()=>(i(),()=>{s(new Set)}),[i]),t};t.b=({room:e,onClose:t})=>{const s=Object(n.useContext)(d.a),b=((e,t=p)=>{const[s,i]=Object(n.useState)(e?t(e.currentState):void 0),o=Object(n.useCallback)(()=>{e&&i(t(e.currentState))},[e,t]);return Object(u.a)(null==e?void 0:e.currentState,"RoomState.events",o),Object(n.useEffect)(()=>(o(),()=>{i(void 0)}),[o]),s})(e,e=>e.mayClientSendStateEvent(a.a.RoomPinnedEvents,s)),y=g(e),_=f(e);Object(n.useEffect)(()=>{y.filter(e=>!_.has(e)).length>0&&s.setRoomAccountData(e.roomId,v,{event_ids:y})},[s,e.roomId,y,_]);const E=Object(h.a)(()=>{const t=y.map(async t=>{var n;const i=e.getUnfilteredTimelineSet(),a=null==i||null===(n=i.getTimelineForEvent(t))||void 0===n?void 0:n.getEvents().find(e=>e.getId()===t);if(a)return a;try{const n=await s.fetchRoomEvent(e.roomId,t),i=new o.b(n);if(i.isEncrypted()&&await s.decryptEventIfNeeded(i),i&&class{static isPinnable(e){return!!e&&("m.room.message"===e.getType()&&!e.isRedacted())}}.isPinnable(i))return i}catch(s){console.error("Error looking up pinned event "+t+" in room "+e.roomId),console.error(s)}return null});return Promise.all(t)},[s,e,y],null);let S;if(E)if(E.length>0){let t;b&&(t=async t=>{var n;const i=e.currentState.getStateEvents(a.a.RoomPinnedEvents,"");if(null!=i&&null!==(n=i.getContent())&&void 0!==n&&n.pinned){const n=i.getContent().pinned,o=n.indexOf(t.getId());-1!==o&&(n.splice(o,1),await s.sendStateEvent(e.roomId,a.a.RoomPinnedEvents,{pinned:n},""))}}),S=E.filter(Boolean).reverse().map(s=>i.a.createElement(m.a,{key:s.getId(),room:e,event:s,onUnpinClicked:()=>t(s)}))}else S=i.a.createElement("div",{className:"mx_PinnedMessagesCard_empty"},i.a.createElement("div",null,i.a.createElement("div",{className:"mx_PinnedMessagesCard_MessageActionBar"},i.a.createElement("div",{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_reactButton"}),i.a.createElement("div",{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_replyButton"}),i.a.createElement("div",{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_optionsButton"})),i.a.createElement("h2",null,Object(r.a)("Nothing pinned, yet")),Object(r.a)("If you have permissions, open the menu on any message and select <b>Pin</b> to stick them here.",{},{b:e=>i.a.createElement("b",null,e)})));else S=i.a.createElement(l.a,null);return i.a.createElement(c.b,{header:i.a.createElement("h2",null,Object(r.a)("Pinned messages")),className:"mx_PinnedMessagesCard",onClose:t},S)}},function(e,t,s){"use strict";s.d(t,"e",(function(){return h})),s.d(t,"d",(function(){return m})),s.d(t,"g",(function(){return p})),s.d(t,"c",(function(){return g})),s.d(t,"f",(function(){return v})),s.d(t,"a",(function(){return f})),s.d(t,"b",(function(){return y}));var n=s(18),i=s.n(n),o=s(970),a=s.n(o);class r{constructor(e){i()(this,"_regex",void 0);const t=a()(e,{extended:!1,globstar:!1}).toString().replace(/\\\?/g,".");this._regex=new RegExp(t.substring(1,t.length-1))}test(e){return this._regex.test(e)}}const c=["m.ban","org.matrix.mjolnir.ban"];function l(e,t=!0){return c.includes(e)?t?c[c.length-1]:"m.ban":null}class d{constructor(e,t,s,n){i()(this,"_glob",void 0),i()(this,"_entity",void 0),i()(this,"_action",void 0),i()(this,"_reason",void 0),i()(this,"_kind",void 0),this._glob=new r(e),this._entity=e,this._action=l(t,!1),this._reason=s,this._kind=n}get entity(){return this._entity}get reason(){return this._reason}get kind(){return this._kind}get recommendation(){return this._action}isMatch(e){return this._glob.test(e)}}var u=s(94);const h="m.room.rule.user",m="m.room.rule.server",p=[h,"org.matrix.mjolnir.rule.user"],g=["m.room.rule.room","org.matrix.mjolnir.rule.room"],v=[m,"org.matrix.mjolnir.rule.server"],f=[...p,...g,...v];function b(e,t=!0){return p.includes(e)?t?p[p.length-1]:h:g.includes(e)?t?g[g.length-1]:"m.room.rule.room":v.includes(e)?t?v[v.length-1]:m:null}class y{constructor(e){i()(this,"_rules",[]),i()(this,"_roomId",void 0),this._roomId=e,this.updateList()}get roomId(){return this._roomId}get serverRules(){return this._rules.filter(e=>e.kind===m)}get userRules(){return this._rules.filter(e=>e.kind===h)}get roomRules(){return this._rules.filter(e=>"m.room.rule.room"===e.kind)}async banEntity(e,t,s){await u.a.get().sendStateEvent(this._roomId,b(e,!0),{entity:t,reason:s,recommendation:l("m.ban",!0)},"rule:"+t),this._rules.push(new d(t,"m.ban",s,b(e,!1)))}async unbanEntity(e,t){await u.a.get().sendStateEvent(this._roomId,b(e,!0),{},"rule:"+t),this._rules=this._rules.filter(s=>s.kind!==b(e,!1)||s.entity!==t)}updateList(){this._rules=[];const e=u.a.get().getRoom(this._roomId);if(e)for(const t of f){const s=e.currentState.getStateEvents(t);for(const e of s){if(!e.getStateKey())continue;const s=b(t,!1),n=e.getContent().entity,i=e.getContent().recommendation,o=e.getContent().reason;n&&i&&o&&this._rules.push(new d(n,i,o,s))}}}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(8),i=s(167),o=s(114),a=s(1),r=s(0),c=s(115),l=s.n(c),d=s(110);class u extends n.EventEmitter{constructor(e,t,s){super(),this.relationType=e,this.eventType=t,this.room=s,l()(this,"relationEventIds",new Set),l()(this,"relations",new Set),l()(this,"annotationsByKey",{}),l()(this,"annotationsBySender",{}),l()(this,"sortedAnnotationsByKey",[]),l()(this,"targetEvent",null),l()(this,"creationEmitted",!1),l()(this,"onEventStatus",(e,t)=>{e.isSending()?t===o.a.CANCELLED&&(e.removeListener("Event.status",this.onEventStatus),this.removeEvent(e)):e.removeListener("Event.status",this.onEventStatus)}),l()(this,"onBeforeRedaction",async e=>{if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===d.c.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===d.c.Replace&&this.targetEvent){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.removeListener("Event.beforeRedaction",this.onBeforeRedaction),this.emit("Relations.redaction",e)}})}async addEvent(e){if(this.relationEventIds.has(e.getId()))return;const t=e.getRelation();if(!t)return void r.a.error("Event must have relation info");const s=t.rel_type,n=e.getType();if(this.relationType===s&&this.eventType===n){if(e.isSending()&&e.on("Event.status",this.onEventStatus),this.relations.add(e),this.relationEventIds.add(e.getId()),this.relationType===d.c.Annotation)this.addAnnotationToAggregation(e);else if(this.relationType===d.c.Replace&&this.targetEvent){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.on("Event.beforeRedaction",this.onBeforeRedaction),this.emit("Relations.add",e),this.maybeEmitCreated()}else r.a.error("Event relation info doesn't match this container")}async removeEvent(e){if(!this.relations.has(e))return;const t=e.getRelation();if(!t)return void r.a.error("Event must have relation info");const s=t.rel_type,n=e.getType();if(this.relationType===s&&this.eventType===n){if(this.relations.delete(e),this.relationType===d.c.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===d.c.Replace&&this.targetEvent){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}this.emit("Relations.remove",e)}else r.a.error("Event relation info doesn't match this container")}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){const{key:t}=e.getRelation();if(!t)return;let s=this.annotationsByKey[t];s||(s=this.annotationsByKey[t]=new Set,this.sortedAnnotationsByKey.push([t,s])),s.add(e),this.sortedAnnotationsByKey.sort((e,t)=>{const s=e[1];return t[1].size-s.size});const n=e.getSender();let i=this.annotationsBySender[n];i||(i=this.annotationsBySender[n]=new Set),i.add(e)}removeAnnotationFromAggregation(e){const{key:t}=e.getRelation();if(!t)return;const s=this.annotationsByKey[t];s&&(s.delete(e),this.sortedAnnotationsByKey.sort((e,t)=>{const s=e[1];return t[1].size-s.size}));const n=e.getSender(),i=this.annotationsBySender[n];i&&i.delete(e)}getSortedAnnotationsByKey(){return this.relationType!==d.c.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==d.c.Annotation?null:this.annotationsBySender}async getLastReplacement(){if(this.relationType!==d.c.Replace)return null;if(!this.targetEvent)return null;const e=this.targetEvent.getServerAggregatedRelation(d.c.Replace),t=e&&e.origin_server_ts,s=this.getRelations().reduce((e,s)=>s.getSender()!==this.targetEvent.getSender()||t&&t>s.getTs()||e&&e.getTs()>s.getTs()?e:s,null);return null!=s&&s.shouldAttemptDecryption()?await s.attemptDecryption(this.room.client.crypto):null!=s&&s.isBeingDecrypted()&&await s.getDecryptionPromise(),s}async setTargetEvent(e){if(!this.targetEvent){if(this.targetEvent=e,this.relationType===d.c.Replace){const e=await this.getLastReplacement();e&&this.targetEvent.makeReplaced(e)}this.maybeEmitCreated()}}maybeEmitCreated(){this.creationEmitted||this.targetEvent&&this.relations.size&&(this.creationEmitted=!0,this.targetEvent.emit("Event.relationsCreated",this.relationType,this.eventType))}}let h;function m(e,t){this.room=e,this._timelineSupport=Boolean(t.timelineSupport),this._liveTimeline=new i.a(this),this._unstableClientRelationAggregation=!!t.unstableClientRelationAggregation,this._timelines=[this._liveTimeline],this._eventIdToTimeline={},this._filter=t.filter||null,this._unstableClientRelationAggregation&&(this._relations={})}h=r.a.log.bind(r.a),a.r(m,n.EventEmitter),m.prototype.getTimelines=function(){return this._timelines},m.prototype.getFilter=function(){return this._filter},m.prototype.setFilter=function(e){this._filter=e},m.prototype.getPendingEvents=function(){return this.room?this._filter?this._filter.filterRoomTimeline(this.room.getPendingEvents()):this.room.getPendingEvents():[]},m.prototype.getLiveTimeline=function(){return this._liveTimeline},m.prototype.eventIdToTimeline=function(e){return this._eventIdToTimeline[e]},m.prototype.replaceEventId=function(e,t){const s=this._eventIdToTimeline[e];s&&(delete this._eventIdToTimeline[e],this._eventIdToTimeline[t]=s)},m.prototype.resetLiveTimeline=function(e,t){const s=!this._timelineSupport||!t,n=this._liveTimeline,o=s?n.forkLive(i.a.FORWARDS):n.fork(i.a.FORWARDS);s?(this._timelines=[o],this._eventIdToTimeline={}):this._timelines.push(o),t&&n.setPaginationToken(t,i.a.FORWARDS),o.setPaginationToken(e,i.a.BACKWARDS),this._liveTimeline=o,this.emit("Room.timelineReset",this.room,this,s)},m.prototype.getTimelineForEvent=function(e){const t=this._eventIdToTimeline[e];return void 0===t?null:t},m.prototype.findEventById=function(e){const t=this.getTimelineForEvent(e);if(t)return t.getEvents().find((function(t){return t.getId()==e}))},m.prototype.addTimeline=function(){if(!this._timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const e=new i.a(this);return this._timelines.push(e),e},m.prototype.addEventsToTimeline=function(e,t,s,n){if(!s)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&s==this._liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this._filter&&!(e=this._filter.filterRoomTimeline(e)).length)return;const o=t?i.a.BACKWARDS:i.a.FORWARDS,a=t?i.a.FORWARDS:i.a.BACKWARDS;let c=!1,l=!1;for(let n=0;n<e.length;n++){const d=e[n],u=d.getId(),m=this._eventIdToTimeline[u];if(!m){this.addEventToTimeline(d,s,t),l=!0,c=!0;continue}if(l=!1,m==s){h("Event "+u+" already in timeline "+s);continue}const p=s.getNeighbouringTimeline(o);if(p){h(m==p?"Event "+u+" in neighbouring timeline - switching to "+m:"Event "+u+" already in a different timeline "+m),s=m;continue}r.a.info("Already have timeline for "+u+" - joining timeline "+s+" to "+m);const g=m===this._liveTimeline,v=s===this._liveTimeline,f=o===i.a.BACKWARDS&&g,b=o===i.a.FORWARDS&&v;f||b?(f&&r.a.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+m+")"),b&&r.a.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+s+")")):(s.setNeighbouringTimeline(m,o),m.setNeighbouringTimeline(s,a),s=m,c=!0)}if(l||!c){if(o===i.a.FORWARDS&&s===this._liveTimeline)return r.a.warn({lastEventWasNew:l,didUpdate:c}),void r.a.warn(`Refusing to set forwards pagination token of live timeline ${s} to ${n}`);s.setPaginationToken(n,o)}},m.prototype.addLiveEvent=function(e,t,s){if(this._filter){if(!this._filter.filterRoomTimeline([e]).length)return}const n=this._eventIdToTimeline[e.getId()];if(n)if("replace"===t){h("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());const t=n.getEvents();for(let s=0;s<t.length;s++)if(t[s].getId()===e.getId()){i.a.setEventMetadata(e,n.getState(i.a.FORWARDS),!1),t[s].encryptedType||(t[s]=e);break}}else h("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this._liveTimeline,!1,s)},m.prototype.addEventToTimeline=function(e,t,s,n){const i=e.getId();t.addEvent(e,s),this._eventIdToTimeline[i]=t,this.setRelationsTarget(e),this.aggregateRelations(e);const o={timeline:t,liveEvent:!s&&t==this._liveTimeline&&!n};this.emit("Room.timeline",e,this.room,Boolean(s),!1,o)},m.prototype.handleRemoteEcho=function(e,t,s){const n=this._eventIdToTimeline[t];n?(delete this._eventIdToTimeline[t],this._eventIdToTimeline[s]=n):this._filter?this._filter.filterRoomTimeline([e]).length&&this.addEventToTimeline(e,this._liveTimeline,!1):this.addEventToTimeline(e,this._liveTimeline,!1)},m.prototype.removeEvent=function(e){const t=this._eventIdToTimeline[e];if(!t)return null;const s=t.removeEvent(e);if(s){delete this._eventIdToTimeline[e];const n={timeline:t};this.emit("Room.timeline",s,this.room,void 0,!0,n)}return s},m.prototype.compareEventOrdering=function(e,t){if(e==t)return 0;const s=this._eventIdToTimeline[e],n=this._eventIdToTimeline[t];if(void 0===s)return null;if(void 0===n)return null;if(s===n){let n,i;const o=s.getEvents();for(let s=0;s<o.length&&(void 0===n||void 0===i);s++){const a=o[s].getId();a==e&&(n=s),a==t&&(i=s)}return n-i}let o=s;for(;o;){if(o===n)return-1;o=o.getNeighbouringTimeline(i.a.FORWARDS)}for(o=s;o;){if(o===n)return 1;o=o.getNeighbouringTimeline(i.a.BACKWARDS)}return null},m.prototype.getRelationsForEvent=function(e,t,s){if(!this._unstableClientRelationAggregation)throw new Error("Client-side relation aggregation is disabled");if(!e||!t||!s)throw new Error("Invalid arguments for `getRelationsForEvent`");return((this._relations[e]||{})[t]||{})[s]},m.prototype.setRelationsTarget=function(e){if(!this._unstableClientRelationAggregation)return;const t=this._relations[e.getId()];if(t)for(const s of Object.values(t))for(const t of Object.values(s))t.setTargetEvent(e)},m.prototype.aggregateRelations=function(e){if(!this._unstableClientRelationAggregation)return;if(e.isRedacted()||e.status===o.a.CANCELLED)return;if(e.isBeingDecrypted()||e.shouldAttemptDecryption())return void e.once("Event.decrypted",()=>{this.aggregateRelations(e)});const t=e.getRelation();if(!t)return;const s=t.event_id,n=t.rel_type,i=e.getType();let a=this._relations[s];a||(a=this._relations[s]={});let r=a[n];r||(r=a[n]={});let c,l=r[i];l||(l=r[i]=new u(n,i,this.room),c=this.findEventById(s)||this.room.getPendingEvent(s),c&&l.setTargetEvent(c)),l.addEvent(e)}},function(e,t,s){"use strict";s.d(t,"b",(function(){return q})),s.d(t,"c",(function(){return H})),s.d(t,"a",(function(){return $})),s.d(t,"d",(function(){return Z}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(101),c=s.n(r),l=s(92),d=s(95),u=s(94),h=s(122),m=s(127),p=s(102),g=s(198),v=s(272),f=s(238),b=s(96),y=s(200),_=s(99);var E,S,w,C=s(137),k=s(157),O=s(111),R=s(103),I=s(146),x=s(159),T=s(182),j=s(98),N=s(116),P=s(120),D=s(93),A=s(107),M=s(214),U=s(130),L=s(100),F=s(142),B=s(113),V=s(109),K=s(677);function W(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function G(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?W(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):W(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const q="dm",H="invite",$="call_transfer";class z{}class Y extends z{constructor(e){super(),i()(this,"_userId",void 0),i()(this,"displayName",void 0),i()(this,"avatarUrl",void 0),this._userId=e.user_id,this.displayName=e.display_name,this.avatarUrl=e.avatar_url}get name(){return this.displayName||this._userId}get userId(){return this._userId}getMxcAvatarUrl(){return this.avatarUrl}}class J extends z{constructor(e){super(),i()(this,"id",void 0),this.id=e}get isEmail(){return this.id.includes("@")}get name(){return this.id}get userId(){return this.id}getMxcAvatarUrl(){return null}}class Q extends a.a.PureComponent{constructor(...e){super(...e),i()(this,"onRemove",e=>{e.preventDefault(),e.stopPropagation(),this.props.onRemove(this.props.member)})}render(){const e=this.props.member.isEmail?a.a.createElement("img",{className:"mx_InviteDialog_userTile_avatar mx_InviteDialog_userTile_threepidAvatar",src:s(678),width:20,height:20}):a.a.createElement(U.a,{className:"mx_InviteDialog_userTile_avatar",url:this.props.member.getMxcAvatarUrl()?Object(A.b)(this.props.member.getMxcAvatarUrl()).getSquareThumbnailHttp(20):null,name:this.props.member.name,idName:this.props.member.userId,width:20,height:20});let t;return this.props.onRemove&&(t=a.a.createElement(L.a,{className:"mx_InviteDialog_userTile_remove",onClick:this.onRemove},a.a.createElement("img",{src:s(1216),alt:Object(l.a)("Remove"),width:8,height:8}))),a.a.createElement("span",{className:"mx_InviteDialog_userTile"},a.a.createElement("span",{className:"mx_InviteDialog_userTile_pill"},e,a.a.createElement("span",{className:"mx_InviteDialog_userTile_name"},this.props.member.name)),t)}}class X extends a.a.PureComponent{constructor(...e){super(...e),i()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onToggle(this.props.member)})}highlightName(e){if(!this.props.highlightWord)return e;const t=e.toLowerCase(),s=this.props.highlightWord.toLowerCase(),n=[];let i,o=0;for(;(i=t.indexOf(s,o))>=0;){i>o&&n.push(a.a.createElement("span",{key:o+"begin"},e.substring(o,i))),o=i;const t=e.substring(o,s.length+o);n.push(a.a.createElement("span",{className:"mx_InviteDialog_roomTile_highlight",key:o+"bold"},t)),o+=t.length}return o<e.length&&n.push(a.a.createElement("span",{key:o+"end"},e.substring(o))),n}render(){let e=null;if(this.props.lastActiveTs){const t=function(e){let t=(new Date).getTime()-e;const s=Math.abs(Math.ceil(t/6e4)),n=Math.ceil(s/60),i=Math.ceil(n/24);return t>=0?t<=15e3?Object(l.a)("a few seconds ago"):t<=75e3?Object(l.a)("about a minute ago"):s<=45?Object(l.a)("%(num)s minutes ago",{num:s}):s<=75?Object(l.a)("about an hour ago"):n<=23?Object(l.a)("%(num)s hours ago",{num:n}):n<=26?Object(l.a)("about a day ago"):Object(l.a)("%(num)s days ago",{num:i}):(t=Math.abs(t),t<=15e3?Object(l.a)("a few seconds from now"):t<=75e3?Object(l.a)("about a minute from now"):s<=45?Object(l.a)("%(num)s minutes from now",{num:s}):s<=75?Object(l.a)("about an hour from now"):n<=23?Object(l.a)("%(num)s hours from now",{num:n}):n<=26?Object(l.a)("about a day from now"):Object(l.a)("%(num)s days from now",{num:i}))}(this.props.lastActiveTs);e=a.a.createElement("span",{className:"mx_InviteDialog_roomTile_time"},t)}const t=this.props.member.isEmail?a.a.createElement("img",{src:s(678),width:36,height:36}):a.a.createElement(U.a,{url:this.props.member.getMxcAvatarUrl()?Object(A.b)(this.props.member.getMxcAvatarUrl()).getSquareThumbnailHttp(36):null,name:this.props.member.name,idName:this.props.member.userId,width:36,height:36});let n=null;this.props.isSelected&&(n=a.a.createElement("div",{className:"mx_InviteDialog_roomTile_selected"}));const i=a.a.createElement("span",{className:"mx_InviteDialog_roomTile_avatarStack"},t,n),o=this.props.member.isEmail?Object(l.a)("Invite by email"):this.highlightName(this.props.member.userId);return a.a.createElement("div",{className:"mx_InviteDialog_roomTile",onClick:this.onClick},i,a.a.createElement("span",{className:"mx_InviteDialog_roomTile_nameStack"},a.a.createElement("div",{className:"mx_InviteDialog_roomTile_name"},this.highlightName(this.props.member.name)),a.a.createElement("div",{className:"mx_InviteDialog_roomTile_userId"},o)),e)}}let Z=Object(D.a)("views.dialogs.InviteDialog")((w=S=class e extends a.a.PureComponent{constructor(t){if(super(t),i()(this,"closeCopiedTooltip",void 0),i()(this,"debounceTimer",null),i()(this,"editorRef",Object(o.createRef)()),i()(this,"unmounted",!1),i()(this,"onConsultFirstChange",e=>{this.setState({consultFirst:e.target.checked})}),i()(this,"startDm",async()=>{this.setState({busy:!0});const e=u.a.get(),t=this.convertFilter(),s=t.map(e=>e.userId);let n;if(n=1===s.length?Object(C.e)(e,s[0]):m.a.shared().getDMRoomForIdentifiers(s),n)return b.a.dispatch({action:"view_room",room_id:n.roomId,should_peek:!1,joining:!1}),void this.props.onFinished();const i={inlineErrors:!0};if(Object(C.f)()){if(!t.some(e=>e instanceof J)){await Object(C.a)(e,s)&&(i.encryption=!0)}}try{const t=1===s.length&&s[0]===e.getUserId();1!==s.length||t||(i.dmUserId=s[0]),s.length>1&&(i.createOpts=s.reduce((t,s)=>{const n=Object(M.d)(s);if("email"===n){const n={id_server:e.getIdentityServerUrl(!0),medium:"email",address:s};t.invite_3pid.push(n)}else"mx-user-id"===n&&t.invite.push(s);return t},{invite:[],invite_3pid:[]})),await Object(C.b)(i),this.props.onFinished()}catch(e){console.error(e),this.setState({busy:!1,errorText:Object(l.a)("We couldn't create your DM.")})}}),i()(this,"inviteUsers",async()=>{const e=P.a.getTimestamp();this.setState({busy:!0}),this.convertFilter();const t=this.convertFilter().map(e=>e.userId),s=u.a.get(),n=s.getRoom(this.props.roomId);if(!n)return console.error("Failed to find the room to invite users to"),void this.setState({busy:!1,errorText:Object(l.a)("Something went wrong trying to invite the users.")});try{const i=await Object(k.a)(this.props.roomId,t);if(P.a.instance.trackSendInvite(e,this.props.roomId,t.length),this.shouldAbortAfterInviteError(i,n)||this.props.onFinished(),s.isRoomEncrypted(this.props.roomId)){const e=n.currentState.getStateEvents("m.room.history_visibility",""),t=e&&e.getContent()&&e.getContent().history_visibility;if("world_readable"==t||"shared"==t){const e=[];for(const[t,s]of Object.entries(i.states))"invited"===s&&"mx-user-id"===Object(M.d)(t)&&e.push(t);console.log("Sharing history with",e),s.sendSharedHistoryKeys(this.props.roomId,e)}}}catch(e){console.error(e),this.setState({busy:!1,errorText:Object(l.a)("We couldn't invite those users. Please check the users you want to invite and try again.")})}}),i()(this,"transferCall",async()=>{this.convertFilter();const e=this.convertFilter().map(e=>e.userId);if(e.length>1&&this.setState({errorText:Object(l.a)("A call can only be transferred to a single user.")}),this.state.consultFirst){const t=await Object(C.c)(u.a.get(),e[0]);b.a.dispatch({action:"place_call",type:this.props.call.type,room_id:t,transferee:this.props.call}),b.a.dispatch({action:"view_room",room_id:t,should_peek:!1,joining:!1}),this.props.onFinished()}else{this.setState({busy:!0});try{await this.props.call.transfer(e[0]),this.setState({busy:!1}),this.props.onFinished()}catch(e){this.setState({busy:!1,errorText:Object(l.a)("Failed to transfer call")})}}}),i()(this,"onKeyDown",e=>{if(this.state.busy)return;const t=e.target.value.trim(),s=e.ctrlKey||e.shiftKey||e.metaKey;!t&&this.state.targets.length>0&&e.key===O.a.BACKSPACE&&!s?(e.preventDefault(),this.removeMember(this.state.targets[this.state.targets.length-1])):(t&&e.key===O.a.ENTER&&!s||t&&e.key===O.a.SPACE&&!s&&t.includes("@")&&!t.includes(" "))&&(e.preventDefault(),this.convertFilter())}),i()(this,"updateSuggestions",async e=>{if(u.a.get().searchUserDirectory({term:e}).then(async t=>{if(e===this.state.filterText){if(t.results||(t.results=[]),"@"===e[0]&&e.indexOf(":")>1)try{const s=await u.a.get().getProfileInfo(e);s&&t.results.splice(0,0,{user_id:e,display_name:s.displayname,avatar_url:s.avatar_url})}catch(s){console.warn("Non-fatal error trying to make an invite for a user ID"),console.warn(s),t.results.splice(0,0,{user_id:e,display_name:e,avatar_url:null})}this.setState({serverResultsMixin:t.results.map(e=>({userId:e.user_id,user:new Y(e)}))})}}).catch(e=>{console.error("Error searching user directory:"),console.error(e),this.setState({serverResultsMixin:[]})}),this.state.canUseIdentityServer){if(e.indexOf("@")>0&&g.a(e)&&j.b.getValue(N.a.IdentityServer)){this.setState({threepidResultsMixin:[{user:new J(e),userId:e}]});try{const t=new y.a,s=await t.getAccessToken();if(e!==this.state.filterText)return;const n=await u.a.get().lookupThreePid("email",e,void 0,s);if(e!==this.state.filterText)return;if(!n||!n.mxid)return;const i=await u.a.get().getProfileInfo(n.mxid);if(e!==this.state.filterText||!i)return;this.setState({threepidResultsMixin:[...this.state.threepidResultsMixin,{user:new Y({user_id:n.mxid,display_name:i.displayname,avatar_url:i.avatar_url}),userId:n.mxid}]})}catch(e){console.error("Error searching identity server:"),console.error(e),this.setState({threepidResultsMixin:[]})}}}else this.setState({tryingIdentityServer:!0})}),i()(this,"updateFilter",e=>{const t=e.target.value;this.setState({filterText:t}),this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.updateSuggestions(t)},150)}),i()(this,"showMoreRecents",()=>{this.setState({numRecentsShown:this.state.numRecentsShown+5})}),i()(this,"showMoreSuggestions",()=>{this.setState({numSuggestionsShown:this.state.numSuggestionsShown+5})}),i()(this,"toggleMember",e=>{if(!this.state.busy){let t=this.state.filterText;const s=this.state.targets.map(e=>e),n=s.indexOf(e);n>=0?s.splice(n,1):(s.push(e),t=""),this.setState({targets:s,filterText:t}),this.editorRef&&this.editorRef.current&&this.editorRef.current.focus()}}),i()(this,"removeMember",e=>{const t=this.state.targets.map(e=>e),s=t.indexOf(e);s>=0&&(t.splice(s,1),this.setState({targets:t})),this.editorRef&&this.editorRef.current&&this.editorRef.current.focus()}),i()(this,"onPaste",async e=>{if(this.state.filterText)return;e.preventDefault();const t=e.clipboardData.getData("text"),s=[...this.state.recents,...this.state.suggestions,...this.state.serverResultsMixin,...this.state.threepidResultsMixin],n=[],i=[],o=t.split(/[\s,]+/).map(e=>e.trim()).filter(e=>!!e);for(const t of o){const o=s.find(e=>e.userId===t);if(o)n.push(o.user);else if(t.indexOf("@")>0&&g.a(t))n.push(new J(t));else if("@"===t[0])try{const e=await u.a.get().getProfileInfo(t),s=e?e.displayname:null,i=e?e.avatar_url:null;n.push(new Y({user_id:t,display_name:s,avatar_url:i}))}catch(e){console.error("Error looking up profile for "+t),console.error(e),i.push(t)}else i.push(t)}if(!this.unmounted){if(i.length>0){const e=d.getComponent("dialogs.QuestionDialog");_.a.createTrackedDialog("Invite Paste Fail","",e,{title:Object(l.a)("Failed to find the following users"),description:Object(l.a)("The following users might not exist or are invalid, and cannot be invited: %(csvNames)s",{csvNames:i.join(", ")}),button:Object(l.a)("OK")})}this.setState({targets:[...this.state.targets,...n]})}}),i()(this,"onClickInputArea",e=>{e.preventDefault(),e.stopPropagation(),this.editorRef&&this.editorRef.current&&this.editorRef.current.focus()}),i()(this,"onUseDefaultIdentityServerClick",e=>{e.preventDefault(),Object(v.d)(),this.setState({canUseIdentityServer:!0,tryingIdentityServer:!1})}),i()(this,"onManageSettingsClick",e=>{e.preventDefault(),b.a.fire(R.a.ViewUserSettings),this.props.onFinished()}),i()(this,"onCommunityInviteClick",e=>{this.props.onFinished(),Object(k.e)(T.a.instance.getSelectedCommunityId())}),i()(this,"onCopyClick",async e=>{e.preventDefault();const t=e.target,s=await Object(F.c)(Object(h.h)(u.a.get().getUserId())),n=t.getBoundingClientRect(),{close:i}=V.n(K.a,G(G({},Object(V.p)(n,2)),{},{message:s?Object(l.a)("Copied!"):Object(l.a)("Failed to copy")}));this.closeCopiedTooltip=t.onmouseleave=i}),t.kind===H&&!t.roomId)throw new Error("When using KIND_INVITE a roomId is required for an InviteDialog");if(t.kind===$&&!t.call)throw new Error("When using KIND_CALL_TRANSFER a call is required for an InviteDialog");const s=new Set([u.a.get().getUserId(),p.a.get().welcomeUserId]);if(t.roomId){const e=u.a.get().getRoom(t.roomId);if(!e)throw new Error("Room ID given to InviteDialog does not look like a room");e.getMembersWithMembership("invite").forEach(e=>s.add(e.userId)),e.getMembersWithMembership("join").forEach(e=>s.add(e.userId)),e.getMembersWithMembership("ban").forEach(e=>s.add(e.userId)),P.a.instance.trackBeginInvite(t.roomId)}this.state={targets:[],filterText:this.props.initialText,recents:e.buildRecents(s),numRecentsShown:3,suggestions:this.buildSuggestions(s),numSuggestionsShown:3,serverResultsMixin:[],threepidResultsMixin:[],canUseIdentityServer:!!u.a.get().getIdentityServerUrl(),tryingIdentityServer:!1,consultFirst:!1,busy:!1,errorText:null}}componentDidMount(){this.props.initialText&&this.updateSuggestions(this.props.initialText)}componentWillUnmount(){this.unmounted=!0,this.closeCopiedTooltip&&this.closeCopiedTooltip()}static buildRecents(e){const t=m.a.shared().getUniqueRoomsWithIndividuals(),s=x.b.instance.orderedLists[I.a.DM]||[],n=u.a.get().getUserId();for(const e of s){const s=e.getJoinedMembers().filter(e=>e.userId!==n);for(const n of s)t[n.userId]||(console.warn(`Adding DM room for ${n.userId} as ${e.roomId} from tag, not DM map`),t[n.userId]=e)}const i=[];for(const s in t){if(e.has(s)){console.warn(`[Invite:Recents] Excluding ${s} from recents`);continue}const n=t[s],o=n.getMember(s);if(!o){console.warn(`[Invite:Recents] ${s} is missing a member object in their own DM (${n.roomId})`);continue}const a=["m.room.message","m.room.encrypted","m.sticker"],r=20;let c=0;if(n.timeline&&n.timeline.length)for(let e=n.timeline.length-1;e>=0;e--){const t=n.timeline[e];if(a.includes(t.getType())){c=t.getTs();break}if(n.timeline.length-e>r)break}c?i.push({userId:s,user:o,lastActive:c}):console.warn(`[Invite:Recents] ${s} (${n.roomId}) has a weird last timestamp: ${c}`)}return i||console.warn("[Invite:Recents] No recents to suggest!"),i.sort((e,t)=>t.lastActive-e.lastActive),i}buildSuggestions(e){const t=u.a.get().getRooms().filter(e=>"join"===e.getMyMembership()&&e.getJoinedMemberCount()<=200).reduce((t,s)=>{if(m.a.shared().getUserIdForRoomId(s.roomId))return t;const n=s.getJoinedMembers().filter(t=>!e.has(t.userId));for(const i of n)e.has(i.userId)||(t[i.userId]||(t[i.userId]={member:i,pickedMemberRoomSize:s.getJoinedMemberCount(),rooms:[]}),t[i.userId].rooms.push(s),s.getJoinedMemberCount()<t[i.userId].pickedMemberRoomSize&&(t[i.userId].member=i,t[i.userId].pickedMemberRoomSize=s.getJoinedMemberCount()));return t},{}),s=Object.values(t).reduce((e,t)=>{const s=t.rooms.reduce((e,t)=>e+t.getJoinedMemberCount(),0),n=200*t.rooms.length;return e[t.member.userId]={member:t.member,numRooms:t.rooms.length,score:Math.max(0,Math.pow(1-s/n,5))},e},{}),n=u.a.get().getRooms().filter(e=>"join"===e.getMyMembership()),i=(new Date).getTime(),o=i-36e5,a={},r={};for(const t of n){const s=m.a.shared().getUserIdForRoomId(t.roomId);if(Object.keys(t.tags).includes("m.lowpriority")||s)continue;const n=t.getLiveTimeline().getEvents();for(let s=n.length-1;s>=Math.max(0,n.length-50);s--){const i=n[s];if(!e.has(i.getSender())){if(i.getTs()<=o)break;(!a[i.getSender()]||a[i.getSender()]<i.getTs())&&(a[i.getSender()]=i.getTs(),r[i.getSender()]=t.getMember(i.getSender()))}}}for(const e in a){const t=a[e],n=r[e];if(!n)continue;const c=i-o-Math.abs(i-t),l=Math.max(1,c/9e5);let d=s[e];d||(d=s[e]={score:0}),d.member=n,d.score+=l}const c=Object.values(s);return c.sort((e,t)=>e.score===t.score?e.numRooms===t.numRooms?Object(F.a)(e.member.userId,t.member.userId):t.numRooms-e.numRooms:t.score-e.score),c.map(e=>({userId:e.member.userId,user:e.member}))}shouldAbortAfterInviteError(e,t){this.setState({busy:!1});const s=new Map(this.state.targets.map(e=>[e.userId,e]));return!Object(k.d)(e.states,t,e.inviter,s)}convertFilter(){if(!this.state.filterText||!this.state.filterText.includes("@"))return this.state.targets||[];let e;this.state.filterText.startsWith("@")?e=new Y({user_id:this.state.filterText,display_name:null,avatar_url:null}):j.b.getValue(N.a.IdentityServer)&&(e=new J(this.state.filterText));const t=[...this.state.targets||[],e];return this.setState({targets:t,filterText:""}),t}renderSection(e){let t="recents"===e?this.state.recents:this.state.suggestions,s="recents"===e?this.state.numRecentsShown:this.state.numSuggestionsShown;const n="recents"===e?this.showMoreRecents.bind(this):this.showMoreSuggestions.bind(this);let i="recents"===e?Object(l.a)("Recent Conversations"):Object(l.a)("Suggestions"),o=null;if("suggestions"===e&&T.a.instance.getSelectedCommunityId()){const e=T.a.instance.getSelectedCommunityName();o=Object(l.a)("May include members not in %(communityName)s",{communityName:e})}this.props.kind===H&&(i="recents"===e?Object(l.a)("Recently Direct Messaged"):Object(l.a)("Suggestions"));let r=[],c=[];const u=this.state.serverResultsMixin||this.state.threepidResultsMixin;if(this.state.filterText&&u&&"suggestions"===e){const e=e=>!t.some(t=>t.userId===e.userId)&&!r.some(t=>t.userId===e.userId)&&!c.some(t=>t.userId===e.userId);c=this.state.serverResultsMixin.filter(e),r=this.state.threepidResultsMixin.filter(e)}const h=r.length>0||c.length>0;if(0===t.length&&!h)return null;if(this.state.filterText){const e=this.state.filterText.toLowerCase();if(t=t.filter(t=>t.user.name.toLowerCase().includes(e)||t.userId.toLowerCase().includes(e)),0===t.length&&!h)return a.a.createElement("div",{className:"mx_InviteDialog_section"},a.a.createElement("h3",null,i),a.a.createElement("p",null,Object(l.a)("No results")))}t=[...r,...t,...c],s===t.length-1&&s++;const m=t.slice(0,s),p=m.length<t.length,g=d.getComponent("elements.AccessibleButton");let v=null;p&&(v=a.a.createElement(g,{onClick:n,kind:"link"},Object(l.a)("Show more")));const f=m.map(t=>{return a.a.createElement(X,{member:t.user,lastActiveTs:(s=t,"recents"===e?s.lastActive:null),key:t.userId,onToggle:this.toggleMember,highlightWord:this.state.filterText,isSelected:this.state.targets.some(e=>e.userId===t.userId)});var s});return a.a.createElement("div",{className:"mx_InviteDialog_section"},a.a.createElement("h3",null,i),o?a.a.createElement("p",{className:"mx_InviteDialog_subname"},o):null,f,v)}renderEditor(){const e=this.state.targets.map(e=>a.a.createElement(Q,{member:e,onRemove:!this.state.busy&&this.removeMember,key:e.userId})),t=a.a.createElement("input",{type:"text",onKeyDown:this.onKeyDown,onChange:this.updateFilter,value:this.state.filterText,ref:this.editorRef,onPaste:this.onPaste,autoFocus:!0,disabled:this.state.busy,autoComplete:"off"});return a.a.createElement("div",{className:"mx_InviteDialog_editor",onClick:this.onClickInputArea},e,t)}renderIdentityServerWarning(){if(!this.state.tryingIdentityServer||this.state.canUseIdentityServer||!j.b.getValue(N.a.IdentityServer))return null;const e=Object(v.c)();return e?a.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(l.a)("Use an identity server to invite by email. <default>Use the default (%(defaultIdentityServerName)s)</default> or manage in <settings>Settings</settings>.",{defaultIdentityServerName:Object(f.a)(e)},{default:e=>a.a.createElement("a",{href:"#",onClick:this.onUseDefaultIdentityServerClick},e),settings:e=>a.a.createElement("a",{href:"#",onClick:this.onManageSettingsClick},e)})):a.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(l.a)("Use an identity server to invite by email. Manage in <settings>Settings</settings>.",{},{settings:e=>a.a.createElement("a",{href:"#",onClick:this.onManageSettingsClick},e)}))}async onLinkClick(e){e.preventDefault(),Object(F.d)(e.target)}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("elements.AccessibleButton"),n=d.getComponent("elements.Spinner");let i,o,r,m,p,g,v=null;this.state.busy&&(v=a.a.createElement(n,{w:20,h:20}));let f=a.a.createElement("span",null);const b=j.b.getValue(N.a.IdentityServer),y=u.a.get(),_=y.getUserId();if(this.props.kind===q){if(i=Object(l.a)("Direct Messages"),o=b?Object(l.a)("Start a conversation with someone using their name, email address or username (like <userId/>).",{},{userId:()=>a.a.createElement("a",{href:Object(h.h)(_),rel:"noreferrer noopener",target:"_blank"},_)}):Object(l.a)("Start a conversation with someone using their name or username (like <userId/>).",{},{userId:()=>a.a.createElement("a",{href:Object(h.h)(_),rel:"noreferrer noopener",target:"_blank"},_)}),T.a.instance.getSelectedCommunityId()){const e=T.a.instance.getSelectedCommunityName(),s=Object(l.a)("This won't invite them to %(communityName)s. To invite someone to %(communityName)s, click <a>here</a>",{communityName:e},{userId:()=>a.a.createElement("a",{href:Object(h.h)(_),rel:"noreferrer noopener",target:"_blank"},_),a:e=>a.a.createElement(t,{kind:"link",onClick:this.onCommunityInviteClick},e)});o=a.a.createElement(a.a.Fragment,null,o," ",s)}r=Object(l.a)("Go"),m=this.startDm,p=a.a.createElement("div",{className:"mx_InviteDialog_section_hidden_suggestions_disclaimer"},a.a.createElement("span",null,Object(l.a)("Some suggestions may be hidden for privacy.")),a.a.createElement("p",null,Object(l.a)("If you can't see who you’re looking for, send them your invite link below.")));const e=Object(h.h)(u.a.get().getUserId());g=a.a.createElement("div",{className:"mx_InviteDialog_footer"},a.a.createElement("h3",null,Object(l.a)("Or send invite link")),a.a.createElement("div",{className:"mx_InviteDialog_footer_link"},a.a.createElement("a",{href:e,onClick:this.onLinkClick},e),a.a.createElement(B.a,{title:Object(l.a)("Copy"),onClick:this.onCopyClick,className:"mx_InviteDialog_footer_link_copy"},a.a.createElement("div",null))))}else if(this.props.kind===H){var E;const e=null===(E=u.a.get())||void 0===E?void 0:E.getRoom(this.props.roomId),t=j.b.getValue("feature_spaces")&&(null==e?void 0:e.isSpaceRoom());let n;if(i=t?Object(l.a)("Invite to %(spaceName)s",{spaceName:e.name||Object(l.a)("Unnamed Space")}):Object(l.a)("Invite to %(roomName)s",{roomName:e.name||Object(l.a)("Unnamed Room")}),n=t?b?Object(l.b)("Invite someone using their name, email address, username (like <userId/>) or <a>share this space</a>."):Object(l.b)("Invite someone using their name, username (like <userId/>) or <a>share this space</a>."):b?Object(l.b)("Invite someone using their name, email address, username (like <userId/>) or <a>share this room</a>."):Object(l.b)("Invite someone using their name, username (like <userId/>) or <a>share this room</a>."),o=Object(l.a)(n,{},{userId:()=>a.a.createElement("a",{href:Object(h.h)(_),rel:"noreferrer noopener",target:"_blank"},_),a:e=>a.a.createElement("a",{href:Object(h.g)(this.props.roomId),rel:"noreferrer noopener",target:"_blank"},e)}),r=Object(l.a)("Invite"),m=this.inviteUsers,y.isRoomEncrypted(this.props.roomId)){const e=y.getRoom(this.props.roomId).currentState.getStateEvents("m.room.history_visibility",""),t=e&&e.getContent()&&e.getContent().history_visibility;"world_readable"!==t&&"shared"!==t||(f=a.a.createElement("p",{className:"mx_InviteDialog_helpText"},a.a.createElement("img",{src:s(1217),width:14,height:14})," "+Object(l.a)("Invited people will be able to read old messages.")))}}else this.props.kind===$?(i=Object(l.a)("Transfer"),r=Object(l.a)("Transfer"),m=this.transferCall,g=a.a.createElement("div",null,a.a.createElement("label",null,a.a.createElement("input",{type:"checkbox",checked:this.state.consultFirst,onChange:this.onConsultFirstChange}),Object(l.a)("Consult first")))):console.error("Unknown kind of InviteDialog: "+this.props.kind);const S=this.state.targets.length>0||this.state.filterText&&this.state.filterText.includes("@");return a.a.createElement(e,{className:c()("mx_InviteDialog",{mx_InviteDialog_hasFooter:!!g}),hasCancel:!0,onFinished:this.props.onFinished,title:i},a.a.createElement("div",{className:"mx_InviteDialog_content"},a.a.createElement("p",{className:"mx_InviteDialog_helpText"},o),a.a.createElement("div",{className:"mx_InviteDialog_addressBar"},this.renderEditor(),a.a.createElement("div",{className:"mx_InviteDialog_buttonAndSpinner"},a.a.createElement(t,{kind:"primary",onClick:m,className:"mx_InviteDialog_goButton",disabled:this.state.busy||!S},r),v)),f,this.renderIdentityServerWarning(),a.a.createElement("div",{className:"error"},this.state.errorText),a.a.createElement("div",{className:"mx_InviteDialog_userSections"},this.renderSection("recents"),this.renderSection("suggestions"),p),g))}},i()(S,"defaultProps",{kind:q,initialText:""}),E=w))||E},function(e,t,s){"use strict";var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(138),d=s(176),u=s(109),h=s(92),m=s(140),p=s(245),g=s(187),v=s(96),f=s(98),b=s(99),y=s(143),_=s(135),E=s(161),S=s(105),w=s(190),C=s(94),k=s(102),O=s(5);function R(){return k.a.get().audioStreamUrl}async function I(e,t){const s=await async function(e){const t=await C.a.get().getOpenIdToken(),s=R()+"/createStream",n=await window.fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room_id:e,openid_token:t})});return(await n.json()).stream_id}(t);await e.transport.send(O.a.StartLiveStream,{rtmpStreamKey:"rtmp://audiostream.dummy/"+s})}t.a=e=>{let{onFinished:t,app:s,userWidget:n,onDeleteClick:o,onEditClick:C,showUnpin:k}=e,O=a()(e,["onFinished","app","userWidget","onDeleteClick","onEditClick","showUnpin"]);const x=Object(r.useContext)(S.a),{room:T,roomId:j}=Object(r.useContext)(g.a),N=p.a.instance.getMessagingForId(s.id),P=n||m.a.canUserModifyWidgets(j);let D,A,M,U,L;if(R()&&E.a.JITSI.matches(s.type)){const e=async()=>{try{await I(N,j)}catch(e){console.error("Failed to start livestream",e);const t=e.message||Object(h.a)("Unable to start audio streaming.");b.a.createTrackedDialog("WidgetContext Menu","Livestream failed",_.a,{title:Object(h.a)("Failed to start livestream"),description:t})}t()};D=c.a.createElement(d.b,{onClick:e,label:Object(h.a)("Start audio stream")})}if(k){const e=()=>{w.d.instance.moveToContainer(T,s,w.a.Right),t()};A=c.a.createElement(d.b,{onClick:e,label:Object(h.a)("Unpin")})}if(P&&m.a.isManagedByManager(s)){const e=()=>{C?C():m.a.editWidget(T,s),t()};M=c.a.createElement(d.b,{onClick:e,label:Object(h.a)("Edit")})}if(null!=N&&N.hasCapability(l.MatrixCapabilities.Screenshots)){const e=()=>{null==N||N.takeScreenshot().then(e=>{v.a.dispatch({action:"picture_snapshot",file:e.screenshot})}).catch(e=>{console.error("Failed to take screenshot: ",e)}),t()};U=c.a.createElement(d.b,{onClick:e,label:Object(h.a)("Take a picture")})}if(o||P){const e=()=>{o?o():b.a.createTrackedDialog("Delete Widget","",y.a,{title:Object(h.a)("Delete Widget"),description:Object(h.a)("Deleting a widget removes it for all users in this room. Are you sure you want to delete this widget?"),button:Object(h.a)("Delete widget"),onFinished:e=>{e&&m.a.setRoomWidget(j,s.id)}}),t()};L=c.a.createElement(d.b,{onClick:e,label:n?Object(h.a)("Remove"):Object(h.a)("Remove for everyone")})}let F=f.b.getValue("allowedWidgets",j)[s.eventId];void 0===F&&(F=s.creatorUserId===x.getUserId());const B=E.a.JITSI.matches(s.type);let V;if(!n&&!B&&F){const e=()=>{console.info("Revoking permission for widget to load: "+s.eventId);const e=f.b.getValue("allowedWidgets",j);e[s.eventId]=!1;const n=f.b.firstSupportedLevel("allowedWidgets");f.b.setValue("allowedWidgets",j,n,e).catch(e=>{console.error(e)}),t()};V=c.a.createElement(d.b,{onClick:e,label:Object(h.a)("Revoke permissions")})}const K=w.d.instance.getContainerWidgets(T,w.a.Top),W=K.findIndex(e=>e.id===s.id);let G,q;if(k&&W>0){const e=()=>{w.d.instance.moveWithinContainer(T,w.a.Top,s,-1),t()};G=c.a.createElement(d.b,{onClick:e,label:Object(h.a)("Move left")})}if(k&&W<K.length-1){const e=()=>{w.d.instance.moveWithinContainer(T,w.a.Top,s,1),t()};q=c.a.createElement(d.b,{onClick:e,label:Object(h.a)("Move right")})}return c.a.createElement(d.e,i()({},O,{chevronFace:u.a.None,onFinished:t}),c.a.createElement(d.c,null,D,M,V,L,U,G,q,A))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i=s(115),o=s.n(i),a=s(8),r=s(168),c=s(0),l=s(1),d=s(110);!function(e){e[e.NotStarted=0]="NotStarted",e[e.InProgress=1]="InProgress",e[e.Finished=2]="Finished"}(n||(n={}));class u extends a.EventEmitter{constructor(e,t={status:n.NotStarted}){super(),this.roomId=e,this.oobMemberFlags=t,o()(this,"sentinels",{}),o()(this,"displayNameToUserIds",{}),o()(this,"userIdsToDisplayNames",{}),o()(this,"tokenToInvite",{}),o()(this,"joinedMemberCount",null),o()(this,"summaryJoinedMemberCount",null),o()(this,"invitedMemberCount",null),o()(this,"summaryInvitedMemberCount",null),o()(this,"modified",void 0),o()(this,"members",{}),o()(this,"events",new Map),o()(this,"paginationToken",null),this.updateModifiedTime()}getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>"join"===t.membership?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>"invite"===t.membership?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;let t=this.sentinels[e];if(void 0===t){t=new r.a(this.roomId,e);const s=this.members[e];s&&t.setMembershipEvent(s.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return void 0===t?[]:null;if(void 0===t)return Array.from(this.events.get(e).values());const s=this.events.get(e).get(t);return s||null}clone(){const e=new u(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=n.NotStarted,Array.from(this.events.values()).forEach(t=>{e.setStateEvents(Array.from(t.values()))}),this.oobMemberFlags.status=t,null!==this.summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==n.Finished&&this.getMembers().forEach(t=>{if(t.isOutOfBand()){e.getMember(t.userId).markOutOfBand()}}),e}setUnknownStateEvents(e){const t=e.filter(e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey()));this.setStateEvents(t)}setStateEvents(e){this.updateModifiedTime(),e.forEach(e=>{if(e.getRoomId()!==this.roomId)return;if(!e.isState())return;const t=this.getStateEventMatching(e);this.setStateEvent(e),e.getType()===d.a.RoomMember&&(this.updateDisplayNameCache(e.getStateKey(),e.getContent().displayname),this.updateThirdPartyTokenCache(e)),this.emit("RoomState.events",e,this,t)}),e.forEach(e=>{if(e.getRoomId()===this.roomId&&e.isState())if(e.getType()===d.a.RoomMember){const t=e.getStateKey();"leave"!==e.getContent().membership&&"ban"!==e.getContent().membership||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);const s=this.getOrCreateMember(t,e);s.setMembershipEvent(e,this),this.updateMember(s),this.emit("RoomState.members",e,this,s)}else if(e.getType()===d.a.RoomPowerLevels){if(""!==e.getStateKey())return;Object.values(this.members).forEach(t=>{const s=t.getLastModifiedTime();t.setPowerLevelEvent(e),s!==t.getLastModifiedTime()&&this.emit("RoomState.members",e,this,t)}),this.sentinels={}}})}getOrCreateMember(e,t){let s=this.members[e];return s||(s=new r.a(this.roomId,e),this.members[e]=s,this.emit("RoomState.newMember",t,this,s)),s}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}getStateEventMatching(e){return this.events.has(e.getType())?this.events.get(e.getType()).get(e.getStateKey()):null}updateMember(e){const t=this.getStateEvents(d.a.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===n.NotStarted}markOutOfBandMembersStarted(){this.oobMemberFlags.status===n.NotStarted&&(this.oobMemberFlags.status=n.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===n.InProgress&&(this.oobMemberFlags.status=n.NotStarted)}clearOutOfBandMembers(){let e=0;Object.keys(this.members).forEach(t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])}),c.a.log(`LL: RoomState removed ${e} members...`),this.oobMemberFlags.status=n.NotStarted}setOutOfBandMembers(e){c.a.log(`LL: RoomState about to set ${e.length} OOB members ...`),this.oobMemberFlags.status===n.InProgress&&(c.a.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=n.Finished,e.forEach(e=>this.setOutOfBandMember(e)))}setOutOfBandMember(e){if(e.getType()!==d.a.RoomMember)return;const t=e.getStateKey(),s=this.getMember(t);if(s&&!s.isOutOfBand())return;const n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),this.updateDisplayNameCache(n.userId,n.name),this.setStateEvent(e),this.updateMember(n),this.emit("RoomState.members",e,this,n)}setTypingEvent(e){Object.values(this.members).forEach((function(t){t.setTypingEvent(e)}))}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){return this.displayNameToUserIds[l.D(e)]||[]}maySendRedactionForEvent(e,t){const s=this.getMember(t);if(!s||"leave"===s.membership)return!1;if(e.status||e.isRedacted())return!1;const n=this.maySendEvent(d.a.RoomRedaction,t);return e.getSender()===t?n:this.hasSufficientPowerLevelFor("redact",s.powerLevel)}hasSufficientPowerLevelFor(e,t){const s=this.getStateEvents(d.a.RoomPowerLevels,"");let n={};s&&(n=s.getContent());let i=50;return l.u(n[e])&&(i=n[e]),t>=i}maySendMessage(e){return this.maySendEventOfType(d.a.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return!t.isGuest()&&this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,s){const n=this.getStateEvents(d.a.RoomPowerLevels,"");let i,o={},a=0,r=0,c=0;if(n){i=n.getContent(),o=i.events||{},a=Number.isFinite(i.state_default)?i.state_default:50;const e=i.users&&i.users[t];Number.isFinite(e)?c=e:Number.isFinite(i.users_default)&&(c=i.users_default),Number.isFinite(i.events_default)&&(r=i.events_default)}let l=s?a:r;return Number.isFinite(o[e])&&(l=o[e]),c>=l}mayTriggerNotifOfType(e,t){const s=this.getMember(t);if(!s)return!1;const n=this.getStateEvents(d.a.RoomPowerLevels,"");let i=50;return n&&n.getContent()&&n.getContent().notifications&&l.u(n.getContent().notifications[e])&&(i=n.getContent().notifications[e]),s.powerLevel>=i}getJoinRule(){const e=this.getStateEvents(d.a.RoomJoinRules,"");return(e?e.getContent():{}).join_rule||"invite"}updateThirdPartyTokenCache(e){if(!e.getContent().third_party_invite)return;const t=(e.getContent().third_party_invite.signed||{}).token;if(!t)return;this.getStateEvents(d.a.RoomThirdPartyInvite,t)&&(this.tokenToInvite[t]=e)}updateDisplayNameCache(e,t){const s=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],s){const t=l.D(s),n=this.displayNameToUserIds[t];if(n){const s=n.filter(t=>t!==e);this.displayNameToUserIds[t]=s}}this.userIdsToDisplayNames[e]=t;const n=t&&l.D(t);n&&(this.displayNameToUserIds[n]||(this.displayNameToUserIds[n]=[]),this.displayNameToUserIds[n].push(e))}}},function(e,t,s){"use strict";function n(e){const t=e.embeddedPages;let s=null==t?void 0:t.homeUrl;return s||(s=e.welcomePageUrl),s}function i(e){const t=e.embeddedPages;return!0===(null==t?void 0:t.loginForWelcome)}s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(18),i=s.n(n);class o{get action(){return"NOT_USED"}constructor(e){i()(this,"fn",void 0),this.fn=e}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(91),i=s.n(n),o=s(110),a=s(101),r=s.n(a),c=s(100),l=s(119),d=s(105),u=s(491),h=s(132),m=s(120),p=s(187);const g=52;t.b=({hasAvatar:e,hasAvatarLabel:t,noAvatarLabel:s,setAvatarUrl:a,children:g})=>{const v=Object(n.useContext)(d.a),[f,b]=Object(n.useState)(!1),[y,_]=Object(n.useState)(!1),[E,S]=Object(n.useState)(!1);Object(u.b)(()=>{S(!0)},3e3),Object(u.b)(()=>{S(!1)},13e3);const w=Object(n.useRef)(),C=e||f?t:s,{room:k}=Object(n.useContext)(p.a);if(!(null==k?void 0:k.currentState.maySendStateEvent(o.a.RoomAvatar,v.getUserId())))return i.a.createElement(i.a.Fragment,null,g);const O=!!C&&(y||E);return i.a.createElement(i.a.Fragment,null,i.a.createElement("input",{type:"file",ref:w,className:"mx_MiniAvatarUploader_input",onChange:async e=>{var t;if(null===(t=e.target.files)||void 0===t||!t.length)return;b(!0),h.a.trackEvent("mini_avatar","upload"),m.a.instance.track("mini_avatar_upload");const s=e.target.files[0],n=await v.uploadContent(s);await a(n),b(!1)},accept:"image/*"}),i.a.createElement(c.a,{className:r()("mx_MiniAvatarUploader",{mx_MiniAvatarUploader_busy:f,mx_MiniAvatarUploader_hasAvatar:e}),disabled:f,onClick:()=>{w.current.click()},onMouseOver:()=>_(!0),onMouseLeave:()=>_(!1)},g,i.a.createElement("div",{className:"mx_MiniAvatarUploader_indicator"},f?i.a.createElement(l.a,{w:20,h:20}):i.a.createElement("div",{className:"mx_MiniAvatarUploader_cameraIcon"})),i.a.createElement("div",{className:r()("mx_Tooltip",{mx_Tooltip_visible:O,mx_Tooltip_invisible:!O})},i.a.createElement("div",{className:"mx_Tooltip_chevron"}),C)))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return r})),s.d(t,"c",(function(){return c})),s.d(t,"d",(function(){return l}));var n=s(97),i=s.n(n),o=s(92);const a=i.a.shape({userId:i.a.string.isRequired,displayname:i.a.string,avatarUrl:i.a.string}),r=i.a.shape({displayname:i.a.string,name:i.a.string,roomId:i.a.string.isRequired,canonicalAlias:i.a.string,avatarUrl:i.a.string});function c(e){return{userId:e.user_id,displayname:e.displayname,avatarUrl:e.avatar_url,isPrivileged:e.is_privileged}}function l(e){return{displayname:e.name||e.canonical_alias||Object(o.a)("Unnamed Room"),name:e.name,roomId:e.room_id,canonicalAlias:e.canonical_alias,avatarUrl:e.avatar_url,topic:e.topic,numJoinedMembers:e.num_joined_members,worldReadable:e.world_readable,guestCanJoin:e.guest_can_join,isPublic:!1!==e.is_public}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(355);function i(e,t,s){return new n.a(n=>{n({action:e+".pending",request:"function"==typeof s?s():void 0}),t().then(t=>{n({action:e+".success",result:t})}).catch(t=>{n({action:e+".failure",err:t})})})}},function(e,t,s){"use strict";function n(e,t){return e.size!==t.size||(!!Array.from(t).some(t=>!e.has(t))||!!Array.from(e).some(e=>!t.has(e)))}s.d(t,"a",(function(){return n}))},function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return r}));var n=s(94),i=s(500),o=s(188);const a=e=>{let t="";n.a.get()&&(t=n.a.get().getUserId());const s={},a=e=>{if(s[e.roomId])return s[e.roomId];const n=(()=>{if(!e||!e.timeline)return Number.MAX_SAFE_INTEGER;if(Object(o.b)(e.getMyMembership())!==o.a.Join){const s=e.currentState.getStateEvents("m.room.member",t);if(s&&!Array.isArray(s))return s.getTs()}for(let s=e.timeline.length-1;s>=0;--s){const n=e.timeline[s];if(n.getTs()&&(n.getSender()===t||i.b(n)))return n.getTs()}return e.timeline.length&&e.timeline[0].getTs()?e.timeline[0].getTs():Number.MAX_SAFE_INTEGER})();return s[e.roomId]=n,n};return e.sort((e,t)=>a(t)-a(e))};class r{async sortRooms(e,t){return a(e)}}},function(e,t,s){"use strict";var n=s(501),i=s(122);function o(e){const t=e.scanner.TOKENS,s=e.parser.TOKENS.Base,n=e.parser.start;if(void 0===t.UNDERSCORE)throw new Error("linkify-matrix requires linkifyjs 2.1.1: this version is too old.");const i=function(e){s.call(this,e),this.type="roomalias",this.isLink=!0};i.prototype=new s;const o=n.jump(t.POUND),a=new e.parser.State,r=new e.parser.State,c=new e.parser.State(i),l=new e.parser.State,d=new e.parser.State(i),u=new e.parser.State,h=new e.parser.State(i),m=[t.DOT,t.PLUS,t.NUM,t.DOMAIN,t.TLD,t.UNDERSCORE,t.POUND,t.LOCALHOST];o.on(m,a),a.on(m,a),a.on(t.DOMAIN,a),a.on(t.COLON,r),r.on(t.DOMAIN,c),r.on(t.LOCALHOST,d),r.on(t.TLD,d),c.on(t.DOT,l),l.on(t.DOMAIN,c),l.on(t.TLD,d),d.on(t.DOT,l),d.on(t.COLON,u),u.on(t.NUM,h);const p=function(e){s.call(this,e),this.type="userid",this.isLink=!0};p.prototype=new s;const g=n.jump(t.AT),v=new e.parser.State,f=new e.parser.State,b=new e.parser.State(p),y=new e.parser.State,_=new e.parser.State(p),E=new e.parser.State,S=new e.parser.State(p),w=[t.DOT,t.UNDERSCORE,t.PLUS,t.NUM,t.DOMAIN,t.TLD,t.LOCALHOST];g.on(w,v),v.on(w,v),v.on(t.DOMAIN,v),v.on(t.COLON,f),f.on(t.DOMAIN,b),f.on(t.LOCALHOST,_),f.on(t.TLD,_),b.on(t.DOT,y),y.on(t.DOMAIN,b),y.on(t.TLD,_),_.on(t.DOT,y),_.on(t.COLON,E),E.on(t.NUM,S);const C=function(e){s.call(this,e),this.type="groupid",this.isLink=!0};C.prototype=new s;const k=n.jump(t.PLUS),O=new e.parser.State,R=new e.parser.State,I=new e.parser.State(C),x=new e.parser.State,T=new e.parser.State(C),j=new e.parser.State,N=new e.parser.State(C),P=[t.DOT,t.UNDERSCORE,t.PLUS,t.NUM,t.DOMAIN,t.TLD,t.LOCALHOST];k.on(P,O),O.on(P,O),O.on(t.DOMAIN,O),O.on(t.COLON,R),R.on(t.DOMAIN,I),R.on(t.LOCALHOST,T),R.on(t.TLD,T),I.on(t.DOT,x),x.on(t.DOMAIN,I),x.on(t.TLD,T),T.on(t.DOT,x),T.on(t.COLON,j),j.on(t.NUM,N)}o.onUserClick=function(e,t){e.preventDefault()},o.onAliasClick=function(e,t){e.preventDefault()},o.onGroupClick=function(e,t){e.preventDefault()};o.ELEMENT_URL_PATTERN="^(?:https?://)?(?:"+((window.location.host+window.location.pathname).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"|(?:www\\.)?(?:riot|vector)\\.im/(?:app|beta|staging|develop)/|(?:app|beta|staging|develop)\\.element\\.io/)(#.*)"),o.MATRIXTO_URL_PATTERN="^(?:https?://)?(?:www\\.)?matrix\\.to/#/(([#@!+]).*)",o.MATRIXTO_MD_LINK_PATTERN="\\[([^\\]]*)\\]\\((?:https?://)?(?:www\\.)?matrix\\.to/#/([#@!+][^\\)]*)\\)",o.MATRIXTO_BASE_URL=n.a,o.options={events:function(e,t){switch(t){case"url":try{const t=Object(i.j)(e);if(t&&t.userId)return{click:function(e){o.onUserClick(e,t.userId)}}}catch(e){}break;case"userid":return{click:function(t){o.onUserClick(t,e)}};case"roomalias":return{click:function(t){o.onAliasClick(t,e)}};case"groupid":return{click:function(t){o.onGroupClick(t,e)}}}},formatHref:function(e,t){switch(t){case"roomalias":case"userid":case"groupid":default:return Object(i.k)(e)}},linkAttributes:{rel:"noreferrer noopener"},target:function(e,t){if("url"===t)try{return Object(i.l)(e)!==e||decodeURIComponent(e).match(o.ELEMENT_URL_PATTERN)?null:"_blank"}catch(e){}return null}},t.a=o},,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o}));var n=s(92);function i(e){return{undefined:Object(n.a)("Default"),0:Object(n.a)("Restricted"),[e]:Object(n.a)("Default"),50:Object(n.a)("Moderator"),100:Object(n.a)("Admin")}}function o(e,t){const s=i(t);return s[e]?s[e]:Object(n.a)("Custom (%(level)s)",{level:e})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(1);s(0);function i(e,t){this.retryAlgorithm=e||i.RETRY_BACKOFF_RATELIMIT,this.queueAlgorithm=t||i.QUEUE_MESSAGES,this._queues={},this._activeQueues=[],this._procFn=null}function o(e){e._procFn&&Object.keys(e._queues).filter((function(t){return-1===e._activeQueues.indexOf(t)&&e._queues[t].length>0})).forEach((function(t){e._activeQueues.push(t),r("Spinning up queue: '%s'",t),function e(t,s){const n=function(e,t){const s=e._queues[t];if(!Array.isArray(s))return null;return s[0]}(t,s);if(!n){const e=t._activeQueues.indexOf(s);return e>=0&&t._activeQueues.splice(e,1),void r("Stopping queue '%s' as it is now empty",s)}r("Queue '%s' has %s pending events",s,t._queues[s].length),Promise.resolve().then(()=>t._procFn(n.event)).then((function(i){a(t,s),r("Queue '%s' sent event %s",s,n.event.getId()),n.defer.resolve(i),e(t,s)}),(function(i){n.attempts+=1;const o=t.retryAlgorithm(n.event,n.attempts,i);r("retry(%s) err=%s event_id=%s waitTime=%s",n.attempts,i,n.event.getId(),o),-1===o?(r("Queue '%s' giving up on event %s",s,n.event.getId()),a(t,s),n.defer.reject(i),e(t,s)):setTimeout((function(){e(t,s)}),o)}))}(e,t)}))}function a(e,t){const s=e._queues[t];return Array.isArray(s)?s.shift():null}function r(){0}i.prototype.getQueueForEvent=function(e){const t=this.queueAlgorithm(e);return t&&this._queues[t]?this._queues[t].map((function(e){return e.event})):null},i.prototype.removeEventFromQueue=function(e){const t=this.queueAlgorithm(e);if(!t||!this._queues[t])return!1;let s=!1;return n.C(this._queues[t],(function(t){if(t.event.getId()===e.getId())return s=!0,!0})),s},i.prototype.setProcessFunction=function(e){this._procFn=e,o(this)},i.prototype.queueEvent=function(e){const t=this.queueAlgorithm(e);if(!t)return null;this._queues[t]||(this._queues[t]=[]);const s=n.j();return this._queues[t].push({event:e,defer:s,attempts:0}),r("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),o(this),s.promise},i.RETRY_BACKOFF_RATELIMIT=function(e,t,s){if(400===s.httpStatus||403===s.httpStatus||401===s.httpStatus)return-1;if("rejected"===s.cors)return-1;if("M_TOO_LARGE"===s.name)return-1;if("M_LIMIT_EXCEEDED"===s.name){const e=s.data.retry_after_ms;if(e>0)return e}return t>4?-1:1e3*Math.pow(2,t)},i.QUEUE_MESSAGES=function(e){return"m.room.message"===e.getType()||e.hasAssocation()?"message":null}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(115),i=s.n(n);class o{constructor(e){i()(this,"target",void 0),this.target=e}reEmit(e,t){for(const s of t){const t=(...t)=>{"error"===s&&0===this.target.listenerCount("error")||this.target.emit(s,...t,e)};e.on(s,t)}}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return a}));var n=s(8),i=s.n(n);let o;!function(e){e.NewStream="new_stream"}(o||(o={}));class a extends i.a{constructor(e,t,s,n,i){super(),this.stream=e,this.userId=t,this.purpose=s,this.client=n,this.roomId=i}getMember(){return this.client.getRoom(this.roomId).getMember(this.userId)}isLocal(){return this.userId===this.client.getUserId()}isAudioMuted(){return 0===this.stream.getAudioTracks().length}isVideoMuted(){return 0===this.stream.getVideoTracks().length}setNewStream(e){this.stream=e,this.emit(o.NewStream,this.stream)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d})),s.d(t,"b",(function(){return u}));var n=s(114),i=s(8),o=s(0),a=s(313),r=s(276),c=s(315);const l=new Error("Verification timed out");class d extends Error{constructor(e){super(),this.startEvent=e}}class u extends i.EventEmitter{constructor(e,t,s,n,i,o){super(),this._channel=e,this._baseApis=t,this.userId=s,this.deviceId=n,this.startEvent=i,this.request=o,this.cancelled=!1,this._done=!1,this._promise=null,this._transactionTimeoutTimer=null}get initiatedByMe(){if(!this.startEvent)return!0;const e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this._baseApis.getUserId()&&t.from_device===this._baseApis.getDeviceId()}_resetTimer(){o.a.info("Refreshing/starting the verification transaction timeout timer"),null!==this._transactionTimeoutTimer&&clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=setTimeout(()=>{this._done||this.cancelled||(o.a.info("Triggering verification timeout"),this.cancel(l))},6e5)}_endTimer(){null!==this._transactionTimeoutTimer&&(clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=null)}_send(e,t){return this._channel.send(e,t)}_waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));const t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this._expectedEvent=e,new Promise((e,t)=>{this._resolveEvent=e,this._rejectEvent=t}))}canSwitchStartEvent(){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(o.a.log("Verification Base: switching verification start event",{restartingFlow:!!this._rejectEvent}),this._rejectEvent){const t=this._rejectEvent;this._rejectEvent=void 0,t(new d(e))}else this.startEvent=e}handleEvent(e){if(!this._done)if(e.getType()===this._expectedEvent)"m.key.verification.done"!==this._expectedEvent&&(this._expectedEvent=void 0,this._rejectEvent=void 0,this._resetTimer(),this._resolveEvent(e));else if("m.key.verification.cancel"===e.getType()){const t=this._reject;if(this._reject=void 0,t){const s=e.getContent(),{reason:n,code:i}=s;t(new Error(`Other side cancelled verification because ${n} (${i})`))}}else if(this._expectedEvent){const t=new Error("Unexpected message: expecting "+this._expectedEvent+" but got "+e.getType());if(this._expectedEvent=void 0,this._rejectEvent){const e=this._rejectEvent;this._rejectEvent=void 0,e(t)}this.cancel(t)}}done(){if(this._endTimer(),!this._done)return this.request.onVerifierFinished(),this._resolve(),Object(c.e)(this._baseApis,this.userId,this.deviceId)}cancel(e){if(this._endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===l){const e=Object(r.e)();this._send(e.getType(),e.getContent())}else if(e instanceof n.b){if(e.getSender()!==this.userId){const t=e.getContent();"m.key.verification.cancel"===e.getType()?(t.code=t.code||"m.unknown",t.reason=t.reason||t.body||"Unknown reason",this._send("m.key.verification.cancel",t)):this._send("m.key.verification.cancel",{code:"m.unknown",reason:t.body||"Unknown reason"})}}else this._send("m.key.verification.cancel",{code:"m.unknown",reason:e.toString()});null!==this._promise?this._reject&&this._reject(e):this._promise=Promise.reject(e),this.emit("cancel",e)}}verify(){return this._promise||(this._promise=new Promise((e,t)=>{this._resolve=(...t)=>{this._done=!0,this._endTimer(),e(...t)},this._reject=(...e)=>{this._done=!0,this._endTimer(),t(...e)}}),this._doVerification&&!this._started&&(this._started=!0,this._resetTimer(),Promise.resolve(this._doVerification()).then(this.done.bind(this),this.cancel.bind(this)))),this._promise}async _verifyKeys(e,t,s){const n=[];for(const[i,r]of Object.entries(t)){const t=i.split(":",2)[1],c=this._baseApis.getStoredDevice(e,t);if(c)await s(i,c,r),n.push(t);else{const c=this._baseApis.crypto.deviceList.getStoredCrossSigningForUser(e);c&&c.getId()===t?(await s(i,a.a.fromStorage({keys:{[i]:t}},t),r),n.push(t)):o.a.warn(`verification: Could not find device ${t} to verify`)}}if(!n.length)throw new Error("No devices could be verified");o.a.info("Verification completed! Marking devices verified: ",n);for(const t of n)await this._baseApis.setDeviceVerified(e,t)}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return a}));var n=s(167);s(0);const i=function(){};function o(e,t,s){s=s||{},this._client=e,this._timelineSet=t,this._start=null,this._end=null,this._eventCount=0,this._windowLimit=s.windowLimit||1e3}function a(e,t){this.timeline=e,this.index=t}o.prototype.load=function(e,t){const s=this;t=t||20;const n=function(n){let i;const o=n.getEvents();if(e){for(let t=0;t<o.length;t++)if(o[t].getId()==e){i=t;break}if(void 0===i)throw new Error("getEventTimeline result didn't include requested event")}else i=o.length;const r=Math.min(o.length,i+Math.ceil(t/2)),c=Math.max(0,r-t);s._start=new a(n,c-n.getBaseIndex()),s._end=new a(n,r-n.getBaseIndex()),s._eventCount=r-c};if(e){const t=this._timelineSet.getTimelineForEvent(e);if(t)return n(t),Promise.resolve(t);return this._client.getEventTimeline(this._timelineSet,e).then(n)}return n(this._timelineSet.getLiveTimeline()),Promise.resolve()},o.prototype.getTimelineIndex=function(e){if(e==n.a.BACKWARDS)return this._start;if(e==n.a.FORWARDS)return this._end;throw new Error("Invalid direction '"+e+"'")},o.prototype.extend=function(e,t){const s=this.getTimelineIndex(e);if(!s)return i("TimelineWindow: no timeline yet"),!1;const o=e==n.a.BACKWARDS?s.retreat(t):s.advance(t);if(o){this._eventCount+=o,i("TimelineWindow: increased cap by "+o+" (now "+this._eventCount+")");const t=this._eventCount-this._windowLimit;return t>0&&this.unpaginate(t,e!=n.a.BACKWARDS),!0}return!1},o.prototype.canPaginate=function(e){const t=this.getTimelineIndex(e);if(!t)return i("TimelineWindow: no timeline yet"),!1;if(e==n.a.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;return Boolean(t.timeline.getNeighbouringTimeline(e)||t.timeline.getPaginationToken(e))},o.prototype.paginate=function(e,t,s,o){void 0===s&&(s=!0),void 0===o&&(o=5);const a=this.getTimelineIndex(e);if(!a)return i("TimelineWindow: no timeline yet"),Promise.resolve(!1);if(a.pendingPaginate)return a.pendingPaginate;if(this.extend(e,t))return Promise.resolve(!0);if(!s||0===o)return Promise.resolve(!1);if(!a.timeline.getPaginationToken(e))return i("TimelineWindow: no token"),Promise.resolve(!1);i("TimelineWindow: starting request");const r=this,c=this._client.paginateEventTimeline(a.timeline,{backwards:e==n.a.BACKWARDS,limit:t}).finally((function(){a.pendingPaginate=null})).then((function(s){return i("TimelineWindow: request completed with result "+s),!!s&&r.paginate(e,t,!0,o-1)}));return a.pendingPaginate=c,c},o.prototype.unpaginate=function(e,t){const s=t?this._start:this._end;if(e>this._eventCount||e<0)throw new Error("Attemting to unpaginate "+e+" events, but only have "+this._eventCount+" in the timeline");for(;e>0;){const n=t?s.advance(e):s.retreat(e);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this._eventCount+" events");e-=n,this._eventCount-=n,i("TimelineWindow.unpaginate: dropped "+n+" (now "+this._eventCount+")")}},o.prototype.getEvents=function(){if(!this._start)return[];const e=[];let t=this._start.timeline;for(;;){const s=t.getEvents();let i=0,o=s.length;t===this._start.timeline&&(i=this._start.index+t.getBaseIndex()),t===this._end.timeline&&(o=this._end.index+t.getBaseIndex());for(let t=i;t<o;t++)e.push(s[t]);if(t===this._end.timeline)break;t=t.getNeighbouringTimeline(n.a.FORWARDS)}return e},a.prototype.minIndex=function(){return-1*this.timeline.getBaseIndex()},a.prototype.maxIndex=function(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()},a.prototype.advance=function(e){if(!e)return 0;let t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;const s=this.timeline.getNeighbouringTimeline(e<0?n.a.BACKWARDS:n.a.FORWARDS);return s?(this.timeline=s,this.index=e<0?this.maxIndex():this.minIndex(),i("paginate: switched to new neighbour"),this.advance(e)):0},a.prototype.retreat=function(e){return-1*this.advance(-1*e)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(136),i=s.n(n),o=s(1),a=s(0);function r(e){this._matrixClient=e.matrixClient,this._data=e.authData||{},this._requestCallback=e.doRequest,this._busyChangedCallback=e.busyChanged,this._stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this._resolveFunc=null,this._rejectFunc=null,this._inputs=e.inputs||{},this._requestEmailTokenCallback=e.requestEmailToken,e.sessionId&&(this._data.session=e.sessionId),this._clientSecret=e.clientSecret||this._matrixClient.generateClientSecret(),this._emailSid=e.emailSid,void 0===this._emailSid&&(this._emailSid=null),this._requestingEmailToken=!1,this._chosenFlow=null,this._currentStage=null,this._submitPromise=null}r.prototype={attemptAuth:function(){return new Promise((e,t)=>{this._resolveFunc=e,this._rejectFunc=t;if(this._data&&this._data.flows)this._startNextAuthStage();else{this._busyChangedCallback&&this._busyChangedCallback(!0);let e=null;this._data.session&&(e={session:this._data.session}),this._doRequest(e).finally(()=>{this._busyChangedCallback&&this._busyChangedCallback(!1)})}})},poll:async function(){if(!this._data.session)return;if(!this._resolveFunc)return;if(this._submitPromise)return;let e={};if("m.login.email.identity"==this._currentStage&&this._emailSid){const t={sid:this._emailSid,client_secret:this._clientSecret};if(await this._matrixClient.doesServerRequireIdServerParam()){const e=i.a.parse(this._matrixClient.getIdentityServerUrl());t.id_server=e.host}e={type:"m.login.email.identity",threepid_creds:t,threepidCreds:t}}this.submitAuthDict(e,!0)},getSessionId:function(){return this._data?this._data.session:void 0},getClientSecret:function(){return this._clientSecret},getStageParams:function(e){let t={};return this._data&&this._data.params&&(t=this._data.params),t[e]},getChosenFlow(){return this._chosenFlow},submitAuthDict:async function(e,t){if(!this._resolveFunc)throw new Error("submitAuthDict() called before attemptAuth()");for(!t&&this._busyChangedCallback&&this._busyChangedCallback(!0);this._submitPromise;)try{await this._submitPromise}catch(e){}let s;this._data.session?(s={session:this._data.session},o.o(s,e)):s=e;try{this._submitPromise=this._doRequest(s,t),await this._submitPromise}finally{this._submitPromise=null,!t&&this._busyChangedCallback&&this._busyChangedCallback(!1)}},getEmailSid:function(){return this._emailSid},setEmailSid:function(e){this._emailSid=e},_doRequest:async function(e,t){try{const s=await this._requestCallback(e,t);this._resolveFunc(s),this._resolveFunc=null,this._rejectFunc=null}catch(e){const s=e.data?e.data.flows:null,n=this._data.flows||Boolean(s);401===e.httpStatus&&e.data&&n||(t?a.a.log("Background poll request failed doing UI auth: ignoring",e):this._rejectFunc(e)),e.data.flows||e.data.completed||e.data.session||(e.data.flows=this._data.flows,e.data.completed=this._data.completed,e.data.session=this._data.session),this._data=e.data;try{this._startNextAuthStage()}catch(e){this._rejectFunc(e),this._resolveFunc=null,this._rejectFunc=null}if(!this._emailSid&&!this._requestingEmailToken&&this._chosenFlow.stages.includes("m.login.email.identity")){this._requestingEmailToken=!0;try{const e=await this._requestEmailTokenCallback(this._inputs.emailAddress,this._clientSecret,1,this._data.session);this._emailSid=e.sid}catch(e){this._rejectFunc(e),this._resolveFunc=null,this._rejectFunc=null}finally{this._requestingEmailToken=!1}}}},_startNextAuthStage:function(){const e=this._chooseStage();if(!e)throw new Error("No incomplete flows from the server");if(this._currentStage=e,"m.login.dummy"===e)return void this.submitAuthDict({type:"m.login.dummy"});if(this._data&&this._data.errcode||this._data.error)return void this._stateUpdatedCallback(e,{errcode:this._data.errcode||"",error:this._data.error||""});const t={};"m.login.email.identity"==e&&(t.emailSid=this._emailSid),this._stateUpdatedCallback(e,t)},_chooseStage:function(){null===this._chosenFlow&&(this._chosenFlow=this._chooseFlow()),a.a.log("Active flow => %s",JSON.stringify(this._chosenFlow));const e=this._firstUncompletedStage(this._chosenFlow);return a.a.log("Next stage: %s",e),e},_chooseFlow:function(){const e=this._data.flows||[],t=Boolean(this._inputs.emailAddress)||Boolean(this._emailSid),s=Boolean(this._inputs.phoneCountry)&&Boolean(this._inputs.phoneNumber);for(const n of e){let e=!1,i=!1;for(const t of n.stages)"m.login.email.identity"===t?e=!0:"m.login.msisdn"==t&&(i=!0);if(e==t&&i==s)return n}const n=new Error("No appropriate authentication flow found");throw n.name="NoAuthFlowFoundError",n.required_stages=[],t&&n.required_stages.push("m.login.email.identity"),s&&n.required_stages.push("m.login.msisdn"),n.available_flows=e,n},_firstUncompletedStage:function(e){const t=(this._data||{}).completed||[];for(let s=0;s<e.stages.length;++s){const n=e.stages[s];if(-1===t.indexOf(n))return n}}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(1);s(0);const i="session.e2e.";function o(e){if(this.store=e,!(n.s(e.getItem)&&n.s(e.setItem)&&n.s(e.removeItem)&&n.s(e.key)&&"number"==typeof e.length))throw new Error("Supplied webStore does not meet the WebStorage API interface")}o.prototype={removeEndToEndAccount:function(){this.store.removeItem(a)},getEndToEndAccount:function(){return this.store.getItem(a)},getAllEndToEndDevices:function(){const e=d(""),t={};for(let s=0;s<this.store.length;++s){const n=this.store.key(s),i=n.substr(e.length);n.startsWith(e)&&(t[i]=m(this.store,n))}return t},getEndToEndDeviceTrackingStatus:function(){return m(this.store,c)},getEndToEndDeviceSyncToken:function(){return m(this.store,r)},removeEndToEndDeviceData:function(){g(this.store,d("")),g(this.store,c),g(this.store,r)},getEndToEndSessions:function(e){return m(this.store,u(e))},getAllEndToEndSessions:function(){const e=p(this.store,u("")),t={};for(const s of e){t[s.substr(u("").length)]=m(this.store,s)}return t},removeAllEndToEndSessions:function(){g(this.store,u(""))},getAllEndToEndInboundGroupSessionKeys:function(){const e=i+"inboundgroupsessions/",t=[];for(let s=0;s<this.store.length;s++){const n=this.store.key(s);n.startsWith(e)&&t.push({senderKey:n.substr(e.length,43),sessionId:n.substr(e.length+44)})}return t},getEndToEndInboundGroupSession:function(e,t){const s=function(e,t){return i+"inboundgroupsessions/"+e+"/"+t}(e,t);return this.store.getItem(s)},removeAllEndToEndInboundGroupSessions:function(){g(this.store,i+"inboundgroupsessions/")},getAllEndToEndRooms:function(){const e=p(this.store,h("")),t={};for(const s of e){t[s.substr(h("").length)]=m(this.store,s)}return t},removeAllEndToEndRooms:function(){g(this.store,h(""))},setLocalTrustedBackupPubKey:function(e){this.store.setItem(l,e)},getLocalTrustedBackupPubKey:function(){return this.store.getItem(l)}};const a=i+"account",r=i+"device_sync_token",c=i+"device_tracking",l=i+"trusted_backup_pubkey";function d(e){return i+"devices/"+e}function u(e){return i+"sessions/"+e}function h(e){return i+"rooms/"+e}function m(e,t){try{return JSON.parse(e.getItem(t))}catch(e){v("Failed to get key %s: %s",t,e),v(e.stack)}return null}function p(e,t){const s=[];for(let n=0;n<e.length;++n){const i=e.key(n);i.startsWith(t)&&s.push(i)}return s}function g(e,t){const s=[];for(let n=0;n<e.length;++n){const i=e.key(n);i.startsWith(t)&&s.push(i)}for(const t of s)e.removeItem(t)}function v(){0}},,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(18),i=s.n(n),o=s(102),a=s(94);class r{constructor(){i()(this,"domain",void 0),i()(this,"update",async e=>{let t=(o.a.get().jitsi||{}).preferredDomain||"jitsi.riot.im";if(console.log("Attempting to get Jitsi conference information from homeserver"),e&&e["im.vector.riot.jitsi"]){const s=e["im.vector.riot.jitsi"].preferredDomain;s&&(t=s)}this.domain=t,console.log("Jitsi conference domain:",this.preferredDomain)})}get preferredDomain(){return this.domain||"jitsi.riot.im"}async getJitsiAuth(){if(!this.preferredDomain)return null;let e;try{const t=await fetch(`https://${this.preferredDomain}/.well-known/element/jitsi`);e=await t.json()}catch(e){return null}return e.auth?e.auth:null}start(){const e=a.a.get();e.on("WellKnown.client",this.update),this.update(e.getClientWellKnown())}parsePreferredConferenceUrl(e){const t=new URL(e);return t.hostname!==this.preferredDomain?null:{conferenceId:t.pathname,domain:t.hostname,isAudioOnly:!1}}static getInstance(){return r.instance||(r.instance=new r),r.instance}}i()(r,"instance",void 0)},,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return T})),s.d(t,"b",(function(){return j}));var n,i,o,a=s(104),r=s.n(a),c=s(18),l=s.n(c),d=s(91),u=s.n(d),h=s(97),m=s.n(h),p=s(114),g=s(94),v=s(96),f=s(95),b=s(92),y=s(99),_=s(407),E=s(98),S=s(134),w=s(246),C=s(176),k=s(110),O=s(93),R=s(348),I=s(591),x=s(103);function T(e){return e===p.a.QUEUED||e===p.a.NOT_SENT}let j=Object(O.a)("views.context_menus.MessageContextMenu")((o=i=class extends u.a.Component{constructor(...e){super(...e),l()(this,"state",{canRedact:!1,canPin:!1}),l()(this,"_checkPermissions",()=>{const e=g.a.get(),t=e.getRoom(this.props.mxEvent.getRoomId()),s=t.currentState.maySendRedactionForEvent(this.props.mxEvent,e.credentials.userId)&&this.props.mxEvent.getType()!==k.a.RoomServerAcl&&this.props.mxEvent.getType()!==k.a.RoomEncryption;let n=t.currentState.mayClientSendStateEvent(k.a.RoomPinnedEvents,e);E.b.getValue("feature_pinning")||(n=!1),this.setState({canRedact:s,canPin:n})}),l()(this,"onResendReactionsClick",()=>{for(const e of this._getUnsentReactions())_.a.resend(e);this.closeMenu()}),l()(this,"onReportEventClick",()=>{const e=f.getComponent("dialogs.ReportEventDialog");y.a.createTrackedDialog("Report Event","",e,{mxEvent:this.props.mxEvent},"mx_Dialog_reportEvent"),this.closeMenu()}),l()(this,"onViewSourceClick",()=>{const e=f.getComponent("structures.ViewSource");y.a.createTrackedDialog("View Event Source","",e,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource"),this.closeMenu()}),l()(this,"onRedactClick",()=>{const e=f.getComponent("dialogs.ConfirmRedactDialog");y.a.createTrackedDialog("Confirm Redact Dialog","",e,{onFinished:async(e,t)=>{if(!e)return;const s=g.a.get();try{this.props.onCloseDialog&&this.props.onCloseDialog(),await s.redactEvent(this.props.mxEvent.getRoomId(),this.props.mxEvent.getId(),void 0,t?{reason:t}:{})}catch(e){const t=e.errcode||e.statusCode;if(void 0!==t){const e=f.getComponent("dialogs.ErrorDialog");y.a.createTrackedDialog("You cannot delete this message","",e,{title:Object(b.a)("Error"),description:Object(b.a)("You cannot delete this message. (%(code)s)",{code:t})})}}}},"mx_Dialog_confirmredact"),this.closeMenu()}),l()(this,"onForwardClick",()=>{y.a.createTrackedDialog("Forward Message","",I.a,{matrixClient:g.a.get(),event:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator}),this.closeMenu()}),l()(this,"onPinClick",()=>{var e,t;const s=g.a.get(),n=s.getRoom(this.props.mxEvent.getRoomId()),i=this.props.mxEvent.getId(),o=(null==n||null===(e=n.currentState)||void 0===e||null===(t=e.getStateEvents(k.a.RoomPinnedEvents,""))||void 0===t?void 0:t.pinned)||[];var a,r;o.includes(i)?o.splice(o.indexOf(i),1):(o.push(i),s.setRoomAccountData(n.roomId,R.a,{event_ids:[...(null===(a=n.getAccountData(R.a))||void 0===a||null===(r=a.getContent())||void 0===r?void 0:r.event_ids)||[],i]}));s.sendStateEvent(this.props.mxEvent.getRoomId(),k.a.RoomPinnedEvents,{pinned:o},""),this.closeMenu()}),l()(this,"closeMenu",()=>{this.props.onFinished&&this.props.onFinished()}),l()(this,"onUnhidePreviewClick",()=>{this.props.eventTileOps&&this.props.eventTileOps.unhideWidget(),this.closeMenu()}),l()(this,"onQuoteClick",()=>{v.a.dispatch({action:x.a.ComposerInsert,event:this.props.mxEvent}),this.closeMenu()}),l()(this,"onPermalinkClick",e=>{e.preventDefault();const t=f.getComponent("dialogs.ShareDialog");y.a.createTrackedDialog("share room message dialog","",t,{target:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator}),this.closeMenu()}),l()(this,"onCollapseReplyThreadClick",()=>{this.props.collapseReplyThread(),this.closeMenu()})}componentDidMount(){g.a.get().on("RoomMember.powerLevel",this._checkPermissions),this._checkPermissions()}componentWillUnmount(){const e=g.a.get();e&&e.removeListener("RoomMember.powerLevel",this._checkPermissions)}_isPinned(){const e=g.a.get().getRoom(this.props.mxEvent.getRoomId()).currentState.getStateEvents(k.a.RoomPinnedEvents,"");if(!e)return!1;const t=e.getContent();return t.pinned&&Array.isArray(t.pinned)&&t.pinned.includes(this.props.mxEvent.getId())}_getReactions(e){const t=g.a.get().getRoom(this.props.mxEvent.getRoomId()),s=this.props.mxEvent.getId();return t.getPendingEvents().filter(t=>{const n=t.getRelation();return n&&"m.annotation"===n.rel_type&&n.event_id===s&&e(t)})}_getPendingReactions(){return this._getReactions(e=>T(e.status))}_getUnsentReactions(){return this._getReactions(e=>e.status===p.a.NOT_SENT)}render(){const e=g.a.get().getUserId(),t=this.props.mxEvent,s=t.status,n=this._getUnsentReactions().length;let i,o,a,c,l,d,h,m,v;const f=!s||s===p.a.SENT;t.isRedacted()||0!==n&&(i=u.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconResend",label:Object(b.a)("Resend %(unsentCount)s reaction(s)",{unsentCount:n}),onClick:this.onResendReactionsClick})),f&&this.state.canRedact&&(o=u.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconRedact",label:Object(b.a)("Remove"),onClick:this.onRedactClick})),Object(w.c)(t)&&(a=u.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconForward",label:Object(b.a)("Forward"),onClick:this.onForwardClick}),this.state.canPin&&(c=u.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconPin",label:this._isPinned()?Object(b.a)("Unpin"):Object(b.a)("Pin"),onClick:this.onPinClick})));const y=u.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconSource",label:Object(b.a)("View source"),onClick:this.onViewSourceClick});let _;this.props.eventTileOps&&this.props.eventTileOps.isWidgetHidden()&&(l=u.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconUnhidePreview",label:Object(b.a)("Show preview"),onClick:this.onUnhidePreviewClick})),this.props.permalinkCreator&&(_=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const E=u.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconPermalink",onClick:this.onPermalinkClick,label:Object(b.a)("Share"),element:"a",href:_,target:"_blank",rel:"noreferrer noopener"});let k;this.props.eventTileOps&&(h=u.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconQuote",label:Object(b.a)("Quote"),onClick:this.onQuoteClick})),"string"==typeof t.event.content.external_url&&Object(S.e)(t.event.content.external_url)&&(d=u.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconLink",onClick:this.closeMenu,label:Object(b.a)("Source URL"),element:"a",target:"_blank",rel:"noreferrer noopener",href:t.event.content.external_url})),this.props.collapseReplyThread&&(m=u.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconCollapse",label:Object(b.a)("Collapse reply thread"),onClick:this.onCollapseReplyThreadClick})),t.getSender()!==e&&(k=u.a.createElement(C.b,{iconClassName:"mx_MessageContextMenu_iconReport",label:Object(b.a)("Report"),onClick:this.onReportEventClick}));const O=u.a.createElement(C.c,null,h,a,c,E,k,d,l,y,i,m);return o&&(v=u.a.createElement(C.c,{red:!0},o)),u.a.createElement(C.e,r()({},this.props,{className:"mx_MessageContextMenu",compact:!0}),O,v)}},l()(i,"propTypes",{mxEvent:m.a.object.isRequired,eventTileOps:m.a.object,collapseReplyThread:m.a.func,onFinished:m.a.func,onCloseDialog:m.a.func}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(114),i=s(94),o=s(96);class a{static resendUnsentEvents(e){return Promise.all(e.getPendingEvents().filter((function(e){return e.status===n.a.NOT_SENT})).map((function(e){return a.resend(e)})))}static cancelUnsentEvents(e){e.getPendingEvents().filter((function(e){return e.status===n.a.NOT_SENT})).forEach((function(e){a.removeFromQueue(e)}))}static resend(e){const t=i.a.get().getRoom(e.getRoomId());return i.a.get().resendEvent(e,t).then((function(t){o.a.dispatch({action:"message_sent",event:e})}),(function(t){console.log("Resend got send failure: "+t.name+"("+t+")"),o.a.dispatch({action:"message_send_failed",event:e})}))}static removeFromQueue(e){i.a.get().cancelPendingEvent(e)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(91);const i=(e,t,s)=>{const[i,o]=Object(n.useState)(s);return Object(n.useEffect)(()=>{let t=!1;return e().then(e=>{t||o(e)}),()=>{t=!0}},t),i}},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(18),i=s.n(n),o=s(94),a=s(349),r=s(98),c=s(92),l=s(96),d=s(106),u=s(241);class h{constructor(){i()(this,"_lists",[]),i()(this,"_roomIds",[]),i()(this,"_mjolnirWatchRef",null),i()(this,"_dispatcherRef",null),i()(this,"_onAction",e=>{"setup_mjolnir"===e.action&&(console.log("Setting up Mjolnir: after sync"),this.setup())}),i()(this,"_onEvent",e=>{o.a.get()&&this._roomIds.includes(e.getRoomId())&&a.a.includes(e.getType())&&this._updateLists(this._roomIds)})}get roomIds(){return this._roomIds}get lists(){return this._lists}start(){this._mjolnirWatchRef=r.b.watchSetting("mjolnirRooms",null,this._onListsChanged.bind(this)),this._dispatcherRef=l.a.register(this._onAction),l.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"setup_mjolnir"}})}setup(){o.a.get()&&(this._updateLists(r.b.getValue("mjolnirRooms")),o.a.get().on("RoomState.events",this._onEvent))}stop(){this._mjolnirWatchRef&&(r.b.unwatchSetting(this._mjolnirWatchRef),this._mjolnirWatchRef=null),this._dispatcherRef&&(l.a.unregister(this._dispatcherRef),this._dispatcherRef=null),o.a.get()&&o.a.get().removeListener("RoomState.events",this._onEvent)}async getOrCreatePersonalList(){let e=r.b.getValue("mjolnirPersonalRoom");if(!e){const t=await o.a.get().createRoom({name:Object(c.a)("My Ban List"),topic:Object(c.a)("This is your list of users/servers you have blocked - don't leave the room!"),preset:u.a.PrivateChat});e=t.room_id,await r.b.setValue("mjolnirPersonalRoom",null,d.a.ACCOUNT,e),await r.b.setValue("mjolnirRooms",null,d.a.ACCOUNT,[e,...this._roomIds])}if(!e)throw new Error("Error finding a room ID to use");let t=this._lists.find(t=>t.roomId===e);return t||(t=new a.b(e)),t}getPersonalList(){const e=r.b.getValue("mjolnirPersonalRoom");if(!e)return null;let t=this._lists.find(t=>t.roomId===e);return t||(t=new a.b(e)),t}async subscribeToList(e){const t=[...this._roomIds,e];await r.b.setValue("mjolnirRooms",null,d.a.ACCOUNT,t),this._lists.push(new a.b(e))}async unsubscribeFromList(e){const t=this._roomIds.filter(t=>t!==e);await r.b.setValue("mjolnirRooms",null,d.a.ACCOUNT,t),this._lists=this._lists.filter(t=>t.roomId!==e)}_onListsChanged(e,t,s,n){this._updateLists(n)}_updateLists(e){if(o.a.get()&&(console.log("Updating Mjolnir ban lists to: "+e),this._lists=[],this._roomIds=e||[],e))for(const t of e)this._lists.push(new a.b(t))}isServerBanned(e){for(const t of this._lists)for(const s of t.serverRules)if(s.isMatch(e))return!0;return!1}isUserBanned(e){for(const t of this._lists)for(const s of t.userRules)if(s.isMatch(e))return!0;return!1}static sharedInstance(){return h._instance||(h._instance=new h),h._instance}}i()(h,"_instance",null)},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(92),a=s(105),r=s(150),c=s(98);const l=i.a.forwardRef(({mxEvent:e},t)=>{const s=Object(n.useContext)(a.a);let l=Object(o.a)("Message deleted");const d=e.getUnsigned(),u=d&&d.redacted_because&&d.redacted_because.sender;if(u&&u!==e.getSender()){const t=s.getRoom(e.getRoomId()),n=t&&t.getMember(u);l=Object(o.a)("Message deleted by %(name)s",{name:n?n.name:u})}const h=c.b.getValue("showTwelveHourTimestamps"),m=Object(r.b)(new Date(d.redacted_because.origin_server_ts),h),p=Object(o.a)("Message deleted on %(date)s",{date:m});return i.a.createElement("span",{className:"mx_RedactedBody",ref:t,title:p},l)});t.a=l},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(92),u=s(93);let h=Object(u.a)("views.rooms.PresenceLabel")((o=i=class extends l.a.Component{getDuration(e){if(!e)return;const t=Math.round(e/1e3),s=t%60,n=Math.round(t/60)%60,i=Math.round(t/3600)%24,o=Math.round(t/86400);return t<60?t<0?Object(d.a)("%(duration)ss",{duration:0}):Object(d.a)("%(duration)ss",{duration:s}):t<3600?Object(d.a)("%(duration)sm",{duration:n}):t<86400?Object(d.a)("%(duration)sh",{duration:i}):Object(d.a)("%(duration)sd",{duration:o})}getPrettyPresence(e,t,s){if(!s&&void 0!==t&&t>0){const s=this.getDuration(t);return"online"===e?Object(d.a)("Online for %(duration)s",{duration:s}):"unavailable"===e?Object(d.a)("Idle for %(duration)s",{duration:s}):"offline"===e?Object(d.a)("Offline for %(duration)s",{duration:s}):Object(d.a)("Unknown for %(duration)s",{duration:s})}return"online"===e?Object(d.a)("Online"):"unavailable"===e?Object(d.a)("Idle"):"offline"===e?Object(d.a)("Offline"):Object(d.a)("Unknown")}render(){return l.a.createElement("div",{className:"mx_PresenceLabel"},this.getPrettyPresence(this.props.presenceState,this.props.activeAgo,this.props.currentlyActive))}},r()(i,"defaultProps",{activeAgo:-1,presenceState:null}),n=o))||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return r}));var n=s(91),i=s(131),o=s(117);const a=(e,t=250)=>{const[s,a]=Object(n.useState)(e.getJoinedMembers());return Object(i.a)(e.currentState,"RoomState.members",Object(o.throttle)(()=>{a(e.getJoinedMembers())},t,{leading:!0,trailing:!0})),s},r=(e,t=250)=>{const[s,a]=Object(n.useState)(e.getJoinedMemberCount());return Object(i.a)(e.currentState,"RoomState.members",Object(o.throttle)(()=>{a(e.getJoinedMemberCount())},t,{leading:!0,trailing:!0})),s}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(95),l=s(92),d=s(94),u=s(118),h=s(99),m=s(102),p=s(93);let g=Object(p.a)("views.elements.ErrorBoundary")(n=class extends r.a.PureComponent{constructor(e){super(e),o()(this,"_onClearCacheAndReload",()=>{u.a.get()&&(d.a.get().stopClient(),d.a.get().store.deleteAllData().then(()=>{u.a.get().reload()}))}),o()(this,"_onBugReport",()=>{const e=c.getComponent("dialogs.BugReportDialog");e&&h.a.createTrackedDialog("Bug Report Dialog","",e,{label:"react-soft-crash"})}),this.state={error:null}}static getDerivedStateFromError(e){return{error:e}}componentDidCatch(e,{componentStack:t}){console.error(e),console.error("The above error occured while React was rendering the following components:",t)}render(){if(this.state.error){const e=c.getComponent("elements.AccessibleButton"),t="https://github.com/SchildiChat/schildichat-desktop/issues/new";let s;return m.a.get().bug_report_endpoint_url&&(s=r.a.createElement(r.a.Fragment,null,r.a.createElement("p",null,Object(l.a)("Please <newIssueLink>create a new issue</newIssueLink> on GitHub so that we can investigate this bug.",{},{newIssueLink:e=>r.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:t},e)})),r.a.createElement("p",null,Object(l.a)("If you've submitted a bug via GitHub, debug logs can help us track down the problem. Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited and the usernames of other users. They do not contain messages.")),r.a.createElement(e,{onClick:this._onBugReport,kind:"primary"},Object(l.a)("Submit debug logs")))),r.a.createElement("div",{className:"mx_ErrorBoundary"},r.a.createElement("div",{className:"mx_ErrorBoundary_body"},r.a.createElement("h1",null,Object(l.a)("Something went wrong!")),s,r.a.createElement(e,{onClick:this._onClearCacheAndReload,kind:"danger"},Object(l.a)("Clear cache and reload"))))}return this.props.children}})||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return M}));var n=s(91),i=s.n(n),o=s(101),a=s.n(o),r=s(105),c=s(596),l=s(204),d=s(92),u=s(129),h=s(100),m=s(96),p=s(103),g=s(126),v=s(99),f=s(415),b=s(131),y=s(140),_=s(183),E=s(98),S=s(205),w=s(419),C=s(113),k=s(217),O=s(420),R=s(187),I=s(116),x=s(109),T=s(352),j=s(412),N=s(190),P=s(191),D=s(154);const A=({children:e,className:t,onClick:s})=>i.a.createElement(h.a,{className:a()("mx_BaseCard_Button mx_RoomSummaryCard_Button",t),onClick:s},e),M=e=>{const[t,s]=Object(n.useState)(k.a.instance.getApps(e.roomId)),i=Object(n.useCallback)(()=>{s([...k.a.instance.getApps(e.roomId)])},[e]);return Object(n.useEffect)(i,[e,i]),Object(b.a)(k.a.instance,e.roomId,i),Object(b.a)(N.d.instance,N.d.emissionForRoom(e),i),t},U=({app:e,room:t})=>{const s=y.a.getWidgetName(e),n=y.a.getWidgetDataTitle(e),o=n&&" - "+n,r=N.d.instance.isInContainer(t,e,N.a.Top),c=r?()=>{N.d.instance.moveToContainer(t,e,N.a.Right)}:()=>{N.d.instance.moveToContainer(t,e,N.a.Top)},[l,u,h,v]=Object(x.q)();let f;if(l){const t=u.current.getBoundingClientRect();f=i.a.createElement(T.a,{chevronFace:x.a.None,right:D.b.instance.windowWidth-t.right,bottom:D.b.instance.windowHeight-t.top,onFinished:v,app:e})}const b=!r&&!N.d.instance.canAddToContainer(t,N.a.Top);let _;_=b?Object(d.a)("You can only pin up to %(count)s widgets",{count:N.b}):r?Object(d.a)("Unpin"):Object(d.a)("Pin");const E=a()("mx_BaseCard_Button mx_RoomSummaryCard_Button",{mx_RoomSummaryCard_Button_pinned:r});return i.a.createElement("div",{className:E,ref:u},i.a.createElement(C.a,{className:"mx_RoomSummaryCard_icon_app",onClick:()=>{m.a.dispatch({action:p.a.SetRightPanelPhase,phase:g.c.Widget,refireParams:{widgetId:e.id}})},title:r?Object(d.a)("Unpin a widget to view it in this panel"):"",forceHide:!r,disabled:r,yOffset:-48},i.a.createElement(w.a,{app:e}),i.a.createElement("span",null,s),o),i.a.createElement(x.d,{className:"mx_RoomSummaryCard_app_options",isExpanded:l,onClick:h,title:Object(d.a)("Options"),yOffset:-24}),i.a.createElement(C.a,{className:"mx_RoomSummaryCard_app_pinToggle",onClick:c,title:_,disabled:b,yOffset:-24}),f)},L=({room:e})=>{const t=M(e);let s=null;return t.length>0&&N.d.instance.canCopyLayoutToRoom(e)&&(s=i.a.createElement(h.a,{kind:"link",onClick:()=>N.d.instance.copyLayoutToRoom(e)},Object(d.a)("Set my room layout for everyone"))),i.a.createElement(l.a,{className:"mx_RoomSummaryCard_appsGroup",title:Object(d.a)("Widgets")},t.map(t=>i.a.createElement(U,{key:t.id,app:t,room:e})),s,i.a.createElement(h.a,{kind:"link",onClick:()=>{const t=_.a.sharedInstance();t.hasManager()?E.b.getValue("feature_many_integration_managers")?t.openAll(e):t.getPrimaryManager().open(e):t.openNoManagerDialog()}},t.length>0?Object(d.a)("Edit widgets, bridges & bots"):Object(d.a)("Add widgets, bridges & bots")))},F=()=>{m.a.dispatch({action:p.a.SetRightPanelPhase,phase:g.c.RoomMemberList})},B=()=>{m.a.dispatch({action:p.a.SetRightPanelPhase,phase:g.c.FilePanel})},V=()=>{m.a.dispatch({action:"open_room_settings"})};t.a=({room:e,onClose:t})=>{const s=Object(n.useContext)(r.a),o=Object(c.a)(s,e),h=Object(n.useContext)(R.a).e2eStatus,m=e.getCanonicalAlias()||e.getAltAliases()[0]||"",p=i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_RoomSummaryCard_avatar",role:"presentation"},i.a.createElement(u.a,{room:e,height:54,width:54,viewAvatarOnClick:!0}),i.a.createElement(S.a,{tooltip:o?Object(d.a)("Encrypted"):Object(d.a)("Not encrypted"),class:a()("mx_RoomSummaryCard_e2ee",{mx_RoomSummaryCard_e2ee_normal:o,mx_RoomSummaryCard_e2ee_warning:o&&h===O.a.Warning,mx_RoomSummaryCard_e2ee_verified:o&&h===O.a.Verified})})),i.a.createElement(P.a,{room:e},e=>i.a.createElement("h2",{title:e},e)),i.a.createElement("div",{className:"mx_RoomSummaryCard_alias",title:m},m)),g=Object(j.a)(e);return i.a.createElement(l.b,{header:p,className:"mx_RoomSummaryCard",onClose:t},i.a.createElement(l.a,{title:Object(d.a)("About"),className:"mx_RoomSummaryCard_aboutGroup"},i.a.createElement(A,{className:"mx_RoomSummaryCard_icon_people",onClick:F},Object(d.a)("%(count)s people",{count:g})),i.a.createElement(A,{className:"mx_RoomSummaryCard_icon_files",onClick:B},Object(d.a)("Show files")),i.a.createElement(A,{className:"mx_RoomSummaryCard_icon_share",onClick:()=>{v.a.createTrackedDialog("share room dialog","",f.a,{target:e})}},Object(d.a)("Share room")),i.a.createElement(A,{className:"mx_RoomSummaryCard_icon_settings",onClick:V},Object(d.a)("Room settings"))),E.b.getValue(I.a.Widgets)&&i.a.createElement(L,{room:e}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return x}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s(97),d=s(230),u=s(210),h=s(239),m=s(168),p=s(114),g=s(95),v=s(92),f=s(416),b=s(122),y=s(109),_=s(142),E=s(148),S=s(113),w=s(98),C=s(116),k=s(93);function O(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function R(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?O(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):O(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const I=[{name:"Facebook",img:s(994),url:e=>"https://www.facebook.com/sharer/sharer.php?u="+e},{name:"Twitter",img:s(995),url:e=>"https://twitter.com/home?status="+e},{name:"LinkedIn",img:s(996),url:e=>"https://www.linkedin.com/shareArticle?mini=true&url="+e},{name:"Reddit",img:s(997),url:e=>"http://www.reddit.com/submit?url="+e},{name:"email",img:s(998),url:e=>"mailto:?body="+e}];let x=Object(k.a)("views.dialogs.ShareDialog")((o=i=class e extends c.PureComponent{constructor(e){super(e),r()(this,"closeCopiedTooltip",void 0),this.onCopyClick=this.onCopyClick.bind(this),this.onLinkSpecificEventCheckboxClick=this.onLinkSpecificEventCheckboxClick.bind(this);let t=null;e.target instanceof d.b&&(t=new b.a(e.target),t.load()),this.state={linkSpecificEvent:this.props.target instanceof p.b,permalinkCreator:t}}static onLinkClick(e){e.preventDefault(),Object(_.d)(e.target)}async onCopyClick(e){e.preventDefault();const t=e.target,s=await Object(_.c)(this.getUrl()),n=t.getBoundingClientRect(),i=g.getComponent("context_menus.GenericTextContextMenu"),{close:o}=y.n(i,R(R({},Object(y.p)(n,2)),{},{message:s?Object(v.a)("Copied!"):Object(v.a)("Failed to copy")}));this.closeCopiedTooltip=t.onmouseleave=o}onLinkSpecificEventCheckboxClick(){this.setState({linkSpecificEvent:!this.state.linkSpecificEvent})}componentWillUnmount(){this.closeCopiedTooltip&&this.closeCopiedTooltip()}getUrl(){let e;if(this.props.target instanceof d.b)if(this.state.linkSpecificEvent){const t=this.props.target.getLiveTimeline().getEvents();e=this.state.permalinkCreator.forEvent(t[t.length-1].getId())}else e=this.state.permalinkCreator.forShareableRoom();else this.props.target instanceof u.a||this.props.target instanceof m.a?e=Object(b.h)(this.props.target.userId):this.props.target instanceof h.a?e=Object(b.f)(this.props.target.groupId):this.props.target instanceof p.b&&(e=this.state.linkSpecificEvent?this.props.permalinkCreator.forEvent(this.props.target.getId()):this.props.permalinkCreator.forRoom());return e}render(){let t,s;if(this.props.target instanceof d.b){t=Object(v.a)("Share Room");this.props.target.getLiveTimeline().getEvents().length>0&&(s=c.createElement("div",null,c.createElement(E.a,{checked:this.state.linkSpecificEvent,onChange:this.onLinkSpecificEventCheckboxClick},Object(v.a)("Link to most recent message"))))}else this.props.target instanceof u.a||this.props.target instanceof m.a?t=Object(v.a)("Share User"):this.props.target instanceof h.a?t=Object(v.a)("Share Community"):this.props.target instanceof p.b&&(t=Object(v.a)("Share Room Message"),s=c.createElement("div",null,c.createElement(E.a,{checked:this.state.linkSpecificEvent,onClick:this.onLinkSpecificEventCheckboxClick},Object(v.a)("Link to selected message"))));const n=this.getUrl(),i=encodeURIComponent(n),o=w.b.getValue(C.a.ShareQRCode),a=w.b.getValue(C.a.ShareSocial);let r;(o||a)&&(r=c.createElement(c.Fragment,null,c.createElement("hr",null),c.createElement("div",{className:"mx_ShareDialog_split"},o&&c.createElement("div",{className:"mx_ShareDialog_qrcode_container"},c.createElement(f.a,{data:n,width:256})),a&&c.createElement("div",{className:"mx_ShareDialog_social_container"},I.map(e=>c.createElement("a",{rel:"noreferrer noopener",target:"_blank",key:e.name,title:e.name,href:e.url(i),className:"mx_ShareDialog_social_icon"},c.createElement("img",{src:e.img,alt:e.name,height:64,width:64})))))));const l=g.getComponent("views.dialogs.BaseDialog");return c.createElement(l,{title:t,className:"mx_ShareDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},c.createElement("div",{className:"mx_ShareDialog_content"},c.createElement("div",{className:"mx_ShareDialog_matrixto"},c.createElement("a",{href:n,onClick:e.onLinkClick,className:"mx_ShareDialog_matrixto_link"},n),c.createElement(S.a,{title:Object(v.a)("Copy"),onClick:this.onCopyClick,className:"mx_ShareDialog_matrixto_copy"})),s,r))}},r()(i,"propTypes",{onFinished:l.func.isRequired,target:l.oneOfType([l.instanceOf(d.b),l.instanceOf(u.a),l.instanceOf(h.a),l.instanceOf(m.a),l.instanceOf(p.b)]).isRequired}),n=o))||n},function(e,t,s){"use strict";var n=s(18),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s(973),l=s(101),d=s.n(l),u=s(92),h=s(119);function m(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function p(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?m(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const g={errorCorrectionLevel:"L"};t.a=e=>{let{data:t,className:s}=e,n=a()(e,["data","className"]);const[i,o]=r.useState(null);return r.useEffect(()=>{let e=!1;return Object(c.toDataURL)(t,p(p({},g),n)).then(t=>{e||o(t)}),()=>{e=!0}},[JSON.stringify(t),n]),r.createElement("div",{className:d()("mx_QRCode",s)},i?r.createElement("img",{src:i,className:"mx_VerificationQRCode",alt:Object(u.a)("QR Code")}):r.createElement(h.a,null))}},,,function(e,t,s){"use strict";var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(101),d=s.n(l),u=s(130),h=s(107);t.a=e=>{let{app:t,className:n,width:o=20,height:r=20}=e,l=a()(e,["app","className","width","height"]),m=[s(999)];return t.type.includes("jitsi")?m=[s(1e3)]:t.type.includes("meeting")||t.type.includes("calendar")?m=[s(1001)]:t.type.includes("pad")||t.type.includes("doc")||t.type.includes("calc")?m=[s(1002)]:t.type.includes("clock")&&(m=[s(1003)]),c.a.createElement(u.a,i()({},l,{name:t.id,className:d()("mx_WidgetAvatar",n),url:t.avatar_url?Object(h.b)(t.avatar_url).getSquareThumbnailHttp(20):void 0,urls:m,width:o,height:r}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o}));var n=s(127);let i;async function o(e,t){const s=(await t.getEncryptionTargetMembers()).map(({userId:e})=>e),o=!!n.a.shared().getUserIdForRoomId(t.roomId),a=[],r=[];s.filter(t=>t!==e.getUserId()).forEach(t=>{(e.checkUserTrust(t).isCrossSigningVerified()?a:r).push(t)});for(const t of r)if(e.checkUserTrust(t).wasCrossSigningVerified())return i.Warning;const c=a.length>0&&!o&&2!==s.length||1===s.length?[...a,e.getUserId()]:a;for(const t of c){if(e.getStoredDevicesForUser(t).some(({deviceId:s})=>!e.checkDeviceTrust(t,s).isVerified()))return i.Warning}return 0===r.length?i.Verified:i.Normal}!function(e){e.Warning="warning",e.Verified="verified",e.Normal="normal"}(i||(i={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(18),i=s.n(n),o=s(164),a=s(252);class r extends o.a{getValueOverride(e,t,s,n){if(!s)return null;if(r.isLogin)return"light";return Object(a.b)()[s]?null:a.a}}i()(r,"isLogin",!1)},function(e,t,s){"use strict";s.d(t,"b",(function(){return h})),s.d(t,"a",(function(){return m}));var n=s(91),i=s.n(n),o=s(99),a=s(95),r=s(310),c=s(92),l=s(94),d=s(128),u=s(148);function h(e){return new Promise((t,s)=>{const n=i.a.createElement("div",null,i.a.createElement("div",null,Object(c.a)("Who would you like to add to this community?")),i.a.createElement("div",{className:"warning"},Object(c.a)("Warning: any person you add to a community will be publicly visible to anyone who knows the community ID"))),l=a.getComponent("dialogs.AddressPickerDialog");o.a.createTrackedDialog("Group Invite","",l,{title:Object(c.a)("Invite new community members"),description:n,placeholder:Object(c.a)("Name or Matrix ID"),button:Object(c.a)("Invite to Community"),validAddressTypes:["mx-user-id"],onFinished:(n,i)=>{n&&function(e,t){const s=new r.a(e),n=t.map(e=>e.address);return s.invite(n).then(s=>{const n=[];for(const e of Object.keys(s))"error"===t[e]&&n.push(e);if(n.length>0){const t=a.getComponent("dialogs.ErrorDialog");o.a.createTrackedDialog("Failed to invite the following users to the group","",t,{title:Object(c.a)("Failed to invite the following users to %(groupId)s:",{groupId:e}),description:n.join(", ")})}}).catch(t=>{const s=a.getComponent("dialogs.ErrorDialog");o.a.createTrackedDialog("Failed to invite users to group","",s,{title:Object(c.a)("Failed to invite users to community"),description:Object(c.a)("Failed to invite users to %(groupId)s",{groupId:e})})})}(e,i).then(t,s)}},null,!1,!0)})}function m(e){return new Promise((t,s)=>{let n=!1;const r=i.a.createElement("div",null,i.a.createElement("div",null,Object(c.a)("Which rooms would you like to add to this community?"))),h=i.a.createElement(u.a,{className:"mx_GroupAddressPicker_checkboxContainer",onChange:e=>{n=e.target.checked}},Object(c.a)("Show these rooms to non-members on the community page and room list?")),m=a.getComponent("dialogs.AddressPickerDialog");o.a.createTrackedDialog("Add Rooms to Group","",m,{title:Object(c.a)("Add rooms to the community"),description:r,extraNode:h,placeholder:Object(c.a)("Room name or address"),button:Object(c.a)("Add to community"),pickerType:"room",validAddressTypes:["mx-room-id"],onFinished:(i,r)=>{i&&function(e,t,s){const n=l.a.get(),i=[];return Promise.allSettled(t.map(t=>d.a.addRoomToGroup(e,t.address,s).catch(()=>{i.push(t.address)}).then(()=>{const s=t.address,i=n.getRoom(s);if(!i||!i.currentState.mayClientSendStateEvent("m.room.related_groups",n))return;const o=i.currentState.getStateEvents("m.room.related_groups",""),a=o&&o.getContent().groups||[];return a.includes(e)?void 0:(a.push(e),l.a.get().sendStateEvent(s,"m.room.related_groups",{groups:a},""))}))).then(()=>{if(0===i.length)return;const t=a.getComponent("dialogs.ErrorDialog");o.a.createTrackedDialog("Failed to add the following room to the group","",t,{title:Object(c.a)("Failed to add the following rooms to %(groupId)s:",{groupId:e}),description:i.join(", ")})})}(e,r,n).then(t,s)}},null,!1,!0)})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(91),i=s.n(n),o=s(95),a=s(92);const r=({text:e})=>{const t=o.getComponent("elements.Spinner");return i.a.createElement("div",{className:"mx_EncryptionInfo_spinner"},i.a.createElement(t,null),e)};t.b=({waitingForOtherParty:e,waitingForNetwork:t,member:s,onStartVerification:n,isRoomEncrypted:c,inDialog:l,isSelfVerification:d})=>{let u,h;if(e||t){let t;t=e?d?Object(a.a)("Accept on your other login…"):Object(a.a)("Waiting for %(displayName)s to accept…",{displayName:s.displayName||s.name||s.userId}):Object(a.a)("Accepting…"),u=i.a.createElement(r,{text:t})}else{const e=o.getComponent("elements.AccessibleButton");u=i.a.createElement(e,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:n},Object(a.a)("Start Verification"))}return h=c?i.a.createElement("div",null,i.a.createElement("p",null,Object(a.a)("Messages in this room are end-to-end encrypted.")),i.a.createElement("p",null,Object(a.a)("Your messages are secured and only you and the recipient have the unique keys to unlock them."))):i.a.createElement("div",null,i.a.createElement("p",null,Object(a.a)("Messages in this room are not end-to-end encrypted.")),i.a.createElement("p",null,Object(a.a)("In encrypted rooms, your messages are secured and only you and the recipient have the unique keys to unlock them."))),l?u:i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(a.a)("Encryption")),h),i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(a.a)("Verify User")),i.a.createElement("div",null,i.a.createElement("p",null,Object(a.a)("For extra security, verify this user by checking a one-time code on both of your devices.")),i.a.createElement("p",null,Object(a.a)("To be secure, do this in person or use a trusted way to communicate.")),u)))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(93),m=s(416);let p=Object(h.a)("views.elements.crypto.VerificationQRCode")((o=i=class extends l.a.PureComponent{render(){return l.a.createElement(m.a,{data:[{data:this.props.qrCodeData.buffer,mode:"byte"}],className:"mx_VerificationQRCode",width:196})}},r()(i,"propTypes",{qrCodeData:u.a.object.isRequired}),n=o))||n},function(e,t){e.exports="img/e2e/warning.78bb264.svg"},,function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(97),l=s.n(c),d=s(101),u=s.n(d),h=s(100),m=s(92),p=s(111),g=s(93);class v extends r.a.Component{constructor(e){super(e),this._onMouseEnter=this._onMouseEnter.bind(this),this._onClick=this._onClick.bind(this)}_onMouseEnter(){this.props.onMouseEnter(this.props.dropdownKey)}_onClick(e){e.preventDefault(),e.stopPropagation(),this.props.onClick(this.props.dropdownKey)}render(){const e=u()({mx_Dropdown_option:!0,mx_Dropdown_option_highlight:this.props.highlighted});return r.a.createElement("div",{id:this.props.id,className:e,onClick:this._onClick,onMouseEnter:this._onMouseEnter,role:"option","aria-selected":this.props.highlighted,ref:this.props.inputRef},this.props.children)}}o()(v,"defaultProps",{disabled:!1}),v.propTypes={children:l.a.oneOfType([l.a.arrayOf(l.a.node),l.a.node]),highlighted:l.a.bool,dropdownKey:l.a.string,onClick:l.a.func.isRequired,onMouseEnter:l.a.func.isRequired,inputRef:l.a.any};let f=Object(g.a)("views.elements.Dropdown")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"_onInputKeyDown",e=>{let t=!0;switch(e.key){case p.a.ENTER:this.props.onOptionChange(this.state.highlightedOption);case p.a.ESCAPE:this._close();break;case p.a.ARROW_DOWN:this.setState({highlightedOption:this._nextOption(this.state.highlightedOption)});break;case p.a.ARROW_UP:this.setState({highlightedOption:this._prevOption(this.state.highlightedOption)});break;default:t=!1}t&&(e.preventDefault(),e.stopPropagation())}),this.dropdownRootElement=null,this.ignoreEvent=null,this._onInputClick=this._onInputClick.bind(this),this._onRootClick=this._onRootClick.bind(this),this._onDocumentClick=this._onDocumentClick.bind(this),this._onMenuOptionClick=this._onMenuOptionClick.bind(this),this._onInputChange=this._onInputChange.bind(this),this._collectRoot=this._collectRoot.bind(this),this._collectInputTextBox=this._collectInputTextBox.bind(this),this._setHighlightedOption=this._setHighlightedOption.bind(this),this.inputTextBox=null,this._reindexChildren(this.props.children);const t=r.a.Children.toArray(e.children)[0];this.state={expanded:!1,highlightedOption:t?t.key:null,searchQuery:""}}UNSAFE_componentWillMount(){this._button=Object(a.createRef)(),document.addEventListener("click",this._onDocumentClick,!1)}componentWillUnmount(){document.removeEventListener("click",this._onDocumentClick,!1)}UNSAFE_componentWillReceiveProps(e){if(!e.children||0===e.children.length)return;this._reindexChildren(e.children);const t=e.children[0];this.setState({highlightedOption:t?t.key:null})}_reindexChildren(e){this.childrenByKey={},r.a.Children.forEach(e,e=>{this.childrenByKey[e.key]=e})}_onDocumentClick(e){e!==this.ignoreEvent&&this.setState({expanded:!1})}_onRootClick(e){this.ignoreEvent=e}_onInputClick(e){this.props.disabled||this.state.expanded||(this.setState({expanded:!0}),e.preventDefault())}_close(){this.setState({expanded:!1}),this._button.current&&this._button.current.focus()}_onMenuOptionClick(e){this._close(),this.props.onOptionChange(e)}_onInputChange(e){this.setState({searchQuery:e.target.value}),this.props.onSearchChange&&this.props.onSearchChange(e.target.value)}_collectRoot(e){this.dropdownRootElement&&this.dropdownRootElement.removeEventListener("click",this._onRootClick,!1),e&&e.addEventListener("click",this._onRootClick,!1),this.dropdownRootElement=e}_collectInputTextBox(e){this.inputTextBox=e,e&&e.focus()}_setHighlightedOption(e){this.setState({highlightedOption:e})}_nextOption(e){const t=Object.keys(this.childrenByKey),s=t.indexOf(e);return t[(s+1)%t.length]}_prevOption(e){const t=Object.keys(this.childrenByKey),s=t.indexOf(e);return t[(s-1)%t.length]}_scrollIntoView(e){e&&e.scrollIntoView({block:"nearest",behavior:"auto"})}_getMenuOptions(){const e=r.a.Children.map(this.props.children,e=>{const t=this.state.highlightedOption===e.key;return r.a.createElement(v,{id:`${this.props.id}__${e.key}`,key:e.key,dropdownKey:e.key,highlighted:t,onMouseEnter:this._setHighlightedOption,onClick:this._onMenuOptionClick,inputRef:t?this._scrollIntoView:void 0},e)});return 0===e.length?[r.a.createElement("div",{key:"0",className:"mx_Dropdown_option",role:"option"},Object(m.a)("No results"))]:e}render(){let e;const t={};let s;if(this.props.menuWidth&&(t.width=this.props.menuWidth),this.state.expanded&&(this.props.searchEnabled&&(e=r.a.createElement("input",{type:"text",className:"mx_Dropdown_option",ref:this._collectInputTextBox,onKeyDown:this._onInputKeyDown,onChange:this._onInputChange,value:this.state.searchQuery,role:"combobox","aria-autocomplete":"list","aria-activedescendant":`${this.props.id}__${this.state.highlightedOption}`,"aria-owns":this.props.id+"_listbox","aria-disabled":this.props.disabled,"aria-label":this.props.label})),s=r.a.createElement("div",{className:"mx_Dropdown_menu",style:t,role:"listbox",id:this.props.id+"_listbox"},this._getMenuOptions())),!e){const t=this.props.getShortOption?this.props.getShortOption(this.props.value):this.childrenByKey[this.props.value];e=r.a.createElement("div",{className:"mx_Dropdown_option",id:this.props.id+"_value"},t)}const n={mx_Dropdown:!0,mx_Dropdown_disabled:this.props.disabled};return this.props.className&&(n[this.props.className]=!0),r.a.createElement("div",{className:u()(n),ref:this._collectRoot},r.a.createElement(h.a,{className:"mx_Dropdown_input mx_no_textinput",onClick:this._onInputClick,"aria-haspopup":"listbox","aria-expanded":this.state.expanded,disabled:this.props.disabled,inputRef:this._button,"aria-label":this.props.label,"aria-describedby":this.props.id+"_value"},e,r.a.createElement("span",{className:"mx_Dropdown_arrow"}),s))}})||n;f.propTypes={id:l.a.string.isRequired,menuWidth:l.a.number,onOptionChange:l.a.func.isRequired,onSearchChange:l.a.func,searchEnabled:l.a.bool,getShortOption:l.a.func,value:l.a.string,disabled:l.a.bool,label:l.a.string.isRequired}},function(e,t,s){"use strict";s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return d}));var n=s(92),i=s(253),o=s(165),a=s(144);const r=()=>{i.default.setEnabled(!0)},c=()=>{i.default.setPromptHidden(!0)},l=e=>{a.a.sharedInstance().addOrReplaceToast({key:"desktopnotifications",title:e?Object(n.a)("Don't miss a reply"):Object(n.a)("Notifications"),props:{description:Object(n.a)("Enable desktop notifications"),acceptLabel:Object(n.a)("Enable"),onAccept:r,rejectLabel:Object(n.a)("Dismiss"),onReject:c},component:o.a,priority:30})},d=()=>{a.a.sharedInstance().dismissToast("desktopnotifications")}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(18),i=s.n(n),o=s(96),a=s(254);class r{constructor(e,t){this.window=e,this.document=t,i()(this,"activeNowTimeout",void 0),i()(this,"activeRecentlyTimeout",void 0),i()(this,"attachedActiveNowTimers",[]),i()(this,"attachedActiveRecentlyTimers",[]),i()(this,"lastScreenX",0),i()(this,"lastScreenY",0),i()(this,"onPageVisibilityChanged",e=>{"hidden"===this.document.visibilityState?(this.activeNowTimeout.abort(),this.activeRecentlyTimeout.abort()):this.onUserActivity(e)}),i()(this,"onWindowBlurred",()=>{this.activeNowTimeout.abort(),this.activeRecentlyTimeout.abort()}),i()(this,"onUserActivity",e=>{if(this.document.hasFocus()){if(e.screenX&&"mousemove"===e.type){if(e.screenX===this.lastScreenX&&e.screenY===this.lastScreenY)return;this.lastScreenX=e.screenX,this.lastScreenY=e.screenY}o.a.dispatch({action:"user_activity"}),this.activeNowTimeout.isRunning()?this.activeNowTimeout.restart():(this.activeNowTimeout.start(),o.a.dispatch({action:"user_activity_start"}),r.runTimersUntilTimeout(this.attachedActiveNowTimers,this.activeNowTimeout)),this.activeRecentlyTimeout.isRunning()?this.activeRecentlyTimeout.restart():(this.activeRecentlyTimeout.start(),r.runTimersUntilTimeout(this.attachedActiveRecentlyTimers,this.activeRecentlyTimeout))}}),this.activeNowTimeout=new a.a(700),this.activeRecentlyTimeout=new a.a(12e4)}static sharedInstance(){return void 0===window.mxUserActivity&&(window.mxUserActivity=new r(window,document)),window.mxUserActivity}timeWhileActiveNow(e){this.timeWhile(e,this.attachedActiveNowTimers),this.userActiveNow()&&e.start()}timeWhileActiveRecently(e){this.timeWhile(e,this.attachedActiveRecentlyTimers),this.userActiveRecently()&&e.start()}timeWhile(e,t){-1===t.indexOf(e)&&(t.push(e),e.finished().finally(()=>{const s=t.indexOf(e);-1!==s&&t.splice(s,1)}).catch(e=>{}))}start(){this.document.addEventListener("mousedown",this.onUserActivity),this.document.addEventListener("mousemove",this.onUserActivity),this.document.addEventListener("keydown",this.onUserActivity),this.document.addEventListener("visibilitychange",this.onPageVisibilityChanged),this.window.addEventListener("blur",this.onWindowBlurred),this.window.addEventListener("focus",this.onUserActivity),this.window.addEventListener("wheel",this.onUserActivity,{passive:!0,capture:!0})}stop(){this.document.removeEventListener("mousedown",this.onUserActivity),this.document.removeEventListener("mousemove",this.onUserActivity),this.document.removeEventListener("keydown",this.onUserActivity),this.window.removeEventListener("wheel",this.onUserActivity,{capture:!0}),this.document.removeEventListener("visibilitychange",this.onPageVisibilityChanged),this.window.removeEventListener("blur",this.onWindowBlurred),this.window.removeEventListener("focus",this.onUserActivity)}userActiveNow(){return this.activeNowTimeout.isRunning()}userActiveRecently(){return this.activeRecentlyTimeout.isRunning()}static async runTimersUntilTimeout(e,t){e.forEach(e=>e.start());try{await t.finished()}catch(e){}e.forEach(e=>e.abort())}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(92),m=s(94),p=s(99),g=s(431),v=s(95),f=s(432),b=s(93);let y=Object(b.a)("structures.auth.SetupEncryptionBody")((o=i=class extends l.a.Component{constructor(){super(),r()(this,"_onStoreUpdate",()=>{const e=f.b.sharedInstance();e.phase!==f.a.Finished?this.setState({phase:e.phase,verificationRequest:e.verificationRequest,backupInfo:e.backupInfo}):this.props.onFinished()}),r()(this,"_onUsePassphraseClick",async()=>{f.b.sharedInstance().usePassPhrase()}),r()(this,"_onVerifyClick",()=>{const e=m.a.get(),t=e.getUserId(),s=e.requestVerification(t);this.props.onFinished(!0),p.a.createTrackedDialog("New Session Verification","Starting dialog",g.a,{verificationRequestPromise:s,member:e.getUser(t),onFinished:async()=>{(await s).cancel()}})}),r()(this,"onSkipClick",()=>{f.b.sharedInstance().skip()}),r()(this,"onSkipConfirmClick",()=>{f.b.sharedInstance().skipConfirm()}),r()(this,"onSkipBackClick",()=>{f.b.sharedInstance().returnAfterSkip()}),r()(this,"onDoneClick",()=>{f.b.sharedInstance().done()});const e=f.b.sharedInstance();e.on("update",this._onStoreUpdate),e.start(),this.state={phase:e.phase,verificationRequest:e.verificationRequest,backupInfo:e.backupInfo}}componentWillUnmount(){const e=f.b.sharedInstance();e.off("update",this._onStoreUpdate),e.stop()}render(){const e=v.getComponent("elements.AccessibleButton"),{phase:t}=this.state;if(this.state.verificationRequest){const e=v.getComponent("views.right_panel.EncryptionPanel");return l.a.createElement(e,{layout:"dialog",verificationRequest:this.state.verificationRequest,onClose:this.props.onFinished,member:m.a.get().getUser(this.state.verificationRequest.otherUserId)})}if(t===f.a.Intro){const t=f.b.sharedInstance();let n,i,o;return t.keyInfo&&((s=t.keyInfo).passphrase&&s.passphrase.salt&&s.passphrase.iterations)?n=Object(h.a)("Use Security Key or Phrase"):t.keyInfo&&(n=Object(h.a)("Use Security Key")),n&&(i=l.a.createElement(e,{kind:"link",onClick:this._onUsePassphraseClick},n)),t.hasDevicesToVerifyAgainst&&(o=l.a.createElement(e,{kind:"primary",onClick:this._onVerifyClick},Object(h.a)("Use another login"))),l.a.createElement("div",null,l.a.createElement("p",null,Object(h.a)("Verify your identity to access encrypted messages and prove your identity to others.")),l.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o,i,l.a.createElement(e,{kind:"danger",onClick:this.onSkipClick},Object(h.a)("Skip"))))}if(t===f.a.Done){let t;return t=this.state.backupInfo?l.a.createElement("p",null,Object(h.a)("Your new session is now verified. It has access to your encrypted messages, and other users will see it as trusted.")):l.a.createElement("p",null,Object(h.a)("Your new session is now verified. Other users will see it as trusted.")),l.a.createElement("div",null,l.a.createElement("div",{className:"mx_CompleteSecurity_heroIcon mx_E2EIcon_verified"}),t,l.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},l.a.createElement(e,{kind:"primary",onClick:this.onDoneClick},Object(h.a)("Done"))))}if(t===f.a.ConfirmSkip)return l.a.createElement("div",null,l.a.createElement("p",null,Object(h.a)("Without verifying, you won’t have access to all your messages and may appear as untrusted to others.")),l.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},l.a.createElement(e,{className:"warning",kind:"secondary",onClick:this.onSkipConfirmClick},Object(h.a)("Skip")),l.a.createElement(e,{kind:"danger",onClick:this.onSkipBackClick},Object(h.a)("Go Back"))));if(t===f.a.Busy||t===f.a.Loading){const e=v.getComponent("views.elements.Spinner");return l.a.createElement(e,null)}var s;console.log("SetupEncryptionBody: Unknown phase "+t)}},r()(i,"propTypes",{onFinished:u.a.func.isRequired}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(94),m=s(95),p=s(92),g=s(93);let v=Object(g.a)("views.dialogs.VerificationRequestDialog")((o=i=class extends l.a.Component{constructor(...e){super(...e),this.state={},this.props.verificationRequest?this.state.verificationRequest=this.props.verificationRequest:this.props.verificationRequestPromise&&this.props.verificationRequestPromise.then(e=>{this.setState({verificationRequest:e})})}render(){const e=m.getComponent("views.dialogs.BaseDialog"),t=m.getComponent("views.right_panel.EncryptionPanel"),s=this.state.verificationRequest,n=s&&s.otherUserId,i=this.props.member||n&&h.a.get().getUser(n),o=s&&s.isSelfVerification?Object(p.a)("Verify other login"):Object(p.a)("Verification Request");return l.a.createElement(e,{className:"mx_InfoDialog",onFinished:this.props.onFinished,contentId:"mx_Dialog_content",title:o,hasCancel:!0},l.a.createElement(t,{layout:"dialog",verificationRequest:this.props.verificationRequest,verificationRequestPromise:this.props.verificationRequestPromise,onClose:this.props.onFinished,member:i}))}},r()(i,"propTypes",{verificationRequest:u.a.object,verificationRequestPromise:u.a.object,onFinished:u.a.func.isRequired,member:u.a.string}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return d})),s.d(t,"b",(function(){return u}));var n=s(18),i=s.n(n),o=s(8),a=s.n(o),r=s(94),c=s(181),l=s(216);let d;!function(e){e[e.Loading=0]="Loading",e[e.Intro=1]="Intro",e[e.Busy=2]="Busy",e[e.Done=3]="Done",e[e.ConfirmSkip=4]="ConfirmSkip",e[e.Finished=5]="Finished"}(d||(d={}));class u extends a.a{constructor(...e){super(...e),i()(this,"started",void 0),i()(this,"phase",void 0),i()(this,"verificationRequest",void 0),i()(this,"backupInfo",void 0),i()(this,"keyId",void 0),i()(this,"keyInfo",void 0),i()(this,"hasDevicesToVerifyAgainst",void 0),i()(this,"onUserTrustStatusChanged",e=>{if(e!==r.a.get().getUserId())return;r.a.get().getCrossSigningId()&&(this.phase=d.Done,this.emit("update"))}),i()(this,"onVerificationRequest",e=>{this.setActiveVerificationRequest(e)}),i()(this,"onVerificationRequestChange",()=>{if(this.verificationRequest.cancelled)this.verificationRequest.off("change",this.onVerificationRequestChange),this.verificationRequest=null,this.emit("update");else if(this.verificationRequest.phase===l.c){this.verificationRequest.off("change",this.onVerificationRequestChange),this.verificationRequest=null;const e=r.a.get().getCrossSigningId();this.phase=e?d.Done:d.Busy,this.emit("update")}})}static sharedInstance(){return window.mxSetupEncryptionStore||(window.mxSetupEncryptionStore=new u),window.mxSetupEncryptionStore}start(){if(this.started)return;this.started=!0,this.phase=d.Loading,this.verificationRequest=null,this.backupInfo=null,this.keyId=null,this.keyInfo=null;const e=r.a.get();e.on("crypto.verification.request",this.onVerificationRequest),e.on("userTrustStatusChanged",this.onUserTrustStatusChanged);const t=e.getVerificationRequestsToDeviceInProgress(e.getUserId());t.length&&this.setActiveVerificationRequest(t[t.length-1]),this.fetchKeyInfo()}stop(){this.started&&(this.started=!1,this.verificationRequest&&this.verificationRequest.off("change",this.onVerificationRequestChange),r.a.get()&&(r.a.get().removeListener("crypto.verification.request",this.onVerificationRequest),r.a.get().removeListener("userTrustStatusChanged",this.onUserTrustStatusChanged)))}async fetchKeyInfo(){const e=r.a.get(),t=await e.isSecretStored("m.cross_signing.master",!1);null===t||0===Object.keys(t).length?(this.keyId=null,this.keyInfo=null):(this.keyId=Object.keys(t)[0],this.keyInfo=t[this.keyId]);const s=await e.getDehydratedDevice();this.hasDevicesToVerifyAgainst=e.getStoredDevicesForUser(e.getUserId()).some(e=>e.getIdentityKey()&&(!s||e.deviceId!=s.device_id)),this.hasDevicesToVerifyAgainst||this.keyInfo?this.phase=d.Intro:this.phase=d.Finished,this.emit("update")}async usePassPhrase(){this.phase=d.Busy,this.emit("update");const e=r.a.get();try{const t=await e.getKeyBackupVersion();this.backupInfo=t,this.emit("update"),await new Promise((s,n)=>{Object(c.b)(async()=>{await e.checkOwnCrossSigningTrust(),s(),t&&await e.restoreKeyBackupWithSecretStorage(t)}).catch(n)}),e.getCrossSigningId()&&(this.phase=d.Done,this.emit("update"))}catch(e){e instanceof c.a||console.log(e),this.phase=d.Intro,this.emit("update")}}skip(){this.phase=d.ConfirmSkip,this.emit("update")}skipConfirm(){this.phase=d.Finished,this.emit("update")}returnAfterSkip(){this.phase=d.Intro,this.emit("update")}done(){this.phase=d.Finished,this.emit("update"),r.a.get().crypto.cancelAndResendAllOutgoingKeyRequests()}async setActiveVerificationRequest(e){e.otherUserId===r.a.get().getUserId()&&(this.verificationRequest&&this.verificationRequest.off("change",this.onVerificationRequestChange),this.verificationRequest=e,await e.accept(),e.on("change",this.onVerificationRequestChange),this.emit("update"))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(101),l=s.n(c),d=s(185),u=s(92),h=s(93);let m=Object(h.a)("views.elements.InfoTooltip")(n=class extends r.a.PureComponent{constructor(e){super(e),o()(this,"onMouseOver",()=>{this.setState({hover:!0})}),o()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const{tooltip:e,children:t,tooltipClassName:s}=this.props,n=Object(u.a)("Information"),i=this.state.hover?r.a.createElement(d.b,{className:"mx_InfoTooltip_container",tooltipClassName:l()("mx_InfoTooltip_tooltip",s),label:e||n,alignment:d.a.Right}):r.a.createElement("div",null);return r.a.createElement("div",{onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,className:"mx_InfoTooltip"},r.a.createElement("span",{className:"mx_InfoTooltip_icon","aria-label":n}),t,i)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i=s(18),o=s.n(i),a=s(91),r=s(100),c=s(93);const l=["1","2","3","4","5","6","7","8","9","*","0","#"];var d;!function(e){e[e.Digit=0]="Digit",e[e.Delete=1]="Delete",e[e.Dial=2]="Dial"}(d||(d={}));class u extends a.PureComponent{constructor(...e){super(...e),o()(this,"onClick",()=>{this.props.onButtonPress(this.props.digit)})}render(){switch(this.props.kind){case d.Digit:return a.createElement(r.a,{className:"mx_DialPad_button",onClick:this.onClick},this.props.digit);case d.Delete:return a.createElement(r.a,{className:"mx_DialPad_button mx_DialPad_deleteButton",onClick:this.onClick});case d.Dial:return a.createElement(r.a,{className:"mx_DialPad_button mx_DialPad_dialButton",onClick:this.onClick})}}}let h=Object(c.a)("views.voip.DialPad")(n=class extends a.PureComponent{render(){const e=[];for(const t of l)e.push(a.createElement(u,{key:t,kind:d.Digit,digit:t,onButtonPress:this.props.onDigitPress}));return this.props.hasDialAndDelete&&(e.push(a.createElement(u,{key:"del",kind:d.Delete,onButtonPress:this.props.onDeletePress})),e.push(a.createElement(u,{key:"dial",kind:d.Dial,onButtonPress:this.props.onDialPress}))),a.createElement("div",{className:"mx_DialPad"},e)}})||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return g})),s.d(t,"a",(function(){return v}));var n=s(91),i=s.n(n),o=s(92),a=s(102),r=s(165),c=s(144),l=s(143),d=s(639),u=s(118),h=s(99);function m(e){const t=e.split("-");return 5===t.length&&"react"===t[1]&&"js"===t[3]}function p(){u.a.get().installUpdate()}const g=(e,t,s)=>{let n,g=Object(o.a)("What's new?");s?n=()=>{h.a.createTrackedDialog("Display release notes","",l.a,{title:Object(o.a)("What's New"),description:i.a.createElement("pre",null,s),button:Object(o.a)("Update"),onFinished:e=>{e&&u.a.get()&&u.a.get().installUpdate()}})}:m(e)&&m(t)?n=()=>{h.a.createTrackedDialog("Display Changelog","",d.a,{version:e,newVersion:t,onFinished:e=>{e&&u.a.get()&&u.a.get().installUpdate()}})}:(n=p,g=Object(o.a)("Update"));const v=a.a.get().brand;c.a.sharedInstance().addOrReplaceToast({key:"update",title:Object(o.a)("Update %(brand)s",{brand:v}),props:{description:Object(o.a)("New version of %(brand)s is available",{brand:v}),acceptLabel:g,onAccept:n,rejectLabel:Object(o.a)("Dismiss"),onReject:function(){u.a.get().deferUpdate(t)}},component:r.a,priority:20})},v=()=>{c.a.sharedInstance().dismissToast("update")}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v})),s.d(t,"b",(function(){return f}));var n,i,o,a=s(18),r=s.n(a),c=s(393),l=s(91),d=s.n(l),u=s(97),h=s.n(u),m=s(209),p=s(95),g=s(93);const v=new Error("User cancelled auth session");let f=Object(g.a)("structures.InteractiveAuthComponent")((o=i=class extends d.a.Component{constructor(e){super(e),r()(this,"_requestEmailToken",async(...e)=>{this.setState({busy:!0});try{return await this.props.requestEmailToken(...e)}finally{this.setState({busy:!1})}}),r()(this,"tryContinue",()=>{this._stageComponent.current&&this._stageComponent.current.tryContinue&&this._stageComponent.current.tryContinue()}),r()(this,"_authStateUpdated",(e,t)=>{const s=this.state.authStage;this.setState({busy:!1,authStage:e,stageState:t,errorText:t.error},()=>{s!==e?this._setFocus():!t.error&&this._stageComponent.current&&this._stageComponent.current.attemptFailed&&this._stageComponent.current.attemptFailed()})}),r()(this,"_requestCallback",e=>this.props.makeRequest(e)),r()(this,"_onBusyChanged",e=>{e&&this.setState({busy:!0,errorText:null,stageErrorText:null})}),r()(this,"_submitAuthDict",e=>{this._authLogic.submitAuthDict(e)}),r()(this,"_onPhaseChange",e=>{this.props.onStagePhaseChange&&this.props.onStagePhaseChange(this.state.authStage,e||0)}),r()(this,"_onStageCancel",()=>{this.props.onAuthFinished(!1,v)}),r()(this,"_onAuthStageFailed",e=>{this.props.onAuthFinished(!1,e)}),r()(this,"_setEmailSid",e=>{this._authLogic.setEmailSid(e)}),this.state={authStage:null,busy:!1,errorText:null,stageErrorText:null,submitButtonEnabled:!1},this._unmounted=!1,this._authLogic=new c.a({authData:this.props.authData,doRequest:this._requestCallback,busyChanged:this._onBusyChanged,inputs:this.props.inputs,stateUpdated:this._authStateUpdated,matrixClient:this.props.matrixClient,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.emailSid,requestEmailToken:this._requestEmailToken}),this._intervalId=null,this.props.poll&&(this._intervalId=setInterval(()=>{this._authLogic.poll()},2e3)),this._stageComponent=Object(l.createRef)()}UNSAFE_componentWillMount(){this._authLogic.attemptAuth().then(e=>{const t={emailSid:this._authLogic.getEmailSid(),clientSecret:this._authLogic.getClientSecret()};this.props.onAuthFinished(!0,e,t)}).catch(e=>{if(this.props.onAuthFinished(!1,e),console.error("Error during user-interactive auth:",e),this._unmounted)return;const t=e.message||e.toString();this.setState({errorText:t})})}componentWillUnmount(){this._unmounted=!0,null!==this._intervalId&&clearInterval(this._intervalId)}_setFocus(){this._stageComponent.current&&this._stageComponent.current.focus&&this._stageComponent.current.focus()}_renderCurrentStage(){const e=this.state.authStage;if(!e){if(this.state.busy){const e=p.getComponent("elements.Spinner");return d.a.createElement(e,null)}return null}const t=Object(m.d)(e);return d.a.createElement(t,{ref:this._stageComponent,loginType:e,matrixClient:this.props.matrixClient,authSessionId:this._authLogic.getSessionId(),clientSecret:this._authLogic.getClientSecret(),stageParams:this._authLogic.getStageParams(e),submitAuthDict:this._submitAuthDict,errorText:this.state.stageErrorText,busy:this.state.busy,inputs:this.props.inputs,stageState:this.state.stageState,fail:this._onAuthStageFailed,setEmailSid:this._setEmailSid,showContinue:!this.props.continueIsManaged,onPhaseChange:this._onPhaseChange,continueText:this.props.continueText,continueKind:this.props.continueKind,onCancel:this._onStageCancel})}render(){let e=null;return this.state.errorText&&(e=d.a.createElement("div",{className:"error"},this.state.errorText)),d.a.createElement("div",null,d.a.createElement("div",null,this._renderCurrentStage(),e))}},r()(i,"propTypes",{matrixClient:h.a.object.isRequired,authData:h.a.shape({flows:h.a.array,params:h.a.object,session:h.a.string}),makeRequest:h.a.func.isRequired,onAuthFinished:h.a.func.isRequired,inputs:h.a.object,requestEmailToken:h.a.func,sessionId:h.a.string,clientSecret:h.a.string,emailSid:h.a.string,poll:h.a.bool,continueIsManaged:h.a.bool,onStagePhaseChange:h.a.func,continueText:h.a.string,continueKind:h.a.string}),n=o))||n},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(143),a=s(92),r=s(112),c=s(102),l=s(98),d=s(438),u=s(148),h=s(99),m=s(226),p=s(100),g=s(96),v=s(103),f=s(208);t.a=({featureId:e,onFinished:t})=>{const s=l.b.getBetaInfo(e),[b,y]=Object(n.useState)(""),[_,E]=Object(n.useState)(!1);return i.a.createElement(o.a,{className:"mx_BetaFeedbackDialog",hasCancelButton:!0,title:Object(a.a)("%(featureName)s beta feedback",{featureName:s.title}),description:i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_BetaFeedbackDialog_subheading"},Object(a.a)(s.feedbackSubheading)," ",Object(a.a)("Your platform and username will be noted to help us use your feedback as much as we can."),i.a.createElement(p.a,{kind:"link",onClick:()=>{t(!1),g.a.dispatch({action:v.a.ViewUserSettings,initialTabId:f.a.Labs})}},Object(a.a)("To leave the beta, visit your settings."))),i.a.createElement(r.a,{id:"feedbackComment",label:Object(a.a)("Feedback"),type:"text",autoComplete:"off",value:b,element:"textarea",onChange:e=>{y(e.target.value)},autoFocus:!0}),i.a.createElement(u.a,{checked:_,onClick:e=>E(e.target.checked)},Object(a.a)("You may contact me if you have any follow up questions"))),button:Object(a.a)("Send feedback"),buttonDisabled:!b,onFinished:async n=>{var i;if(!n)return t(!1);const o=null===(i=l.b.getBetaInfo(e))||void 0===i?void 0:i.extraSettings.reduce((e,t)=>(e[t]=l.b.getValue(t),e),{});Object(d.c)(c.a.get().bug_report_endpoint_url,s.feedbackLabel,b,_,o),t(!0),h.a.createTrackedDialog("Beta Dialog Sent",e,m.a,{title:Object(a.a)("Beta feedback"),description:Object(a.a)("Thank you for your feedback, we really appreciate it."),button:Object(a.a)("Done"),hasCloseButton:!1,fixedWidth:!1})}})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return p})),s.d(t,"b",(function(){return g})),s.d(t,"c",(function(){return v}));var n=s(1012),i=s.n(n),o=s(94),a=s(118),r=s(92),c=s(1021),l=s.n(c),d=s(440),u=s(98),h=s(102);async function m(e={},t=!0){const s=e.progressCallback||(()=>{});s(Object(r.a)("Collecting app version information"));let n="UNKNOWN";try{n=await a.a.get().getAppVersion()}catch(e){}let c="UNKNOWN";window.navigator&&window.navigator.userAgent&&(c=window.navigator.userAgent);let l="UNKNOWN";try{l=String(window.matchMedia("(display-mode: standalone)").matches)}catch(e){}let h="UNKNOWN";try{h=String(window.matchMedia("(pointer: coarse)").matches)}catch(e){}const m=o.a.get();console.log("Sending bug report.");const p=new FormData;if(p.append("text",e.userText||"User did not supply any additional text."),p.append("app","element-web"),p.append("version",n),p.append("user_agent",c),p.append("installed_pwa",l),p.append("touch_input",h),m&&(p.append("user_id",m.credentials.userId),p.append("device_id",m.deviceId),m.isCryptoEnabled())){const e=["ed25519:"+m.getDeviceEd25519Key()];m.getDeviceCurve25519Key&&e.push("curve25519:"+m.getDeviceCurve25519Key()),p.append("device_keys",e.join(", ")),p.append("cross_signing_key",m.getCrossSigningId());const t=m.crypto.crossSigningInfo,s=m.crypto.secretStorage;p.append("cross_signing_ready",String(await m.isCrossSigningReady())),p.append("cross_signing_supported_by_hs",String(await m.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"))),p.append("cross_signing_key",t.getId()),p.append("cross_signing_pk_in_secret_storage",String(!!await t.isStoredInSecretStorage(s)));const n=m.getCrossSigningCacheCallbacks();p.append("cross_signing_master_pk_cached",String(!(!n||!await n.getCrossSigningKeyCache("master")))),p.append("cross_signing_self_signing_pk_cached",String(!(!n||!await n.getCrossSigningKeyCache("self_signing")))),p.append("cross_signing_user_signing_pk_cached",String(!(!n||!await n.getCrossSigningKeyCache("user_signing")))),p.append("secret_storage_ready",String(await m.isSecretStorageReady())),p.append("secret_storage_key_in_account",String(!!await s.hasKey())),p.append("session_backup_key_in_secret_storage",String(!!await m.isKeyBackupKeyStored()));const i=await m.crypto.getSessionBackupPrivateKey();p.append("session_backup_key_cached",String(!!i)),p.append("session_backup_key_well_formed",String(i instanceof Uint8Array))}e.label&&p.append("label",e.label);const g=u.b.getFeatureSettingNames().filter(e=>u.b.getValue(e));if(g.length&&p.append("enabled_labs",g.join(", ")),u.b.getValue("lowBandwidth")&&p.append("lowBandwidth","enabled"),navigator.storage&&navigator.storage.persisted)try{p.append("storageManager_persisted",String(await navigator.storage.persisted()))}catch(e){}else if(document.hasStorageAccess)try{p.append("storageManager_persisted",String(await document.hasStorageAccess()))}catch(e){}if(navigator.storage&&navigator.storage.estimate)try{const e=await navigator.storage.estimate();p.append("storageManager_quota",String(e.quota)),p.append("storageManager_usage",String(e.usage)),e.usageDetails&&Object.keys(e.usageDetails).forEach(t=>{p.append("storageManager_usage_"+t,String(e.usageDetails[t]))})}catch(e){}if(window.Modernizr){const e=Object.keys(window.Modernizr).filter(e=>!1===window.Modernizr[e]);e.length>0&&p.append("modernizr_missing_features",e.join(", "))}if(p.append("mx_local_settings",localStorage.getItem("mx_local_settings")),e.sendLogs){s(Object(r.a)("Collecting logs"));const e=await d.c();for(const s of e){let e=(new TextEncoder).encode(s.lines);t&&(e=i.a.gzip(e)),p.append("compressed-log",new Blob([e]),s.id)}}return p}async function p(e,t={}){if(!e)throw new Error("No bug report endpoint has been set.");const s=t.progressCallback||(()=>{}),n=await m(t);s(Object(r.a)("Uploading logs")),await f(e,n,s)}async function g(e={}){const t=e.progressCallback||(()=>{}),s=await m(e,!1);t(Object(r.a)("Downloading logs"));let n="";const i=new l.a;let o=0;for(const[e,t]of s.entries())"compressed-log"===e?await new Promise(e=>{const s=new FileReader;s.addEventListener("loadend",t=>{i.append(`log-${o++}.log`,(new TextDecoder).decode(t.target.result)),e()}),s.readAsArrayBuffer(t)}):n+=`${e} = ${t}\n`;i.append("issue.txt",n);const a=document.createElement("a");a.href="data:application/octet-stream;base64,"+btoa(function(e){let t="";for(let s=0;s<e.length;s+=1)t+=String.fromCharCode(e[s]);return t}(i.out)),a.download="rageshake.tar",document.body.appendChild(a),a.click(),document.body.removeChild(a)}async function v(e,t,s,n=!1,i={}){var r;let c="UNKNOWN";try{c=await a.a.get().getAppVersion()}catch(e){}const l=new FormData;l.append("label",t),l.append("text",s),l.append("can_contact",n?"yes":"no"),l.append("app","element-web"),l.append("version",c),l.append("platform",a.a.get().getHumanReadableName()),l.append("user_id",null===(r=o.a.get())||void 0===r?void 0:r.getUserId());for(const e in i)l.append(e,i[e]);await f(h.a.get().bug_report_endpoint_url,l,()=>{})}function f(e,t,s){return new Promise((n,i)=>{const o=new XMLHttpRequest;o.open("POST",e),o.timeout=3e5,o.onreadystatechange=function(){if(o.readyState===XMLHttpRequest.LOADING)s(Object(r.a)("Waiting for response from server"));else if(o.readyState===XMLHttpRequest.DONE){if(o.status<200||o.status>=400)return void i(new Error("HTTP "+o.status));n()}},o.send(t)})}},,function(e,t,s){"use strict";(function(e){s.d(t,"d",(function(){return o})),s.d(t,"e",(function(){return a})),s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return c})),s.d(t,"c",(function(){return l}));class n{constructor(){this.logs=""}monkeyPatch(e){const t={log:"I",info:"I",warn:"W",error:"E"};Object.keys(t).forEach(s=>{const n=t[s],i=e[s].bind(e);e[s]=(...e)=>{this.log(n,...e),i(...e)}})}log(e,...t){let s=`${(new Date).toISOString()} ${e} ${(t=t.map(e=>{if(e instanceof DOMException)return e.message+` (${e.name} | ${e.code}) `+(e.stack?"\n"+e.stack:"");if(e instanceof Error)return e.message+(e.stack?"\n"+e.stack:"");if("object"!=typeof e)return e;try{return JSON.stringify(e)}catch(t){return JSON.stringify(e,(e,t)=>e&&"object"==typeof t?"<object>":t)}})).join(" ")}\n`;s=s.replace(/token=[a-zA-Z0-9-]+/gm,"token=xxxxx"),this.logs+=s}flush(e){if(e)return this.logs;const t=this.logs;return this.logs="",t}}class i{constructor(e,t){this.indexedDB=e,this.logger=t,this.id="instance-"+Math.random()+Date.now(),this.index=0,this.db=null,this.flushPromise=null,this.flushAgainPromise=null}connect(){const e=this.indexedDB.open("logs");return new Promise((t,s)=>{e.onsuccess=e=>{this.db=e.target.result,setInterval(this.flush.bind(this),3e4),t()},e.onerror=e=>{const t="Failed to open log database: "+e.target.error.name;console.error(t),s(new Error(t))},e.onupgradeneeded=e=>{const t=e.target.result,s=t.createObjectStore("logs",{keyPath:["id","index"]});s.createIndex("id","id",{unique:!1}),s.add(this._generateLogEntry(new Date+" ::: Log database was created."));t.createObjectStore("logslastmod",{keyPath:"id"}).add(this._generateLastModifiedTime())}})}flush(){return this.flushPromise?(this.flushAgainPromise||(this.flushAgainPromise=this.flushPromise.then(()=>this.flush()).then(()=>{this.flushAgainPromise=null})),this.flushAgainPromise):(this.flushPromise=new Promise((e,t)=>{if(!this.db)return void t(new Error("No connected database"));const s=this.logger.flush();if(0===s.length)return void e();const n=this.db.transaction(["logs","logslastmod"],"readwrite"),i=n.objectStore("logs");n.oncomplete=t=>{e()},n.onerror=e=>{console.error("Failed to flush logs : ",e),t(new Error("Failed to write logs: "+e.target.errorCode))},i.add(this._generateLogEntry(s));n.objectStore("logslastmod").put(this._generateLastModifiedTime())}).then(()=>{this.flushPromise=null}),this.flushPromise)}async consume(){const e=this.db;function t(t,s){const n=e.transaction("logs","readonly").objectStore("logs");return new Promise((e,i)=>{const o=n.index("id").openCursor(IDBKeyRange.only(t),"prev");let a="";o.onerror=e=>{i(new Error("Query failed: "+e.target.errorCode))},o.onsuccess=t=>{const n=t.target.result;n?(a=n.value.lines+a,a.length>=s?e(a):n.continue()):e(a)}})}const s=await function(e,t,s){const n=e.openCursor(t);return new Promise((e,t)=>{const i=[];n.onerror=e=>{t(new Error("Query failed: "+e.target.errorCode))},n.onsuccess=t=>{const n=t.target.result;n?(i.push(s(n)),n.continue()):e(i)}})}(e.transaction("logslastmod","readonly").objectStore("logslastmod"),void 0,e=>({id:e.value.id,ts:e.value.ts})).then(e=>e.sort((e,t)=>t.ts-e.ts).map(e=>e.id));let n=[];const i=[];let o=0;for(let e=0;e<s.length;e++){const a=await t(s[e],5242880-o);if(i.push({lines:a,id:s[e]}),o+=a.length,o>=5242880){n=s.slice(e+1);break}}return n.length>0&&(console.log("Removing logs: ",n),Promise.all(n.map(t=>function(t){return new Promise((s,n)=>{const i=e.transaction(["logs","logslastmod"],"readwrite"),o=i.objectStore("logs");o.index("id").openKeyCursor(IDBKeyRange.only(t)).onsuccess=e=>{const t=e.target.result;t&&(o.delete(t.primaryKey),t.continue())},i.oncomplete=()=>{s()},i.onerror=e=>{n(new Error(`Failed to delete logs for '${t}' : ${e.target.errorCode}`))};i.objectStore("logslastmod").delete(t)})}(t))).then(()=>{console.log(`Removed ${n.length} old logs.`)},e=>{console.error(e)})),i}_generateLogEntry(e){return{id:this.id,lines:e,index:this.index++}}_generateLastModifiedTime(){return{id:this.id,ts:Date.now()}}}function o(t=!0){return e.mx_rage_initPromise?e.mx_rage_initPromise:(e.mx_rage_logger=new n,e.mx_rage_logger.monkeyPatch(window.console),t?a():(e.mx_rage_initPromise=Promise.resolve(),e.mx_rage_initPromise))}function a(){if(e.mx_rage_initStoragePromise)return e.mx_rage_initStoragePromise;let t;console.log("Configuring rageshake persistence...");try{t=window.indexedDB}catch(e){}return t?(e.mx_rage_store=new i(t,e.mx_rage_logger),e.mx_rage_initStoragePromise=e.mx_rage_store.connect(),e.mx_rage_initStoragePromise):(e.mx_rage_initStoragePromise=Promise.resolve(),e.mx_rage_initStoragePromise)}function r(){e.mx_rage_store&&e.mx_rage_store.flush()}async function c(){e.mx_rage_store&&await e.mx_rage_store.consume()}async function l(){if(!e.mx_rage_logger)throw new Error("No console logger, did you forget to call init()?");return e.mx_rage_store?(await e.mx_rage_store.flush(),await e.mx_rage_store.consume()):[{lines:e.mx_rage_logger.flush(!0),id:"-"}]}}).call(this,s(7))},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(98),l=s(92),d=s(333),u=s(148),h=s(93);let m=Object(h.a)("views.elements.SettingsFlag")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"onChange",async e=>{await this.save(e),this.setState({value:e}),this.props.onChange&&this.props.onChange(e)}),o()(this,"checkBoxOnChange",e=>{this.onChange(e.target.checked)}),o()(this,"save",async e=>{await c.b.setValue(this.props.name,this.props.roomId,this.props.level,void 0!==e?e:this.state.value)}),this.state={value:c.b.getValueAt(this.props.level,this.props.name,this.props.roomId,this.props.isExplicit)}}render(){const e=c.b.canSetValue(this.props.name,this.props.roomId,this.props.level),t=this.props.label?Object(l.a)(this.props.label):c.b.getDisplayName(this.props.name,this.props.level),s=c.b.getDescription(this.props.name);return this.props.useCheckbox?r.a.createElement(u.a,{checked:this.state.value,onChange:this.checkBoxOnChange,disabled:this.props.disabled||!e},t):r.a.createElement("div",{className:"mx_SettingsFlag"},r.a.createElement("span",{className:"mx_SettingsFlag_label"},t),r.a.createElement(d.a,{checked:this.state.value,onChange:this.onChange,disabled:this.props.disabled||!e,"aria-label":t}),s&&r.a.createElement("div",{className:"mx_SettingsFlag_microcopy"},s))}})||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return d})),s.d(t,"d",(function(){return u})),s.d(t,"a",(function(){return h})),s.d(t,"c",(function(){return m})),s.d(t,"f",(function(){return E})),s.d(t,"e",(function(){return S}));var n=s(91),i=s(101),o=s.n(i),a=s(95),r=s(99),c=s(92),l=s(111);let d,u;Object(c.b)("Navigation"),Object(c.b)("Calls"),Object(c.b)("Composer"),Object(c.b)("Room List"),Object(c.b)("Autocomplete"),function(e){e.NAVIGATION="Navigation",e.CALLS="Calls",e.COMPOSER="Composer",e.ROOM_LIST="Room List",e.ROOM="Room",e.AUTOCOMPLETE="Autocomplete"}(d||(d={})),Object(c.b)("Alt"),Object(c.b)("Alt Gr"),Object(c.b)("Shift"),Object(c.b)("Super"),Object(c.b)("Ctrl"),function(e){e.ALT="Alt",e.ALT_GR="Alt Gr",e.SHIFT="Shift",e.SUPER="Super",e.COMMAND="Command",e.CONTROL="Ctrl"}(u||(u={}));const h=l.b?u.COMMAND:u.CONTROL,m="digits",p={[d.COMPOSER]:[{keybinds:[{modifiers:[h],key:l.a.B}],description:Object(c.b)("Toggle Bold")},{keybinds:[{modifiers:[h],key:l.a.I}],description:Object(c.b)("Toggle Italics")},{keybinds:[{modifiers:[h],key:l.a.GREATER_THAN}],description:Object(c.b)("Toggle Quote")},{keybinds:[{modifiers:[u.SHIFT],key:l.a.ENTER}],description:Object(c.b)("New line")},{keybinds:[{key:l.a.ARROW_UP},{key:l.a.ARROW_DOWN}],description:Object(c.b)("Navigate recent messages to edit")},{keybinds:[{modifiers:[h],key:l.a.HOME},{modifiers:[h],key:l.a.END}],description:Object(c.b)("Jump to start/end of the composer")},{keybinds:[{modifiers:[u.CONTROL,u.ALT],key:l.a.ARROW_UP},{modifiers:[u.CONTROL,u.ALT],key:l.a.ARROW_DOWN}],description:Object(c.b)("Navigate composer history")},{keybinds:[{key:l.a.ESCAPE}],description:Object(c.b)("Cancel replying to a message")}],[d.CALLS]:[{keybinds:[{modifiers:[h],key:l.a.D}],description:Object(c.b)("Toggle microphone mute")},{keybinds:[{modifiers:[h],key:l.a.E}],description:Object(c.b)("Toggle video on/off")}],[d.ROOM]:[{keybinds:[{key:l.a.PAGE_UP},{key:l.a.PAGE_DOWN}],description:Object(c.b)("Scroll up/down in the timeline")},{keybinds:[{key:l.a.ESCAPE}],description:Object(c.b)("Dismiss read marker and jump to bottom")},{keybinds:[{modifiers:[u.SHIFT],key:l.a.PAGE_UP}],description:Object(c.b)("Jump to oldest unread message")},{keybinds:[{modifiers:[h,u.SHIFT],key:l.a.U}],description:Object(c.b)("Upload a file")},{keybinds:[{modifiers:[h],key:l.a.F}],description:Object(c.b)("Search (must be enabled)")}],[d.ROOM_LIST]:[{keybinds:[{modifiers:[h],key:l.a.K}],description:Object(c.b)("Jump to room search")},{keybinds:[{key:l.a.ARROW_UP},{key:l.a.ARROW_DOWN}],description:Object(c.b)("Navigate up/down in the room list")},{keybinds:[{key:l.a.ENTER}],description:Object(c.b)("Select room from the room list")},{keybinds:[{key:l.a.ARROW_LEFT}],description:Object(c.b)("Collapse room list section")},{keybinds:[{key:l.a.ARROW_RIGHT}],description:Object(c.b)("Expand room list section")},{keybinds:[{key:l.a.ESCAPE}],description:Object(c.b)("Clear room list filter field")}],[d.NAVIGATION]:[{keybinds:[{modifiers:[u.ALT,u.SHIFT],key:l.a.ARROW_UP},{modifiers:[u.ALT,u.SHIFT],key:l.a.ARROW_DOWN}],description:Object(c.b)("Previous/next unread room or DM")},{keybinds:[{modifiers:[u.ALT],key:l.a.ARROW_UP},{modifiers:[u.ALT],key:l.a.ARROW_DOWN}],description:Object(c.b)("Previous/next room or DM")},{keybinds:[{modifiers:[h],key:l.a.BACKTICK}],description:Object(c.b)("Toggle the top left menu")},{keybinds:[{key:l.a.ESCAPE}],description:Object(c.b)("Close dialog or context menu")},{keybinds:[{key:l.a.ENTER},{key:l.a.SPACE}],description:Object(c.b)("Activate selected button")},{keybinds:[{modifiers:[h],key:l.a.PERIOD}],description:Object(c.b)("Toggle right panel")},{keybinds:[{modifiers:[h],key:l.a.SLASH}],description:Object(c.b)("Toggle this dialog")},{keybinds:[{modifiers:[u.CONTROL,l.b?u.SHIFT:u.ALT],key:l.a.H}],description:Object(c.b)("Go to Home View")}],[d.AUTOCOMPLETE]:[{keybinds:[{key:l.a.ARROW_UP},{key:l.a.ARROW_DOWN}],description:Object(c.b)("Move autocomplete selection up/down")},{keybinds:[{key:l.a.ESCAPE}],description:Object(c.b)("Cancel autocomplete")}]},g=[d.COMPOSER,d.AUTOCOMPLETE,d.ROOM,d.ROOM_LIST,d.NAVIGATION,d.CALLS],v={[u.COMMAND]:"⌘"};l.b&&(v[u.ALT]="⌥");const f={[l.a.PAGE_UP]:Object(c.b)("Page Up"),[l.a.PAGE_DOWN]:Object(c.b)("Page Down"),[l.a.ESCAPE]:Object(c.b)("Esc"),[l.a.ENTER]:Object(c.b)("Enter"),[l.a.SPACE]:Object(c.b)("Space"),[l.a.HOME]:Object(c.b)("Home"),[l.a.END]:Object(c.b)("End"),[m]:Object(c.b)("[number]")},b={[l.a.ARROW_UP]:"↑",[l.a.ARROW_DOWN]:"↓",[l.a.ARROW_LEFT]:"←",[l.a.ARROW_RIGHT]:"→"},y=({shortcut:e})=>{const t=o()({mx_KeyboardShortcutsDialog_inline:e.keybinds.every(e=>!e.modifiers||0===e.modifiers.length)});return n.createElement("div",{className:t},n.createElement("h5",null,Object(c.a)(e.description)),e.keybinds.map(e=>{let t=e.key;return f[e.key]?t=Object(c.a)(f[e.key]):b[e.key]&&(t=b[e.key]),n.createElement("div",{key:e.key},e.modifiers&&e.modifiers.map(e=>n.createElement(n.Fragment,{key:e},n.createElement("kbd",null,v[e]||Object(c.a)(e)),"+")),n.createElement("kbd",null,t))}))};let _=null;const E=()=>{if(_)return _.close(),void(_=null);const e=g.map(e=>{const t=p[e];return n.createElement("div",{className:"mx_KeyboardShortcutsDialog_category",key:e},n.createElement("h3",null,Object(c.a)(e)),n.createElement("div",null,t.map(e=>n.createElement(y,{key:e.description,shortcut:e}))))}),t=a.getComponent("dialogs.InfoDialog");_=r.a.createTrackedDialog("Keyboard Shortcuts","",t,{className:"mx_KeyboardShortcutsDialog",title:Object(c.a)("Keyboard Shortcuts"),description:e,hasCloseButton:!0,onKeyDown:e=>{!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||e.key!==l.a.SLASH||(e.stopPropagation(),_.close())},onFinished:()=>{_=null}})},S=(e,t)=>{p[e].push(t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u})),s.d(t,"b",(function(){return h}));var n=s(91),i=s.n(n),o=s(231),a=s(92),r=s(102),c=s(96),l=s(103),d=s(208);let u;function h({isRoomEncrypted:e,kind:t}){if(!e)return null;if(o.a.get())return null;if(o.a.error)return i.a.createElement(i.a.Fragment,null,Object(a.a)("Message search initialisation failed, check <a>your settings</a> for more information",{},{a:e=>i.a.createElement("a",{onClick:e=>{e.preventDefault(),c.a.dispatch({action:l.a.ViewUserSettings,initialTabId:d.a.Security})}},e)}));const{desktopBuilds:s,brand:n}=r.a.get();let h=null,m=null;if(s.available)switch(m=i.a.createElement("img",{src:s.logo}),t){case u.Files:h=Object(a.a)("Use the <a>Desktop app</a> to see all encrypted files",{},{a:e=>i.a.createElement("a",{href:s.url,target:"_blank",rel:"noreferrer noopener"},e)});break;case u.Search:h=Object(a.a)("Use the <a>Desktop app</a> to search encrypted messages",{},{a:e=>i.a.createElement("a",{href:s.url,target:"_blank",rel:"noreferrer noopener"},e)})}else switch(t){case u.Files:h=Object(a.a)("This version of %(brand)s does not support viewing some encrypted files",{brand:n});break;case u.Search:h=Object(a.a)("This version of %(brand)s does not support searching encrypted messages",{brand:n})}return h?i.a.createElement("div",{className:"mx_DesktopBuildsNotice"},m,i.a.createElement("span",null,h)):(console.warn("Unknown desktop builds warning kind: ",t),null)}!function(e){e[e.Files=0]="Files",e[e.Search=1]="Search"}(u||(u={}))},function(e,t,s){"use strict";var n,i,o,a=s(18),r=s.n(a),c=s(98),l=s(155),d=s(91),u=s.n(d),h=s(147),m=s.n(h),p=s(97),g=s.n(p),v=s(167),f=s(392),b=s(92),y=s(94),_=s(187),E=s(429),S=s(99),w=s(96),C=s(95),k=s(111),O=s(254),R=s(265),I=s(195),x=s(116),T=s(93),j=s(121);let N=function(){};let P=Object(T.a)("structures.TimelinePanel")((o=i=class e extends u.a.Component{constructor(t){super(t),r()(this,"onMessageListUnfillRequest",(e,t)=>{const s=e?v.a.BACKWARDS:v.a.FORWARDS;N("TimelinePanel: unpaginating events in direction",s);const n=t,i=this.state.events.findIndex(e=>e.getId()===n),o=e?i+1:this.state.events.length-i;if(o>0){N("TimelinePanel: Unpaginating",o,"in direction",s),this._timelineWindow.unpaginate(o,e);const t=e?"canBackPaginate":"canForwardPaginate",{events:n,liveEvents:i,firstVisibleEventIndex:a}=this._getEvents();this.setState({[t]:!0,events:n,liveEvents:i,firstVisibleEventIndex:a})}}),r()(this,"onPaginationRequest",(e,t,s)=>this.props.onPaginationRequest?this.props.onPaginationRequest(e,t,s):e.paginate(t,s)),r()(this,"onMessageListFillRequest",e=>{if(!this._shouldPaginate())return Promise.resolve(!1);const t=e?v.a.BACKWARDS:v.a.FORWARDS,s=e?"canBackPaginate":"canForwardPaginate",n=e?"backPaginating":"forwardPaginating";return this.state[s]?this._timelineWindow.canPaginate(t)?e&&0!==this.state.firstVisibleEventIndex?(N("TimelinePanel: won't",t,"paginate past first visible event"),Promise.resolve(!1)):(N("TimelinePanel: Initiating paginate; backwards:"+e),this.setState({[n]:!0}),this.onPaginationRequest(this._timelineWindow,t,20).then(t=>{if(this.unmounted)return;N("TimelinePanel: paginate complete backwards:"+e+"; success:"+t);const{events:i,liveEvents:o,firstVisibleEventIndex:a}=this._getEvents(),r={[n]:!1,[s]:t,events:i,liveEvents:o,firstVisibleEventIndex:a},c=e?v.a.FORWARDS:v.a.BACKWARDS,l=e?"canForwardPaginate":"canBackPaginate";return!this.state[l]&&this._timelineWindow.canPaginate(c)&&(N("TimelinePanel: can now",c,"paginate again"),r[l]=!0),new Promise(s=>{this.setState(r,()=>{s(t&&(!e||0===a))})})})):(N("TimelinePanel: can't",t,"paginate any further"),this.setState({[s]:!1}),Promise.resolve(!1)):(N("TimelinePanel: have given up",t,"paginating this timeline"),Promise.resolve(!1))}),r()(this,"onMessageListScroll",e=>{if(this.props.onScroll&&this.props.onScroll(e),this.props.manageReadMarkers){const e=this.getReadMarkerPosition();e<0&&this.setState({readMarkerVisible:!0});const t=this._readMarkerTimeout(e);this._readMarkerActivityTimer.changeTimeout(t)}}),r()(this,"onAction",e=>{switch(e.action){case"ignore_state_changed":this.forceUpdate()}}),r()(this,"onRoomTimeline",(e,t,s,n,i)=>{i.timeline.getTimelineSet()===this.props.timelineSet&&!s&&i&&i.liveEvent&&this._messagePanel.current&&(this._messagePanel.current.getScrollState().stuckAtBottom?this._timelineWindow.paginate(v.a.FORWARDS,1,!1).then(()=>{if(this.unmounted)return;const{events:t,liveEvents:s,firstVisibleEventIndex:n}=this._getEvents(),i=s[s.length-1],o={events:t,liveEvents:s,firstVisibleEventIndex:n};let a;if(this.props.manageReadMarkers){const t=y.a.get().credentials.userId,s=e.sender?e.sender.userId:null;a=!1,s==t||E.a.sharedInstance().userActiveRecently()?i&&0===this.getReadMarkerPosition()&&(this._setReadMarker(i.getId(),i.getTs(),!0),o.readMarkerVisible=!1,o.readMarkerEventId=i.getId(),a=!0):o.readMarkerVisible=!0}this.setState(o,()=>{this._messagePanel.current.updateTimelineMinHeight(),a&&this.props.onReadMarkerUpdated()})}):this.setState({canForwardPaginate:!0}))}),r()(this,"onRoomTimelineReset",(e,t)=>{t===this.props.timelineSet&&this._messagePanel.current&&this._messagePanel.current.isAtBottom()&&this._loadTimeline()}),r()(this,"canResetTimeline",()=>this._messagePanel.current&&this._messagePanel.current.isAtBottom()),r()(this,"onRoomRedaction",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),r()(this,"onEventReplaced",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),r()(this,"onRoomReceipt",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),r()(this,"onLocalEchoUpdated",(e,t,s)=>{this.unmounted||t===this.props.timelineSet.room&&this._reloadEvents()}),r()(this,"onAccountData",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&"m.fully_read"===e.getType()&&this.setState({readMarkerEventId:e.getContent().event_id},this.props.onReadMarkerUpdated)}),r()(this,"onEventDecrypted",e=>{this.props.timelineSet.room&&e.getRoomId()===this.props.timelineSet.room.roomId&&this.forceUpdate()}),r()(this,"onSync",(e,t,s)=>{this.setState({clientSyncState:e})}),r()(this,"sendReadReceipt",()=>{if(c.b.getValue("lowBandwidth"))return;if(!this._messagePanel.current)return;if(!this.props.manageReadReceipts)return;const e=y.a.get();if(!e||e.isGuest())return;let t=!0;const s=this._getCurrentReadReceipt(!0),n=this._indexForEventId(s);s&&null===n&&this._timelineWindow.canPaginate(v.a.FORWARDS)&&(t=!1);const i=this._getLastDisplayedEventIndex({ignoreOwn:!0});null===i&&(t=!1);let o=this.state.events[i];t=t&&i>n&&this.lastRRSentEventId!=o.getId();const a=this.lastRMSentEventId!=this.state.readMarkerEventId;(t||a)&&(t?this.lastRRSentEventId=o.getId():o=null,this.lastRMSentEventId=this.state.readMarkerEventId,N("TimelinePanel: Sending Read Markers for ",this.props.timelineSet.room.roomId,"rm",this.state.readMarkerEventId,o?"rr "+o.getId():""),y.a.get().setRoomReadMarkers(this.props.timelineSet.room.roomId,this.state.readMarkerEventId,o,{}).catch(e=>{if("M_UNRECOGNIZED"===e.errcode&&o)return y.a.get().sendReadReceipt(o,{}).catch(e=>{console.error(e),this.lastRRSentEventId=void 0});console.error(e),this.lastRRSentEventId=void 0,this.lastRMSentEventId=void 0}),this.isAtEndOfLiveTimeline()&&(this.props.timelineSet.room.setUnreadNotificationCount("total",0),this.props.timelineSet.room.setUnreadNotificationCount("highlight",0),w.a.dispatch({action:"on_room_read",roomId:this.props.timelineSet.room.roomId})))}),r()(this,"updateReadMarker",()=>{if(!this.props.manageReadMarkers)return;if(1===this.getReadMarkerPosition())return;const e=this._getLastDisplayedEventIndex({allowPartial:!0});if(null===e)return;const t=this.state.events[e];this._setReadMarker(t.getId(),t.getTs()),this.state.readMarkerVisible&&this.setState({readMarkerVisible:!1}),this.sendReadReceipt()}),r()(this,"jumpToLiveTimeline",()=>{this._timelineWindow.canPaginate(v.a.FORWARDS)?this._loadTimeline():this._messagePanel.current&&this._messagePanel.current.scrollToBottom()}),r()(this,"scrollToEventIfNeeded",e=>{this._messagePanel.current&&this._messagePanel.current.scrollToEventIfNeeded(e)}),r()(this,"jumpToReadMarker",()=>{if(!this.props.manageReadMarkers)return;if(!this._messagePanel.current)return;if(!this.state.readMarkerEventId)return;null===this._messagePanel.current.getReadMarkerPosition()?this._loadTimeline(this.state.readMarkerEventId,0,1/3):this._messagePanel.current.scrollToEvent(this.state.readMarkerEventId,0,1/3)}),r()(this,"forgetReadMarker",()=>{if(!this.props.manageReadMarkers)return;const e=this._getCurrentReadReceipt(),t=this.props.timelineSet.getTimelineForEvent(e);let s;if(t){const n=t.getEvents().find(t=>t.getId()==e);n&&(s=n.getTs())}this._setReadMarker(e,s)}),r()(this,"isAtEndOfLiveTimeline",()=>this._messagePanel.current&&this._messagePanel.current.isAtBottom()&&this._timelineWindow&&!this._timelineWindow.canPaginate(v.a.FORWARDS)),r()(this,"getScrollState",()=>this._messagePanel.current?this._messagePanel.current.getScrollState():null),r()(this,"getReadMarkerPosition",()=>{if(!this.props.manageReadMarkers)return null;if(!this._messagePanel.current)return null;const t=this._messagePanel.current.getReadMarkerPosition();if(null!==t)return t;const s=e.roomReadMarkerTsMap[this.props.timelineSet.room.roomId];return s&&this.state.events.length>0?s<this.state.events[0].getTs()?-1:1:null}),r()(this,"canJumpToReadMarker",()=>{const e=this.getReadMarkerPosition();return null!==this.state.readMarkerEventId&&(e<0||null===e)}),r()(this,"handleScrollKey",e=>{this._messagePanel.current&&(!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||e.key!==k.a.END?this._messagePanel.current.handleScrollKey(e):this.jumpToLiveTimeline())}),r()(this,"getRelationsForEvent",(...e)=>this.props.timelineSet.getRelationsForEvent(...e)),N("TimelinePanel: mounting"),this.lastRRSentEventId=void 0,this.lastRMSentEventId=void 0,this._messagePanel=Object(d.createRef)();let s=null;if(this.props.manageReadMarkers){const e=this.props.timelineSet.room.getAccountData("m.fully_read");s=e?e.getContent().event_id:this._getCurrentReadReceipt()}this.state={events:[],liveEvents:[],timelineLoading:!0,firstVisibleEventIndex:0,canBackPaginate:!1,canForwardPaginate:!1,readMarkerVisible:!0,readMarkerEventId:s,backPaginating:!1,forwardPaginating:!1,clientSyncState:y.a.get().getSyncState(),isTwelveHour:c.b.getValue("showTwelveHourTimestamps"),alwaysShowTimestamps:c.b.getValue("alwaysShowTimestamps"),readMarkerInViewThresholdMs:c.b.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:c.b.getValue("readMarkerOutOfViewThresholdMs")},this.dispatcherRef=w.a.register(this.onAction),y.a.get().on("Room.timeline",this.onRoomTimeline),y.a.get().on("Room.timelineReset",this.onRoomTimelineReset),y.a.get().on("Room.redaction",this.onRoomRedaction),y.a.get().on("Room.redactionCancelled",this.onRoomRedaction),y.a.get().on("Room.receipt",this.onRoomReceipt),y.a.get().on("Room.localEchoUpdated",this.onLocalEchoUpdated),y.a.get().on("Room.accountData",this.onAccountData),y.a.get().on("Event.decrypted",this.onEventDecrypted),y.a.get().on("Event.replaced",this.onEventReplaced),y.a.get().on("sync",this.onSync)}UNSAFE_componentWillMount(){this.props.manageReadReceipts&&this.updateReadReceiptOnUserActivity(),this.props.manageReadMarkers&&this.updateReadMarkerOnUserActivity(),this._initTimeline(this.props)}UNSAFE_componentWillReceiveProps(e){e.timelineSet!==this.props.timelineSet&&console.warn("Replacing timelineSet on a TimelinePanel - confusion may ensue");const t=e.eventId!=this.props.eventId,s=e.highlightedEventId!=this.props.highlightedEventId;if(t||s)return console.log("TimelinePanel switching to eventId "+e.eventId+" (was "+this.props.eventId+")"),this._initTimeline(e)}componentWillUnmount(){this.unmounted=!0,this._readReceiptActivityTimer&&(this._readReceiptActivityTimer.abort(),this._readReceiptActivityTimer=null),this._readMarkerActivityTimer&&(this._readMarkerActivityTimer.abort(),this._readMarkerActivityTimer=null),w.a.unregister(this.dispatcherRef);const e=y.a.get();e&&(e.removeListener("Room.timeline",this.onRoomTimeline),e.removeListener("Room.timelineReset",this.onRoomTimelineReset),e.removeListener("Room.redaction",this.onRoomRedaction),e.removeListener("Room.redactionCancelled",this.onRoomRedaction),e.removeListener("Room.receipt",this.onRoomReceipt),e.removeListener("Room.localEchoUpdated",this.onLocalEchoUpdated),e.removeListener("Room.accountData",this.onAccountData),e.removeListener("Event.decrypted",this.onEventDecrypted),e.removeListener("Event.replaced",this.onEventReplaced),e.removeListener("sync",this.onSync))}_readMarkerTimeout(e){return 0===e?this.state.readMarkerInViewThresholdMs:this.state.readMarkerOutOfViewThresholdMs}async updateReadMarkerOnUserActivity(){const e=this._readMarkerTimeout(this.getReadMarkerPosition());for(this._readMarkerActivityTimer=new O.a(e);this._readMarkerActivityTimer;){E.a.sharedInstance().timeWhileActiveRecently(this._readMarkerActivityTimer);try{await this._readMarkerActivityTimer.finished()}catch(e){continue}this.updateReadMarker()}}async updateReadReceiptOnUserActivity(){for(this._readReceiptActivityTimer=new O.a(500);this._readReceiptActivityTimer;){E.a.sharedInstance().timeWhileActiveNow(this._readReceiptActivityTimer);try{await this._readReceiptActivityTimer.finished()}catch(e){continue}this.sendReadReceipt()}}_advanceReadMarkerPastMyEvents(){if(!this.props.manageReadMarkers)return;const e=this._timelineWindow.getEvents();let t;for(t=0;t<e.length&&e[t].getId()!=this.state.readMarkerEventId;t++);if(t>=e.length)return;const s=y.a.get().credentials.userId;for(t++;t<e.length;t++){const n=e[t];if(!n.sender||n.sender.userId!=s)break}t--;const n=e[t];this._setReadMarker(n.getId(),n.getTs())}_initTimeline(e){const t=e.eventId,s=e.eventPixelOffset;let n=1;return null==s&&(n=.5),this._loadTimeline(t,s,n)}_loadTimeline(e,t,s){this._timelineWindow=new f.b(y.a.get(),this.props.timelineSet,{windowLimit:this.props.timelineCap});const n=()=>{this._messagePanel.current&&this._messagePanel.current.onTimelineReset(),this._reloadEvents(),this._advanceReadMarkerPastMyEvents(),this.setState({canBackPaginate:this._timelineWindow.canPaginate(v.a.BACKWARDS),canForwardPaginate:this._timelineWindow.canPaginate(v.a.FORWARDS),timelineLoading:!1},()=>{this._messagePanel.current?(e?this._messagePanel.current.scrollToEvent(e,t,s):this._messagePanel.current.scrollToBottom(),this.props.sendReadReceiptOnLoad&&this.sendReadReceipt()):console.log("can't initialise scroll state because messagePanel didn't load")})},i=t=>{this.setState({timelineLoading:!1}),console.error(`Error loading timeline panel at ${e}: ${t}`);const s=C.getComponent("dialogs.ErrorDialog");let n,i;e&&(n=()=>{w.a.dispatch({action:"view_room",room_id:this.props.timelineSet.room.roomId})}),i="M_FORBIDDEN"==t.errcode?Object(b.a)("Tried to load a specific point in this room's timeline, but you do not have permission to view the message in question."):Object(b.a)("Tried to load a specific point in this room's timeline, but was unable to find it."),S.a.createTrackedDialog("Failed to load timeline position","",s,{title:Object(b.a)("Failed to load timeline position"),description:i,onFinished:n})};if(this.props.timelineSet.getTimelineForEvent(e))this._timelineWindow.load(e,20),n();else{const t=this._timelineWindow.load(e,20);this.setState({events:[],liveEvents:[],canBackPaginate:!1,canForwardPaginate:!1,timelineLoading:!0}),t.then(n,i)}}_reloadEvents(){this.unmounted||this.setState(this._getEvents())}_getEvents(){const e=this._timelineWindow.getEvents();Object(j.b)(e).reverse().forEach(e=>{y.a.get().decryptEventIfNeeded(e)});const t=this._checkForPreJoinUISI(e),s=[...e];return this._timelineWindow.canPaginate(v.a.FORWARDS)||e.push(...this.props.timelineSet.getPendingEvents()),{events:e,liveEvents:s,firstVisibleEventIndex:t}}_checkForPreJoinUISI(e){const t=this.props.timelineSet.room;if(0===e.length||!t||!y.a.get().isRoomEncrypted(t.roomId))return 0;const s=y.a.get().credentials.userId;let n,i="leave";for(n=e.length-1;n>=0;n--){const o=t.getTimelineForEvent(e[n].getId());if(!o){console.warn(`Event ${e[n].getId()} in room ${t.roomId} is live, but it does not have a timeline`);continue}const a=o.getState(v.a.FORWARDS).getMember(s);i=a?a.membership:"leave";const r=o.getEvents();for(let t=r.length-1;t>=0;t--){const o=r[t];if(o.getId()===e[n].getId())break;if(o.getStateKey()===s&&"m.room.member"===o.getType()){i=o.getPrevContent().membership||"leave"}}break}for(;n>=0;n--){const t=e[n];if(t.getStateKey()===s&&"m.room.member"===t.getType()){i=t.getPrevContent().membership||"leave"}else if("leave"===i&&(t.isDecryptionFailure()||t.isBeingDecrypted()))return n+1}return 0}_indexForEventId(e){for(let t=0;t<this.state.events.length;++t)if(e==this.state.events[t].getId())return t;return null}_getLastDisplayedEventIndex(e){const t=(e=e||{}).ignoreOwn||!1,s=e.allowPartial||!1,n=this._messagePanel.current;if(!n)return null;const i=m.a.findDOMNode(n);if(!i)return null;const o=i.getBoundingClientRect(),a=y.a.get().credentials.userId,r=e=>{if(e){const t=e.getBoundingClientRect();if(s&&t.top<o.bottom||!s&&t.bottom<o.bottom)return!0}return!1};let c=0;for(let e=this.state.liveEvents.length-1;e>=0;--e){const s=this.state.liveEvents[e],i=n.getNodeForEventId(s.getId()),o=r(i);if(o&&0!==c)return e+c;i&&!o&&(c=0);const l=!!s.status||t&&s.sender&&s.sender.userId==a;if(!(!Object(I.b)(s)||Object(R.a)(s,this.context))&&i){if(!l&&o)return e}else(!l||l&&0!==c)&&++c}return null}_getCurrentReadReceipt(e){const t=y.a.get();if(null==t)return null;const s=t.credentials.userId;return this.props.timelineSet.room.getEventReadUpTo(s,e)}_setReadMarker(t,s,n){const i=this.props.timelineSet.room.roomId;t!==this.state.readMarkerEventId&&(e.roomReadMarkerTsMap[i]=s,n||this.setState({readMarkerEventId:t},this.props.onReadMarkerUpdated))}_shouldPaginate(){return!this.state.events.some(e=>e.isBeingDecrypted())}render(){const e=C.getComponent("structures.MessagePanel"),t=C.getComponent("elements.Spinner");if(this.state.timelineLoading)return u.a.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},u.a.createElement(t,null));if(0==this.state.events.length&&!this.state.canBackPaginate&&this.props.empty)return u.a.createElement("div",{className:this.props.className+" mx_RoomView_messageListWrapper"},u.a.createElement("div",{className:"mx_RoomView_empty"},this.props.empty));const s=!this._timelineWindow.canPaginate(v.a.FORWARDS),n=this.state.forwardPaginating||["PREPARED","CATCHUP"].includes(this.state.clientSyncState),i=this.state.firstVisibleEventIndex?this.state.events.slice(this.state.firstVisibleEventIndex):this.state.events;return u.a.createElement(e,{ref:this._messagePanel,room:this.props.timelineSet.room,permalinkCreator:this.props.permalinkCreator,hidden:this.props.hidden,backPaginating:this.state.backPaginating,forwardPaginating:n,events:i,highlightedEventId:this.props.highlightedEventId,readMarkerEventId:this.state.readMarkerEventId,readMarkerVisible:this.state.readMarkerVisible,suppressFirstDateSeparator:this.state.canBackPaginate,showUrlPreview:this.props.showUrlPreview,showReadReceipts:this.props.showReadReceipts,ourUserId:y.a.get().credentials.userId,stickyBottom:s,onScroll:this.onMessageListScroll,onUserScroll:this.props.onUserScroll,onFillRequest:this.onMessageListFillRequest,onUnfillRequest:this.onMessageListUnfillRequest,isTwelveHour:this.state.isTwelveHour,alwaysShowTimestamps:this.props.alwaysShowTimestamps||this.state.alwaysShowTimestamps,className:this.props.className,tileShape:this.props.tileShape,resizeNotifier:this.props.resizeNotifier,getRelationsForEvent:this.getRelationsForEvent,editState:this.props.editState,showReactions:this.props.showReactions,layout:this.props.layout,singleSideBubbles:this.props.singleSideBubbles,enableFlair:c.b.getValue(x.a.Flair)})}},r()(i,"propTypes",{timelineSet:g.a.object.isRequired,showReadReceipts:g.a.bool,manageReadReceipts:g.a.bool,sendReadReceiptOnLoad:g.a.bool,manageReadMarkers:g.a.bool,manageComposerDispatches:g.a.bool,hidden:g.a.bool,highlightedEventId:g.a.string,eventId:g.a.string,eventPixelOffset:g.a.number,showUrlPreview:g.a.bool,onScroll:g.a.func,onUserScroll:g.a.func,onReadMarkerUpdated:g.a.func,onPaginationRequest:g.a.func,timelineCap:g.a.number,className:g.a.string,tileShape:g.a.string,empty:g.a.node,showReactions:g.a.bool,layout:l.b,singleSideBubbles:g.a.bool,alwaysShowTimestamps:g.a.bool}),r()(i,"contextType",_.a),r()(i,"roomReadMarkerTsMap",{}),r()(i,"defaultProps",{timelineCap:Number.MAX_VALUE,className:"mx_RoomView_messagePanel",sendReadReceiptOnLoad:!0}),n=o))||n;t.a=P},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(92),a=s(100),r=s(142),c=s(149),l=s(122),d=s(157),u=s(94);t.a=({space:e,onFinished:t})=>{var s;const[h,m]=Object(n.useState)(Object(o.a)("Click to copy"));return i.a.createElement("div",{className:"mx_SpacePublicShare"},i.a.createElement(a.a,{className:"mx_SpacePublicShare_shareButton",onClick:async()=>{const t=new l.a(e);t.load();const s=await Object(r.c)(t.forRoom())?Object(o.a)("Copied!"):Object(o.a)("Failed to copy");m(s),await Object(c.c)(5e3),h===s&&m(Object(o.a)("Click to copy"))}},i.a.createElement("h3",null,Object(o.a)("Share invite link")),i.a.createElement("span",null,h)),e.canInvite(null===(s=u.a.get())||void 0===s?void 0:s.getUserId())?i.a.createElement(a.a,{className:"mx_SpacePublicShare_inviteButton",onClick:()=>{Object(d.g)(e.roomId),t&&t()}},i.a.createElement("h3",null,Object(o.a)("Invite people")),i.a.createElement("span",null,Object(o.a)("Invite with email or username"))):null)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return T}));var n=s(91),i=s.n(n),o=s(101),a=s.n(o),r=s(92),c=s(124),l=s(427),d=s(281),u=s(145),h=s(129),m=s(242),p=s(100),g=s(125),v=s(149),f=s(127),b=s(122),y=s(148),_=s(105),E=s(360),S=s(447),w=s(295),C=s(259),k=s(220),O=s(328),R=s(282),I=s(130);const x=({room:e,checked:t,onChange:s})=>i.a.createElement("label",{className:"mx_AddExistingToSpace_entry"},null!=e&&e.isSpaceRoom()?i.a.createElement(h.a,{room:e,height:32,width:32}):i.a.createElement(C.a,{room:e,avatarSize:32}),i.a.createElement("span",{className:"mx_AddExistingToSpace_entry_name"},e.name),i.a.createElement(y.a,{onChange:s?e=>s(e.target.checked):null,checked:t,disabled:!s})),T=({space:e,footerPrompt:t,emptySelectionButton:o,onFinished:a})=>{const c=Object(n.useContext)(_.a),l=Object(n.useMemo)(()=>c.getVisibleRooms().filter(e=>"join"===e.getMyMembership()),[c]),[h,m]=Object(n.useState)(new Set),[y,w]=Object(n.useState)(null),[C,T]=Object(n.useState)(null),[j,N]=Object(n.useState)(""),P=j.toLowerCase().trim(),D=Object(n.useMemo)(()=>new Set(u.f.instance.getChildSpaces(e.roomId)),[e]),A=Object(n.useMemo)(()=>new Set(u.f.instance.getChildRooms(e.roomId)),[e]),[M,U,L]=Object(n.useMemo)(()=>{let t=l;if(P){t=new k.a(l,{keys:["name"],funcs:[e=>[e.getCanonicalAlias(),...e.getAltAliases()].filter(Boolean)],shouldMatchWordsOnly:!1}).match(P)}const s=e.getJoinRule();return Object(E.b)(t).reduce((t,n)=>(n.isSpaceRoom()?n===e||D.has(n)||t[0].push(n):A.has(n)||(f.a.shared().getUserIdForRoomId(n.roomId)?"public"!==s&&t[2].push(n):t[1].push(n)),t),[[],[],[]])},[l,e,P,A,D]),F=async()=>{let t;T(null),w(0);for(const s of h){const n=Object(b.b)(s);try{await u.f.instance.addRoomToSpace(e,s.roomId,n).catch(async t=>{if("M_LIMIT_EXCEEDED"===t.errcode)return await Object(v.c)(t.data.retry_after_ms),u.f.instance.addRoomToSpace(e,s.roomId,n);throw t}),w(e=>e+1)}catch(e){console.error("Failed to add rooms to space",e),T(t=e);break}}t||a(!0)},B=null!==y;let V;if(C)V=i.a.createElement(i.a.Fragment,null,i.a.createElement("img",{src:s(610),height:"24",width:"24",alt:""}),i.a.createElement("span",{className:"mx_AddExistingToSpaceDialog_error"},i.a.createElement("div",{className:"mx_AddExistingToSpaceDialog_errorHeading"},Object(r.a)("Not all selected were added")),i.a.createElement("div",{className:"mx_AddExistingToSpaceDialog_errorCaption"},Object(r.a)("Try again"))),i.a.createElement(p.a,{className:"mx_AddExistingToSpaceDialog_retryButton",onClick:F},Object(r.a)("Retry")));else if(B)V=i.a.createElement("span",null,i.a.createElement(S.a,{value:y,max:h.size}),i.a.createElement("div",{className:"mx_AddExistingToSpaceDialog_progressText"},Object(r.a)("Adding rooms... (%(progress)s out of %(count)s)",{count:h.size,progress:y})));else{let e=o;(!e||h.size>0)&&(e=i.a.createElement(p.a,{kind:"primary",disabled:h.size<1,onClick:F},Object(r.a)("Add"))),V=i.a.createElement(i.a.Fragment,null,i.a.createElement("span",null,t),e)}const K=B||C?null:(e,t)=>{e?h.add(t):h.delete(t),m(new Set(h))},[W,G]=Object(n.useState)(20);return i.a.createElement("div",{className:"mx_AddExistingToSpace"},i.a.createElement(d.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:Object(r.a)("Filter your rooms and spaces"),onSearch:N,autoComplete:!0,autoFocus:!0}),i.a.createElement(g.a,{className:"mx_AddExistingToSpace_content"},U.length>0?i.a.createElement("div",{className:"mx_AddExistingToSpace_section"},i.a.createElement("h3",null,Object(r.a)("Rooms")),i.a.createElement(O.a,{truncateAt:W,createOverflowElement:function(e,t){const n=Object(r.a)("and %(count)s others...",{count:e});return i.a.createElement(R.b,{className:"mx_EntityTile_ellipsis",avatarJsx:i.a.createElement(I.a,{url:s(283),name:"...",width:36,height:36}),name:n,presenceState:"online",suppressOnHover:!0,onClick:()=>G(t)})},getChildren:(e,t)=>U.slice(e,t).map(e=>i.a.createElement(x,{key:e.roomId,room:e,checked:h.has(e),onChange:K?t=>{K(t,e)}:null})),getChildCount:()=>U.length})):void 0,M.length>0?i.a.createElement("div",{className:"mx_AddExistingToSpace_section mx_AddExistingToSpace_section_spaces"},i.a.createElement("h3",null,Object(r.a)("Spaces")),i.a.createElement("div",{className:"mx_AddExistingToSpace_section_experimental"},i.a.createElement("div",null,Object(r.a)("Feeling experimental?")),i.a.createElement("div",null,Object(r.a)("You can add existing spaces to a space."))),M.map(e=>i.a.createElement(x,{key:e.roomId,room:e,checked:h.has(e),onChange:K?t=>{K(t,e)}:null}))):null,L.length>0?i.a.createElement("div",{className:"mx_AddExistingToSpace_section"},i.a.createElement("h3",null,Object(r.a)("Direct Messages")),L.map(e=>i.a.createElement(x,{key:e.roomId,room:e,checked:h.has(e),onChange:K?t=>{K(t,e)}:null}))):null,M.length+U.length+L.length<1?i.a.createElement("span",{className:"mx_AddExistingToSpace_noResults"},Object(r.a)("No results")):void 0),i.a.createElement("div",{className:"mx_AddExistingToSpace_footer"},V))};t.b=({matrixClient:e,space:t,onCreateRoomClick:s,onFinished:o})=>{const[d,g]=Object(n.useState)(t),v=u.f.instance.getChildSpaces(t.roomId);let f;if(v.length>0){const e=[t,...v].map(e=>{const t=a()("mx_AddExistingToSpaceDialog_dropdownOption",{mx_AddExistingToSpaceDialog_dropdownOptionActive:e===d});return i.a.createElement("div",{key:e.roomId,className:t},i.a.createElement(h.a,{room:e,width:24,height:24}),e.name||Object(m.a)(e)||e.roomId)});f=i.a.createElement(l.a,{id:"mx_SpaceSelectDropdown",onOptionChange:e=>{g(v.find(t=>t.roomId===e)||t)},value:d.roomId,label:Object(r.a)("Space selection")},e)}else f=i.a.createElement("div",{className:"mx_AddExistingToSpaceDialog_onlySpace"},t.name||Object(m.a)(t)||t.roomId);const b=i.a.createElement(i.a.Fragment,null,i.a.createElement(h.a,{room:d,height:40,width:40}),i.a.createElement("div",null,i.a.createElement("h1",null,Object(r.a)("Add existing rooms")),f));return i.a.createElement(c.a,{title:b,className:"mx_AddExistingToSpaceDialog",contentId:"mx_AddExistingToSpace",onFinished:o,fixedWidth:!1},i.a.createElement(_.a.Provider,{value:e},i.a.createElement(T,{space:t,onFinished:o,footerPrompt:i.a.createElement(i.a.Fragment,null,i.a.createElement("div",null,Object(r.a)("Want to add a new room instead?")),i.a.createElement(p.a,{onClick:()=>s(e,t),kind:"link"},Object(r.a)("Create a new room")))})),i.a.createElement(w.a,{onClick:()=>o(!1)}))}},function(e,t,s){"use strict";var n=s(91),i=s.n(n);t.a=({value:e,max:t})=>i.a.createElement("progress",{className:"mx_ProgressBar",max:t,value:e})},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(91),i=s.n(n),o=s(92),a=s(100),r=s(112);const c=({avatarUrl:e,avatarDisabled:t=!1,setAvatar:s})=>{const r=Object(n.useRef)(),[c,l]=Object(n.useState)(e);let d;return d=t?c?i.a.createElement("img",{className:"mx_SpaceBasicSettings_avatar",src:c,alt:""}):i.a.createElement("div",{className:"mx_SpaceBasicSettings_avatar"}):c?i.a.createElement(i.a.Fragment,null,i.a.createElement(a.a,{className:"mx_SpaceBasicSettings_avatar",onClick:()=>{var e;return null===(e=r.current)||void 0===e?void 0:e.click()},element:"img",src:c,alt:""}),i.a.createElement(a.a,{onClick:()=>{r.current.value="",l(void 0),s(void 0)},kind:"link",className:"mx_SpaceBasicSettings_avatar_remove"},Object(o.a)("Delete"))):i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_SpaceBasicSettings_avatar",onClick:()=>{var e;return null===(e=r.current)||void 0===e?void 0:e.click()}}),i.a.createElement(a.a,{onClick:()=>{var e;return null===(e=r.current)||void 0===e?void 0:e.click()},kind:"link"},Object(o.a)("Upload"))),i.a.createElement("div",{className:"mx_SpaceBasicSettings_avatarContainer"},d,i.a.createElement("input",{type:"file",ref:r,onChange:e=>{var t;if(null===(t=e.target.files)||void 0===t||!t.length)return;const n=e.target.files[0];s(n);const i=new FileReader;i.onload=e=>{l(e.target.result)},i.readAsDataURL(n)},accept:"image/*"}))};t.b=({avatarUrl:e,avatarDisabled:t=!1,setAvatar:s,name:n="",nameDisabled:a=!1,setName:l,topic:d="",topicDisabled:u=!1,setTopic:h})=>i.a.createElement("div",{className:"mx_SpaceBasicSettings"},i.a.createElement(c,{avatarUrl:e,avatarDisabled:t,setAvatar:s}),i.a.createElement(r.a,{name:"spaceName",label:Object(o.a)("Name"),autoFocus:!0,value:n,onChange:e=>l(e.target.value),disabled:a}),i.a.createElement(r.a,{name:"spaceTopic",element:"textarea",label:Object(o.a)("Description"),value:d,onChange:e=>h(e.target.value),rows:3,disabled:u}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(110),l=s(92),d=s(94),u=s(100),h=s(674),m=s(450),p=s(99),g=s(96),v=s(93);function f(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}let b=Object(v.a)("views.settings.tabs.room.AdvancedRoomSettingsTab")(n=class extends r.a.Component{constructor(e,t){super(e,t),o()(this,"upgradeRoom",e=>{const t=d.a.get().getRoom(this.props.roomId);p.a.createTrackedDialog("Upgrade Room Version","",h.a,{room:t})}),o()(this,"openDevtools",e=>{p.a.createDialog(m.b,{roomId:this.props.roomId})}),o()(this,"onOldRoomClicked",e=>{e.preventDefault(),e.stopPropagation(),g.a.dispatch({action:"view_room",room_id:this.state.oldRoomId,event_id:this.state.oldEventId}),this.props.closeSettingsFn()}),this.state={upgradeRecommendation:null};const s=d.a.get().getRoom(this.props.roomId);s.getRecommendedVersion().then(e=>{const t=s.currentState.getStateEvents(c.a.RoomTombstone,""),n={},i=s.currentState.getStateEvents(c.a.RoomCreate,""),a=i?i.getContent().predecessor:null;a&&a.room_id&&(n.oldRoomId=a.room_id,n.oldEventId=a.event_id),this.setState(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?f(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):f(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({upgraded:!(null==t||!t.getContent().replacement_room),upgradeRecommendation:e},n))})}render(){const e=d.a.get().getRoom(this.props.roomId);let t;const s=e.currentState.getStateEvents(c.a.RoomCreate,"");let n,i;if(s&&!1===s.getContent()["m.federate"]&&(t=r.a.createElement("div",null,Object(l.a)("This room is not accessible by remote Matrix servers"))),this.state.upgradeRecommendation&&this.state.upgradeRecommendation.needsUpgrade&&!this.state.upgraded&&(n=r.a.createElement("div",null,r.a.createElement("p",{className:"mx_SettingsTab_warningText"},Object(l.a)("<b>Warning</b>: Upgrading a room will <i>not automatically migrate room members to the new version of the room.</i> We'll post a link to the new room in the old version of the room - room members will have to click this link to join the new room.",{},{b:e=>r.a.createElement("b",null,e),i:e=>r.a.createElement("i",null,e)})),r.a.createElement(u.a,{onClick:this.upgradeRoom,kind:"primary"},Object(l.a)("Upgrade this room to the recommended room version")))),this.state.oldRoomId){let e=Object(l.a)("this room");const t=d.a.get().getRoom(this.props.roomId);t&&t.name&&(e=t.name),i=r.a.createElement(u.a,{element:"a",onClick:this.onOldRoomClicked},Object(l.a)("View older messages in %(roomName)s.",{roomName:e}))}return r.a.createElement("div",{className:"mx_SettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Advanced")),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},null!=e&&e.isSpaceRoom()?Object(l.a)("Space information"):Object(l.a)("Room information")),r.a.createElement("div",null,r.a.createElement("span",null,Object(l.a)("Internal room ID:"))," ",this.props.roomId),t),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Room version")),r.a.createElement("div",null,r.a.createElement("span",null,Object(l.a)("Room version:"))," ",e.getVersion()),i,n),r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Developer options")),r.a.createElement(u.a,{onClick:this.openDevtools,kind:"primary"},Object(l.a)("Open Devtools"))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return w})),s.d(t,"b",(function(){return A}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(95),l=s(451),d=s(92),u=s(112),h=s(105),m=s(131),p=s(216),g=s(217),v=s(123),f=s(741),b=s(98),y=s(99),_=s(135),E=s(93);class S extends r.a.PureComponent{constructor(...e){super(...e),o()(this,"onBack",()=>{this.state.message?this.setState({message:null}):this.props.onBack()}),o()(this,"onChange",e=>{this.setState({[e.target.id]:"checkbox"===e.target.type?e.target.checked:e.target.value})})}buttons(){return r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(d.a)("Back")),!this.state.message&&r.a.createElement("button",{onClick:this.send},Object(d.a)("Send")))}textInput(e,t){return r.a.createElement(u.a,{id:e,label:t,size:42,autoFocus:!0,type:"text",autoComplete:"on",value:this.state[e],onChange:this.onChange})}}class w extends S{static getLabel(){return Object(d.a)("Send Custom Event")}constructor(e){super(e),o()(this,"send",async()=>{if(""===this.state.eventType)return void this.setState({message:Object(d.a)("You must specify an event type!")});let e;try{const t=JSON.parse(this.state.evContent);await this.doSend(t),e=Object(d.a)("Event sent!")}catch(t){e=Object(d.a)("Failed to send custom event.")+" ("+t.toString()+")"}this.setState({message:e})});const{eventType:t,stateKey:s,evContent:n}=Object.assign({eventType:"",stateKey:"",evContent:"{\n\n}"},this.props.inputs);this.state={isStateEvent:Boolean(this.props.forceStateEvent),eventType:t,stateKey:s,evContent:n}}doSend(e){const t=this.context;return this.state.isStateEvent?t.sendStateEvent(this.props.room.roomId,this.state.eventType,e,this.state.stateKey):t.sendEvent(this.props.room.roomId,this.state.eventType,e)}render(){if(this.state.message)return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},this.state.message),this.buttons());const e=!this.state.message&&!this.props.forceStateEvent&&!this.props.forceGeneralEvent;return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_DevTools_content"},r.a.createElement("div",{className:"mx_DevTools_eventTypeStateKeyGroup"},this.textInput("eventType",Object(d.a)("Event Type")),this.state.isStateEvent&&this.textInput("stateKey",Object(d.a)("State Key"))),r.a.createElement("br",null),r.a.createElement(u.a,{id:"evContent",label:Object(d.a)("Event Content"),type:"text",className:"mx_DevTools_textarea",autoComplete:"off",value:this.state.evContent,onChange:this.onChange,element:"textarea"})),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(d.a)("Back")),!this.state.message&&r.a.createElement("button",{onClick:this.send},Object(d.a)("Send")),e&&r.a.createElement("div",{style:{float:"right"}},r.a.createElement("input",{id:"isStateEvent",className:"mx_DevTools_tgl mx_DevTools_tgl-flip",type:"checkbox",checked:this.state.isStateEvent,onChange:this.onChange}),r.a.createElement("label",{className:"mx_DevTools_tgl-btn","data-tg-off":"Event","data-tg-on":"State Event",htmlFor:"isStateEvent"}))))}}o()(w,"contextType",h.a);class C extends S{static getLabel(){return Object(d.a)("Send Account Data")}constructor(e){super(e),o()(this,"send",async()=>{if(""===this.state.eventType)return void this.setState({message:Object(d.a)("You must specify an event type!")});let e;try{const t=JSON.parse(this.state.evContent);await this.doSend(t),e=Object(d.a)("Event sent!")}catch(t){e=Object(d.a)("Failed to send custom event.")+" ("+t.toString()+")"}this.setState({message:e})});const{eventType:t,evContent:s}=Object.assign({eventType:"",evContent:"{\n\n}"},this.props.inputs);this.state={isRoomAccountData:Boolean(this.props.isRoomAccountData),eventType:t,evContent:s}}doSend(e){const t=this.context;return this.state.isRoomAccountData?t.setRoomAccountData(this.props.room.roomId,this.state.eventType,e):t.setAccountData(this.state.eventType,e)}render(){return this.state.message?r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},this.state.message),this.buttons()):r.a.createElement("div",null,r.a.createElement("div",{className:"mx_DevTools_content"},this.textInput("eventType",Object(d.a)("Event Type")),r.a.createElement("br",null),r.a.createElement(u.a,{id:"evContent",label:Object(d.a)("Event Content"),type:"text",className:"mx_DevTools_textarea",autoComplete:"off",value:this.state.evContent,onChange:this.onChange,element:"textarea"})),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(d.a)("Back")),!this.state.message&&r.a.createElement("button",{onClick:this.send},Object(d.a)("Send")),!this.state.message&&r.a.createElement("div",{style:{float:"right"}},r.a.createElement("input",{id:"isRoomAccountData",className:"mx_DevTools_tgl mx_DevTools_tgl-flip",type:"checkbox",checked:this.state.isRoomAccountData,disabled:this.props.forceMode,onChange:this.onChange}),r.a.createElement("label",{className:"mx_DevTools_tgl-btn","data-tg-off":"Account Data","data-tg-on":"Room Data",htmlFor:"isRoomAccountData"}))))}}o()(C,"contextType",h.a);class k extends r.a.PureComponent{static filterChildren(e,t){if(!t)return e;const s=t.toLowerCase();return e.filter(e=>e.key.toString().toLowerCase().includes(s))}constructor(e){super(e),o()(this,"showAll",()=>{this.setState({truncateAt:this.state.truncateAt+50})}),o()(this,"createOverflowElement",(e,t)=>r.a.createElement("button",{className:"mx_DevTools_RoomStateExplorer_button",onClick:this.showAll},Object(d.a)("and %(count)s others...",{count:e}))),o()(this,"onQuery",e=>{this.props.onChange&&this.props.onChange(e.target.value)}),o()(this,"getChildren",(e,t)=>this.state.filteredChildren.slice(e,t)),o()(this,"getChildCount",()=>this.state.filteredChildren.length),this.state={filteredChildren:k.filterChildren(this.props.children,this.props.query),truncateAt:20}}UNSAFE_componentWillReceiveProps(e){this.props.children===e.children&&this.props.query===e.query||this.setState({filteredChildren:k.filterChildren(e.children,e.query),truncateAt:20})}render(){const e=c.getComponent("elements.TruncatedList");return r.a.createElement("div",null,r.a.createElement(u.a,{label:Object(d.a)("Filter results"),autoFocus:!0,size:64,type:"text",autoComplete:"off",value:this.props.query,onChange:this.onQuery,className:"mx_TextInputDialog_input mx_DevTools_RoomStateExplorer_query",key:this.props.children[0]?this.props.children[0].key:""}),r.a.createElement(e,{getChildren:this.getChildren,getChildCount:this.getChildCount,truncateAt:this.state.truncateAt,createOverflowElement:this.createOverflowElement}))}}class O extends r.a.PureComponent{static getLabel(){return Object(d.a)("Explore Room State")}constructor(e){super(e),o()(this,"roomStateEvents",void 0),o()(this,"onBack",()=>{this.state.editing?this.setState({editing:!1}):this.state.event?this.setState({event:null}):this.state.eventType?this.setState({eventType:null}):this.props.onBack()}),o()(this,"editEv",()=>{this.setState({editing:!0})}),o()(this,"onQueryEventType",e=>{this.setState({queryEventType:e})}),o()(this,"onQueryStateKey",e=>{this.setState({queryStateKey:e})}),this.roomStateEvents=this.props.room.currentState.events,this.state={eventType:null,event:null,editing:!1,queryEventType:"",queryStateKey:""}}browseEventType(e){return()=>{this.setState({eventType:e})}}onViewSourceClick(e){return()=>{this.setState({event:e})}}render(){if(this.state.event)return this.state.editing?r.a.createElement(w,{room:this.props.room,forceStateEvent:!0,onBack:this.onBack,inputs:{eventType:this.state.event.getType(),evContent:JSON.stringify(this.state.event.getContent(),null,"\t"),stateKey:this.state.event.getStateKey()}}):r.a.createElement("div",{className:"mx_ViewSource"},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement(l.a,{className:"json"},JSON.stringify(this.state.event.event,null,2))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(d.a)("Back")),r.a.createElement("button",{onClick:this.editEv},Object(d.a)("Edit"))));let e=null;const t="mx_DevTools_RoomStateExplorer_button";if(null===this.state.eventType)e=r.a.createElement(k,{query:this.state.queryEventType,onChange:this.onQueryEventType},Array.from(this.roomStateEvents.entries()).map(([e,s])=>{let n;return n=1===s.size&&s.has("")?this.onViewSourceClick(s.get("")):this.browseEventType(e),r.a.createElement("button",{className:t,key:e,onClick:n},e)}));else{const s=this.roomStateEvents.get(this.state.eventType);e=r.a.createElement(k,{query:this.state.queryStateKey,onChange:this.onQueryStateKey},Array.from(s.entries()).map(([e,s])=>r.a.createElement("button",{className:t,key:e,onClick:this.onViewSourceClick(s)},e)))}return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},e),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(d.a)("Back"))))}}o()(O,"contextType",h.a);class R extends r.a.PureComponent{static getLabel(){return Object(d.a)("Explore Account Data")}constructor(e){super(e),o()(this,"onBack",()=>{this.state.editing?this.setState({editing:!1}):this.state.event?this.setState({event:null}):this.props.onBack()}),o()(this,"onChange",e=>{this.setState({[e.target.id]:"checkbox"===e.target.type?e.target.checked:e.target.value})}),o()(this,"editEv",()=>{this.setState({editing:!0})}),o()(this,"onQueryEventType",e=>{this.setState({queryEventType:e})}),this.state={isRoomAccountData:!1,event:null,editing:!1,queryEventType:""}}getData(){return this.state.isRoomAccountData?this.props.room.accountData:this.context.store.accountData}onViewSourceClick(e){return()=>{this.setState({event:e})}}render(){if(this.state.event)return this.state.editing?r.a.createElement(C,{room:this.props.room,isRoomAccountData:this.state.isRoomAccountData,onBack:this.onBack,inputs:{eventType:this.state.event.getType(),evContent:JSON.stringify(this.state.event.getContent(),null,"\t")},forceMode:!0}):r.a.createElement("div",{className:"mx_ViewSource"},r.a.createElement("div",{className:"mx_DevTools_content"},r.a.createElement(l.a,{className:"json"},JSON.stringify(this.state.event.event,null,2))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(d.a)("Back")),r.a.createElement("button",{onClick:this.editEv},Object(d.a)("Edit"))));const e=[],t=this.getData();return Object.keys(t).forEach(s=>{const n=t[s];e.push(r.a.createElement("button",{className:"mx_DevTools_RoomStateExplorer_button",key:s,onClick:this.onViewSourceClick(n)},s))}),r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement(k,{query:this.state.queryEventType,onChange:this.onQueryEventType},e)),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(d.a)("Back")),r.a.createElement("div",{style:{float:"right"}},r.a.createElement("input",{id:"isRoomAccountData",className:"mx_DevTools_tgl mx_DevTools_tgl-flip",type:"checkbox",checked:this.state.isRoomAccountData,onChange:this.onChange}),r.a.createElement("label",{className:"mx_DevTools_tgl-btn","data-tg-off":"Account Data","data-tg-on":"Room Data",htmlFor:"isRoomAccountData"}))))}}o()(R,"contextType",h.a);class I extends r.a.PureComponent{static getLabel(){return Object(d.a)("View Servers in Room")}constructor(e){super(e),o()(this,"servers",void 0),o()(this,"onQuery",e=>{this.setState({query:e})});const t=this.props.room,s=new Set;t.currentState.getStateEvents("m.room.member").forEach(e=>s.add(e.getSender().split(":")[1])),this.servers=Array.from(s).map(e=>r.a.createElement("button",{key:e,className:"mx_DevTools_ServersInRoomList_button"},e)),this.state={query:""}}render(){return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement(k,{query:this.state.query,onChange:this.onQuery},this.servers)),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.props.onBack},Object(d.a)("Back"))))}}o()(I,"contextType",h.a);const x={[p.g]:"unsent",[p.e]:"requested",[p.d]:"ready",[p.c]:"done",[p.f]:"started",[p.b]:"cancelled"},T=({txnId:e,request:t})=>{const[,s]=Object(a.useState)(),[n,i]=Object(a.useState)(t.timeout);return Object(m.a)(t,"change",s),Object(a.useEffect)(()=>{if(0==t.timeout)return;const e=setInterval(()=>{i(t.timeout)},500);return()=>{clearInterval(e)}},[t]),r.a.createElement("div",{className:"mx_DevTools_VerificationRequest"},r.a.createElement("dl",null,r.a.createElement("dt",null,"Transaction"),r.a.createElement("dd",null,e),r.a.createElement("dt",null,"Phase"),r.a.createElement("dd",null,x[t.phase]||t.phase),r.a.createElement("dt",null,"Timeout"),r.a.createElement("dd",null,Math.floor(n/1e3)),r.a.createElement("dt",null,"Methods"),r.a.createElement("dd",null,t.methods&&t.methods.join(", ")),r.a.createElement("dt",null,"requestingUserId"),r.a.createElement("dd",null,t.requestingUserId),r.a.createElement("dt",null,"observeOnly"),r.a.createElement("dd",null,JSON.stringify(t.observeOnly))))};class j extends r.a.PureComponent{constructor(...e){super(...e),o()(this,"onNewRequest",()=>{this.forceUpdate()})}static getLabel(){return Object(d.a)("Verification Requests")}componentDidMount(){this.context.on("crypto.verification.request",this.onNewRequest)}componentWillUnmount(){this.context.off("crypto.verification.request",this.onNewRequest)}render(){const e=this.context,t=this.props.room,s=(e.crypto.inRoomVerificationRequests._requestsByRoomId||new Map).get(t.roomId)||new Map;return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},Array.from(s.entries()).reverse().map(([e,t])=>r.a.createElement(T,{txnId:e,request:t,key:e}))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.props.onBack},Object(d.a)("Back"))))}}o()(j,"contextType",h.a);class N extends r.a.Component{static getLabel(){return Object(d.a)("Active Widgets")}constructor(e){super(e),o()(this,"onWidgetStoreUpdate",()=>{this.forceUpdate()}),o()(this,"onQueryChange",e=>{this.setState({query:e})}),o()(this,"onEditWidget",e=>{this.setState({editWidget:e})}),o()(this,"onBack",()=>{const e=g.a.instance.getApps(this.props.room.roomId);this.state.editWidget&&e.includes(this.state.editWidget)?this.setState({editWidget:null}):this.props.onBack()}),this.state={query:"",editWidget:null}}componentDidMount(){g.a.instance.on(v.b,this.onWidgetStoreUpdate)}componentWillUnmount(){g.a.instance.off(v.b,this.onWidgetStoreUpdate)}render(){const e=this.props.room,t=this.state.editWidget,s=g.a.instance.getApps(e.roomId);if(t&&s.includes(t)){const s=Array.from(Array.from(e.currentState.events.values()).map(e=>e.values())).reduce((e,t)=>(e.push(...t),e),[]).find(e=>e.getId()===t.eventId);return s?r.a.createElement(w,{onBack:this.onBack,room:e,forceStateEvent:!0,inputs:{eventType:s.getType(),evContent:JSON.stringify(s.getContent(),null,"\t"),stateKey:s.getStateKey()}}):r.a.createElement("div",null,Object(d.a)("There was an error finding this widget."),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(d.a)("Back"))))}return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement(k,{query:this.state.query,onChange:this.onQueryChange},s.map(e=>r.a.createElement("button",{className:"mx_DevTools_RoomStateExplorer_button",key:e.url+e.eventId,onClick:()=>this.onEditWidget(e)},e.url)))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(d.a)("Back"))))}}class P extends r.a.PureComponent{static getLabel(){return Object(d.a)("Settings Explorer")}constructor(e){super(e),o()(this,"onQueryChange",e=>{this.setState({query:e.target.value})}),o()(this,"onExplValuesEdit",e=>{this.setState({explicitValues:e.target.value})}),o()(this,"onExplRoomValuesEdit",e=>{this.setState({explicitRoomValues:e.target.value})}),o()(this,"onBack",()=>{this.state.editSetting?this.setState({editSetting:null}):this.state.viewSetting?this.setState({viewSetting:null}):this.props.onBack()}),o()(this,"onViewClick",(e,t)=>{e.preventDefault(),this.setState({viewSetting:t})}),o()(this,"onEditClick",(e,t)=>{e.preventDefault(),this.setState({editSetting:t,explicitValues:this.renderExplicitSettingValues(t,null),explicitRoomValues:this.renderExplicitSettingValues(t,this.props.room.roomId)})}),o()(this,"onSaveClick",async()=>{try{const e=this.state.editSetting,t=JSON.parse(this.state.explicitValues),s=JSON.parse(this.state.explicitRoomValues);for(const s of Object.keys(t)){console.log(`[Devtools] Setting value of ${e} at ${s} from user input`);try{const n=t[s];await b.b.setValue(e,null,s,n)}catch(e){console.warn(e)}}const n=this.props.room.roomId;for(const i of Object.keys(t)){console.log(`[Devtools] Setting value of ${e} at ${i} in ${n} from user input`);try{const t=s[i];await b.b.setValue(e,n,i,t)}catch(e){console.warn(e)}}this.setState({viewSetting:e,editSetting:null})}catch(e){y.a.createTrackedDialog("Devtools - Failed to save settings","",_.a,{title:Object(d.a)("Failed to save settings"),description:e.message})}}),this.state={query:"",editSetting:null,viewSetting:null,explicitValues:null,explicitRoomValues:null}}renderSettingValue(e){return["boolean","number"].includes(typeof e)?e.toString():JSON.stringify(e)}renderExplicitSettingValues(e,t){const s={};for(const n of b.a)try{s[n]=b.b.getValueAt(n,e,t,!0,!0),void 0===s[n]&&(s[n]=null)}catch(e){console.warn(e)}return JSON.stringify(s,null,4)}renderCanEditLevel(e,t){const s=b.b.canSetValue(this.state.editSetting,e,t),n=s?"mx_DevTools_SettingsExplorer_mutable":"mx_DevTools_SettingsExplorer_immutable";return r.a.createElement("td",{className:n},r.a.createElement("code",null,s.toString()))}render(){const e=this.props.room;if(!this.state.viewSetting&&!this.state.editSetting){const t=Object.keys(f.a).filter(e=>!this.state.query||e.toLowerCase().includes(this.state.query.toLowerCase()));return r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content mx_DevTools_SettingsExplorer"},r.a.createElement(u.a,{label:Object(d.a)("Filter results"),autoFocus:!0,size:64,type:"text",autoComplete:"off",value:this.state.query,onChange:this.onQueryChange,className:"mx_TextInputDialog_input mx_DevTools_RoomStateExplorer_query"}),r.a.createElement("table",null,r.a.createElement("thead",null,r.a.createElement("tr",null,r.a.createElement("th",null,Object(d.a)("Setting ID")),r.a.createElement("th",null,Object(d.a)("Value")),r.a.createElement("th",null,Object(d.a)("Value in this room")))),r.a.createElement("tbody",null,t.map(t=>r.a.createElement("tr",{key:t},r.a.createElement("td",null,r.a.createElement("a",{href:"",onClick:e=>this.onViewClick(e,t)},r.a.createElement("code",null,t)),r.a.createElement("a",{href:"",onClick:e=>this.onEditClick(e,t),className:"mx_DevTools_SettingsExplorer_edit"},"✏")),r.a.createElement("td",null,r.a.createElement("code",null,this.renderSettingValue(b.b.getValue(t)))),r.a.createElement("td",null,r.a.createElement("code",null,this.renderSettingValue(b.b.getValue(t,e.roomId))))))))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onBack},Object(d.a)("Back"))))}return this.state.editSetting?r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content mx_DevTools_SettingsExplorer"},r.a.createElement("h3",null,Object(d.a)("Setting:")," ",r.a.createElement("code",null,this.state.editSetting)),r.a.createElement("div",{className:"mx_DevTools_SettingsExplorer_warning"},r.a.createElement("b",null,Object(d.a)("Caution:"))," ",Object(d.a)("This UI does NOT check the types of the values. Use at your own risk.")),r.a.createElement("div",null,Object(d.a)("Setting definition:"),r.a.createElement("pre",null,r.a.createElement("code",null,JSON.stringify(f.a[this.state.editSetting],null,4)))),r.a.createElement("div",null,r.a.createElement("table",null,r.a.createElement("thead",null,r.a.createElement("tr",null,r.a.createElement("th",null,Object(d.a)("Level")),r.a.createElement("th",null,Object(d.a)("Settable at global")),r.a.createElement("th",null,Object(d.a)("Settable at room")))),r.a.createElement("tbody",null,b.a.map(t=>r.a.createElement("tr",{key:t},r.a.createElement("td",null,r.a.createElement("code",null,t)),this.renderCanEditLevel(null,t),this.renderCanEditLevel(e.roomId,t)))))),r.a.createElement("div",null,r.a.createElement(u.a,{id:"valExpl",label:Object(d.a)("Values at explicit levels"),type:"text",className:"mx_DevTools_textarea",element:"textarea",autoComplete:"off",value:this.state.explicitValues,onChange:this.onExplValuesEdit})),r.a.createElement("div",null,r.a.createElement(u.a,{id:"valExpl",label:Object(d.a)("Values at explicit levels in this room"),type:"text",className:"mx_DevTools_textarea",element:"textarea",autoComplete:"off",value:this.state.explicitRoomValues,onChange:this.onExplRoomValuesEdit}))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onSaveClick},Object(d.a)("Save setting values")),r.a.createElement("button",{onClick:this.onBack},Object(d.a)("Back")))):this.state.viewSetting?r.a.createElement("div",null,r.a.createElement("div",{className:"mx_Dialog_content mx_DevTools_SettingsExplorer"},r.a.createElement("h3",null,Object(d.a)("Setting:")," ",r.a.createElement("code",null,this.state.viewSetting)),r.a.createElement("div",null,Object(d.a)("Setting definition:"),r.a.createElement("pre",null,r.a.createElement("code",null,JSON.stringify(f.a[this.state.viewSetting],null,4)))),r.a.createElement("div",null,Object(d.a)("Value:")," ",r.a.createElement("code",null,this.renderSettingValue(b.b.getValue(this.state.viewSetting)))),r.a.createElement("div",null,Object(d.a)("Value in this room:")," ",r.a.createElement("code",null,this.renderSettingValue(b.b.getValue(this.state.viewSetting,e.roomId)))),r.a.createElement("div",null,Object(d.a)("Values at explicit levels:"),r.a.createElement("pre",null,r.a.createElement("code",null,this.renderExplicitSettingValues(this.state.viewSetting,null)))),r.a.createElement("div",null,Object(d.a)("Values at explicit levels in this room:"),r.a.createElement("pre",null,r.a.createElement("code",null,this.renderExplicitSettingValues(this.state.viewSetting,e.roomId))))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:e=>this.onEditClick(e,this.state.viewSetting)},Object(d.a)("Edit Values")),r.a.createElement("button",{onClick:this.onBack},Object(d.a)("Back")))):void 0}}const D=[w,O,C,R,I,j,N,P];let A=Object(E.a)("views.dialogs.DevtoolsDialog")(n=class extends r.a.PureComponent{constructor(e){super(e),o()(this,"onBack",()=>{this.setState({mode:null})}),o()(this,"onCancel",()=>{this.props.onFinished(!1)}),this.state={mode:null}}setMode(e){return()=>{this.setState({mode:e})}}render(){let e;if(this.state.mode)e=r.a.createElement(h.a.Consumer,null,e=>r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_DevTools_label_left"},this.state.mode.getLabel()),r.a.createElement("div",{className:"mx_DevTools_label_right"},"Room ID: ",this.props.roomId),r.a.createElement("div",{className:"mx_DevTools_label_bottom"}),r.a.createElement(this.state.mode,{onBack:this.onBack,room:e.getRoom(this.props.roomId)})));else{const t="mx_DevTools_RoomStateExplorer_button";e=r.a.createElement(r.a.Fragment,null,r.a.createElement("div",null,r.a.createElement("div",{className:"mx_DevTools_label_left"},Object(d.a)("Toolbox")),r.a.createElement("div",{className:"mx_DevTools_label_right"},"Room ID: ",this.props.roomId),r.a.createElement("div",{className:"mx_DevTools_label_bottom"}),r.a.createElement("div",{className:"mx_Dialog_content"},D.map(e=>{const s=e.getLabel(),n=this.setMode(e);return r.a.createElement("button",{className:t,key:s,onClick:n},s)}))),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onCancel},Object(d.a)("Cancel"))))}const t=c.getComponent("views.dialogs.BaseDialog");return r.a.createElement(t,{className:"mx_QuestionDialog",onFinished:this.props.onFinished,title:Object(d.a)("Developer Tools")},e)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(675),m=s(93);let p=Object(m.a)("views.elements.SyntaxHighlight")((o=i=class extends l.a.Component{constructor(e){super(e),this._ref=this._ref.bind(this)}componentDidUpdate(){this._el&&Object(h.highlightBlock)(this._el)}_ref(e){this._el=e,this.componentDidUpdate()}render(){const{className:e,children:t}=this.props;return l.a.createElement("pre",{className:e+" mx_SyntaxHighlight",ref:this._ref},l.a.createElement("code",null,t))}},r()(i,"propTypes",{className:u.a.string,children:u.a.node}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(18),i=s.n(n);class o{constructor(e,t){this.fn=e,this.onMarkCallback=t,i()(this,"marked",!1)}reset(){this.marked=!1}mark(){var e;this.marked||null===(e=this.onMarkCallback)||void 0===e||e.call(this),this.marked=!0}trigger(){this.marked&&(this.reset(),this.fn())}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(113),d=s(175);const u=e=>{let{inputRef:t}=e,s=a()(e,["inputRef"]);const[n,o,r]=Object(d.e)(t);return c.a.createElement(l.a,i()({},s,{onFocus:n,inputRef:r,tabIndex:o?0:-1}))}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return j})),s.d(t,"b",(function(){return N}));var n,i=s(18),o=s.n(i),a=s(91),r=s(1),c=s(101),l=s.n(c),d=s(175),u=s(92),h=s(100),m=s(681),p=s(109),g=s(159),v=s(233),f=s(146),b=s(96),y=s(180),_=s(113),E=s(111),S=s(284),w=s(1222),C=s(174),k=s(748),O=s(121),R=s(141),I=s(176),x=s(184),T=s(93);const j=32;Object(w.a)();let N=Object(T.a)("views.rooms.RoomSublist")(n=class t extends a.Component{constructor(t){super(t),o()(this,"headerButton",Object(a.createRef)()),o()(this,"sublistRef",Object(a.createRef)()),o()(this,"tilesRef",Object(a.createRef)()),o()(this,"dispatcherRef",void 0),o()(this,"layout",void 0),o()(this,"heightAtStart",void 0),o()(this,"isBeingFiltered",void 0),o()(this,"notificationState",void 0),o()(this,"onListsUpdated",()=>{const e={};if(this.props.extraTiles){const t=g.b.instance.getFirstNameFilterCondition();t?e.filteredExtraTiles=this.props.extraTiles.filter(e=>t.matches(Object(r.x)(e.props.displayName||""))):this.state.filteredExtraTiles&&(e.filteredExtraTiles=null)}const t=this.state.rooms,s=Object(O.b)(g.b.instance.orderedLists[this.props.tagId]||[]);Object(O.e)(t,s)&&(e.rooms=s);const n=!!g.b.instance.getFirstNameFilterCondition();n!==this.isBeingFiltered&&(this.isBeingFiltered=n,e.isExpanded=!!n||!this.layout.isCollapsed),Object.keys(e).length>0&&this.setState(e)}),o()(this,"onAction",t=>{"view_room"===t.action&&t.show_room_tile&&this.state.rooms&&e(()=>{const e=this.state.rooms.findIndex(e=>e.roomId===t.room_id);!this.state.isExpanded&&e>-1&&this.toggleCollapsed(),e>=this.numVisibleTiles&&(this.layout.visibleTiles=this.layout.tilesWithPadding(e+1,32),this.forceUpdate())})}),o()(this,"onAddRoom",e=>{e.stopPropagation(),this.props.onAddRoom&&this.props.onAddRoom()}),o()(this,"onAddGroupRoom",e=>{e.stopPropagation(),this.props.onAddGroupRoom&&this.props.onAddGroupRoom()}),o()(this,"onAddDirectRoom",e=>{e.stopPropagation(),this.props.onAddDirectRoom&&this.props.onAddDirectRoom()}),o()(this,"onResize",(e,t,s,n)=>{const i=this.heightAtStart+n.height;this.applyHeightChange(i),this.setState({height:i})}),o()(this,"onResizeStart",()=>{this.heightAtStart=this.state.height,this.setState({isResizing:!0})}),o()(this,"onResizeStop",(e,t,s,n)=>{const i=this.heightAtStart+n.height;this.applyHeightChange(i),this.setState({isResizing:!1,height:i})}),o()(this,"onShowAllClick",()=>{const e=this.numVisibleTiles,t=this.layout.tilesToPixelsWithPadding(this.numTiles,this.padding);this.applyHeightChange(t),this.setState({height:t},()=>{this.focusRoomTile(e)})}),o()(this,"onShowLessClick",()=>{const e=this.layout.tilesToPixelsWithPadding(this.layout.defaultVisibleTiles,this.padding);this.applyHeightChange(e),this.setState({height:e})}),o()(this,"focusRoomTile",e=>{if(!this.sublistRef.current)return;const t=this.sublistRef.current.querySelectorAll(".mx_RoomTile"),s=t&&t[e];s&&s.focus()}),o()(this,"onOpenMenuClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})}),o()(this,"onContextMenu",e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,height:0}})}),o()(this,"onAddRoomContextMenu",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({addRoomContextMenuPosition:t.getBoundingClientRect()})}),o()(this,"onCloseMenu",()=>{this.setState({contextMenuPosition:null})}),o()(this,"onCloseAddRoomMenu",()=>{this.setState({addRoomContextMenuPosition:null})}),o()(this,"onUnreadFirstChanged",async()=>{const e=g.b.instance.getListOrder(this.props.tagId)===v.a.Importance?v.a.Natural:v.a.Importance;await g.b.instance.setListOrder(this.props.tagId,e),this.forceUpdate()}),o()(this,"onTagSortChanged",async e=>{await g.b.instance.setTagSorting(this.props.tagId,e)}),o()(this,"onMessagePreviewChanged",()=>{this.layout.showPreviews=!this.layout.showPreviews,this.forceUpdate()}),o()(this,"onBadgeClick",e=>{let t;e.preventDefault(),e.stopPropagation(),t=this.props.tagId===f.a.Invite?this.state.rooms&&this.state.rooms[0]:g.b.instance.unfilteredLists[this.props.tagId].find(e=>{const t=this.notificationState.getForRoom(e);return t.count>0&&t.color===this.notificationState.color}),t&&b.a.dispatch({action:"view_room",room_id:t.roomId,show_room_tile:!0})}),o()(this,"onHeaderClick",()=>{const t=this.headerButton.current.parentElement,s=t.parentElement.parentElement,n=s.parentElement.parentElement,i=Math.round(n.scrollTop),o=i<=Math.round(j),a=i>=Math.round(n.scrollHeight-n.offsetHeight),r=t.classList.contains("mx_RoomSublist_headerContainer_stickyTop"),c=t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom");if(c&&!a||r&&!o)s.scrollIntoView({behavior:"smooth"});else{const t=this.state.isExpanded;this.toggleCollapsed(),!t&&c&&e(()=>{s.scrollIntoView({behavior:"smooth"})})}}),o()(this,"toggleCollapsed",()=>{this.layout.isCollapsed=this.state.isExpanded,this.setState({isExpanded:!this.layout.isCollapsed}),this.props.onListCollapse&&this.props.onListCollapse(!this.layout.isCollapsed)}),o()(this,"onHeaderKeyDown",e=>{switch(Object(x.f)().getRoomListAction(e)){case x.e.CollapseSection:e.stopPropagation(),this.state.isExpanded&&this.toggleCollapsed();break;case x.e.ExpandSection:if(e.stopPropagation(),this.state.isExpanded){if(this.sublistRef.current){const e=this.sublistRef.current.querySelector(".mx_RoomTile");e&&e.focus()}}else this.toggleCollapsed()}}),o()(this,"onKeyDown",e=>{switch(e.key){case E.a.ARROW_LEFT:e.stopPropagation(),this.headerButton.current.focus();break;case E.a.ARROW_RIGHT:e.stopPropagation()}}),this.layout=k.a.instance.getLayoutFor(this.props.tagId),this.heightAtStart=0,this.isBeingFiltered=!!g.b.instance.getFirstNameFilterCondition(),this.notificationState=C.a.instance.getListState(this.props.tagId),this.state={contextMenuPosition:null,addRoomContextMenuPosition:null,isResizing:!1,isExpanded:this.isBeingFiltered?this.isBeingFiltered:!this.layout.isCollapsed,height:0,rooms:Object(O.b)(g.b.instance.orderedLists[this.props.tagId]||[])},this.state=Object.assign(this.state,{height:this.calculateInitialHeight()})}calculateInitialHeight(){const e=Math.max(Math.floor(this.layout.visibleTiles),this.layout.minVisibleTiles),t=Math.min(this.numTiles,e);return this.layout.tilesToPixelsWithPadding(t,this.padding)}get padding(){let e=4;const t=this.numTiles>this.numVisibleTiles,s=this.numTiles>this.layout.defaultVisibleTiles;return(t||s)&&(e+=28),e}get extraTiles(){return this.state.filteredExtraTiles?this.state.filteredExtraTiles:this.props.extraTiles?this.props.extraTiles:null}get numTiles(){return t.calcNumTiles(this.state.rooms,this.extraTiles)}static calcNumTiles(e,t){return(e||[]).length+(t||[]).length}get numVisibleTiles(){const e=Math.ceil(this.layout.visibleTiles);return Math.min(e,this.numTiles)}componentDidUpdate(e,s){const n=s.filteredExtraTiles||e.extraTiles;t.calcNumTiles(s.rooms,n)!==this.numTiles&&this.setState({height:this.calculateInitialHeight()})}shouldComponentUpdate(e,s){if(Object(R.d)(this.props,e))return!0;const n=Object(R.c)(this.state,["rooms"]),i=Object(R.c)(s,["rooms"]);if(Object(R.d)(n,i))return!0;const o=this.props.extraTiles||[],a=s.filteredExtraTiles||e.extraTiles||[];if(o.length>0||a.length>0)return!0;if(t.calcNumTiles(s.rooms,a)!==this.numTiles)return!0;if(!s.isExpanded)return!1;if(this.state.rooms.length!==s.rooms.length)return!0;const r=this.state.rooms.slice(0,this.numVisibleTiles),c=s.rooms.slice(0,this.numVisibleTiles);return!!Object(O.e)(r,c)}componentDidMount(){var e;this.dispatcherRef=b.a.register(this.onAction),g.b.instance.on(g.a,this.onListsUpdated),null===(e=this.tilesRef.current)||void 0===e||e.addEventListener("scroll",this.onScrollPrevent,{passive:!0})}componentWillUnmount(){var e;b.a.unregister(this.dispatcherRef),g.b.instance.off(g.a,this.onListsUpdated),null===(e=this.tilesRef.current)||void 0===e||e.removeEventListener("scroll",this.onScrollPrevent)}applyHeightChange(e){const t=Math.ceil(this.layout.pixelsToTiles(e-this.padding));this.layout.visibleTiles=Math.min(this.numTiles,t)}renderVisibleTiles(){if(!this.state.isExpanded)return[];const e=[];if(this.state.rooms){const t=this.state.rooms.slice(0,this.numVisibleTiles);for(const s of t)e.push(a.createElement(m.a,{room:s,key:"room-"+s.roomId,showMessagePreview:this.layout.showPreviews,isMinimized:this.props.isMinimized,tag:this.props.tagId}))}return this.extraTiles&&e.push(...this.extraTiles),e.length>this.numVisibleTiles?e.slice(0,this.numVisibleTiles):e}renderMenu(){let e=null;if(this.state.contextMenuPosition){const t=g.b.instance.getTagSorting(this.props.tagId)===v.b.Alphabetic,s=g.b.instance.getListOrder(this.props.tagId)===v.a.Importance;let n=null;this.props.tagId!==f.a.Invite&&(n=a.createElement(a.Fragment,null,a.createElement("hr",null),a.createElement("div",null,a.createElement("div",{className:"mx_RoomSublist_contextMenu_title"},Object(u.a)("Appearance")),a.createElement(p.i,{onClose:this.onCloseMenu,onChange:this.onUnreadFirstChanged,checked:s},Object(u.a)("Show rooms with unread messages first")),a.createElement(p.i,{onClose:this.onCloseMenu,onChange:this.onMessagePreviewChanged,checked:this.layout.showPreviews},Object(u.a)("Show previews of messages"))))),e=a.createElement(p.b,{chevronFace:p.a.None,left:this.state.contextMenuPosition.left,top:this.state.contextMenuPosition.top+this.state.contextMenuPosition.height,onFinished:this.onCloseMenu},a.createElement("div",{className:"mx_RoomSublist_contextMenu"},a.createElement("div",null,a.createElement("div",{className:"mx_RoomSublist_contextMenu_title"},Object(u.a)("Sort by")),a.createElement(p.j,{onClose:this.onCloseMenu,onChange:()=>this.onTagSortChanged(v.b.Recent),checked:!t,name:`mx_${this.props.tagId}_sortBy`},Object(u.a)("Activity")),a.createElement(p.j,{onClose:this.onCloseMenu,onChange:()=>this.onTagSortChanged(v.b.Alphabetic),checked:t,name:`mx_${this.props.tagId}_sortBy`},Object(u.a)("A-Z"))),n))}else this.state.addRoomContextMenuPosition&&(e=a.createElement(I.e,{chevronFace:p.a.None,left:this.state.addRoomContextMenuPosition.left-7,top:this.state.addRoomContextMenuPosition.top+this.state.addRoomContextMenuPosition.height,onFinished:this.onCloseAddRoomMenu,compact:!0},this.props.addRoomContextMenu(this.onCloseAddRoomMenu)));return a.createElement(a.Fragment,null,a.createElement(p.d,{className:"mx_RoomSublist_menuButton",onClick:this.onOpenMenuClick,title:Object(u.a)("List options"),isExpanded:!!this.state.contextMenuPosition}),e)}renderHeader(){return a.createElement(d.d,{inputRef:this.headerButton},({onFocus:e,isActive:t,ref:s})=>{const n=t?0:-1;let i=Object(u.a)("Jump to first unread room.");this.props.tagId===f.a.Invite&&(i=Object(u.a)("Jump to first invite."));const o=a.createElement(y.a,{forceCount:!0,notification:this.notificationState,onClick:this.onBadgeClick,tabIndex:n,"aria-label":i});let r=null;this.props.onAddRoom?r=a.createElement(_.a,{tabIndex:n,onClick:this.onAddRoom,className:"mx_RoomSublist_auxButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip","aria-label":this.props.addRoomLabel||Object(u.a)("Add room"),title:this.props.addRoomLabel}):this.props.addRoomContextMenu&&(r=a.createElement(p.d,{tabIndex:n,onClick:this.onAddRoomContextMenu,className:"mx_RoomSublist_auxButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip","aria-label":this.props.addRoomLabel||Object(u.a)("Add room"),title:this.props.addRoomLabel,isExpanded:!!this.state.addRoomContextMenuPosition}));let c=null;this.props.onAddGroupRoom&&(c=a.createElement(_.a,{tabIndex:n,onClick:this.onAddGroupRoom,className:"mx_RoomSublist_auxGroupButton","aria-label":this.props.addGroupRoomLabel||Object(u.a)("Add room"),title:this.props.addGroupRoomLabel,tooltipClassName:"mx_RoomSublist_addRoomTooltip"}));let d=null;this.props.onAddDirectRoom&&(d=a.createElement(_.a,{tabIndex:n,onClick:this.onAddDirectRoom,className:"mx_RoomSublist_auxDmButton","aria-label":this.props.addDirectRoomLabel||Object(u.a)("Add room"),title:this.props.addDirectRoomLabel,tooltipClassName:"mx_RoomSublist_addRoomTooltip"}));const m=l()({mx_RoomSublist_collapseBtn:!0,mx_RoomSublist_collapseBtn_collapsed:!this.state.isExpanded}),g=l()({mx_RoomSublist_headerContainer:!0,mx_RoomSublist_headerContainer_withAux:!!r||!!c||!!d}),v=a.createElement("div",{className:"mx_RoomSublist_badgeContainer"},o);let b=h.a;return this.props.isMinimized&&(b=_.a),a.createElement("div",{className:g,onKeyDown:this.onHeaderKeyDown,onFocus:e,"aria-label":this.props.label},a.createElement("div",{className:"mx_RoomSublist_stickable"},a.createElement(b,{onFocus:e,inputRef:s,tabIndex:n,className:"mx_RoomSublist_headerText",role:"treeitem","aria-expanded":this.state.isExpanded,"aria-level":1,onClick:this.onHeaderClick,onContextMenu:this.onContextMenu,title:this.props.isMinimized?this.props.label:void 0},a.createElement("span",{className:m}),a.createElement("span",null,this.props.label)),this.renderMenu(),this.props.isMinimized?null:v,this.props.isMinimized?null:r,this.props.isMinimized?null:d,this.props.isMinimized?null:c),this.props.isMinimized?v:null,this.props.isMinimized?r:null,this.props.isMinimized?d:null,this.props.isMinimized?c:null)})}onScrollPrevent(e){e.target.scrollTop=0}render(){var e;const t=this.renderVisibleTiles(),s=l()({mx_RoomSublist:!0,mx_RoomSublist_hasMenuOpen:!!this.state.contextMenuPosition,mx_RoomSublist_minimized:this.props.isMinimized,mx_RoomSublist_hidden:!(this.state.rooms.length||null!==(e=this.props.extraTiles)&&void 0!==e&&e.length||!0===this.props.alwaysVisible)});let n=null;if(t.length>0){const e=this.layout,s=Math.min(e.minVisibleTiles,this.numTiles),i=4+(s<this.numTiles?28:0),o=e.tilesToPixelsWithPadding(s,i),r=e.tilesToPixelsWithPadding(this.numTiles,this.padding),c=l()({mx_RoomSublist_showNButton:!0});let h=null;if(r>this.state.height){const e=this.state.height-4-28,t=Math.floor(e/this.layout.tileHeight),s=this.numTiles-t,n=Object(u.a)("Show %(count)s more",{count:s});let i=a.createElement("span",{className:"mx_RoomSublist_showNButtonText"},n);this.props.isMinimized&&(i=null),h=a.createElement(d.a,{role:"treeitem",onClick:this.onShowAllClick,className:c,"aria-label":n},a.createElement("span",{className:"mx_RoomSublist_showMoreButtonChevron mx_RoomSublist_showNButtonChevron"}),i)}else if(this.numTiles>this.layout.defaultVisibleTiles){const e=Object(u.a)("Show less");let t=a.createElement("span",{className:"mx_RoomSublist_showNButtonText"},e);this.props.isMinimized&&(t=null),h=a.createElement(d.a,{role:"treeitem",onClick:this.onShowLessClick,className:c,"aria-label":e},a.createElement("span",{className:"mx_RoomSublist_showLessButtonChevron mx_RoomSublist_showNButtonChevron"}),t)}const m={bottom:!0,bottomLeft:!1,bottomRight:!1,left:!1,right:!1,top:!1,topLeft:!1,topRight:!1};e.visibleTiles>=this.numTiles&&this.numTiles<=e.minVisibleTiles&&(m.bottom=!1);const p=l()({mx_RoomSublist_resizerHandles:!0,mx_RoomSublist_resizerHandles_showNButton:!!h});n=a.createElement(a.Fragment,null,a.createElement(S.Resizable,{size:{height:this.state.height},minHeight:o,maxHeight:r,onResizeStart:this.onResizeStart,onResizeStop:this.onResizeStop,onResize:this.onResize,handleWrapperClass:p,handleClasses:{bottom:"mx_RoomSublist_resizerHandle"},className:"mx_RoomSublist_resizeBox",enable:m},a.createElement("div",{className:"mx_RoomSublist_tiles",ref:this.tilesRef},t),h))}else this.props.showSkeleton&&this.state.isExpanded&&(n=a.createElement("div",{className:"mx_RoomSublist_skeletonUI"}));return a.createElement("div",{ref:this.sublistRef,className:s,role:"group","aria-label":this.props.label,onKeyDown:this.onKeyDown},this.renderHeader(),n)}})||n}).call(this,s(169).setImmediate)},function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return r}));var n=s(18),i=s.n(n),o=s(685);let a;!function(e){e[e.Pending=0]="Pending",e[e.Success=1]="Success",e[e.Error=2]="Error"}(a||(a={}));class r extends o.a{constructor(e,t){super(),this.auditName=e,this.runFn=t,i()(this,"_status",a.Pending),i()(this,"didFail",!1),i()(this,"startTime",new Date)}get didPreviouslyFail(){return this.didFail}get status(){return this._status}run(){if(this.status===a.Success)throw new Error("Cannot re-run a successful echo transaction");this.setStatus(a.Pending),this.runFn().then(()=>this.setStatus(a.Success)).catch(()=>this.setStatus(a.Error))}cancel(){this.setStatus(a.Success)}setStatus(e){this._status=e,e===a.Error?this.didFail=!0:e===a.Success&&(this.didFail=!1),this.notifyCondition(e)}}},,,function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(97),a=s.n(o);const r=e=>{const t=["mx_ResizeHandle"];return e.vertical?t.push("mx_ResizeHandle_vertical"):t.push("mx_ResizeHandle_horizontal"),e.reverse&&t.push("mx_ResizeHandle_reverse"),i.a.createElement("div",{className:t.join(" "),"data-id":e.id},i.a.createElement("div",null))};r.propTypes={vertical:a.a.bool,reverse:a.a.bool,id:a.a.string},t.a=r},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(697),i=s(341);class o extends n.a{start(e){this.vertical?e.style.minHeight=null:e.style.minWidth=null}finish(e){const t=e.offsetParent;if(t)if(this.vertical){const s=(e.offsetHeight/t.offsetHeight*100).toFixed(2)+"%";e.style.minHeight=s,e.style.height=s}else{const s=(e.offsetWidth/t.offsetWidth*100).toFixed(2)+"%";e.style.minWidth=s,e.style.width=s}}}class a extends i.a{static createSizer(e,t,s){return new o(e,t,s)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(18),i=s.n(n),o=s(117);class a{constructor(e,t,s){if(this.container=e,this.distributorCtor=t,this.config=s,i()(this,"classNames",void 0),i()(this,"onMouseDown",e=>{const t=e.target&&e.target.closest("."+this.classNames.handle);if(!t||t.parentElement!==this.container)return;e.preventDefault(),this.classNames.resizing&&this.container.classList.add(this.classNames.resizing),this.config.onResizeStart&&this.config.onResizeStart();const{sizer:s,distributor:n}=this.createSizerAndDistributor(t);n.start();const i=e=>{const t=s.offsetFromEvent(e);n.resizeFromContainerOffset(t)},o=document.body,a=()=>{this.classNames.resizing&&this.container.classList.remove(this.classNames.resizing),n.finish(),this.config.onResizeStop&&this.config.onResizeStop(),o.removeEventListener("mouseup",a,!1),document.removeEventListener("mouseleave",a,!1),o.removeEventListener("mousemove",i,!1)};o.addEventListener("mouseup",a,!1),document.addEventListener("mouseleave",a,!1),o.addEventListener("mousemove",i,!1)}),i()(this,"onResize",Object(o.throttle)(()=>{const e=this.getDistributors();e.forEach(e=>e.start()),e.forEach(e=>e.finish())},100,{trailing:!0,leading:!0})),i()(this,"getDistributors",()=>this.getResizeHandles().map(e=>{const{distributor:t}=this.createSizerAndDistributor(e);return t})),!e)throw new Error("Resizer requires a non-null `container` arg");this.classNames={handle:"resizer-handle",reverse:"resizer-reverse",vertical:"resizer-vertical",resizing:"resizer-resizing"}}setClassNames(e){this.classNames=e}attach(){this.container.addEventListener("mousedown",this.onMouseDown,!1),window.addEventListener("resize",this.onResize)}detach(){this.container.removeEventListener("mousedown",this.onMouseDown,!1),window.removeEventListener("resize",this.onResize)}forHandleAt(e){const t=this.getResizeHandles()[e];if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}forHandleWithId(e){const t=this.getResizeHandles().find(t=>t.getAttribute("data-id")===e);if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}isReverseResizeHandle(e){return e&&e.classList.contains(this.classNames.reverse)}isResizeHandle(e){return e&&e.classList.contains(this.classNames.handle)}createSizerAndDistributor(e){const t=e.classList.contains(this.classNames.vertical),s=this.isReverseResizeHandle(e),n=this.distributorCtor,i=n.createSizer(this.container,t,s),o=n.createItem(e,this,i);return{sizer:i,distributor:new n(o)}}getResizeHandles(){return this.container.children?Array.from(this.container.children).filter(e=>this.isResizeHandle(e)):[]}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return I}));var n,i=s(104),o=s.n(i),a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(96),u=s(153),h=s(94),m=s(92),p=s(698),g=s(129),v=s(158),f=s(101),b=s.n(f),y=s(100),_=s(111),E=s(109),S=s(699),w=s(194),C=s(700),k=s(93);function O(){return document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function R(){const e=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;e&&e.call(document)}let I=Object(k.a)("views.voip.CallView")(n=class extends l.a.Component{constructor(e){super(e),r()(this,"dispatcherRef",void 0),r()(this,"contentRef",Object(c.createRef)()),r()(this,"controlsHideTimer",null),r()(this,"dialpadButton",Object(c.createRef)()),r()(this,"contextMenuButton",Object(c.createRef)()),r()(this,"onAction",e=>{switch(e.action){case"video_fullscreen":if(!this.contentRef.current)return;e.fullscreen?function(e){const t=e.requestFullscreen||e.webkitRequestFullScreen||e.msRequestFullscreen;t&&t.call(e)}(this.contentRef.current):O()&&R()}}),r()(this,"onCallState",e=>{this.setState({callState:e})}),r()(this,"onFeedsChanged",e=>{this.setState({feeds:e})}),r()(this,"onCallLocalHoldUnhold",()=>{this.setState({isLocalOnHold:this.props.call.isLocalOnHold()})}),r()(this,"onCallRemoteHoldUnhold",()=>{this.setState({isRemoteOnHold:this.props.call.isRemoteOnHold(),isLocalOnHold:this.props.call.isLocalOnHold()})}),r()(this,"onFullscreenClick",()=>{d.a.dispatch({action:"video_fullscreen",fullscreen:!0})}),r()(this,"onExpandClick",()=>{const e=u.e.sharedInstance().roomIdForCall(this.props.call);d.a.dispatch({action:"view_room",room_id:e})}),r()(this,"onControlsHideTimer",()=>{this.controlsHideTimer=null,this.setState({controlsVisible:!1})}),r()(this,"onMouseMove",()=>{this.showControls()}),r()(this,"onDialpadClick",()=>{this.state.showDialpad?(null!==this.controlsHideTimer&&clearTimeout(this.controlsHideTimer),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,1e3),this.setState({showDialpad:!1})):(this.controlsHideTimer&&(clearTimeout(this.controlsHideTimer),this.controlsHideTimer=null),this.setState({showDialpad:!0,controlsVisible:!0}))}),r()(this,"onMicMuteClick",()=>{const e=!this.state.micMuted;this.props.call.setMicrophoneMuted(e),this.setState({micMuted:e})}),r()(this,"onVidMuteClick",()=>{const e=!this.state.vidMuted;this.props.call.setLocalVideoMuted(e),this.setState({vidMuted:e})}),r()(this,"onMoreClick",()=>{this.controlsHideTimer&&(clearTimeout(this.controlsHideTimer),this.controlsHideTimer=null),this.setState({showMoreMenu:!0,controlsVisible:!0})}),r()(this,"closeDialpad",()=>{this.setState({showDialpad:!1}),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,1e3)}),r()(this,"closeContextMenu",()=>{this.setState({showMoreMenu:!1}),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,1e3)}),r()(this,"onNativeKeyDown",e=>{let t=!1;const s=Object(_.d)(e);switch(e.key){case _.a.D:s&&(this.onMicMuteClick(),this.showControls(),t=!0);break;case _.a.E:s&&(this.onVidMuteClick(),this.showControls(),t=!0)}t&&(e.stopPropagation(),e.preventDefault())}),r()(this,"onRoomAvatarClick",()=>{const e=u.e.sharedInstance().roomIdForCall(this.props.call);d.a.dispatch({action:"view_room",room_id:e})}),r()(this,"onSecondaryRoomAvatarClick",()=>{const e=u.e.sharedInstance().roomIdForCall(this.props.secondaryCall);d.a.dispatch({action:"view_room",room_id:e})}),r()(this,"onCallResumeClick",()=>{const e=u.e.sharedInstance().roomIdForCall(this.props.call);u.e.sharedInstance().setActiveCallRoomId(e)}),r()(this,"onTransferClick",()=>{const e=u.e.sharedInstance().getTransfereeForCallId(this.props.call.callId);this.props.call.transferToCall(e)}),this.state={isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),callState:this.props.call.state,controlsVisible:!0,showMoreMenu:!1,showDialpad:!1,feeds:this.props.call.getFeeds()},this.updateCallListeners(null,this.props.call)}componentDidMount(){this.dispatcherRef=d.a.register(this.onAction),document.addEventListener("keydown",this.onNativeKeyDown)}componentWillUnmount(){O()&&R(),document.removeEventListener("keydown",this.onNativeKeyDown),this.updateCallListeners(this.props.call,null),d.a.unregister(this.dispatcherRef)}componentDidUpdate(e){this.props.call!==e.call&&(this.setState({isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),callState:this.props.call.state}),this.updateCallListeners(null,this.props.call))}updateCallListeners(e,t){e!==t&&(e&&(e.removeListener(v.c.State,this.onCallState),e.removeListener(v.c.LocalHoldUnhold,this.onCallLocalHoldUnhold),e.removeListener(v.c.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),e.removeListener(v.c.FeedsChanged,this.onFeedsChanged)),t&&(t.on(v.c.State,this.onCallState),t.on(v.c.LocalHoldUnhold,this.onCallLocalHoldUnhold),t.on(v.c.RemoteHoldUnhold,this.onCallRemoteHoldUnhold),t.on(v.c.FeedsChanged,this.onFeedsChanged)))}showControls(){this.state.showMoreMenu||this.state.showDialpad||(this.state.controlsVisible||this.setState({controlsVisible:!0}),null!==this.controlsHideTimer&&clearTimeout(this.controlsHideTimer),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,1e3))}render(){const e=h.a.get(),t=u.e.sharedInstance().roomIdForCall(this.props.call),s=u.e.sharedInstance().roomIdForCall(this.props.secondaryCall),n=e.getRoom(t),i=this.props.secondaryCall?e.getRoom(s):null;let a,r;this.state.showDialpad&&(a=l.a.createElement(C.a,o()({},Object(E.m)(this.dialpadButton.current.getBoundingClientRect(),E.a.None,8),{onFinished:this.closeDialpad,call:this.props.call}))),this.state.showMoreMenu&&(r=l.a.createElement(S.a,o()({},Object(E.l)(this.contextMenuButton.current.getBoundingClientRect(),E.a.None,8),{onFinished:this.closeContextMenu,call:this.props.call})));const c=b()({mx_CallView_callControls_button:!0,mx_CallView_callControls_button_micOn:!this.state.micMuted,mx_CallView_callControls_button_micOff:this.state.micMuted}),f=b()({mx_CallView_callControls_button:!0,mx_CallView_callControls_button_vidOn:!this.state.vidMuted,mx_CallView_callControls_button_vidOff:this.state.vidMuted}),_=b()({mx_CallView_callControls_button:!0,mx_CallView_callControls_button_micOn:this.state.micMuted,mx_CallView_callControls_button_micOff:!this.state.micMuted,mx_CallView_callControls_button_invisible:!0}),k=b()({mx_CallView_callControls_button:!0,mx_CallView_callControls_button_vidOn:this.state.micMuted,mx_CallView_callControls_button_vidOff:!this.state.micMuted,mx_CallView_callControls_button_invisible:!0}),O=b()({mx_CallView_callControls:!0,mx_CallView_callControls_hidden:!this.state.controlsVisible}),R=this.props.call.type===v.f.Video?l.a.createElement(y.a,{className:f,onClick:this.onVidMuteClick}):null,I=this.state.callState===v.e.Connected?l.a.createElement(E.c,{className:"mx_CallView_callControls_button mx_CallView_callControls_dialpad",inputRef:this.dialpadButton,onClick:this.onDialpadClick,isExpanded:this.state.showDialpad}):l.a.createElement("div",{className:"mx_CallView_callControls_button mx_CallView_callControls_button_dialpad_hidden"}),x=this.state.callState===v.e.Connected?l.a.createElement(E.c,{className:"mx_CallView_callControls_button mx_CallView_callControls_button_more",onClick:this.onMoreClick,inputRef:this.contextMenuButton,isExpanded:this.state.showMoreMenu}):l.a.createElement("div",{className:"mx_CallView_callControls_button mx_CallView_callControls_button_more_hidden"}),T=l.a.createElement("div",{className:O},I,l.a.createElement(y.a,{className:c,onClick:this.onMicMuteClick}),l.a.createElement(y.a,{className:"mx_CallView_callControls_button mx_CallView_callControls_button_hangup",onClick:()=>{d.a.dispatch({action:"hangup",room_id:t})}}),R,l.a.createElement("div",{className:_}),l.a.createElement("div",{className:k}),x),j=this.props.pipMode?76:160;let N;const P=u.e.sharedInstance().getTransfereeForCallId(this.props.call.callId),D=this.state.isLocalOnHold||this.state.isRemoteOnHold;let A;if(P){const e=h.a.get().getRoom(u.e.sharedInstance().roomIdForCall(this.props.call)),t=e?e.name:Object(m.a)("unknown person"),s=h.a.get().getRoom(u.e.sharedInstance().roomIdForCall(P)),n=s?s.name:Object(m.a)("unknown person");A=l.a.createElement("div",{className:"mx_CallView_holdTransferContent"},Object(m.a)("Consulting with %(transferTarget)s. <a>Transfer to %(transferee)s</a>",{transferTarget:t,transferee:n},{a:e=>l.a.createElement(y.a,{kind:"link",onClick:this.onTransferClick},e)}))}else if(D){let e=null;if(this.state.isRemoteOnHold){const t=u.e.sharedInstance().hasAnyUnheldCall()?Object(m.b)("You held the call <a>Switch</a>"):Object(m.b)("You held the call <a>Resume</a>");e=Object(m.a)(t,{},{a:e=>l.a.createElement(y.a,{kind:"link",onClick:this.onCallResumeClick},e)})}else this.state.isLocalOnHold&&(e=Object(m.a)("%(peerName)s held the call",{peerName:this.props.call.getOpponentMember().name}));A=l.a.createElement("div",{className:"mx_CallView_holdTransferContent"},e)}if(D||P)if(this.props.call.type===v.f.Video){const e=b()({mx_CallView_content:!0,mx_CallView_video:!0,mx_CallView_video_hold:D});let t=null;const s={},n=Object(w.a)(this.props.call.getOpponentMember(),1024,1024,"crop");s.backgroundImage="url("+n+")",t=l.a.createElement("div",{className:"mx_CallView_video_holdBackground",style:s}),N=l.a.createElement("div",{className:e,ref:this.contentRef,onMouseMove:this.onMouseMove},t,A,T)}else{const e=b()({mx_CallView_content:!0,mx_CallView_voice:!0,mx_CallView_voice_hold:D});N=l.a.createElement("div",{className:e,onMouseMove:this.onMouseMove},l.a.createElement("div",{className:"mx_CallView_voice_avatarsContainer"},l.a.createElement("div",{className:"mx_CallView_voice_avatarContainer",style:{width:j,height:j}},l.a.createElement(g.a,{room:n,height:j,width:j}))),A,T)}else if(this.props.call.noIncomingFeeds()){const e=b()({mx_CallView_content:!0,mx_CallView_voice:!0}),t=this.props.call.getLocalFeeds().map((e,t)=>{if(!e.isVideoMuted())return l.a.createElement(p.a,{key:t,feed:e,call:this.props.call,pipMode:this.props.pipMode,onResize:this.props.onResize})});N=l.a.createElement("div",{className:e,onMouseMove:this.onMouseMove},t,l.a.createElement("div",{className:"mx_CallView_voice_avatarsContainer"},l.a.createElement("div",{className:"mx_CallView_voice_avatarContainer",style:{width:j,height:j}},l.a.createElement(g.a,{room:n,height:j,width:j}))),l.a.createElement("div",{className:"mx_CallView_holdTransferContent"},Object(m.a)("Connecting")),T)}else{const e=b()({mx_CallView_content:!0,mx_CallView_video:!0}),t=this.state.feeds.map((e,t)=>{if(!e.isVideoMuted()||!e.isLocal())return l.a.createElement(p.a,{key:t,feed:e,call:this.props.call,pipMode:this.props.pipMode,onResize:this.props.onResize})});N=l.a.createElement("div",{className:e,ref:this.contentRef,onMouseMove:this.onMouseMove},t,T)}const M=this.props.call.type===v.f.Video?Object(m.a)("Video Call"):Object(m.a)("Voice Call");let U,L,F;this.props.call.type!==v.f.Video||this.props.pipMode||(L=l.a.createElement("div",{className:"mx_CallView_header_button mx_CallView_header_button_fullscreen",onClick:this.onFullscreenClick,title:Object(m.a)("Fill Screen")})),this.props.pipMode&&(F=l.a.createElement("div",{className:"mx_CallView_header_button mx_CallView_header_button_expand",onClick:this.onExpandClick,title:Object(m.a)("Return to call")}));const B=l.a.createElement("div",{className:"mx_CallView_header_controls"},L,F);let V;if(this.props.pipMode){let e;this.props.secondaryCall&&(e=l.a.createElement("span",{className:"mx_CallView_header_secondaryCallInfo"},l.a.createElement(y.a,{element:"span",onClick:this.onSecondaryRoomAvatarClick},l.a.createElement(g.a,{room:i,height:16,width:16}),l.a.createElement("span",{className:"mx_CallView_secondaryCall_roomName"},Object(m.a)("%(name)s on hold",{name:i.name}))))),V=l.a.createElement("div",{className:"mx_CallView_header"},l.a.createElement(y.a,{onClick:this.onRoomAvatarClick},l.a.createElement(g.a,{room:n,height:32,width:32})),l.a.createElement("div",{className:"mx_CallView_header_callInfo"},l.a.createElement("div",{className:"mx_CallView_header_roomName"},n.name),l.a.createElement("div",{className:"mx_CallView_header_callTypeSmall"},M,e)),B),U="mx_CallView_pip"}else V=l.a.createElement("div",{className:"mx_CallView_header"},l.a.createElement("div",{className:"mx_CallView_header_phoneIcon"}),l.a.createElement("span",{className:"mx_CallView_header_callType"},M),B),U="mx_CallView_large";return l.a.createElement("div",{className:"mx_CallView "+U},V,N,a,r)}})||n},,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(254),m=s(125),p=s(93),g=s(184);let v;v=function(){};let f=Object(p.a)("structures.ScrollPanel")((o=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onScroll",e=>{this.props.resizeNotifier&&this.props.resizeNotifier.isResizing||(v("onScroll",this._getScrollNode().scrollTop),this._scrollTimeout.restart(),this._saveScrollState(),this.updatePreventShrinking(),this.props.onScroll(e),this.checkFillState())}),r()(this,"onResize",()=>{v("onResize"),this.checkScroll(),this.preventShrinkingState&&this.preventShrinking()}),r()(this,"checkScroll",()=>{this.unmounted||(this._restoreSavedScrollState(),this.checkFillState())}),r()(this,"isAtBottom",()=>{const e=this._getScrollNode();return Math.abs(e.scrollHeight-(e.scrollTop+e.clientHeight))<=1}),r()(this,"checkFillState",async(e=0)=>{if(this.unmounted)return;const t=0===e,s=this._getScrollNode();if(t){if(this._isFilling)return v("_isFilling: not entering while request is ongoing, marking for a subsequent request"),void(this._fillRequestWhileRunning=!0);v("_isFilling: setting"),this._isFilling=!0}const n=this._itemlist.current,i=n&&n.firstElementChild,o=i&&i.offsetTop,a=[];if((!i||s.scrollTop-o<s.clientHeight)&&a.push(this._maybeFill(e,!0)),s.scrollHeight-s.scrollTop<2*s.clientHeight&&a.push(this._maybeFill(e,!1)),a.length)try{await Promise.all(a)}catch(e){console.error(e)}t&&(v("_isFilling: clearing"),this._isFilling=!1),this._fillRequestWhileRunning&&(this._fillRequestWhileRunning=!1,this.checkFillState())}),r()(this,"getScrollState",()=>this.scrollState),r()(this,"resetScrollState",()=>{this.scrollState={stuckAtBottom:this.props.startAtBottom},this._bottomGrowth=0,this._pages=0,this._scrollTimeout=new h.a(100),this._heightUpdateInProgress=!1}),r()(this,"scrollToTop",()=>{this._getScrollNode().scrollTop=0,this._saveScrollState()}),r()(this,"scrollToBottom",()=>{const e=this._getScrollNode();e.scrollTop=e.scrollHeight,this._saveScrollState()}),r()(this,"scrollRelative",e=>{const t=this._getScrollNode(),s=e*t.clientHeight*.9;t.scrollBy(0,s),this._saveScrollState()}),r()(this,"handleScrollKey",e=>{let t=!1;switch(Object(g.f)().getRoomAction(e)){case g.d.ScrollUp:this.scrollRelative(-1),t=!0;break;case g.d.RoomScrollDown:this.scrollRelative(1),t=!0;break;case g.d.JumpToFirstMessage:this.scrollToTop(),t=!0;break;case g.d.JumpToLatestMessage:this.scrollToBottom(),t=!0}t&&this.props.onUserScroll&&this.props.onUserScroll(e)}),r()(this,"scrollToToken",(e,t,s)=>{t=t||0,s=s||0,this.scrollState={stuckAtBottom:!1,trackedScrollToken:e};const n=this._getTrackedNode(),i=this._getScrollNode();n&&(v("scrollToken: setting scrollTop",{offsetBase:s,pixelOffset:t,offsetTop:n.offsetTop}),i.scrollTop=n.offsetTop-i.clientHeight*s+t,this._saveScrollState())}),r()(this,"_collectScroll",e=>{this._divScroll=e}),r()(this,"preventShrinking",()=>{const e=this._itemlist.current,t=e&&e.children;if(!e)return;let s;for(let e=t.length-1;e>=0;e--){const n=t[e];if(n.dataset.scrollTokens){s=n;break}}if(!s)return;this.clearPreventShrinking();const n=e.clientHeight-(s.offsetTop+s.clientHeight);this.preventShrinkingState={offsetFromBottom:n,offsetNode:s},v("prevent shrinking, last tile ",n,"px from bottom")}),r()(this,"clearPreventShrinking",()=>{const e=this._itemlist.current,t=e&&e.parentElement;t&&(t.style.paddingBottom=null),this.preventShrinkingState=null,v("prevent shrinking cleared")}),r()(this,"updatePreventShrinking",()=>{if(this.preventShrinkingState){const e=this._getScrollNode(),t=this.scrollState,s=this._itemlist.current,{offsetNode:n,offsetFromBottom:i}=this.preventShrinkingState,o=s.parentElement;let a=!n.parentElement;if(!a&&!t.stuckAtBottom){a=e.scrollHeight-(e.scrollTop+e.clientHeight)>=200}if(!a){const e=i-(s.clientHeight-(n.offsetTop+n.clientHeight));e>0?(o.style.paddingBottom=e+"px",v("update prevent shrinking ",e,"px from bottom")):e<0&&(a=!0)}a&&this.clearPreventShrinking()}}),this._pendingFillRequests={b:null,f:null},this.props.resizeNotifier&&this.props.resizeNotifier.on("middlePanelResizedNoisy",this.onResize),this.resetScrollState(),this._itemlist=Object(c.createRef)()}componentDidMount(){this.checkScroll()}componentDidUpdate(){this.checkScroll(),this.updatePreventShrinking()}componentWillUnmount(){this.unmounted=!0,this.props.resizeNotifier&&this.props.resizeNotifier.removeListener("middlePanelResizedNoisy",this.onResize)}_getExcessHeight(e){const t=this._getScrollNode(),s=this._getMessagesHeight(),n=s-this._getListHeight(),i=t.scrollTop+n;return e?i-t.clientHeight-6e3:s-(i+2*t.clientHeight)-6e3}_checkUnfillState(e){let t=this._getExcessHeight(e);if(t<=0)return;const s=t,n=this._itemlist.current.children;let i,o=null;for(let s=0;s<n.length&&(i=n[e?s:n.length-1-s],t-=i.clientHeight,!(i.clientHeight>t));s++)i.dataset.scrollTokens&&(o=i.dataset.scrollTokens.split(",")[0]);o&&(this._unfillDebouncer&&clearTimeout(this._unfillDebouncer),this._unfillDebouncer=setTimeout(()=>{this._unfillDebouncer=null,v("unfilling now",e,s),this.props.onUnfillRequest(e,o)},200))}_maybeFill(e,t){const s=t?"b":"f";if(!this._pendingFillRequests[s])return v("starting "+s+" fill"),this._pendingFillRequests[s]=!0,new Promise(e=>setTimeout(e,1)).then(()=>this.props.onFillRequest(t)).finally(()=>{this._pendingFillRequests[s]=!1}).then(n=>{if(!this.unmounted)return this._checkUnfillState(!t),v(s+" fill complete; hasMoreResults:"+n),n?this.checkFillState(e+1):void 0});v("Already a "+s+" fill in progress - not starting another")}_saveScrollState(){if(this.props.stickyBottom&&this.isAtBottom())return this.scrollState={stuckAtBottom:!0},void v("saved stuckAtBottom state");const e=this._getScrollNode(),t=e.scrollHeight-(e.scrollTop+e.clientHeight),s=this._itemlist.current.children;let n=null;for(let e=s.length-1;e>=0&&!(s[e].dataset.scrollTokens&&(n=s[e],this._topFromBottom(n)>t));--e);if(!n)return void v("unable to save scroll state: found no children in the viewport");const i=n.dataset.scrollTokens.split(",")[0];v("saving anchored scroll state to message",n&&n.innerText,i);const o=this._topFromBottom(n);this.scrollState={stuckAtBottom:!1,trackedNode:n,trackedScrollToken:i,bottomOffset:o,pixelOffset:o-t}}async _restoreSavedScrollState(){const e=this.scrollState;if(e.stuckAtBottom){const e=this._getScrollNode();e.scrollTop!==e.scrollHeight&&(e.scrollTop=e.scrollHeight)}else if(e.trackedScrollToken){const t=this._itemlist.current,s=this._getTrackedNode();if(s){const n=this._topFromBottom(s),i=n-e.bottomOffset;this._bottomGrowth+=i,e.bottomOffset=n;const o=this._getListHeight()+"px";t.style.height!==o&&(t.style.height=o),v("balancing height because messages below viewport grew by",i)}}if(this._heightUpdateInProgress)v("not updating height because request already in progress");else{this._heightUpdateInProgress=!0;try{await this._updateHeight()}finally{this._heightUpdateInProgress=!1}}}async _updateHeight(){if(this._scrollTimeout.isRunning()?(v("updateHeight waiting for scrolling to end ... "),await this._scrollTimeout.finished()):v("updateHeight getting straight to business, no scrolling going on."),this.unmounted)return;const e=this._getScrollNode(),t=this._itemlist.current,s=this._getMessagesHeight(),n=e.clientHeight,i=Math.max(n,s);this._pages=Math.ceil(i/400),this._bottomGrowth=0;const o=this._getListHeight()+"px",a=this.scrollState;if(a.stuckAtBottom)t.style.height!==o&&(t.style.height=o),e.scrollTop!==e.scrollHeight&&(e.scrollTop=e.scrollHeight),v("updateHeight to",o);else if(a.trackedScrollToken){const s=this._getTrackedNode();if(s){const n=s.offsetTop;t.style.height!==o&&(t.style.height=o);const i=s.offsetTop-n;e.scrollBy(0,i),v("updateHeight to",{newHeight:o,topDiff:i})}}}_getTrackedNode(){const e=this.scrollState,t=e.trackedNode;if(!t||!t.parentElement){let t;const s=this._itemlist.current.children,n=e.trackedScrollToken;for(let e=s.length-1;e>=0;--e){const i=s[e];if(i.dataset.scrollTokens&&-1!==i.dataset.scrollTokens.split(",").indexOf(n)){t=i;break}}t&&v("had to find tracked node again for "+e.trackedScrollToken),e.trackedNode=t}if(e.trackedNode)return e.trackedNode;v("No node with ; '"+e.trackedScrollToken+"'")}_getListHeight(){return this._bottomGrowth+400*this._pages}_getMessagesHeight(){const e=this._itemlist.current,t=e.lastElementChild;return(t?t.offsetTop+t.clientHeight:0)-(e.firstElementChild?e.firstElementChild.offsetTop:0)+36}_topFromBottom(e){return this._itemlist.current.clientHeight-e.offsetTop}_getScrollNode(){if(this.unmounted)throw new Error("ScrollPanel._getScrollNode called when unmounted");if(!this._divScroll)throw new Error("ScrollPanel._getScrollNode called before AutoHideScrollbar ref collected");return this._divScroll}render(){return l.a.createElement(m.a,{wrappedRef:this._collectScroll,onScroll:this.onScroll,onWheel:this.props.onUserScroll,className:"mx_ScrollPanel "+this.props.className,style:this.props.style},this.props.fixedChildren,l.a.createElement("div",{className:"mx_RoomView_messageListWrapper"},l.a.createElement("ol",{ref:this._itemlist,className:"mx_RoomView_MessageList","aria-live":"polite",role:"list"},this.props.children)))}},r()(i,"propTypes",{stickyBottom:u.a.bool,startAtBottom:u.a.bool,onFillRequest:u.a.func,onUnfillRequest:u.a.func,onScroll:u.a.func,onUserScroll:u.a.func,className:u.a.string,style:u.a.object,resizeNotifier:u.a.object,fixedChildren:u.a.node}),r()(i,"defaultProps",{stickyBottom:!0,startAtBottom:!0,onFillRequest:function(e){return Promise.resolve(!1)},onUnfillRequest:function(e,t){},onScroll:function(){}}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i=s(104),o=s.n(i),a=s(108),r=s.n(a),c=s(18),l=s.n(c),d=s(91),u=s.n(d),h=s(101),m=s.n(h),p=s(132),g=s(113),v=s(93);let f=Object(v.a)("views.right_panel.HeaderButton")(n=class extends u.a.Component{constructor(...e){super(...e),l()(this,"onClick",()=>{p.a.trackEvent(...this.props.analytics),this.props.onClick()})}render(){const e=this.props,{isHighlighted:t,onClick:s,analytics:n,name:i,title:a}=e,c=r()(e,["isHighlighted","onClick","analytics","name","title"]),l=m()({mx_RightPanel_headerButton:!0,mx_RightPanel_headerButton_highlight:t,["mx_RightPanel_"+i]:!0});return u.a.createElement(g.a,o()({},c,{"aria-selected":t,role:"tab",title:a,className:l,onClick:this.onClick}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h})),s.d(t,"b",(function(){return m}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(96),l=s(249),d=s(103),u=s(93);let h;!function(e){e.Room="room",e.Group="group"}(h||(h={}));let m=Object(u.a)("views.right_panel.HeaderButtons")(n=class extends r.a.Component{constructor(e,t){super(e),o()(this,"storeToken",void 0),o()(this,"dispatcherRef",void 0);const s=l.a.getSharedInstance();this.state={headerKind:t,phase:t===h.Room?s.visibleRoomPanelPhase:s.visibleGroupPanelPhase}}componentDidMount(){this.storeToken=l.a.getSharedInstance().addListener(this.onRightPanelUpdate.bind(this)),this.dispatcherRef=c.a.register(this.onAction.bind(this))}componentWillUnmount(){this.storeToken&&this.storeToken.remove(),this.dispatcherRef&&c.a.unregister(this.dispatcherRef)}setPhase(e,t){c.a.dispatch({action:d.a.SetRightPanelPhase,phase:e,refireParams:t})}isPhase(e){return Array.isArray(e)?e.includes(this.state.phase):e===this.state.phase}onRightPanelUpdate(){const e=l.a.getSharedInstance();this.state.headerKind===h.Room?this.setState({phase:e.visibleRoomPanelPhase}):this.state.headerKind===h.Group&&this.setState({phase:e.visibleGroupPanelPhase})}render(){return r.a.createElement("div",{className:"mx_HeaderButtons"},this.renderButtons())}})||n},function(e,t,s){"use strict";var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(95),u=s(96),h=s(101),m=s.n(h),p=s(230),g=s(168),v=s(97),f=s.n(v),b=s(94),y=s(170),_=s(122),E=s(105),S=s(103),w=s(107),C=s(185),k=s(93);let O=Object(k.a)("views.elements.Pill")((o=i=class e extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{resourceId:null,pillType:null,member:null,group:null,room:null,hover:!1}),r()(this,"onMouseOver",()=>{this.setState({hover:!0})}),r()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),r()(this,"onUserPillClicked",()=>{u.a.dispatch({action:S.a.ViewUser,member:this.state.member})})}static roomNotifPos(e){return e.indexOf("@room")}static roomNotifLen(){return"@room".length}async UNSAFE_componentWillReceiveProps(t){let s,n;if(t.url)if(t.inMessage){const e=Object(_.i)(t.url);s=e.primaryEntityId,n=e.sigil}else s=Object(_.c)(t.url),n=s?s[0]:void 0;const i=this.props.type||{"@":e.TYPE_USER_MENTION,"#":e.TYPE_ROOM_MENTION,"!":e.TYPE_ROOM_MENTION,"+":e.TYPE_GROUP_MENTION}[n];let o,a,r;switch(i){case e.TYPE_AT_ROOM_MENTION:r=t.room;break;case e.TYPE_USER_MENTION:{const e=t.room?t.room.getMember(s):void 0;o=e,e||(o=new g.a(null,s),this.doProfileLookup(s,o))}break;case e.TYPE_ROOM_MENTION:{const e="#"===s[0]?b.a.get().getRooms().find(e=>e.getCanonicalAlias()===s||e.getAltAliases().includes(s)):b.a.get().getRoom(s);r=e}break;case e.TYPE_GROUP_MENTION:{const e=b.a.get();try{a=await y.a.getGroupProfileCached(e,s)}catch(e){a={groupId:s,avatarUrl:null,name:null}}}}this.setState({resourceId:s,pillType:i,member:o,group:a,room:r})}componentDidMount(){this._unmounted=!1,this._matrixClient=b.a.get(),this.UNSAFE_componentWillReceiveProps(this.props)}componentWillUnmount(){this._unmounted=!0}doProfileLookup(e,t){b.a.get().getProfileInfo(e).then(e=>{this._unmounted||(t.name=e.displayname,t.rawDisplayName=e.displayname,t.events.member={getContent:()=>({avatar_url:e.avatar_url}),getDirectionalContent:function(){return this.getContent()}},this.setState({member:t}))}).catch(t=>{console.error("Could not retrieve profile data for "+e+":",t)})}render(){const t=d.getComponent("views.avatars.BaseAvatar"),s=d.getComponent("avatars.MemberAvatar"),n=d.getComponent("avatars.RoomAvatar"),i=this.state.resourceId;let o,a,r,c=null,u=i,h=this.props.url;switch(this.state.pillType){case e.TYPE_AT_ROOM_MENTION:{const e=this.props.room;e&&(u="@room",this.props.shouldShowPillAvatar&&(c=l.a.createElement(n,{room:e,width:16,height:16,"aria-hidden":"true"})),o="mx_AtRoomPill")}break;case e.TYPE_USER_MENTION:{const e=this.state.member;e&&(a=e.userId,e.rawDisplayName=e.rawDisplayName||"",u=e.rawDisplayName,this.props.shouldShowPillAvatar&&(c=l.a.createElement(s,{member:e,width:16,height:16,"aria-hidden":"true"})),o="mx_UserPill",h=null,r=this.onUserPillClicked)}break;case e.TYPE_ROOM_MENTION:{const e=this.state.room;e&&(u=e.name||i,this.props.shouldShowPillAvatar&&(c=l.a.createElement(n,{room:e,width:16,height:16,"aria-hidden":"true"}))),o="mx_RoomPill"}break;case e.TYPE_GROUP_MENTION:if(this.state.group){const{avatarUrl:e,groupId:s,name:n}=this.state.group;u=s,this.props.shouldShowPillAvatar&&(c=l.a.createElement(t,{name:n||s,width:16,height:16,"aria-hidden":"true",url:e?Object(w.b)(e).getSquareThumbnailHttp(16):null})),o="mx_GroupPill"}}const p=m()("mx_Pill",o,{mx_UserPill_me:a===b.a.get().getUserId(),mx_UserPill_selected:this.props.isSelected});if(this.state.pillType){const{yOffset:e}=this.props;let t;return this.state.hover&&i&&(t=l.a.createElement(C.b,{label:i,yOffset:e})),l.a.createElement(E.a.Provider,{value:this._matrixClient},this.props.inMessage?l.a.createElement("a",{className:p,href:h,onClick:r,"data-offset-key":this.props.offsetKey,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},c,u,t):l.a.createElement("span",{className:p,"data-offset-key":this.props.offsetKey,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},c,u,t))}return null}},r()(i,"TYPE_USER_MENTION","TYPE_USER_MENTION"),r()(i,"TYPE_ROOM_MENTION","TYPE_ROOM_MENTION"),r()(i,"TYPE_GROUP_MENTION","TYPE_GROUP_MENTION"),r()(i,"TYPE_AT_ROOM_MENTION","TYPE_AT_ROOM_MENTION"),r()(i,"propTypes",{type:f.a.string,url:f.a.string,inMessage:f.a.bool,room:f.a.instanceOf(p.b),shouldShowPillAvatar:f.a.bool,isSelected:f.a.bool}),n=o))||n;t.a=O},,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return O}));var n,i=s(104),o=s.n(i),a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(92),u=s(113),h=s(111),m=s(402),p=s.n(m),g=s(171),v=s(262),f=s(406),b=s(109),y=s(592),_=s(98),E=s(150),S=s(96),w=s(93);function C(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function k(e){let t,s,n;return 1===e.deltaMode?(t=18*e.deltaX,s=18*e.deltaY,n=18*e.deltaZ):(t=e.deltaX,s=e.deltaY,n=e.deltaZ),new WheelEvent("syntheticWheel",function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?C(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):C(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({deltaMode:0,deltaY:s,deltaX:t,deltaZ:n},e))}let O=Object(w.a)("views.elements.ImageView")(n=class extends l.a.Component{constructor(e){super(e),r()(this,"contextMenuButton",Object(c.createRef)()),r()(this,"focusLock",Object(c.createRef)()),r()(this,"imageWrapper",Object(c.createRef)()),r()(this,"image",Object(c.createRef)()),r()(this,"initX",0),r()(this,"initY",0),r()(this,"previousX",0),r()(this,"previousY",0),r()(this,"recalculateZoom",()=>{this.setZoomAndRotation()}),r()(this,"setZoomAndRotation",e=>{const t=this.image.current,s=this.imageWrapper.current,n=e||this.state.rotation,i=n%180==0,o=i?t.naturalWidth:t.naturalHeight,a=i?t.naturalHeight:t.naturalWidth,r=s.clientWidth/o,c=s.clientHeight/a;if(r>=1&&c>=1)return void this.setState({zoom:1,minZoom:1,maxZoom:1,rotation:n});const l=.95*Math.min(r,c),d=this.state.zoom<=this.state.minZoom?l:this.state.zoom;this.setState({minZoom:l,maxZoom:1,rotation:n,zoom:d})}),r()(this,"onWheel",e=>{e.stopPropagation(),e.preventDefault();const{deltaY:t}=k(e);this.zoom(-.0025*t)}),r()(this,"onZoomInClick",()=>{this.zoom(.1)}),r()(this,"onZoomOutClick",()=>{this.zoom(-.1)}),r()(this,"onKeyDown",e=>{e.key===h.a.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.props.onFinished())}),r()(this,"onRotateCounterClockwiseClick",()=>{const e=this.state.rotation;this.setZoomAndRotation(e-90)}),r()(this,"onRotateClockwiseClick",()=>{const e=this.state.rotation;this.setZoomAndRotation(e+90)}),r()(this,"onDownloadClick",()=>{const e=document.createElement("a");e.href=this.props.src,e.download=this.props.name,e.target="_blank",e.rel="noreferrer noopener",e.click()}),r()(this,"onOpenContextMenu",()=>{this.setState({contextMenuDisplayed:!0})}),r()(this,"onCloseContextMenu",()=>{this.setState({contextMenuDisplayed:!1})}),r()(this,"onPermalinkClicked",e=>{e.preventDefault(),S.a.dispatch({action:"view_room",event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId()}),this.props.onFinished()}),r()(this,"onStartMoving",e=>{e.stopPropagation(),e.preventDefault(),0===e.button&&(this.state.zoom!==this.state.minZoom?(this.setState({moving:!0}),this.previousX=this.state.translationX,this.previousY=this.state.translationY,this.initX=e.pageX-this.state.translationX,this.initY=e.pageY-this.state.translationY):this.setState({zoom:this.state.maxZoom}))}),r()(this,"onMoving",e=>{e.stopPropagation(),e.preventDefault(),this.state.moving&&this.setState({translationX:e.pageX-this.initX,translationY:e.pageY-this.initY})}),r()(this,"onEndMoving",()=>{!0===this.state.moving&&Math.abs(this.state.translationX-this.previousX)<10&&Math.abs(this.state.translationY-this.previousY)<10&&(this.setState({zoom:this.state.minZoom,translationX:0,translationY:0}),this.initX=0,this.initY=0),this.setState({moving:!1})}),this.state={zoom:0,minZoom:.95,maxZoom:.95,rotation:0,translationX:0,translationY:0,moving:!1,contextMenuDisplayed:!1}}componentDidMount(){this.focusLock.current.addEventListener("wheel",this.onWheel,{passive:!1}),window.addEventListener("resize",this.recalculateZoom),this.image.current.addEventListener("load",this.recalculateZoom)}componentWillUnmount(){this.focusLock.current.removeEventListener("wheel",this.onWheel),window.removeEventListener("resize",this.recalculateZoom),this.image.current.removeEventListener("load",this.recalculateZoom)}zoom(e){const t=this.state.zoom+e;t<=this.state.minZoom?this.setState({zoom:this.state.minZoom,translationX:0,translationY:0}):t>=this.state.maxZoom?this.setState({zoom:this.state.maxZoom}):this.setState({zoom:t})}renderContextMenu(){let e=null;return this.state.contextMenuDisplayed&&(e=l.a.createElement(b.b,o()({},Object(b.k)(this.contextMenuButton.current.getBoundingClientRect()),{onFinished:this.onCloseContextMenu}),l.a.createElement(f.b,{mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator,onFinished:this.onCloseContextMenu,onCloseDialog:this.props.onFinished}))),l.a.createElement(l.a.Fragment,null,e)}render(){const e=!!this.props.mxEvent,t=this.state.maxZoom===this.state.minZoom;let s;s=this.state.moving?"grabbing":t?"default":this.state.zoom===this.state.minZoom?"zoom-in":"zoom-out";const n=this.state.rotation+"deg",i=this.state.zoom,o=this.state.translationX+"px",a=this.state.translationY+"px",r={cursor:s,transition:this.state.moving?null:"transform 200ms ease 0s",transform:`translateX(${o})\n                        translateY(${a})\n                        scale(${i})\n                        rotate(${n})`};let c,h,m,f;if(e){const e=this.props.mxEvent,t=_.b.getValue("showTwelveHourTimestamps");let s="#";this.props.permalinkCreator&&(s=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const n=e.sender?e.sender.name:e.getSender(),i=l.a.createElement("div",{className:"mx_ImageView_info_sender"},n),o=l.a.createElement("a",{href:s,onClick:this.onPermalinkClicked,"aria-label":Object(E.b)(new Date(this.props.mxEvent.getTs()),t,!1)},l.a.createElement(y.a,{showFullDate:!0,showTwelveHour:t,ts:e.getTs(),showSeconds:!1})),a=l.a.createElement(g.a,{member:e.sender,width:32,height:32,viewUserOnClick:!0});c=l.a.createElement("div",{className:"mx_ImageView_info_wrapper"},a,l.a.createElement("div",{className:"mx_ImageView_info"},i,o))}else c=l.a.createElement("div",null);return this.props.mxEvent&&(h=l.a.createElement(v.a,{className:"mx_ImageView_button mx_ImageView_button_more",title:Object(d.a)("Options"),onClick:this.onOpenContextMenu,inputRef:this.contextMenuButton,isExpanded:this.state.contextMenuDisplayed})),t||(m=l.a.createElement(u.a,{className:"mx_ImageView_button mx_ImageView_button_zoomOut",title:Object(d.a)("Zoom out"),onClick:this.onZoomOutClick}),f=l.a.createElement(u.a,{className:"mx_ImageView_button mx_ImageView_button_zoomIn",title:Object(d.a)("Zoom in"),onClick:this.onZoomInClick})),l.a.createElement(p.a,{returnFocus:!0,lockProps:{onKeyDown:this.onKeyDown,role:"dialog"},className:"mx_ImageView",ref:this.focusLock},l.a.createElement("div",{className:"mx_ImageView_panel"},c,l.a.createElement("div",{className:"mx_ImageView_toolbar"},l.a.createElement(u.a,{className:"mx_ImageView_button mx_ImageView_button_rotateCCW",title:Object(d.a)("Rotate Left"),onClick:this.onRotateCounterClockwiseClick}),l.a.createElement(u.a,{className:"mx_ImageView_button mx_ImageView_button_rotateCW",title:Object(d.a)("Rotate Right"),onClick:this.onRotateClockwiseClick}),m,f,l.a.createElement(u.a,{className:"mx_ImageView_button mx_ImageView_button_download",title:Object(d.a)("Download"),onClick:this.onDownloadClick}),h,l.a.createElement(u.a,{className:"mx_ImageView_button mx_ImageView_button_close",title:Object(d.a)("Close"),onClick:this.props.onFinished}),this.renderContextMenu())),l.a.createElement("div",{className:"mx_ImageView_image_wrapper",ref:this.imageWrapper,onMouseDown:this.props.onFinished,onMouseMove:this.onMoving,onMouseUp:this.onEndMoving,onMouseLeave:this.onEndMoving},l.a.createElement("img",{src:this.props.src,title:this.props.name,style:r,ref:this.image,className:"mx_ImageView_image",draggable:!0,onMouseDown:this.onStartMoving})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(18),i=s.n(n),o=s(153);const a={};var r=s(584),c=s(98);class l{constructor(){}static get instance(){return l.internalInstance||(l.internalInstance=new l),l.internalInstance}async onNewInvitedRoom(e){await r.a.sharedInstance().onNewInvitedRoom(e)}isRoomVisible(e){if(!e)return!1;if(o.e.sharedInstance().getSupportsVirtualRooms()&&r.a.sharedInstance().isVirtualRoom(e))return!1;if(c.b.getValue("feature_spaces")&&e.isSpaceRoom())return!1;const t=a.isRoomVisible;return!t||t(e)}}i()(l,"internalInstance",void 0)},,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(100);const d=e=>{let{label:t,isExpanded:s,children:n,onClick:o,onContextMenu:r}=e,d=a()(e,["label","isExpanded","children","onClick","onContextMenu"]);return c.a.createElement(l.a,i()({},d,{onClick:o,onContextMenu:r||o,title:t,"aria-label":t,"aria-haspopup":!0,"aria-expanded":s}),n)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r);const l=e=>{let{children:t,label:s}=e,n=a()(e,["children","label"]);return c.a.createElement("div",i()({},n,{role:"group","aria-label":s}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(100),d=s(113);const u=e=>{let{children:t,label:s,tooltip:n}=e,o=a()(e,["children","label","tooltip"]);const r=o["aria-label"]||s;return n?c.a.createElement(d.a,i()({},o,{role:"menuitem",tabIndex:-1,"aria-label":r,title:n}),t):c.a.createElement(l.a,i()({},o,{role:"menuitem",tabIndex:-1,"aria-label":r}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(100);const d=e=>{let{children:t,label:s,active:n,disabled:o}=e,r=a()(e,["children","label","active","disabled"]);return c.a.createElement(l.a,i()({},r,{role:"menuitemcheckbox","aria-checked":n,"aria-disabled":o,disabled:o,tabIndex:-1,"aria-label":s}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(100);const d=e=>{let{children:t,label:s,active:n,disabled:o}=e,r=a()(e,["children","label","active","disabled"]);return c.a.createElement(l.a,i()({},r,{role:"menuitemradio","aria-checked":n,"aria-disabled":o,disabled:o,tabIndex:-1,"aria-label":s}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(111),d=s(148);const u=e=>{let{children:t,label:s,onChange:n,onClose:o}=e,r=a()(e,["children","label","onChange","onClose"]);return c.a.createElement(d.a,i()({},r,{role:"menuitemcheckbox",tabIndex:-1,"aria-label":s,onChange:n,onKeyDown:e=>{e.key!==l.a.ENTER&&e.key!==l.a.SPACE||(e.stopPropagation(),e.preventDefault(),n(),e.key===l.a.ENTER&&o())},onKeyUp:e=>{e.key!==l.a.SPACE&&e.key!==l.a.ENTER||(e.stopPropagation(),e.preventDefault())}}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(111),d=s(211);const u=e=>{let{children:t,label:s,onChange:n,onClose:o}=e,r=a()(e,["children","label","onChange","onClose"]);return c.a.createElement(d.a,i()({},r,{role:"menuitemradio",tabIndex:-1,"aria-label":s,onChange:n,onKeyDown:e=>{e.key!==l.a.ENTER&&e.key!==l.a.SPACE||(e.stopPropagation(),e.preventDefault(),n(),e.key===l.a.ENTER&&o())},onKeyUp:e=>{e.key!==l.a.SPACE&&e.key!==l.a.ENTER||(e.stopPropagation(),e.preventDefault())}}),t)}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(18),i=s.n(n),o=s(94),a=s(8);class r extends a.EventEmitter{constructor(e){super(),this.dispatcher=e,i()(this,"matrixClient",void 0),i()(this,"dispatcherRef",void 0),i()(this,"onAction",async e=>{if("MatrixActions.sync"===e.action){if("PREPARED"!==e.prevState||"PREPARED"===e.state)return;this.matrixClient!==e.matrixClient&&(this.matrixClient&&await this.onNotReady(),this.matrixClient=e.matrixClient,await this.onReady())}else"on_client_not_viable"!==e.action&&"on_logged_out"!==e.action||this.matrixClient&&(await this.onNotReady(),this.matrixClient=null)}),this.dispatcherRef=this.dispatcher.register(this.onAction),o.a.get()&&(this.matrixClient=o.a.get(),this.onReady())}get mxClient(){return this.matrixClient}useUnitTestClient(e){this.matrixClient=e}destroy(){this.dispatcher.unregister(this.dispatcherRef)}async onReady(){}async onNotReady(){}}},function(e,t){e.exports="img/logo-spinner.3878bb0.svg"},function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return o}));var n=s(91);const i=(e,t)=>{const s=Object(n.useRef)();Object(n.useEffect)(()=>{s.current=e},[e]),Object(n.useEffect)(()=>{const e=setTimeout(()=>{s.current()},t);return()=>clearTimeout(e)},[t])},o=(e,t,s)=>{const[i,o]=Object(n.useState)(s);return((e,t)=>{const s=Object(n.useRef)();Object(n.useEffect)(()=>{s.current=e},[e]),Object(n.useEffect)(()=>{const e=setInterval(()=>{s.current()},t);return()=>clearInterval(e)},[t])})(()=>o(e=>e-1),t),0===i&&e(),i}},,,,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return o}));const n=new Map;function i(e,t){n.set(e,t)}function o(e){return n.get(e)}},function(e,t,s){"use strict";(function(e){var n=s(18),i=s.n(n),o=s(96),a=s(8),r=s.n(a),c=s(117),l=s(98),d=s(159),u=s(174),h=s(146),m=s(141);function p(e,t){const s=Math.min(e.length,t.length);let n;for(let i=0;i<s;++i)if(e.charAt(i)!==t.charAt(i)){n=e.substr(0,i);break}void 0===n&&(n=e.substr(0,s));const i=n.indexOf(" ");return-1!==i&&(n=n.substr(0,i+1)),n.length>=2?n:""}class g extends r.a{constructor(){super(),i()(this,"_onListsUpdated",()=>{const e=this._getUpdatedTags();this._state.tags&&!Object(m.d)(this._state.tags,e)||this._setState({tags:e})}),this._state={tags:{}},this._getUpdatedTags=Object(c.throttle)(this._getUpdatedTags,500,{leading:!0,trailing:!0}),d.b.instance.on(d.a,this._onListsUpdated),o.a.register(e=>this._onDispatch(e))}getTags(){return this._state.tags}_setState(e){this._state=Object.assign(this._state,e),this.emit("change")}addListener(e){return this.on("change",e),{remove:()=>{this.removeListener("change",e)}}}getSortedTags(){const e=Object.keys(this._state.tags).sort(),t=e.map((t,s)=>{const n=0===s,i=s===e.length-1,o=n?"":p(t,e[s-1]),a=i?"":p(t,e[s+1]);return o.length>a.length?o:a});return e.map((e,s)=>{const n=u.a.instance.getListState(e);let i;n.hasUnreadCount&&(i=n);const o=e.substr(t[s].length,1);return{name:e,avatarLetter:o,badgeNotifState:i,selected:this._state.tags[e]}})}_onDispatch(e){switch(e.action){case"select_custom_room_tag":{const t=this._state.tags;if(t.hasOwnProperty(e.tag)){const s={};s[e.tag]=!t[e.tag];const n=Object.assign({},t,s);this._setState({tags:n})}break}case"on_client_not_viable":case"on_logged_out":this._state={tags:{}},d.b.instance.off(d.a,this._onListsUpdated)}}_getUpdatedTags(){if(!l.b.getValue("feature_custom_tags"))return{};const e=Object.keys(d.b.instance.orderedLists).filter(e=>Object(h.d)(e)).sort(),t=this._state&&this._state.tags;return e.reduce((e,s)=>(e[s]=t&&t[s]||!1,e),{})}}void 0===e.singletonCustomRoomTagStore&&(e.singletonCustomRoomTagStore=new g),t.a=e.singletonCustomRoomTagStore}).call(this,s(7))},function(e,t,s){"use strict";function n(e,t){const s=t.getUserId();for(const t of Object.keys(e.getContent())){if(Object.keys(e.getContent()[t]["m.read"]||{}).includes(s))return!0}}s.d(t,"a",(function(){return n}))},function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return c}));var n=s(110),i=s(94),o=s(265),a=s(195);function r(e){if(e.sender&&e.sender.userId==i.a.get().credentials.userId)return!1;switch(e.getType()){case n.a.RoomMember:case n.a.RoomThirdPartyInvite:case n.a.CallAnswer:case n.a.CallHangup:case n.a.RoomAliases:case n.a.RoomCanonicalAlias:case n.a.RoomServerAcl:return!1}return!e.isRedacted()&&Object(a.b)(e)}function c(e){const t=i.a.get().getUserId(),s=e.getEventReadUpTo(t);if(e.timeline.length&&e.timeline[e.timeline.length-1].sender&&e.timeline[e.timeline.length-1].sender.userId===t)return!1;for(let t=e.timeline.length-1;t>=0;--t){const n=e.timeline[t];if(n.getId()==s)return!1;if(!Object(o.a)(n)&&r(n))return!0}return!0}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o}));var n=s(502);const i="https://matrix.to";class o extends n.b{constructor(){super()}forEvent(e,t,s){return`${i}/#/${e}/${t}${this.encodeServerCandidates(s)}`}forRoom(e,t){return`${i}/#/${e}${this.encodeServerCandidates(t)}`}forUser(e){return`${i}/#/${e}`}forGroup(e){return`${i}/#/${e}`}forEntity(e){return`${i}/#/${e}`}isPermalinkHost(e){return"matrix.to"===e}encodeServerCandidates(e){return e&&0!==e.length?"?via="+e.map(e=>encodeURIComponent(e)).join("&via="):""}parsePermalink(e){if(!e||!e.startsWith(i))throw new Error("Does not appear to be a permalink");const t=e.substring((i+"/#/").length).split("/"),s=t[0];if("@"===s[0])return n.a.forUser(s);if("+"===s[0])return n.a.forGroup(s);if("#"===s[0]||"!"===s[0]){if(1===t.length){const[e,t=""]=s.split("?"),i=t.split(/&?via=/g).filter(e=>!!e);return n.a.forRoom(e,i)}const e=t.length>1?t.slice(1).join("/"):"",[i,o=""]=e.split("?"),a=o.split(/&?via=/g).filter(e=>!!e);return n.a.forEvent(s,i,a)}throw new Error("Unknown entity type in permalink")}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return a}));var n=s(18),i=s.n(n);class o{forEvent(e,t,s=[]){throw new Error("Not implemented")}forRoom(e,t=[]){throw new Error("Not implemented")}forGroup(e){throw new Error("Not implemented")}forUser(e){throw new Error("Not implemented")}forEntity(e){throw new Error("Not implemented")}isPermalinkHost(e){throw new Error("Not implemented")}parsePermalink(e){throw new Error("Not implemented")}}class a{constructor(e,t,s,n,o){i()(this,"roomIdOrAlias",void 0),i()(this,"eventId",void 0),i()(this,"userId",void 0),i()(this,"groupId",void 0),i()(this,"viaServers",void 0),this.roomIdOrAlias=e,this.eventId=t,this.groupId=n,this.userId=s,this.viaServers=o}static forUser(e){return new a(null,null,e,null,null)}static forGroup(e){return new a(null,null,null,e,null)}static forRoom(e,t=[]){return new a(e,null,null,null,t)}static forEvent(e,t,s=[]){return new a(e,t,null,null,s)}get primaryEntityId(){return this.roomIdOrAlias||this.userId||this.groupId}get sigil(){return this.primaryEntityId[0]}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){},,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(95),l=s(92),d=s(98),u=s(106),h=s(93);let m=Object(h.a)("views.dialogs.AskInviteAnywayDialog")(n=class extends r.a.Component{constructor(...e){super(...e),o()(this,"onInviteClicked",()=>{this.props.onInviteAnyways(),this.props.onFinished(!0)}),o()(this,"onInviteNeverWarnClicked",()=>{d.b.setValue("promptBeforeInviteUnknownUsers",null,u.a.ACCOUNT,!1),this.props.onInviteAnyways(),this.props.onFinished(!0)}),o()(this,"onGiveUpClicked",()=>{this.props.onGiveUp(),this.props.onFinished(!1)})}render(){const e=c.getComponent("views.dialogs.BaseDialog"),t=this.props.unknownProfileUsers.map(e=>r.a.createElement("li",{key:e.userId},e.userId,": ",e.errorText));return r.a.createElement(e,{className:"mx_RetryInvitesDialog",onFinished:this.onGiveUpClicked,title:Object(l.a)("The following users may not exist"),contentId:"mx_Dialog_content"},r.a.createElement("div",{id:"mx_Dialog_content"},r.a.createElement("p",null,Object(l.a)("Unable to find profiles for the Matrix IDs listed below - would you like to invite them anyway?")),r.a.createElement("ul",null,t)),r.a.createElement("div",{className:"mx_Dialog_buttons"},r.a.createElement("button",{onClick:this.onGiveUpClicked},Object(l.a)("Close")),r.a.createElement("button",{onClick:this.onInviteNeverWarnClicked},Object(l.a)("Invite anyway and never warn me again")),r.a.createElement("button",{onClick:this.onInviteClicked,autoFocus:!0},Object(l.a)("Invite anyway"))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(0),i=s(273);function o(e){return"crypto.sessions/"+e}function a(e){return"crypto.session.problems/"+e}function r(e,t){return"crypto.inboundgroupsessions/"+e+"/"+t}function c(e,t){return"crypto.inboundgroupsessions.withheld/"+e+"/"+t}function l(e){return"crypto.rooms/"+e}class d extends i.a{constructor(e){super(),this.store=e}static exists(e){const t=e.length;for(let s=0;s<t;s++)if(e.key(s).startsWith("crypto."))return!0;return!1}countEndToEndSessions(e,t){let s=0;for(let e=0;e<this.store.length;++e)this.store.key(e).startsWith(o(""))&&++s;t(s)}_getEndToEndSessions(e,t,s){const n=u(this.store,o(e)),i={};for(const[e,t]of Object.entries(n||{}))i[e]="string"==typeof t?{session:t}:t;return i}getEndToEndSession(e,t,s,n){n(this._getEndToEndSessions(e)[t]||{})}getEndToEndSessions(e,t,s){s(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(let e=0;e<this.store.length;++e)if(this.store.key(e).startsWith(o(""))){const s=this.store.key(e).split("/")[1];for(const e of Object.values(this._getEndToEndSessions(s)))t(e)}}storeEndToEndSession(e,t,s,n){const i=this._getEndToEndSessions(e)||{};i[t]=s,h(this.store,o(e),i)}async storeEndToEndSessionProblem(e,t,s){const n=a(e),i=u(this.store,n)||[];i.push({type:t,fixed:s,time:Date.now()}),i.sort((e,t)=>e.time-t.time),h(this.store,n,i)}async getEndToEndSessionProblem(e,t){const s=a(e),n=u(this.store,s)||[];if(!n.length)return null;const i=n[n.length-1];for(const e of n)if(e.time>t)return Object.assign({},e,{fixed:i.fixed});return i.fixed?null:i}async filterOutNotifiedErrorDevices(e){const t=u(this.store,"crypto.notified_error_devices")||{},s=[];for(const n of e){const{userId:e,deviceInfo:i}=n;e in t?i.deviceId in t[e]||(s.push(n),t[e][i.deviceId]=!0):(s.push(n),t[e]={[i.deviceId]:!0})}return h(this.store,"crypto.notified_error_devices",t),s}getEndToEndInboundGroupSession(e,t,s,n){n(u(this.store,r(e,t)),u(this.store,c(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let e=0;e<this.store.length;++e){const s=this.store.key(e);s.startsWith("crypto.inboundgroupsessions/")&&t({senderKey:s.substr("crypto.inboundgroupsessions/".length,43),sessionId:s.substr("crypto.inboundgroupsessions/".length+44),sessionData:u(this.store,s)})}t(null)}addEndToEndInboundGroupSession(e,t,s,n){u(this.store,r(e,t))||this.storeEndToEndInboundGroupSession(e,t,s,n)}storeEndToEndInboundGroupSession(e,t,s,n){h(this.store,r(e,t),s)}storeEndToEndInboundGroupSessionWithheld(e,t,s,n){h(this.store,c(e,t),s)}getEndToEndDeviceData(e,t){t(u(this.store,"crypto.device_data"))}storeEndToEndDeviceData(e,t){h(this.store,"crypto.device_data",e)}storeEndToEndRoom(e,t,s){h(this.store,l(e),t)}getEndToEndRooms(e,t){const s={},n=l("");for(let e=0;e<this.store.length;++e){const t=this.store.key(e);if(t.startsWith(n)){s[t.substr(n.length)]=u(this.store,t)}}t(s)}getSessionsNeedingBackup(e){const t=u(this.store,"crypto.sessionsneedingbackup")||{},s=[];for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const t=n.substr(0,43),i=n.substr(44);if(this.getEndToEndInboundGroupSession(t,i,null,e=>{s.push({senderKey:t,sessionId:i,sessionData:e})}),e&&n.length>=e)break}return Promise.resolve(s)}countSessionsNeedingBackup(){const e=u(this.store,"crypto.sessionsneedingbackup")||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){const t=u(this.store,"crypto.sessionsneedingbackup")||{};for(const s of e)delete t[s.senderKey+"/"+s.sessionId];return h(this.store,"crypto.sessionsneedingbackup",t),Promise.resolve()}markSessionsNeedingBackup(e){const t=u(this.store,"crypto.sessionsneedingbackup")||{};for(const s of e)t[s.senderKey+"/"+s.sessionId]=!0;return h(this.store,"crypto.sessionsneedingbackup",t),Promise.resolve()}deleteAllData(){return this.store.removeItem("crypto.account"),Promise.resolve()}getAccount(e,t){t(u(this.store,"crypto.account"))}storeAccount(e,t){h(this.store,"crypto.account",t)}getCrossSigningKeys(e,t){t(u(this.store,"crypto.cross_signing_keys"))}getSecretStorePrivateKey(e,t,s){t(u(this.store,"crypto.ssss_cache."+s))}storeCrossSigningKeys(e,t){h(this.store,"crypto.cross_signing_keys",t)}storeSecretStorePrivateKey(e,t,s){h(this.store,"crypto.ssss_cache."+t,s)}doTxn(e,t,s){return Promise.resolve(s(null))}}function u(e,t){try{return JSON.parse(e.getItem(t))}catch(e){n.a.log("Error: Failed to get key %s: %s",t,e.stack||e),n.a.log(e.stack)}return null}function h(e,t,s){e.setItem(t,JSON.stringify(s))}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return c}));var n=s(0),i=s(160),o=s(744);function a(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>49152){const t=new Error("Message too long ("+e.length+" bytes). The maximum for an encrypted message is 49152 bytes.");throw t.data={errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"},t}}function r(e){this._cryptoStore=e,this._pickleKey="DEFAULT_KEY",this.deviceCurve25519Key=null,this.deviceEd25519Key=null,this._maxOneTimeKeys=null,this._outboundGroupSessionStore={},this._inboundGroupSessionMessageIndexes={},this._sessionsInProgress={},this._olmPrekeyPromise=Promise.resolve()}r.prototype.init=async function(t={}){let s;const o=new e.Olm.Account,{pickleKey:a,fromExportedDevice:r}=t;try{r?(a&&n.a.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this._pickleKey=r.pickleKey,await async function(e,t,s,n){await t.doTxn("readwrite",[i.a.STORE_ACCOUNT,i.a.STORE_SESSIONS],s=>{t.storeAccount(s,e.pickledAccount),e.sessions.forEach(e=>{const{deviceKey:n,sessionId:i}=e,o={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};t.storeEndToEndSession(n,i,o,s)})}),n.unpickle(s,e.pickledAccount)}(r,this._cryptoStore,this._pickleKey,o)):(a&&(this._pickleKey=a),await async function(e,t,s){await e.doTxn("readwrite",[i.a.STORE_ACCOUNT],n=>{e.getAccount(n,i=>{null!==i?s.unpickle(t,i):(s.create(),i=s.pickle(t),e.storeAccount(n,i))})})}(this._cryptoStore,this._pickleKey,o)),s=JSON.parse(o.identity_keys()),this._maxOneTimeKeys=o.max_number_of_one_time_keys()}finally{o.free()}this.deviceCurve25519Key=s.curve25519,this.deviceEd25519Key=s.ed25519},r.getOlmVersion=function(){return e.Olm.get_library_version()},r.prototype._getAccount=function(t,s){this._cryptoStore.getAccount(t,t=>{const n=new e.Olm.Account;try{n.unpickle(this._pickleKey,t),s(n)}finally{n.free()}})},r.prototype._storeAccount=function(e,t){this._cryptoStore.storeAccount(e,t.pickle(this._pickleKey))},r.prototype.export=async function(){const e={pickleKey:this._pickleKey};return await this._cryptoStore.doTxn("readonly",[i.a.STORE_ACCOUNT,i.a.STORE_SESSIONS],t=>{this._cryptoStore.getAccount(t,t=>{e.pickledAccount=t}),e.sessions=[],this._cryptoStore.getAllEndToEndSessions(t,t=>{e.sessions.push(t)})}),e},r.prototype._getSession=function(e,t,s,n){this._cryptoStore.getEndToEndSession(e,t,s,e=>{this._unpickleSession(e,n)})},r.prototype._unpickleSession=function(t,s){const n=new e.Olm.Session;try{n.unpickle(this._pickleKey,t.session);s(Object.assign({},t,{session:n}))}finally{n.free()}},r.prototype._saveSession=function(e,t,s){const n=t.session.session_id(),i=Object.assign(t,{session:t.session.pickle(this._pickleKey)});this._cryptoStore.storeEndToEndSession(e,n,i,s)},r.prototype._getUtility=function(t){const s=new e.Olm.Utility;try{return t(s)}finally{s.free()}},r.prototype.sign=async function(e){let t;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_ACCOUNT],s=>{this._getAccount(s,s=>{t=s.sign(e)})}),t},r.prototype.getOneTimeKeys=async function(){let e;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_ACCOUNT],t=>{this._getAccount(t,t=>{e=JSON.parse(t.one_time_keys())})}),e},r.prototype.maxNumberOfOneTimeKeys=function(){return this._maxOneTimeKeys},r.prototype.markKeysAsPublished=async function(){await this._cryptoStore.doTxn("readwrite",[i.a.STORE_ACCOUNT],e=>{this._getAccount(e,t=>{t.mark_keys_as_published(),this._storeAccount(e,t)})})},r.prototype.generateOneTimeKeys=function(e){return this._cryptoStore.doTxn("readwrite",[i.a.STORE_ACCOUNT],t=>{this._getAccount(t,s=>{s.generate_one_time_keys(e),this._storeAccount(t,s)})})},r.prototype.generateFallbackKey=async function(){await this._cryptoStore.doTxn("readwrite",[i.a.STORE_ACCOUNT],e=>{this._getAccount(e,t=>{t.generate_fallback_key(),this._storeAccount(e,t)})})},r.prototype.getFallbackKey=async function(){let e;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_ACCOUNT],t=>{this._getAccount(t,t=>{e=JSON.parse(t.fallback_key())})}),e},r.prototype.createOutboundSession=async function(t,s){let o;return await this._cryptoStore.doTxn("readwrite",[i.a.STORE_ACCOUNT,i.a.STORE_SESSIONS],n=>{this._getAccount(n,i=>{const a=new e.Olm.Session;try{a.create_outbound(i,t,s),o=a.session_id(),this._storeAccount(n,i);const e={session:a,lastReceivedMessageTs:Date.now()};this._saveSession(t,e,n)}finally{a.free()}})},n.a.withPrefix("[createOutboundSession]")),o},r.prototype.createInboundSession=async function(t,s,o){if(0!==s)throw new Error("Need messageType == 0 to create inbound session");let a;return await this._cryptoStore.doTxn("readwrite",[i.a.STORE_ACCOUNT,i.a.STORE_SESSIONS],n=>{this._getAccount(n,i=>{const r=new e.Olm.Session;try{r.create_inbound_from(i,t,o),i.remove_one_time_keys(r),this._storeAccount(n,i);const e=r.decrypt(s,o),c={session:r,lastReceivedMessageTs:Date.now()};this._saveSession(t,c,n),a={payload:e,session_id:r.session_id()}}finally{r.free()}})},n.a.withPrefix("[createInboundSession]")),a},r.prototype.getSessionIdsForDevice=async function(e){const t=n.a.withPrefix("[getSessionIdsForDevice]");if(this._sessionsInProgress[e]){t.debug(`Waiting for Olm session for ${e} to be created`);try{await this._sessionsInProgress[e]}catch(e){}}let s;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_SESSIONS],t=>{this._cryptoStore.getEndToEndSessions(e,t,e=>{s=Object.keys(e)})},t),s},r.prototype.getSessionIdForDevice=async function(e,t,s){const n=await this.getSessionInfoForDevice(e,t,s);if(0===n.length)return null;let i=0;for(let e=1;e<n.length;e++){const t=n[e],s=void 0===t.lastReceivedMessageTs?0:t.lastReceivedMessageTs,o=n[i],a=void 0===o.lastReceivedMessageTs?0:o.lastReceivedMessageTs;(s>a||s===a&&t.sessionId<o.sessionId)&&(i=e)}return n[i].sessionId},r.prototype.getSessionInfoForDevice=async function(e,t,s=n.a){if(s=s.withPrefix("[getSessionInfoForDevice]"),this._sessionsInProgress[e]&&!t){s.debug(`Waiting for Olm session for ${e} to be created`);try{await this._sessionsInProgress[e]}catch(e){}}const o=[];return await this._cryptoStore.doTxn("readonly",[i.a.STORE_SESSIONS],t=>{this._cryptoStore.getEndToEndSessions(e,t,e=>{const t=Object.keys(e).sort();for(const s of t)this._unpickleSession(e[s],e=>{o.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:s})})})},s),o},r.prototype.encryptMessage=async function(e,t,s){let o;return a(s),await this._cryptoStore.doTxn("readwrite",[i.a.STORE_SESSIONS],i=>{this._getSession(e,t,i,a=>{const r=a.session.describe();n.a.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+r),o=a.session.encrypt(s),this._saveSession(e,a,i)})},n.a.withPrefix("[encryptMessage]")),o},r.prototype.decryptMessage=async function(e,t,s,o){let a;return await this._cryptoStore.doTxn("readwrite",[i.a.STORE_SESSIONS],i=>{this._getSession(e,t,i,r=>{const c=r.session.describe();n.a.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),a=r.session.decrypt(s,o),r.lastReceivedMessageTs=Date.now(),this._saveSession(e,r,i)})},n.a.withPrefix("[decryptMessage]")),a},r.prototype.matchesSession=async function(e,t,s,o){if(0!==s)return!1;let a;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_SESSIONS],s=>{this._getSession(e,t,s,e=>{a=e.session.matches_inbound(o)})},n.a.withPrefix("[matchesSession]")),a},r.prototype.recordSessionProblem=async function(e,t,s){await this._cryptoStore.storeEndToEndSessionProblem(e,t,s)},r.prototype.sessionMayHaveProblems=async function(e,t){return await this._cryptoStore.getEndToEndSessionProblem(e,t)},r.prototype.filterOutNotifiedErrorDevices=async function(e){return await this._cryptoStore.filterOutNotifiedErrorDevices(e)},r.prototype._saveOutboundGroupSession=function(e){const t=e.pickle(this._pickleKey);this._outboundGroupSessionStore[e.session_id()]=t},r.prototype._getOutboundGroupSession=function(t,s){const n=this._outboundGroupSessionStore[t];if(void 0===n)throw new Error("Unknown outbound group session "+t);const i=new e.Olm.OutboundGroupSession;try{return i.unpickle(this._pickleKey,n),s(i)}finally{i.free()}},r.prototype.createOutboundGroupSession=function(){const t=new e.Olm.OutboundGroupSession;try{return t.create(),this._saveOutboundGroupSession(t),t.session_id()}finally{t.free()}},r.prototype.encryptGroupMessage=function(e,t){const s=this;return n.a.log("encrypting msg with megolm session "+e),a(t),this._getOutboundGroupSession(e,(function(e){const n=e.encrypt(t);return s._saveOutboundGroupSession(e),n}))},r.prototype.getOutboundGroupSessionKey=function(e){return this._getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))},r.prototype._unpickleInboundGroupSession=function(t,s){const n=new e.Olm.InboundGroupSession;try{return n.unpickle(this._pickleKey,t.session),s(n)}finally{n.free()}},r.prototype._getInboundGroupSession=function(e,t,s,n,i){this._cryptoStore.getEndToEndInboundGroupSession(t,s,n,(t,s)=>{if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this._unpickleInboundGroupSession(t,e=>{i(e,t,s)})}else i(null,null,s)})},r.prototype.addInboundGroupSession=async function(t,s,o,a,r,c,l,d={}){await this._cryptoStore.doTxn("readwrite",[i.a.STORE_INBOUND_GROUP_SESSIONS,i.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,i.a.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],i=>{this._getInboundGroupSession(t,s,a,i,(u,h)=>{const m=new e.Olm.InboundGroupSession;try{if(l?m.import_session(r):m.create(r),a!=m.session_id())throw new Error("Mismatched group session ID from senderKey: "+s);if(u&&(n.a.log("Update for megolm session "+s+"/"+a),u.first_known_index()<=m.first_known_index()&&(u.first_known_index()!=m.first_known_index()||d.untrusted||!h.untrusted)))return void n.a.log("Keeping existing megolm session "+a);n.a.info("Storing megolm session "+s+"/"+a+" with first index "+m.first_known_index());const e=Object.assign({},d,{room_id:t,session:m.pickle(this._pickleKey),keysClaimed:c,forwardingCurve25519KeyChain:o});this._cryptoStore.storeEndToEndInboundGroupSession(s,a,e,i),!u&&d.sharedHistory&&this._cryptoStore.addSharedHistoryInboundGroupSession(t,s,a,i)}finally{m.free()}})},n.a.withPrefix("[addInboundGroupSession]"))},r.prototype.addInboundGroupSessionWithheld=async function(e,t,s,n,o){await this._cryptoStore.doTxn("readwrite",[i.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,s,{room_id:e,code:n,reason:o},i)})};const c={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function l(e){return e.code&&e.code in c?c[e.code]:e.reason?e.reason:"decryption key withheld"}r.prototype.decryptGroupMessage=async function(e,t,s,a,r,c){let d,u;if(await this._cryptoStore.doTxn("readwrite",[i.a.STORE_INBOUND_GROUP_SESSIONS,i.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],n=>{this._getInboundGroupSession(e,t,s,n,(e,i,h)=>{if(null===e)return h&&(u=new o.b("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",l(h),{session:t+"|"+s})),void(d=null);let m;try{m=e.decrypt(a)}catch(e){return void(u=e&&"OLM.UNKNOWN_MESSAGE_INDEX"===e.message&&h?new o.b("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",l(h),{session:t+"|"+s}):e)}let p=m.plaintext;if(void 0===p)p=m;else{const e=t+"|"+s+"|"+m.message_index;if(e in this._inboundGroupSessionMessageIndexes){const t=this._inboundGroupSessionMessageIndexes[e];if(t.id!==r||t.timestamp!==c)return void(u=new Error("Duplicate message index, possible replay attack: "+e))}this._inboundGroupSessionMessageIndexes[e]={id:r,timestamp:c}}i.session=e.pickle(this._pickleKey),this._cryptoStore.storeEndToEndInboundGroupSession(t,s,i,n),d={result:p,keysClaimed:i.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:i.forwardingCurve25519KeyChain||[],untrusted:i.untrusted}})},n.a.withPrefix("[decryptGroupMessage]")),u)throw u;return d},r.prototype.hasInboundSessionKeys=async function(e,t,s){let o;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_INBOUND_GROUP_SESSIONS,i.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._cryptoStore.getEndToEndInboundGroupSession(t,s,i,i=>{null!==i?e!==i.room_id?(n.a.warn(`requested keys for inbound group session ${t}|`+s+", with incorrect room_id "+`(expected ${i.room_id}, `+`was ${e})`),o=!1):o=!0:o=!1})},n.a.withPrefix("[hasInboundSessionKeys]")),o},r.prototype.getInboundGroupSessionKey=async function(e,t,s,o){let a;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_INBOUND_GROUP_SESSIONS,i.a.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],n=>{this._getInboundGroupSession(e,t,s,n,(e,t)=>{if(null===e)return void(a=null);void 0===o&&(o=e.first_known_index());const s=e.export_session(o),n=(t.keysClaimed||{}).ed25519||null;a={chain_index:o,key:s,forwarding_curve25519_key_chain:t.forwardingCurve25519KeyChain||[],sender_claimed_ed25519_key:n,shared_history:t.sharedHistory||!1}})},n.a.withPrefix("[getInboundGroupSessionKey]")),a},r.prototype.exportInboundGroupSession=function(e,t,s){return this._unpickleInboundGroupSession(s,n=>{const i=n.first_known_index();return{sender_key:e,sender_claimed_keys:s.keysClaimed,room_id:s.room_id,session_id:t,session_key:n.export_session(i),forwarding_curve25519_key_chain:n.forwardingCurve25519KeyChain||[],first_known_index:n.first_known_index(),"org.matrix.msc3061.shared_history":s.sharedHistory||!1}})},r.prototype.getSharedHistoryInboundGroupSessions=async function(e){let t;return await this._cryptoStore.doTxn("readonly",[i.a.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],s=>{t=this._cryptoStore.getSharedHistoryInboundGroupSessions(e,s)},n.a.withPrefix("[getSharedHistoryInboundGroupSessionsForRoom]")),t},r.prototype.verifySignature=function(e,t,s){this._getUtility((function(n){n.ed25519_verify(e,t,s)}))}}).call(this,s(7))},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(0),i=s(1),o=s(139),a=s(314),r=s(556);function c(e){const t=e.currentState&&e.currentState.getStateEvents("m.room.history_visibility",""),s=t&&t.getContent()&&t.getContent().history_visibility;return["world_readable","shared"].includes(s)}function l(e,t=!1){this.sessionId=e,this.useCount=0,this.creationTime=(new Date).getTime(),this.sharedWithDevices={},this.blockedDevicesNotified={},this.sharedHistory=t}function d(e){Object(i.y)(this,a.e,e),this._setupPromise=Promise.resolve(),this._outboundSessions={},this._sessionRotationPeriodMsgs=100,this._sessionRotationPeriodMs=6048e5,void 0!==e.config.rotation_period_ms&&(this._sessionRotationPeriodMs=e.config.rotation_period_ms),void 0!==e.config.rotation_period_msgs&&(this._sessionRotationPeriodMsgs=e.config.rotation_period_msgs)}function u(e){Object(i.y)(this,a.b,e),this._pendingEvents={},this.olmlib=o}l.prototype.needsRotation=function(e,t){const s=(new Date).getTime()-this.creationTime;return(this.useCount>=e||s>=t)&&(n.a.log("Rotating megolm session after "+this.useCount+" messages, "+s+"ms"),!0)},l.prototype.markSharedWithDevice=function(e,t,s){this.sharedWithDevices[e]||(this.sharedWithDevices[e]={}),this.sharedWithDevices[e][t]=s},l.prototype.markNotifiedBlockedDevice=function(e,t){this.blockedDevicesNotified[e]||(this.blockedDevicesNotified[e]={}),this.blockedDevicesNotified[e][t]=!0},l.prototype.sharedWithTooManyDevices=function(e){for(const t in this.sharedWithDevices)if(this.sharedWithDevices.hasOwnProperty(t)){if(!e.hasOwnProperty(t))return n.a.log("Starting new megolm session because we shared with "+t),!0;for(const s in this.sharedWithDevices[t])if(this.sharedWithDevices[t].hasOwnProperty(s)&&!e[t].hasOwnProperty(s))return n.a.log("Starting new megolm session because we shared with "+t+":"+s),!0}},i.r(d,a.e),d.prototype._ensureOutboundSession=async function(e,t,s,i){let a;function r(){return a}const l=this._setupPromise.then(async r=>{a=r;const l=c(e);a&&l!==a.sharedHistory&&(a=null),a&&a.needsRotation(this._sessionRotationPeriodMsgs,this._sessionRotationPeriodMs)&&(n.a.log("Starting new megolm session because we need to rotate."),a=null),a&&a.sharedWithTooManyDevices(t)&&(a=null),a||(n.a.log("Starting new megolm session for room "+this._roomId),a=await this._prepareNewSession(l),n.a.log(`Started new megolm session ${a.sessionId} for room `+this._roomId),this._outboundSessions[a.sessionId]=a);const d={};for(const[e,s]of Object.entries(t))for(const[t,n]of Object.entries(s)){n.getIdentityKey()!=this._olmDevice.deviceCurve25519Key&&(a.sharedWithDevices[e]&&void 0!==a.sharedWithDevices[e][t]||(d[e]=d[e]||[],d[e].push(n)))}const u=this._olmDevice.getOutboundGroupSessionKey(a.sessionId),h={type:"m.room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:a.sessionId,session_key:u.key,chain_index:u.chain_index,"org.matrix.msc3061.shared_history":l}},[m,p]=await o.getExistingOlmSessions(this._olmDevice,this._baseApis,d);await Promise.all([(async()=>{n.a.debug("Sharing keys with existing Olm sessions in "+this._roomId),await this._shareKeyWithOlmSessions(a,u,h,p),n.a.debug("Shared keys with existing Olm sessions in "+this._roomId)})(),(async()=>{n.a.debug("Sharing keys (start phase 1) with new Olm sessions in "+this._roomId);const e=[],t=Date.now(),s=[];await this._shareKeyWithDevices(a,u,h,m,e,i?1e4:2e3,s),n.a.debug("Shared keys (end phase 1) with new Olm sessions in "+this._roomId),!i&&Date.now()-t<1e4?(async()=>{const t={},i=new Set;for(const e of s)i.add(e);const o=[];for(const{userId:s,deviceInfo:n}of e){const e=s.slice(s.indexOf(":")+1);i.has(e)?(t[s]=t[s]||[],t[s].push(n)):o.push({userId:s,deviceInfo:n})}n.a.debug("Sharing keys (start phase 2) with new Olm sessions in "+this._roomId),await this._shareKeyWithDevices(a,u,h,t,o,3e4),n.a.debug("Shared keys (end phase 2) with new Olm sessions in "+this._roomId),await this._notifyFailedOlmDevices(a,u,o)})():await this._notifyFailedOlmDevices(a,u,e),n.a.debug("Shared keys (all phases done) with new Olm sessions in "+this._roomId)})(),(async()=>{n.a.debug("Notifying blocked devices in "+this._roomId);const e={};let t=0;for(const[n,i]of Object.entries(s))for(const[s,o]of Object.entries(i))a.blockedDevicesNotified[n]&&void 0!==a.blockedDevicesNotified[n][s]||(e[n]=e[n]||{},e[n][s]={device:o},t++);await this._notifyBlockedDevices(a,e),n.a.debug(`Notified ${t} blocked devices in ${this._roomId}`)})()])});return l.catch(e=>{n.a.error("Failed to ensure outbound session in "+this._roomId,e)}),this._setupPromise=l.then(r,r),l.then(r)},d.prototype._prepareNewSession=async function(e){const t=this._olmDevice.createOutboundGroupSession(),s=this._olmDevice.getOutboundGroupSessionKey(t);return await this._olmDevice.addInboundGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],t,s.key,{ed25519:this._olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),this._crypto.backupManager.backupGroupSession(this._olmDevice.deviceCurve25519Key,t),new l(t,e)},d.prototype._getDevicesWithoutSessions=function(e,t,s){s=s||[];for(const[n,i]of Object.entries(t)){const t=e[n];for(const e of i){const i=e.deviceId;t[i].sessionId||(s.push({userId:n,deviceInfo:e}),delete t[i])}}return s},d.prototype._splitDevices=function(e){let t=[];const s=[t];for(const[n,i]of Object.entries(e)){for(const e of Object.values(i))t.push({userId:n,deviceInfo:e.device});t.length>20&&(t=[],s.push(t))}return 0===t.length&&s.pop(),s},d.prototype._encryptAndSendKeysToDevices=function(e,t,s,i){const a={},r=[];for(let e=0;e<s.length;e++){const t={algorithm:o.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},n=s[e],c=n.userId,l=n.deviceInfo,d=l.deviceId;a[c]||(a[c]={}),a[c][d]=t,r.push(o.encryptMessageForDevice(t.ciphertext,this._userId,this._deviceId,this._olmDevice,c,l,i))}return Promise.all(r).then(()=>{for(const e of Object.keys(a)){for(const t of Object.keys(a[e]))0===Object.keys(a[e][t].ciphertext).length&&(n.a.log("No ciphertext for device "+e+":"+t+": pruning"),delete a[e][t]);0===Object.keys(a[e]).length&&(n.a.log("Pruned all devices for user "+e),delete a[e])}if(0!==Object.keys(a).length)return this._baseApis.sendToDevice("m.room.encrypted",a).then(()=>{for(const s of Object.keys(a))for(const n of Object.keys(a[s]))e.markSharedWithDevice(s,n,t)});n.a.log("No users left to send to: aborting")})},d.prototype._sendBlockedNotificationsToDevices=async function(e,t,s){const n={};for(const e of t){const t=e.userId,i=e.deviceInfo,o=i.deviceInfo.deviceId,a=Object.assign({},s);a.code=i.code,a.reason=i.reason,"m.no_olm"===a.code&&(delete a.room_id,delete a.session_id),n[t]||(n[t]={}),n[t][o]=a}await this._baseApis.sendToDevice("org.matrix.room_key.withheld",n);for(const t of Object.keys(n))for(const s of Object.keys(n[t]))e.markNotifiedBlockedDevice(t,s)},d.prototype.reshareKeyWithDevice=async function(e,t,s,i){const a=this._outboundSessions[t];if(!a)return void n.a.debug(`megolm session ${t} not found: not re-sharing keys`);if(void 0===a.sharedWithDevices[s])return void n.a.debug(`megolm session ${t} never shared with user ${s}`);const r=a.sharedWithDevices[s][i.deviceId];if(void 0===r)return void n.a.debug("megolm session ID "+t+" never shared with device "+s+":"+i.deviceId);const c=await this._olmDevice.getInboundGroupSessionKey(this._roomId,e,t,r);if(!c)return void n.a.warn(`No inbound session key found for megolm ${t}: not re-sharing keys`);await o.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[s]:[i]});const l={type:"m.forwarded_room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:t,session_key:c.key,chain_index:c.chain_index,sender_key:e,sender_claimed_ed25519_key:c.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:c.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":c.shared_history||!1}},d={algorithm:o.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await o.encryptMessageForDevice(d.ciphertext,this._userId,this._deviceId,this._olmDevice,s,i,l),await this._baseApis.sendToDevice("m.room.encrypted",{[s]:{[i.deviceId]:d}}),n.a.debug(`Re-shared key for megolm session ${t} with ${s}:${i.deviceId}`)},d.prototype._shareKeyWithDevices=async function(e,t,s,i,a,r,c){n.a.debug("Ensuring Olm sessions for devices in "+this._roomId);const l=await o.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,i,r,c,n.a.withPrefix(`[${this._roomId}]`));n.a.debug("Ensured Olm sessions for devices in "+this._roomId),this._getDevicesWithoutSessions(l,i,a),n.a.debug("Sharing keys with Olm sessions in "+this._roomId),await this._shareKeyWithOlmSessions(e,t,s,l),n.a.debug("Shared keys with Olm sessions in "+this._roomId)},d.prototype._shareKeyWithOlmSessions=async function(e,t,s,i){const o=this._splitDevices(i);for(let i=0;i<o.length;i++){const a=`megolm keys for ${e.sessionId} in ${this._roomId} (slice ${i+1}/${o.length})`;try{n.a.debug("Sharing "+a),await this._encryptAndSendKeysToDevices(e,t.chain_index,o[i],s),n.a.debug("Shared "+a)}catch(e){throw n.a.error("Failed to share "+a),e}}},d.prototype._notifyFailedOlmDevices=async function(e,t,s){n.a.debug(`Notifying ${s.length} devices we failed to create Olm sessions in `+this._roomId);for(const{userId:n,deviceInfo:i}of s){const s=i.deviceId;e.markSharedWithDevice(n,s,t.chain_index)}const i=await this._olmDevice.filterOutNotifiedErrorDevices(s);n.a.debug(`Filtered down to ${i.length} error devices in `+this._roomId);const o={};for(const{userId:e,deviceInfo:t}of i)o[e]=o[e]||{},o[e][t.deviceId]={device:{code:"m.no_olm",reason:r.b["m.no_olm"],deviceInfo:t}};await this._notifyBlockedDevices(e,o),n.a.debug(`Notified ${i.length} devices we failed to create Olm sessions in `+this._roomId)},d.prototype._notifyBlockedDevices=async function(e,t){const s={room_id:this._roomId,session_id:e.sessionId,algorithm:o.MEGOLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key},i=this._splitDevices(t);for(let t=0;t<i.length;t++)try{await this._sendBlockedNotificationsToDevices(e,i[t],s),n.a.log(`Completed blacklist notification for ${e.sessionId} in ${this._roomId} (slice ${t+1}/${i.length})`)}catch(s){throw n.a.log(`blacklist notification for ${e.sessionId} in ${this._roomId} (slice ${t+1}/${i.length}) failed`),s}},d.prototype.prepareToEncrypt=function(e){if(this.encryptionPreparation){const e=Date.now()-this.encryptionPreparationMetadata.startTime;n.a.debug(`Already started preparing to encrypt for ${this._roomId} `+e+" ms ago, skipping")}else n.a.debug("Preparing to encrypt events for "+this._roomId),this.encryptionPreparationMetadata={startTime:Date.now()},this.encryptionPreparation=(async()=>{try{n.a.debug("Getting devices in "+this._roomId);const[t,s]=await this._getDevicesInRoom(e);this._crypto.getGlobalErrorOnUnknownDevices()&&this._removeUnknownDevices(t),n.a.debug("Ensuring outbound session in "+this._roomId),await this._ensureOutboundSession(e,t,s,!0),n.a.debug("Ready to encrypt events for "+this._roomId)}catch(e){n.a.error("Failed to prepare to encrypt events for "+this._roomId,e)}finally{delete this.encryptionPreparationMetadata,delete this.encryptionPreparation}})()},d.prototype.encryptMessage=async function(e,t,s){if(n.a.log("Starting to encrypt event for "+this._roomId),this.encryptionPreparation)try{await this.encryptionPreparation}catch(e){}const[i,a]=await this._getDevicesInRoom(e);this._crypto.getGlobalErrorOnUnknownDevices()&&this._checkForUnknownDevices(i);const r=await this._ensureOutboundSession(e,i,a),c={room_id:this._roomId,type:t,content:s},l=this._olmDevice.encryptGroupMessage(r.sessionId,JSON.stringify(c)),d={algorithm:o.MEGOLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:l,session_id:r.sessionId,device_id:this._deviceId};return r.useCount++,d},d.prototype.forceDiscardSession=function(){this._setupPromise=this._setupPromise.then(()=>null)},d.prototype._checkForUnknownDevices=function(e){const t={};if(Object.keys(e).forEach(s=>{Object.keys(e[s]).forEach(n=>{const i=e[s][n];i.isUnverified()&&!i.isKnown()&&(t[s]||(t[s]={}),t[s][n]=i)})}),Object.keys(t).length)throw new a.f("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)},d.prototype._removeUnknownDevices=function(e){for(const[t,s]of Object.entries(e)){for(const[e,t]of Object.entries(s))t.isUnverified()&&!t.isKnown()&&delete s[e];0===Object.keys(s).length&&delete e[t]}},d.prototype._getDevicesInRoom=async function(e){const t=(await e.getEncryptionTargetMembers()).map((function(e){return e.userId}));let s=this._crypto.getGlobalBlacklistUnverifiedDevices();"boolean"==typeof e.getBlacklistUnverifiedDevices()&&(s=e.getBlacklistUnverifiedDevices());const n=await this._crypto.downloadKeys(t,!1),i={};for(const e in n){if(!n.hasOwnProperty(e))continue;const t=n[e];for(const n in t){if(!t.hasOwnProperty(n))continue;const o=this._crypto.checkDeviceTrust(e,n);if(t[n].isBlocked()||!o.isVerified()&&s){i[e]||(i[e]={});const s=t[n].isBlocked()?{code:"m.blacklisted",reason:r.b["m.blacklisted"]}:{code:"m.unverified",reason:r.b["m.unverified"]};s.deviceInfo=t[n],i[e][n]=s,delete t[n]}}}return[n,i]},i.r(u,a.b);const h={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};u.prototype.decryptEvent=async function(e){const t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new a.c("MEGOLM_MISSING_FIELDS","Missing fields in input");let s;this._addEventToPendingList(e);try{s=await this._olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs())}catch(s){if("DecryptionError"===s.name)throw s;let n="OLM_DECRYPT_GROUP_MESSAGE_ERROR";throw s&&"OLM.UNKNOWN_MESSAGE_INDEX"===s.message&&(this._requestKeysForEvent(e),n="OLM_UNKNOWN_MESSAGE_INDEX"),new a.c(n,s?s.toString():"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id})}if(null===s){this._requestKeysForEvent(e);const s=await this._olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4);if(s){let e=h[s.type]||h.unknown;throw s.fixed&&(e+=" Trying to create a new secure channel and re-requesting the keys."),new a.c("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e,{session:t.sender_key+"|"+t.session_id})}throw new a.c("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id})}this._removeEventFromPendingList(e);const n=JSON.parse(s.result);if(n.room_id!==e.getRoomId())throw new a.c("MEGOLM_BAD_ROOM","Message intended for room "+n.room_id);return{clearEvent:n,senderCurve25519Key:s.senderKey,claimedEd25519Key:s.keysClaimed.ed25519,forwardingCurve25519KeyChain:s.forwardingCurve25519KeyChain,untrusted:s.untrusted}},u.prototype._requestKeysForEvent=function(e){const t=e.getWireContent(),s=e.getKeyRequestRecipients(this._userId);this._crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},s)},u.prototype._addEventToPendingList=function(e){const t=e.getWireContent(),s=t.sender_key,n=t.session_id;this._pendingEvents[s]||(this._pendingEvents[s]=new Map);const i=this._pendingEvents[s];i.has(n)||i.set(n,new Set),i.get(n).add(e)},u.prototype._removeEventFromPendingList=function(e){const t=e.getWireContent(),s=t.sender_key,n=t.session_id,i=this._pendingEvents[s],o=i&&i.get(n);o&&(o.delete(e),0===o.size&&i.delete(s),0===i.size&&delete this._pendingEvents[s])},u.prototype.onRoomKeyEvent=function(e){const t=e.getContent(),s=t.session_id;let i,o=e.getSenderKey(),a=[],r=!1;if(!t.room_id||!s||!t.session_key)return void n.a.error("key event is missing fields");if(!o)return void n.a.error("key event has no sender key (not encrypted?)");if("m.forwarded_room_key"==e.getType()){if(r=!0,a=t.forwarding_curve25519_key_chain,Array.isArray(a)||(a=[]),a=a.slice(),a.push(o),o=t.sender_key,!o)return void n.a.error("forwarded_room_key event is missing sender_key field");const e=t.sender_claimed_ed25519_key;if(!e)return void n.a.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");i={ed25519:e}}else i=e.getKeysClaimed();const c={};return t["org.matrix.msc3061.shared_history"]&&(c.sharedHistory=!0),this._olmDevice.addInboundGroupSession(t.room_id,o,a,s,t.session_key,i,r,c).then(()=>{this._retryDecryption(o,s).then(e=>{e&&this._crypto.cancelRoomKeyRequest({algorithm:t.algorithm,room_id:t.room_id,session_id:t.session_id,sender_key:o})})}).then(()=>{this._crypto.backupManager.backupGroupSession(o,t.session_id)}).catch(e=>{n.a.error("Error handling m.room_key_event: "+e)})},u.prototype.onRoomKeyWithheldEvent=async function(e){const t=e.getContent(),s=t.sender_key;if("m.no_olm"===t.code){const i=e.getSender();if(n.a.warn(`${i}:${s} was unable to establish an olm session with us`),await this._olmDevice.getSessionIdForDevice(s))return n.a.debug("New session already created.  Not creating a new one."),await this._olmDevice.recordSessionProblem(s,"no_olm",!0),void this.retryDecryptionFromSender(s);let a=this._crypto.deviceList.getDeviceByIdentityKey(t.algorithm,s);if(!a&&(await this._crypto.downloadKeys([i],!1),a=this._crypto.deviceList.getDeviceByIdentityKey(t.algorithm,s),!a))return n.a.info("Couldn't find device for identity key "+s+": not establishing session"),await this._olmDevice.recordSessionProblem(s,"no_olm",!1),void this.retryDecryptionFromSender(s);await o.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[i]:[a]},!1);const r={algorithm:o.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await o.encryptMessageForDevice(r.ciphertext,this._userId,this._deviceId,this._olmDevice,i,a,{type:"m.dummy"}),await this._olmDevice.recordSessionProblem(s,"no_olm",!0),this.retryDecryptionFromSender(s),await this._baseApis.sendToDevice("m.room.encrypted",{[i]:{[a.deviceId]:r}})}else await this._olmDevice.addInboundGroupSessionWithheld(t.room_id,s,t.session_id,t.code,t.reason)},u.prototype.hasKeysForKeyRequest=function(e){const t=e.requestBody;return this._olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)},u.prototype.shareKeysWithDevice=function(e){const t=e.userId,s=e.deviceId,i=this._crypto.getStoredDevice(t,s),a=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[t]:[i]}).then(e=>e[t][s].sessionId?(n.a.log("sharing keys for session "+a.sender_key+"|"+a.session_id+" with device "+t+":"+s),this._buildKeyForwardingMessage(a.room_id,a.sender_key,a.session_id)):null).then(e=>{const n={algorithm:o.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};return this.olmlib.encryptMessageForDevice(n.ciphertext,this._userId,this._deviceId,this._olmDevice,t,i,e).then(()=>{const e={[t]:{[s]:n}};return this._baseApis.sendToDevice("m.room.encrypted",e)})})},u.prototype._buildKeyForwardingMessage=async function(e,t,s){const n=await this._olmDevice.getInboundGroupSessionKey(e,t,s);return{type:"m.forwarded_room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:n.sender_claimed_ed25519_key,session_id:s,session_key:n.key,chain_index:n.chain_index,forwarding_curve25519_key_chain:n.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":n.shared_history||!1}}},u.prototype.importRoomKey=function(e,t={}){const s={};return t.untrusted&&(s.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(s.sharedHistory=!0),this._olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,s).then(()=>{"backup"!==t.source&&this._crypto.backupManager.backupGroupSession(e.sender_key,e.session_id).catch(e=>{n.a.log("Failed to back up megolm session",e)}),this._retryDecryption(e.sender_key,e.session_id)})},u.prototype._retryDecryption=async function(e,t){const s=this._pendingEvents[e];if(!s)return!0;const i=s.get(t);return!i||(n.a.debug("Retrying decryption on events",[...i]),await Promise.all([...i].map(async e=>{try{await e.attemptDecryption(this._crypto,{isRetry:!0})}catch(e){}})),!(this._pendingEvents[e]||{})[t])},u.prototype.retryDecryptionFromSender=async function(e){const t=this._pendingEvents[e];return!t||(delete this._pendingEvents[e],await Promise.all([...t].map(async([e,t])=>{await Promise.all([...t].map(async e=>{try{await e.attemptDecryption(this._crypto)}catch(e){}}))})),!this._pendingEvents[e])},u.prototype.sendSharedHistoryInboundSessions=async function(e){await o.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,e),n.a.log("sendSharedHistoryInboundSessions to users",Object.keys(e));const t=await this._olmDevice.getSharedHistoryInboundGroupSessions(this._roomId);n.a.log("shared-history sessions",t);for(const[s,i]of t){const t=await this._buildKeyForwardingMessage(this._roomId,s,i),a=[],r={};for(const[s,n]of Object.entries(e)){r[s]={};for(const e of n){const n={algorithm:o.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};r[s][e.deviceId]=n,a.push(o.encryptMessageForDevice(n.ciphertext,this._userId,this._deviceId,this._olmDevice,s,e,t))}}await Promise.all(a);for(const e of Object.keys(r)){for(const t of Object.keys(r[e]))0===Object.keys(r[e][t].ciphertext).length&&(n.a.log("No ciphertext for device "+e+":"+t+": pruning"),delete r[e][t]);0===Object.keys(r[e]).length&&(n.a.log("Pruned all devices for user "+e),delete r[e])}if(0===Object.keys(r).length)return void n.a.log("No users left to send to: aborting");await this._baseApis.sendToDevice("m.room.encrypted",r)}},Object(a.g)(o.MEGOLM_ALGORITHM,d,u)},function(e,t,s){"use strict";(function(e,n){s.d(t,"a",(function(){return h})),s.d(t,"b",(function(){return m}));var i=s(115),o=s.n(i),a=s(139),r=s(160),c=s(274),l=s(311),d=s.n(l),u=s(0);const h="org.matrix.msc2697.v1.olm.libolm_pickle";class m{constructor(e){this.crypto=e,o()(this,"inProgress",!1),o()(this,"timeoutId",void 0),o()(this,"key",void 0),o()(this,"keyInfo",void 0),o()(this,"deviceDisplayName",void 0),this.getDehydrationKeyFromCache()}async getDehydrationKeyFromCache(){return await this.crypto.cryptoStore.doTxn("readonly",[r.a.STORE_ACCOUNT],t=>{this.crypto.cryptoStore.getSecretStorePrivateKey(t,async t=>{if(t){const{key:s,keyInfo:i,deviceDisplayName:o,time:r}=t,l=e.from(this.crypto.olmDevice._pickleKey),d=await Object(c.a)(s,l,h);this.key=Object(a.decodeBase64)(d),this.keyInfo=i,this.deviceDisplayName=o;const u=Date.now(),m=Math.max(1,r+6048e5-u);this.timeoutId=n.setTimeout(this.dehydrateDevice.bind(this),m)}},"dehydration")})}async setKeyAndQueueDehydration(e,t={},s){await this.setKey(e,t,s)||this.dehydrateDevice()}async setKey(e,t={},s){if(!e)return this.timeoutId&&(n.clearTimeout(this.timeoutId),this.timeoutId=void 0),await this.crypto.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",null)}),this.key=void 0,void(this.keyInfo=void 0);let i=this.key&&e.length==this.key.length;for(let t=0;i&&t<e.length;t++)e[t]!=this.key[t]&&(i=!1);return i||(this.key=e,this.keyInfo=t,this.deviceDisplayName=s),i}async dehydrateDevice(){if(this.inProgress)u.a.log("Dehydration already in progress -- not starting new dehydration");else{this.inProgress=!0,this.timeoutId&&(n.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{const t=e.from(this.crypto.olmDevice._pickleKey),s=await Object(c.b)(Object(a.encodeBase64)(this.key),t,h);await this.crypto.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",{keyInfo:this.keyInfo,key:s,deviceDisplayName:this.deviceDisplayName,time:Date.now()})}),u.a.log("Attempting to dehydrate device"),u.a.log("Creating account");const i=new n.Olm.Account;i.create();const o=JSON.parse(i.identity_keys()),l=i.max_number_of_one_time_keys();i.generate_one_time_keys(l/2),i.generate_fallback_key();const m=JSON.parse(i.one_time_keys()),p=JSON.parse(i.fallback_key());i.mark_keys_as_published();const g=i.pickle(new Uint8Array(this.key)),v={algorithm:h,account:g};this.keyInfo.passphrase&&(v.passphrase=this.keyInfo.passphrase),u.a.log("Uploading account to server");const f=(await this.crypto.baseApis.http.authedRequest(void 0,"PUT","/dehydrated_device",void 0,{device_data:v,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).device_id;u.a.log("Preparing device keys",f);const b={algorithms:this.crypto.supportedAlgorithms,device_id:f,user_id:this.crypto.userId,keys:{["ed25519:"+f]:o.ed25519,["curve25519:"+f]:o.curve25519}},y=i.sign(d.a.stringify(b));b.signatures={[this.crypto.userId]:{["ed25519:"+f]:y}},this.crypto.crossSigningInfo.getId("self_signing")&&await this.crypto.crossSigningInfo.signObject(b,"self_signing"),u.a.log("Preparing one-time keys");const _={};for(const[e,t]of Object.entries(m.curve25519)){const s={key:t},n=i.sign(d.a.stringify(s));s.signatures={[this.crypto.userId]:{["ed25519:"+f]:n}},_["signed_curve25519:"+e]=s}u.a.log("Preparing fallback keys");const E={};for(const[e,t]of Object.entries(p.curve25519)){const s={key:t,fallback:!0},n=i.sign(d.a.stringify(s));s.signatures={[this.crypto.userId]:{["ed25519:"+f]:n}},E["signed_curve25519:"+e]=s}return u.a.log("Uploading keys to server"),await this.crypto.baseApis.http.authedRequest(void 0,"POST","/keys/upload/"+encodeURI(f),void 0,{device_keys:b,one_time_keys:_,"org.matrix.msc2732.fallback_keys":E}),u.a.log("Done dehydrating"),this.timeoutId=n.setTimeout(this.dehydrateDevice.bind(this),6048e5),f}finally{this.inProgress=!1}}}stop(){this.timeoutId&&(n.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}}).call(this,s(36).Buffer,s(7))},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return h}));var n=s(115),i=s.n(n),o=s(178),a=s(0),r=s(139),c=s(316),l=s(1),d=s(160),u=s(317);class h{constructor(e,t){this.baseApis=e,this.getKey=t,i()(this,"algorithm",void 0),i()(this,"backupInfo",void 0),i()(this,"checkedForBackup",void 0),i()(this,"sendingBackups",void 0),this.checkedForBackup=!1,this.sendingBackups=!1}get version(){return this.backupInfo&&this.backupInfo.version}static async makeAlgorithm(e,t){const s=p[e.algorithm];if(!s)throw new Error("Unknown backup algorithm");return await s.init(e.auth_data,t)}async enableKeyBackup(e){this.backupInfo=e,this.algorithm&&this.algorithm.free(),this.algorithm=await h.makeAlgorithm(e,this.getKey),this.baseApis.emit("crypto.keyBackupStatus",!0),this.scheduleKeyBackupSend()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit("crypto.keyBackupStatus",!1)}getKeyBackupEnabled(){return this.checkedForBackup?Boolean(this.algorithm):null}async prepareKeyBackupVersion(e,t){const s=t?p[t]:g;if(!s)throw new Error("Unknown backup algorithm");const[n,i]=await s.prepare(e),o=Object(u.b)(n);return{algorithm:s.algorithmName,auth_data:i,recovery_key:o,privateKey:n}}async createKeyBackupVersion(e){this.algorithm=await h.makeAlgorithm(e,this.getKey)}async checkAndStart(){if(a.a.log("Checking key backup status..."),this.baseApis.isGuest())return a.a.log("Skipping key backup check since user is guest"),this.checkedForBackup=!0,null;let e;try{e=await this.baseApis.getKeyBackupVersion()}catch(e){return a.a.log("Error checking for active key backup",e),404===e.httpStatus&&(this.checkedForBackup=!0),null}this.checkedForBackup=!0;const t=await this.isKeyBackupTrusted(e);return t.usable&&!this.backupInfo?(a.a.log("Found usable key backup v"+e.version+": enabling key backups"),await this.enableKeyBackup(e)):!t.usable&&this.backupInfo?(a.a.log("No usable key backup: disabling key backup"),this.disableKeyBackup()):t.usable||this.backupInfo?t.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(a.a.log("On backup version "+this.backupInfo.version+" but found version "+e.version+": switching."),this.disableKeyBackup(),await this.enableKeyBackup(e),await this.scheduleAllGroupSessionsForBackup()):a.a.log("Backup version "+e.version+" still current")):a.a.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:t}}async checkKeyBackup(){return this.checkedForBackup=!1,this.checkAndStart()}async isKeyBackupTrusted(e){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!(e&&e.algorithm&&e.auth_data&&e.auth_data.public_key&&e.auth_data.signatures))return a.a.info("Key backup is absent or missing required data"),t;const s=this.baseApis.crypto.sessionStore.getLocalTrustedBackupPubKey();e.auth_data.public_key===s&&(a.a.info("Backup public key "+s+" is trusted locally"),t.trusted_locally=!0);const n=e.auth_data.signatures[this.baseApis.getUserId()]||[];for(const s of Object.keys(n)){const n=s.split(":");if("ed25519"!==n[0]){a.a.log("Ignoring unknown signature type: "+n[0]);continue}const i={deviceId:n[1]},o=this.baseApis.crypto.crossSigningInfo.getId();if(o===i.deviceId){i.crossSigningId=!0;try{await Object(r.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,this.baseApis.getUserId(),i.deviceId,o),i.valid=!0}catch(e){a.a.warn("Bad signature from cross signing key "+o,e),i.valid=!1}t.sigs.push(i);continue}const c=this.baseApis.crypto.deviceList.getStoredDevice(this.baseApis.getUserId(),i.deviceId);if(c){i.device=c,i.deviceTrust=await this.baseApis.checkDeviceTrust(this.baseApis.getUserId(),i.deviceId);try{await Object(r.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,this.baseApis.getUserId(),c.deviceId,c.getFingerprint()),i.valid=!0}catch(t){a.a.info("Bad signature from key ID "+s+" userID "+this.baseApis.getUserId()+" device ID "+c.deviceId+" fingerprint: "+c.getFingerprint(),e.auth_data,t),i.valid=!1}}else i.valid=null,a.a.info("Ignoring signature from unknown key "+s);t.sigs.push(i)}return t.usable=t.sigs.some(e=>e.valid&&(e.device&&e.deviceTrust.isVerified()||e.crossSigningId)),t.usable=t.usable||t.trusted_locally,t}async scheduleKeyBackupSend(e=1e4){if(!this.sendingBackups){this.sendingBackups=!0;try{const t=Math.random()*e;await Object(l.F)(t,void 0);let s=0;for(;;){if(!this.algorithm)return;try{if(0===await this.backupPendingKeys(200))return;s=0}catch(e){if(s++,a.a.log("Key backup request failed",e),e.data&&("M_NOT_FOUND"==e.data.errcode||"M_WRONG_ROOM_KEYS_VERSION"==e.data.errcode))throw await this.checkKeyBackup(),this.baseApis.crypto.emit("crypto.keyBackupFailed",e.data.errcode),e}s&&await Object(l.F)(1e3*Math.pow(2,Math.min(s-1,4)),void 0)}}finally{this.sendingBackups=!1}}}async backupPendingKeys(e){const t=await this.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let s=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();this.baseApis.crypto.emit("crypto.keyBackupSessionsRemaining",s);const n={};for(const e of t){const t=e.sessionData.room_id;void 0===n[t]&&(n[t]={sessions:{}});const s=await this.baseApis.crypto.olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);s.algorithm=r.MEGOLM_ALGORITHM;const i=(s.forwarding_curve25519_key_chain||[]).length,o=this.baseApis.crypto.deviceList.getUserByIdentityKey(r.MEGOLM_ALGORITHM,e.senderKey),a=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(r.MEGOLM_ALGORITHM,e.senderKey),c=this.baseApis.crypto.checkDeviceInfoTrust(o,a).isVerified();n[t].sessions[e.sessionId]={first_message_index:s.first_known_index,forwarded_count:i,is_verified:c,session_data:await this.algorithm.encryptSession(s)}}return await this.baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:n}),await this.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(t),s=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),this.baseApis.crypto.emit("crypto.keyBackupSessionsRemaining",s),t.length}async backupGroupSession(e,t){await this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),this.backupInfo&&this.scheduleKeyBackupSend()}async scheduleAllGroupSessionsForBackup(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)}async flagAllGroupSessionsForBackup(){await this.baseApis.crypto.cryptoStore.doTxn("readwrite",[d.a.STORE_INBOUND_GROUP_SESSIONS,d.a.STORE_BACKUP],e=>{this.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(e,t=>{null!==t&&this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([t],e)})});const e=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return this.baseApis.emit("crypto.keyBackupSessionsRemaining",e),e}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}class m{constructor(e,t,s){this.authData=e,this.publicKey=t,this.getKey=s}static async init(t,s){if(!t||!t.public_key)throw new Error("auth_data missing required information");const n=new e.Olm.PkEncryption;return n.set_recipient_key(t.public_key),new m(t,n,s)}static async prepare(t){const s=new e.Olm.PkDecryption;try{const n={};if(t)if(t instanceof Uint8Array)n.public_key=s.init_with_private_key(t);else{const e=await Object(c.c)(t);n.private_key_salt=e.salt,n.private_key_iterations=e.iterations,n.public_key=s.init_with_private_key(e.key)}else n.public_key=s.generate_key();return(new e.Olm.PkEncryption).set_recipient_key(n.public_key),[s.get_private_key(),n]}finally{s.free()}}async encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,this.publicKey.encrypt(JSON.stringify(t))}async decryptSessions(t){const s=await this.getKey(),n=new e.Olm.PkDecryption;try{if(n.init_with_private_key(s)!==this.authData.public_key)throw{errcode:o.b.RESTORE_BACKUP_ERROR_BAD_KEY};const e=[];for(const[s,i]of Object.entries(t))try{const t=JSON.parse(n.decrypt(i.session_data.ephemeral,i.session_data.mac,i.session_data.ciphertext));t.session_id=s,e.push(t)}catch(e){a.a.log("Failed to decrypt megolm session from backup",e,i)}return e}finally{n.free()}}async keyMatches(t){const s=new e.Olm.PkDecryption;let n;try{n=s.init_with_private_key(t)}finally{s.free()}return n===this.authData.public_key}free(){this.publicKey.free()}}i()(m,"algorithmName","m.megolm_backup.v1.curve25519-aes-sha2");const p={[m.algorithmName]:m},g=m}).call(this,s(7))},,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(95),m=s(92),p=s(96),g=s(111),v=s(93);let f=Object(v.a)("views.settings.IntegrationManager")((o=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onKeyDown",e=>{e.key===g.a.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.props.onFinished())}),r()(this,"onAction",e=>{"close_scalar"===e.action&&this.props.onFinished()}),r()(this,"onError",()=>{this.setState({errored:!0})}),this.state={errored:!1}}componentDidMount(){this.dispatcherRef=p.a.register(this.onAction),document.addEventListener("keydown",this.onKeyDown)}componentWillUnmount(){p.a.unregister(this.dispatcherRef),document.removeEventListener("keydown",this.onKeyDown)}render(){if(this.props.loading){const e=h.getComponent("elements.Spinner");return l.a.createElement("div",{className:"mx_IntegrationManager_loading"},l.a.createElement("h3",null,Object(m.a)("Connecting to integration manager...")),l.a.createElement(e,null))}return!this.props.connected||this.state.errored?l.a.createElement("div",{className:"mx_IntegrationManager_error"},l.a.createElement("h3",null,Object(m.a)("Cannot connect to integration manager")),l.a.createElement("p",null,Object(m.a)("The integration manager is offline or it cannot reach your homeserver."))):l.a.createElement("iframe",{src:this.props.url,onError:this.onError})}},r()(i,"propTypes",{connected:u.a.bool.isRequired,loading:u.a.bool.isRequired,url:u.a.string,onFinished:u.a.func.isRequired}),r()(i,"defaultProps",{connected:!0,loading:!1}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(92),m=s(102),p=s(95),g=s(93);let v=Object(g.a)("views.dialogs.IntegrationsImpossibleDialog")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"_onAcknowledgeClick",()=>{this.props.onFinished()})}render(){const e=m.a.get().brand,t=p.getComponent("views.dialogs.BaseDialog"),s=p.getComponent("views.elements.DialogButtons");return l.a.createElement(t,{className:"mx_IntegrationsImpossibleDialog",hasCancel:!1,onFinished:this.props.onFinished,title:Object(h.a)("Integrations not allowed")},l.a.createElement("div",{className:"mx_IntegrationsImpossibleDialog_content"},l.a.createElement("p",null,Object(h.a)("Your %(brand)s doesn't allow you to use an Integration Manager to do this. Please contact an admin.",{brand:e}))),l.a.createElement(s,{primaryButton:Object(h.a)("OK"),onPrimaryButtonClick:this._onAcknowledgeClick,hasCancel:!1}))}},r()(i,"propTypes",{onFinished:u.a.func.isRequired}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(183),m=s(230),p=s(95),g=s(277),v=s(101),f=s.n(v),b=s(570),y=s(93);let _=Object(y.a)("views.dialogs.TabbedIntegrationManagerDialog")((o=i=class extends l.a.Component{constructor(e){super(e),r()(this,"openManager",async(e,t=!1)=>{if(e===this.state.currentIndex&&!t)return;const s=this.state.managers[e],n=s.getScalarClient();this.setState({busy:!0,currentIndex:e,currentLoading:!0,currentConnected:!1,currentScalarClient:n}),b.a(s.uiUrl),n.setTermsInteractionCallback((e,t)=>Object(g.c)(e,t,"mx_TermsDialog_forIntegrationManager"));try{await n.connect(),n.hasCredentials()?this.setState({busy:!1,currentLoading:!1,currentConnected:!0}):this.setState({busy:!1,currentLoading:!1,currentConnected:!1})}catch(e){if(e instanceof g.b)return;console.error(e),this.setState({busy:!1,currentLoading:!1,currentConnected:!1})}}),this.state={managers:h.a.sharedInstance().getOrderedManagers(),busy:!0,currentIndex:0,currentConnected:!1,currentLoading:!0,currentScalarClient:null}}componentDidMount(){this.openManager(0,!0)}_renderTabs(){const e=p.getComponent("views.elements.AccessibleButton");return this.state.managers.map((t,s)=>{const n=f()({mx_TabbedIntegrationManagerDialog_tab:!0,mx_TabbedIntegrationManagerDialog_currentTab:this.state.currentIndex===s});return l.a.createElement(e,{className:n,onClick:()=>this.openManager(s),key:"tab_"+s,disabled:this.state.busy},t.name)})}_renderTab(){const e=p.getComponent("views.settings.IntegrationManager");let t=null;return this.state.currentScalarClient&&(t=this.state.currentScalarClient.getScalarInterfaceUrlForRoom(this.props.room,this.props.screen,this.props.integrationId)),l.a.createElement(e,{configured:!0,loading:this.state.currentLoading,connected:this.state.currentConnected,url:t,onFinished:()=>{}})}render(){return l.a.createElement("div",{className:"mx_TabbedIntegrationManagerDialog_container"},l.a.createElement("div",{className:"mx_TabbedIntegrationManagerDialog_tabs"},this._renderTabs()),l.a.createElement("div",{className:"mx_TabbedIntegrationManagerDialog_currentManager"},this._renderTab()))}},r()(i,"propTypes",{onFinished:u.a.func.isRequired,room:u.a.instanceOf(m.b),screen:u.a.string,integrationId:u.a.string}),n=o))||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return _})),s.d(t,"c",(function(){return E})),s.d(t,"a",(function(){return S}));var n=s(94),i=s(114),o=s(96),a=s(140),r=s(133),c=s(92),l=s(183),d=s(161),u=s(141);function h(e,t){const s=Object(u.a)(e.data);s.response=t,e.source.postMessage(s,e.origin)}function m(e,t,s){console.error("Action:"+e.data.action+" failed with message: "+t);const n=Object(u.a)(e.data);n.response={error:{message:t}},s&&(n.response.error._error=s),e.source.postMessage(n,e.origin)}function p(e,t){const s=e.data.widget_id;let n=e.data.type;const i=e.data.url,r=e.data.name,l=e.data.data,u=e.data.userWidget;if(s&&void 0!==i){if(null!==i){if(void 0!==r&&"string"!=typeof r)return void m(e,Object(c.a)("Unable to create widget."),new Error("Optional field 'name' must be a string."));if(void 0!==l&&!(l instanceof Object))return void m(e,Object(c.a)("Unable to create widget."),new Error("Optional field 'data' must be an Object."));if("string"!=typeof n)return void m(e,Object(c.a)("Unable to create widget."),new Error("Field 'type' must be a string."));if("string"!=typeof i)return void m(e,Object(c.a)("Unable to create widget."),new Error("Field 'url' must be a string or null."))}n=d.a.fromString(n),u?a.a.setUserWidget(s,n,i,r,l).then(()=>{h(e,{success:!0}),o.a.dispatch({action:"user_widget_updated"})}).catch(t=>{m(e,Object(c.a)("Unable to create widget."),t)}):(t||m(e,Object(c.a)("Missing roomId."),null),a.a.setRoomWidget(t,s,n,i,r,l).then(()=>{h(e,{success:!0})},t=>{m(e,Object(c.a)("Failed to send request."),t)}))}else m(e,Object(c.a)("Unable to create widget."),new Error("Missing required widget fields."))}function g(e,t){const s=n.a.get();if(!s)return void m(e,Object(c.a)("You need to be logged in."));let i=[];if(t){const n=s.getRoom(t);if(!n)return void m(e,Object(c.a)("This room is not recognised."));i=a.a.getRoomWidgets(n).map(e=>e.event)}const o=a.a.getUserWidgetsArray();i=i.concat(o),h(e,i)}function v(e,t,s,i){const o=n.a.get();if(!o)return void m(e,Object(c.a)("You need to be logged in."));const a=o.getRoom(t);if(!a)return void m(e,Object(c.a)("This room is not recognised."));const r=a.currentState.getStateEvents(s,i);h(e,r?r.getContent():null)}const f=function(e){let t,s;e.origin||(e.origin=e.originalEvent.origin);try{y||(y=l.a.sharedInstance().getPrimaryManager().uiUrl),t=new URL(y)}catch(e){return}try{s=new URL(e.origin)}catch(e){return}if(t.origin!==s.origin||!e.data.action||e.data.api)return;if("close_scalar"===e.data.action)return o.a.dispatch({action:"close_scalar"}),void h(e,null);const a=e.data.room_id,d=e.data.user_id;if(!a)return"get_widgets"===e.data.action?void g(e,null):"set_widget"===e.data.action?void p(e,null):void m(e,Object(c.a)("Missing room_id in request"));if(a===r.a.getRoomId())if("get_widgets"!==e.data.action)if("set_widget"!==e.data.action)if("join_rules_state"!==e.data.action)if("set_plumbing_state"!==e.data.action)if("get_membership_count"!==e.data.action)if("get_room_enc_state"!==e.data.action)if("can_send_event"!==e.data.action)if(d)switch(e.data.action){case"membership_state":!function(e,t,s){console.log(`membership_state of ${s} in room ${t} requested.`),v(e,t,"m.room.member",s)}(e,a,d);break;case"invite":!function(e,t,s){console.log(`Received request to invite ${s} into room ${t}`);const i=n.a.get();if(!i)return void m(e,Object(c.a)("You need to be logged in."));const o=i.getRoom(t);if(o){const t=o.getMember(s);if(t&&"invite"===t.membership)return void h(e,{success:!0})}i.invite(t,s).then((function(){h(e,{success:!0})}),(function(t){m(e,Object(c.a)("You need to be able to invite users to do that."),t)}))}(e,a,d);break;case"bot_options":!function(e,t,s){console.log(`bot_options of ${s} in room ${t} requested.`),v(e,t,"m.room.bot.options","_"+s)}(e,a,d);break;case"set_bot_options":!function(e,t,s){console.log(`Received request to set options for bot ${s} in room ${t}`);const i=n.a.get();i?i.sendStateEvent(t,"m.room.bot.options",e.data.content,"_"+s).then(()=>{h(e,{success:!0})},t=>{m(e,t.message?t.message:Object(c.a)("Failed to send request."),t)}):m(e,Object(c.a)("You need to be logged in."))}(e,a,d);break;case"set_bot_power":!function(e,t,s,o){if(!(Number.isInteger(o)&&o>=0))return void m(e,Object(c.a)("Power level must be positive integer."));console.log(`Received request to set power level to ${o} for bot ${s} in room ${t}.`);const a=n.a.get();a?a.getStateEvent(t,"m.room.power_levels","").then(n=>{const r=new i.b({type:"m.room.power_levels",content:n});a.setPowerLevel(t,s,o,r).then(()=>{h(e,{success:!0})},t=>{m(e,t.message?t.message:Object(c.a)("Failed to send request."),t)})}):m(e,Object(c.a)("You need to be logged in."))}(e,a,d,e.data.level);break;default:console.warn("Unhandled postMessage event with action '"+e.data.action+"'")}else m(e,Object(c.a)("Missing user_id in request"));else!function(e,t){const s=""+e.data.event_type,i=Boolean(e.data.is_state),o=n.a.get();if(!o)return void m(e,Object(c.a)("You need to be logged in."));const a=o.getRoom(t);if(!a)return void m(e,Object(c.a)("This room is not recognised."));if("join"!==a.getMyMembership())return void m(e,Object(c.a)("You are not in this room."));const r=o.credentials.userId;let l=!1;l=i?a.currentState.maySendStateEvent(s,r):a.currentState.maySendEvent(s,r),l?h(e,!0):m(e,Object(c.a)("You do not have permission to do that in this room."))}(e,a);else!function(e,t){const s=n.a.get();if(!s)return void m(e,Object(c.a)("You need to be logged in."));if(!s.getRoom(t))return void m(e,Object(c.a)("This room is not recognised."));h(e,n.a.get().isRoomEncrypted(t))}(e,a);else!function(e,t){const s=n.a.get();if(!s)return void m(e,Object(c.a)("You need to be logged in."));const i=s.getRoom(t);if(!i)return void m(e,Object(c.a)("This room is not recognised."));h(e,i.getJoinedMemberCount())}(e,a);else!function(e,t,s){if("string"!=typeof s)throw new Error("Plumbing state status should be a string");console.log(`Received request to set plumbing state to status "${s}" in room ${t}`);const i=n.a.get();i?i.sendStateEvent(t,"m.room.plumbing",{status:s}).then(()=>{h(e,{success:!0})},t=>{m(e,t.message?t.message:Object(c.a)("Failed to send request."),t)}):m(e,Object(c.a)("You need to be logged in."))}(e,a,e.data.status);else!function(e,t){console.log(`join_rules of ${t} requested.`),v(e,t,"m.room.join_rules","")}(e,a);else p(e,a);else g(e,a);else m(e,Object(c.a)("Room %(roomId)s not visible",{roomId:a}))};let b=0,y=null;function _(){0===b&&window.addEventListener("message",f,!1),b+=1}function E(){if(b-=1,0===b&&window.removeEventListener("message",f),b<0){const e=new Error("ScalarMessaging: mismatched startListening / stopListening detected. Negative count");console.error(e)}}function S(e){y=e}},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(92),m=s(95),p=s(96),g=s(103),v=s(93);let f=Object(v.a)("views.dialogs.IntegrationsDisabledDialog")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"_onAcknowledgeClick",()=>{this.props.onFinished()}),r()(this,"_onOpenSettingsClick",()=>{this.props.onFinished(),p.a.fire(g.a.ViewUserSettings)})}render(){const e=m.getComponent("views.dialogs.BaseDialog"),t=m.getComponent("views.elements.DialogButtons");return l.a.createElement(e,{className:"mx_IntegrationsDisabledDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(h.a)("Integrations are disabled")},l.a.createElement("div",{className:"mx_IntegrationsDisabledDialog_content"},l.a.createElement("p",null,Object(h.a)("Enable 'Manage Integrations' in Settings to do this."))),l.a.createElement(t,{primaryButton:Object(h.a)("Settings"),onPrimaryButtonClick:this._onOpenSettingsClick,cancelButton:Object(h.a)("OK"),onCancel:this._onAcknowledgeClick}))}},r()(i,"propTypes",{onFinished:u.a.func.isRequired}),n=o))||n},,function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(124),d=s(100),u=s(158),h=s(93);let m;!function(e){e.Screens="screens",e.Windows="windows"}(m||(m={}));class p extends r.a.Component{constructor(e){super(e),o()(this,"onClick",e=>{this.props.onSelect(this.props.source)})}render(){return r.a.createElement(d.a,{className:"mx_desktopCapturerSourcePicker_stream_button",title:this.props.source.name,onClick:this.onClick},r.a.createElement("img",{className:"mx_desktopCapturerSourcePicker_stream_thumbnail",src:this.props.source.thumbnailURL}),r.a.createElement("span",{className:"mx_desktopCapturerSourcePicker_stream_name"},this.props.source.name))}}let g=Object(h.a)("views.elements.DesktopCapturerSourcePicker")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"interval",void 0),o()(this,"onSelect",e=>{this.props.onFinished(e)}),o()(this,"onScreensClick",e=>{this.setState({selectedTab:m.Screens})}),o()(this,"onWindowsClick",e=>{this.setState({selectedTab:m.Windows})}),o()(this,"onCloseClick",e=>{this.props.onFinished(null)}),this.state={selectedTab:m.Screens,sources:[]}}async componentDidMount(){this.setState({sources:await Object(u.h)()}),this.interval=setInterval(async()=>{this.setState({sources:await Object(u.h)()})},500)}componentWillUnmount(){clearInterval(this.interval)}render(){let e;e=this.state.selectedTab===m.Screens?this.state.sources.filter(e=>e.id.startsWith("screen")).map(e=>r.a.createElement(p,{source:e,onSelect:this.onSelect,key:e.id})):this.state.sources.filter(e=>e.id.startsWith("window")).map(e=>r.a.createElement(p,{source:e,onSelect:this.onSelect,key:e.id}));const t="mx_desktopCapturerSourcePicker_tabLabel",s=t+(this.state.selectedTab===m.Screens?"_selected":""),n=t+(this.state.selectedTab===m.Windows?"_selected":"");return r.a.createElement(l.a,{className:"mx_desktopCapturerSourcePicker",onFinished:this.onCloseClick,title:Object(c.a)("Share your screen")},r.a.createElement("div",{className:"mx_desktopCapturerSourcePicker_tabLabels"},r.a.createElement(d.a,{className:s,onClick:this.onScreensClick},Object(c.a)("Screens")),r.a.createElement(d.a,{className:n,onClick:this.onWindowsClick},Object(c.a)("Windows"))),r.a.createElement("div",{className:"mx_desktopCapturerSourcePicker_panel"},e))}})||n},,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(18),i=s.n(n),o=s(137),a=s(94),r=s(127),c=s(153);class l{constructor(){i()(this,"virtualToNativeRoomIdCache",new Map)}static sharedInstance(){return void 0===window.mxVoipUserMapper&&(window.mxVoipUserMapper=new l),window.mxVoipUserMapper}async userToVirtualUser(e){const t=await c.e.sharedInstance().sipVirtualLookup(e);return 0!==t.length&&t[0].fields.lookup_success?t[0].userid:null}async getOrCreateVirtualRoomForRoom(e){const t=r.a.shared().getUserIdForRoomId(e);if(!t)return null;const s=await this.userToVirtualUser(t);if(!s)return null;const n=await Object(o.d)(a.a.get(),s,e);return a.a.get().setRoomAccountData(n,c.d,{native_room:e}),this.virtualToNativeRoomIdCache.set(n,e),n}nativeRoomForVirtualRoom(e){const t=this.virtualToNativeRoomIdCache.get(e);if(t)return console.log("Returning native room ID "+t+" for virtual room ID "+e+" from cache"),t;const s=a.a.get().getRoom(e);if(!s)return null;const n=s.getAccountData(c.d);if(!n||!n.getContent())return null;const i=n.getContent().native_room,o=a.a.get().getRoom(i);return o&&"join"===o.getMyMembership()?i:null}isVirtualRoom(e){if(this.nativeRoomForVirtualRoom(e.roomId))return!0;if(this.virtualToNativeRoomIdCache.has(e.roomId))return!0;const t=e.currentState.getStateEvents("m.room.create","");if(!t||!t.getContent())return!1;if(t.getSender()!==a.a.get().getUserId())return!1;const s=t.getContent()[c.d];return Boolean(s)}async onNewInvitedRoom(e){if(!c.e.sharedInstance().getSupportsVirtualRooms())return;const t=e.getDMInviter();console.log(`Checking virtual-ness of room ID ${e.roomId}, invited by ${t}`);const s=await c.e.sharedInstance().sipNativeLookup(t);if(0!==s.length&&s[0].fields.is_virtual){const t=s[0].userid,n=Object(o.e)(a.a.get(),t);n&&(a.a.get().setRoomAccountData(e.roomId,c.d,{native_room:n.roomId}),a.a.get().joinRoom(e.roomId)),this.virtualToNativeRoomIdCache.set(e.roomId,n.roomId)}}}},function(e,t,s){"use strict";var n=s(108),i=s.n(n),o=s(91),a=s.n(o),r=s(92),c=s(124),l=s(96),d=s(586),u=s(326),h=s(587),m=s(670),p=s(98),g=s(116),v=s(449);let f;!function(e){e.General="SPACE_GENERAL_TAB",e.Visibility="SPACE_VISIBILITY_TAB",e.Advanced="SPACE_ADVANCED_TAB"}(f||(f={}));t.a=({matrixClient:e,space:t,onFinished:s})=>{Object(d.a)(l.a,e=>{let{action:n}=e,o=i()(e,["action"]);"after_leave_room"===n&&o.room_id===t.roomId&&s(!1)});const n=Object(o.useMemo)(()=>[new u.a(f.General,Object(r.b)("General"),"mx_SpaceSettingsDialog_generalIcon",a.a.createElement(h.a,{matrixClient:e,space:t,onFinished:s})),new u.a(f.Visibility,Object(r.b)("Visibility"),"mx_SpaceSettingsDialog_visibilityIcon",a.a.createElement(m.a,{matrixClient:e,space:t})),p.b.getValue(g.a.AdvancedSettings)?new u.a(f.Advanced,Object(r.b)("Advanced"),"mx_RoomSettingsDialog_warningIcon",a.a.createElement(v.a,{roomId:t.roomId,closeSettingsFn:s})):null].filter(Boolean),[e,t,s]);return a.a.createElement(c.a,{title:Object(r.a)("Space settings"),className:"mx_SpaceSettingsDialog",contentId:"mx_SpaceSettingsDialog",onFinished:s,fixedWidth:!1},a.a.createElement("div",{className:"mx_SpaceSettingsDialog_content",id:"mx_SpaceSettingsDialog",title:Object(r.a)("Settings - %(spaceName)s",{spaceName:t.name})},a.a.createElement(u.b,{tabs:n})))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(91);const i=(e,t)=>{const s=Object(n.useRef)(e=>{});Object(n.useEffect)(()=>{s.current=t},[t]),Object(n.useEffect)(()=>{const t=e.register(e=>s.current(e));return()=>{e.unregister(t)}},[e])}},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(110),a=s(92),r=s(100),c=s(295),l=s(448),d=s(194),u=s(329),h=s(96);t.a=({matrixClient:e,space:t,onFinished:s})=>{const[m,p]=Object(n.useState)(!1),[g,v]=Object(n.useState)(""),f=e.getUserId(),[b,y]=Object(n.useState)(null),_=t.currentState.maySendStateEvent(o.a.RoomAvatar,f),E=null!==b,[S,w]=Object(n.useState)(t.name),C=t.currentState.maySendStateEvent(o.a.RoomName,f),k=S!==t.name,O=Object(u.b)(t),[R,I]=Object(n.useState)(O),x=t.currentState.maySendStateEvent(o.a.RoomTopic,f),T=R!==O;return i.a.createElement("div",{className:"mx_SettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(a.a)("General")),i.a.createElement("div",null,Object(a.a)("Edit settings relating to your space.")),g&&i.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},g),i.a.createElement(c.a,{onClick:()=>s(!1)}),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement(l.b,{avatarUrl:Object(d.b)(t,80,80,"crop"),avatarDisabled:m||!_,setAvatar:y,name:S,nameDisabled:m||!C,setName:w,topic:R,topicDisabled:m||!x,setTopic:I}),i.a.createElement(r.a,{onClick:()=>{y(null),w(t.name),I(O)},disabled:m||!(E||k||T),kind:"link"},Object(a.a)("Cancel")),i.a.createElement(r.a,{onClick:async()=>{p(!0);const s=[];E&&(b?s.push(e.sendStateEvent(t.roomId,o.a.RoomAvatar,{url:await e.uploadContent(b)},"")):s.push(e.sendStateEvent(t.roomId,o.a.RoomAvatar,{},""))),k&&s.push(e.setRoomName(t.roomId,S)),T&&s.push(e.setRoomTopic(t.roomId,R));const n=await Promise.allSettled(s);p(!1);const i=n.filter(e=>"rejected"===e.status);i.length>0&&(console.error("Failed to save space settings: ",i),v(Object(a.a)("Failed to save space settings.")))},disabled:m,kind:"primary"},m?Object(a.a)("Saving..."):Object(a.a)("Save Changes"))),i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(a.a)("Leave Space")),i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},i.a.createElement(r.a,{kind:"danger",onClick:()=>{h.b.dispatch({action:"leave_room",room_id:t.roomId})}},Object(a.a)("Leave Space"))))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(96),u=s(100),h=s(589),m=s(171),p=s(92),g=s(150),v=s(93),f=s(105),b=s(162),y=s(113);let _=Object(v.a)("views.rooms.PinnedEventTile")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"onTileClicked",()=>{d.a.dispatch({action:"view_room",event_id:this.props.event.getId(),highlighted:!0,room_id:this.props.event.getRoomId()})})}render(){const e=this.props.event.getSender(),t=this.props.room.getMember(e);let s=null;return this.props.onUnpinClicked&&(s=l.a.createElement(y.a,{onClick:this.props.onUnpinClicked,className:"mx_PinnedEventTile_unpinButton",title:Object(p.a)("Unpin")})),l.a.createElement("div",{className:"mx_PinnedEventTile"},l.a.createElement(m.a,{className:"mx_PinnedEventTile_senderAvatar",member:t,width:24,height:24,fallbackUserId:e}),l.a.createElement("span",{className:"mx_PinnedEventTile_sender "+Object(b.f)(e)},(null==t?void 0:t.name)||e),s,l.a.createElement("div",{className:"mx_PinnedEventTile_message"},l.a.createElement(h.a,{mxEvent:this.props.event,className:"mx_PinnedEventTile_body",maxImageHeight:150,onHeightChanged:()=>{}})),l.a.createElement("div",{className:"mx_PinnedEventTile_footer"},l.a.createElement("span",{className:"mx_PinnedEventTile_timestamp"},Object(g.a)(new Date(this.props.event.getTs()))),l.a.createElement(u.a,{onClick:this.onTileClicked,kind:"link"},Object(p.a)("View message"))))}},r()(i,"contextType",f.a),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(95),m=s(98),p=s(409),g=s(410),v=s(590),f=s(93);let b=Object(f.a)("views.messages.MessageEvent")((o=i=class extends l.a.Component{constructor(e){super(e),r()(this,"getEventTileOps",()=>this._body.current&&this._body.current.getEventTileOps?this._body.current.getEventTileOps():null),r()(this,"onTileUpdate",()=>{this.forceUpdate()}),this._body=Object(c.createRef)()}render(){const e={"m.text":h.getComponent("messages.TextualBody"),"m.notice":h.getComponent("messages.TextualBody"),"m.emote":h.getComponent("messages.TextualBody"),"m.image":h.getComponent("messages.MImageBody"),"m.file":h.getComponent("messages.MFileBody"),"m.audio":h.getComponent("messages.MVoiceOrAudioBody"),"m.video":h.getComponent("messages.MVideoBody")},t={"m.sticker":h.getComponent("messages.MStickerBody")},s=this.props.mxEvent.getContent(),n=this.props.mxEvent.getType(),i=s.msgtype;let o=g.a;if(this.props.mxEvent.isRedacted()||(o=n&&t[n]?t[n]:i&&e[i]?e[i]:s.url?e["m.file"]:v.a),m.b.getValue("feature_mjolnir")){const e=`mx_mjolnir_render_${this.props.mxEvent.getRoomId()}__${this.props.mxEvent.getId()}`;if(!("true"===localStorage.getItem(e))){const e=this.props.mxEvent.getSender().split(":").slice(1).join(":"),t=p.a.sharedInstance().isUserBanned(this.props.mxEvent.getSender()),s=p.a.sharedInstance().isServerBanned(e);(t||s)&&(o=h.getComponent("messages.MjolnirBody"))}}return l.a.createElement(o,{ref:this._body,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,tileShape:this.props.tileShape,maxImageHeight:this.props.maxImageHeight,replacingEventId:this.props.replacingEventId,editState:this.props.editState,onHeightChanged:this.props.onHeightChanged,onMessageAllowed:this.onTileUpdate,permalinkCreator:this.props.permalinkCreator,scBubble:this.props.scBubble,scBubbleGroupTimestamp:this.props.scBubbleGroupTimestamp,scBubbleActionBar:this.props.scBubbleActionBar})}},r()(i,"propTypes",{mxEvent:u.a.object.isRequired,highlights:u.a.array,highlightLink:u.a.string,showUrlPreview:u.a.bool,onHeightChanged:u.a.func,tileShape:u.a.string,maxImageHeight:u.a.number,permalinkCreator:u.a.object,scBubble:u.a.bool,scBubbleGroupTimestamp:u.a.object,scBubbleActionBar:u.a.object}),n=o))||n},function(e,t,s){"use strict";var n=s(91),i=s.n(n);t.a=Object(n.forwardRef)(({mxEvent:e},t)=>{const s=e.getContent().body;return i.a.createElement("span",{className:"mx_UnknownBody",ref:t},s)})},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(101),a=s.n(o),r=s(114),c=s(92),l=s(96),d=s(327),u=s(116),h=s(155),m=s(124),p=s(194),g=s(195),v=s(281),f=s(259),b=s(185),y=s(113),_=s(125),E=s(247),S=s(180),w=s(360),C=s(220),k=s(328),O=s(282),R=s(130);var I;!function(e){e[e.CanSend=0]="CanSend",e[e.Sending=1]="Sending",e[e.Sent=2]="Sent",e[e.Failed=3]="Failed"}(I||(I={}));const x=({room:e,event:t,matrixClient:s,onFinished:o})=>{const[a,r]=Object(n.useState)(I.CanSend);let d,u,h,m=!1;return a===I.CanSend?(d="mx_ForwardList_canSend",e.maySendMessage()?u=Object(c.a)("Send"):(m=!0,u=Object(c.a)("You don't have permission to do this"))):a===I.Sending?(d="mx_ForwardList_sending",m=!0,u=Object(c.a)("Sending"),h=i.a.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":u})):a===I.Sent?(d="mx_ForwardList_sent",m=!0,u=Object(c.a)("Sent"),h=i.a.createElement("div",{className:"mx_ForwardList_sendIcon","aria-label":u})):(d="mx_ForwardList_sendFailed",m=!0,u=Object(c.a)("Failed to send"),h=i.a.createElement(S.a,{notification:E.a.RED_EXCLAMATION})),i.a.createElement("div",{className:"mx_ForwardList_entry"},i.a.createElement(y.a,{className:"mx_ForwardList_roomButton",onClick:()=>{l.a.dispatch({action:"view_room",room_id:e.roomId}),o(!0)},title:Object(c.a)("Open link"),yOffset:-20,alignment:b.a.Top},i.a.createElement(f.a,{room:e,avatarSize:32}),i.a.createElement("span",{className:"mx_ForwardList_entry_name"},e.name)),i.a.createElement(y.a,{kind:a===I.Failed?"danger_outline":"primary_outline",className:"mx_ForwardList_sendButton "+d,onClick:async()=>{r(I.Sending);try{await s.sendEvent(e.roomId,t.getType(),t.getContent()),r(I.Sent)}catch(e){r(I.Failed)}},disabled:m,title:u,yOffset:-20,alignment:b.a.Top},i.a.createElement("div",{className:"mx_ForwardList_sendLabel"},Object(c.a)("Send")),h))};t.a=({matrixClient:e,event:t,permalinkCreator:o,onFinished:l})=>{const f=e.getUserId(),[b,y]=Object(n.useState)({});Object(n.useEffect)(()=>{e.getProfileInfo(f).then(e=>y(e))},[e,f]);const E=new r.b({type:"m.room.message",sender:f,content:t.getContent(),unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:t.getRoomId()});E.sender={name:b.displayname||f,rawDisplayName:b.displayname,userId:f,getAvatarUrl:(...e)=>Object(p.c)({avatarUrl:b.avatar_url},30,30,"crop"),getMxcAvatarUrl:()=>b.avatar_url};const[S,I]=Object(n.useState)(""),T=S.toLowerCase(),j=Object(d.a)("feature_spaces"),N=Object(d.a)(u.a.Flair),P=Object(d.b)("layout");let D=Object(n.useMemo)(()=>Object(w.b)(e.getVisibleRooms().filter(e=>"join"===e.getMyMembership()&&!(j&&e.isSpaceRoom()))),[e,j]);T&&(D=new C.a(D,{keys:["name"],funcs:[e=>[e.getCanonicalAlias(),...e.getAltAliases()].filter(Boolean)],shouldMatchWordsOnly:!1}).match(T));const[A,M]=Object(n.useState)(20);return i.a.createElement(m.a,{title:Object(c.a)("Forward message"),className:"mx_ForwardDialog",contentId:"mx_ForwardList",onFinished:l,fixedWidth:!1},i.a.createElement("h3",null,Object(c.a)("Message preview")),i.a.createElement("div",{className:a()("mx_ForwardDialog_preview",{mx_IRCLayout:P==h.a.IRC,mx_GroupLayout:P==h.a.Group,sc_BubbleLayout:P==h.a.Bubble})},i.a.createElement(g.a,{mxEvent:E,layout:P,enableFlair:N,permalinkCreator:o,as:"div"})),i.a.createElement("hr",null),i.a.createElement("div",{className:"mx_ForwardList",id:"mx_ForwardList"},i.a.createElement(v.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:Object(c.a)("Search for rooms or people"),onSearch:I,autoComplete:!0,autoFocus:!0}),i.a.createElement(_.a,{className:"mx_ForwardList_content"},D.length>0?i.a.createElement("div",{className:"mx_ForwardList_results"},i.a.createElement(k.a,{truncateAt:A,createOverflowElement:function(e,t){const n=Object(c.a)("and %(count)s others...",{count:e});return i.a.createElement(O.b,{className:"mx_EntityTile_ellipsis",avatarJsx:i.a.createElement(R.a,{url:s(283),name:"...",width:36,height:36}),name:n,presenceState:"online",suppressOnHover:!0,onClick:()=>M(t)})},getChildren:(s,n)=>D.slice(s,n).map(s=>i.a.createElement(x,{key:s.roomId,room:s,event:t,matrixClient:e,onFinished:l})),getChildCount:()=>D.length})):i.a.createElement("span",{className:"mx_ForwardList_noResults"},Object(c.a)("No results")))))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n,i=s(91),o=s.n(i),a=s(150),r=s(93);let c=Object(r.a)("views.messages.MessageTimestamp")(n=class extends o.a.Component{render(){const e=new Date(this.props.ts);let t;return t=this.props.showFullDate?Object(a.b)(e,this.props.showTwelveHour,this.props.showSeconds):this.props.showSeconds?Object(a.d)(e,this.props.showTwelveHour):Object(a.e)(e,this.props.showTwelveHour),o.a.createElement("span",{className:"mx_MessageTimestamp",title:Object(a.b)(e,this.props.showTwelveHour),"aria-hidden":!0},t)}})||n},function(e,t,s){"use strict";s.d(t,"c",(function(){return p})),s.d(t,"a",(function(){return g})),s.d(t,"d",(function(){return v})),s.d(t,"b",(function(){return f}));var n=s(94),i=s(96),o=s(99),a=s(95),r=s(126),c=s(137),l=s(181),d=s(312),u=s(103),h=s(595);async function m(){const e=n.a.get();if(!e.isCryptoEnabled())return!1;return!!e.getCrossSigningId("user_signing")||(await Object(l.b)(),!1)}async function p(e,t){const s=n.a.get();s.isGuest()?i.a.dispatch({action:"require_registration"}):s.getCryptoTrustCrossSignedDevices()&&!await m()||o.a.createTrackedDialog("Verification warning","unverified session",h.a,{user:e,device:t,onFinished:async n=>{if("sas"===n){const n=s.legacyDeviceVerification(e.userId,t.deviceId,d.d.SAS);i.a.dispatch({action:u.a.SetRightPanelPhase,phase:r.c.EncryptionPanel,refireParams:{member:e,verificationRequestPromise:n}})}else if("legacy"===n){const s=a.getComponent("dialogs.ManualDeviceKeyVerificationDialog");o.a.createTrackedDialog("Legacy verify session","legacy verify session",s,{userId:e.userId,device:t})}}})}async function g(e){const t=n.a.get();if(t.isGuest())return void i.a.dispatch({action:"require_registration"});if(t.getCryptoTrustCrossSignedDevices()&&!await m())return;const s=t.requestVerification(e.userId);i.a.dispatch({action:u.a.SetRightPanelPhase,phase:r.c.EncryptionPanel,refireParams:{member:e,verificationRequestPromise:s}})}async function v(e){if(n.a.get().isGuest())return void i.a.dispatch({action:"require_registration"});if(!await m())return;const t=f(e);i.a.dispatch({action:u.a.SetRightPanelPhase,phase:r.c.EncryptionPanel,refireParams:{member:e,verificationRequest:t}})}function f(e){const t=n.a.get(),s=Object(c.e)(t,e.userId);if(s)return t.findVerificationRequestDMInProgress(s.roomId)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(18),i=s.n(n),o=s(117),a=s(101),r=s.n(a),c=s(91),l=s.n(c),d=s(95),u=s(94),h=s(112),m=s(100),p=s(92),g=s(181),v=s(99);class f extends l.a.PureComponent{constructor(e){super(e),i()(this,"fileUpload",l.a.createRef()),i()(this,"onCancel",()=>{this.state.resetting&&this.setState({resetting:!1}),this.props.onFinished(!1)}),i()(this,"onUseRecoveryKeyClick",()=>{this.setState({forceRecoveryKey:!0})}),i()(this,"validateRecoveryKeyOnChange",Object(o.debounce)(async()=>{await this.validateRecoveryKey()},200)),i()(this,"onRecoveryKeyChange",e=>{this.setState({recoveryKey:e.target.value,recoveryKeyFileError:null}),this.fileUpload.current&&(this.fileUpload.current.value=null),this.validateRecoveryKeyOnChange()}),i()(this,"onRecoveryKeyFileChange",async e=>{if(0===e.target.files.length)return;const t=e.target.files[0];if(t.size>128)this.setState({recoveryKeyFileError:!0,recoveryKeyCorrect:!1,recoveryKeyValid:!1});else{const e=await t.text();/^[123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz\s]+$/.test(e)?(this.setState({recoveryKeyFileError:null,recoveryKey:e.trim()}),await this.validateRecoveryKey()):this.setState({recoveryKeyFileError:!0,recoveryKeyCorrect:!1,recoveryKeyValid:!1,recoveryKey:""})}}),i()(this,"onRecoveryKeyFileUploadClick",()=>{this.fileUpload.current.click()}),i()(this,"onPassPhraseNext",async e=>{if(e.preventDefault(),this.state.passPhrase.length<=0)return;this.setState({keyMatches:null});const t={passphrase:this.state.passPhrase},s=await this.props.checkPrivateKey(t);s?this.props.onFinished(t):this.setState({keyMatches:s})}),i()(this,"onRecoveryKeyNext",async e=>{if(e.preventDefault(),!this.state.recoveryKeyValid)return;this.setState({keyMatches:null});const t={recoveryKey:this.state.recoveryKey},s=await this.props.checkPrivateKey(t);s?this.props.onFinished(t):this.setState({keyMatches:s})}),i()(this,"onPassPhraseChange",e=>{this.setState({passPhrase:e.target.value,keyMatches:null})}),i()(this,"onResetAllClick",e=>{e.preventDefault(),this.setState({resetting:!0})}),i()(this,"onConfirmResetAllClick",async()=>{v.a.toggleCurrentDialogVisibility();try{await Object(g.b)(async()=>{const e=u.a.get();await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const s=d.getComponent("views.dialogs.InteractiveAuthDialog"),{finished:n}=v.a.createTrackedDialog("Cross-signing keys dialog","",s,{title:Object(p.a)("Setting up keys"),matrixClient:e,makeRequest:t}),[i]=await n;if(!i)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:!0}),this.props.onFinished(!0)},!0)}catch(e){console.error(e),this.props.onFinished(!1)}}),this.state={recoveryKey:"",recoveryKeyValid:null,recoveryKeyCorrect:null,recoveryKeyFileError:null,forceRecoveryKey:!1,passPhrase:"",keyMatches:null,resetting:!1}}async validateRecoveryKey(){if(""!==this.state.recoveryKey)try{const e=u.a.get(),t=e.keyBackupKeyFromRecoveryKey(this.state.recoveryKey),s=await e.checkSecretStorageKey(t,this.props.keyInfo);this.setState({recoveryKeyValid:!0,recoveryKeyCorrect:s})}catch(e){this.setState({recoveryKeyValid:!1,recoveryKeyCorrect:!1})}else this.setState({recoveryKeyValid:null,recoveryKeyCorrect:null})}getKeyValidationText(){return this.state.recoveryKeyFileError?Object(p.a)("Wrong file type"):this.state.recoveryKeyCorrect?Object(p.a)("Looks good!"):this.state.recoveryKeyValid?Object(p.a)("Wrong Security Key"):null===this.state.recoveryKeyValid?"":Object(p.a)("Invalid Security Key")}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=this.props.keyInfo&&this.props.keyInfo.passphrase&&this.props.keyInfo.passphrase.salt&&this.props.keyInfo.passphrase.iterations,n=l.a.createElement("div",{className:"mx_AccessSecretStorageDialog_reset"},Object(p.a)("Forgotten or lost all recovery methods? <a>Reset all</a>",null,{a:e=>l.a.createElement("a",{href:"",onClick:this.onResetAllClick,className:"mx_AccessSecretStorageDialog_reset_link"},e)}));let i,o,a;if(this.state.resetting)o=Object(p.a)("Reset everything"),a=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_resetBadge"],i=l.a.createElement("div",null,l.a.createElement("p",null,Object(p.a)("Only do this if you have no other device to complete verification with.")),l.a.createElement("p",null,Object(p.a)("If you reset everything, you will restart with no trusted sessions, no trusted users, and might not be able to see past messages.")),l.a.createElement(t,{primaryButton:Object(p.a)("Reset"),onPrimaryButtonClick:this.onConfirmResetAllClick,hasCancel:!0,onCancel:this.onCancel,focus:!1,primaryButtonClass:"danger"}));else if(s&&!this.state.forceRecoveryKey){const e=d.getComponent("elements.AccessibleButton");let s;o=Object(p.a)("Security Phrase"),a=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_securePhraseTitle"],s=!1===this.state.keyMatches?l.a.createElement("div",{className:"mx_AccessSecretStorageDialog_keyStatus"},"👎 ",Object(p.a)("Unable to access secret storage. Please verify that you entered the correct Security Phrase.")):l.a.createElement("div",{className:"mx_AccessSecretStorageDialog_keyStatus"}),i=l.a.createElement("div",null,l.a.createElement("p",null,Object(p.a)("Enter your Security Phrase or <button>Use your Security Key</button> to continue.",{},{button:t=>l.a.createElement(e,{className:"mx_linkButton",element:"span",onClick:this.onUseRecoveryKeyClick},t)})),l.a.createElement("form",{className:"mx_AccessSecretStorageDialog_primaryContainer",onSubmit:this.onPassPhraseNext},l.a.createElement("input",{type:"password",id:"mx_passPhraseInput",className:"mx_AccessSecretStorageDialog_passPhraseInput",onChange:this.onPassPhraseChange,value:this.state.passPhrase,autoFocus:!0,autoComplete:"new-password",placeholder:Object(p.a)("Security Phrase")}),s,l.a.createElement(t,{primaryButton:Object(p.a)("Continue"),onPrimaryButtonClick:this.onPassPhraseNext,hasCancel:!0,onCancel:this.onCancel,focus:!1,primaryDisabled:0===this.state.passPhrase.length,additive:n})))}else{o=Object(p.a)("Security Key"),a=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_secureBackupTitle"];const e=r()({mx_AccessSecretStorageDialog_recoveryKeyFeedback:!0,mx_AccessSecretStorageDialog_recoveryKeyFeedback_valid:!0===this.state.recoveryKeyCorrect,mx_AccessSecretStorageDialog_recoveryKeyFeedback_invalid:!1===this.state.recoveryKeyCorrect}),s=l.a.createElement("div",{className:e},this.getKeyValidationText());i=l.a.createElement("div",null,l.a.createElement("p",null,Object(p.a)("Use your Security Key to continue.")),l.a.createElement("form",{className:"mx_AccessSecretStorageDialog_primaryContainer",onSubmit:this.onRecoveryKeyNext,spellCheck:!1,autoComplete:"off"},l.a.createElement("div",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry"},l.a.createElement("div",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_textInput"},l.a.createElement(h.a,{type:"password",label:Object(p.a)("Security Key"),value:this.state.recoveryKey,onChange:this.onRecoveryKeyChange,forceValidity:this.state.recoveryKeyCorrect,autoComplete:"off"})),l.a.createElement("span",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_entryControlSeparatorText"},Object(p.a)("or")),l.a.createElement("div",null,l.a.createElement("input",{type:"file",className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_fileInput",ref:this.fileUpload,onChange:this.onRecoveryKeyFileChange}),l.a.createElement(m.a,{kind:"primary",onClick:this.onRecoveryKeyFileUploadClick},Object(p.a)("Upload")))),s,l.a.createElement(t,{primaryButton:Object(p.a)("Continue"),onPrimaryButtonClick:this.onRecoveryKeyNext,hasCancel:!0,cancelButton:Object(p.a)("Go Back"),cancelButtonClass:"danger",onCancel:this.onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid,additive:n})))}return l.a.createElement(e,{className:"mx_AccessSecretStorageDialog",onFinished:this.props.onFinished,title:o,titleClass:a},l.a.createElement("div",null,i))}}},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(92),a=s(94),r=s(206),c=s(100),l=s(124);t.a=({device:e,user:t,onFinished:s})=>{let n,d;return a.a.get().getUserId()===t.userId?(d=Object(o.a)("You signed in to a new session without verifying it:"),n=Object(o.a)("Verify your other session using one of the options below.")):(d=Object(o.a)("%(name)s (%(userId)s) signed in to a new session without verifying it:",{name:t.displayName,userId:t.userId}),n=Object(o.a)("Ask this user to verify their session, or manually verify it below.")),i.a.createElement(l.a,{onFinished:s,className:"mx_UntrustedDeviceDialog",title:i.a.createElement(i.a.Fragment,null,i.a.createElement(r.b,{status:"warning",size:24,hideTooltip:!0}),Object(o.a)("Not Trusted"))},i.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},i.a.createElement("p",null,d),i.a.createElement("p",null,e.getDisplayName()," (",e.deviceId,")"),i.a.createElement("p",null,n)),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement(c.a,{element:"button",kind:"secondary",onClick:()=>s("legacy")},Object(o.a)("Manually Verify by Text")),i.a.createElement(c.a,{element:"button",kind:"secondary",onClick:()=>s("sas")},Object(o.a)("Interactively verify by Emoji")),i.a.createElement(c.a,{kind:"primary",onClick:()=>s(!1)},Object(o.a)("Done"))))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(91),i=s(131);function o(e,t){const[s,o]=Object(n.useState)(t?e.isRoomEncrypted(t.roomId):void 0),a=Object(n.useCallback)(s=>{t&&"m.room.encryption"===s.getType()&&o(e.isRoomEncrypted(t.roomId))},[e,t]);return Object(i.a)(t?t.currentState:void 0,"RoomState.events",a),s}},,,,,function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(105),a=s(204),r=s(140),c=s(285),l=s(92),d=s(414),u=s(126),h=s(96),m=s(103),p=s(109),g=s(352),v=s(190),f=s(154);t.a=({room:e,widgetId:t,onClose:s})=>{const b=Object(n.useContext)(o.a),y=Object(d.b)(e).find(e=>e.id===t),_=y&&v.d.instance.isInContainer(e,y,v.a.Top),[E,S,w,C]=Object(p.q)();if(Object(n.useEffect)(()=>{y&&!_||h.a.dispatch({action:m.a.SetRightPanelPhase,phase:u.c.RoomSummary})},[y,_]),!y||_)return null;let k;if(E){const e=S.current.getBoundingClientRect();k=i.a.createElement(g.a,{chevronFace:p.a.None,right:f.b.instance.windowWidth-e.right-12,top:e.bottom+12,onFinished:C,app:y})}const O=i.a.createElement(i.a.Fragment,null,i.a.createElement("h2",null,r.a.getWidgetName(y)),i.a.createElement(p.c,{kind:"secondary",className:"mx_WidgetCard_optionsButton",inputRef:S,onClick:w,isExpanded:E,label:Object(l.a)("Options")}),k);return i.a.createElement(a.b,{header:O,className:"mx_WidgetCard",onClose:s,previousPhase:u.c.RoomSummary,withoutScrollContainer:!0},i.a.createElement(c.a,{app:y,fullWidth:!0,show:!0,showMenubar:!1,room:e,userId:b.getUserId(),creatorUserId:y.creatorUserId,widgetPageTitle:r.a.getWidgetDataTitle(y),waitForIframeLoad:y.waitForIframeLoad}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(136),m=s.n(h),p=s(95),g=s(92),v=s(102),f=s(140),b=s(94),y=s(93);function _(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function E(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?_(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):_(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let S=Object(y.a)("views.elements.AppPermission")((o=i=class extends l.a.Component{constructor(e){super(e);const t=this.parseWidgetUrl(),s=b.a.get().getRoom(this.props.roomId);let n;s&&(n=s.getMember(this.props.creatorUserId)),this.state=E(E({},t),{},{roomMember:n})}parseWidgetUrl(){const e=m.a.parse(this.props.url),t=new URLSearchParams(e.search);if(f.a.isScalarUrl(e)&&t&&t.get("url")){const e=m.a.parse(t.get("url"));return{widgetDomain:e.host||e.hostname,isWrapped:!0}}return{widgetDomain:e.host||e.hostname,isWrapped:!1}}render(){const e=v.a.get().brand,t=p.getComponent("views.elements.AccessibleButton"),s=p.getComponent("views.avatars.MemberAvatar"),n=p.getComponent("views.avatars.BaseAvatar"),i=p.getComponent("views.elements.TextWithTooltip"),o=this.state.roomMember?this.state.roomMember.name:this.props.creatorUserId,a=o===this.props.creatorUserId?null:this.props.creatorUserId,r=this.state.roomMember?l.a.createElement(s,{member:this.state.roomMember,width:38,height:38}):l.a.createElement(n,{name:this.props.creatorUserId,width:38,height:38}),c=l.a.createElement("div",null,Object(g.a)("Any of the following data may be shared:"),l.a.createElement("ul",null,l.a.createElement("li",null,Object(g.a)("Your display name")),l.a.createElement("li",null,Object(g.a)("Your avatar URL")),l.a.createElement("li",null,Object(g.a)("Your user ID")),l.a.createElement("li",null,Object(g.a)("Your theme")),l.a.createElement("li",null,Object(g.a)("%(brand)s URL",{brand:e})),l.a.createElement("li",null,Object(g.a)("Room ID")),l.a.createElement("li",null,Object(g.a)("Widget ID")))),d=l.a.createElement(i,{tooltip:c,tooltipClass:"mx_AppPermissionWarning_tooltip mx_Tooltip_dark"},l.a.createElement("span",{className:"mx_AppPermissionWarning_helpIcon"})),u=this.state.isWrapped?Object(g.a)("Using this widget may share data <helpIcon /> with %(widgetDomain)s & your Integration Manager.",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>d}):Object(g.a)("Using this widget may share data <helpIcon /> with %(widgetDomain)s.",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>d}),h=this.props.isRoomEncrypted?Object(g.a)("Widgets do not use message encryption."):null;return l.a.createElement("div",{className:"mx_AppPermissionWarning"},l.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_bolder mx_AppPermissionWarning_smallText"},Object(g.a)("Widget added by")),l.a.createElement("div",{className:"mx_AppPermissionWarning_row"},r,l.a.createElement("h4",{className:"mx_AppPermissionWarning_bolder"},o),l.a.createElement("div",{className:"mx_AppPermissionWarning_smallText"},a)),l.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"},u),l.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"},Object(g.a)("This widget may use cookies.")," ",h),l.a.createElement("div",{className:"mx_AppPermissionWarning_row"},l.a.createElement(t,{kind:"primary_sm",onClick:this.props.onPermissionGranted},Object(g.a)("Continue"))))}},r()(i,"propTypes",{url:u.a.string.isRequired,creatorUserId:u.a.string.isRequired,roomId:u.a.string.isRequired,onPermissionGranted:u.a.func.isRequired,isRoomEncrypted:u.a.bool}),r()(i,"defaultProps",{onPermissionGranted:()=>{}}),n=o))||n},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(97);const a=e=>i.a.createElement("div",{className:"mx_AppPermissionWarning"},i.a.createElement("div",{className:"mx_AppPermissionWarningImage"},i.a.createElement("img",{src:s(224),alt:""})),i.a.createElement("div",{className:"mx_AppPermissionWarningText"},i.a.createElement("span",{className:"mx_AppPermissionWarningTextLabel"},e.errorMsg)));a.propTypes={errorMsg:s.n(o).a.string},a.defaultProps={errorMsg:"Error"},t.a=a},function(e,t,s){"use strict";var n=s(18),i=s.n(n),o=s(133);class a{constructor(){i()(this,"listeners",{}),i()(this,"_activeRoomId",o.a.getRoomId()),i()(this,"roomStoreToken",void 0),i()(this,"onRoomViewStoreUpdate",()=>{this._activeRoomId&&this.emit(this._activeRoomId,!1),this._activeRoomId=o.a.getRoomId(),this._activeRoomId&&this.emit(this._activeRoomId,!0)}),this.roomStoreToken=o.a.addListener(this.onRoomViewStoreUpdate)}get activeRoomId(){return this._activeRoomId}addListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}removeListener(e,t){if(this.listeners[e]){const s=this.listeners[e].indexOf(t);s>-1&&this.listeners[e].splice(s,1)}else console.warn("Unregistering unrecognised listener (roomId="+e+")")}emit(e,t){if(this.listeners[e])for(const s of this.listeners[e])s.call(null,t)}}void 0===window.mxActiveRoomObserver&&(window.mxActiveRoomObserver=new a),t.a=window.mxActiveRoomObserver},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(92),m=s(95),p=s(173),g=s(138),v=s(606),f=s(93);let b=Object(f.a)("views.dialogs.WidgetOpenIDPermissionsDialog")((o=i=class extends l.a.Component{constructor(){super(),r()(this,"_onAllow",()=>{this._onPermissionSelection(!0)}),r()(this,"_onDeny",()=>{this._onPermissionSelection(!1)}),r()(this,"_onRememberSelectionChange",e=>{this.setState({rememberSelection:e})}),this.state={rememberSelection:!1}}_onPermissionSelection(e){this.state.rememberSelection&&(console.log(`Remembering ${this.props.widgetId} as allowed=${e} for OpenID`),v.b.instance.setOIDCState(this.props.widget,this.props.widgetKind,this.props.inRoomId,e?v.a.Allowed:v.a.Denied)),this.props.onFinished(e)}render(){const e=m.getComponent("views.dialogs.BaseDialog"),t=m.getComponent("views.elements.DialogButtons");return l.a.createElement(e,{className:"mx_WidgetOpenIDPermissionsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(h.a)("Allow this widget to verify your identity")},l.a.createElement("div",{className:"mx_WidgetOpenIDPermissionsDialog_content"},l.a.createElement("p",null,Object(h.a)("The widget will verify your user ID, but won't be able to perform actions for you:")),l.a.createElement("p",{className:"text-muted"},this.props.widget.templateUrl.split("?")[0].split("#")[0])),l.a.createElement(t,{primaryButton:Object(h.a)("Continue"),onPrimaryButtonClick:this._onAllow,onCancel:this._onDeny,additive:l.a.createElement(p.a,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this._onRememberSelectionChange,label:Object(h.a)("Remember this")})}))}},r()(i,"propTypes",{onFinished:u.a.func.isRequired,widget:u.a.objectOf(g.Widget).isRequired,widgetKind:u.a.string.isRequired,inRoomId:u.a.string}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return d}));var n=s(18),i=s.n(n),o=s(98),a=s(138),r=s(94),c=s(106);let l;!function(e){e[e.Allowed=0]="Allowed",e[e.Denied=1]="Denied",e[e.Unknown=2]="Unknown"}(l||(l={}));class d{constructor(){}static get instance(){return d.internalInstance||(d.internalInstance=new d),d.internalInstance}packSettingKey(e,t,s){let n=s;if(t!==a.WidgetKind.Room&&(n=r.a.get().getUserId()),t===a.WidgetKind.Modal&&(n="*MODAL*-"+n),!n)throw new Error("Failed to determine a location to check the widget's OIDC state with");return encodeURIComponent(`${n}::${e.templateUrl}`)}getOIDCState(e,t,s){var n,i;const a=this.packSettingKey(e,t,s),r=o.b.getValue("widgetOpenIDPermissions");return null!=r&&null!==(n=r.deny)&&void 0!==n&&n.includes(a)?l.Denied:null!=r&&null!==(i=r.allow)&&void 0!==i&&i.includes(a)?l.Allowed:l.Unknown}setOIDCState(e,t,s,n){const i=this.packSettingKey(e,t,s),a=o.b.getValue("widgetOpenIDPermissions");a.allow||(a.allow=[]),a.deny||(a.deny=[]),n===l.Allowed?a.allow.push(i):n===l.Denied?a.deny.push(i):(a.allow=a.allow.filter(e=>e!==i),a.deny=a.deny.filter(e=>e!==i)),o.b.setValue("widgetOpenIDPermissions",null,c.a.DEVICE,a)}}i()(d,"internalInstance",void 0)},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.CanChangeViewedRoom="io.element.view_room"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i=s(18),o=s.n(i),a=s(91),r=s(124),c=s(92),l=s(100),d=s(138),u=s(743),h=s(94),m=s(212),p=s(121),g=s(747),v=s(93),f=s(609),b=s(98);function y(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function _(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?y(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):y(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let E=Object(v.a)("views.dialogs.ModalWidgetDialog")(n=class extends a.PureComponent{constructor(e){super(e),o()(this,"widget",void 0),o()(this,"possibleButtons",void 0),o()(this,"appFrame",a.createRef()),o()(this,"state",{disabledButtonIds:(this.props.widgetDefinition.buttons||[]).filter(e=>e.disabled).map(e=>e.id)}),o()(this,"onReady",()=>{this.state.messaging.sendWidgetConfig(this.props.widgetDefinition)}),o()(this,"onLoad",()=>{this.state.messaging.once("ready",this.onReady),this.state.messaging.on("action:"+d.WidgetApiFromWidgetAction.CloseModalWidget,this.onWidgetClose),this.state.messaging.on("action:"+d.WidgetApiFromWidgetAction.SetModalButtonEnabled,this.onButtonEnableToggle)}),o()(this,"onWidgetClose",e=>{this.props.onFinished(!0,e.detail.data)}),o()(this,"onButtonEnableToggle",e=>{e.preventDefault();if(e.detail.data.button===d.BuiltInModalButtonID.Close||!this.possibleButtons.includes(e.detail.data.button))return this.state.messaging.transport.reply(e.detail,{error:{message:"Invalid button"}});let t;if(e.detail.data.enabled)t=Object(p.b)(this.state.disabledButtonIds).filter(t=>t!==e.detail.data.button);else{const s=new Set(this.state.disabledButtonIds);s.add(e.detail.data.button),t=Array.from(s)}this.setState({disabledButtonIds:t}),this.state.messaging.transport.reply(e.detail,{})}),this.widget=new g.a(_(_({},this.props.widgetDefinition),{},{creatorUserId:h.a.get().getUserId(),id:"modal_"+this.props.sourceWidgetId})),this.possibleButtons=(this.props.widgetDefinition.buttons||[]).map(e=>e.id)}componentDidMount(){const e=new u.a([],this.widget,d.WidgetKind.Modal),t=new d.ClientWidgetApi(this.widget,this.appFrame.current,e);this.setState({messaging:t})}componentWillUnmount(){this.state.messaging.off("ready",this.onReady),this.state.messaging.off("action:"+d.WidgetApiFromWidgetAction.CloseModalWidget,this.onWidgetClose),this.state.messaging.stop()}render(){const e=this.widget.getCompleteUrl({widgetRoomId:this.props.widgetRoomId,currentUserId:h.a.get().getUserId(),userDisplayName:m.a.instance.displayName,userHttpAvatarUrl:m.a.instance.getHttpAvatarUrl(),clientId:f.a,clientTheme:b.b.getValue("theme"),clientLanguage:Object(c.g)()}),t=new URL(e);t.searchParams.set("widgetId",this.widget.id),t.searchParams.set("parentUrl",window.location.href.split("#",2)[0]);const n=t.toString().replace(/%24/g,"$");let i;return this.props.widgetDefinition.buttons&&(i=this.props.widgetDefinition.buttons.slice(0,3).reverse().map(e=>{let t="secondary";switch(e.kind){case d.ModalButtonKind.Primary:t="primary";break;case d.ModalButtonKind.Secondary:t="primary_outline";break;case d.ModalButtonKind.Danger:t="danger"}const s=this.state.disabledButtonIds.includes(e.id);return a.createElement(l.a,{key:e.id,kind:t,onClick:()=>{this.state.messaging.notifyModalWidgetButtonClicked(e.id)},disabled:s},e.label)})),a.createElement(r.a,{title:this.props.widgetDefinition.name||Object(c.a)("Modal Widget"),className:"mx_ModalWidgetDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},a.createElement("div",{className:"mx_ModalWidgetDialog_warning"},a.createElement("img",{src:s(610),height:"16",width:"16",alt:""}),Object(c.a)("Data on this screen is shared with %(widgetDomain)s",{widgetDomain:t.hostname})),a.createElement("div",null,a.createElement("iframe",{ref:this.appFrame,sandbox:"allow-forms allow-scripts allow-same-origin",src:n,onLoad:this.onLoad})),a.createElement("div",{className:"mx_ModalWidgetDialog_buttons"},i))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));const n="io.element.web"},function(e,t){e.exports="img/element-icons/warning-badge.413c9a9.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return T}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(102),d=s(96),u=s(157),h=s(248),m=s(94),p=s(182),g=s(204),v=s(126),f=s(129),b=s(191),y=s(93),_=s(98),E=s(168),S=s(328),w=s(119),C=s(281),k=s(100),O=s(282),R=s(612),I=s(130);const x=/[\x21-\x2F\x3A-\x40\x5B-\x60\x7B-\x7E]+/g;let T=Object(y.a)("views.rooms.MemberList")(n=class extends r.a.Component{constructor(e){var t;super(e),o()(this,"showPresence",!0),o()(this,"mounted",!1),o()(this,"collator",void 0),o()(this,"sortNames",new Map),o()(this,"onUserPresenceChange",(e,t)=>{this.refs[t.userId]&&this.updateList()}),o()(this,"onRoom",e=>{e.roomId===this.props.roomId&&this.showMembersAccordingToMembershipWithLL()}),o()(this,"onMyMembership",(e,t,s)=>{e.roomId===this.props.roomId&&"join"===t&&this.showMembersAccordingToMembershipWithLL()}),o()(this,"onRoomStateMember",(e,t,s)=>{s.roomId===this.props.roomId&&this.updateList()}),o()(this,"onRoomMemberName",(e,t)=>{t.roomId===this.props.roomId&&this.updateList()}),o()(this,"onRoomStateEvent",(e,t)=>{e.getRoomId()===this.props.roomId&&"m.room.third_party_invite"===e.getType()&&this.updateList(),this.canInvite!==this.state.canInvite&&this.setState({canInvite:this.canInvite})}),o()(this,"updateList",Object(h.a)(()=>{this.updateListNow()},500)),o()(this,"createOverflowTileJoined",(e,t)=>this.createOverflowTile(e,t,this.showMoreJoinedMemberList)),o()(this,"createOverflowTileInvited",(e,t)=>this.createOverflowTile(e,t,this.showMoreInvitedMemberList)),o()(this,"createOverflowTile",(e,t,n)=>{const i=Object(c.a)("and %(count)s others...",{count:e});return r.a.createElement(O.b,{className:"mx_EntityTile_ellipsis",avatarJsx:r.a.createElement(I.a,{url:s(283),name:"...",width:36,height:36}),name:i,presenceState:"online",suppressOnHover:!0,onClick:n})}),o()(this,"showMoreJoinedMemberList",()=>{this.setState({truncateAtJoined:this.state.truncateAtJoined+100})}),o()(this,"showMoreInvitedMemberList",()=>{this.setState({truncateAtInvited:this.state.truncateAtInvited+100})}),o()(this,"memberSort",(e,t)=>{const s=e.user,n=t.user;if(!s&&!n)return 0;if(s&&!n)return-1;if(!s&&n)return 1;if(this.showPresence){const e=e=>"unavailable"===e?"online":e,t=t=>{const s=["active","online","offline"],n=s.indexOf(e(t));return-1===n?s.length:n},i=t(s.currentlyActive?"active":s.presence),o=t(n.currentlyActive?"active":n.presence);if(i!==o)return i-o}return e.powerLevel!==t.powerLevel?t.powerLevel-e.powerLevel:this.showPresence&&s.getLastActiveTs()!==n.getLastActiveTs()?n.getLastActiveTs()-s.getLastActiveTs():this.collator.compare(this.sortNames.get(e),this.sortNames.get(t))}),o()(this,"onSearchQueryChanged",e=>{this.setState({searchQuery:e,filteredJoinedMembers:this.filterMembers(this.state.members,"join",e),filteredInvitedMembers:this.filterMembers(this.state.members,"invite",e)})}),o()(this,"onPending3pidInviteClick",e=>{d.a.dispatch({action:"view_3pid_invite",event:e})}),o()(this,"getChildrenJoined",(e,t)=>this.makeMemberTiles(this.state.filteredJoinedMembers.slice(e,t))),o()(this,"getChildCountJoined",()=>this.state.filteredJoinedMembers.length),o()(this,"getChildrenInvited",(e,t)=>{let s=this.state.filteredInvitedMembers;return t>this.state.filteredInvitedMembers.length&&(s=s.concat(this.getPending3PidInvites())),this.makeMemberTiles(s.slice(e,t))}),o()(this,"getChildCountInvited",()=>this.state.filteredInvitedMembers.length+(this.getPending3PidInvites()||[]).length),o()(this,"onInviteButtonClick",()=>{m.a.get().isGuest()?d.a.dispatch({action:"require_registration"}):d.a.dispatch({action:"view_invite",roomId:this.props.roomId})});const n=m.a.get();n.hasLazyLoadMembersEnabled()?this.state=this.getMembersState([]):this.state=this.getMembersState(this.roomMembers()),n.on("Room",this.onRoom);const i=l.a.get().enable_presence_by_hs_url,a=m.a.get().baseUrl;this.showPresence=null===(t=null==i?void 0:i[a])||void 0===t||t}UNSAFE_componentWillMount(){const e=m.a.get();this.mounted=!0,e.hasLazyLoadMembersEnabled()?(this.showMembersAccordingToMembershipWithLL(),e.on("Room.myMembership",this.onMyMembership)):this.listenForMembersChanges()}listenForMembersChanges(){const e=m.a.get();e.on("RoomState.members",this.onRoomStateMember),e.on("RoomMember.name",this.onRoomMemberName),e.on("RoomState.events",this.onRoomStateEvent),e.on("User.lastPresenceTs",this.onUserPresenceChange),e.on("User.presence",this.onUserPresenceChange),e.on("User.currentlyActive",this.onUserPresenceChange)}componentWillUnmount(){this.mounted=!1;const e=m.a.get();e&&(e.removeListener("RoomState.members",this.onRoomStateMember),e.removeListener("RoomMember.name",this.onRoomMemberName),e.removeListener("Room.myMembership",this.onMyMembership),e.removeListener("RoomState.events",this.onRoomStateEvent),e.removeListener("Room",this.onRoom),e.removeListener("User.lastPresenceTs",this.onUserPresenceChange),e.removeListener("User.presence",this.onUserPresenceChange),e.removeListener("User.currentlyActive",this.onUserPresenceChange)),this.updateList.cancelPendingCall()}async showMembersAccordingToMembershipWithLL(){if(m.a.get().hasLazyLoadMembersEnabled()){const e=m.a.get().getRoom(this.props.roomId);if("join"===(e&&e.getMyMembership())){this.setState({loading:!0});try{await e.loadMembersIfNeeded()}catch(e){}this.mounted&&(this.setState(this.getMembersState(this.roomMembers())),this.listenForMembersChanges())}else this.setState(this.getMembersState(this.roomMembers()))}}get canInvite(){const e=m.a.get(),t=e.getRoom(this.props.roomId);return t&&t.canInvite(e.getUserId())}getMembersState(e){return{loading:!1,members:e,filteredJoinedMembers:this.filterMembers(e,"join"),filteredInvitedMembers:this.filterMembers(e,"invite"),canInvite:this.canInvite,truncateAtJoined:30,truncateAtInvited:5,searchQuery:""}}updateListNow(){const e=this.roomMembers();this.setState({loading:!1,members:e,filteredJoinedMembers:this.filterMembers(e,"join",this.state.searchQuery),filteredInvitedMembers:this.filterMembers(e,"invite",this.state.searchQuery)})}getMembersWithUser(){if(!this.props.roomId)return[];const e=m.a.get(),t=e.getRoom(this.props.roomId);if(!t)return[];const s=Object.values(t.currentState.members);return s.forEach(t=>{t.user||(t.user=e.getUser(t.userId)),this.sortNames.set(t,("@"===t.name[0]?t.name.substr(1):t.name).replace(x,""))}),s}roomMembers(){const e=this.getMembersWithUser().filter(e=>"join"===e.membership||"invite"===e.membership),t=_.b.getValue("language");return this.collator=new Intl.Collator(t,{sensitivity:"base",ignorePunctuation:!1}),e.sort(this.memberSort),e}memberString(e){if(e){const t=e.user;return"("+e.name+", "+e.powerLevel+", "+(t?t.lastActiveAgo:"<null>")+", "+(t?t.getLastActiveTs():"<null>")+", "+(t?t.currentlyActive:"<null>")+", "+(t?t.presence:"<null>")+")"}return"(null)"}filterMembers(e,t,s){return e.filter(e=>{if(s){s=s.toLowerCase();const t=-1!==e.name.toLowerCase().indexOf(s),n=-1!==e.userId.toLowerCase().indexOf(s);if(!t&&!n)return!1}return e.membership===t})}getPending3PidInvites(){const e=m.a.get().getRoom(this.props.roomId);if(e)return e.currentState.getStateEvents("m.room.third_party_invite").filter((function(t){if(!Object(u.c)(t))return!1;return!e.currentState.getInviteForThreePidToken(t.getStateKey())}))}makeMemberTiles(e){return e.map(e=>e instanceof E.a?r.a.createElement(R.a,{key:e.userId,member:e,ref:e.userId,showPresence:this.showPresence}):r.a.createElement(O.b,{key:e.getStateKey(),name:e.getContent().display_name,suppressOnHover:!0,onClick:()=>this.onPending3pidInviteClick(e)}))}render(){if(this.state.loading)return r.a.createElement(g.b,{className:"mx_MemberList",onClose:this.props.onClose,previousPhase:v.c.RoomSummary},r.a.createElement(w.a,null));const e=m.a.get().getRoom(this.props.roomId);let t,s,n;if(e&&"join"===e.getMyMembership()){let s=Object(c.a)("Invite to this room");const n=p.a.instance.getSelectedCommunityGeneralChat();n&&n.roomId===this.props.roomId?s=Object(c.a)("Invite to this community"):_.b.getValue("feature_spaces")&&e.isSpaceRoom()&&(s=Object(c.a)("Invite to this space")),t=r.a.createElement(k.a,{className:"mx_MemberList_invite",onClick:this.onInviteButtonClick,disabled:!this.state.canInvite},r.a.createElement("span",null,s))}this.getChildCountInvited()>0&&(s=r.a.createElement("h2",null,Object(c.a)("Invited")),n=r.a.createElement(S.a,{className:"mx_MemberList_section mx_MemberList_invited",truncateAt:this.state.truncateAtInvited,createOverflowElement:this.createOverflowTileInvited,getChildren:this.getChildrenInvited,getChildCount:this.getChildCountInvited}));const i=r.a.createElement(C.a,{className:"mx_MemberList_query mx_textinput_icon mx_textinput_search",placeholder:Object(c.a)("Filter room members"),onSearch:this.onSearchQueryChanged});let o,a=v.c.RoomSummary;return _.b.getValue("feature_spaces")&&null!=e&&e.isSpaceRoom()&&(a=void 0,o=r.a.createElement("div",{className:"mx_RightPanel_scopeHeader"},r.a.createElement(f.a,{room:e,height:32,width:32}),r.a.createElement(b.a,{room:e}))),r.a.createElement(g.b,{className:"mx_MemberList",header:r.a.createElement(r.a.Fragment,null,o,t),footer:i,onClose:this.props.onClose,previousPhase:a},r.a.createElement("div",{className:"mx_MemberList_wrapper"},r.a.createElement(S.a,{className:"mx_MemberList_section mx_MemberList_joined",truncateAt:this.state.truncateAtJoined,createOverflowElement:this.createOverflowTileJoined,getChildren:this.getChildrenJoined,getChildCount:this.getChildCountJoined}),s,n))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i,o,a=s(104),r=s.n(a),c=s(18),l=s.n(c),d=s(98),u=s(91),h=s.n(u),m=s(96),p=s(92),g=s(94),v=s(103),f=s(93),b=s(110),y=s(282),_=s(171);let E=Object(f.a)("views.rooms.MemberTile")((o=i=class extends h.a.Component{constructor(e){super(e),l()(this,"userLastModifiedTime",void 0),l()(this,"memberLastModifiedTime",void 0),l()(this,"onRoomStateEvents",e=>{if(e.getType()!==b.a.RoomEncryption)return;const{roomId:t}=this.props.member;if(e.getRoomId()!==t)return;g.a.get().removeListener("RoomState.events",this.onRoomStateEvents),this.setState({isRoomEncrypted:!0}),this.updateE2EStatus()}),l()(this,"onUserTrustStatusChanged",(e,t)=>{e===this.props.member.userId&&this.updateE2EStatus()}),l()(this,"onDeviceVerificationChanged",(e,t,s)=>{e===this.props.member.userId&&this.updateE2EStatus()}),l()(this,"onStatusMessageCommitted",()=>{this.setState({statusMessage:this.getStatusMessage()})}),l()(this,"onClick",()=>{m.a.dispatch({action:v.a.ViewUser,member:this.props.member})}),this.state={statusMessage:this.getStatusMessage(),isRoomEncrypted:!1,e2eStatus:null}}componentDidMount(){const e=g.a.get();if(d.b.getValue("feature_custom_status")){const{user:e}=this.props.member;e&&e.on("User._unstable_statusMessage",this.onStatusMessageCommitted)}const{roomId:t}=this.props.member;if(t){const s=e.isRoomEncrypted(t);this.setState({isRoomEncrypted:s}),s?(e.on("userTrustStatusChanged",this.onUserTrustStatusChanged),e.on("deviceVerificationChanged",this.onDeviceVerificationChanged),this.updateE2EStatus()):e.on("RoomState.events",this.onRoomStateEvents)}}componentWillUnmount(){const e=g.a.get(),{user:t}=this.props.member;t&&t.removeListener("User._unstable_statusMessage",this.onStatusMessageCommitted),e&&(e.removeListener("RoomState.events",this.onRoomStateEvents),e.removeListener("userTrustStatusChanged",this.onUserTrustStatusChanged),e.removeListener("deviceVerificationChanged",this.onDeviceVerificationChanged))}async updateE2EStatus(){const e=g.a.get(),{userId:t}=this.props.member,s=t===e.getUserId(),n=e.checkUserTrust(t);if(!n.isCrossSigningVerified())return void this.setState({e2eStatus:n.wasCrossSigningVerified()?"warning":"normal"});const i=e.getStoredDevicesForUser(t).some(n=>{const{deviceId:i}=n,o=e.checkDeviceTrust(t,i);return s?!o.isCrossSigningVerified():!o.isVerified()});this.setState({e2eStatus:i?"warning":"verified"})}getStatusMessage(){const{user:e}=this.props.member;return e?e.unstable_statusMessage:""}shouldComponentUpdate(e,t){return void 0===this.memberLastModifiedTime||this.memberLastModifiedTime<e.member.getLastModifiedTime()||(!(!e.member.user||!(void 0===this.userLastModifiedTime||this.userLastModifiedTime<e.member.user.getLastModifiedTime()))||(t.isRoomEncrypted!==this.state.isRoomEncrypted||t.e2eStatus!==this.state.e2eStatus))}getDisplayName(){return this.props.member.name}getPowerLabel(){return Object(p.a)("%(userName)s (power %(powerLevelNumber)s)",{userName:this.props.member.userId,powerLevelNumber:this.props.member.powerLevel})}render(){const e=this.props.member,t=this.getDisplayName(),s=e.user?e.user.presence:null;let n=null;e.user&&d.b.getValue("feature_custom_status")&&(n=this.state.statusMessage);const i=h.a.createElement(_.a,{member:e,width:36,height:36,"aria-hidden":"true"});e.user&&(this.userLastModifiedTime=e.user.getLastModifiedTime()),this.memberLastModifiedTime=e.getLastModifiedTime();const o=new Map([[100,y.a.Admin],[50,y.a.Moderator]]);let a=this.props.member.powerLevel;for(const[e]of o)if(this.props.member.powerLevel>=e){a=e;break}const c=o.get(a);let l;return this.state.isRoomEncrypted&&(l=this.state.e2eStatus),h.a.createElement(y.b,r()({},this.props,{presenceState:s,presenceLastActiveAgo:e.user?e.user.lastActiveAgo:0,presenceLastTs:e.user?e.user.lastPresenceTs:0,presenceCurrentlyActive:!!e.user&&e.user.currentlyActive,avatarJsx:i,title:this.getPowerLabel(),name:t,powerStatus:c,showPresence:this.props.showPresence,subtextLabel:n,e2eStatus:l,onClick:this.onClick}))}},l()(i,"defaultProps",{showPresence:!0}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(92),u=s(95),h=s(96),m=s(128),p=s(97),g=s.n(p),v=s(422),f=s(100),b=s(126),y=s(125),_=s(103),E=s(93);let S=Object(E.a)("views.groups.GroupMemberList")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{members:null,membersError:null,invitedMembers:null,invitedMembersError:null,truncateAt:30}),r()(this,"_createOverflowTile",(e,t)=>{const n=u.getComponent("rooms.EntityTile"),i=u.getComponent("avatars.BaseAvatar"),o=Object(d.a)("and %(count)s others...",{count:e});return l.a.createElement(n,{className:"mx_EntityTile_ellipsis",avatarJsx:l.a.createElement(i,{url:s(283),name:"...",width:36,height:36}),name:o,presenceState:"online",suppressOnHover:!0,onClick:this._showFullMemberList})}),r()(this,"_showFullMemberList",()=>{this.setState({truncateAt:-1})}),r()(this,"onSearchQueryChanged",e=>{this.setState({searchQuery:e.target.value})}),r()(this,"onInviteToGroupButtonClick",()=>{Object(v.b)(this.props.groupId).then(()=>{h.a.dispatch({action:_.a.SetRightPanelPhase,phase:b.c.GroupMemberList,refireParams:{groupId:this.props.groupId}})})})}componentDidMount(){this._unmounted=!1,this._initGroupStore(this.props.groupId)}componentWillUnmount(){this._unmounted=!0}_initGroupStore(e){m.a.registerListener(e,()=>{this._fetchMembers()}),m.a.on("error",(t,s,n)=>{this._unmounted||e!==s||(n===m.a.STATE_KEY.GroupMembers&&this.setState({membersError:t}),n===m.a.STATE_KEY.GroupInvitedMembers&&this.setState({invitedMembersError:t}))})}_fetchMembers(){this._unmounted||this.setState({members:m.a.getGroupMembers(this.props.groupId),invitedMembers:m.a.getGroupInvitedMembers(this.props.groupId)})}makeGroupMemberTiles(e,t,s){if(s)return l.a.createElement("div",{className:"warning"},Object(d.a)("Failed to load group members"));const n=u.getComponent("groups.GroupMemberTile"),i=u.getComponent("elements.TruncatedList");(e=(e||"").toLowerCase())&&(t=t.filter(t=>{const s=(t.displayname||"").toLowerCase().includes(e),n=t.userId.toLowerCase().includes(e);return!(!s&&!n)}));const o={};t.forEach(e=>{o[e.userId]||(o[e.userId]=e)}),(t=Object.keys(o).map(e=>o[e])).sort((e,t)=>{if(e.isPrivileged===t.isPrivileged){const s=e.displayname||e.userId,n=t.displayname||t.userId;return s<n?-1:s>n?1:0}return e.isPrivileged?-1:1});const a=t.map(e=>l.a.createElement(n,{key:e.userId,groupId:this.props.groupId,member:e}));return l.a.createElement(i,{className:"mx_MemberList_wrapper",truncateAt:this.state.truncateAt,createOverflowElement:this._createOverflowTile},a)}render(){if(this.state.fetching||this.state.fetchingInvitedMembers){const e=u.getComponent("elements.Spinner");return l.a.createElement("div",{className:"mx_MemberList"},l.a.createElement(e,null))}const e=l.a.createElement("input",{className:"mx_GroupMemberList_query mx_textinput",id:"mx_GroupMemberList_query",type:"text",onChange:this.onSearchQueryChanged,value:this.state.searchQuery,placeholder:Object(d.a)("Filter community members"),autoComplete:"off"}),t=this.state.members?l.a.createElement("div",{className:"mx_MemberList_joined"},this.makeGroupMemberTiles(this.state.searchQuery,this.state.members,this.state.membersError)):l.a.createElement("div",null),s=this.state.invitedMembers&&this.state.invitedMembers.length>0?l.a.createElement("div",{className:"mx_MemberList_invited"},l.a.createElement("h2",null,Object(d.a)("Invited")),this.makeGroupMemberTiles(this.state.searchQuery,this.state.invitedMembers,this.state.invitedMembersError)):l.a.createElement("div",null);let n;return m.a.isUserPrivileged(this.props.groupId)&&(n=l.a.createElement(f.a,{className:"mx_MemberList_invite mx_MemberList_inviteCommunity",onClick:this.onInviteToGroupButtonClick},l.a.createElement("span",null,Object(d.a)("Invite to this community")))),l.a.createElement("div",{className:"mx_MemberList",role:"tabpanel"},n,l.a.createElement(y.a,null,t,s),e)}},r()(i,"propTypes",{groupId:g.a.string.isRequired}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(92),u=s(95),h=s(128),m=s(97),p=s.n(m),g=s(422),v=s(100),f=s(125),b=s(93);let y=Object(b.a)("views.groups.GroupRoomList")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{rooms:null,truncateAt:30,searchQuery:""}),r()(this,"onGroupStoreUpdated",()=>{this._unmounted||this.setState({rooms:h.a.getGroupRooms(this.props.groupId)})}),r()(this,"_createOverflowTile",(e,t)=>{const n=u.getComponent("rooms.EntityTile"),i=u.getComponent("avatars.BaseAvatar"),o=Object(d.a)("and %(count)s others...",{count:e});return l.a.createElement(n,{className:"mx_EntityTile_ellipsis",avatarJsx:l.a.createElement(i,{url:s(283),name:"...",width:36,height:36}),name:o,presenceState:"online",suppressOnHover:!0,onClick:this._showFullRoomList})}),r()(this,"_showFullRoomList",()=>{this.setState({truncateAt:-1})}),r()(this,"onSearchQueryChanged",e=>{this.setState({searchQuery:e.target.value})}),r()(this,"onAddRoomToGroupButtonClick",()=>{Object(g.a)(this.props.groupId).then(()=>{this.forceUpdate()})})}componentDidMount(){this._unmounted=!1,this._initGroupStore(this.props.groupId)}componentWillUnmount(){this._unmounted=!0,this._unregisterGroupStore()}_unregisterGroupStore(){h.a.unregisterListener(this.onGroupStoreUpdated)}_initGroupStore(e){h.a.registerListener(e,this.onGroupStoreUpdated),h.a.on("error",(t,s)=>{s===e&&this.setState({rooms:null})})}makeGroupRoomTiles(e){const t=u.getComponent("groups.GroupRoomTile");e=(e||"").toLowerCase();let s=this.state.rooms;return e&&(s=s.filter(t=>{const s=(t.name||"").toLowerCase().includes(e),n=(t.canonicalAlias||"").toLowerCase().includes(e);return s||n})),s=s.map((e,s)=>l.a.createElement(t,{key:s,groupId:this.props.groupId,groupRoom:e})),s}render(){if(null===this.state.rooms)return null;let e;h.a.isUserPrivileged(this.props.groupId)&&(e=l.a.createElement(v.a,{className:"mx_MemberList_invite mx_MemberList_addRoomToCommunity",onClick:this.onAddRoomToGroupButtonClick},l.a.createElement("span",null,Object(d.a)("Add rooms to this community"))));const t=l.a.createElement("input",{className:"mx_GroupRoomList_query mx_textinput",id:"mx_GroupRoomList_query",type:"text",onChange:this.onSearchQueryChanged,value:this.state.searchQuery,placeholder:Object(d.a)("Filter community rooms"),autoComplete:"off"}),s=u.getComponent("elements.TruncatedList");return l.a.createElement("div",{className:"mx_GroupRoomList",role:"tabpanel"},e,l.a.createElement(f.a,{className:"mx_GroupRoomList_joined mx_GroupRoomList_outerWrapper"},l.a.createElement(s,{className:"mx_GroupRoomList_wrapper",truncateAt:this.state.truncateAt,createOverflowElement:this._createOverflowTile},this.makeGroupRoomTiles(this.state.searchQuery))),t)}},r()(i,"propTypes",{groupId:p.a.string.isRequired}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(96),m=s(99),p=s(95),g=s(92),v=s(128),f=s(105),b=s(125),y=s(93),_=s(107);let E=Object(y.a)("views.groups.GroupRoomInfo")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{isUserPrivilegedInGroup:null,groupRoom:null,groupRoomPublicityLoading:!1,groupRoomRemoveLoading:!1}),r()(this,"onGroupStoreUpdated",()=>{this.setState({isUserPrivilegedInGroup:v.a.isUserPrivileged(this.props.groupId)}),this._updateGroupRoom()}),r()(this,"_onRemove",e=>{const t=this.props.groupId,s=this.state.groupRoom.displayname;e.preventDefault(),e.stopPropagation();const n=p.getComponent("dialogs.QuestionDialog");m.a.createTrackedDialog("Confirm removal of group from room","",n,{title:Object(g.a)("Are you sure you want to remove '%(roomName)s' from %(groupId)s?",{roomName:s,groupId:t}),description:Object(g.a)("Removing a room from the community will also remove it from the community page."),button:Object(g.a)("Remove"),onFinished:e=>{if(!e)return;this.setState({groupRoomRemoveLoading:!0});const t=this.props.groupId,n=this.props.groupRoomId;v.a.removeRoomFromGroup(this.props.groupId,n).then(()=>{h.a.dispatch({action:"view_group_room_list"})}).catch(e=>{console.error(`Error whilst removing ${n} from ${t}`,e);const i=p.getComponent("dialogs.ErrorDialog");m.a.createTrackedDialog("Failed to remove room from group","",i,{title:Object(g.a)("Failed to remove room from community"),description:Object(g.a)("Failed to remove '%(roomName)s' from %(groupId)s",{groupId:t,roomName:s})})}).finally(()=>{this.setState({groupRoomRemoveLoading:!1})})}})}),r()(this,"_onCancel",e=>{h.a.dispatch({action:"view_group_room_list"})}),r()(this,"_changeGroupRoomPublicity",e=>{const t="public"===e.target.value;this.setState({groupRoomPublicityLoading:!0});const s=this.props.groupId,n=this.props.groupRoomId,i=this.state.groupRoom.displayname;v.a.updateGroupRoomVisibility(this.props.groupId,n,t).catch(e=>{console.error(`Error whilst changing visibility of ${n} in ${s} to ${t}`,e);const o=p.getComponent("dialogs.ErrorDialog");m.a.createTrackedDialog("Failed to remove room from group","",o,{title:Object(g.a)("Something went wrong!"),description:Object(g.a)("The visibility of '%(roomName)s' in %(groupId)s could not be updated.",{roomName:i,groupId:s})})}).finally(()=>{this.setState({groupRoomPublicityLoading:!1})})})}componentDidMount(){this._initGroupStore(this.props.groupId)}UNSAFE_componentWillReceiveProps(e){e.groupId!==this.props.groupId&&(this._unregisterGroupStore(this.props.groupId),this._initGroupStore(e.groupId))}componentWillUnmount(){this._unregisterGroupStore(this.props.groupId)}_initGroupStore(e){v.a.registerListener(e,this.onGroupStoreUpdated)}_unregisterGroupStore(e){v.a.unregisterListener(this.onGroupStoreUpdated)}_updateGroupRoom(){this.setState({groupRoom:v.a.getGroupRooms(this.props.groupId).find(e=>e.roomId===this.props.groupRoomId)})}render(){const e=p.getComponent("elements.AccessibleButton"),t=p.getComponent("elements.InlineSpinner");if(this.state.groupRoomRemoveLoading||!this.state.groupRoom){const e=p.getComponent("elements.Spinner");return l.a.createElement("div",{className:"mx_MemberInfo"},l.a.createElement(e,null))}let n;this.state.isUserPrivilegedInGroup&&(n=l.a.createElement("div",{className:"mx_MemberInfo_adminTools"},l.a.createElement("h3",null,Object(g.a)("Admin Tools")),l.a.createElement("div",{className:"mx_MemberInfo_buttons"},l.a.createElement(e,{className:"mx_MemberInfo_field",onClick:this._onRemove},Object(g.a)("Remove from community"))),l.a.createElement("h3",null,Object(g.a)("Visibility in Room List"),this.state.groupRoomPublicityLoading?l.a.createElement(t,null):l.a.createElement("div",null)),l.a.createElement("div",null,l.a.createElement("label",null,l.a.createElement("input",{type:"radio",value:"public",checked:this.state.groupRoom.isPublic,onChange:this._changeGroupRoomPublicity}),l.a.createElement("div",{className:"mx_MemberInfo_label_text"},Object(g.a)("Visible to everyone")))),l.a.createElement("div",null,l.a.createElement("label",null,l.a.createElement("input",{type:"radio",value:"private",checked:!this.state.groupRoom.isPublic,onChange:this._changeGroupRoomPublicity}),l.a.createElement("div",{className:"mx_MemberInfo_label_text"},Object(g.a)("Only visible to community members"))))));const i=this.state.groupRoom.avatarUrl;let o;if(i){const e=Object(_.b)(i).getSquareThumbnailHttp(800);o=l.a.createElement("div",{className:"mx_MemberInfo_avatar"},l.a.createElement("img",{src:e}))}const a=this.state.groupRoom.displayname;return l.a.createElement("div",{className:"mx_MemberInfo",role:"tabpanel"},l.a.createElement(b.a,null,l.a.createElement(e,{className:"mx_MemberInfo_cancel",onClick:this._onCancel},l.a.createElement("img",{src:s(336),width:"18",height:"18",className:"mx_filterFlipColor"})),o,l.a.createElement("h2",null,a),l.a.createElement("div",{className:"mx_MemberInfo_profile"},l.a.createElement("div",{className:"mx_MemberInfo_profileField"},this.state.groupRoom.canonicalAlias)),n))}},r()(i,"contextType",f.a),r()(i,"propTypes",{groupId:u.a.string,groupRoomId:u.a.string}),n=o))||n},function(e,t,s){"use strict";var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(101),d=s.n(l),u=s(168),h=s(167),m=s(96),p=s(99),g=s(92),v=s(137),f=s(127),b=s(100),y=s(102),_=s(98),E=s(133),S=s(310),w=s(128),C=s(94),k=s(206),O=s(131),R=s(387),I=s(105),x=s(126),T=s(617),j=s(408),N=s(593),P=s(103),D=s(208),A=s(596),M=s(204),U=s(420),L=s(474),F=s(119),B=s(663),V=s(171),K=s(411),W=s(415),G=s(135),q=s(143),H=s(664),$=s(226),z=s(110),Y=s(129),J=s(191),Q=s(107),X=s(154);function Z({userId:e,device:t}){var s;const n=Object(r.useContext)(I.a),i=e===n.getUserId(),o=n.checkDeviceTrust(e,t.deviceId),a=n.checkUserTrust(e),l=i?o.isCrossSigningVerified():o.isVerified(),u=d()("mx_UserInfo_device",{mx_UserInfo_device_verified:l,mx_UserInfo_device_unverified:!l}),h=d()("mx_E2EIcon",{mx_E2EIcon_normal:!a.isVerified(),mx_E2EIcon_verified:l,mx_E2EIcon_warning:a.isVerified()&&!l}),m=()=>{Object(N.c)(n.getUser(e),t)};let p;p=null!==(s=t.getDisplayName())&&void 0!==s&&s.trim()?t.ambiguous?t.getDisplayName()+" ("+t.deviceId+")":t.getDisplayName():t.deviceId;let v=null;return a.isVerified()&&(v=l?Object(g.a)("Trusted"):Object(g.a)("Not trusted")),l?c.a.createElement("div",{className:u,title:t.deviceId},c.a.createElement("div",{className:h}),c.a.createElement("div",{className:"mx_UserInfo_device_name"},p),c.a.createElement("div",{className:"mx_UserInfo_device_trusted"},v)):c.a.createElement(b.a,{className:u,title:t.deviceId,onClick:m},c.a.createElement("div",{className:h}),c.a.createElement("div",{className:"mx_UserInfo_device_name"},p),c.a.createElement("div",{className:"mx_UserInfo_device_trusted"},v))}function ee({devices:e,userId:t,loading:s}){const n=Object(r.useContext)(I.a),i=n.checkUserTrust(t),[o,a]=Object(r.useState)(!1);if(s)return c.a.createElement(F.a,null);if(null===e)return c.a.createElement(c.a.Fragment,null,Object(g.a)("Unable to load session list"));const l=t===n.getUserId(),d=e.map(e=>n.checkDeviceTrust(t,e.deviceId));let u=[];const h=[];let m,p,v,f="mx_E2EIcon";if(i.isVerified()){for(let t=0;t<e.length;++t){const s=e[t],n=d[t];(l?n.isCrossSigningVerified():n.isVerified())?u.push(s):h.push(s)}m=Object(g.a)("%(count)s verified sessions",{count:u.length}),p=Object(g.a)("Hide verified sessions"),f+=" mx_E2EIcon_verified"}else u=e,m=Object(g.a)("%(count)s sessions",{count:e.length}),p=Object(g.a)("Hide sessions"),f+=" mx_E2EIcon_normal";u.length&&(v=o?c.a.createElement(b.a,{className:"mx_UserInfo_expand mx_linkButton",onClick:()=>a(!1)},c.a.createElement("div",null,p)):c.a.createElement(b.a,{className:"mx_UserInfo_expand mx_linkButton",onClick:()=>a(!0)},c.a.createElement("div",{className:f}),c.a.createElement("div",null,m)));let y=h.map((e,s)=>c.a.createElement(Z,{key:s,userId:t,device:e}));if(o){const e=h.length;y=y.concat(u.map((s,n)=>c.a.createElement(Z,{key:n+e,userId:t,device:s})))}return c.a.createElement("div",{className:"mx_UserInfo_devices"},c.a.createElement("div",null,y),c.a.createElement("div",null,v))}const te=({member:e,isIgnored:t,canInvite:s,isSpace:n})=>{const i=Object(r.useContext)(I.a);let o=null,a=null,l=null,u=null;const h=e.userId===i.getUserId();if(!h){const r=()=>{const s=i.getIgnoredUsers();if(t){const t=s.indexOf(e.userId);-1!==t&&s.splice(t,1)}else s.push(e.userId);i.setIgnoredUsers(s)};if(o=c.a.createElement(b.a,{onClick:r,className:d()("mx_UserInfo_field",{mx_UserInfo_destructive:!t})},t?Object(g.a)("Unignore"):Object(g.a)("Ignore")),e.roomId&&!n){const t=function(){const t=i.getRoom(e.roomId);m.a.dispatch({action:"view_room",highlighted:!0,event_id:t.getEventReadUpTo(e.userId),room_id:e.roomId})},s=function(){m.a.dispatch({action:P.a.ComposerInsert,userId:e.userId})},n=i.getRoom(e.roomId);null!=n&&n.getEventReadUpTo(e.userId)&&(u=c.a.createElement(b.a,{onClick:t,className:"mx_UserInfo_field"},Object(g.a)("Jump to read receipt"))),a=c.a.createElement(b.a,{onClick:s,className:"mx_UserInfo_field"},Object(g.a)("Mention"))}if(s&&(!e||!e.membership||"leave"===e.membership)){const t=e&&e.roomId?e.roomId:E.a.getRoomId(),s=async()=>{try{const s=new S.a(t);await s.invite([e.userId]).then(()=>{if("invited"!==s.getCompletionState(e.userId))throw new Error(s.getErrorText(e.userId))})}catch(e){p.a.createTrackedDialog("Failed to invite","",G.a,{title:Object(g.a)("Failed to invite"),description:e&&e.message?e.message:Object(g.a)("Operation failed")})}};l=c.a.createElement(b.a,{onClick:s,className:"mx_UserInfo_field"},Object(g.a)("Invite"))}}const f=c.a.createElement(b.a,{onClick:()=>{p.a.createTrackedDialog("share room member dialog","",W.a,{target:e})},className:"mx_UserInfo_field"},Object(g.a)("Share Link to User"));let y;return h||(y=c.a.createElement(b.a,{onClick:()=>async function(e,t){const s=Object(v.e)(e,t);if(s)return void m.a.dispatch({action:"view_room",room_id:s.roomId});const n={dmUserId:t,encryption:void 0};if(Object(v.f)()){const s=await e.downloadKeys([t]);Object.values(s).every(e=>Object.keys(e).length>0)&&(n.encryption=!0)}return Object(v.b)(n)}(i,e.userId),className:"mx_UserInfo_field"},Object(g.a)("Direct message"))),c.a.createElement("div",{className:"mx_UserInfo_container"},c.a.createElement("h3",null,Object(g.a)("Options")),c.a.createElement("div",null,y,u,f,a,l,o))},se=async e=>{const{finished:t}=p.a.createTrackedDialog("Demoting Self","",q.a,{title:Object(g.a)("Demote yourself?"),description:c.a.createElement("div",null,e?Object(g.a)("You will not be able to undo this change as you are demoting yourself, if you are the last privileged user in the space it will be impossible to regain privileges."):Object(g.a)("You will not be able to undo this change as you are demoting yourself, if you are the last privileged user in the room it will be impossible to regain privileges.")),button:Object(g.a)("Demote")}),[s]=await t;return s},ne=({children:e})=>c.a.createElement("div",{className:"mx_UserInfo_container"},c.a.createElement("h3",null,Object(g.a)("Admin Tools")),c.a.createElement("div",{className:"mx_UserInfo_buttons"},e)),ie=e=>{var t,s;return(null==e||null===(t=e.currentState)||void 0===t||null===(s=t.getStateEvents(z.a.RoomPowerLevels,""))||void 0===s?void 0:s.getContent())||{}},oe=({member:e,startUpdating:t,stopUpdating:s})=>{const n=Object(r.useContext)(I.a);if("invite"!==e.membership&&"join"!==e.membership)return null;const i="invite"===e.membership?Object(g.a)("Disinvite"):Object(g.a)("Kick");return c.a.createElement(b.a,{className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:async()=>{const{finished:i}=p.a.createTrackedDialog("Confirm User Action Dialog","onKick",H.a,{member:e,action:"invite"===e.membership?Object(g.a)("Disinvite"):Object(g.a)("Kick"),title:"invite"===e.membership?Object(g.a)("Disinvite this user?"):Object(g.a)("Kick this user?"),askReason:"join"===e.membership,danger:!0}),[o,a]=await i;o&&(t(),n.kick(e.roomId,e.userId,a||void 0).then(()=>{console.log("Kick success")},(function(e){console.error("Kick error: "+e),p.a.createTrackedDialog("Failed to kick","",G.a,{title:Object(g.a)("Failed to kick"),description:e&&e.message?e.message:"Operation failed"})})).finally(()=>{s()}))}},i)},ae=({member:e})=>{const t=Object(r.useContext)(I.a);return c.a.createElement(b.a,{className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:async()=>{const{roomId:s,userId:n}=e,i=t.getRoom(s);if(!i)return;let o=i.getLiveTimeline(),a=[];for(;o;)a=o.getEvents().reduce((e,t)=>t.getSender()!==n||t.isRedacted()||t.isRedaction()||t.getType()===z.a.RoomCreate||t.getType()===z.a.RoomServerAcl?e:e.concat(t),a),o=o.getNeighbouringTimeline(h.a.BACKWARDS);const r=a.length,l=e.name;if(0===r)p.a.createTrackedDialog("No user messages found to remove","",$.a,{title:Object(g.a)("No recent messages by %(user)s found",{user:l}),description:c.a.createElement("div",null,c.a.createElement("p",null,Object(g.a)("Try scrolling up in the timeline to see if there are any earlier ones.")))});else{const{finished:e}=p.a.createTrackedDialog("Remove recent messages by user","",q.a,{title:Object(g.a)("Remove recent messages by %(user)s",{user:l}),description:c.a.createElement("div",null,c.a.createElement("p",null,Object(g.a)("You are about to remove %(count)s messages by %(user)s. This cannot be undone. Do you wish to continue?",{count:r,user:l})),c.a.createElement("p",null,Object(g.a)("For a large amount of messages, this might take some time. Please don't refresh your client in the meantime."))),button:Object(g.a)("Remove %(count)s messages",{count:r})}),[n]=await e;if(!n)return;await Promise.resolve(),console.info(`Started redacting recent ${r} messages for ${l} in ${s}`),await Promise.all(a.map(async e=>{try{await t.redactEvent(s,e.getId())}catch(t){console.error("Could not redact",e.getId()),console.error(t)}})),console.info(`Finished redacting recent ${r} messages for ${l} in ${s}`)}}},Object(g.a)("Remove recent messages"))},re=({member:e,startUpdating:t,stopUpdating:s})=>{const n=Object(r.useContext)(I.a);let i=Object(g.a)("Ban");"ban"===e.membership&&(i=Object(g.a)("Unban"));const o=d()("mx_UserInfo_field",{mx_UserInfo_destructive:"ban"!==e.membership});return c.a.createElement(b.a,{className:o,onClick:async()=>{const{finished:i}=p.a.createTrackedDialog("Confirm User Action Dialog","onBanOrUnban",H.a,{member:e,action:"ban"===e.membership?Object(g.a)("Unban"):Object(g.a)("Ban"),title:"ban"===e.membership?Object(g.a)("Unban this user?"):Object(g.a)("Ban this user?"),askReason:"ban"!==e.membership,danger:"ban"!==e.membership}),[o,a]=await i;if(!o)return;let r;t(),r="ban"===e.membership?n.unban(e.roomId,e.userId):n.ban(e.roomId,e.userId,a||void 0),r.then(()=>{console.log("Ban success")},(function(e){console.error("Ban error: "+e),p.a.createTrackedDialog("Failed to ban user","",G.a,{title:Object(g.a)("Error"),description:Object(g.a)("Failed to ban user")})})).finally(()=>{s()})}},i)},ce=({member:e,room:t,powerLevels:s,startUpdating:n,stopUpdating:i})=>{const o=Object(r.useContext)(I.a);if("join"!==e.membership)return null;const a=((e,t)=>{if(!t||!e)return!1;const s=(t.events?t.events["m.room.message"]:null)||t.events_default;return e.powerLevel<s})(e,s),l=d()("mx_UserInfo_field",{mx_UserInfo_destructive:!a}),u=a?Object(g.a)("Unmute"):Object(g.a)("Mute");return c.a.createElement(b.a,{className:l,onClick:async()=>{const s=e.roomId,r=e.userId;if(r===o.getUserId())try{if(!await se(_.b.getValue("feature_spaces")&&(null==t?void 0:t.isSpaceRoom())))return}catch(e){return void console.error("Failed to warn about self demotion: ",e)}const c=t.currentState.getStateEvents("m.room.power_levels","");if(!c)return;const l=c.getContent(),d=(l.events?l.events["m.room.message"]:null)||l.events_default;let u;u=a?d:d-1,u=parseInt(u),isNaN(u)||(n(),o.setPowerLevel(s,r,u,c).then(()=>{console.log("Mute toggle success")},(function(e){console.error("Mute error: "+e),p.a.createTrackedDialog("Failed to mute user","",G.a,{title:Object(g.a)("Error"),description:Object(g.a)("Failed to mute user")})})).finally(()=>{i()}))}},u)},le=({room:e,children:t,member:s,startUpdating:n,stopUpdating:i,powerLevels:o})=>{const a=Object(r.useContext)(I.a);let l,d,u,h;const m=(o.events?o.events["m.room.power_levels"]:null)||o.state_default,{ban:p=50,kick:g=50,redact:v=50}=o,f=e.getMember(a.getUserId());if(!f)return c.a.createElement("div",null);const b=f.userId===s.userId,y=s.powerLevel<f.powerLevel||b;return y&&f.powerLevel>=g&&(l=c.a.createElement(oe,{member:s,startUpdating:n,stopUpdating:i})),!(f.powerLevel>=v)||_.b.getValue("feature_spaces")&&e.isSpaceRoom()||(h=c.a.createElement(ae,{member:s,startUpdating:n,stopUpdating:i})),y&&f.powerLevel>=p&&(d=c.a.createElement(re,{member:s,startUpdating:n,stopUpdating:i})),y&&f.powerLevel>=m&&(u=c.a.createElement(ce,{member:s,room:e,powerLevels:o,startUpdating:n,stopUpdating:i})),l||d||u||h||t?c.a.createElement(ne,null,u,l,d,h,t):c.a.createElement("div",null)},de=({children:e,groupId:t,groupMember:s,startUpdating:n,stopUpdating:i})=>{const o=Object(r.useContext)(I.a),[a,l]=Object(r.useState)(!1),[d,u]=Object(r.useState)(!1);if(Object(r.useEffect)(()=>{let e=!1;const n=()=>{e||(l(w.a.isUserPrivileged(t)),u(w.a.getGroupInvitedMembers(t).some(e=>e.userId===s.userId)))};return w.a.registerListener(t,n),n(),()=>{e=!0,w.a.unregisterListener(n)}},[t,s.userId]),a){const a=async()=>{const{finished:e}=p.a.createDialog(H.a,{matrixClient:o,groupMember:s,action:d?Object(g.a)("Disinvite"):Object(g.a)("Remove from community"),title:d?Object(g.a)("Disinvite this user from community?"):Object(g.a)("Remove this user from community?"),danger:!0}),[a]=await e;a&&(n(),o.removeUserFromGroup(t,s.userId).then(()=>{m.a.dispatch({action:P.a.ViewUser,member:null})}).catch(e=>{p.a.createTrackedDialog("Failed to remove user from group","",G.a,{title:Object(g.a)("Error"),description:d?Object(g.a)("Failed to withdraw invitation"):Object(g.a)("Failed to remove user from community")}),console.log(e)}).finally(()=>{i()}))},r=c.a.createElement(b.a,{className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:a},d?Object(g.a)("Disinvite"):Object(g.a)("Remove from community"));return c.a.createElement(ne,null,r,e)}return c.a.createElement("div",null)};const ue=({user:e,room:t,roomPermissions:s,powerLevels:n})=>{if(s.canEdit)return c.a.createElement(he,{user:e,room:t,roomPermissions:s});{const t=n.users_default||0,s=e.powerLevel,i=Object(R.b)(s,t);return c.a.createElement("div",{className:"mx_UserInfo_profileField"},c.a.createElement("div",{className:"mx_UserInfo_roleDescription"},i))}},he=({user:e,room:t,roomPermissions:s})=>{const n=Object(r.useContext)(I.a),[i,o]=Object(r.useState)(e.powerLevel),a=Object(r.useCallback)(async s=>{const i=parseInt(s,10);o(i);const a=e.roomId,r=e.userId,l=t.currentState.getStateEvents("m.room.power_levels","");if(!l)return;const d=n.getUserId(),u=l.getContent().users[d];if(u&&parseInt(u)===i){const{finished:e}=p.a.createTrackedDialog("Promote to PL100 Warning","",q.a,{title:Object(g.a)("Warning!"),description:c.a.createElement("div",null,Object(g.a)("You will not be able to undo this change as you are promoting the user to have the same power level as yourself."),c.a.createElement("br",null),Object(g.a)("Are you sure?")),button:Object(g.a)("Continue")}),[t]=await e;if(!t)return}else if(d===r)try{if(!await se(_.b.getValue("feature_spaces")&&(null==t?void 0:t.isSpaceRoom())))return}catch(e){console.error("Failed to warn about self demotion: ",e)}await((e,t,s,i)=>n.setPowerLevel(e,t,parseInt(s),i).then((function(){console.log("Power change success")}),(function(e){console.error("Failed to change power level "+e),p.a.createTrackedDialog("Failed to change power level","",G.a,{title:Object(g.a)("Error"),description:Object(g.a)("Failed to change power level")})})))(a,r,i,l)},[e.roomId,e.userId,n,t]),l=t.currentState.getStateEvents("m.room.power_levels",""),d=l?l.getContent().users_default:0;return c.a.createElement("div",{className:"mx_UserInfo_profileField"},c.a.createElement(B.a,{label:null,value:i,maxValue:s.modifyLevelMax,usersDefault:d,onChange:a}))},me=e=>{const t=Object(r.useContext)(I.a),[s,n]=Object(r.useState)(void 0);return Object(r.useEffect)(()=>{n(void 0);let s=!1;return async function(){try{await t.downloadKeys([e],!0);const i=t.getStoredDevicesForUser(e);if(s)return;(e=>{const t=Object.create(null);for(let s=0;s<e.length;s++){const n=e[s].getDisplayName(),i=t[n]||[];i.push(s),t[n]=i}for(const s in t)t[s].length>1&&t[s].forEach(t=>{e[t].ambiguous=!0})})(i),n(i)}catch(e){n(null)}}(),()=>{s=!0}},[t,e]),Object(r.useEffect)(()=>{let s=!1;const i=async()=>{const i=t.getStoredDevicesForUser(e);s||n(i)},o=t=>{t.includes(e)&&i()},a=(t,s)=>{t===e&&i()},r=(t,s)=>{t===e&&i()};return t.on("crypto.devicesUpdated",o),t.on("deviceVerificationChanged",a),t.on("userTrustStatusChanged",r),()=>{s=!0,t.removeListener("crypto.devicesUpdated",o),t.removeListener("deviceVerificationChanged",a),t.removeListener("userTrustStatusChanged",r)}},[t,e]),s},pe=({room:e,member:t,groupId:s,devices:n,isRoomEncrypted:i})=>{const o=Object(r.useContext)(I.a),a=((e,t)=>{const[s,n]=Object(r.useState)(ie(t)),i=Object(r.useCallback)(e=>{t&&(e&&e.getType()!==z.a.RoomPowerLevels||n(ie(t)))},[t]);return Object(O.a)(e,"RoomState.events",i),Object(r.useEffect)(()=>(i(),()=>{n({})}),[i]),s})(o,e),l=(e=>{const[t,s]=Object(r.useState)(!1);return Object(r.useEffect)(()=>{e.isSynapseAdministrator().then(e=>{s(e)},()=>{s(!1)})},[e]),t})(o),[d,u]=Object(r.useState)(o.isUserIgnored(t.userId));Object(r.useEffect)(()=>{u(o.isUserIgnored(t.userId))},[o,t.userId]);const h=Object(r.useCallback)(e=>{"m.ignored_user_list"===e.getType()&&u(o.isUserIgnored(t.userId))},[o,t.userId]);Object(O.a)(o,"accountData",h);const[v,y]=Object(r.useState)(0),E=Object(r.useCallback)(()=>{y(v+1)},[v]),S=Object(r.useCallback)(()=>{y(v-1)},[v]),w=function(e,t,s){const[n,i]=Object(r.useState)({modifyLevelMax:-1,canEdit:!1,canInvite:!1}),o=Object(r.useCallback)(()=>{if(!t)return;const n=t.currentState.getStateEvents("m.room.power_levels","");if(!n)return;const o=n.getContent();if(!o)return;const a=t.getMember(e.getUserId());if(!a)return;const r=s,c=a.userId===r.userId;let l=-1;if(r.powerLevel<a.powerLevel||c){const e=(o.events?o.events["m.room.power_levels"]:null)||o.state_default;a.powerLevel>=e&&(c||a.powerLevel>r.powerLevel)&&(l=a.powerLevel)}i({canInvite:a.powerLevel>=o.invite,canEdit:l>=0,modifyLevelMax:l})},[e,s,t]);return Object(O.a)(e,"RoomState.members",o),Object(r.useEffect)(()=>(o(),()=>{i({modifyLevelMax:-1,canEdit:!1,canInvite:!1})}),[o]),n}(o,e,t),k=Object(r.useCallback)(async()=>{const{finished:e}=p.a.createTrackedDialog("Synapse User Deactivation","",q.a,{title:Object(g.a)("Deactivate user?"),description:c.a.createElement("div",null,Object(g.a)("Deactivating this user will log them out and prevent them from logging back in. Additionally, they will leave all the rooms they are in. This action cannot be reversed. Are you sure you want to deactivate this user?")),button:Object(g.a)("Deactivate user"),danger:!0}),[s]=await e;if(s)try{await o.deactivateSynapseUser(t.userId)}catch(e){console.error("Failed to deactivate user"),console.error(e),p.a.createTrackedDialog("Failed to deactivate Synapse user","",G.a,{title:Object(g.a)("Failed to deactivate user"),description:e&&e.message?e.message:Object(g.a)("Operation failed")})}},[o,t.userId]);let R,x,T,A;l&&t.userId.endsWith(":"+C.a.getHomeserverName())&&(R=c.a.createElement(b.a,{onClick:k,className:"mx_UserInfo_field mx_UserInfo_destructive"},Object(g.a)("Deactivate user"))),e&&t.roomId?(f.a.shared().getUserIdForRoomId(t.roomId)||(T=c.a.createElement("div",{className:"mx_UserInfo_container"},c.a.createElement("h3",null,Object(g.a)("Role")),c.a.createElement(ue,{powerLevels:a,user:t,room:e,roomPermissions:w}))),A=c.a.createElement(le,{powerLevels:a,member:t,room:e,startUpdating:E,stopUpdating:S},R)):s?A=c.a.createElement(de,{groupId:s,groupMember:t,startUpdating:E,stopUpdating:S},R):R&&(A=c.a.createElement(ne,null,R)),v>0&&(x=c.a.createElement(F.a,{imgClassName:"mx_ContextualMenu_spinner"}));const M=o.isCryptoEnabled();let U,L;i?_.b.getValue("feature_spaces")&&e.isSpaceRoom()||(U=Object(g.a)("Messages in this room are end-to-end encrypted.")):M?!e||_.b.getValue("feature_spaces")&&e.isSpaceRoom()||(U=Object(g.a)("Messages in this room are not end-to-end encrypted.")):U=Object(g.a)("This client does not support end-to-end encryption.");const B=(e=>Object(j.a)(async()=>e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),[e],!1))(o),V=M&&o.checkUserTrust(t.userId),K=M&&V.isCrossSigningVerified(),W=t.userId===o.getUserId(),H=M&&B&&!K&&!W&&n&&n.length>0,$=function(e,t,s,n){return Object(j.a)(async()=>{if(s){n(!0);try{await e.downloadKeys([t.userId]);const s=e.getStoredCrossSigningForUser(t.userId);return!!(s&&s.getId())}finally{n(!1)}}},[e,t,s],void 0)}(o,t,H,e=>{y(t=>t+(e?1:-1))}),Y=void 0===n;let J;H&&(void 0!==$?L=c.a.createElement(b.a,{className:"mx_UserInfo_field mx_UserInfo_verifyButton",onClick:()=>{$?Object(N.d)(t):Object(N.a)(t)}},Object(g.a)("Verify")):Y||(L=c.a.createElement(F.a,null))),t.userId==o.getUserId()&&(J=c.a.createElement("p",null,c.a.createElement(b.a,{className:"mx_UserInfo_field",onClick:()=>{m.a.dispatch({action:P.a.ViewUserSettings,initialTabId:D.a.Security})}},Object(g.a)("Edit devices"))));const Q=c.a.createElement("div",{className:"mx_UserInfo_container"},c.a.createElement("h3",null,Object(g.a)("Security")),c.a.createElement("p",null,U),L,M&&c.a.createElement(ee,{loading:Y,devices:n,userId:t.userId}),J);return c.a.createElement(c.a.Fragment,null,T,Q,c.a.createElement(te,{canInvite:w.canInvite,isIgnored:d,member:t,isSpace:_.b.getValue("feature_spaces")&&(null==e?void 0:e.isSpaceRoom())}),A,x)},ge=({member:e,e2eStatus:t})=>{const s=Object(r.useContext)(I.a),n=Object(r.useCallback)(()=>{const t=e.getMxcAvatarUrl?e.getMxcAvatarUrl():e.avatarUrl;if(!t)return;const s={src:Object(Q.b)(t).srcHttp,name:e.name||e.displayName};p.a.createDialog(L.a,s,"mx_Dialog_lightbox",null,!0)},[e]),i=c.a.createElement("div",{className:"mx_UserInfo_avatar"},c.a.createElement("div",null,c.a.createElement("div",null,c.a.createElement(V.a,{key:e.userId,member:e,width:.6*X.b.instance.windowHeight,height:.6*X.b.instance.windowHeight,resizeMethod:"scale",fallbackUserId:e.userId,onClick:n,urls:e.avatarUrl?[e.avatarUrl]:void 0}))));let o,a,l,d;e instanceof u.a&&e.user&&(o=e.user.presence,a=e.user.lastActiveAgo,l=e.user.currentlyActive,_.b.getValue("feature_custom_status")&&(d=e.user?e.user.unstable_statusMessage:e.unstable_statusMessage));const h=y.a.get().enable_presence_by_hs_url;let m=!0;h&&void 0!==h[s.baseUrl]&&(m=h[s.baseUrl]);let g=null;m&&(g=c.a.createElement(K.a,{activeAgo:a,currentlyActive:l,presenceState:o}));let v,f=null;d&&(f=c.a.createElement("span",{className:"mx_UserInfo_statusMessage"},d)),t&&(v=c.a.createElement(k.b,{size:18,status:t,isUser:!0}));const b=e.rawDisplayName||e.displayname;return c.a.createElement(c.a.Fragment,null,i,c.a.createElement("div",{className:"mx_UserInfo_container mx_UserInfo_separator"},c.a.createElement("div",{className:"mx_UserInfo_profile"},c.a.createElement("div",null,c.a.createElement("h2",null,v,c.a.createElement("span",{title:b,"aria-label":b},b))),c.a.createElement("div",null,e.userId),c.a.createElement("div",{className:"mx_UserInfo_profileStatus"},g,f))))};t.a=e=>{let{user:t,groupId:s,room:n,onClose:o,phase:l=x.c.RoomMemberInfo}=e,d=a()(e,["user","groupId","room","onClose","phase"]);const u=Object(r.useContext)(I.a),h=Object(r.useMemo)(()=>n&&n.getMember(t.userId)||t,[n,t]),p=Object(A.a)(u,n),v=me(t.userId);let f;p&&v&&(f=((e,t,s)=>{const n=t===e.getUserId(),i=e.checkUserTrust(t);if(!i.isCrossSigningVerified())return i.wasCrossSigningVerified()?U.a.Warning:U.a.Normal;return s.some(s=>{const{deviceId:i}=s,o=e.checkDeviceTrust(t,i);return n?!o.isCrossSigningVerified():!o.isVerified()})?U.a.Warning:U.a.Verified})(u,t.userId,v));const b=["mx_UserInfo"];let y,E;n&&l===x.c.EncryptionPanel?(E=x.c.RoomMemberInfo,y={member:h}):n&&(E=E=_.b.getValue("feature_spaces")&&n.isSpaceRoom()?x.c.SpaceMemberList:x.c.RoomMemberList);const S=()=>{m.a.dispatch({action:P.a.SetRightPanelPhase,phase:E,refireParams:y})};let w;switch(l){case x.c.RoomMemberInfo:case x.c.GroupMemberInfo:case x.c.SpaceMemberInfo:w=c.a.createElement(pe,{room:n,member:h,groupId:s,devices:v,isRoomEncrypted:p});break;case x.c.EncryptionPanel:b.push("mx_UserInfo_smallAvatar"),w=c.a.createElement(T.a,i()({},d,{member:h,onClose:S,isRoomEncrypted:p}))}let C,k=void 0;if(l===x.c.EncryptionPanel){const e=d.verificationRequest;e&&e.pending&&(k=Object(g.a)("Cancel"))}_.b.getValue("feature_spaces")&&null!=n&&n.isSpaceRoom()&&(C=c.a.createElement("div",{className:"mx_RightPanel_scopeHeader"},c.a.createElement(Y.a,{room:n,height:32,width:32}),c.a.createElement(J.a,{room:n})));const O=c.a.createElement(c.a.Fragment,null,C,c.a.createElement(ge,{member:h,e2eStatus:f}));return c.a.createElement(M.b,{className:b.join(" "),header:O,onClose:o,closeLabel:k,previousPhase:E,refireParams:y},w)}},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(216),a=s(423),r=s(618),c=s(94),l=s(137),d=s(131),u=s(99),h=s(95),m=s(92),p=s(96),g=s(103),v=s(126);const f=["m.key_mismatch","m.user_error","m.mismatched_sas"];t.a=e=>{const{verificationRequest:t,verificationRequestPromise:b,member:y,onClose:_,layout:E,isRoomEncrypted:S}=e,[w,C]=Object(n.useState)(t),[k,O]=Object(n.useState)(!1),[R,I]=Object(n.useState)(w&&w.phase);Object(n.useEffect)(()=>{C(t),t&&(O(!1),I(t.phase))},[t]),Object(n.useEffect)(()=>{b&&async function(){O(!0);const e=await b;O(!1),C(e),I(e.phase)}()},[b]);const x=Object(n.useCallback)(()=>{if(w&&w.cancelled&&f.includes(w.cancellationCode)){const e=h.getComponent("dialogs.ErrorDialog");u.a.createTrackedDialog("Verification failed","insecure",e,{headerImage:s(425),title:Object(m.a)("Your messages are not secure"),description:i.a.createElement("div",null,Object(m.a)("One of the following may be compromised:"),i.a.createElement("ul",null,i.a.createElement("li",null,Object(m.a)("Your homeserver")),i.a.createElement("li",null,Object(m.a)("The homeserver the user you’re verifying is connected to")),i.a.createElement("li",null,Object(m.a)("Yours, or the other users’ internet connection")),i.a.createElement("li",null,Object(m.a)("Yours, or the other users’ session")))),onFinished:_})}else w&&I(w.phase)},[_,w]);Object(d.a)(w,"change",x);const T=Object(n.useCallback)(async()=>{O(!0);const e=c.a.get(),t=await Object(l.c)(e,y.userId),s=await e.requestVerificationDM(y.userId,t);C(s),I(s.phase),p.a.dispatch({action:g.a.SetRightPanelPhase,phase:v.c.EncryptionPanel,refireParams:{member:y,verificationRequest:s}})},[y]),j=!w&&k||w&&(R===o.e||R===o.g||void 0===R),N=w?w.isSelfVerification:y.userId===c.a.get().getUserId();if(!w||j){const e=!w&&k||w&&w.initiatedByMe;return i.a.createElement(a.b,{isRoomEncrypted:S,onStartVerification:T,member:y,isSelfVerification:N,waitingForOtherParty:j&&e,waitingForNetwork:j&&!e,inDialog:"dialog"===E})}return i.a.createElement(r.a,{isRoomEncrypted:S,layout:E,onClose:_,member:y,request:w,key:w.channel.transactionId,inDialog:"dialog"===E,phase:R})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n,i,o=s(18),a=s.n(o),r=s(91),c=s.n(r),l=s(94),d=s(95),u=s(312),h=s(275),m=s(424),p=s(92),g=s(102),v=s(206),f=s(216),b=s(119),y=s(93);!function(e){e[e.PHASE_UNSENT=0]="PHASE_UNSENT",e[e.PHASE_REQUESTED=1]="PHASE_REQUESTED",e[e.PHASE_READY=2]="PHASE_READY",e[e.PHASE_DONE=3]="PHASE_DONE",e[e.PHASE_STARTED=4]="PHASE_STARTED",e[e.PHASE_CANCELLED=5]="PHASE_CANCELLED"}(i||(i={}));let _=Object(y.a)("views.right_panel.VerificationPanel")(n=class extends c.a.PureComponent{constructor(e){super(e),a()(this,"hasVerifier",void 0),a()(this,"onReciprocateYesClick",()=>{this.setState({reciprocateButtonClicked:!0}),this.state.reciprocateQREvent.confirm()}),a()(this,"onReciprocateNoClick",()=>{this.setState({reciprocateButtonClicked:!0}),this.state.reciprocateQREvent.cancel()}),a()(this,"startSAS",async()=>{this.setState({emojiButtonClicked:!0});const e=this.props.request.beginKeyVerification(u.d.SAS);try{await e.verify()}catch(e){console.error(e)}}),a()(this,"onSasMatchesClick",()=>{this.state.sasEvent.confirm()}),a()(this,"onSasMismatchesClick",()=>{this.state.sasEvent.mismatch()}),a()(this,"updateVerifierState",()=>{const{request:e}=this.props,{sasEvent:t,reciprocateQREvent:s}=e.verifier;e.verifier.off("show_sas",this.updateVerifierState),e.verifier.off("show_reciprocate_qr",this.updateVerifierState),this.setState({sasEvent:t,reciprocateQREvent:s})}),a()(this,"onRequestChange",async()=>{const{request:e}=this.props,t=this.hasVerifier;if(this.hasVerifier=!!e.verifier,!t&&this.hasVerifier){e.verifier.on("show_sas",this.updateVerifierState),e.verifier.on("show_reciprocate_qr",this.updateVerifierState);try{await e.verifier.verify()}catch(e){console.error("error verify",e)}}}),this.state={},this.hasVerifier=!1}renderQRPhase(){const{member:e,request:t}=this.props,s=t.otherPartySupportsMethod(u.d.SAS),n=t.otherPartySupportsMethod(h.c),i=d.getComponent("elements.AccessibleButton"),o=g.a.get().brand,a=s||n?null:c.a.createElement("p",null,Object(p.a)("The session you are trying to verify doesn't support scanning a QR code or emoji verification, which is what %(brand)s supports. Try with a different client.",{brand:o}));if("dialog"===this.props.layout){let e,o;n&&(e=c.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOption"},c.a.createElement("p",null,Object(p.a)("Scan this unique code")),c.a.createElement(m.a,{qrCodeData:t.qrCodeData}))),s&&(o=c.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOption"},c.a.createElement("p",null,Object(p.a)("Compare unique emoji")),c.a.createElement("span",{className:"mx_VerificationPanel_QRPhase_helpText"},Object(p.a)("Compare a unique set of emoji if you don't have a camera on either device")),c.a.createElement(i,{disabled:this.state.emojiButtonClicked,onClick:this.startSAS,kind:"primary"},Object(p.a)("Start"))));const r=e&&o?c.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_betweenText"},Object(p.a)("or")):null;return c.a.createElement("div",null,Object(p.a)("Verify this session by completing one of the following:"),c.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOptions"},e,r,o,a))}let r,l;if(n&&(r=c.a.createElement("div",{className:"mx_UserInfo_container"},c.a.createElement("h3",null,Object(p.a)("Verify by scanning")),c.a.createElement("p",null,Object(p.a)("Ask %(displayName)s to scan your code:",{displayName:e.displayName||e.name||e.userId})),c.a.createElement("div",{className:"mx_VerificationPanel_qrCode"},c.a.createElement(m.a,{qrCodeData:t.qrCodeData})))),s){const e=this.state.emojiButtonClicked,t=n?Object(p.a)("If you can't scan the code above, verify by comparing unique emoji."):Object(p.a)("Verify by comparing unique emoji.");l=c.a.createElement("div",{className:"mx_UserInfo_container"},c.a.createElement("h3",null,Object(p.a)("Verify by emoji")),c.a.createElement("p",null,t),c.a.createElement(i,{disabled:e,kind:"primary",className:"mx_UserInfo_wideButton mx_VerificationPanel_verifyByEmojiButton",onClick:this.startSAS},Object(p.a)("Verify by emoji")))}const v=a?c.a.createElement("div",{className:"mx_UserInfo_container"},a):null;return c.a.createElement(c.a.Fragment,null,r,l,v)}getDevice(){const e=this.props.request&&this.props.request.channel.deviceId;return l.a.get().getStoredDevice(l.a.get().getUserId(),e)}renderQRReciprocatePhase(){const{member:e,request:t}=this.props,s=d.getComponent("elements.AccessibleButton"),n=t.isSelfVerification?Object(p.a)("Almost there! Is your other session showing the same shield?"):Object(p.a)("Almost there! Is %(displayName)s showing the same shield?",{displayName:e.displayName||e.name||e.userId});let i;return i=this.state.reciprocateQREvent?c.a.createElement(c.a.Fragment,null,c.a.createElement("p",null,n),c.a.createElement(v.b,{isUser:!0,status:"verified",size:128,hideTooltip:!0}),c.a.createElement("div",{className:"mx_VerificationPanel_reciprocateButtons"},c.a.createElement(s,{kind:"danger",disabled:this.state.reciprocateButtonClicked,onClick:this.onReciprocateNoClick},Object(p.a)("No")),c.a.createElement(s,{kind:"primary",disabled:this.state.reciprocateButtonClicked,onClick:this.onReciprocateYesClick},Object(p.a)("Yes")))):c.a.createElement("p",null,c.a.createElement(b.a,null)),c.a.createElement("div",{className:"mx_UserInfo_container mx_VerificationPanel_reciprocate_section"},c.a.createElement("h3",null,Object(p.a)("Verify by scanning")),i)}renderVerifiedPhase(){const{member:e,request:t}=this.props;let s,n;if(t.isSelfVerification||(s=this.props.isRoomEncrypted?Object(p.a)("Verify all users in a room to ensure it's secure."):Object(p.a)("In encrypted rooms, verify all users to ensure it’s secure.")),t.isSelfVerification){const e=this.getDevice();e?n=Object(p.a)("You've successfully verified %(deviceName)s (%(deviceId)s)!",{deviceName:e?e.getDisplayName():"",deviceId:this.props.request.channel.deviceId}):(console.warn("Verified device we don't know about: "+this.props.request.channel.deviceId),n=Object(p.a)("You've successfully verified your device!"))}else n=Object(p.a)("You've successfully verified %(displayName)s!",{displayName:e.displayName||e.name||e.userId});const i=d.getComponent("elements.AccessibleButton");return c.a.createElement("div",{className:"mx_UserInfo_container mx_VerificationPanel_verified_section"},c.a.createElement("h3",null,Object(p.a)("Verified")),c.a.createElement("p",null,n),c.a.createElement(v.b,{isUser:!0,status:"verified",size:128,hideTooltip:!0}),s?c.a.createElement("p",null,s):null,c.a.createElement(i,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:this.props.onClose},Object(p.a)("Got it")))}renderCancelledPhase(){const{member:e,request:t}=this.props,s=d.getComponent("elements.AccessibleButton");let n,i;return n=t.isSelfVerification?Object(p.a)("Start verification again from the notification."):Object(p.a)("Start verification again from their profile."),"m.timeout"===t.cancellationCode?i=Object(p.a)("Verification timed out.")+" "+n:t.cancellingUserId===t.otherUserId?(i=t.isSelfVerification?Object(p.a)("You cancelled verification on your other session."):Object(p.a)("%(displayName)s cancelled verification.",{displayName:e.displayName||e.name||e.userId}),i=`${i} ${n}`):i=Object(p.a)("You cancelled verification.")+" "+n,c.a.createElement("div",{className:"mx_UserInfo_container"},c.a.createElement("h3",null,Object(p.a)("Verification cancelled")),c.a.createElement("p",null,i),c.a.createElement(s,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:this.props.onClose},Object(p.a)("Got it")))}render(){const{member:e,phase:t,request:s}=this.props,n=e.displayName||e.name||e.userId;switch(t){case f.d:return this.renderQRPhase();case f.f:switch(s.chosenMethod){case u.d.RECIPROCATE_QR_CODE:return this.renderQRReciprocatePhase();case u.d.SAS:{const e=d.getComponent("views.verification.VerificationShowSas"),t=this.state.sasEvent?c.a.createElement(e,{displayName:n,device:this.getDevice(),sas:this.state.sasEvent.sas,onCancel:this.onSasMismatchesClick,onDone:this.onSasMatchesClick,inDialog:this.props.inDialog,isSelf:s.isSelfVerification}):c.a.createElement(b.a,null);return c.a.createElement("div",{className:"mx_UserInfo_container"},c.a.createElement("h3",null,Object(p.a)("Compare emoji")),t)}default:return null}case f.c:return this.renderVerifiedPhase();case f.b:return this.renderCancelledPhase()}return console.error("VerificationPanel unhandled phase:",t),null}componentDidMount(){const{request:e}=this.props;if(e.on("change",this.onRequestChange),e.verifier){const{sasEvent:t,reciprocateQREvent:s}=e.verifier;this.setState({sasEvent:t,reciprocateQREvent:s})}this.onRequestChange()}componentWillUnmount(){const{request:e}=this.props;e.verifier&&(e.verifier.off("show_sas",this.updateVerifierState),e.verifier.off("show_reciprocate_qr",this.updateVerifierState)),e.off("change",this.onRequestChange)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return P}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(92),u=s(620),h=s(98),m=s(624),p=s(625),g=s(100),v=s(627),f=s(97),b=s.n(f),y=s(118),_=s(94),E=s(95),S=s(99),w=s(96),C=s(277),k=s(199),O=s(200),R=s(238),I=s(640),x=s(119),T=s(106),j=s(116),N=s(93);let P=Object(N.a)("views.settings.tabs.user.GeneralUserSettingsTab")((o=i=class extends l.a.Component{constructor(){super(),r()(this,"_onAction",e=>{"id_server_changed"===e.action&&(this.setState({haveIdServer:Boolean(_.a.get().getIdentityServerUrl())}),this._getThreepidState())}),r()(this,"_onEmailsChange",e=>{this.setState({emails:e})}),r()(this,"_onMsisdnsChange",e=>{this.setState({msisdns:e})}),r()(this,"_onLanguageChange",e=>{if(this.state.language===e)return;h.b.setValue("language",null,T.a.DEVICE,e),this.setState({language:e});const t=y.a.get();t&&(t.setLanguage(e),t.reload())}),r()(this,"_onSpellCheckLanguagesChange",e=>{this.setState({spellCheckLanguages:e});const t=y.a.get();t&&t.setSpellCheckLanguages(e)}),r()(this,"_onPasswordChangeError",e=>{let t=e.error||e.message||"";403===e.httpStatus?t=Object(d.a)("Failed to change password. Is your password correct?"):t||(t+=` (HTTP status ${e.httpStatus})`);const s=E.getComponent("dialogs.ErrorDialog");console.error("Failed to change password: "+t),S.a.createTrackedDialog("Failed to change password","",s,{title:Object(d.a)("Error"),description:t})}),r()(this,"_onPasswordChanged",()=>{const e=E.getComponent("dialogs.ErrorDialog");S.a.createTrackedDialog("Password changed","",e,{title:Object(d.a)("Success"),description:Object(d.a)("Your password was successfully changed. You will not receive push notifications on other sessions until you log back in to them")+"."})}),r()(this,"_onDeactivateClicked",()=>{S.a.createTrackedDialog("Deactivate Account","",v.a,{onFinished:e=>{e&&this.props.closeSettingsFn()}})}),this.state={language:d.d(),spellCheckLanguages:[],haveIdServer:Boolean(_.a.get().getIdentityServerUrl()),serverSupportsSeparateAddAndBind:null,idServerHasUnsignedTerms:!1,requiredPolicyInfo:{hasTerms:!1},emails:[],msisdns:[],loading3pids:!0},this.dispatcherRef=w.a.register(this._onAction)}async UNSAFE_componentWillMount(){const e=_.a.get(),t=await e.doesServerSupportSeparateAddAndBind(),s=(await e.getCapabilities())["m.change_password"],n=!s||!1!==s.enabled;this.setState({serverSupportsSeparateAddAndBind:t,canChangePassword:n}),this._getThreepidState()}async componentDidMount(){const e=y.a.get();e&&this.setState({spellCheckLanguages:await e.getSpellCheckLanguages()})}componentWillUnmount(){w.a.unregister(this.dispatcherRef)}async _getThreepidState(){const e=_.a.get();this._checkTerms();let t=[];try{t=await Object(I.a)(e)}catch(e){const t=_.a.get().getIdentityServerUrl();console.warn(`Unable to reach identity server at ${t} to check for 3PIDs bindings in Settings`),console.warn(e)}this.setState({emails:t.filter(e=>"email"===e.medium),msisdns:t.filter(e=>"msisdn"===e.medium),loading3pids:!1})}async _checkTerms(){if(!this.state.haveIdServer)return void this.setState({idServerHasUnsignedTerms:!1});const e=_.a.get().getIdentityServerUrl(),t=new O.a;try{const s=await t.getAccessToken({check:!1});await Object(C.d)([new C.a(k.a.IS,e,s)],(t,s,n)=>new Promise((n,i)=>{this.setState({idServerName:Object(R.a)(e),requiredPolicyInfo:{hasTerms:!0,policiesAndServices:t,agreedUrls:s,resolve:n}})})),this.setState({requiredPolicyInfo:{hasTerms:!1}})}catch(t){console.warn(`Unable to reach identity server at ${e} to check for terms in Settings`),console.warn(t)}}_renderProfileSection(){return l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement(u.a,null))}_renderAccountSection(){const e=E.getComponent("views.settings.ChangePassword"),t=E.getComponent("views.settings.account.EmailAddresses"),s=E.getComponent("views.settings.account.PhoneNumbers");let n=l.a.createElement(e,{className:"mx_GeneralUserSettingsTab_changePassword",rowClassName:"",buttonKind:"primary",onError:this._onPasswordChangeError,onFinished:this._onPasswordChanged}),i=null;if(h.b.getValue(j.a.ThirdPartyID)&&(this.state.haveIdServer||!0===this.state.serverSupportsSeparateAddAndBind)){const e=this.state.loading3pids?l.a.createElement(x.a,null):l.a.createElement(t,{emails:this.state.emails,onEmailsChange:this._onEmailsChange}),n=this.state.loading3pids?l.a.createElement(x.a,null):l.a.createElement(s,{msisdns:this.state.msisdns,onMsisdnsChange:this._onMsisdnsChange});i=l.a.createElement("div",null,l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Email addresses")),e,l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Phone numbers")),n)}else null===this.state.serverSupportsSeparateAddAndBind&&(i=l.a.createElement(x.a,null));let o=Object(d.a)("Set a new account password...");return this.state.canChangePassword||(o=null,n=null),l.a.createElement("div",{className:"mx_SettingsTab_section mx_GeneralUserSettingsTab_accountSection"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Account")),l.a.createElement("p",{className:"mx_SettingsTab_subsectionText"},o),n,i)}_renderLanguageSection(){return l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Language and region")),l.a.createElement(m.a,{className:"mx_GeneralUserSettingsTab_languageInput",onOptionChange:this._onLanguageChange,value:this.state.language}))}_renderSpellCheckSection(){return l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Spell check dictionaries")),l.a.createElement(p.a,{languages:this.state.spellCheckLanguages,onLanguagesChange:this._onSpellCheckLanguagesChange}))}_renderDiscoverySection(){const e=E.getComponent("views.settings.SetIdServer");if(this.state.requiredPolicyInfo.hasTerms){const t=E.getComponent("views.terms.InlineTermsAgreement"),s=l.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(d.a)("Agree to the identity server (%(serverName)s) Terms of Service to allow yourself to be discoverable by email address or phone number.",{serverName:this.state.idServerName}));return l.a.createElement("div",null,l.a.createElement(t,{policiesAndServicePairs:this.state.requiredPolicyInfo.policiesAndServices,agreedUrls:this.state.requiredPolicyInfo.agreedUrls,onFinished:this.state.requiredPolicyInfo.resolve,introElement:s}),l.a.createElement(e,{missingTerms:!0}))}const t=E.getComponent("views.settings.discovery.EmailAddresses"),s=E.getComponent("views.settings.discovery.PhoneNumbers"),n=this.state.loading3pids?l.a.createElement(x.a,null):l.a.createElement(t,{emails:this.state.emails}),i=this.state.loading3pids?l.a.createElement(x.a,null):l.a.createElement(s,{msisdns:this.state.msisdns}),o=this.state.haveIdServer?l.a.createElement("div",{className:"mx_GeneralUserSettingsTab_discovery"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Email addresses")),n,l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Phone numbers")),i):null;return l.a.createElement("div",{className:"mx_SettingsTab_section"},o,l.a.createElement(e,null))}_renderManagementSection(){return l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Account management")),l.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(d.a)("Deactivating your account is a permanent action - be careful!")),l.a.createElement(g.a,{onClick:this._onDeactivateClicked,kind:"danger"},Object(d.a)("Deactivate Account")))}_renderIntegrationManagerSection(){if(!h.b.getValue(j.a.Widgets))return null;const e=E.getComponent("views.settings.SetIntegrationManager");return l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement(e,null))}render(){const e=y.a.get().supportsMultiLanguageSpellCheck(),t=this.state.requiredPolicyInfo.hasTerms?l.a.createElement("img",{className:"mx_GeneralUserSettingsTab_warningIcon",src:s(641),width:"18",height:"18",alt:Object(d.a)("Warning")}):null;let n,i;return h.b.getValue(j.a.Deactivate)&&(n=l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(d.a)("Deactivate account")),this._renderManagementSection())),h.b.getValue(j.a.IdentityServer)&&(i=l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"mx_SettingsTab_heading"},t," ",Object(d.a)("Discovery")),this._renderDiscoverySection())),l.a.createElement("div",{className:"mx_SettingsTab"},l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(d.a)("General")),this._renderProfileSection(),this._renderAccountSection(),this._renderLanguageSection(),e?this._renderSpellCheckSection():null,i,this._renderIntegrationManagerSection(),n)}},r()(i,"propTypes",{closeSettingsFn:b.a.func.isRequired}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(94),d=s(112),u=s(621),h=s(95),m=s(212),p=s(99),g=s(135),v=s(93),f=s(107);let b=Object(v.a)("views.settings.ProfileSettings")(n=class extends r.a.Component{constructor(){super(),o()(this,"_uploadAvatar",()=>{this._avatarUpload.current.click()}),o()(this,"_removeAvatar",()=>{this._avatarUpload.current.value="",this.setState({avatarUrl:null,avatarFile:null,enableProfileSave:!0})}),o()(this,"_cancelProfileChanges",async e=>{e.stopPropagation(),e.preventDefault(),this.state.enableProfileSave&&this.setState({enableProfileSave:!1,displayName:this.state.originalDisplayName,avatarUrl:this.state.originalAvatarUrl,avatarFile:null})}),o()(this,"_saveProfile",async e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.enableProfileSave)return;this.setState({enableProfileSave:!1});const t=l.a.get(),s={},n=this.state.displayName.trim();try{if(this.state.originalDisplayName!==this.state.displayName&&(await t.setDisplayName(n),s.originalDisplayName=n,s.displayName=n),this.state.avatarFile){console.log(`Uploading new avatar, ${this.state.avatarFile.name} of type ${this.state.avatarFile.type}, (${this.state.avatarFile.size}) bytes`);const e=await t.uploadContent(this.state.avatarFile);await t.setAvatarUrl(e),s.avatarUrl=Object(f.b)(e).getSquareThumbnailHttp(96),s.originalAvatarUrl=s.avatarUrl,s.avatarFile=null}else this.state.originalAvatarUrl!==this.state.avatarUrl&&await t.setAvatarUrl("")}catch(e){console.log("Failed to save profile",e),p.a.createTrackedDialog("Failed to save profile","",g.a,{title:Object(c.a)("Failed to save your profile"),description:e&&e.message?e.message:Object(c.a)("The operation could not be completed")})}this.setState(s)}),o()(this,"_onDisplayNameChanged",e=>{this.setState({displayName:e.target.value,enableProfileSave:!0})}),o()(this,"_onAvatarChanged",e=>{if(!e.target.files||!e.target.files.length)return void this.setState({avatarUrl:this.state.originalAvatarUrl,avatarFile:null,enableProfileSave:!1});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarUrl:e.target.result,avatarFile:t,enableProfileSave:!0})},s.readAsDataURL(t)});const e=l.a.get();let t=m.a.instance.avatarMxc;t&&(t=Object(f.b)(t).getSquareThumbnailHttp(96)),this.state={userId:e.getUserId(),originalDisplayName:m.a.instance.displayName,displayName:m.a.instance.displayName,originalAvatarUrl:t,avatarUrl:t,avatarFile:null,enableProfileSave:!1},this._avatarUpload=Object(a.createRef)()}render(){const e=Object(u.a)("user-settings");let t=null;e&&(t=r.a.createElement("span",{className:"mx_ProfileSettings_hostingSignup"},Object(c.a)("<a>Upgrade</a> to your own domain",{},{a:t=>r.a.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)}),r.a.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},r.a.createElement("img",{src:s(623),width:"11",height:"10",alt:""}))));const n=h.getComponent("elements.AccessibleButton"),i=h.getComponent("settings.AvatarSetting");return r.a.createElement("form",{onSubmit:this._saveProfile,autoComplete:"off",noValidate:!0,className:"mx_ProfileSettings_profileForm"},r.a.createElement("input",{type:"file",ref:this._avatarUpload,className:"mx_ProfileSettings_avatarUpload",onChange:this._onAvatarChanged,accept:"image/*"}),r.a.createElement("div",{className:"mx_ProfileSettings_profile"},r.a.createElement("div",{className:"mx_ProfileSettings_controls"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Profile")),r.a.createElement(d.a,{label:Object(c.a)("Display Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this._onDisplayNameChanged}),r.a.createElement("p",null,this.state.userId,t)),r.a.createElement(i,{avatarUrl:this.state.avatarUrl,avatarName:this.state.displayName||this.state.userId,avatarAltText:Object(c.a)("Profile picture"),uploadAvatar:this._uploadAvatar,removeAvatar:this._removeAvatar})),r.a.createElement("div",{className:"mx_ProfileSettings_buttons"},r.a.createElement(n,{onClick:this._cancelProfileChanges,kind:"link",disabled:!this.state.enableProfileSave},Object(c.a)("Cancel")),r.a.createElement(n,{onClick:this._saveProfile,kind:"primary",disabled:!this.state.enableProfileSave},Object(c.a)("Save"))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(136),i=s.n(n),o=s(1004),a=s.n(o),r=s(102),c=s(94);function l(e){const t=r.a.get().hosting_signup_link;if(!t)return null;if(!e)return t;if("matrix.org"!==c.a.get().getDomain())return null;try{const s=i.a.parse(t),n=a.a.parse(s.query);return n.utm_campaign=e,s.search=void 0,s.query=n,s.format()}catch(e){return t}}},,function(e,t){e.exports="img/external-link.a8d3e9b.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i=s(91),o=s.n(i),a=s(97),r=s.n(a),c=s(95),l=s(92),d=s(98),u=s(93);let h=Object(u.a)("views.elements.LanguageDropdown")(n=class extends o.a.Component{constructor(e){super(e),this._onSearchChange=this._onSearchChange.bind(this),this.state={searchQuery:"",langs:null}}componentDidMount(){if(l.c().then(e=>{e.sort((function(e,t){return e.label<t.label?-1:e.label>t.label?1:0})),this.setState({langs:e})}).catch(()=>{this.setState({langs:["en"]})}),!this.props.value){const e=l.g();this.props.onOptionChange(e)}}_onSearchChange(e){this.setState({searchQuery:e})}render(){if(null===this.state.langs){const e=c.getComponent("elements.Spinner");return o.a.createElement(e,null)}const e=c.getComponent("elements.Dropdown");let t;t=this.state.searchQuery?this.state.langs.filter(e=>function(e,t){return!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e)):this.state.langs;const s=t.map(e=>o.a.createElement("div",{key:e.value},e.label));let n=d.b.getValue("language",null,!0),i=null;return n||(n=navigator.language||navigator.userLanguage),i=this.props.value||n,o.a.createElement(e,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this._onSearchChange,searchEnabled:!0,value:i,label:Object(l.a)("Language Dropdown"),disabled:this.props.disabled},s)}})||n;h.propTypes={className:r.a.string,onOptionChange:r.a.func.isRequired,value:r.a.string}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(626),l=s(100),d=s(92),u=s(93);class h extends r.a.Component{constructor(...e){super(...e),o()(this,"_onRemove",e=>(e.stopPropagation(),e.preventDefault(),this.props.onRemoved(this.props.language)))}render(){return r.a.createElement("div",{className:"mx_ExistingSpellCheckLanguage"},r.a.createElement("span",{className:"mx_ExistingSpellCheckLanguage_language"},this.props.language),r.a.createElement(l.a,{onClick:this._onRemove,kind:"danger_sm"},Object(d.a)("Remove")))}}let m=Object(u.a)("views.settings.SpellCheckLanguages")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"_onRemoved",e=>{const t=this.props.languages.filter(t=>t!==e);this.props.onLanguagesChange(t)}),o()(this,"_onAddClick",e=>{e.stopPropagation(),e.preventDefault();const t=this.state.newLanguage;t&&(this.props.languages.includes(t)||(this.props.languages.push(t),this.props.onLanguagesChange(this.props.languages)))}),o()(this,"_onNewLanguageChange",e=>{this.state.newLanguage!==e&&this.setState({newLanguage:e})}),this.state={newLanguage:""}}render(){const e=this.props.languages.map(e=>r.a.createElement(h,{language:e,onRemoved:this._onRemoved,key:e})),t=r.a.createElement(l.a,{onClick:this._onAddClick,kind:"primary"},Object(d.a)("Add"));return r.a.createElement("div",{className:"mx_SpellCheckLanguages"},e,r.a.createElement("form",{onSubmit:this._onAddClick,noValidate:!0},r.a.createElement(c.a,{className:"mx_GeneralUserSettingsTab_spellCheckLanguageInput",value:this.state.newLanguage,onOptionChange:this._onNewLanguageChange}),t))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i=s(91),o=s.n(i),a=s(427),r=s(95),c=s(118),l=s(98),d=s(92),u=s(93);let h=Object(u.a)("views.elements.SpellCheckLanguagesDropdown")(n=class extends o.a.Component{constructor(e){super(e),this._onSearchChange=this._onSearchChange.bind(this),this.state={searchQuery:"",languages:null}}componentDidMount(){const e=c.a.get();e&&e.getAvailableSpellCheckLanguages().then(e=>{e.sort((function(e,t){return e<t?-1:e>t?1:0}));const t=[];e.forEach(e=>{t.push({label:e,value:e})}),this.setState({languages:t})}).catch(e=>{this.setState({languages:["en"]})})}_onSearchChange(e){this.setState({searchQuery:e})}render(){if(null===this.state.languages){const e=r.getComponent("elements.Spinner");return o.a.createElement(e,null)}let e;e=this.state.searchQuery?this.state.languages.filter(e=>function(e,t){return!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e)):this.state.languages;const t=e.map(e=>o.a.createElement("div",{key:e.value},e.label));let s=l.b.getValue("language",null,!0),n=null;return s||(s=navigator.language||navigator.userLanguage),n=this.props.value||s,o.a.createElement(a.a,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this._onSearchChange,searchEnabled:!0,value:n,label:Object(d.a)("Language Dropdown")},t)}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(95),l=s(132),d=s(94),u=s(287),h=s(92),m=s(436),p=s(209),g=s(148),v=s(93);let f=Object(v.a)("views.dialogs.DeactivateAccountDialog")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"onStagePhaseChange",(e,t)=>{const s={[p.c.PHASE_PREAUTH]:{body:Object(h.a)("Confirm your account deactivation by using Single Sign On to prove your identity."),continueText:Object(h.a)("Single Sign On"),continueKind:"danger"},[p.c.PHASE_POSTAUTH]:{body:Object(h.a)("Are you sure you want to deactivate your account? This is irreversible."),continueText:Object(h.a)("Confirm account deactivation"),continueKind:"danger"}},n={[p.c.LOGIN_TYPE]:s,[p.c.UNSTABLE_LOGIN_TYPE]:s,[p.b.LOGIN_TYPE]:{[p.a]:{body:Object(h.a)("To continue, please enter your password:")}}}[e];let i=null,o=null,a=null;if(n){const e=n[t];e&&e.body&&(i=e.body),e&&e.continueText&&(o=e.continueText),e&&e.continueKind&&(a=e.continueKind)}this.setState({bodyText:i,continueText:o,continueKind:a})}),o()(this,"onUIAuthFinished",(e,t)=>{e||(t!==m.a?(console.error("Error during UI Auth:",{result:t}),this.setState({errStr:Object(h.a)("There was a problem communicating with the server. Please try again.")})):this.onCancel())}),o()(this,"onUIAuthComplete",e=>{d.a.get().deactivateAccount(e,this.state.shouldErase).then(e=>{l.a.trackEvent("Account","Deactivate Account"),u.j(),this.props.onFinished(!0)}).catch(e=>{console.error(e),this.setState({errStr:Object(h.a)("There was a problem communicating with the server. Please try again.")})})}),o()(this,"onEraseFieldChange",e=>{this.setState({shouldErase:e.currentTarget.checked,authEnabled:!1}),this.initAuth(e.currentTarget.checked)}),this.state={shouldErase:!1,errStr:null,authData:null,authEnabled:!0,bodyText:null,continueText:null,continueKind:null},this.initAuth(!1)}onCancel(){this.props.onFinished(!1)}initAuth(e){d.a.get().deactivateAccount(null,e).then(e=>{console.warn("User's account got deactivated without confirmation: Server had no auth"),this.setState({errStr:Object(h.a)("Server did not require any authentication")})}).catch(e=>{e&&401===e.httpStatus&&e.data?this.setState({authData:e.data,authEnabled:!0}):this.setState({errStr:Object(h.a)("Server did not return valid authentication information.")})})}render(){const e=c.getComponent("views.dialogs.BaseDialog");let t=null;this.state.errStr&&(t=r.a.createElement("div",{className:"error"},this.state.errStr));let s=r.a.createElement("div",null,Object(h.a)("Loading..."));return this.state.authData&&this.state.authEnabled&&(s=r.a.createElement("div",null,this.state.bodyText,r.a.createElement(m.b,{matrixClient:d.a.get(),authData:this.state.authData,makeRequest:this.onUIAuthComplete,onAuthFinished:this.onUIAuthFinished,onStagePhaseChange:this.onStagePhaseChange,continueText:this.state.continueText,continueKind:this.state.continueKind}))),r.a.createElement(e,{className:"mx_DeactivateAccountDialog",onFinished:this.props.onFinished,titleClass:"danger",title:Object(h.a)("Deactivate Account")},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement("p",null,Object(h.a)("This will make your account permanently unusable. You will not be able to log in, and no one will be able to re-register the same user ID. This will cause your account to leave all rooms it is participating in, and it will remove your account details from your identity server. <b>This action is irreversible.</b>",{},{b:e=>r.a.createElement("b",null," ",e," ")})),r.a.createElement("p",null,Object(h.a)("Deactivating your account <b>does not by default cause us to forget messages you have sent.</b> If you would like us to forget your messages, please tick the box below.",{},{b:e=>r.a.createElement("b",null," ",e," ")})),r.a.createElement("p",null,Object(h.a)("Message visibility in Matrix is similar to email. Our forgetting your messages means that messages you have sent will not be shared with any new or unregistered users, but registered users who already have access to these messages will still have access to their copy.")),r.a.createElement("div",{className:"mx_DeactivateAccountDialog_input_section"},r.a.createElement("p",null,r.a.createElement(g.a,{checked:this.state.shouldErase,onChange:this.onEraseFieldChange},Object(h.a)("Please forget all messages I have sent when my account is deactivated (<b>Warning:</b> this will cause future users to see an incomplete view of conversations)",{},{b:e=>r.a.createElement("b",null,e)}))),t,s)))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(18),i=s.n(n),o=s(152),a=s(160),r=s(394),c=s(319);function l(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function d(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?l(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):l(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const u=window.localStorage;let h;try{h=window.indexedDB}catch(e){}function m(e){const t={useAuthorizationHeader:!0};return h&&u&&(t.store=new c.a({indexedDB:h,dbName:"riot-web-sync",localStorage:u,workerScript:m.indexedDbWorkerScript})),u&&(t.sessionStore=new r.a(u)),h&&(t.cryptoStore=new a.a(h,"matrix-js-sdk:crypto")),Object(o.createClient)(d(d({},t),e))}m.indexedDbWorkerScript=null},function(e,t,s){"use strict";s.d(t,"c",(function(){return a})),s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(164),i=s(94),o=s(263);function a(){const e=new o.a(i.a.get()).getPushRuleById(".m.rule.master");return e?e.enabled&&!e.actions.includes("notify"):(console.warn("No master push rule! Notifications are disabled for this user."),!0)}function r(){let e=s(253);return e.default&&(e=e.default),e}class c extends n.a{getValueOverride(e,t,s,n){return!!r().isPossible()&&(null===s||"default"===n?!a():s)}onChange(e,t,s){r().supportsDesktopNotifications()&&r().setEnabled(s)}}class l extends n.a{getValueOverride(e,t,s){return!!r().isPossible()&&(null===s?!a():s)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(18),i=s.n(n),o=s(94),a=s(98),r=s(254);class c{constructor(){i()(this,"typingStates",void 0),this.reset()}static sharedInstance(){return void 0===window.mxTypingStore&&(window.mxTypingStore=new c),window.mxTypingStore}reset(){this.typingStates={}}setSelfTyping(e,t){if(!a.b.getValue("sendTypingNotifications"))return;if(a.b.getValue("lowBandwidth"))return;let s=this.typingStates[e];!t&&!s||s&&s.isTyping===t||(s||(s=this.typingStates[e]={isTyping:t,serverTimer:new r.a(3e4),userTimer:new r.a(1e4)}),s.isTyping=t,t&&(s.serverTimer.isRunning()?s.serverTimer.restart():s.serverTimer.restart().finished().then(()=>{const t=this.typingStates[e];t&&(t.isTyping=!1)}),s.userTimer.isRunning()?s.userTimer.restart():s.userTimer.restart().finished().then(()=>{this.setSelfTyping(e,!1)})),o.a.get().sendTyping(e,t,3e4))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(430),l=s(124),d=s(92),u=s(432),h=s(93);function m(e){return e===u.a.Done?s(1008):s(425)}let p=Object(h.a)("views.dialogs.security.SetupEncryptionDialog")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"store",void 0),o()(this,"onStoreUpdate",()=>{this.setState({icon:m(this.store.phase)})}),this.store=u.b.sharedInstance(),this.state={icon:m(this.store.phase)}}componentDidMount(){this.store.on("update",this.onStoreUpdate)}componentWillUnmount(){this.store.removeListener("update",this.onStoreUpdate)}render(){return r.a.createElement(l.a,{headerImage:this.state.icon,onFinished:this.props.onFinished,title:Object(d.a)("Verify this session")},r.a.createElement(c.a,{onFinished:this.props.onFinished}))}})||n},function(e,t,s){"use strict";t.a={HomePage:"home_page",RoomView:"room_view",RoomDirectory:"room_directory",UserView:"user_view",GroupView:"group_view",MyGroups:"my_groups"}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return c}));var n=s(96),i=s(95),o=s(99),a=s(92);const r=/^[a-z0-9=_\-./]+$/;async function c(e){void 0===e&&(e={});const t=i.getComponent("dialogs.QuestionDialog"),s=o.a.createTrackedDialog("Registration required","",t,{hasCancelButton:!0,quitOnly:!0,title:Object(a.a)("Sign In or Create Account"),description:Object(a.a)("Use your account or create a new one to continue."),button:Object(a.a)("Create Account"),extraButtons:[React.createElement("button",{key:"start_login",onClick:()=>{s.close(),n.a.dispatch({action:"start_login",screenAfterLogin:e.screen_after})}},Object(a.a)("Sign In"))],onFinished:t=>{t?n.a.dispatch({action:"start_registration",screenAfterLogin:e.screen_after}):e.go_home_on_cancel?n.a.dispatch({action:"view_home_page"}):e.go_welcome_on_cancel&&n.a.dispatch({action:"view_welcome_page"})}})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(18),i=s.n(n),o=s(8),a=s(117);class r extends o.EventEmitter{constructor(...e){super(...e),i()(this,"_isResizing",!1),i()(this,"throttledMiddlePanel",Object(a.throttle)(()=>this.emit("middlePanelResized"),200))}get isResizing(){return this._isResizing}startResizing(){this._isResizing=!0,this.emit("isResizing",!0)}stopResizing(){this._isResizing=!1,this.emit("isResizing",!1)}noisyMiddlePanel(){this.emit("middlePanelResizedNoisy")}updateMiddlePanel(){this.throttledMiddlePanel(),this.noisyMiddlePanel()}notifyLeftHandleResized(){this.updateMiddlePanel()}notifyRightHandleResized(){this.updateMiddlePanel()}notifyTimelineHeightChanged(){this.updateMiddlePanel()}notifyWindowResized(){this.updateMiddlePanel()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(18),i=s.n(n),o=s(96),a=s(98),r=s(298),c=s(103),l=s(106);class d{constructor(){i()(this,"dispatcherRef",void 0),i()(this,"onAction",e=>{e.action===c.a.UpdateFontSize?this.setRootFontSize(e.size):e.action===c.a.UpdateSystemFont&&this.setSystemFont(e)}),i()(this,"setRootFontSize",e=>{const t=Math.max(Math.min(d.MAX_SIZE,e),d.MIN_SIZE);t!==e&&a.b.setValue("baseFontSize",null,l.a.DEVICE,t),document.querySelector(":root").style.fontSize=Object(r.a)(t)}),i()(this,"setSystemFont",({useSystemFont:e,font:t})=>{document.body.style.fontFamily=e?t:""}),this.dispatcherRef=null}start(){this.setRootFontSize(a.b.getValue("baseFontSize")),this.setSystemFont({useSystemFont:a.b.getValue("useSystemFont"),font:a.b.getValue("systemFont")}),this.dispatcherRef=o.a.register(this.onAction)}stop(){o.a.unregister(this.dispatcherRef)}}i()(d,"MIN_SIZE",8),i()(d,"MAX_SIZE",15),i()(d,"SIZE_DIFF",5)},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(124),l=s(92),d=s(112),u=s(100),h=s(94),m=s(433),p=s(96),g=s(157),v=s(128),f=s(93);let b=Object(f.a)("views.dialogs.CreateCommunityPrototypeDialog")(n=class extends r.a.PureComponent{constructor(e){super(e),o()(this,"avatarUploadRef",r.a.createRef()),o()(this,"onNameChange",e=>{const t=(e.target.value||"").toLowerCase().replace(/[^a-z0-9.\-_]/g,"-");this.setState({name:e.target.value,localpart:t})}),o()(this,"onSubmit",async e=>{if(e.preventDefault(),e.stopPropagation(),!this.state.busy){this.setState({busy:!0});try{let e="";this.state.avatarFile&&(e=await h.a.get().uploadContent(this.state.avatarFile));const t=await h.a.get().createGroup({localpart:this.state.localpart,profile:{name:this.state.name,avatar_url:e}});p.a.dispatch({action:"deselect_tags"},!0),p.a.dispatch({action:"select_tag",tag:t.group_id}),this.props.onFinished(!0),t.room_id?(await v.a.refreshGroupRooms(t.group_id),p.a.dispatch({action:"view_room",room_id:t.room_id}),Object(g.f)(t.room_id,this.state.name)):p.a.dispatch({action:"view_group",group_id:t.group_id,group_is_new:!0})}catch(e){console.error(e),this.setState({busy:!1,error:Object(l.a)("There was an error creating your community. The name may be taken or the server is unable to process your request.")})}}}),o()(this,"onAvatarChanged",e=>{if(e.target.files&&e.target.files.length){this.setState({busy:!0});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarFile:t,busy:!1,avatarPreview:e.target.result})},s.readAsDataURL(t)}else this.setState({avatarFile:null})}),o()(this,"onChangeAvatar",()=>{this.avatarUploadRef.current&&this.avatarUploadRef.current.click()}),this.state={name:"",localpart:"",error:null,busy:!1,avatarFile:null,avatarPreview:null}}render(){let e=null;this.state.localpart&&(e=r.a.createElement("span",{className:"mx_CreateCommunityPrototypeDialog_communityId"},Object(l.a)("Community ID: +<localpart />:%(domain)s",{domain:h.a.getHomeserverName()},{localpart:()=>r.a.createElement("u",null,this.state.localpart)}),r.a.createElement(m.a,{tooltip:Object(l.a)("Use this when referencing your community to others. The community ID cannot be changed.")})));let t=r.a.createElement("span",{className:"mx_CreateCommunityPrototypeDialog_subtext"},Object(l.a)("You can change this later if needed."));if(this.state.error){const e="mx_CreateCommunityPrototypeDialog_subtext mx_CreateCommunityPrototypeDialog_subtext_error";t=r.a.createElement("span",{className:e},this.state.error)}let s=r.a.createElement("img",{src:this.state.avatarPreview,className:"mx_CreateCommunityPrototypeDialog_avatar"});return this.state.avatarPreview||(s=r.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_placeholderAvatar"})),r.a.createElement(c.a,{className:"mx_CreateCommunityPrototypeDialog",onFinished:this.props.onFinished,title:Object(l.a)("What's the name of your community or team?")},r.a.createElement("form",{onSubmit:this.onSubmit},r.a.createElement("div",{className:"mx_Dialog_content"},r.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_colName"},r.a.createElement(d.a,{value:this.state.name,onChange:this.onNameChange,placeholder:Object(l.a)("Enter name"),label:Object(l.a)("Enter name")}),t,r.a.createElement("span",{className:"mx_CreateCommunityPrototypeDialog_subtext"}," ",e),r.a.createElement(u.a,{kind:"primary",onClick:this.onSubmit,disabled:this.state.busy},Object(l.a)("Create"))),r.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_colAvatar"},r.a.createElement("input",{type:"file",style:{display:"none"},ref:this.avatarUploadRef,accept:"image/*",onChange:this.onAvatarChanged}),r.a.createElement(u.a,{onClick:this.onChangeAvatar,className:"mx_CreateCommunityPrototypeDialog_avatarContainer"},s),r.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_tip"},r.a.createElement("b",null,Object(l.a)("Add image (optional)")),r.a.createElement("span",null,Object(l.a)("An image will help people identify your community.")))))))}})||n},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return l}));var n=s(18),i=s.n(n),o=s(8),a=s.n(o),r=s(572);function c(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}class l extends a.a{static get instance(){return l._instance||(l._instance=new l),l._instance}storeInvite(e,t){const s=function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?c(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):c(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({roomId:e},t),n=this.generateIdOf(s);return localStorage.setItem("mx_threepid_invite_"+n,JSON.stringify(s)),this.translateInvite(s)}getWireInvites(){const e=[];for(let t=0;t<localStorage.length;t++){const s=localStorage.key(t);s.startsWith("mx_threepid_invite_")&&e.push(JSON.parse(localStorage.getItem(s)))}return e}getInvites(){return this.getWireInvites().map(e=>this.translateInvite(e))}pickBestInvite(){return this.getInvites()[0]}resolveInvite(e){localStorage.removeItem("mx_threepid_invite_"+e.id)}generateIdOf(t){return r.base32.stringify(e.from(JSON.stringify(t)))}translateInvite(e){return{id:this.generateIdOf(e),roomId:e.roomId,toEmail:e.email,signUrl:e.signurl,roomName:e.room_name,roomAvatarUrl:e.room_avatar_url,inviterName:e.inviter_name}}translateToWireFormat(e){return{email:e.toEmail,signurl:e.signUrl,room_name:e.roomName,room_avatar_url:e.roomAvatarUrl,inviter_name:e.inviterName}}}i()(l,"_instance",void 0)}).call(this,s(36).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i=s(18),o=s.n(i),a=s(91),r=s(92),c=s(100),l=s(112),d=s(434),u=s(96),h=s(93),m=s(103);let p=Object(h.a)("views.voip.DialPadModal")(n=class extends a.PureComponent{constructor(e){super(e),o()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),o()(this,"onChange",e=>{this.setState({value:e.target.value})}),o()(this,"onFormSubmit",e=>{e.preventDefault(),this.onDialPress()}),o()(this,"onDigitPress",e=>{this.setState({value:this.state.value+e})}),o()(this,"onDeletePress",()=>{0!==this.state.value.length&&this.setState({value:this.state.value.slice(0,-1)})}),o()(this,"onDialPress",async()=>{const e={action:m.a.DialNumber,number:this.state.value};u.a.dispatch(e),this.props.onFinished(!0)}),this.state={value:""}}render(){return a.createElement("div",{className:"mx_DialPadModal"},a.createElement("div",{className:"mx_DialPadModal_header"},a.createElement("div",null,a.createElement("span",{className:"mx_DialPadModal_title"},Object(r.a)("Dial pad")),a.createElement(c.a,{className:"mx_DialPadModal_cancel",onClick:this.onCancelClick})),a.createElement("form",{onSubmit:this.onFormSubmit},a.createElement(l.a,{className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange}))),a.createElement("div",{className:"mx_DialPadModal_horizSep"}),a.createElement("div",{className:"mx_DialPadModal_dialPad"},a.createElement(d.a,{hasDialAndDelete:!0,onDigitPress:this.onDigitPress,onDeletePress:this.onDeletePress,onDialPress:this.onDialPress})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(91),i=s.n(n),o=s(95),a=s(296),r=s.n(a),c=s(92);const l=["vector-im/element-web","matrix-org/matrix-react-sdk","matrix-org/matrix-js-sdk"];class d extends i.a.Component{constructor(e){super(e),this.state={}}componentDidMount(){const e=this.props.newVersion.split("-"),t=this.props.version.split("-");if(null!=e&&null!=t)for(let s=0;s<l.length;s++){const n=t[2*s],i=e[2*s],o=`https://riot.im/github/repos/${l[s]}/compare/${n}...${i}`;r()(o,(e,t,n)=>{t.statusCode<200||t.statusCode>=300?this.setState({[l[s]]:t.statusText}):this.setState({[l[s]]:JSON.parse(n).commits})})}}elementsForCommit(e){return i.a.createElement("li",{key:e.sha,className:"mx_ChangelogDialog_li"},i.a.createElement("a",{href:e.html_url,target:"_blank",rel:"noreferrer noopener"},e.commit.message.split("\n")[0]))}render(){const e=o.getComponent("views.elements.Spinner"),t=o.getComponent("dialogs.QuestionDialog"),s=l.map(t=>{let s;return s=null==this.state[t]?i.a.createElement(e,{key:t}):"string"==typeof this.state[t]?Object(c.a)("Unable to load commit detail: %(msg)s",{msg:this.state[t]}):this.state[t].map(this.elementsForCommit),i.a.createElement("div",{key:t},i.a.createElement("h2",null,t),i.a.createElement("ul",null,s))}),n=i.a.createElement("div",{className:"mx_ChangelogDialog_content"},null==this.props.version||null==this.props.newVersion?i.a.createElement("h2",null,Object(c.a)("Unavailable")):s);return i.a.createElement(t,{title:Object(c.a)("Changelog"),description:n,button:Object(c.a)("Update"),onFinished:this.props.onFinished})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(200);async function i(e,t){const s=e.getUserId();let{threepids:i}=await e.getThreePids();if(t&&(i=i.filter(e=>e.medium===t)),i.length>0&&e.getIdentityServerUrl())try{const o=new n.a,a=await o.getAccessToken({check:!1}),r=i.map(({medium:e,address:t})=>[e,t]),c=await e.bulkLookupThreePids(r,a);for(const[e,n,o]of c.threepids){if(o!==s)continue;if(t&&e!==t)continue;const a=i.find(t=>t.medium===e&&t.address===n);a&&(a.bound=!0)}}catch(e){if("M_TERMS_NOT_SIGNED"!==e.errcode)throw e}return i}},function(e,t){e.exports="img/feather-customised/warning-triangle.d050a38.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(97),d=s.n(l),u=s(98),h=s(173),m=s(95),p=s(106),g=s(93),v=s(102),f=s(290);class b extends r.a.Component{constructor(...e){super(...e),o()(this,"_onChange",async e=>{await u.b.setValue(this.props.featureId,null,p.a.DEVICE,e),this.forceUpdate()})}render(){const e=u.b.getDisplayName(this.props.featureId),t=u.b.getValue(this.props.featureId),s=u.b.canSetValue(this.props.featureId,null,p.a.DEVICE);return r.a.createElement(h.a,{value:t,label:e,onChange:this._onChange,disabled:!s})}}o()(b,"propTypes",{featureId:d.a.string.isRequired});let y=Object(g.a)("views.settings.tabs.user.LabsUserSettingsTab")(n=class extends r.a.Component{constructor(){super()}render(){const e=u.b.getFeatureSettingNames(),[t,s]=e.reduce((e,t)=>(e[u.b.getBetaInfo(t)?1:0].push(t),e),[[],[]]);let n,i;if(s.length&&(n=r.a.createElement("div",{className:"mx_SettingsTab_section"},s.map(e=>r.a.createElement(f.b,{key:e,featureId:e})))),v.a.get().showLabsSettings){const e=m.getComponent("views.elements.SettingsFlag"),s=t.map(e=>r.a.createElement(b,{featureId:e,key:e}));i=r.a.createElement("div",{className:"mx_SettingsTab_section"},s,r.a.createElement(e,{name:"enableWidgetScreenshots",level:p.a.ACCOUNT}),r.a.createElement(e,{name:"showHiddenEventsInTimeline",level:p.a.DEVICE}),r.a.createElement(e,{name:"lowBandwidth",level:p.a.DEVICE}),r.a.createElement(e,{name:"advancedRoomListLogging",level:p.a.DEVICE}))}return r.a.createElement("div",{className:"mx_SettingsTab mx_LabsUserSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Labs")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Feeling experimental? Labs are the best way to get things early, test out new features and help shape them before they actually launch. <a>Learn more</a>.",{},{a:e=>r.a.createElement("a",{href:"https://github.com/vector-im/element-web/blob/develop/docs/labs.md",rel:"noreferrer noopener",target:"_blank"},e)})),n,i)}})||n},,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return D}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(102),d=s(94),u=s(98),h=s(252),m=s(334),p=s(650),g=s(100),v=s(96),f=s(635),b=s(103),y=s(148),_=s(441),E=s(112),S=s(651),w=s(291),C=s(106),k=s(116),O=s(155),R=s(101),I=s.n(R),x=s(211),T=s(93),j=s(142);function N(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function P(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?N(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):N(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let D=Object(T.a)("views.settings.tabs.user.AppearanceUserSettingsTab")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"MESSAGE_PREVIEW_TEXT",Object(c.a)("Hey you. You're the best!")),o()(this,"themeTimer",void 0),o()(this,"onThemeChange",e=>{if(this.state.theme===e)return;const t=u.b.getValue("theme");u.b.setValue("theme",null,C.a.DEVICE,e).catch(()=>{v.a.dispatch({action:b.a.RecheckTheme}),this.setState({theme:t})}),this.setState({theme:e}),v.a.dispatch({action:b.a.RecheckTheme,forceTheme:e})}),o()(this,"onUseSystemThemeChanged",e=>{this.setState({useSystemTheme:e}),u.b.setValue("use_system_theme",null,C.a.DEVICE,e),v.a.dispatch({action:b.a.RecheckTheme})}),o()(this,"onFontSizeChanged",e=>{this.setState({fontSize:e.toString()}),u.b.setValue("baseFontSize",null,C.a.DEVICE,e-f.a.SIZE_DIFF)}),o()(this,"onValidateFontSize",async({value:e})=>{const t=parseFloat(e),s=f.a.MIN_SIZE+f.a.SIZE_DIFF,n=f.a.MAX_SIZE+f.a.SIZE_DIFF;return isNaN(t)?{valid:!1,feedback:Object(c.a)("Size must be a number")}:s<=t&&t<=n?(u.b.setValue("baseFontSize",null,C.a.DEVICE,parseInt(e,10)-f.a.SIZE_DIFF),{valid:!0,feedback:Object(c.a)("Use between %(min)s pt and %(max)s pt",{min:s,max:n})}):{valid:!1,feedback:Object(c.a)("Custom font size can only be between %(min)s pt and %(max)s pt",{min:s,max:n})}}),o()(this,"onAddCustomTheme",async()=>{let e=u.b.getValue("custom_themes");e||(e=[]),e=e.map(e=>e),this.themeTimer&&clearTimeout(this.themeTimer);try{const t=await fetch(this.state.customThemeUrl),s=await t.json();if(!s||"string"!=typeof s.name||"object"!=typeof s.colors)return void this.setState({customThemeMessage:{text:Object(c.a)("Invalid theme schema."),isError:!0}});e.push(s)}catch(e){return console.error(e),void this.setState({customThemeMessage:{text:Object(c.a)("Error downloading theme information."),isError:!0}})}await u.b.setValue("custom_themes",null,C.a.ACCOUNT,e),this.setState({customThemeUrl:"",customThemeMessage:{text:Object(c.a)("Theme added!"),isError:!1}}),this.themeTimer=setTimeout(()=>{this.setState({customThemeMessage:{text:"",isError:!1}})},3e3)}),o()(this,"onCustomThemeChange",e=>{this.setState({customThemeUrl:e.target.value})}),o()(this,"onLayoutChange",e=>{let t;switch(e.target.value){case"irc":t=O.a.IRC;break;case"group":t=O.a.Group;break;case"bubble":t=O.a.Bubble}this.setState({layout:t}),u.b.setValue("layout",null,C.a.DEVICE,t)}),o()(this,"onIRCLayoutChange",e=>{e?(this.setState({layout:O.a.IRC}),u.b.setValue("layout",null,C.a.DEVICE,O.a.IRC)):(this.setState({layout:O.a.Group}),u.b.setValue("layout",null,C.a.DEVICE,O.a.Group))}),o()(this,"renderLayoutSection",()=>r.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_Layout"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Message layout")),r.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_Layout_RadioButtons"},r.a.createElement("div",{className:I()("mx_AppearanceUserSettingsTab_Layout_RadioButton",{mx_AppearanceUserSettingsTab_Layout_RadioButton_selected:this.state.layout==O.a.IRC})},r.a.createElement(S.a,{className:"mx_AppearanceUserSettingsTab_Layout_RadioButton_preview",message:this.MESSAGE_PREVIEW_TEXT,layout:O.a.IRC,userId:this.state.userId,displayName:this.state.displayName,avatarUrl:this.state.avatarUrl}),r.a.createElement(x.a,{name:"layout",value:"irc",checked:this.state.layout==O.a.IRC,onChange:this.onLayoutChange},"IRC")),r.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_spacer"}),r.a.createElement("div",{className:I()("mx_AppearanceUserSettingsTab_Layout_RadioButton",{mx_AppearanceUserSettingsTab_Layout_RadioButton_selected:this.state.layout==O.a.Group})},r.a.createElement(S.a,{className:"mx_AppearanceUserSettingsTab_Layout_RadioButton_preview",message:this.MESSAGE_PREVIEW_TEXT,layout:O.a.Group,userId:this.state.userId,displayName:this.state.displayName,avatarUrl:this.state.avatarUrl}),r.a.createElement(x.a,{name:"layout",value:"group",checked:this.state.layout==O.a.Group,onChange:this.onLayoutChange},Object(c.a)("Modern"))),r.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_spacer"}),r.a.createElement("div",{className:I()("mx_AppearanceUserSettingsTab_Layout_RadioButton",{mx_AppearanceUserSettingsTab_Layout_RadioButton_selected:this.state.layout==O.a.Bubble})},r.a.createElement(S.a,{className:"mx_AppearanceUserSettingsTab_Layout_RadioButton_preview",message:this.MESSAGE_PREVIEW_TEXT,layout:O.a.Bubble,userId:this.state.userId,displayName:this.state.displayName,avatarUrl:this.state.avatarUrl}),r.a.createElement(x.a,{name:"layout",value:"bubble",checked:this.state.layout==O.a.Bubble,onChange:this.onLayoutChange},Object(c.a)("Message bubbles")))))),this.state=P(P({fontSize:(u.b.getValue("baseFontSize",null)+f.a.SIZE_DIFF).toString()},this.calculateThemeState()),{},{customThemeUrl:"",customThemeMessage:{isError:!1,text:""},useCustomFontSize:u.b.getValue("useCustomFontSize"),useSystemFont:u.b.getValue("useSystemFont"),systemFont:u.b.getValue("systemFont"),showAdvanced:!0,layout:u.b.getValue("layout"),adaptiveSideBubbles:u.b.getValue("adaptiveSideBubbles"),userId:"@erim:fink.fink",displayName:"Erimayas Fink",avatarUrl:null})}async componentDidMount(){const e=d.a.get(),t=e.getUserId(),s=await e.getProfileInfo(t);this.setState({userId:t,displayName:s.displayname,avatarUrl:s.avatar_url})}calculateThemeState(){const e=u.b.getValue("theme"),t=u.b.getValueAt(C.a.DEVICE,"use_system_theme",null,!1,!0),s=u.b.getValueAt(C.a.DEVICE,"theme",null,!1,!0);return t?{theme:e,useSystemTheme:!0}:s?{theme:e,useSystemTheme:!1}:{theme:e,useSystemTheme:u.b.getValueAt(C.a.DEVICE,"use_system_theme")}}renderThemeSection(){let e,t;if((new m.a).isSystemThemeSupported()&&(e=r.a.createElement("div",null,r.a.createElement(y.a,{checked:this.state.useSystemTheme,onChange:e=>this.onUseSystemThemeChanged(e.target.checked)},u.b.getDisplayName("use_system_theme")))),u.b.getValue("feature_custom_themes")){let e=null;this.state.customThemeMessage.text&&(e=this.state.customThemeMessage.isError?r.a.createElement("div",{className:"text-error"},this.state.customThemeMessage.text):r.a.createElement("div",{className:"text-success"},this.state.customThemeMessage.text)),t=r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("form",{onSubmit:this.onAddCustomTheme},r.a.createElement(E.a,{label:Object(c.a)("Custom theme URL"),type:"text",id:"mx_GeneralUserSettingsTab_customThemeInput",autoComplete:"off",onChange:this.onCustomThemeChange,value:this.state.customThemeUrl}),r.a.createElement(g.a,{onClick:this.onAddCustomTheme,type:"submit",kind:"primary_sm",disabled:!this.state.customThemeUrl.trim()},Object(c.a)("Add theme")),e))}const s=Object.entries(Object(h.b)()).map(e=>({id:e[0],name:e[1]})),n=s.filter(e=>!e.id.startsWith("custom-")),i=s.filter(e=>!n.includes(e)).sort((e,t)=>Object(j.a)(e.name,t.name)),o=[...n,...i];return r.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_themeSection"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Theme")),e,r.a.createElement("div",{className:"mx_ThemeSelectors"},r.a.createElement(w.a,{name:"theme",definitions:o.map(e=>({value:e.id,label:e.name,disabled:this.state.useSystemTheme,className:"mx_ThemeSelector_"+e.id})),onChange:this.onThemeChange,value:this.state.useSystemTheme?void 0:this.state.theme,outlined:!0})),t)}renderFontSection(){return r.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_fontScaling"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Font size")),r.a.createElement(S.a,{className:"mx_AppearanceUserSettingsTab_fontSlider_preview",message:this.MESSAGE_PREVIEW_TEXT,layout:this.state.layout,userId:this.state.userId,displayName:this.state.displayName,avatarUrl:this.state.avatarUrl}),r.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_fontSlider"},r.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_fontSlider_smallText"},"Aa"),r.a.createElement(p.a,{values:[13,14,15,16,18],value:parseInt(this.state.fontSize,10),onSelectionChange:this.onFontSizeChanged,displayFunc:e=>"",disabled:this.state.useCustomFontSize}),r.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_fontSlider_largeText"},"Aa")),r.a.createElement(_.a,{name:"useCustomFontSize",level:C.a.ACCOUNT,onChange:e=>this.setState({useCustomFontSize:e}),useCheckbox:!0}),r.a.createElement(E.a,{type:"number",label:Object(c.a)("Font size"),autoComplete:"off",placeholder:this.state.fontSize.toString(),value:this.state.fontSize.toString(),id:"font_size_field",onValidate:this.onValidateFontSize,onChange:e=>this.setState({fontSize:e.target.value}),disabled:!this.state.useCustomFontSize,className:"mx_SettingsTab_customFontSizeField"}))}renderAdvancedSection(){if(!u.b.getValue(k.a.AdvancedSettings))return null;const e=l.a.get().brand,t=r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Advanced"));let s;if(this.state.showAdvanced){const t=Object(c.a)("Set the name of a font installed on your system & %(brand)s will attempt to use it.",{brand:e});s=r.a.createElement(r.a.Fragment,null,r.a.createElement(_.a,{name:"unifiedRoomList",level:C.a.DEVICE,useCheckbox:!0}),r.a.createElement(_.a,{name:"useCompactLayout",level:C.a.DEVICE,useCheckbox:!0,disabled:this.state.layout!==O.a.Group}),r.a.createElement(_.a,{name:"singleSideBubbles",level:C.a.DEVICE,useCheckbox:!0,disabled:this.state.layout!==O.a.Bubble||this.state.adaptiveSideBubbles}),r.a.createElement(_.a,{name:"adaptiveSideBubbles",level:C.a.DEVICE,useCheckbox:!0,onChange:e=>this.setState({adaptiveSideBubbles:e}),disabled:this.state.layout!==O.a.Bubble}),r.a.createElement(_.a,{name:"useSystemFont",level:C.a.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useSystemFont:e})}),r.a.createElement(E.a,{className:"mx_AppearanceUserSettingsTab_systemFont",label:u.b.getDisplayName("systemFont"),onChange:e=>{this.setState({systemFont:e.target.value}),u.b.setValue("systemFont",null,C.a.DEVICE,e.target.value)},tooltipContent:t,forceTooltipVisible:!0,disabled:!this.state.useSystemFont,value:this.state.systemFont}))}return r.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_Advanced"},t,s)}render(){const e=l.a.get().brand;return r.a.createElement("div",{className:"mx_SettingsTab mx_AppearanceUserSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Customise your appearance")),r.a.createElement("div",{className:"mx_SettingsTab_SubHeading"},Object(c.a)("Appearance Settings only affect this %(brand)s session.",{brand:e})),this.renderThemeSection(),this.renderLayoutSection(),this.renderFontSection(),this.renderAdvancedSection())}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n,i=s(91),o=s(93);let a=Object(o.a)("views.elements.Slider")(n=class extends i.Component{offset(e,t){const s=e.reduce((e,s)=>t>s?e+1:e,0);if(0===s)return 0;if(s===e.length)return 100;const n=e[s-1],i=e[s],o=1/(e.length-1);return 100*(s-1+(t-n)/(i-n))*o}render(){const e=this.props.values.map(e=>i.createElement(r,{active:e<=this.props.value,label:this.props.displayFunc(e),onClick:this.props.disabled?()=>{}:()=>this.props.onSelectionChange(e),key:e,disabled:this.props.disabled}));let t=null;if(!this.props.disabled){const e=this.offset(this.props.values,this.props.value);t=i.createElement("div",{className:"mx_Slider_selection"},i.createElement("div",{className:"mx_Slider_selectionDot",style:{left:"calc(-0.55em + "+e+"%)"}}),i.createElement("hr",{style:{width:e+"%"}}))}return i.createElement("div",{className:"mx_Slider"},i.createElement("div",null,i.createElement("div",{className:"mx_Slider_bar"},i.createElement("hr",{onClick:this.props.disabled?()=>{}:this.onClick.bind(this)}),t),i.createElement("div",{className:"mx_Slider_dotContainer"},e)))}onClick(e){const t=e.target.clientWidth,s=e.nativeEvent.offsetX/t,n=this.props.values[Math.round(s*(this.props.values.length-1))];this.props.onSelectionChange(n)}})||n;class r extends i.PureComponent{render(){let e="mx_Slider_dot";return!this.props.disabled&&this.props.active&&(e+=" mx_Slider_dotActive"),i.createElement("span",{onClick:this.props.onClick,className:"mx_Slider_dotValue"},i.createElement("div",{className:e}),i.createElement("div",{className:"mx_Slider_labelContainer"},i.createElement("div",{className:"mx_Slider_label"},this.props.label)))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(91),o=s.n(i),a=s(101),r=s.n(a),c=s(114),l=s(194),d=s(195),u=s(98),h=s(155),m=s(116),p=s(93);let g=Object(p.a)("views.elements.EventTilePreview")(n=class extends o.a.Component{constructor(e){super(e),this.state={message:e.message}}fakeEvent({message:e}){const t={type:"m.room.message",sender:this.props.userId,content:{"m.new_content":{msgtype:"m.text",body:e,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},msgtype:"m.text",body:e,displayname:this.props.displayName,avatar_url:this.props.avatarUrl},unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:"!999999999999999999:example.org"},s=new c.b(t);return s.sender={name:this.props.displayName||this.props.userId,rawDisplayName:this.props.displayName,userId:this.props.userId,getAvatarUrl:(...e)=>l.c({avatarUrl:this.props.avatarUrl},32,32,"crop"),getMxcAvatarUrl:()=>this.props.avatarUrl},s}render(){const e=this.fakeEvent(this.state),t=r()(this.props.className,{mx_IRCLayout:this.props.layout==h.a.IRC,mx_GroupLayout:this.props.layout==h.a.Group,sc_BubbleLayout:this.props.layout==h.a.Bubble});return o.a.createElement("div",{className:t},o.a.createElement(d.a,{mxEvent:e,layout:this.props.layout,enableFlair:u.b.getValue(m.a.Flair),as:"div"}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return j}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(92),m=s(102),p=s(94),g=s(162),v=s(100),f=s(132),b=s(99),y=s(95),_=s(149),E=s(96),S=s(137),w=s(106),C=s(653),k=s(98),O=s(116),R=s(654),I=s(120),x=s(93);class T extends l.a.Component{constructor(...e){super(...e),r()(this,"_onUnignoreClicked",e=>{this.props.onUnignored(this.props.userId)})}render(){const e="mx_SecurityUserSettingsTab_ignoredUser_"+this.props.userId;return l.a.createElement("div",{className:"mx_SecurityUserSettingsTab_ignoredUser"},l.a.createElement(v.a,{onClick:this._onUnignoreClicked,kind:"primary_sm","aria-describedby":e,disabled:this.props.inProgress},Object(h.a)("Unignore")),l.a.createElement("span",{id:e},this.props.userId))}}r()(T,"propTypes",{userId:u.a.string.isRequired,onUnignored:u.a.func.isRequired,inProgress:u.a.bool.isRequired});let j=Object(x.a)("views.settings.tabs.user.SecurityUserSettingsTab")((o=i=class extends l.a.Component{constructor(){super(),r()(this,"_updateBlacklistDevicesFlag",e=>{p.a.get().setGlobalBlacklistUnverifiedDevices(e)}),r()(this,"_updateAnalytics",e=>{e?f.a.enable():f.a.disable(),I.a.instance.enable(!e)}),r()(this,"_onExportE2eKeysClicked",()=>{b.a.createTrackedDialogAsync("Export E2E Keys","",s.e(4).then(s.bind(null,1306)),{matrixClient:p.a.get()})}),r()(this,"_onImportE2eKeysClicked",()=>{b.a.createTrackedDialogAsync("Import E2E Keys","",s.e(28).then(s.bind(null,1307)),{matrixClient:p.a.get()})}),r()(this,"_onGoToUserProfileClick",()=>{E.a.dispatch({action:"view_user_info",userId:p.a.get().getUserId()}),this.props.closeSettingsFn()}),r()(this,"_onUserUnignored",async e=>{const{ignoredUserIds:t,waitingUnignored:s}=this.state,n=t.filter(e=>!s.includes(e)),i=n.indexOf(e);-1!==i&&(n.splice(i,1),this.setState(({waitingUnignored:t})=>({waitingUnignored:[...t,e]})),p.a.get().setIgnoredUsers(n))}),r()(this,"_getInvitedRooms",()=>p.a.get().getRooms().filter(e=>e.hasMembershipState(p.a.get().getUserId(),"invite"))),r()(this,"_manageInvites",async e=>{this.setState({managingInvites:!0});const t=this._getInvitedRooms().map(e=>e.roomId),s=this,n=p.a.get(),i=e?n.joinRoom.bind(n):n.leave.bind(n);for(let e=0;e<t.length;e++){const n=t[e];await i(n).then(()=>{this.setState({invitedRoomAmt:s.state.invitedRoomAmt-1})},async t=>{"M_LIMIT_EXCEEDED"===t.errcode?(await Object(_.c)(t.retry_after_ms||2500),e--):console.warn(t)})}this.setState({managingInvites:!1})}),r()(this,"_onAcceptAllInvitesClicked",e=>{this._manageInvites(!0)}),r()(this,"_onRejectAllInvitesClicked",e=>{this._manageInvites(!1)});const e=this._getInvitedRooms();this.state={ignoredUserIds:p.a.get().getIgnoredUsers(),waitingUnignored:[],managingInvites:!1,invitedRoomAmt:e.length},this._onAction=this._onAction.bind(this)}_onAction({action:e}){if("ignore_state_changed"===e){const e=p.a.get().getIgnoredUsers(),t=this.state.waitingUnignored.filter(t=>e.includes(t));this.setState({ignoredUserIds:e,waitingUnignored:t})}}componentDidMount(){this.dispatcherRef=E.a.register(this._onAction)}componentWillUnmount(){E.a.unregister(this.dispatcherRef)}_renderCurrentDeviceInfo(){const e=y.getComponent("views.elements.SettingsFlag"),t=p.a.get(),s=t.deviceId;let n=t.getDeviceEd25519Key();n=n?g.e(n):Object(h.a)("<not supported>");let i,o=null;return t.isCryptoEnabled()&&(o=l.a.createElement("div",{className:"mx_SecurityUserSettingsTab_importExportButtons"},l.a.createElement(v.a,{kind:"primary",onClick:this._onExportE2eKeysClicked},Object(h.a)("Export E2E room keys")),l.a.createElement(v.a,{kind:"primary",onClick:this._onImportE2eKeysClicked},Object(h.a)("Import E2E room keys")))),k.b.isEnabled("blacklistUnverifiedDevices")&&(i=l.a.createElement(e,{name:"blacklistUnverifiedDevices",level:w.a.DEVICE,onChange:this._updateBlacklistDevicesFlag})),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Cryptography")),l.a.createElement("ul",{className:"mx_SettingsTab_subsectionText mx_SecurityUserSettingsTab_deviceInfo"},l.a.createElement("li",null,l.a.createElement("label",null,Object(h.a)("Session ID:")),l.a.createElement("span",null,l.a.createElement("code",null,s))),l.a.createElement("li",null,l.a.createElement("label",null,Object(h.a)("Session key:")),l.a.createElement("span",null,l.a.createElement("code",null,l.a.createElement("b",null,n))))),o,i)}_renderIgnoredUsers(){const{waitingUnignored:e,ignoredUserIds:t}=this.state,s=null!=t&&t.length?t.map(t=>l.a.createElement(T,{userId:t,onUnignored:this._onUserUnignored,key:t,inProgress:e.includes(t)})):Object(h.a)("You have no ignored users.");return l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Ignored users")),l.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},s))}_renderManageInvites(){if(0===this.state.invitedRoomAmt)return null;const e=this._getInvitedRooms(),t=y.getComponent("elements.InlineSpinner"),s=this._onAcceptAllInvitesClicked.bind(this,e),n=this._onRejectAllInvitesClicked.bind(this,e);return l.a.createElement("div",{className:"mx_SettingsTab_section mx_SecurityUserSettingsTab_bulkOptions"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Bulk options")),l.a.createElement(v.a,{onClick:s,kind:"primary",disabled:this.state.managingInvites},Object(h.a)("Accept all %(invitedRooms)s invites",{invitedRooms:this.state.invitedRoomAmt})),l.a.createElement(v.a,{onClick:n,kind:"danger",disabled:this.state.managingInvites},Object(h.a)("Reject all %(invitedRooms)s invites",{invitedRooms:this.state.invitedRoomAmt})),this.state.managingInvites?l.a.createElement(t,null):l.a.createElement("div",null))}render(){const e=m.a.get().brand,t=y.getComponent("views.settings.DevicesPanel"),s=y.getComponent("views.elements.SettingsFlag"),n=y.getComponent("views.settings.EventIndexPanel"),i=l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Secure Backup")),l.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},l.a.createElement(C.a,null))),o=l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Message search")),l.a.createElement(n,null)),a=y.getComponent("views.settings.CrossSigningPanel"),r=l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Cross-signing")),l.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},l.a.createElement(a,null)));let c,d;Object(S.f)()||(c=l.a.createElement("div",{className:"mx_SecurityUserSettingsTab_warning"},Object(h.a)("Your server admin has disabled end-to-end encryption by default in private rooms & Direct Messages."))),(f.a.canEnable()||I.a.instance.canEnable())&&(d=l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(h.a)("Privacy")),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Analytics")),l.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(h.a)("%(brand)s collects anonymous analytics to allow us to improve the application.",{brand:e})," ",Object(h.a)("Privacy is important to us, so we don't collect any personal or identifiable data for our analytics."),l.a.createElement(v.a,{className:"mx_SettingsTab_linkBtn",onClick:f.a.showDetailsModal},Object(h.a)("Learn more about how we use analytics."))),l.a.createElement(s,{name:"analyticsOptIn",level:w.a.DEVICE,onChange:this._updateAnalytics}))));const u=y.getComponent("views.settings.E2eAdvancedPanel");let p;if(k.b.getValue(O.a.AdvancedSettings)){const e=this._renderIgnoredUsers(),t=this._renderManageInvites(),s=Object(R.b)()?l.a.createElement(u,null):null;(e||t||s)&&(p=l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(h.a)("Advanced")),l.a.createElement("div",{className:"mx_SettingsTab_section"},e,t,s)))}return l.a.createElement("div",{className:"mx_SettingsTab mx_SecurityUserSettingsTab"},c,l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(h.a)("Where you’re logged in")),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",null,Object(h.a)("Manage the names of and sign out of your sessions below or <a>verify them in your User Profile</a>.",{},{a:e=>l.a.createElement(v.a,{kind:"link",onClick:this._onGoToUserProfileClick},e)})),l.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(h.a)("A session's public name is visible to people you communicate with"),l.a.createElement(t,null))),l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(h.a)("Encryption")),l.a.createElement("div",{className:"mx_SettingsTab_section"},i,o,r,this._renderCurrentDeviceInfo()),d,p)}},r()(i,"propTypes",{closeSettingsFn:u.a.func.isRequired}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(94),l=s(92),d=s(99),u=s(243),h=s(119),m=s(100),p=s(143),g=s(250),v=s(181),f=s(93);let b=Object(f.a)("views.settings.SecureBackupPanel")(n=class extends r.a.PureComponent{constructor(e){super(e),o()(this,"_onKeyBackupSessionsRemaining",e=>{this.setState({sessionsRemaining:e})}),o()(this,"_onKeyBackupStatus",()=>{this._loadBackupStatus()}),o()(this,"_startNewBackup",()=>{d.a.createTrackedDialogAsync("Key Backup","Key Backup",s.e(5).then(s.bind(null,737)),{onFinished:()=>{this._loadBackupStatus()}},null,!1,!0)}),o()(this,"_deleteBackup",()=>{d.a.createTrackedDialog("Delete Backup","",p.a,{title:Object(l.a)("Delete Backup"),description:Object(l.a)("Are you sure? You will lose your encrypted messages if your keys are not backed up properly."),button:Object(l.a)("Delete Backup"),danger:!0,onFinished:e=>{e&&(this.setState({loading:!0}),c.a.get().deleteKeyBackupVersion(this.state.backupInfo.version).then(()=>{this._loadBackupStatus()}))}})}),o()(this,"_restoreBackup",async()=>{d.a.createTrackedDialog("Restore Backup","",g.a,null,null,!1,!0)}),o()(this,"_resetSecretStorage",async()=>{this.setState({error:null});try{await Object(v.b)(()=>{},!0)}catch(e){if(console.error("Error resetting secret storage",e),this._unmounted)return;this.setState({error:e})}this._unmounted||this._loadBackupStatus()}),this._unmounted=!1,this.state={loading:!0,error:null,backupKeyStored:null,backupKeyCached:null,backupKeyWellFormed:null,secretStorageKeyInAccount:null,secretStorageReady:null,backupInfo:null,backupSigStatus:null,sessionsRemaining:0}}componentDidMount(){this._checkKeyBackupStatus(),c.a.get().on("crypto.keyBackupStatus",this._onKeyBackupStatus),c.a.get().on("crypto.keyBackupSessionsRemaining",this._onKeyBackupSessionsRemaining)}componentWillUnmount(){this._unmounted=!0,c.a.get()&&(c.a.get().removeListener("crypto.keyBackupStatus",this._onKeyBackupStatus),c.a.get().removeListener("crypto.keyBackupSessionsRemaining",this._onKeyBackupSessionsRemaining))}async _checkKeyBackupStatus(){this._getUpdatedDiagnostics();try{const{backupInfo:e,trustInfo:t}=await c.a.get().checkKeyBackup();this.setState({loading:!1,error:null,backupInfo:e,backupSigStatus:t})}catch(e){if(console.log("Unable to fetch check backup status",e),this._unmounted)return;this.setState({loading:!1,error:e,backupInfo:null,backupSigStatus:null})}}async _loadBackupStatus(){this.setState({loading:!0}),this._getUpdatedDiagnostics();try{const e=await c.a.get().getKeyBackupVersion(),t=await c.a.get().isKeyBackupTrusted(e);if(this._unmounted)return;this.setState({loading:!1,error:null,backupInfo:e,backupSigStatus:t})}catch(e){if(console.log("Unable to fetch key backup status",e),this._unmounted)return;this.setState({loading:!1,error:e,backupInfo:null,backupSigStatus:null})}}async _getUpdatedDiagnostics(){const e=c.a.get(),t=e.crypto.secretStorage,s=!!await e.isKeyBackupKeyStored(),n=await e.crypto.getSessionBackupPrivateKey(),i=!!n,o=n instanceof Uint8Array,a=await t.hasKey(),r=await e.isSecretStorageReady();this._unmounted||this.setState({backupKeyStored:s,backupKeyCached:i,backupKeyWellFormed:o,secretStorageKeyInAccount:a,secretStorageReady:r})}render(){const{loading:e,error:t,backupKeyStored:s,backupKeyCached:n,backupKeyWellFormed:i,secretStorageKeyInAccount:o,secretStorageReady:a,backupInfo:d,backupSigStatus:p,sessionsRemaining:g}=this.state;let v,f,b;const y=[];if(t)v=r.a.createElement("div",{className:"error"},Object(l.a)("Unable to load key backup status"));else if(e)v=r.a.createElement(h.a,null);else if(d){let e,t=Object(l.a)("Restore from Backup");c.a.get().getKeyBackupEnabled()?v=r.a.createElement("p",null,"✅ ",Object(l.a)("This session is backing up your keys. ")):(v=r.a.createElement(r.a.Fragment,null,r.a.createElement("p",null,Object(l.a)("This session is <b>not backing up your keys</b>, but you do have an existing backup you can restore from and add to going forward.",{},{b:e=>r.a.createElement("b",null,e)})),r.a.createElement("p",null,Object(l.a)("Connect this session to key backup before signing out to avoid losing any keys that may only be on this session."))),t=Object(l.a)("Connect this session to Key Backup")),e=c.a.get().getKeyBackupEnabled()?g>0?r.a.createElement("div",null,Object(l.a)("Backing up %(sessionsRemaining)s keys...",{sessionsRemaining:g})," ",r.a.createElement("br",null)):r.a.createElement("div",null,Object(l.a)("All keys backed up")," ",r.a.createElement("br",null)):"";let s,n=p.sigs.map((e,t)=>{const s=e.device?e.device.getDisplayName()||e.device.deviceId:null,n=t=>r.a.createElement("span",{className:e.valid?"mx_SecureBackupPanel_sigValid":"mx_SecureBackupPanel_sigInvalid"},t),i=t=>r.a.createElement("span",{className:e.device&&e.deviceTrust.isVerified()?"mx_SecureBackupPanel_deviceVerified":"mx_SecureBackupPanel_deviceNotVerified"},t),o=e=>r.a.createElement("span",{className:"mx_SecureBackupPanel_deviceName"},s),a=e.device&&e.device.getFingerprint()===c.a.get().getDeviceEd25519Key(),d=e.crossSigningId&&e.deviceId===c.a.get().getCrossSigningId();let u;return e.valid&&d?u=Object(l.a)("Backup has a <validity>valid</validity> signature from this user",{},{validity:n}):!e.valid&&d?u=Object(l.a)("Backup has a <validity>invalid</validity> signature from this user",{},{validity:n}):e.crossSigningId?u=Object(l.a)("Backup has a signature from <verify>unknown</verify> user with ID %(deviceId)s",{deviceId:e.deviceId},{verify:i}):e.device?e.valid&&a?u=Object(l.a)("Backup has a <validity>valid</validity> signature from this session",{},{validity:n}):!e.valid&&a?u=Object(l.a)("Backup has an <validity>invalid</validity> signature from this session",{},{validity:n}):e.valid&&e.deviceTrust.isVerified()?u=Object(l.a)("Backup has a <validity>valid</validity> signature from <verify>verified</verify> session <device></device>",{},{validity:n,verify:i,device:o}):e.valid&&!e.deviceTrust.isVerified()?u=Object(l.a)("Backup has a <validity>valid</validity> signature from <verify>unverified</verify> session <device></device>",{},{validity:n,verify:i,device:o}):!e.valid&&e.deviceTrust.isVerified()?u=Object(l.a)("Backup has an <validity>invalid</validity> signature from <verify>verified</verify> session <device></device>",{},{validity:n,verify:i,device:o}):e.valid||e.deviceTrust.isVerified()||(u=Object(l.a)("Backup has an <validity>invalid</validity> signature from <verify>unverified</verify> session <device></device>",{},{validity:n,verify:i,device:o})):u=Object(l.a)("Backup has a signature from <verify>unknown</verify> session with ID %(deviceId)s",{deviceId:e.deviceId},{verify:i}),r.a.createElement("div",{key:t},u)});0===p.sigs.length&&(n=Object(l.a)("Backup is not signed by any of your sessions")),p.trusted_locally&&(s=Object(l.a)("This backup is trusted because it has been restored on this session")),f=r.a.createElement(r.a.Fragment,null,r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Backup version:")),r.a.createElement("td",null,d.version)),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Algorithm:")),r.a.createElement("td",null,d.algorithm))),b=r.a.createElement(r.a.Fragment,null,e,r.a.createElement("div",null,n),r.a.createElement("div",null,s)),y.push(r.a.createElement(m.a,{key:"restore",kind:"primary",onClick:this._restoreBackup},t)),Object(u.d)()||y.push(r.a.createElement(m.a,{key:"delete",kind:"danger",onClick:this._deleteBackup},Object(l.a)("Delete Backup")))}else v=r.a.createElement(r.a.Fragment,null,r.a.createElement("p",null,Object(l.a)("Your keys are <b>not being backed up from this session</b>.",{},{b:e=>r.a.createElement("b",null,e)})),r.a.createElement("p",null,Object(l.a)("Back up your keys before signing out to avoid losing them."))),y.push(r.a.createElement(m.a,{key:"setup",kind:"primary",onClick:this._startNewBackup},Object(l.a)("Set up")));o&&y.push(r.a.createElement(m.a,{key:"reset",kind:"danger",onClick:this._resetSecretStorage},Object(l.a)("Reset")));let _,E="";return n&&(E=", ",E+=i?Object(l.a)("well formed"):Object(l.a)("unexpected type")),y.length&&(_=r.a.createElement("div",{className:"mx_SecureBackupPanel_buttonRow"},y)),r.a.createElement("div",null,r.a.createElement("p",null,Object(l.a)("Back up your encryption keys with your account data in case you lose access to your sessions. Your keys will be secured with a unique Security Key.")),v,r.a.createElement("details",null,r.a.createElement("summary",null,Object(l.a)("Advanced")),r.a.createElement("table",{className:"mx_SecureBackupPanel_statusList"},r.a.createElement("tbody",null,r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Backup key stored:")),r.a.createElement("td",null,!0===s?Object(l.a)("in secret storage"):Object(l.a)("not stored"))),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Backup key cached:")),r.a.createElement("td",null,n?Object(l.a)("cached locally"):Object(l.a)("not found locally"),E)),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Secret storage public key:")),r.a.createElement("td",null,o?Object(l.a)("in account data"):Object(l.a)("not found"))),r.a.createElement("tr",null,r.a.createElement("td",null,Object(l.a)("Secret storage:")),r.a.createElement("td",null,a?Object(l.a)("ready"):Object(l.a)("not ready"))),f)),b),_)}})||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return l}));var n=s(91),i=s.n(n),o=s(95),a=s(92),r=s(106),c=s(98);function l(){return c.b.isEnabled("e2ee.manuallyVerifyAllSessions")}t.a=e=>{const t=o.getComponent("views.elements.SettingsFlag");return i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(a.a)("Encryption")),i.a.createElement(t,{name:"e2ee.manuallyVerifyAllSessions",level:r.a.DEVICE}),i.a.createElement("div",{className:"mx_E2eAdvancedPanel_settingLongDescription"},Object(a.a)("Individually verify each session used by a user to mark it as trusted, not trusting cross-signed devices.")))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n,i=s(91),o=s.n(i),a=s(92),r=s(95),c=s(93);let l=Object(c.a)("views.settings.tabs.user.NotificationUserSettingsTab")(n=class extends o.a.Component{constructor(){super()}render(){const e=r.getComponent("views.settings.Notifications");return o.a.createElement("div",{className:"mx_SettingsTab mx_NotificationUserSettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(a.a)("Notifications")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement(e,null)))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(92),u=s(173),h=s(98),m=s(112),p=s(95),g=s(118),v=s(106),f=s(93);let b=Object(f.a)("views.settings.tabs.user.PreferencesUserSettingsTab")((o=i=class e extends l.a.Component{constructor(e){super(e),r()(this,"onAutoLaunchChange",e=>{g.a.get().setAutoLaunchEnabled(e).then(()=>this.setState({autoLaunch:e}))}),r()(this,"onWarnBeforeExitChange",e=>{g.a.get().setWarnBeforeExit(e).then(()=>this.setState({warnBeforeExit:e}))}),r()(this,"onAlwaysShowMenuBarChange",e=>{g.a.get().setAutoHideMenuBarEnabled(!e).then(()=>this.setState({alwaysShowMenuBar:e}))}),r()(this,"onMinimizeToTrayChange",e=>{g.a.get().setMinimizeToTrayEnabled(e).then(()=>this.setState({minimizeToTray:e}))}),r()(this,"onAutocompleteDelayChange",e=>{this.setState({autocompleteDelay:e.target.value}),h.b.setValue("autocompleteDelay",null,v.a.DEVICE,e.target.value)}),r()(this,"onReadMarkerInViewThresholdMs",e=>{this.setState({readMarkerInViewThresholdMs:e.target.value}),h.b.setValue("readMarkerInViewThresholdMs",null,v.a.DEVICE,e.target.value)}),r()(this,"onReadMarkerOutOfViewThresholdMs",e=>{this.setState({readMarkerOutOfViewThresholdMs:e.target.value}),h.b.setValue("readMarkerOutOfViewThresholdMs",null,v.a.DEVICE,e.target.value)}),this.state={autoLaunch:!1,autoLaunchSupported:!1,warnBeforeExit:!0,warnBeforeExitSupported:!1,alwaysShowMenuBar:!0,alwaysShowMenuBarSupported:!1,minimizeToTray:!0,minimizeToTraySupported:!1,autocompleteDelay:h.b.getValueAt(v.a.DEVICE,"autocompleteDelay").toString(10),readMarkerInViewThresholdMs:h.b.getValueAt(v.a.DEVICE,"readMarkerInViewThresholdMs").toString(10),readMarkerOutOfViewThresholdMs:h.b.getValueAt(v.a.DEVICE,"readMarkerOutOfViewThresholdMs").toString(10)}}async componentDidMount(){const e=g.a.get(),t=await e.supportsAutoLaunch();let s=!1;t&&(s=await e.getAutoLaunchEnabled());const n=await e.supportsWarnBeforeExit();let i=!1;n&&(i=await e.shouldWarnBeforeExit());const o=await e.supportsAutoHideMenuBar();let a=!0;o&&(a=!await e.getAutoHideMenuBarEnabled());const r=await e.supportsMinimizeToTray();let c=!0;r&&(c=await e.getMinimizeToTrayEnabled()),this.setState({autoLaunch:s,autoLaunchSupported:t,warnBeforeExit:i,warnBeforeExitSupported:n,alwaysShowMenuBarSupported:o,alwaysShowMenuBar:a,minimizeToTraySupported:r,minimizeToTray:c})}renderGroup(e){const t=p.getComponent("views.elements.SettingsFlag");return e.filter(h.b.isEnabled).map(e=>l.a.createElement(t,{key:e,name:e,level:v.a.ACCOUNT}))}render(){let t=null;this.state.autoLaunchSupported&&(t=l.a.createElement(u.a,{value:this.state.autoLaunch,onChange:this.onAutoLaunchChange,label:Object(d.a)("Start automatically after system login")}));let s=null;this.state.warnBeforeExitSupported&&(s=l.a.createElement(u.a,{value:this.state.warnBeforeExit,onChange:this.onWarnBeforeExitChange,label:Object(d.a)("Warn before quitting")}));let n=null;this.state.alwaysShowMenuBarSupported&&(n=l.a.createElement(u.a,{value:this.state.alwaysShowMenuBar,onChange:this.onAlwaysShowMenuBarChange,label:Object(d.a)("Always show the window menu bar")}));let i=null;return this.state.minimizeToTraySupported&&(i=l.a.createElement(u.a,{value:this.state.minimizeToTray,onChange:this.onMinimizeToTrayChange,label:Object(d.a)("Show tray icon and minimize window to it on close")})),l.a.createElement("div",{className:"mx_SettingsTab mx_PreferencesUserSettingsTab"},l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(d.a)("Preferences")),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Room list")),this.renderGroup(e.ROOM_LIST_SETTINGS)),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Composer")),this.renderGroup(e.COMPOSER_SETTINGS)),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("Timeline")),this.renderGroup(e.TIMELINE_SETTINGS)),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(d.a)("General")),this.renderGroup(e.GENERAL_SETTINGS),i,n,t,s,l.a.createElement(m.a,{label:Object(d.a)("Autocomplete delay (ms)"),type:"number",value:this.state.autocompleteDelay,onChange:this.onAutocompleteDelayChange}),l.a.createElement(m.a,{label:Object(d.a)("Read Marker lifetime (ms)"),type:"number",value:this.state.readMarkerInViewThresholdMs,onChange:this.onReadMarkerInViewThresholdMs}),l.a.createElement(m.a,{label:Object(d.a)("Read Marker off-screen lifetime (ms)"),type:"number",value:this.state.readMarkerOutOfViewThresholdMs,onChange:this.onReadMarkerOutOfViewThresholdMs})))}},r()(i,"ROOM_LIST_SETTINGS",["breadcrumbs"]),r()(i,"COMPOSER_SETTINGS",["MessageComposerInput.autoReplaceEmoji","MessageComposerInput.suggestEmoji","sendTypingNotifications","MessageComposerInput.ctrlEnterToSend","MessageComposerInput.showStickersButton"]),r()(i,"TIMELINE_SETTINGS",["showTypingNotifications","autoplayGifsAndVideos","urlPreviewsEnabled","TextualBody.enableBigEmoji","showReadReceipts","showTwelveHourTimestamps","alwaysShowTimestamps","showRedactions","enableSyntaxHighlightLanguageDetection","expandCodeByDefault","scrollToBottomOnMessageSent","showCodeLineNumbers","showJoinLeaves","showAvatarChanges","showDisplaynameChanges","showImages","showChatEffects","Pill.shouldShowPillAvatar","ctrlFForSearch"]),r()(i,"GENERAL_SETTINGS",["TagPanel.enableTagPanel","promptBeforeInviteUnknownUsers"]),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(102),d=s(292),u=s(112),h=s(100),m=s(94),p=s(95),g=s(99),v=s(106),f=s(93);let b=Object(f.a)("views.settings.tabs.user.VoiceUserSettingsTab")(n=class extends r.a.Component{constructor(){super(),o()(this,"_refreshMediaDevices",async e=>{this.setState({mediaDevices:await d.b.getDevices(),activeAudioOutput:d.b.getAudioOutput(),activeAudioInput:d.b.getAudioInput(),activeVideoInput:d.b.getVideoInput()}),e&&e.getTracks().forEach(e=>e.stop())}),o()(this,"_requestMediaPermissions",async()=>{let e,t,s;try{e={video:!0,audio:!0},t=await navigator.mediaDevices.getUserMedia(e)}catch(n){if("NotFoundError"===n.name){e={audio:!0};try{t=await navigator.mediaDevices.getUserMedia(e)}catch(e){s=e}}else s=n}if(s){console.log("Failed to list userMedia devices",s);const e=l.a.get().brand,t=p.getComponent("dialogs.ErrorDialog");g.a.createTrackedDialog("No media permissions","",t,{title:Object(c.a)("No media permissions"),description:Object(c.a)("You may need to manually permit %(brand)s to access your microphone/webcam",{brand:e})})}else this._refreshMediaDevices(t)}),o()(this,"_setAudioOutput",e=>{d.b.instance.setAudioOutput(e.target.value),this.setState({activeAudioOutput:e.target.value})}),o()(this,"_setAudioInput",e=>{d.b.instance.setAudioInput(e.target.value),this.setState({activeAudioInput:e.target.value})}),o()(this,"_setVideoInput",e=>{d.b.instance.setVideoInput(e.target.value),this.setState({activeVideoInput:e.target.value})}),o()(this,"_changeWebRtcMethod",e=>{m.a.get().setForceTURN(!e)}),o()(this,"_changeFallbackICEServerAllowed",e=>{m.a.get().setFallbackICEServerAllowed(e)}),this.state={mediaDevices:!1,activeAudioOutput:null,activeAudioInput:null,activeVideoInput:null}}async componentDidMount(){await d.b.hasAnyLabeledDevices()&&this._refreshMediaDevices()}_renderDeviceOptions(e,t){return e.map(e=>r.a.createElement("option",{key:`${t}-${e.deviceId}`,value:e.deviceId},e.label))}render(){const e=p.getComponent("views.elements.SettingsFlag");let t=null,s=null,n=null,i=null;if(!1===this.state.mediaDevices)t=r.a.createElement("div",{className:"mx_VoiceUserSettingsTab_missingMediaPermissions"},r.a.createElement("p",null,Object(c.a)("Missing media permissions, click the button below to request.")),r.a.createElement(h.a,{onClick:this._requestMediaPermissions,kind:"primary"},Object(c.a)("Request media permissions")));else if(this.state.mediaDevices){s=r.a.createElement("p",null,Object(c.a)("No Audio Outputs detected")),n=r.a.createElement("p",null,Object(c.a)("No Microphones detected")),i=r.a.createElement("p",null,Object(c.a)("No Webcams detected"));const e={deviceId:"",label:Object(c.a)("Default Device")},t=t=>t.some(e=>"default"===e.deviceId)?"default":(t.unshift(e),""),o=this.state.mediaDevices.audioOutput.slice(0);if(o.length>0){const e=t(o);s=r.a.createElement(u.a,{element:"select",label:Object(c.a)("Audio Output"),value:this.state.activeAudioOutput||e,onChange:this._setAudioOutput},this._renderDeviceOptions(o,"audioOutput"))}const a=this.state.mediaDevices.audioInput.slice(0);if(a.length>0){const e=t(a);n=r.a.createElement(u.a,{element:"select",label:Object(c.a)("Microphone"),value:this.state.activeAudioInput||e,onChange:this._setAudioInput},this._renderDeviceOptions(a,"audioInput"))}const l=this.state.mediaDevices.videoInput.slice(0);if(l.length>0){const e=t(l);i=r.a.createElement(u.a,{element:"select",label:Object(c.a)("Camera"),value:this.state.activeVideoInput||e,onChange:this._setVideoInput},this._renderDeviceOptions(l,"videoInput"))}}return r.a.createElement("div",{className:"mx_SettingsTab mx_VoiceUserSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Voice & Video")),r.a.createElement("div",{className:"mx_SettingsTab_section"},t,s,n,i,r.a.createElement(e,{name:"VideoView.flipVideoHorizontally",level:v.a.ACCOUNT}),r.a.createElement(e,{name:"webRtcAllowPeerToPeer",level:v.a.DEVICE,onChange:this._changeWebRtcMethod}),r.a.createElement(e,{name:"fallbackICEServerAllowed",level:v.a.DEVICE,onChange:this._changeFallbackICEServerAllowed})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return C}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(94),d=s(100),u=s(113),h=s(102),m=s(137),p=s(99),g=s(95),v=s(118),f=s(442),b=s(659),y=s(93),_=s(142),E=s(109);function S(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function w(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?S(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):S(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let C=Object(y.a)("views.settings.tabs.user.HelpUserSettingsTab")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"closeCopiedTooltip",void 0),o()(this,"onClearCacheAndReload",e=>{v.a.get()&&(console.log("Clear cache & reload clicked"),l.a.get().stopClient(),l.a.get().store.deleteAllData().then(()=>{v.a.get().reload()}))}),o()(this,"onBugReport",e=>{const t=g.getComponent("dialogs.BugReportDialog");t&&p.a.createTrackedDialog("Bug Report Dialog","",t,{})}),o()(this,"onStartBotChat",e=>{this.props.closeSettingsFn(),Object(m.b)({dmUserId:h.a.get().welcomeUserId,andView:!0})}),o()(this,"showSpoiler",e=>{const t=e.target;t.innerHTML=t.getAttribute("data-spoiler");const s=document.createRange();s.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(s)}),o()(this,"onAccessTokenCopyClick",async e=>{e.preventDefault();const t=e.target,s=await Object(_.c)(l.a.get().getAccessToken()),n=t.getBoundingClientRect(),i=g.getComponent("context_menus.GenericTextContextMenu"),{close:o}=E.n(i,w(w({},Object(E.p)(n,2)),{},{message:s?Object(c.a)("Copied!"):Object(c.a)("Failed to copy")}));this.closeCopiedTooltip=t.onmouseleave=o}),this.state={appVersion:null,canUpdate:!1}}componentDidMount(){v.a.get().getAppVersion().then(e=>this.setState({appVersion:e})).catch(e=>{console.error("Error getting vector version: ",e)}),v.a.get().canSelfUpdate().then(e=>this.setState({canUpdate:e})).catch(e=>{console.error("Error getting self updatability: ",e)})}componentWillUnmount(){this.closeCopiedTooltip&&this.closeCopiedTooltip()}renderLegal(){if(!h.a.get().terms_and_conditions_links)return null;const e=[];for(const t of h.a.get().terms_and_conditions_links)e.push(r.a.createElement("div",{key:t.url},r.a.createElement("a",{href:t.url,rel:"noreferrer noopener",target:"_blank"},t.text)));return r.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Legal")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},e))}renderCredits(){return r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Credits")),r.a.createElement("ul",null,r.a.createElement("li",null,"The ",r.a.createElement("a",{href:"themes/element/img/backgrounds/ocean.jpg",rel:"noreferrer noopener",target:"_blank"}," default cover photo")," is from ",r.a.createElement("a",{href:"https://pixabay.com/de/photos/unterwasser-blau-ozean-meer-802092/",rel:"noreferrer noopener",target:"_blank"},"here")," ","used under the terms of the ",r.a.createElement("a",{href:"https://pixabay.com/de/service/license/",rel:"noreferrer noopener",target:"_blank"},"Pixabay License"),"."),r.a.createElement("li",null,"The ",r.a.createElement("a",{href:"https://github.com/matrix-org/twemoji-colr",rel:"noreferrer noopener",target:"_blank"},"twemoji-colr")," font is © ",r.a.createElement("a",{href:"https://mozilla.org",rel:"noreferrer noopener",target:"_blank"},"Mozilla Foundation")," used under the terms of ",r.a.createElement("a",{href:"http://www.apache.org/licenses/LICENSE-2.0",rel:"noreferrer noopener",target:"_blank"},"Apache 2.0"),"."),r.a.createElement("li",null,"The ",r.a.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twemoji")," emoji art is © ",r.a.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twitter, Inc and other contributors")," used under the terms of ",r.a.createElement("a",{href:"https://creativecommons.org/licenses/by/4.0/",rel:"noreferrer noopener",target:"_blank"},"CC-BY 4.0"),".")))}render(){const e=h.a.get().brand;let t=Object(c.a)("For help with using %(brand)s, click <a>here</a>.",{brand:e},{a:e=>r.a.createElement("a",{href:"https://element.io/help",rel:"noreferrer noopener",target:"_blank"},e)});h.a.get().welcomeUserId&&Object(c.d)().startsWith("en")&&(t=r.a.createElement("div",null,Object(c.a)("For help with using %(brand)s, click <a>here</a> or start a chat with our bot using the button below.",{brand:e},{a:e=>r.a.createElement("a",{href:"https://element.io/help",rel:"noreferrer noopener",target:"_blank"},e)}),r.a.createElement("div",null,r.a.createElement(d.a,{onClick:this.onStartBotChat,kind:"primary"},Object(c.a)("Chat with %(brand)s Bot",{brand:e})))));const s=this.state.appVersion||"unknown";let n=l.a.get().olmVersion;n=n?`${n[0]}.${n[1]}.${n[2]}`:"<not-enabled>";let i,o=null;return this.state.canUpdate&&(o=r.a.createElement(b.a,null)),h.a.get().bug_report_endpoint_url&&(i=r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Bug reporting")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("If you've submitted a bug via GitHub, debug logs can help us track down the problem. Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited and the usernames of other users. They do not contain messages."),r.a.createElement("div",{className:"mx_HelpUserSettingsTab_debugButton"},r.a.createElement(d.a,{onClick:this.onBugReport,kind:"primary"},Object(c.a)("Submit debug logs"))),Object(c.a)("To report a Matrix-related security issue, please read the Matrix.org <a>Security Disclosure Policy</a>.",{},{a:e=>r.a.createElement("a",{href:"https://matrix.org/security-disclosure-policy/",rel:"noreferrer noopener",target:"_blank"},e)})))),r.a.createElement("div",{className:"mx_SettingsTab mx_HelpUserSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Help & About")),i,r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("FAQ")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},t),r.a.createElement(d.a,{kind:"primary",onClick:f.f},Object(c.a)("Keyboard Shortcuts"))),r.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Versions")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("%(brand)s version:",{brand:e})," ",s,r.a.createElement("br",null),Object(c.a)("olm version:")," ",n,r.a.createElement("br",null),o)),this.renderLegal(),this.renderCredits(),r.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Advanced")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Homeserver is")," ",r.a.createElement("code",null,l.a.get().getHomeserverUrl()),r.a.createElement("br",null),Object(c.a)("Identity Server is")," ",r.a.createElement("code",null,l.a.get().getIdentityServerUrl()),r.a.createElement("br",null),r.a.createElement("br",null),r.a.createElement("details",null,r.a.createElement("summary",null,Object(c.a)("Access Token")),r.a.createElement("br",null),r.a.createElement("b",null,Object(c.a)("Your access token gives full access to your account. Do not share it with anyone.")),r.a.createElement("div",{className:"mx_HelpUserSettingsTab_accessToken"},r.a.createElement("code",null,l.a.get().getAccessToken()),r.a.createElement(u.a,{title:Object(c.a)("Copy"),onClick:this.onAccessTokenCopyClick,className:"mx_HelpUserSettingsTab_accessToken_copy"}))),r.a.createElement("br",null),r.a.createElement("div",{className:"mx_HelpUserSettingsTab_debugButton"},r.a.createElement(d.a,{onClick:this.onClearCacheAndReload,kind:"danger"},Object(c.a)("Clear cache and reload"))))))}})||n},function(e,t,s){"use strict";var n=s(108),i=s.n(n),o=s(91),a=s.n(o),r=s(255),c=s(118),l=s(586),d=s(96),u=s(103),h=s(92),m=s(172),p=s(100);function g(){c.a.get().installUpdate()}const v=[r.d.Ready,r.d.Error,r.d.NotAvailable];t.a=()=>{const[e,t]=Object(o.useState)(null);Object(l.a)(d.a,e=>{let{action:s}=e,n=i()(e,["action"]);s===u.a.CheckUpdates&&t(n)});const s=e&&!v.includes(e.status);let n;return e&&(n=a.a.createElement("span",{className:"mx_UpdateCheckButton_summary"},function(e,t){switch(e){case r.d.Error:return Object(h.a)("Error encountered (%(errorDetail)s).",{errorDetail:t});case r.d.Checking:return Object(h.a)("Checking for an update...");case r.d.NotAvailable:return Object(h.a)("No update available.");case r.d.Downloading:return Object(h.a)("Downloading update...");case r.d.Ready:return Object(h.a)("New version available. <a>Update now.</a>",{},{a:e=>a.a.createElement(p.a,{kind:"link",onClick:g},e)})}}(e.status,e.detail),s&&a.a.createElement(m.a,null))),a.a.createElement(a.a.Fragment,null,a.a.createElement(p.a,{onClick:()=>{t(null),c.a.get().startUpdateCheck()},kind:"primary",disabled:s},Object(h.a)("Check for update")),n)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n,i=s(91),o=s.n(i),a=s(92),r=s(661),c=s(93);let l=Object(c.a)("views.settings.tabs.user.FlairUserSettingsTab")(n=class extends o.a.Component{render(){return o.a.createElement("div",{className:"mx_SettingsTab"},o.a.createElement("span",{className:"mx_SettingsTab_heading"},Object(a.a)("Flair")),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement(r.a,null)))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(95),u=s(92),h=s(105),m=s(93);let p=Object(m.a)("views.groups.GroupUserSettings")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{error:null,groups:null})}componentDidMount(){this.context.getJoinedGroups().then(e=>{this.setState({groups:e.groups||[],error:null})},e=>{console.error(e),this.setState({groups:null,error:e})})}render(){let e="",t=null;const s=this.state.groups;if(this.state.error)e=Object(u.a)("Something went wrong when trying to get your communities.");else if(null===s)e=Object(u.a)("Loading...");else if(s.length>0){const n=d.getComponent("groups.GroupPublicityToggle");t=s.map((e,t)=>l.a.createElement(n,{key:t,groupId:e})),e=Object(u.a)("Display your community flair in rooms configured to show it.")}else e=Object(u.a)("You're not currently a member of any communities.");return l.a.createElement("div",null,l.a.createElement("p",{className:"mx_SettingsTab_subsectionText"},e),l.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},t))}},r()(i,"contextType",h.a),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(102),d=s(409),u=s(349),h=s(99),m=s(94),p=s(95),g=s(93);let v=Object(g.a)("views.settings.tabs.user.MjolnirUserSettingsTab")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"onPersonalRuleChanged",e=>{this.setState({newPersonalRule:e.target.value})}),o()(this,"onNewListChanged",e=>{this.setState({newList:e.target.value})}),o()(this,"onAddPersonalRule",async e=>{e.preventDefault(),e.stopPropagation();let t=u.d;this.state.newPersonalRule.startsWith("@")&&(t=u.e),this.setState({busy:!0});try{const e=await d.a.sharedInstance().getOrCreatePersonalList();await e.banEntity(t,this.state.newPersonalRule,Object(c.a)("Ignored/Blocked")),this.setState({newPersonalRule:""})}catch(e){console.error(e);const t=p.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Failed to add Mjolnir rule","",t,{title:Object(c.a)("Error adding ignored user/server"),description:Object(c.a)("Something went wrong. Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}),o()(this,"onSubscribeList",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=await m.a.get().joinRoom(this.state.newList);await d.a.sharedInstance().subscribeToList(e.roomId),this.setState({newList:""})}catch(e){console.error(e);const t=p.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Failed to subscribe to Mjolnir list","",t,{title:Object(c.a)("Error subscribing to list"),description:Object(c.a)("Please verify the room ID or address and try again.")})}finally{this.setState({busy:!1})}}),this.state={busy:!1,newPersonalRule:"",newList:""}}async removePersonalRule(e){this.setState({busy:!0});try{const t=d.a.sharedInstance().getPersonalList();await t.unbanEntity(e.kind,e.entity)}catch(e){console.error(e);const t=p.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Failed to remove Mjolnir rule","",t,{title:Object(c.a)("Error removing ignored user/server"),description:Object(c.a)("Something went wrong. Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}async unsubscribeFromList(e){this.setState({busy:!0});try{await d.a.sharedInstance().unsubscribeFromList(e.roomId),await m.a.get().leave(e.roomId)}catch(e){console.error(e);const t=p.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Failed to unsubscribe from Mjolnir list","",t,{title:Object(c.a)("Error unsubscribing from list"),description:Object(c.a)("Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}viewListRules(e){const t=p.getComponent("dialogs.QuestionDialog"),s=m.a.get().getRoom(e.roomId),n=s?s.name:e.roomId,i=e=>{if(0===e.length)return r.a.createElement("i",null,Object(c.a)("None"));const t=[];for(const s of e)t.push(r.a.createElement("li",{key:s.kind+s.entity},r.a.createElement("code",null,s.entity)));return r.a.createElement("ul",null,t)};h.a.createTrackedDialog("View Mjolnir list rules","",t,{title:Object(c.a)("Ban list rules - %(roomName)s",{roomName:n}),description:r.a.createElement("div",null,r.a.createElement("h3",null,Object(c.a)("Server rules")),i(e.serverRules),r.a.createElement("h3",null,Object(c.a)("User rules")),i(e.userRules)),button:Object(c.a)("Close"),hasCancelButton:!1})}renderPersonalBanListRules(){const e=p.getComponent("elements.AccessibleButton"),t=d.a.sharedInstance().getPersonalList(),s=t?[...t.userRules,...t.serverRules]:[];if(!t||s.length<=0)return r.a.createElement("i",null,Object(c.a)("You have not ignored anyone."));const n=[];for(const t of s)n.push(r.a.createElement("li",{key:t.entity,className:"mx_MjolnirUserSettingsTab_listItem"},r.a.createElement(e,{kind:"danger_sm",onClick:()=>this.removePersonalRule(t),disabled:this.state.busy},Object(c.a)("Remove"))," ",r.a.createElement("code",null,t.entity)));return r.a.createElement("div",null,r.a.createElement("p",null,Object(c.a)("You are currently ignoring:")),r.a.createElement("ul",null,n))}renderSubscribedBanLists(){const e=p.getComponent("elements.AccessibleButton"),t=d.a.sharedInstance().getPersonalList(),s=d.a.sharedInstance().lists.filter(e=>!t||t.roomId!==e.roomId);if(!s||s.length<=0)return r.a.createElement("i",null,Object(c.a)("You are not subscribed to any lists"));const n=[];for(const t of s){const s=m.a.get().getRoom(t.roomId),i=s?r.a.createElement("span",null,s.name," (",r.a.createElement("code",null,t.roomId),")"):r.a.createElement("code",null,"list.roomId");n.push(r.a.createElement("li",{key:t.roomId,className:"mx_MjolnirUserSettingsTab_listItem"},r.a.createElement(e,{kind:"danger_sm",onClick:()=>this.unsubscribeFromList(t),disabled:this.state.busy},Object(c.a)("Unsubscribe"))," ",r.a.createElement(e,{kind:"primary_sm",onClick:()=>this.viewListRules(t),disabled:this.state.busy},Object(c.a)("View rules"))," ",i))}return r.a.createElement("div",null,r.a.createElement("p",null,Object(c.a)("You are currently subscribed to:")),r.a.createElement("ul",null,n))}render(){const e=p.getComponent("elements.Field"),t=p.getComponent("elements.AccessibleButton"),s=l.a.get().brand;return r.a.createElement("div",{className:"mx_SettingsTab mx_MjolnirUserSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Ignored users")),r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"warning"},Object(c.a)("⚠ These settings are meant for advanced users.")),r.a.createElement("br",null),r.a.createElement("br",null),Object(c.a)("Add users and servers you want to ignore here. Use asterisks to have %(brand)s match any characters. For example, <code>@bot:*</code> would ignore all users that have the name 'bot' on any server.",{brand:s},{code:e=>r.a.createElement("code",null,e)}),r.a.createElement("br",null),r.a.createElement("br",null),Object(c.a)("Ignoring people is done through ban lists which contain rules for who to ban. Subscribing to a ban list means the users/servers blocked by that list will be hidden from you."))),r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Personal ban list")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Your personal ban list holds all the users/servers you personally don't want to see messages from. After ignoring your first user/server, a new room will show up in your room list named 'My Ban List' - stay in this room to keep the ban list in effect.")),r.a.createElement("div",null,this.renderPersonalBanListRules()),r.a.createElement("div",null,r.a.createElement("form",{onSubmit:this.onAddPersonalRule,autoComplete:"off"},r.a.createElement(e,{type:"text",label:Object(c.a)("Server or user ID to ignore"),placeholder:Object(c.a)("eg: @bot:* or example.org"),value:this.state.newPersonalRule,onChange:this.onPersonalRuleChanged}),r.a.createElement(t,{type:"submit",kind:"primary",onClick:this.onAddPersonalRule,disabled:this.state.busy},Object(c.a)("Ignore"))))),r.a.createElement("div",{className:"mx_SettingsTab_section"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Subscribed lists")),r.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"warning"},Object(c.a)("Subscribing to a ban list will cause you to join it!"))," ",r.a.createElement("span",null,Object(c.a)("If this isn't what you want, please use a different tool to ignore users."))),r.a.createElement("div",null,this.renderSubscribedBanLists()),r.a.createElement("div",null,r.a.createElement("form",{onSubmit:this.onSubscribeList,autoComplete:"off"},r.a.createElement(e,{type:"text",label:Object(c.a)("Room ID or address of ban list"),value:this.state.newList,onChange:this.onNewListChanged}),r.a.createElement(t,{type:"submit",kind:"primary",onClick:this.onSubscribeList,disabled:this.state.busy},Object(c.a)("Subscribe"))))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(387),m=s(92),p=s(112),g=s(111),v=s(93);let f=Object(v.a)("views.elements.PowerSelector")((o=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onSelectChange",e=>{"SELECT_VALUE_CUSTOM"===e.target.value?this.setState({custom:!0}):(this.props.onChange(e.target.value,this.props.powerLevelKey),this.setState({selectValue:e.target.value}))}),r()(this,"onCustomChange",e=>{this.setState({customValue:e.target.value})}),r()(this,"onCustomBlur",e=>{e.preventDefault(),e.stopPropagation(),this.props.onChange(parseInt(this.state.customValue),this.props.powerLevelKey)}),r()(this,"onCustomKeyDown",e=>{e.key===g.a.ENTER&&(e.preventDefault(),e.stopPropagation(),e.target.blur())}),this.state={levelRoleMap:{},options:[],customValue:this.props.value,selectValue:0}}UNSAFE_componentWillMount(){this._initStateFromProps(this.props)}UNSAFE_componentWillReceiveProps(e){this._initStateFromProps(e)}_initStateFromProps(e){const t=h.a(e.usersDefault),s=Object.keys(t).filter(t=>void 0===t||t<=e.maxValue||t==e.value),n=void 0===t[e.value];this.setState({levelRoleMap:t,options:s,custom:n,customLevel:e.value,selectValue:n?"SELECT_VALUE_CUSTOM":e.value})}render(){let e;const t=void 0===this.props.label?Object(m.a)("Power level"):this.props.label;if(this.state.custom)e=l.a.createElement(p.a,{type:"number",label:t,max:this.props.maxValue,onBlur:this.onCustomBlur,onKeyDown:this.onCustomKeyDown,onChange:this.onCustomChange,value:String(this.state.customValue),disabled:this.props.disabled});else{let s=this.state.options.map(e=>({value:e,text:h.b(e,this.props.usersDefault)}));s.push({value:"SELECT_VALUE_CUSTOM",text:Object(m.a)("Custom level")}),s=s.map(e=>l.a.createElement("option",{value:e.value,key:e.value},e.text)),e=l.a.createElement(p.a,{element:"select",label:t,onChange:this.onSelectChange,value:String(this.state.selectValue),disabled:this.props.disabled},s)}return l.a.createElement("div",{className:"mx_PowerSelector"},e)}},r()(i,"propTypes",{value:u.a.number.isRequired,maxValue:u.a.number.isRequired,usersDefault:u.a.number.isRequired,disabled:u.a.bool,onChange:u.a.func,powerLevelKey:u.a.string,label:u.a.string}),r()(i,"defaultProps",{maxValue:1/0,usersDefault:0}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(95),u=s(92),h=s(93),m=s(107);let p=Object(h.a)("views.dialogs.ConfirmUserActionDialog")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"reasonField",l.a.createRef()),r()(this,"onOk",()=>{var e;this.props.onFinished(!0,null===(e=this.reasonField.current)||void 0===e?void 0:e.value)}),r()(this,"onCancel",()=>{this.props.onFinished(!1)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=d.getComponent("views.avatars.MemberAvatar"),n=d.getComponent("views.avatars.BaseAvatar"),i=this.props.danger?"danger":"";let o,a,r,c;if(this.props.askReason&&(o=l.a.createElement("div",null,l.a.createElement("form",{onSubmit:this.onOk},l.a.createElement("input",{className:"mx_ConfirmUserActionDialog_reasonField",ref:this.reasonField,placeholder:Object(u.a)("Reason"),autoFocus:!0})))),this.props.member)a=l.a.createElement(s,{member:this.props.member,width:48,height:48}),r=this.props.member.name,c=this.props.member.userId;else{const e=this.props.groupMember.avatarUrl?Object(m.b)(this.props.groupMember.avatarUrl).getSquareThumbnailHttp(48):null;r=this.props.groupMember.displayname||this.props.groupMember.userId,c=this.props.groupMember.userId,a=l.a.createElement(n,{name:r,url:e,width:48,height:48})}return l.a.createElement(e,{className:"mx_ConfirmUserActionDialog",onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content"},l.a.createElement("div",{id:"mx_Dialog_content",className:"mx_Dialog_content"},l.a.createElement("div",{className:"mx_ConfirmUserActionDialog_avatar"},a),l.a.createElement("div",{className:"mx_ConfirmUserActionDialog_name"},r),l.a.createElement("div",{className:"mx_ConfirmUserActionDialog_userId"},c)),o,l.a.createElement(t,{primaryButton:this.props.action,onPrimaryButtonClick:this.onOk,primaryButtonClass:i,focus:!this.props.askReason,onCancel:this.onCancel}))}},r()(i,"defaultProps",{danger:!1,askReason:!1}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(94),l=s(92),d=s(96),u=s(95),h=s(99),m=s(157),p=s(129),g=s(191),v=s(93),f=s(98);let b=Object(v.a)("views.rooms.ThirdPartyMemberInfo")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"room",void 0),o()(this,"onRoomStateEvents",e=>{if("m.room.third_party_invite"===e.getType()&&e.getStateKey()===this.state.stateKey){const t=e.getContent().display_name,s={invited:Object(m.c)(e)};t&&(s.displayName=t),this.setState(s)}}),o()(this,"onCancel",()=>{d.a.dispatch({action:"view_3pid_invite",event:null})}),o()(this,"onKickClick",()=>{c.a.get().sendStateEvent(this.state.roomId,"m.room.third_party_invite",{},this.state.stateKey).catch(e=>{console.error(e),this.setState({invited:!0});const t=u.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Revoke 3pid invite failed","",t,{title:Object(l.a)("Failed to revoke invite"),description:Object(l.a)("Could not revoke the invite. The server may be experiencing a temporary problem or you do not have sufficient permissions to revoke the invite.")})}),this.setState({invited:!1})}),this.room=c.a.get().getRoom(this.props.event.getRoomId());const t=this.room.getMember(c.a.get().getUserId()),s=this.room.currentState.getStateEvents("m.room.power_levels","");let n=s?s.getContent().kick:50;"number"!=typeof n&&(n=50);const i=this.room.getMember(this.props.event.getSender());this.state={stateKey:this.props.event.getStateKey(),roomId:this.props.event.getRoomId(),displayName:this.props.event.getContent().display_name,invited:!0,canKick:!!t&&t.powerLevel>n,senderName:i?i.name:this.props.event.getSender()}}componentDidMount(){c.a.get().on("RoomState.events",this.onRoomStateEvents)}componentWillUnmount(){const e=c.a.get();e&&e.removeListener("RoomState.events",this.onRoomStateEvents)}render(){const e=u.getComponent("elements.AccessibleButton");let t,s=null;return this.state.canKick&&this.state.invited&&(s=r.a.createElement("div",{className:"mx_MemberInfo_container"},r.a.createElement("h3",null,Object(l.a)("Admin Tools")),r.a.createElement("div",{className:"mx_MemberInfo_buttons"},r.a.createElement(e,{className:"mx_MemberInfo_field",onClick:this.onKickClick},Object(l.a)("Revoke invite"))))),f.b.getValue("feature_spaces")&&this.room.isSpaceRoom()&&(t=r.a.createElement("div",{className:"mx_RightPanel_scopeHeader"},r.a.createElement(p.a,{room:this.room,height:32,width:32}),r.a.createElement(g.a,{room:this.room}))),r.a.createElement("div",{className:"mx_MemberInfo",role:"tabpanel"},t,r.a.createElement("div",{className:"mx_MemberInfo_name"},r.a.createElement(e,{className:"mx_MemberInfo_cancel",onClick:this.onCancel,title:Object(l.a)("Close")}),r.a.createElement("h2",null,this.state.displayName)),r.a.createElement("div",{className:"mx_MemberInfo_container"},r.a.createElement("div",{className:"mx_MemberInfo_profile"},r.a.createElement("div",{className:"mx_MemberInfo_profileField"},Object(l.a)("Invited by %(sender)s",{sender:this.state.senderName})))),s)}})||n},function(e,t,s){"use strict";var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(294),m=s(95),p=s(94),g=s(231),v=s(92),f=s(204),b=s(126),y=s(443),_=s(93);let E=Object(_.a)("structures.FilePanel")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"decryptingEvents",new Set),r()(this,"state",{timelineSet:null}),r()(this,"onRoomTimeline",(e,t,s,n,i)=>{var o;if((null==t?void 0:t.roomId)!==(null===(o=this.props)||void 0===o?void 0:o.roomId))return;if(s||!i||!i.liveEvent||e.isRedacted())return;p.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()?this.decryptingEvents.add(e.getId()):this.addEncryptedLiveEvent(e)}),r()(this,"onEventDecrypted",(e,t)=>{if(e.getRoomId()!==this.props.roomId)return;const s=e.getId();this.decryptingEvents.delete(s)&&(t||this.addEncryptedLiveEvent(e))}),r()(this,"onPaginationRequest",(e,t,s)=>{const n=p.a.get(),i=g.a.get(),o=this.props.roomId,a=n.getRoom(o);return n.isRoomEncrypted(o)&&null!==i?i.paginateTimelineWindow(a,e,t,s):e.paginate(t,s)})}addEncryptedLiveEvent(e,t){if(!this.state.timelineSet)return;const s=this.state.timelineSet.getLiveTimeline();"m.room.message"===e.getType()&&-1!=["m.file","m.image","m.video","m.audio"].indexOf(e.getContent().msgtype)&&(this.state.timelineSet.eventIdToTimeline(e.getId())||this.state.timelineSet.addEventToTimeline(e,s,!1))}async componentDidMount(){const e=p.a.get();await this.updateTimelineSet(this.props.roomId),p.a.get().isRoomEncrypted(this.props.roomId)&&null!==g.a.get()&&(e.on("Room.timeline",this.onRoomTimeline),e.on("Event.decrypted",this.onEventDecrypted))}componentWillUnmount(){const e=p.a.get();null!==e&&p.a.get().isRoomEncrypted(this.props.roomId)&&null!==g.a.get()&&(e.removeListener("Room.timeline",this.onRoomTimeline),e.removeListener("Event.decrypted",this.onEventDecrypted))}async fetchFileEventsServer(e){const t=p.a.get(),s=new h.a(t.credentials.userId);s.setDefinition({room:{timeline:{contains_url:!0,types:["m.room.message"]}}});const n=await t.getOrCreateFilter("FILTER_FILES_"+t.credentials.userId,s);s.filterId=n;return e.getOrCreateFilteredTimelineSet(s)}async updateTimelineSet(e){const t=p.a.get(),s=t.getRoom(e),n=g.a.get();if(this.noRoom=!s,s){let i;try{if(i=await this.fetchFileEventsServer(s),t.isRoomEncrypted(e)&&null!==n){const e=i.getLiveTimeline();await n.populateFileTimeline(i,e,s,10)}this.setState({timelineSet:i})}catch(e){console.error("Failed to get or create file panel filter",e)}}else console.error("Failed to add filtered timelineSet for FilePanel as no room!")}render(){if(p.a.get().isGuest())return l.a.createElement(f.b,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,previousPhase:b.c.RoomSummary},l.a.createElement("div",{className:"mx_RoomView_empty"},Object(v.a)("You must <a>register</a> to use this functionality",{},{a:e=>l.a.createElement("a",{href:"#/register",key:"sub"},e)})));if(this.noRoom)return l.a.createElement(f.b,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,previousPhase:b.c.RoomSummary},l.a.createElement("div",{className:"mx_RoomView_empty"},Object(v.a)("You must join the room to see its files")));const e=m.getComponent("structures.TimelinePanel"),t=m.getComponent("elements.Spinner"),s=l.a.createElement("div",{className:"mx_RightPanel_empty mx_FilePanel_empty"},l.a.createElement("h2",null,Object(v.a)("No files visible in this room")),l.a.createElement("p",null,Object(v.a)("Attach files from chat or just drag and drop them anywhere in a room."))),n=!this.noRoom&&p.a.get().isRoomEncrypted(this.props.roomId);return this.state.timelineSet?l.a.createElement(f.b,{className:"mx_FilePanel",onClose:this.props.onClose,previousPhase:b.c.RoomSummary,withoutScrollContainer:!0},l.a.createElement(y.b,{isRoomEncrypted:n,kind:y.a.Files}),l.a.createElement(e,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:this.state.timelineSet,showUrlPreview:!1,onPaginationRequest:this.onPaginationRequest,tileShape:"file_grid",resizeNotifier:this.props.resizeNotifier,empty:s})):l.a.createElement(f.b,{className:"mx_FilePanel",onClose:this.props.onClose,previousPhase:b.c.RoomSummary},l.a.createElement(t,null))}},r()(i,"propTypes",{roomId:u.a.string.isRequired,onClose:u.a.func.isRequired}),n=o))||n;t.a=E},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i=s(91),o=s.n(i),a=s(92),r=s(94),c=s(204),l=s(93),d=s(444),u=s(119);let h=Object(l.a)("structures.NotificationPanel")(n=class extends o.a.PureComponent{render(){const e=o.a.createElement("div",{className:"mx_RightPanel_empty mx_NotificationPanel_empty"},o.a.createElement("h2",null,Object(a.a)("You’re all caught up")),o.a.createElement("p",null,Object(a.a)("You have no visible notifications.")));let t;const s=r.a.get().getNotifTimelineSet();return s?t=o.a.createElement(d.a,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:s,showUrlPreview:!1,tileShape:"notif",empty:e,alwaysShowTimestamps:!0}):(console.error("No notifTimelineSet available!"),t=o.a.createElement(u.a,null)),o.a.createElement(c.b,{className:"mx_NotificationPanel",onClose:this.props.onClose,withoutScrollContainer:!0},t)}})||n},function(e,t,s){"use strict";s.d(t,"c",(function(){return U})),s.d(t,"a",(function(){return F}));var n=s(18),i=s.n(n),o=s(104),a=s.n(o),r=s(91),c=s.n(r),l=s(110),d=s(101),u=s.n(d),h=s(117),m=s(94),p=s(96),g=s(92),v=s(100),f=s(124),b=s(119),y=s(281),_=s(129),E=s(191),S=s(408),w=s(320),C=s(148),k=s(125),O=s(130),R=s(107),I=s(433),x=s(205),T=s(338),j=s(145),N=s(113),P=s(134);function D(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function A(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?D(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):D(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const M=({room:e,suggested:t,selected:s,hasPermissions:n,onToggleClick:i,onViewRoomClick:o,numChildRooms:a,children:r})=>{var d,h,p,f,b;const y=m.a.get(),E="join"===(null===(d=y.getRoom(e.room_id))||void 0===d?void 0:d.getMyMembership())?y.getRoom(e.room_id):null,S=(null==E?void 0:E.name)||e.name||e.canonical_alias||(null===(h=e.aliases)||void 0===h?void 0:h[0])||(e.room_type===l.e.Space?Object(g.a)("Unnamed Space"):Object(g.a)("Unnamed Room")),[w,k]=Object(T.a)(!0),j=e=>{e.preventDefault(),e.stopPropagation(),o(!1)},N=e=>{e.preventDefault(),e.stopPropagation(),o(!0)};let D,A,M;E?D=c.a.createElement(v.a,{onClick:j,kind:"primary_outline"},Object(g.a)("View")):N&&(D=c.a.createElement(v.a,{onClick:N,kind:"primary"},Object(g.a)("Join"))),i&&(A=n?c.a.createElement(C.a,{checked:!!s,onChange:i}):c.a.createElement(x.a,{tooltip:Object(g.a)("You don't have permission"),onClick:e=>{e.stopPropagation()}},c.a.createElement(C.a,{disabled:!0}))),M=E?c.a.createElement(_.a,{room:E,width:20,height:20}):c.a.createElement(O.a,{name:S,idName:e.room_id,url:e.avatar_url?Object(R.b)(e.avatar_url).getSquareThumbnailHttp(20):null,width:20,height:20});let U=Object(g.a)("%(count)s members",{count:e.num_joined_members});void 0!==a&&(U+=" · "+Object(g.a)("%(count)s rooms",{count:a}));const L=(null==E||null===(p=E.currentState)||void 0===p||null===(f=p.getStateEvents(l.a.RoomTopic,""))||void 0===f||null===(b=f.getContent())||void 0===b?void 0:b.topic)||e.topic;let F;L&&(U+=" · "+L),t&&(F=c.a.createElement(I.a,{tooltip:Object(g.a)("This room is suggested as a good one to join")},Object(g.a)("Suggested")));const B=c.a.createElement(c.a.Fragment,null,M,c.a.createElement("div",{className:"mx_SpaceRoomDirectory_roomTile_name"},S,F),c.a.createElement("div",{className:"mx_SpaceRoomDirectory_roomTile_info",ref:e=>e&&Object(P.g)(e),onClick:e=>{"A"===e.target.tagName&&e.stopPropagation()}},U),c.a.createElement("div",{className:"mx_SpaceRoomDirectory_actions"},D,A));let V,K;return r&&(V=c.a.createElement("div",{className:u()("mx_SpaceRoomDirectory_subspace_toggle",{mx_SpaceRoomDirectory_subspace_toggle_shown:w}),onClick:e=>{e.stopPropagation(),k()}}),w&&(K=c.a.createElement("div",{className:"mx_SpaceRoomDirectory_subspace_children"},r))),c.a.createElement(c.a.Fragment,null,c.a.createElement(v.a,{className:u()("mx_SpaceRoomDirectory_roomTile",{mx_SpaceRoomDirectory_subspace:e.room_type===l.e.Space}),onClick:n&&i?i:j},B,V),K)},U=(e,t,s=!1)=>{if(m.a.get().isGuest()&&!e.world_readable&&!e.guest_can_join)return void p.a.dispatch({action:"require_registration"});const n=function(e){return e.canonical_alias||(e.aliases?e.aliases[0]:"")}(e)||void 0;p.a.dispatch({action:"view_room",auto_join:s,should_peek:!0,_type:"room_directory",room_alias:n,room_id:e.room_id,via_servers:t,oob_data:{avatarUrl:e.avatar_url,name:e.name||n||Object(g.a)("Unnamed room")}})},L=({spaceId:e,rooms:t,relations:s,parents:n,selectedMap:i,onViewRoomClick:o,onToggleClick:a})=>{var r;const d=m.a.get(),u=d.getRoom(e),p=null==u?void 0:u.currentState.maySendStateEvent(l.a.SpaceChild,d.getUserId()),g=Array.from((null===(r=s.get(e))||void 0===r?void 0:r.values())||[]),v=Object(h.sortBy)(g,e=>Object(j.g)(e.content.order,null,e.state_key)),[f,b]=v.reduce((e,s)=>{const n=s.state_key;return t.has(n)?(e[t.get(n).room_type===l.e.Space?0:1].push(n),e):e},[[],[]])||[[],[]],y=new Set(n).add(e);return c.a.createElement(c.a.Fragment,null,b.map(n=>{var r,l,d;return c.a.createElement(M,{key:n,room:t.get(n),suggested:null===(r=s.get(e))||void 0===r||null===(l=r.get(n))||void 0===l?void 0:l.content.suggested,selected:null==i||null===(d=i.get(e))||void 0===d?void 0:d.has(n),onViewRoomClick:e=>{o(n,e)},hasPermissions:p,onToggleClick:a?()=>a(e,n):void 0})}),f.filter(e=>!y.has(e)).map(n=>{var r,l,d,u;return c.a.createElement(M,{key:n,room:t.get(n),numChildRooms:Array.from((null===(r=s.get(n))||void 0===r?void 0:r.values())||[]).filter(e=>t.has(e.state_key)&&!t.get(e.state_key).room_type).length,suggested:null===(l=s.get(e))||void 0===l||null===(d=l.get(n))||void 0===d?void 0:d.content.suggested,selected:null==i||null===(u=i.get(e))||void 0===u?void 0:u.has(n),onViewRoomClick:e=>{o(n,e)},hasPermissions:p,onToggleClick:a?()=>a(e,n):void 0},c.a.createElement(L,{spaceId:n,rooms:t,relations:s,parents:y,selectedMap:i,onViewRoomClick:o,onToggleClick:a}))}))},F=({space:e,initialText:t="",showRoom:s,refreshToken:n,additionalButtons:i,children:o})=>{const d=m.a.get(),u=d.getUserId(),[h,p]=Object(r.useState)(t),[f,_]=Object(r.useState)(new Map),[E,C,O,R,I]=((e,t,s)=>Object(S.a)(async()=>{try{const s=await e.getSpaceSummary(t.roomId),n=new w.a,i=new w.a,o=new w.a;return s.events.map(e=>{if(e.type===l.a.SpaceChild&&(n.getOrCreate(e.room_id,new Map).set(e.state_key,e),i.getOrCreate(e.state_key,new Set).add(e.room_id)),Array.isArray(e.content.via)){const t=o.getOrCreate(e.state_key,new Set);e.content.via.forEach(e=>t.add(e))}}),[null,s.rooms,n,o,i]}catch(e){return console.error(e),[e]}},[t,s],[void 0]))(d,e,n),x=Object(r.useMemo)(()=>{if(!C)return null;const e=h.toLowerCase().trim(),t=new Map(C.map(e=>[e.room_id,e]));if(!e)return t;const s=C.filter(t=>{var s,n;return(null===(s=t.name)||void 0===s?void 0:s.toLowerCase().includes(e))||(null===(n=t.topic)||void 0===n?void 0:n.toLowerCase().includes(e))}),n=new Set,i=[...s.map(e=>e.room_id)];for(;i.length;){var o;const e=i.pop();n.add(e),null===(o=I.get(e))||void 0===o||o.forEach(e=>{n.has(e)||i.push(e)})}return Array.from(t.keys()).forEach(e=>{n.has(e)||t.delete(e)}),t},[C,I,h]),[T,j]=Object(r.useState)(""),[P,D]=Object(r.useState)(!1),[M,U]=Object(r.useState)(!1);if(E)return c.a.createElement("p",null,Object(g.a)("Your server does not support showing space hierarchies."));let F;if(x){const t=Array.from(x.values()).filter(e=>!e.room_type).length,n=x.size-t-1;let r,h,m;if(r=n>1?Object(g.a)("%(count)s rooms and %(numSpaces)s spaces",{count:t,numSpaces:n}):n>0?Object(g.a)("%(count)s rooms and 1 space",{count:t,numSpaces:n}):Object(g.a)("%(count)s rooms",{count:t,numSpaces:n}),"join"===e.getMyMembership()&&e.currentState.maySendStateEvent(l.a.SpaceChild,u)){const e=Array.from(f.keys()).flatMap(e=>[...f.get(e).values()].map(t=>[e,t])),t=e.every(([e,t])=>{var s,n;return null===(s=O.get(e))||void 0===s||null===(n=s.get(t))||void 0===n?void 0:n.content.suggested}),s=!e.length||P||M;let n=v.a,i={};e.length||(n=N.a,i={tooltip:Object(g.a)("Select a room below first"),yOffset:-40}),h=c.a.createElement(c.a.Fragment,null,c.a.createElement(n,a()({},i,{onClick:async()=>{D(!0);try{for(const[t,s]of e)await d.sendStateEvent(t,l.a.SpaceChild,{},s),O.get(t).delete(s),O.get(t).size>0?O.set(t,new Map(O.get(t))):O.delete(t)}catch(e){j(Object(g.a)("Failed to remove some rooms. Try again later"))}D(!1)},kind:"danger_outline",disabled:s}),P?Object(g.a)("Removing..."):Object(g.a)("Remove")),c.a.createElement(n,a()({},i,{onClick:async()=>{U(!0);try{for(const[i,o]of e){var s,n;const e=!t,a=null===(s=O.get(i))||void 0===s||null===(n=s.get(o))||void 0===n?void 0:n.content;if(!a||a.suggested===e)continue;const r=A(A({},a),{},{suggested:!t});await d.sendStateEvent(i,l.a.SpaceChild,r,o),O.get(i).get(o).content=r,O.set(i,new Map(O.get(i)))}}catch(e){j("Failed to update some suggestions. Try again later")}U(!1),_(new Map)},kind:"primary_outline",disabled:s}),M?Object(g.a)("Saving..."):t?Object(g.a)("Mark as not suggested"):Object(g.a)("Mark as suggested")))}if(x.size){const t=null==e?void 0:e.currentState.maySendStateEvent(l.a.SpaceChild,d.getUserId());m=c.a.createElement(c.a.Fragment,null,c.a.createElement(L,{spaceId:e.roomId,rooms:x,relations:O,parents:new Set,selectedMap:f,onToggleClick:t?(e,t)=>{if(j(""),!f.has(e))return void _(new Map(f.set(e,new Set([t]))));const s=f.get(e);s.has(t)?(s.delete(t),_(new Map(f.set(e,new Set(s))))):_(new Map(f.set(e,new Set([...s,t]))))}:void 0,onViewRoomClick:(e,t)=>{s(x.get(e),Array.from(R.get(e)||[]),t)}}),o&&c.a.createElement("hr",null))}else m=c.a.createElement("div",{className:"mx_SpaceRoomDirectory_noResults"},c.a.createElement("h3",null,Object(g.a)("No results found")),c.a.createElement("div",null,Object(g.a)("You may want to try a different search or check for typos.")));F=c.a.createElement(c.a.Fragment,null,c.a.createElement("div",{className:"mx_SpaceRoomDirectory_listHeader"},r,c.a.createElement("span",null,i,h)),T&&c.a.createElement("div",{className:"mx_SpaceRoomDirectory_error"},T),c.a.createElement(k.a,{className:"mx_SpaceRoomDirectory_list"},m,o))}else F=c.a.createElement(b.a,null);return c.a.createElement(c.a.Fragment,null,c.a.createElement(y.a,{className:"mx_textinput_icon mx_textinput_search",placeholder:Object(g.a)("Search names and descriptions"),onSearch:p,autoFocus:!0,initialValue:t}),F)};t.b=({space:e,onFinished:t,initialText:s})=>{const n=()=>{p.a.dispatch({action:"view_create_room",public:!0}),t()},i=c.a.createElement(c.a.Fragment,null,c.a.createElement(_.a,{room:e,height:32,width:32}),c.a.createElement("div",null,c.a.createElement("h1",null,Object(g.a)("Explore rooms")),c.a.createElement("div",null,c.a.createElement(E.a,{room:e}))));return c.a.createElement(f.a,{className:"mx_SpaceRoomDirectory",hasCancel:!0,onFinished:t,title:i},c.a.createElement("div",{className:"mx_Dialog_content"},Object(g.a)("If you can't find the room you're looking for, ask for an invite or <a>create a new room</a>.",null,{a:e=>c.a.createElement(v.a,{kind:"link",onClick:n},e)}),c.a.createElement(F,{space:e,showRoom:(e,s,n=!1)=>{U(e,s,n),t()},initialText:s},c.a.createElement(v.a,{onClick:n,kind:"primary",className:"mx_SpaceRoomDirectory_createRoom"},Object(g.a)("Create room")))))}},function(e,t,s){"use strict";var n=s(104),i=s.n(n),o=s(108),a=s.n(o),r=s(91),c=s.n(r),l=s(117),d=s(171),u=s(92),h=s(127),m=s(205),p=s(412),g=s(105);const v=5,f=e=>{var t;return!(null===(t=h.a.shared().getDMRoomsForUserId(e.userId))||void 0===t||!t.length)};t.a=e=>{let{room:t,onlyKnownUsers:s=!0,numShown:n=v}=e,o=a()(e,["room","onlyKnownUsers","numShown"]);const h=Object(r.useContext)(g.a);let b=Object(p.b)(t);const y=[e=>!!e.getMxcAvatarUrl()];s?b=b.filter(f):y.unshift(e=>f(e));const _=Object(l.sortBy)(b.filter(e=>e.userId!==h.getUserId()),y).slice(0,n);if(_.length<1)return null;const E=_.map(e=>e.rawDisplayName).reverse().join(", ");let S;return S=o.onClick?c.a.createElement("div",null,c.a.createElement("div",{className:"mx_Tooltip_title"},Object(u.a)("View all %(count)s members",{count:b.length})),c.a.createElement("div",{className:"mx_Tooltip_sub"},Object(u.a)("Including %(commaSeparatedMembers)s",{commaSeparatedMembers:E}))):Object(u.a)("%(count)s members including %(commaSeparatedMembers)s",{count:b.length,commaSeparatedMembers:E}),c.a.createElement("div",i()({},o,{className:"mx_FacePile"}),c.a.createElement(m.a,{class:"mx_FacePile_faces",tooltip:S,tooltipProps:{yOffset:32}},b.length>n?c.a.createElement("span",{className:"mx_FacePile_face mx_FacePile_more"}):null,_.map(e=>c.a.createElement(d.a,{key:e.userId,member:e,width:28,height:28,className:"mx_FacePile_face"}))),s&&c.a.createElement("span",{className:"mx_FacePile_summary"},Object(u.a)("%(count)s people you know have already joined",{count:b.length})))}},function(e,t,s){"use strict";var n,i=s(91),o=s.n(i),a=s(110),r=s(92),c=s(100),l=s(671),d=s(338),u=s(173),h=s(339),m=s(291);!function(e){e.Unlisted="unlisted",e.Private="private"}(n||(n={}));const p=(e,t,s)=>{const[n,o]=Object(i.useState)(e);return[n,async n=>{o(n);try{await t(n)}catch(t){o(e()),s(t)}}]};t.a=({matrixClient:e,space:t})=>{const[s,g]=Object(i.useState)(""),v=e.getUserId(),[f,b]=p(()=>t.getJoinRule()===h.c.Invite?n.Private:n.Unlisted,s=>e.sendStateEvent(t.roomId,a.a.RoomJoinRules,{join_rule:s===n.Unlisted?h.c.Public:h.c.Invite},""),()=>g(Object(r.a)("Failed to update the visibility of this space"))),[y,_]=p(()=>{var e,s;return(null===(e=t.currentState.getStateEvents(a.a.RoomGuestAccess,""))||void 0===e||null===(s=e.getContent())||void 0===s?void 0:s.guest_access)===h.a.CanJoin},s=>e.sendStateEvent(t.roomId,a.a.RoomGuestAccess,{guest_access:s?h.a.CanJoin:h.a.Forbidden},""),()=>g(Object(r.a)("Failed to update the guest access of this space"))),[E,S]=p(()=>{var e,s;return(null===(e=t.currentState.getStateEvents(a.a.RoomHistoryVisibility,""))||void 0===e||null===(s=e.getContent())||void 0===s?void 0:s.history_visibility)||h.b.Shared},s=>e.sendStateEvent(t.roomId,a.a.RoomHistoryVisibility,{history_visibility:s},""),()=>g(Object(r.a)("Failed to update the history visibility of this space"))),[w,C]=Object(d.a)(),k=t.currentState.maySendStateEvent(a.a.RoomJoinRules,v),O=t.currentState.maySendStateEvent(a.a.RoomGuestAccess,v),R=t.currentState.maySendStateEvent(a.a.RoomHistoryVisibility,v),I=t.currentState.mayClientSendStateEvent(a.a.RoomCanonicalAlias,e),x=t.currentState.getStateEvents(a.a.RoomCanonicalAlias,"");let T,j;return T=w?o.a.createElement(o.a.Fragment,null,o.a.createElement(c.a,{onClick:C,kind:"link",className:"mx_SettingsTab_showAdvanced"},Object(r.a)("Hide advanced")),o.a.createElement(u.a,{value:y,onChange:_,disabled:!O,label:Object(r.a)("Enable guest access")}),o.a.createElement("p",null,Object(r.a)("Guests can join a space without having an account."),o.a.createElement("br",null),Object(r.a)("This may be useful for public spaces."))):o.a.createElement(o.a.Fragment,null,o.a.createElement(c.a,{onClick:C,kind:"link",className:"mx_SettingsTab_showAdvanced"},Object(r.a)("Show advanced"))),f!==n.Private&&(j=o.a.createElement(o.a.Fragment,null,o.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(r.a)("Address")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},o.a.createElement(l.a,{roomId:t.roomId,canSetCanonicalAlias:I,canSetAliases:!0,canonicalAliasEvent:x,hidePublishSetting:!0})))),o.a.createElement("div",{className:"mx_SettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(r.a)("Visibility")),s&&o.a.createElement("div",{className:"mx_SpaceRoomView_errorText"},s),o.a.createElement("div",{className:"mx_SettingsTab_section"},o.a.createElement("div",{className:"mx_SettingsTab_section_caption"},Object(r.a)("Decide who can view and join %(spaceName)s.",{spaceName:t.name})),o.a.createElement("div",null,o.a.createElement(m.a,{name:"spaceVisibility",value:f,onChange:b,disabled:!k,definitions:[{value:n.Unlisted,label:Object(r.a)("Public"),description:Object(r.a)("anyone with the link can view and join")},{value:n.Private,label:Object(r.a)("Invite only"),description:Object(r.a)("only invited people can view and join")}]})),T,o.a.createElement(u.a,{value:E===h.b.WorldReadable,onChange:e=>{S(e?h.b.WorldReadable:h.b.Shared)},disabled:!R,label:Object(r.a)("Preview Space")}),o.a.createElement("div",null,Object(r.a)("Allow people to preview your space before they join.")),o.a.createElement("b",null,Object(r.a)("Recommended for public spaces."))),j)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(672),u=s(94),h=s(92),m=s(112),p=s(119),g=s(135),v=s(100),f=s(99),b=s(673),y=s(93),_=s(340);class E extends d.a{constructor(...e){super(...e),r()(this,"aliasField",Object(c.createRef)()),r()(this,"onAliasAdded",async()=>{await this.aliasField.current.validate({allowEmpty:!1}),this.aliasField.current.isValid?this.props.onItemAdded&&this.props.onItemAdded(this.props.newItem):(this.aliasField.current.focus(),this.aliasField.current.validate({allowEmpty:!1,focused:!0}))})}renderNewItemField(){if(!this.props.domain)return super.renderNewItemField();return l.a.createElement("form",{onSubmit:this.onAliasAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},l.a.createElement(_.a,{ref:this.aliasField,onChange:e=>this.onNewItemChanged({target:{value:e}}),value:this.props.newItem||"",domain:this.props.domain}),l.a.createElement(v.a,{onClick:this.onAliasAdded,kind:"primary"},Object(h.a)("Add")))}}let S=Object(y.a)("views.room_settings.AliasSettings")((o=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onNewAliasChanged",e=>{this.setState({newAlias:e})}),r()(this,"onLocalAliasAdded",e=>{if(!e||0===e.length)return;const t=u.a.get().getDomain();e.includes(":")||(e+=":"+t),u.a.get().createAlias(e,this.props.roomId).then(()=>{this.setState({localAliases:this.state.localAliases.concat(e),newAlias:null}),this.state.canonicalAlias||this.changeCanonicalAlias(e)}).catch(e=>{console.error(e),f.a.createTrackedDialog("Error creating address","",g.a,{title:Object(h.a)("Error creating address"),description:Object(h.a)("There was an error creating that address. It may not be allowed by the server or a temporary failure occurred.")})})}),r()(this,"onLocalAliasDeleted",e=>{const t=this.state.localAliases[e];u.a.get().deleteAlias(t).then(()=>{const e=this.state.localAliases.filter(e=>e!==t);this.setState({localAliases:e}),this.state.canonicalAlias===t&&this.changeCanonicalAlias(null)}).catch(e=>{let t;console.error(e),t="M_FORBIDDEN"===e.errcode?Object(h.a)("You don't have permission to delete the address."):Object(h.a)("There was an error removing that address. It may no longer exist or a temporary error occurred."),f.a.createTrackedDialog("Error removing address","",g.a,{title:Object(h.a)("Error removing address"),description:t})})}),r()(this,"onLocalAliasesToggled",e=>{e.target.open&&(this.props.canSetCanonicalAlias||0!==this.state.localAliases.length||this.loadLocalAliases()),this.setState({detailsOpen:e.currentTarget.open})}),r()(this,"onCanonicalAliasChange",e=>{this.changeCanonicalAlias(e.target.value)}),r()(this,"onNewAltAliasChanged",e=>{this.setState({newAltAlias:e})}),r()(this,"onAltAliasAdded",e=>{const t=this.state.altAliases.slice();t.some(t=>t.trim()===e.trim())||(t.push(e.trim()),this.changeAltAliases(t),this.setState({newAltAlias:""}))}),r()(this,"onAltAliasDeleted",e=>{const t=this.state.altAliases.slice();t.splice(e,1),this.changeAltAliases(t)});const t={altAliases:[],localAliases:[],canonicalAlias:null,updatingCanonicalAlias:!1,localAliasesLoading:!1,detailsOpen:!1};if(e.canonicalAliasEvent){const s=e.canonicalAliasEvent.getContent(),n=s.alt_aliases;Array.isArray(n)&&(t.altAliases=n.slice()),t.canonicalAlias=s.alias}this.state=t}componentDidMount(){this.props.canSetCanonicalAlias&&this.loadLocalAliases()}async loadLocalAliases(){this.setState({localAliasesLoading:!0});try{const e=u.a.get();let t=[];if(await e.doesServerSupportUnstableFeature("org.matrix.msc2432")){const s=await e.unstableGetLocalAliases(this.props.roomId);Array.isArray(s.aliases)&&(t=s.aliases)}this.setState({localAliases:t}),0===t.length&&this.setState({detailsOpen:!0})}finally{this.setState({localAliasesLoading:!1})}}changeCanonicalAlias(e){if(!this.props.canSetCanonicalAlias)return;const t=this.state.canonicalAlias;this.setState({canonicalAlias:e,updatingCanonicalAlias:!0});const s={alt_aliases:this.state.altAliases};e&&(s.alias=e),u.a.get().sendStateEvent(this.props.roomId,"m.room.canonical_alias",s,"").catch(e=>{console.error(e),f.a.createTrackedDialog("Error updating main address","",g.a,{title:Object(h.a)("Error updating main address"),description:Object(h.a)("There was an error updating the room's main address. It may not be allowed by the server or a temporary failure occurred.")}),this.setState({canonicalAlias:t})}).finally(()=>{this.setState({updatingCanonicalAlias:!1})})}changeAltAliases(e){if(!this.props.canSetCanonicalAlias)return;this.setState({updatingCanonicalAlias:!0,altAliases:e});const t={};this.state.canonicalAlias&&(t.alias=this.state.canonicalAlias),e&&(t.alt_aliases=e),u.a.get().sendStateEvent(this.props.roomId,"m.room.canonical_alias",t,"").catch(e=>{console.error(e),f.a.createTrackedDialog("Error updating alternative addresses","",g.a,{title:Object(h.a)("Error updating main address"),description:Object(h.a)("There was an error updating the room's alternative addresses. It may not be allowed by the server or a temporary failure occurred.")})}).finally(()=>{this.setState({updatingCanonicalAlias:!1})})}getAliases(){return this.state.altAliases.concat(this.getLocalNonAltAliases())}getLocalNonAltAliases(){const{altAliases:e}=this.state;return this.state.localAliases.filter(t=>!e.includes(t))}render(){var e;const t=u.a.get(),s=t.getDomain(),n=null===(e=t.getRoom(this.props.roomId))||void 0===e?void 0:e.isSpaceRoom();let i=!1;const o=this.state.canonicalAlias||"",a=l.a.createElement(m.a,{onChange:this.onCanonicalAliasChange,value:o,disabled:this.state.updatingCanonicalAlias||!this.props.canSetCanonicalAlias,element:"select",id:"canonicalAlias",label:Object(h.a)("Main address")},l.a.createElement("option",{value:"",key:"unset"},Object(h.a)("not specified")),this.getAliases().map((e,t)=>(e===this.state.canonicalAlias&&(i=!0),l.a.createElement("option",{value:e,key:t},e))),i||!this.state.canonicalAlias?"":l.a.createElement("option",{value:this.state.canonicalAlias,key:"arbitrary"},this.state.canonicalAlias));let r;return r=this.state.localAliasesLoading?l.a.createElement(p.a,null):l.a.createElement(E,{id:"roomAliases",items:this.state.localAliases,newItem:this.state.newAlias,onNewItemChanged:this.onNewAliasChanged,canRemove:this.props.canSetAliases,canEdit:this.props.canSetAliases,onItemAdded:this.onLocalAliasAdded,onItemRemoved:this.onLocalAliasDeleted,noItemsLabel:n?Object(h.a)("This space has no local addresses"):Object(h.a)("This room has no local addresses"),placeholder:Object(h.a)("Local address"),domain:s}),l.a.createElement("div",{className:"mx_AliasSettings"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Published Addresses")),l.a.createElement("p",null,n?Object(h.a)("Published addresses can be used by anyone on any server to join your space."):Object(h.a)("Published addresses can be used by anyone on any server to join your room.")," ",Object(h.a)("To publish an address, it needs to be set as a local address first.")),a,this.props.hidePublishSetting?null:l.a.createElement(b.a,{roomId:this.props.roomId,canSetCanonicalAlias:this.props.canSetCanonicalAlias}),l.a.createElement("datalist",{id:"mx_AliasSettings_altRecommendations"},this.getLocalNonAltAliases().map(e=>l.a.createElement("option",{value:e,key:e})),";"),l.a.createElement(E,{id:"roomAltAliases",items:this.state.altAliases,newItem:this.state.newAltAlias,onNewItemChanged:this.onNewAltAliasChanged,canRemove:this.props.canSetCanonicalAlias,canEdit:this.props.canSetCanonicalAlias,onItemAdded:this.onAltAliasAdded,onItemRemoved:this.onAltAliasDeleted,suggestionsListId:"mx_AliasSettings_altRecommendations",itemsLabel:Object(h.a)("Other published addresses:"),noItemsLabel:Object(h.a)("No other published addresses yet, add one below"),placeholder:Object(h.a)("New published address (e.g. #alias:server)")}),l.a.createElement("span",{className:"mx_SettingsTab_subheading mx_AliasSettings_localAliasHeader"},Object(h.a)("Local Addresses")),l.a.createElement("p",null,n?Object(h.a)("Set addresses for this space so users can find this space through your homeserver (%(localDomain)s)",{localDomain:s}):Object(h.a)("Set addresses for this room so users can find this room through your homeserver (%(localDomain)s)",{localDomain:s})),l.a.createElement("details",{onToggle:this.onLocalAliasesToggled,open:this.state.detailsOpen},l.a.createElement("summary",null,this.state.detailsOpen?Object(h.a)("Show less"):Object(h.a)("Show more")),r))}},r()(i,"defaultProps",{canSetAliases:!1,canSetCanonicalAlias:!1}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(112),d=s(100),u=s(93);class h extends r.a.Component{constructor(...e){super(...e),o()(this,"state",{verifyRemove:!1}),o()(this,"onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),o()(this,"onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),o()(this,"onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),this.props.onRemove&&this.props.onRemove(this.props.index),this.setState({verifyRemove:!1})})}render(){return this.state.verifyRemove?r.a.createElement("div",{className:"mx_EditableItem"},r.a.createElement("span",{className:"mx_EditableItem_promptText"},Object(c.a)("Are you sure?")),r.a.createElement(d.a,{onClick:this.onActuallyRemove,kind:"primary_sm",className:"mx_EditableItem_confirmBtn"},Object(c.a)("Yes")),r.a.createElement(d.a,{onClick:this.onDontRemove,kind:"danger_sm",className:"mx_EditableItem_confirmBtn"},Object(c.a)("No"))):r.a.createElement("div",{className:"mx_EditableItem"},r.a.createElement("div",{onClick:this.onRemove,className:"mx_EditableItem_delete",title:Object(c.a)("Remove"),role:"button"}),r.a.createElement("span",{className:"mx_EditableItem_item"},this.props.value))}}let m=Object(u.a)("views.elements.EditableItemList")(n=class extends r.a.PureComponent{constructor(...e){super(...e),o()(this,"onItemAdded",e=>{e.stopPropagation(),e.preventDefault(),this.props.onItemAdded&&this.props.onItemAdded(this.props.newItem)}),o()(this,"onItemRemoved",e=>{this.props.onItemRemoved&&this.props.onItemRemoved(e)}),o()(this,"onNewItemChanged",e=>{this.props.onNewItemChanged&&this.props.onNewItemChanged(e.target.value)})}renderNewItemField(){return r.a.createElement("form",{onSubmit:this.onItemAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},r.a.createElement(l.a,{label:this.props.placeholder,type:"text",autoComplete:"off",value:this.props.newItem||"",onChange:this.onNewItemChanged,list:this.props.suggestionsListId}),r.a.createElement(d.a,{onClick:this.onItemAdded,kind:"primary",type:"submit",disabled:!this.props.newItem},Object(c.a)("Add")))}render(){const e=this.props.items.map((e,t)=>this.props.canRemove?r.a.createElement(h,{key:e,index:t,value:e,onRemove:this.onItemRemoved}):r.a.createElement("li",{key:e},e)),t=this.props.canRemove?e:r.a.createElement("ul",null,e),s=this.props.items.length>0?this.props.itemsLabel:this.props.noItemsLabel;return r.a.createElement("div",{className:"mx_EditableItemList"},r.a.createElement("div",{className:"mx_EditableItemList_label"},s),t,this.props.canEdit?this.renderNewItemField():r.a.createElement("div",null))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(173),l=s(92),d=s(94),u=s(93);let h=Object(u.a)("views.room_settings.RoomPublishSetting")(n=class extends r.a.PureComponent{constructor(e,t){super(e,t),o()(this,"onRoomPublishChange",e=>{const t=this.state.isRoomPublished,s=!t;this.setState({isRoomPublished:s});d.a.get().setRoomDirectoryVisibility(this.props.roomId,s?"public":"private").catch(()=>{this.setState({isRoomPublished:t})})}),this.state={isRoomPublished:!1}}componentDidMount(){d.a.get().getRoomDirectoryVisibility(this.props.roomId).then(e=>{this.setState({isRoomPublished:"public"===e.visibility})})}render(){const e=d.a.get();return r.a.createElement(c.a,{value:this.state.isRoomPublished,onChange:this.onRoomPublishChange,label:Object(l.a)("Publish this room to the public in %(domain)s's room directory?",{domain:e.getDomain()})})}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(95),m=s(94),p=s(99),g=s(92),v=s(93);let f=Object(v.a)("views.dialogs.RoomUpgradeDialog")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{busy:!0}),r()(this,"_onCancelClick",()=>{this.props.onFinished(!1)}),r()(this,"_onUpgradeClick",()=>{this.setState({busy:!0}),m.a.get().upgradeRoom(this.props.room.roomId,this._targetVersion).then(()=>{this.props.onFinished(!0)}).catch(e=>{const t=h.getComponent("dialogs.ErrorDialog");p.a.createTrackedDialog("Failed to upgrade room","",t,{title:Object(g.a)("Failed to upgrade room"),description:e&&e.message?e.message:Object(g.a)("The room upgrade could not be completed")})}).finally(()=>{this.setState({busy:!1})})})}async componentDidMount(){const e=await this.props.room.getRecommendedVersion();this._targetVersion=e.version,this.setState({busy:!1})}render(){const e=h.getComponent("views.dialogs.BaseDialog"),t=h.getComponent("views.elements.DialogButtons"),s=h.getComponent("views.elements.Spinner");let n;return n=this.state.busy?l.a.createElement(s,null):l.a.createElement(t,{primaryButton:Object(g.a)("Upgrade this room to version %(version)s",{version:this._targetVersion}),primaryButtonClass:"danger",hasCancel:!0,onPrimaryButtonClick:this._onUpgradeClick,focus:this.props.focus,onCancel:this._onCancelClick}),l.a.createElement(e,{className:"mx_RoomUpgradeDialog",onFinished:this.props.onFinished,title:Object(g.a)("Upgrade Room Version"),contentId:"mx_Dialog_content",hasCancel:!0},l.a.createElement("p",null,Object(g.a)("Upgrading this room requires closing down the current instance of the room and creating a new room in its place. To give room members the best possible experience, we will:")),l.a.createElement("ol",null,l.a.createElement("li",null,Object(g.a)("Create a new room with the same name, description and avatar")),l.a.createElement("li",null,Object(g.a)("Update any local room aliases to point to the new room")),l.a.createElement("li",null,Object(g.a)("Stop users from speaking in the old version of the room, and post a message advising users to move to the new room")),l.a.createElement("li",null,Object(g.a)("Put a link back to the old room at the start of the new room so people can see old messages"))),n)}},r()(i,"propTypes",{room:u.a.object.isRequired,onFinished:u.a.func.isRequired}),n=o))||n},,function(e,t,s){"use strict";s.d(t,"a",(function(){return C}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(102),u=s(163),h=s(92),m=s(94),p=s(111),g=s(137),v=s(182),f=s(93),b=s(112),y=s(340),_=s(173),E=s(192),S=s(124),w=s(241);let C=Object(f.a)("views.dialogs.CreateRoomDialog")((o=i=class e extends l.a.Component{constructor(t){super(t),r()(this,"nameField",Object(c.createRef)()),r()(this,"aliasField",Object(c.createRef)()),r()(this,"onKeyDown",e=>{e.key===p.a.ENTER&&(this.onOk(),e.preventDefault(),e.stopPropagation())}),r()(this,"onOk",async()=>{const e=document.activeElement;if(e&&e.blur(),await this.nameField.current.validate({allowEmpty:!1}),this.aliasField.current&&await this.aliasField.current.validate({allowEmpty:!1}),await new Promise(e=>this.setState({},e)),!this.state.nameIsValid||this.aliasField.current&&!this.aliasField.current.isValid){let e;this.state.nameIsValid?this.aliasField.current&&!this.aliasField.current.isValid&&(e=this.aliasField.current):e=this.nameField.current,e&&(e.focus(),e.validate({allowEmpty:!1,focused:!0}))}else this.props.onFinished(!0,this.roomCreateOptions())}),r()(this,"onCancel",()=>{this.props.onFinished(!1)}),r()(this,"onNameChange",e=>{this.setState({name:e.target.value})}),r()(this,"onTopicChange",e=>{this.setState({topic:e.target.value})}),r()(this,"onPublicChange",e=>{this.setState({isPublic:e})}),r()(this,"onEncryptedChange",e=>{this.setState({isEncrypted:e})}),r()(this,"onAliasChange",e=>{this.setState({alias:e})}),r()(this,"onDetailsToggled",e=>{this.setState({detailsOpen:e.target.open})}),r()(this,"onNoFederateChange",e=>{this.setState({noFederate:e})}),r()(this,"onNameValidate",async t=>{const s=await e.validateRoomName(t);return this.setState({nameIsValid:s.valid}),s});const s=d.a.get();this.state={isPublic:this.props.defaultPublic||!1,isEncrypted:Object(g.f)(),name:this.props.defaultName||"",topic:"",alias:"",detailsOpen:!1,noFederate:!1===s.default_federate,nameIsValid:!1,canChangeEncryption:!0},m.a.get().doesServerForceEncryptionForPreset(w.a.PrivateChat).then(e=>this.setState({canChangeEncryption:!e}))}roomCreateOptions(){const e={},t=e.createOpts={};if(t.name=this.state.name,this.state.isPublic){t.visibility=w.b.Public,t.preset=w.a.PublicChat,e.guestAccess=!1;const{alias:s}=this.state;t.room_alias_name=s.substr(1,s.indexOf(":")-1)}return this.state.topic&&(t.topic=this.state.topic),this.state.noFederate&&(t.creation_content={"m.federate":!1}),this.state.isPublic||(this.state.canChangeEncryption?e.encryption=this.state.isEncrypted:e.encryption=!0),v.a.instance.getSelectedCommunityId()&&(e.associatedWithCommunity=v.a.instance.getSelectedCommunityId()),this.props.parentSpace&&(e.parentSpace=this.props.parentSpace),e}componentDidMount(){this.nameField.current.focus()}componentWillUnmount(){}render(){let e;if(this.state.isPublic){const t=m.a.get().getDomain();e=l.a.createElement("div",{className:"mx_CreateRoomDialog_aliasContainer"},l.a.createElement(y.a,{ref:this.aliasField,onChange:this.onAliasChange,domain:t,value:this.state.alias}))}let t,s=l.a.createElement("p",null,Object(h.a)("Private rooms can be found and joined by invitation only. Public rooms can be found and joined by anyone."));if(v.a.instance.getSelectedCommunityId()&&(s=l.a.createElement("p",null,Object(h.a)("Private rooms can be found and joined by invitation only. Public rooms can be found and joined by anyone in this community."))),!this.state.isPublic){let e;e=Object(g.f)()?this.state.canChangeEncryption?Object(h.a)("You can’t disable this later. Bridges & most bots won’t work yet."):Object(h.a)("Your server requires encryption to be enabled in private rooms."):Object(h.a)("Your server admin has disabled end-to-end encryption by default in private rooms & Direct Messages."),t=l.a.createElement(l.a.Fragment,null,l.a.createElement(_.a,{label:Object(h.a)("Enable end-to-end encryption"),onChange:this.onEncryptedChange,value:this.state.isEncrypted,className:"mx_CreateRoomDialog_e2eSwitch",disabled:!this.state.canChangeEncryption}),l.a.createElement("p",null,e))}let n=Object(h.a)("You might enable this if the room will only be used for collaborating with internal teams on your homeserver. This cannot be changed later.");!1===d.a.get().default_federate&&(n=Object(h.a)("You might disable this if the room will be used for collaborating with external teams who have their own homeserver. This cannot be changed later."));let i=this.state.isPublic?Object(h.a)("Create a public room"):Object(h.a)("Create a private room");if(v.a.instance.getSelectedCommunityId()){const e=v.a.instance.getSelectedCommunityName();i=Object(h.a)("Create a room in %(communityName)s",{communityName:e})}return l.a.createElement(S.a,{className:"mx_CreateRoomDialog",onFinished:this.props.onFinished,title:i},l.a.createElement("form",{onSubmit:this.onOk,onKeyDown:this.onKeyDown},l.a.createElement("div",{className:"mx_Dialog_content"},l.a.createElement(b.a,{ref:this.nameField,label:Object(h.a)("Name"),onChange:this.onNameChange,onValidate:this.onNameValidate,value:this.state.name,className:"mx_CreateRoomDialog_name"}),l.a.createElement(b.a,{label:Object(h.a)("Topic (optional)"),onChange:this.onTopicChange,value:this.state.topic,className:"mx_CreateRoomDialog_topic"}),l.a.createElement(_.a,{label:Object(h.a)("Make this room public"),onChange:this.onPublicChange,value:this.state.isPublic}),s,t,e,l.a.createElement("details",{onToggle:this.onDetailsToggled,className:"mx_CreateRoomDialog_details"},l.a.createElement("summary",{className:"mx_CreateRoomDialog_details_summary"},this.state.detailsOpen?Object(h.a)("Hide advanced"):Object(h.a)("Show advanced")),l.a.createElement(_.a,{label:Object(h.a)("Block anyone not part of %(serverName)s from ever joining this room.",{serverName:m.a.getHomeserverName()}),onChange:this.onNoFederateChange,value:this.state.noFederate}),l.a.createElement("p",null,n)))),l.a.createElement(E.a,{primaryButton:Object(h.a)("Create Room"),onPrimaryButtonClick:this.onOk,onCancel:this.onCancel}))}},r()(i,"validateRoomName",Object(u.a)({rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>Object(h.a)("Please enter a name for the room")}]})),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(93);let m=Object(h.a)("views.context_menus.GenericTextContextMenu")((o=i=class extends l.a.Component{render(){return l.a.createElement("div",null,this.props.message)}},r()(i,"propTypes",{message:u.a.string.isRequired}),n=o))||n},function(e,t){e.exports="img/icon-email-pill-avatar.802ffb9.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return w}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(124),l=s(92),d=s(112),u=s(100),h=s(94),m=s(121),p=s(102),g=s(351),v=s(130),f=s(157),b=s(148),y=s(99),_=s(135),E=s(93),S=s(107);let w=Object(E.a)("views.dialogs.CommunityPrototypeInviteDialog")(n=class extends r.a.PureComponent{constructor(e){super(e),o()(this,"onSubmit",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=[...this.state.emailTargets,...this.state.userTargets],t=await Object(f.a)(this.props.roomId,e),s=h.a.get().getRoom(this.props.roomId);Object(f.d)(t.states,s,t.inviter)?this.props.onFinished(!0):this.setState({busy:!1})}catch(e){this.setState({busy:!1}),console.error(e),y.a.createTrackedDialog("Failed to invite","",_.a,{title:Object(l.a)("Failed to invite"),description:e&&e.message?e.message:Object(l.a)("Operation failed")})}}),o()(this,"onAddressChange",(e,t)=>{const s=Object(m.b)(this.state.emailTargets);t>=s.length?s.push(e.target.value):s[t]=e.target.value,this.setState({emailTargets:s})}),o()(this,"onAddressBlur",e=>{const t=Object(m.b)(this.state.emailTargets);e>=t.length||""===t[e].trim()&&(t.splice(e,1),this.setState({emailTargets:t}))}),o()(this,"onShowPeopleClick",()=>{this.setState({showPeople:!this.state.showPeople})}),o()(this,"setPersonToggle",(e,t)=>{const s=Object(m.b)(this.state.userTargets);t&&!s.includes(e.userId)?s.push(e.userId):!t&&s.includes(e.userId)&&s.splice(s.indexOf(e.userId),1),this.setState({userTargets:s})}),o()(this,"onShowMorePeople",()=>{this.setState({numPeople:this.state.numPeople+5})}),this.state={emailTargets:[],userTargets:[],showPeople:!1,people:this.buildSuggestions(),numPeople:5,busy:!1}}buildSuggestions(){const e=new Set([h.a.get().getUserId(),p.a.get().welcomeUserId]);if(this.props.roomId){const t=h.a.get().getRoom(this.props.roomId);if(!t)throw new Error("Room ID given to InviteDialog does not look like a room");t.getMembersWithMembership("invite").forEach(t=>e.add(t.userId)),t.getMembersWithMembership("join").forEach(t=>e.add(t.userId)),t.getMembersWithMembership("ban").forEach(t=>e.add(t.userId))}return g.d.buildRecents(e)}renderPerson(e,t){let s=null;return e.user.getMxcAvatarUrl()&&(s=Object(S.b)(e.user.getMxcAvatarUrl()).getSquareThumbnailHttp(36)),r.a.createElement("div",{className:"mx_CommunityPrototypeInviteDialog_person",key:t},r.a.createElement(v.a,{url:s,name:e.user.name,idName:e.user.userId,width:36,height:36}),r.a.createElement("div",{className:"mx_CommunityPrototypeInviteDialog_personIdentifiers"},r.a.createElement("span",{className:"mx_CommunityPrototypeInviteDialog_personName"},e.user.name),r.a.createElement("span",{className:"mx_CommunityPrototypeInviteDialog_personId"},e.userId)),r.a.createElement(b.a,{onChange:t=>this.setPersonToggle(e,t.target.checked)}))}render(){const e=[];this.state.emailTargets.forEach((t,s)=>{e.push(r.a.createElement(d.a,{key:s,value:t,onChange:e=>this.onAddressChange(e,s),label:Object(l.a)("Email address"),placeholder:Object(l.a)("Email address"),onBlur:()=>this.onAddressBlur(s)}))}),e.push(r.a.createElement(d.a,{key:e.length,value:"",onChange:t=>this.onAddressChange(t,e.length),label:e.length>0?Object(l.a)("Add another email"):Object(l.a)("Email address"),placeholder:e.length>0?Object(l.a)("Add another email"):Object(l.a)("Email address")}));let t=null;const s=[];if(this.state.showPeople){const e=this.state.people.slice(0,this.state.numPeople);e.forEach((e,t)=>{s.push(this.renderPerson(e,t))}),e.length<this.state.people.length&&s.push(r.a.createElement(u.a,{onClick:this.onShowMorePeople,kind:"link",key:"more",className:"mx_CommunityPrototypeInviteDialog_morePeople"},Object(l.a)("Show more")))}this.state.people.length>0&&(t=r.a.createElement("div",{className:"mx_CommunityPrototypeInviteDialog_people"},r.a.createElement("span",null,Object(l.a)("People you know on %(brand)s",{brand:p.a.get().brand})),r.a.createElement(u.a,{onClick:this.onShowPeopleClick},this.state.showPeople?Object(l.a)("Hide"):Object(l.a)("Show"))));let n=Object(l.a)("Skip");const i=this.state.userTargets.length+this.state.emailTargets.length;return i>0&&(n=Object(l.a)("Send %(count)s invites",{count:i})),r.a.createElement(c.a,{className:"mx_CommunityPrototypeInviteDialog",onFinished:this.props.onFinished,title:Object(l.a)("Invite people to join %(communityName)s",{communityName:this.props.communityName})},r.a.createElement("form",{onSubmit:this.onSubmit},r.a.createElement("div",{className:"mx_Dialog_content"},e,t,s,r.a.createElement(u.a,{kind:"primary",onClick:this.onSubmit,disabled:this.state.busy,className:"mx_CommunityPrototypeInviteDialog_primaryButton"},n))))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(18),i=s.n(n),o=s(264),a=s(8),r=s(1),c=s(117);class l extends a.EventEmitter{constructor(){super(),i()(this,"_search",""),i()(this,"callUpdate",Object(c.throttle)(()=>{this.emit(o.a)},200,{trailing:!0,leading:!0}))}get kind(){return o.b.Runtime}get search(){return this._search}set search(e){this._search=e,this.callUpdate()}isVisible(e){const t=this.search.toLowerCase();if("#"===this.search[0]){if(e.getCanonicalAlias()&&e.getCanonicalAlias().toLowerCase().startsWith(t))return!0;if(e.getAltAliases().some(e=>e.toLowerCase().startsWith(t)))return!0}return!!e.name&&this.matches(e.normalizedName)}matches(e){return e.includes(Object(r.x)(this.search))}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return B}));var n,i=s(104),o=s.n(i),a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(101),u=s.n(d),h=s(175),m=s(100),p=s(96),g=s(111),v=s(604),f=s(92),b=s(109),y=s(146),_=s(1316),E=s(259),S=s(300),w=s(94),C=s(180),k=s(159),O=s(1220),R=s(174),I=s(219),x=s(113),T=s(1221),j=s(683),N=s(684),P=s(176),D=s(182),A=s(93),M=s(691),U=s(247);const L=e=>"mx_RoomTile_messagePreview_"+e,F=e=>({left:e.left+window.pageXOffset-9,top:e.bottom+window.pageYOffset+17,chevronFace:b.a.None});let B=Object(A.a)("views.rooms.RoomTile")(n=class extends l.a.PureComponent{constructor(t){super(t),r()(this,"dispatcherRef",void 0),r()(this,"roomTileRef",Object(c.createRef)()),r()(this,"notificationState",void 0),r()(this,"roomProps",void 0),r()(this,"onRoomNameUpdate",e=>{this.forceUpdate()}),r()(this,"onNotificationUpdate",()=>{this.forceUpdate()}),r()(this,"onLocalEchoUpdated",(e,t)=>{(null==t?void 0:t.roomId)===this.props.room.roomId&&this.setState({hasUnsentEvents:this.countUnsentEvents()>0})}),r()(this,"onRoomPropertyUpdate",e=>{e===j.a.NotificationVolume&&this.onNotificationUpdate()}),r()(this,"onAction",t=>{"view_room"===t.action&&t.room_id===this.props.room.roomId&&t.show_room_tile&&e(()=>{this.scrollIntoView()})}),r()(this,"onCommunityUpdate",e=>{e===this.props.room.roomId&&this.forceUpdate()}),r()(this,"onRoomPreviewChanged",e=>{this.props.room&&e.roomId===this.props.room.roomId&&this.generatePreview()}),r()(this,"scrollIntoView",()=>{this.roomTileRef.current&&this.roomTileRef.current.scrollIntoView({block:"nearest",behavior:"auto"})}),r()(this,"onTileClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"view_room",show_room_tile:!0,room_id:this.props.room.roomId,clear_search:e&&(e.key===g.a.ENTER||e.key===g.a.SPACE)})}),r()(this,"onActiveRoomUpdate",e=>{this.setState({selected:e})}),r()(this,"onNotificationsMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({notificationsMenuPosition:t.getBoundingClientRect()})}),r()(this,"onCloseNotificationsMenu",()=>{this.setState({notificationsMenuPosition:null})}),r()(this,"onGeneralMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({generalMenuPosition:t.getBoundingClientRect()})}),r()(this,"onContextMenu",e=>{this.showContextMenu&&(e.preventDefault(),e.stopPropagation(),this.setState({generalMenuPosition:{left:e.clientX,bottom:e.clientY}}))}),r()(this,"onCloseGeneralMenu",()=>{this.setState({generalMenuPosition:null})}),r()(this,"onTagRoom",(e,t)=>{if(e.preventDefault(),e.stopPropagation(),t===y.a.Favourite||t===y.a.LowPriority){const e=t===y.a.Favourite?y.a.LowPriority:y.a.Favourite,s=k.b.instance.getTagsForRoom(this.props.room).includes(t),n=s?t:e,i=s?null:t;p.a.dispatch(O.a.tagRoom(w.a.get(),this.props.room,n,i,void 0,0))}else console.warn(`Unexpected tag ${t} applied to ${this.props.room.roomId}`);e.key===g.a.ENTER&&this.setState({generalMenuPosition:null})}),r()(this,"onLeaveRoomClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"leave_room",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onForgetRoomClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"forget_room",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onOpenRoomSettings",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"open_room_settings",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onInviteClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"view_invite",roomId:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onClickAllNotifs",e=>this.saveNotifState(e,S.a)),r()(this,"onClickAlertMe",e=>this.saveNotifState(e,S.b)),r()(this,"onClickMentions",e=>this.saveNotifState(e,S.c)),r()(this,"onClickMute",e=>this.saveNotifState(e,S.d)),this.state={selected:v.a.activeRoomId===this.props.room.roomId,notificationsMenuPosition:null,generalMenuPosition:null,hasUnsentEvents:this.countUnsentEvents()>0,messagePreview:""},this.generatePreview(),this.notificationState=R.a.instance.getRoomState(this.props.room),this.roomProps=T.a.forRoom(this.props.room)}countUnsentEvents(){return Object(M.b)(this.props.room).length}get showContextMenu(){return this.props.tag!==y.a.Invite}get showMessagePreview(){return!this.props.isMinimized&&this.props.showMessagePreview}componentDidUpdate(e,t){var s,n;const i=e.showMessagePreview!==this.props.showMessagePreview,o=e.isMinimized!==this.props.isMinimized;var a,r,c,l;((i||o)&&this.generatePreview(),(null===(s=e.room)||void 0===s?void 0:s.roomId)!==(null===(n=this.props.room)||void 0===n?void 0:n.roomId))&&(_.a.instance.off(_.a.getPreviewChangedEventName(e.room),this.onRoomPreviewChanged),_.a.instance.on(_.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),D.a.instance.off(D.a.getUpdateEventName(null===(a=e.room)||void 0===a?void 0:a.roomId),this.onCommunityUpdate),D.a.instance.on(D.a.getUpdateEventName(null===(r=this.props.room)||void 0===r?void 0:r.roomId),this.onCommunityUpdate),null===(c=e.room)||void 0===c||c.off("Room.name",this.onRoomNameUpdate),null===(l=this.props.room)||void 0===l||l.on("Room.name",this.onRoomNameUpdate))}componentDidMount(){this.state.selected&&this.scrollIntoView(),v.a.addListener(this.props.room.roomId,this.onActiveRoomUpdate),this.dispatcherRef=p.a.register(this.onAction),_.a.instance.on(_.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),this.notificationState.on(I.a,this.onNotificationUpdate),this.roomProps.on(N.b,this.onRoomPropertyUpdate),this.roomProps.on("Room.name",this.onRoomNameUpdate),D.a.instance.on(D.a.getUpdateEventName(this.props.room.roomId),this.onCommunityUpdate),w.a.get().on("Room.localEchoUpdated",this.onLocalEchoUpdated)}componentWillUnmount(){var e;this.props.room&&(v.a.removeListener(this.props.room.roomId,this.onActiveRoomUpdate),_.a.instance.off(_.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),D.a.instance.off(D.a.getUpdateEventName(this.props.room.roomId),this.onCommunityUpdate),this.props.room.off("Room.name",this.onRoomNameUpdate)),v.a.removeListener(this.props.room.roomId,this.onActiveRoomUpdate),p.a.unregister(this.dispatcherRef),this.notificationState.off(I.a,this.onNotificationUpdate),this.roomProps.off(N.b,this.onRoomPropertyUpdate),this.roomProps.off("Room.name",this.onRoomNameUpdate),D.a.instance.off(D.a.getUpdateEventName(this.props.room.roomId),this.onCommunityUpdate),null===(e=w.a.get())||void 0===e||e.removeListener("Room.localEchoUpdated",this.onLocalEchoUpdated)}async generatePreview(){if(!this.showMessagePreview)return null;const e=await _.a.instance.getPreviewForRoom(this.props.room,this.props.tag);this.setState({messagePreview:e})}async saveNotifState(e,t){if(e.preventDefault(),e.stopPropagation(),w.a.get().isGuest())return;this.roomProps.notificationVolume=t;e.key===g.a.ENTER&&this.setState({notificationsMenuPosition:null})}renderNotificationsMenu(e){if(w.a.get().isGuest()||this.props.tag===y.a.Archived||!this.showContextMenu||this.props.isMinimized)return null;const t=this.roomProps.notificationVolume;let s=null;this.state.notificationsMenuPosition&&(s=l.a.createElement(P.e,o()({},F(this.state.notificationsMenuPosition),{onFinished:this.onCloseNotificationsMenu,className:"mx_RoomTile_contextMenu",compact:!0}),l.a.createElement(P.c,{first:!0},l.a.createElement(P.d,{label:Object(f.a)("Use default"),active:t===S.a,iconClassName:"mx_RoomTile_iconBell",onClick:this.onClickAllNotifs}),l.a.createElement(P.d,{label:Object(f.a)("All messages"),active:t===S.b,iconClassName:"mx_RoomTile_iconBellDot",onClick:this.onClickAlertMe}),l.a.createElement(P.d,{label:Object(f.a)("Mentions & Keywords"),active:t===S.c,iconClassName:"mx_RoomTile_iconBellMentions",onClick:this.onClickMentions}),l.a.createElement(P.d,{label:Object(f.a)("None"),active:t===S.d,iconClassName:"mx_RoomTile_iconBellCrossed",onClick:this.onClickMute}))));const n=u()("mx_RoomTile_notificationsButton",{mx_RoomTile_iconBell:t===S.a,mx_RoomTile_iconBellDot:t===S.b,mx_RoomTile_iconBellMentions:t===S.c,mx_RoomTile_iconBellCrossed:t===S.d,mx_RoomTile_notificationsButton_show:t===S.d});return l.a.createElement(l.a.Fragment,null,l.a.createElement(b.d,{className:n,onClick:this.onNotificationsMenuOpenClick,title:Object(f.a)("Notification options"),isExpanded:!!this.state.notificationsMenuPosition,tabIndex:e?0:-1}),s)}renderGeneralMenu(){if(!this.showContextMenu)return null;let e=null;if(this.state.generalMenuPosition&&this.props.tag===y.a.Archived)e=l.a.createElement(P.e,o()({},F(this.state.generalMenuPosition),{onFinished:this.onCloseGeneralMenu,className:"mx_RoomTile_contextMenu",compact:!0}),l.a.createElement(P.c,{red:!0},l.a.createElement(P.b,{iconClassName:"mx_RoomTile_iconSignOut",label:Object(f.a)("Forget Room"),onClick:this.onForgetRoomClick})));else if(this.state.generalMenuPosition){const t=k.b.instance.getTagsForRoom(this.props.room),s=t.includes(y.a.Favourite),n=s?Object(f.a)("Favourited"):Object(f.a)("Favourite"),i=t.includes(y.a.LowPriority),a=Object(f.a)("Low Priority"),r=w.a.get().getUserId(),c=this.props.room.canInvite(r);e=l.a.createElement(P.e,o()({},F(this.state.generalMenuPosition),{onFinished:this.onCloseGeneralMenu,className:"mx_RoomTile_contextMenu",compact:!0}),l.a.createElement(P.c,null,l.a.createElement(P.a,{onClick:e=>this.onTagRoom(e,y.a.Favourite),active:s,label:n,iconClassName:"mx_RoomTile_iconStar"}),l.a.createElement(P.a,{onClick:e=>this.onTagRoom(e,y.a.LowPriority),active:i,label:a,iconClassName:"mx_RoomTile_iconArrowDown"}),c?l.a.createElement(P.b,{onClick:this.onInviteClick,label:Object(f.a)("Invite People"),iconClassName:"mx_RoomTile_iconInvite"}):null,l.a.createElement(P.b,{onClick:this.onOpenRoomSettings,label:Object(f.a)("Settings"),iconClassName:"mx_RoomTile_iconSettings"})),l.a.createElement(P.c,{red:!0},l.a.createElement(P.b,{onClick:this.onLeaveRoomClick,label:Object(f.a)("Leave Room"),iconClassName:"mx_RoomTile_iconSignOut"})))}return l.a.createElement(l.a.Fragment,null,l.a.createElement(b.d,{className:"mx_RoomTile_menuButton",onClick:this.onGeneralMenuOpenClick,title:Object(f.a)("Room options"),isExpanded:!!this.state.generalMenuPosition}),e)}render(){const e=u()({mx_RoomTile:!0,mx_RoomTile_selected:this.state.selected,mx_RoomTile_hasMenuOpen:!(!this.state.generalMenuPosition&&!this.state.notificationsMenuPosition),mx_RoomTile_minimized:this.props.isMinimized});let t={displayName:null,avatarMxc:null};this.props.tag===y.a.Invite&&(t=D.a.instance.getInviteProfile(this.props.room.roomId));let s=t.displayName||this.props.room.name;"string"!=typeof s&&(s=""),s=s.replace(":",":​");const n=l.a.createElement(E.a,{room:this.props.room,avatarSize:48,displayBadge:this.props.isMinimized,oobData:{avatarUrl:t.avatarMxc}});let i;this.props.isMinimized||(this.state.hasUnsentEvents?i=l.a.createElement("div",{className:"mx_RoomTile_badgeContainer","aria-hidden":"true"},l.a.createElement(C.a,{notification:U.a.RED_EXCLAMATION,forceCount:!1,roomId:this.props.room.roomId})):this.notificationState&&(i=l.a.createElement("div",{className:"mx_RoomTile_badgeContainer","aria-hidden":"true"},l.a.createElement(C.a,{notification:this.notificationState,forceCount:!1,roomId:this.props.room.roomId}))));let a=null;this.showMessagePreview&&this.state.messagePreview&&(a=l.a.createElement("div",{className:"mx_RoomTile_messagePreview",id:L(this.props.room.roomId),title:this.state.messagePreview,dir:"auto"},this.state.messagePreview));const r=u()({mx_RoomTile_name:!0,mx_RoomTile_nameWithPreview:!!a,mx_RoomTile_nameHasUnreadEvents:this.notificationState.isUnread});let c=l.a.createElement("div",{className:"mx_RoomTile_nameContainer"},l.a.createElement("div",{title:s,className:r,tabIndex:-1,dir:"auto"},s),a);this.props.isMinimized&&(c=null);let d,p=s;this.props.tag===y.a.Invite||(this.notificationState.hasMentions?p+=" "+Object(f.a)("%(count)s unread messages including mentions.",{count:this.notificationState.count}):this.notificationState.hasUnreadCount?p+=" "+Object(f.a)("%(count)s unread messages.",{count:this.notificationState.count}):this.notificationState.isUnread&&(p+=" "+Object(f.a)("Unread messages."))),this.showMessagePreview&&(d=L(this.props.room.roomId));const g={};let v=m.a;return this.props.isMinimized&&(v=x.a,g.title=s,g.forceHide=!!this.state.generalMenuPosition),l.a.createElement(l.a.Fragment,null,l.a.createElement(h.d,{inputRef:this.roomTileRef},({onFocus:t,isActive:s,ref:a})=>l.a.createElement(v,o()({},g,{onFocus:t,tabIndex:s?0:-1,inputRef:a,className:e,onClick:this.onTileClick,onContextMenu:this.onContextMenu,role:"treeitem","aria-label":p,"aria-selected":this.state.selected,"aria-describedby":d}),n,c,i,this.renderGeneralMenu(),this.renderNotificationsMenu(s))))}})||n}).call(this,s(169).setImmediate)},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(18),i=s.n(n),o=s(683),a=s(686),r=s(156),c=s(96),l=s(687),d=s(688),u=s(689);const h=e=>"room-"+e.roomId;class m extends r.a{constructor(){super(c.a),i()(this,"caches",new Map)}static get instance(){return m._instance||(m._instance=new m),m._instance}get contexts(){return Array.from(this.caches.values()).map(e=>e.context)}getOrCreateChamberForRoom(e){if(this.caches.has(h(e)))return this.caches.get(h(e));const t=new a.a(e);t.whenAnything(()=>this.checkContexts());const s=new o.b(t);return s.setClient(this.matrixClient),this.caches.set(h(e),s),s}async checkContexts(){let e=!1;for(const t of this.caches.values())if(e=t.context.state===l.a.PendingErrors,e)break;if(e&&!this.state.toastRef){const e=d.a.instance.addToast(u.a);await this.updateState({toastRef:e})}else!e&&this.state.toastRef&&(d.a.instance.removeToast(this.state.toastRef),await this.updateState({toastRef:null}))}async onReady(){if(this.caches)for(const e of this.caches.values())e.setClient(this.matrixClient)}async onNotReady(){for(const e of this.caches.values())e.setClient(null)}async onAction(e){return Promise.resolve()}}i()(m,"_instance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(18),i=s.n(n),o=s(684),a=s(300),r=s(92);let c;!function(e){e[e.NotificationVolume=0]="NotificationVolume"}(c||(c={}));class l extends o.a{constructor(e){super(e,e=>this.properties.get(e)),i()(this,"properties",new Map),i()(this,"onAccountData",e=>{if("m.push_rules"===e.getType()){this.properties.get(c.NotificationVolume)!==Object(a.f)(this.context.room.roomId)&&this.updateNotificationVolume()}})}onClientChanged(e,t){this.properties.clear(),e&&e.removeListener("accountData",this.onAccountData),t&&(t.on("accountData",this.onAccountData),this.updateNotificationVolume())}updateNotificationVolume(){this.properties.set(c.NotificationVolume,Object(a.f)(this.context.room.roomId)),this.markEchoReceived(c.NotificationVolume),this.emit(o.b,c.NotificationVolume)}get notificationVolume(){return this.getValue(c.NotificationVolume)}set notificationVolume(e){this.setValue(Object(r.a)("Change notification settings"),c.NotificationVolume,e,async()=>Object(a.h)(this.context.room.roomId,e),o.c)}}},function(e,t,s){"use strict";s.d(t,"c",(function(){return r})),s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(18),i=s.n(n),o=s(455),a=s(8);async function r(){}const c="property_updated";class l extends a.EventEmitter{constructor(e,t){super(),this.context=e,this.lookupFn=t,i()(this,"cache",new Map),i()(this,"matrixClient",void 0)}setClient(e){const t=this.matrixClient;this.matrixClient=e,this.onClientChanged(t,e)}getValue(e){return this.cache.has(e)?this.cache.get(e).val:this.lookupFn(e)}cacheVal(e,t,s){this.cache.set(e,{txn:s,val:t}),this.emit(c,e)}decacheKey(e){this.cache.has(e)&&(this.context.disownTransaction(this.cache.get(e).txn),this.cache.delete(e),this.emit(c,e))}markEchoReceived(e){if(this.cache.has(e)){const t=this.cache.get(e).txn;this.context.disownTransaction(t),t.cancel()}this.decacheKey(e)}setValue(e,t,s,n,i){this.cache.has(t)&&this.cache.get(t).txn.cancel();const a=this.context.beginTransaction(e,n);this.cacheVal(t,s,a),a.when(o.b.Pending,()=>this.cacheVal(t,s,a)).when(o.b.Error,()=>i()),a.run()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(18),i=s.n(n),o=s(121);class a{constructor(){i()(this,"listeners",[])}when(e,t){return this.listeners.push({condition:e,fn:t}),this}whenAnyOf(e,t){for(const s of e)this.when(s,t);return this}whenAnything(e){return this.listeners.push({condition:null,fn:e}),this}notifyCondition(e){const t=Object(o.b)(this.listeners);for(const s of t)if(null===s.condition||s.condition===e)try{s.fn(this)}catch(t){console.error(`Error calling whenable listener for ${e}:`,t)}}destroy(){this.listeners=[]}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(687);class i extends n.b{constructor(e){super(),this.room=e}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(18),i=s.n(n),o=s(455),a=s(121),r=s(685);let c;!function(e){e[e.NotStarted=0]="NotStarted",e[e.PendingErrors=1]="PendingErrors",e[e.AllSuccessful=2]="AllSuccessful"}(c||(c={}));class l extends r.a{constructor(...e){super(...e),i()(this,"_transactions",[]),i()(this,"_state",c.NotStarted),i()(this,"checkTransactions",()=>{let e=c.AllSuccessful;for(const t of this.transactions){if(t.status===o.b.Error||t.didPreviouslyFail){e=c.PendingErrors;break}t.status===o.b.Pending&&(e=c.NotStarted)}this._state=e,this.notifyCondition(e)})}get transactions(){return Object(a.b)(this._transactions)}get state(){return this._state}get firstFailedTime(){const e=this.transactions.find(e=>e.didPreviouslyFail||e.status===o.b.Error);return e?e.startTime:null}disownTransaction(e){const t=this._transactions.indexOf(e);t>=0&&this._transactions.splice(t,1),e.destroy(),this.checkTransactions()}beginTransaction(e,t){const s=new o.a(e,t);return this._transactions.push(s),s.whenAnything(this.checkTransactions),s.when(o.b.Success,()=>s.destroy()),s}destroy(){for(const e of this.transactions)e.destroy();this._transactions=[],super.destroy()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(18),i=s.n(n),o=s(8),a=s.n(o),r=s(123);class c extends a.a{constructor(...e){super(...e),i()(this,"toasts",new Map)}static get instance(){return c._instance||(c._instance=new c),c._instance}get components(){return Array.from(this.toasts.values())}addToast(e){const t=Symbol();return this.toasts.set(t,e),this.emit(r.b),t}removeToast(e){this.toasts.delete(e),this.emit(r.b)}}i()(c,"_instance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(100),d=s(99),u=s(690),h=s(93);let m=Object(h.a)("views.toasts.NonUrgentEchoFailureToast")(n=class extends r.a.PureComponent{constructor(...e){super(...e),o()(this,"openDialog",()=>{d.a.createTrackedDialog("Local Echo Server Error","",u.a,{})})}render(){return r.a.createElement("div",{className:"mx_NonUrgentEchoFailureToast"},r.a.createElement("span",{className:"mx_NonUrgentEchoFailureToast_icon"}),Object(c.a)("Your server isn't responding to some <a>requests</a>.",{},{a:e=>r.a.createElement(l.a,{kind:"link",onClick:this.openDialog},e)}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n,i=s(18),o=s.n(i),a=s(91),r=s(124),c=s(92),l=s(682),d=s(150),u=s(98),h=s(686),m=s(129),p=s(455),g=s(119),v=s(100),f=s(123),b=s(94),y=s(93);let _=Object(y.a)("views.dialogs.ServerOfflineDialog")(n=class extends a.PureComponent{constructor(...e){super(...e),o()(this,"onEchosUpdated",()=>{this.forceUpdate()})}componentDidMount(){l.a.instance.on(f.b,this.onEchosUpdated)}componentWillUnmount(){l.a.instance.off(f.b,this.onEchosUpdated)}renderTimeline(){return l.a.instance.contexts.map((e,t)=>{if(!e.firstFailedTime)return null;if(!(e instanceof h.a))throw new Error("Cannot render unknown context: "+e);const s=a.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timeline_header"},a.createElement(m.a,{width:24,height:24,room:e.room}),a.createElement("span",null,e.room.name)),n=e.transactions.filter(e=>e.status===p.b.Error||e.didPreviouslyFail).map((e,t)=>{let s=a.createElement(g.a,{w:19,h:19});return e.status===p.b.Error&&(s=a.createElement(v.a,{kind:"link",onClick:()=>e.run()},Object(c.a)("Resend"))),a.createElement("div",{className:"mx_ServerOfflineDialog_content_context_txn",key:"txn-"+t},a.createElement("span",{className:"mx_ServerOfflineDialog_content_context_txn_desc"},e.auditName),s)});return a.createElement("div",{className:"mx_ServerOfflineDialog_content_context",key:"context-"+t},a.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timestamp"},Object(d.e)(e.firstFailedTime,u.b.getValue("showTwelveHourTimestamps"))),a.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timeline"},s,n))})}render(){let e=this.renderTimeline().filter(e=>!!e);0===e.length&&(e=[a.createElement("div",{key:1},Object(c.a)("You're all caught up."))]);const t=b.a.getHomeserverName();return a.createElement(r.a,{title:Object(c.a)("Server isn't responding"),className:"mx_ServerOfflineDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished,hasCancel:!0},a.createElement("div",{className:"mx_ServerOfflineDialog_content"},a.createElement("p",null,Object(c.a)("Your server isn't responding to some of your requests. Below are some of the most likely reasons.")),a.createElement("ul",null,a.createElement("li",null,Object(c.a)("The server (%(serverName)s) took too long to respond.",{serverName:t})),a.createElement("li",null,Object(c.a)("Your firewall or anti-virus is blocking the request.")),a.createElement("li",null,Object(c.a)("A browser extension is preventing the request.")),a.createElement("li",null,Object(c.a)("The server is offline.")),a.createElement("li",null,Object(c.a)("The server has denied your request.")),a.createElement("li",null,Object(c.a)("Your area is experiencing difficulties connecting to the internet.")),a.createElement("li",null,Object(c.a)("A connection error occurred while trying to contact the server.")),a.createElement("li",null,Object(c.a)("The server is not configured to indicate what the problem is (CORS)."))),a.createElement("hr",null),a.createElement("h2",null,Object(c.a)("Recent changes that have not yet been received")),e))}})||n},function(e,t,s){"use strict";s.d(t,"b",(function(){return C})),s.d(t,"a",(function(){return k}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(92),m=s(94),p=s(407),g=s(96),v=s(289),f=s(103),b=s(93),y=s(114),_=s(180),E=s(247),S=s(100),w=s(172);function C(e){return e?e.getPendingEvents().filter((function(e){return e.status===y.a.NOT_SENT})):[]}let k=Object(b.a)("structures.RoomStatusBar")((o=i=class extends l.a.PureComponent{constructor(...e){super(...e),r()(this,"state",{syncState:m.a.get().getSyncState(),syncStateData:m.a.get().getSyncStateData(),unsentMessages:C(this.props.room),isResending:!1}),r()(this,"onSyncStateChange",(e,t,s)=>{"SYNCING"===e&&"SYNCING"===t||this.setState({syncState:e,syncStateData:s})}),r()(this,"_onResendAllClick",()=>{p.a.resendUnsentEvents(this.props.room).then(()=>{this.setState({isResending:!1})}),this.setState({isResending:!0}),g.a.fire(f.a.FocusComposer)}),r()(this,"_onCancelAllClick",()=>{p.a.cancelUnsentEvents(this.props.room),g.a.fire(f.a.FocusComposer)}),r()(this,"_onRoomLocalEchoUpdated",(e,t,s,n)=>{if(t.roomId!==this.props.room.roomId)return;const i=C(this.props.room);this.setState({unsentMessages:i,isResending:i.length>0&&this.state.isResending})})}componentDidMount(){m.a.get().on("sync",this.onSyncStateChange),m.a.get().on("Room.localEchoUpdated",this._onRoomLocalEchoUpdated),this._checkSize()}componentDidUpdate(){this._checkSize()}componentWillUnmount(){const e=m.a.get();e&&(e.removeListener("sync",this.onSyncStateChange),e.removeListener("Room.localEchoUpdated",this._onRoomLocalEchoUpdated))}_checkSize(){this._getSize()?this.props.onVisible&&this.props.onVisible():this.props.onHidden&&this.props.onHidden()}_getSize(){return this._shouldShowConnectionError()?1:this.state.unsentMessages.length>0||this.state.isResending?2:0}_shouldShowConnectionError(){const e=Boolean(this.state.syncStateData&&this.state.syncStateData.error&&"M_RESOURCE_LIMIT_EXCEEDED"===this.state.syncStateData.error.errcode);return"ERROR"===this.state.syncState&&!e}_getUnsentMessageContent(){const e=this.state.unsentMessages;let t,s=null,n=null;for(const t of e){if(t.error&&"M_CONSENT_NOT_GIVEN"===t.error.errcode){s=t.error;break}if(t.error&&"M_RESOURCE_LIMIT_EXCEEDED"===t.error.errcode){n=t.error;break}}t=s?Object(h.a)("You can't send any messages until you review and agree to <consentLink>our terms and conditions</consentLink>.",{},{consentLink:e=>l.a.createElement("a",{href:s.data&&s.data.consent_uri,target:"_blank"},e)}):n?Object(v.a)(n.data.limit_type,n.data.admin_contact,{monthly_active_user:Object(h.b)("Your message wasn't sent because this homeserver has hit its Monthly Active User Limit. Please <a>contact your service administrator</a> to continue using the service."),hs_disabled:Object(h.b)("Your message wasn't sent because this homeserver has been blocked by it's administrator. Please <a>contact your service administrator</a> to continue using the service."),"":Object(h.b)("Your message wasn't sent because this homeserver has exceeded a resource limit. Please <a>contact your service administrator</a> to continue using the service.")}):Object(h.a)("Some of your messages have not been sent");let i=l.a.createElement(l.a.Fragment,null,l.a.createElement(S.a,{onClick:this._onCancelAllClick,className:"mx_RoomStatusBar_unsentCancelAllBtn"},Object(h.a)("Delete all")),l.a.createElement(S.a,{onClick:this._onResendAllClick,className:"mx_RoomStatusBar_unsentResendAllBtn"},Object(h.a)("Retry all")));return this.state.isResending&&(i=l.a.createElement(l.a.Fragment,null,l.a.createElement(w.a,{w:20,h:20}),l.a.createElement("span",null,Object(h.a)("Sending")))),l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"mx_RoomStatusBar mx_RoomStatusBar_unsentMessages"},l.a.createElement("div",{role:"alert"},l.a.createElement("div",{className:"mx_RoomStatusBar_unsentBadge"},l.a.createElement(_.a,{notification:E.a.RED_EXCLAMATION})),l.a.createElement("div",null,l.a.createElement("div",{className:"mx_RoomStatusBar_unsentTitle"},t),l.a.createElement("div",{className:"mx_RoomStatusBar_unsentDescription"},Object(h.a)("You can select all or individual messages to retry or delete"))),l.a.createElement("div",{className:"mx_RoomStatusBar_unsentButtonBar"},i))))}render(){return this._shouldShowConnectionError()?l.a.createElement("div",{className:"mx_RoomStatusBar"},l.a.createElement("div",{role:"alert"},l.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar"},l.a.createElement("img",{src:s(641),width:"24",height:"24",title:"/!\\ ",alt:"/!\\ "}),l.a.createElement("div",null,l.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_title"},Object(h.a)("Connectivity to the server has been lost.")),l.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_desc"},Object(h.a)("Sent messages will be stored until your connection has returned.")))))):this.state.unsentMessages.length>0||this.state.isResending?this._getUnsentMessageContent():null}},r()(i,"propTypes",{room:u.a.object.isRequired,isPeeking:u.a.bool,onResendAllClick:u.a.func,onCancelAllClick:u.a.func,onInviteClick:u.a.func,onResize:u.a.func,onHidden:u.a.func,onVisible:u.a.func}),n=o))||n},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return b}));var n,i=s(18),o=s.n(i),a=s(91),r=s(101),c=s.n(r),l=s(96),d=s(92),u=s(100),h=s(103),m=s(159),p=s(680),g=s(184),v=s(93),f=s(145);let b=Object(v.a)("structures.RoomSearch")(n=class extends a.PureComponent{constructor(t){super(t),o()(this,"dispatcherRef",void 0),o()(this,"inputRef",Object(a.createRef)()),o()(this,"searchFilter",new p.a),o()(this,"onSpaces",e=>{this.setState({inSpaces:e.length>0})}),o()(this,"onAction",e=>{"view_room"===e.action&&e.clear_search?this.clearInput():"focus_room_filter"===e.action&&this.inputRef.current&&this.inputRef.current.focus()}),o()(this,"clearInput",()=>{this.inputRef.current&&(this.inputRef.current.value="",this.onChange())}),o()(this,"openSearch",()=>{l.a.dispatch({action:"show_left_panel"}),l.a.dispatch({action:"focus_room_filter"})}),o()(this,"onChange",()=>{this.inputRef.current&&this.setState({query:this.inputRef.current.value})}),o()(this,"onFocus",e=>{this.setState({focused:!0}),e.target.select()}),o()(this,"onBlur",e=>{this.setState({focused:!1})}),o()(this,"onKeyDown",t=>{switch(Object(g.f)().getRoomListAction(t)){case g.e.ClearSearch:this.clearInput(),l.a.fire(h.a.FocusComposer);break;case g.e.NextRoom:case g.e.PrevRoom:this.props.onKeyDown(t);break;case g.e.SelectRoom:this.props.onSelectRoom()&&e(()=>{this.clearInput()});break}}),this.state={query:"",focused:!1,inSpaces:!1},this.dispatcherRef=l.a.register(this.onAction),f.f.instance.on(f.d,this.clearInput),f.f.instance.on(f.e,this.onSpaces)}componentDidUpdate(e,t){if(t.query!==this.state.query){const e=!!this.searchFilter.search.trim(),t=!!this.state.query.trim();this.searchFilter.search=this.state.query,!e&&t?m.b.instance.addFilter(this.searchFilter):e&&!t&&m.b.instance.removeFilter(this.searchFilter)}}componentWillUnmount(){l.a.unregister(this.dispatcherRef),f.f.instance.off(f.d,this.clearInput),f.f.instance.off(f.e,this.onSpaces)}render(){const e=c()({mx_RoomSearch:!0,mx_RoomSearch_hasQuery:this.state.query,mx_RoomSearch_focused:this.state.focused,mx_RoomSearch_minimized:this.props.isMinimized}),t=c()({mx_RoomSearch_input:!0,mx_RoomSearch_inputExpanded:this.state.query||this.state.focused});let s=Object(d.a)("Filter");this.state.inSpaces&&(s=Object(d.a)("Filter all spaces"));let n=a.createElement("div",{className:"mx_RoomSearch_icon"}),i=a.createElement("input",{type:"text",ref:this.inputRef,className:t,value:this.state.query,onFocus:this.onFocus,onBlur:this.onBlur,onChange:this.onChange,onKeyDown:this.onKeyDown,placeholder:s,autoComplete:"off"}),o=a.createElement(u.a,{tabIndex:-1,title:Object(d.a)("Clear filter"),className:"mx_RoomSearch_clearButton",onClick:this.clearInput});return this.props.isMinimized&&(n=a.createElement(u.a,{title:Object(d.a)("Filter rooms and people"),className:"mx_RoomSearch_icon mx_RoomSearch_minimizedHandle",onClick:this.openSearch}),i=null,o=null),a.createElement("div",{className:e},n,i,o)}})||n}).call(this,s(169).setImmediate)},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(18),i=s.n(n);class o{constructor(e,t,s){this.resizer=t,this.sizer=s,i()(this,"domNode",void 0),i()(this,"id",void 0),i()(this,"reverse",void 0),this.reverse=t.isReverseResizeHandle(e),this.domNode=this.reverse?e.nextElementSibling:e.previousElementSibling,this.id=e.getAttribute("data-id")}copyWith(e,t,s){return new(0,this.constructor)(e,t,s)}advance(e){let t=this.reverse?this.domNode.previousElementSibling:this.domNode.nextElementSibling;const s=e!==this.reverse;do{t=s?t.nextElementSibling:t.previousElementSibling}while(t&&!this.resizer.isResizeHandle(t));if(t){const e=this.copyWith(t,this.resizer,this.sizer);return e.reverse=this.reverse,e}}next(){return this.advance(!0)}previous(){return this.advance(!1)}size(){return this.sizer.getItemSize(this.domNode)}offset(){return this.sizer.getItemOffset(this.domNode)}start(){this.sizer.start(this.domNode)}finish(){this.sizer.finish(this.domNode)}getSize(){return this.sizer.getDesiredItemSize(this.domNode)}setRawSize(e){this.sizer.setItemSize(this.domNode,e)}setSize(e){this.setRawSize(Math.round(e)+"px");const t=this.resizer.config.onResized;t&&t(e,this.id,this.domNode)}clearSize(){this.sizer.clearItemSize(this.domNode);const e=this.resizer.config.onResized;e&&e(null,this.id,this.domNode)}first(){const e=Array.from(this.domNode.parentElement.children).find(e=>this.resizer.isResizeHandle(e));if(e)return this.copyWith(e,this.resizer,this.sizer)}last(){const e=Array.from(this.domNode.parentElement.children).reverse().find(e=>this.resizer.isResizeHandle(e));if(e)return this.copyWith(e,this.resizer,this.sizer)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{constructor(e,t,s){this.container=e,this.vertical=t,this.reverse=s}getItemOffset(e){const t=(this.vertical?e.offsetTop:e.offsetLeft)-this.getOffset();return this.reverse?this.getTotalSize()-(t+this.getItemSize(e)):t}getItemSize(e){return this.vertical?e.offsetHeight:e.offsetWidth}getTotalSize(){return this.vertical?this.container.offsetHeight:this.container.offsetWidth}getOffset(){return this.vertical?this.container.offsetTop:this.container.offsetLeft}getPageOffset(){let e=this.container,t=0;for(;e;){t+=this.vertical?e.offsetTop:e.offsetLeft,e=e.offsetParent}return t}getDesiredItemSize(e){return this.vertical?e.style.height:e.style.width}setItemSize(e,t){this.vertical?e.style.height=t:e.style.width=t}clearItemSize(e){this.vertical?e.style.height=null:e.style.width=null}start(e){}finish(e){}offsetFromEvent(e){const t=this.vertical?e.pageY:e.pageX;return this.reverse?this.getPageOffset()+this.getTotalSize()-t:t-this.getPageOffset()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n,i=s(18),o=s.n(i),a=s(101),r=s.n(a),c=s(91),l=s.n(c),d=s(98),u=s(390),h=s(0),m=s(171),p=s(93);let g=Object(p.a)("views.voip.VideoFeed")(n=class extends l.a.Component{constructor(e){super(e),o()(this,"element",Object(c.createRef)()),o()(this,"onNewStream",()=>{this.setState({audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}),this.playMedia()}),o()(this,"onResize",e=>{this.props.onResize&&!this.props.feed.isLocal()&&this.props.onResize(e)}),this.state={audioMuted:this.props.feed.isAudioMuted(),videoMuted:this.props.feed.isVideoMuted()}}componentDidMount(){this.props.feed.addListener(u.b.NewStream,this.onNewStream),this.playMedia()}componentWillUnmount(){var e;this.props.feed.removeListener(u.b.NewStream,this.onNewStream),null===(e=this.element.current)||void 0===e||e.removeEventListener("resize",this.onResize),this.stopMedia()}playMedia(){const e=this.element.current;if(e){e.muted=!0,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{e.play()}catch(e){h.a.info("Failed to play media element with feed",this.props.feed,e)}}}stopMedia(){const e=this.element.current;e&&(e.pause(),e.src=null)}render(){const e={mx_VideoFeed:!0,mx_VideoFeed_local:this.props.feed.isLocal(),mx_VideoFeed_remote:!this.props.feed.isLocal(),mx_VideoFeed_voice:this.state.videoMuted,mx_VideoFeed_video:!this.state.videoMuted,mx_VideoFeed_mirror:this.props.feed.isLocal()&&d.b.getValue("VideoView.flipVideoHorizontally")};if(this.state.videoMuted){const t=this.props.feed.getMember(),s=this.props.pipMode?76:160;return l.a.createElement("div",{className:r()(e)},l.a.createElement(m.a,{member:t,height:s,width:s}))}return l.a.createElement("video",{className:r()(e),ref:this.element})}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(92),m=s(109),p=s(153),g=s(351),v=s(99),f=s(93);let b=Object(f.a)("views.context_menus.CallContextMenu")((o=i=class extends l.a.Component{constructor(e){super(e),r()(this,"onHoldClick",()=>{this.props.call.setRemoteOnHold(!0),this.props.onFinished()}),r()(this,"onUnholdClick",()=>{p.e.sharedInstance().setActiveCallRoomId(this.props.call.roomId),this.props.onFinished()}),r()(this,"onTransferClick",()=>{v.a.createTrackedDialog("Transfer Call","",g.d,{kind:g.a,call:this.props.call},null,!1,!0),this.props.onFinished()})}render(){const e=this.props.call.isRemoteOnHold()?Object(h.a)("Resume"):Object(h.a)("Hold"),t=this.props.call.isRemoteOnHold()?this.onUnholdClick:this.onHoldClick;let s;return this.props.call.opponentCanBeTransferred()&&(s=l.a.createElement(m.f,{className:"mx_CallContextMenu_item",onClick:this.onTransferClick},Object(h.a)("Transfer"))),l.a.createElement(m.b,this.props,l.a.createElement(m.f,{className:"mx_CallContextMenu_item",onClick:t},e),s)}},r()(i,"propTypes",{user:u.a.object}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(109),d=s(112),u=s(434),h=s(93);let m=Object(h.a)("views.context_menus.DialpadContextMenu")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"onDigitPress",e=>{this.props.call.sendDtmfDigit(e),this.setState({value:this.state.value+e})}),o()(this,"onChange",e=>{this.setState({value:e.target.value})}),this.state={value:""}}render(){return r.a.createElement(l.b,this.props,r.a.createElement("div",{className:"mx_DialPadContextMenu_header"},r.a.createElement("div",null,r.a.createElement("span",{className:"mx_DialPadContextMenu_title"},Object(c.a)("Dial pad"))),r.a.createElement(d.a,{className:"mx_DialPadContextMenu_dialled",value:this.state.value,autoFocus:!0,onChange:this.onChange})),r.a.createElement("div",{className:"mx_DialPadContextMenu_horizSep"}),r.a.createElement("div",{className:"mx_DialPadContextMenu_dialPad"},r.a.createElement(u.a,{onDigitPress:this.onDigitPress,hasDialAndDelete:!1})))}})||n},,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return k}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(95),m=s(94),p=s(96),g=s(101),v=s.n(g),f=s(92),b=s(102),y=s(200),_=s(182),E=s(123),S=s(93),w=s(713);const C=Object.freeze({NotLoggedIn:"NotLoggedIn",Joining:"Joining",Loading:"Loading",Rejecting:"Rejecting",Kicked:"Kicked",Banned:"Banned",OtherThreePIDError:"OtherThreePIDError",InvitedEmailNotFoundInAccount:"InvitedEmailNotFoundInAccount",InvitedEmailNoIdentityServer:"InvitedEmailNoIdentityServer",InvitedEmailMismatch:"InvitedEmailMismatch",Invite:"Invite",ViewingRoom:"ViewingRoom",RoomNotFound:"RoomNotFound",OtherError:"OtherError"});let k=Object(S.a)("views.rooms.RoomPreviewBar")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"state",{busy:!1}),r()(this,"_onCommunityUpdate",e=>{this.props.room&&this.props.room.roomId!==e||this.forceUpdate()}),r()(this,"onLoginClick",()=>{p.a.dispatch({action:"start_login",screenAfterLogin:this._makeScreenAfterLogin()})}),r()(this,"onRegisterClick",()=>{p.a.dispatch({action:"start_registration",screenAfterLogin:this._makeScreenAfterLogin()})})}componentDidMount(){this._checkInvitedEmail(),_.a.instance.on(E.b,this._onCommunityUpdate)}componentDidUpdate(e,t){this.props.invitedEmail===e.invitedEmail&&this.props.inviterName===e.inviterName||this._checkInvitedEmail()}componentWillUnmount(){_.a.instance.off(E.b,this._onCommunityUpdate)}async _checkInvitedEmail(){if(this.props.inviterName&&this.props.invitedEmail){this.setState({busy:!0});try{const e=await m.a.get().getThreePids();if(this.setState({accountEmails:e.threepids.filter(e=>"email"===e.medium).map(e=>e.address)}),!m.a.get().getIdentityServerUrl())return void this.setState({busy:!1});const t=new y.a,s=await t.getAccessToken(),n=await m.a.get().lookupThreePid("email",this.props.invitedEmail,void 0,s);this.setState({invitedEmailMxid:n.mxid})}catch(e){this.setState({threePidFetchError:e})}this.setState({busy:!1})}}_getMessageCase(){if(m.a.get().isGuest())return C.NotLoggedIn;const e=this._getMyMember();if(e){if(e.isKicked())return C.Kicked;if("ban"===e.membership)return C.Banned}if(this.props.joining)return C.Joining;if(this.props.rejecting)return C.Rejecting;if(this.props.loading||this.state.busy)return C.Loading;if(this.props.inviterName){if(this.props.invitedEmail){if(this.state.threePidFetchError)return C.OtherThreePIDError;if(this.state.accountEmails&&!this.state.accountEmails.includes(this.props.invitedEmail))return C.InvitedEmailNotFoundInAccount;if(!m.a.get().getIdentityServerUrl())return C.InvitedEmailNoIdentityServer;if(this.state.invitedEmailMxid!=m.a.get().getUserId())return C.InvitedEmailMismatch}return C.Invite}return this.props.error?"M_NOT_FOUND"==this.props.error.errcode?C.RoomNotFound:C.OtherError:C.ViewingRoom}_getKickOrBanInfo(){const e=this._getMyMember();if(!e)return{};const t=this.props.room.currentState.getMember(e.events.member.getSender());return{memberName:t?t.name:e.events.member.getSender(),reason:e.events.member.getContent().reason}}_joinRule(){const e=this.props.room;if(e){const t=e.currentState.getStateEvents("m.room.join_rules","");if(t)return t.getContent().join_rule}}_communityProfile(){return this.props.room?_.a.instance.getInviteProfile(this.props.room.roomId):{displayName:null,avatarMxc:null}}_roomName(e=!1){let t=this.props.room?this.props.room.name:this.props.roomAlias;const s=this._communityProfile();return s.displayName&&(t=s.displayName),t||(e?Object(f.a)("This room"):Object(f.a)("this room"))}_getMyMember(){return this.props.room&&this.props.room.getMember(m.a.get().getUserId())}_getInviteMember(){const{room:e}=this.props;if(!e)return;const t=m.a.get().getUserId(),s=e.currentState.getMember(t);if(!s)return;const n=s.events.member.getSender();return e.currentState.getMember(n)}_isDMInvite(){const e=this._getMyMember();if(!e)return!1;const t=e.events.member.getContent();return"invite"===t.membership&&t.is_direct}_makeScreenAfterLogin(){return{screen:"room",params:{email:this.props.invitedEmail,signurl:this.props.signUrl,room_name:this.props.oobData?this.props.oobData.room_name:null,room_avatar_url:this.props.oobData?this.props.oobData.avatarUrl:null,inviter_name:this.props.oobData?this.props.oobData.inviterName:null}}}render(){const e=b.a.get().brand,t=h.getComponent("elements.Spinner"),s=h.getComponent("elements.AccessibleButton");let n,i,o,a,r,c,d,u,p=!1;const g=[],y=this._getMessageCase();switch(y){case C.Joining:n=Object(f.a)("Joining room …"),p=!0;break;case C.Loading:n=Object(f.a)("Loading …"),p=!0;break;case C.Rejecting:n=Object(f.a)("Rejecting invite …"),p=!0;break;case C.NotLoggedIn:n=Object(f.a)("Join the conversation with an account"),r=Object(f.a)("Sign Up"),a=this.onRegisterClick,d=Object(f.a)("Sign In"),c=this.onLoginClick,this.props.previewLoading&&(u=l.a.createElement("div",null,l.a.createElement(t,{w:20,h:20}),Object(f.a)("Loading room preview")));break;case C.Kicked:{const{memberName:e,reason:t}=this._getKickOrBanInfo();n=Object(f.a)("You were kicked from %(roomName)s by %(memberName)s",{memberName:e,roomName:this._roomName()}),i=t?Object(f.a)("Reason: %(reason)s",{reason:t}):null,"invite"===this._joinRule()?(r=Object(f.a)("Forget this room"),a=this.props.onForgetClick):(r=Object(f.a)("Re-join"),a=this.props.onJoinClick,d=Object(f.a)("Forget this room"),c=this.props.onForgetClick);break}case C.Banned:{const{memberName:e,reason:t}=this._getKickOrBanInfo();n=Object(f.a)("You were banned from %(roomName)s by %(memberName)s",{memberName:e,roomName:this._roomName()}),i=t?Object(f.a)("Reason: %(reason)s",{reason:t}):null,r=Object(f.a)("Forget this room"),a=this.props.onForgetClick;break}case C.OtherThreePIDError:{n=Object(f.a)("Something went wrong with your invite to %(roomName)s",{roomName:this._roomName()});const e=this._joinRule(),t=Object(f.a)("An error (%(errcode)s) was returned while trying to validate your invite. You could try to pass this information on to a room admin.",{errcode:this.state.threePidFetchError.errcode||Object(f.a)("unknown error code")});switch(e){case"invite":i=[Object(f.a)("You can only join it with a working invite."),t],r=Object(f.a)("Try to join anyway"),a=this.props.onJoinClick;break;case"public":i=Object(f.a)("You can still join it because this is a public room."),r=Object(f.a)("Join the discussion"),a=this.props.onJoinClick;break;default:i=t,r=Object(f.a)("Try to join anyway"),a=this.props.onJoinClick}break}case C.InvitedEmailNotFoundInAccount:n=Object(f.a)("This invite to %(roomName)s was sent to %(email)s which is not associated with your account",{roomName:this._roomName(),email:this.props.invitedEmail}),i=Object(f.a)("Link this email with your account in Settings to receive invites directly in %(brand)s.",{brand:e}),r=Object(f.a)("Join the discussion"),a=this.props.onJoinClick;break;case C.InvitedEmailNoIdentityServer:n=Object(f.a)("This invite to %(roomName)s was sent to %(email)s",{roomName:this._roomName(),email:this.props.invitedEmail}),i=Object(f.a)("Use an identity server in Settings to receive invites directly in %(brand)s.",{brand:e}),r=Object(f.a)("Join the discussion"),a=this.props.onJoinClick;break;case C.InvitedEmailMismatch:n=Object(f.a)("This invite to %(roomName)s was sent to %(email)s",{roomName:this._roomName(),email:this.props.invitedEmail}),i=Object(f.a)("Share this email in Settings to receive invites directly in %(brand)s.",{brand:e}),r=Object(f.a)("Join the discussion"),a=this.props.onJoinClick;break;case C.Invite:{const e=h.getComponent("views.avatars.RoomAvatar"),t=Object.assign({},this.props.oobData,{avatarUrl:this._communityProfile().avatarMxc}),u=l.a.createElement(e,{room:this.props.room,oobData:t}),p=this._getInviteMember();let v;v=p?l.a.createElement("span",null,l.a.createElement("span",{className:"mx_RoomPreviewBar_inviter"},p.rawDisplayName)," (",p.userId,")"):l.a.createElement("span",{className:"mx_RoomPreviewBar_inviter"},this.props.inviterName);this._isDMInvite()?(n=Object(f.a)("Do you want to chat with %(user)s?",{user:p.name}),i=[u,Object(f.a)("<userName/> wants to chat",{},{userName:()=>v})],r=Object(f.a)("Start chatting")):(n=Object(f.a)("Do you want to join %(roomName)s?",{roomName:this._roomName()}),i=[u,Object(f.a)("<userName/> invited you",{},{userName:()=>v})],r=Object(f.a)("Accept"));const b=m.a.get().getUserId(),y=this.props.room.currentState.getMember(b).events.member.event.content.reason;y&&(o=l.a.createElement(w.a,{reason:y})),a=this.props.onJoinClick,d=Object(f.a)("Reject"),c=this.props.onRejectClick,this.props.onRejectAndIgnoreClick&&g.push(l.a.createElement(s,{kind:"secondary",onClick:this.props.onRejectAndIgnoreClick,key:"ignore"},Object(f.a)("Reject & Ignore user")));break}case C.ViewingRoom:n=this.props.canPreview?Object(f.a)("You're previewing %(roomName)s. Want to join it?",{roomName:this._roomName()}):Object(f.a)("%(roomName)s can't be previewed. Do you want to join it?",{roomName:this._roomName(!0)}),r=Object(f.a)("Join the discussion"),a=this.props.onJoinClick;break;case C.RoomNotFound:n=Object(f.a)("%(roomName)s does not exist.",{roomName:this._roomName(!0)}),i=Object(f.a)("This room doesn't exist. Are you sure you're at the right place?");break;case C.OtherError:n=Object(f.a)("%(roomName)s is not accessible at this time.",{roomName:this._roomName(!0)}),i=[Object(f.a)("Try again later, or ask a room admin to check if you have access."),Object(f.a)("%(errcode)s was returned while trying to access the room. If you think you're seeing this message in error, please <issueLink>submit a bug report</issueLink>.",{errcode:this.props.error.errcode},{issueLink:e=>l.a.createElement("a",{href:"https://github.com/SchildiChat/schildichat-desktop/issues/new/choose",target:"_blank",rel:"noreferrer noopener"},e)})]}let _,E,S,k;i&&(Array.isArray(i)||(i=[i]),_=i.map((e,t)=>l.a.createElement("p",{key:"subTitle"+t},e))),E=p?l.a.createElement("h3",{className:"mx_RoomPreviewBar_spinnerTitle"},l.a.createElement(t,null),n):l.a.createElement("h3",null,n),a&&(S=l.a.createElement(s,{kind:"primary",onClick:a},r)),c&&(k=l.a.createElement(s,{kind:"secondary",onClick:c},d));const O=v()("mx_RoomPreviewBar","dark-panel","mx_RoomPreviewBar_"+y,{mx_RoomPreviewBar_panel:this.props.canPreview,mx_RoomPreviewBar_dialog:!this.props.canPreview});return l.a.createElement("div",{className:O},l.a.createElement("div",{className:"mx_RoomPreviewBar_message"},E,_),o,l.a.createElement("div",{className:"mx_RoomPreviewBar_actions"},k,g,S),l.a.createElement("div",{className:"mx_RoomPreviewBar_footer"},u))}},r()(i,"propTypes",{onJoinClick:u.a.func,onRejectClick:u.a.func,onRejectAndIgnoreClick:u.a.func,onForgetClick:u.a.func,inviterName:u.a.string,invitedEmail:u.a.string,oobData:u.a.object,signUrl:u.a.string,error:u.a.object,canPreview:u.a.bool,previewLoading:u.a.bool,room:u.a.object,spinner:u.a.bool,spinnerState:u.a.oneOf(["joining"]),loading:u.a.bool,joining:u.a.bool,rejecting:u.a.bool,roomAlias:u.a.string}),r()(i,"defaultProps",{onJoinClick(){}}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n,i=s(18),o=s.n(i),a=s(101),r=s.n(a),c=s(91),l=s.n(c),d=s(92),u=s(93);let h=Object(u.a)("views.elements.InviteReason")(n=class extends l.a.PureComponent{constructor(e){super(e),o()(this,"onViewClick",()=>{this.setState({hidden:!1})}),this.state={hidden:!0}}render(){const e=r()({mx_InviteReason:!0,mx_InviteReason_hidden:this.state.hidden});return l.a.createElement("div",{className:e},l.a.createElement("div",{className:"mx_InviteReason_reason"},this.props.reason),l.a.createElement("div",{className:"mx_InviteReason_view",onClick:this.onViewClick},Object(d.a)("View message")))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return g})),s.d(t,"b",(function(){return v}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(100),l=s(101),d=s.n(l),u=s(92),h=s(111),m=s(443),p=s(93);let g;!function(e){e.Room="Room",e.All="All"}(g||(g={}));let v=Object(p.a)("views.rooms.SearchBar")(n=class extends r.a.Component{constructor(e){super(e),o()(this,"searchTerm",Object(a.createRef)()),o()(this,"onThisRoomClick",()=>{this.setState({scope:g.Room},()=>this.searchIfQuery())}),o()(this,"onAllRoomsClick",()=>{this.setState({scope:g.All},()=>this.searchIfQuery())}),o()(this,"onSearchChange",e=>{switch(e.key){case h.a.ENTER:this.onSearch();break;case h.a.ESCAPE:this.props.onCancelClick()}}),o()(this,"onSearch",()=>{this.props.onSearch(this.searchTerm.current.value,this.state.scope)}),this.state={scope:g.Room}}searchIfQuery(){this.searchTerm.current.value&&this.onSearch()}render(){const e=d()("mx_SearchBar_searchButton",{mx_SearchBar_searching:this.props.searchInProgress}),t=d()("mx_SearchBar_button",{mx_SearchBar_unselected:this.state.scope!==g.Room}),s=d()("mx_SearchBar_button",{mx_SearchBar_unselected:this.state.scope!==g.All});return r.a.createElement(r.a.Fragment,null,r.a.createElement("div",{className:"mx_SearchBar"},r.a.createElement("div",{className:"mx_SearchBar_buttons",role:"radiogroup"},r.a.createElement(c.a,{className:t,onClick:this.onThisRoomClick,"aria-checked":this.state.scope===g.Room,role:"radio"},Object(u.a)("This Room")),r.a.createElement(c.a,{className:s,onClick:this.onAllRoomsClick,"aria-checked":this.state.scope===g.All,role:"radio"},Object(u.a)("All Rooms"))),r.a.createElement("div",{className:"mx_SearchBar_input mx_textinput"},r.a.createElement("input",{ref:this.searchTerm,type:"text",autoFocus:!0,placeholder:Object(u.a)("Search…"),onKeyDown:this.onSearchChange}),r.a.createElement(c.a,{className:e,onClick:this.onSearch})),r.a.createElement(c.a,{className:"mx_SearchBar_cancel",onClick:this.props.onCancelClick})),r.a.createElement(m.b,{isRoomEncrypted:this.props.isRoomEncrypted,kind:m.a.Search}))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(95),m=s(99),p=s(92),g=s(94),v=s(93);let f=Object(v.a)("views.rooms.RoomUpgradeWarningBar")((o=i=class extends l.a.PureComponent{constructor(e){super(e),r()(this,"_onStateEvents",(e,t)=>{if(!this.props.room||e.getRoomId()!==this.props.room.roomId)return;if("m.room.tombstone"!==e.getType())return;const s=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.setState({upgraded:s&&s.getContent().replacement_room})}),r()(this,"onUpgradeClick",()=>{const e=h.getComponent("dialogs.RoomUpgradeDialog");m.a.createTrackedDialog("Upgrade Room Version","",e,{room:this.props.room})}),this.state={}}componentDidMount(){const e=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.setState({upgraded:e&&e.getContent().replacement_room}),g.a.get().on("RoomState.events",this._onStateEvents)}componentWillUnmount(){const e=g.a.get();e&&e.removeListener("RoomState.events",this._onStateEvents)}render(){const e=h.getComponent("elements.AccessibleButton");let t=l.a.createElement("div",null,l.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},l.a.createElement("p",null,Object(p.a)("Upgrading this room will shut down the current instance of the room and create an upgraded room with the same name.")),l.a.createElement("p",null,Object(p.a)("<b>Warning</b>: Upgrading a room will <i>not automatically migrate room members to the new version of the room.</i> We'll post a link to the new room in the old version of the room - room members will have to click this link to join the new room.",{},{b:e=>l.a.createElement("b",null,e),i:e=>l.a.createElement("i",null,e)}))),l.a.createElement("p",{className:"mx_RoomUpgradeWarningBar_upgradelink"},l.a.createElement(e,{onClick:this.onUpgradeClick},Object(p.a)("Upgrade this room to the recommended room version"))));return this.state.upgraded&&(t=l.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},l.a.createElement("p",null,Object(p.a)("This room has already been upgraded.")))),l.a.createElement("div",{className:"mx_RoomUpgradeWarningBar"},l.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_wrapped"},l.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_header"},Object(p.a)("This room is running room version <roomVersion />, which this homeserver has marked as <i>unstable</i>.",{},{roomVersion:()=>l.a.createElement("code",null,this.props.room.getVersion()),i:e=>l.a.createElement("i",null,e)})),t,l.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_small"},Object(p.a)("Only room administrators will see this warning"))))}},r()(i,"propTypes",{room:u.a.object.isRequired,recommendation:u.a.object.isRequired}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(101),u=s.n(d),h=s(1),m=s(94),p=s(746),g=s(248),v=s(98),f=s(125),b=s(116),y=s(717),_=s(141),E=s(93);let S=Object(E.a)("views.rooms.AuxPanel")((o=i=class extends l.a.Component{constructor(e){super(e),r()(this,"rateLimitedUpdate",new g.a(()=>{this.setState({counters:this.computeCounters()})},500)),this.state={counters:this.computeCounters()}}componentDidMount(){const e=m.a.get();v.b.getValue("feature_state_counters")&&e.on("RoomState.events",this.rateLimitedUpdate)}componentWillUnmount(){const e=m.a.get();e&&v.b.getValue("feature_state_counters")&&e.removeListener("RoomState.events",this.rateLimitedUpdate)}shouldComponentUpdate(e,t){return Object(_.d)(this.props,e)||Object(_.d)(this.state,t)}componentDidUpdate(e,t){this.props.onResize&&this.props.onResize()}computeCounters(){const e=[];if(this.props.room&&v.b.getValue("feature_state_counters")){const t=this.props.room.currentState.getStateEvents("re.jki.counter");t.sort((e,t)=>Object(h.v)(e.getStateKey(),t.getStateKey()));for(const s of t){const t=s.getContent().title,n=s.getContent().value,i=s.getContent().link,o=s.getContent().severity||"normal",a=s.getStateKey();t&&void 0!==n&&e.push({title:t,value:n,link:i,severity:o,stateKey:a})}}return e}render(){const e=l.a.createElement(y.a,{roomId:this.props.room.roomId,maxVideoHeight:this.props.maxHeight,resizeNotifier:this.props.resizeNotifier});let t;v.b.getValue(b.a.Widgets)&&(t=l.a.createElement(p.a,{room:this.props.room,userId:this.props.userId,maxHeight:this.props.maxHeight,showApps:this.props.showApps,resizeNotifier:this.props.resizeNotifier}));let s=null;if(this.state.counters&&v.b.getValue("feature_state_counters")){const e=[];this.state.counters.forEach((t,s)=>{const n=t.title,i=t.value,o=t.link,a=t.severity,r=t.stateKey;let c=l.a.createElement("span",null,n,": ",i);o&&(c=l.a.createElement("a",{href:o,target:"_blank",rel:"noreferrer noopener"},c)),c=l.a.createElement("span",{className:"m_RoomView_auxPanel_stateViews_span","data-severity":a,key:"x-"+r},c),e.push(c),e.push(l.a.createElement("span",{className:"m_RoomView_auxPanel_stateViews_delim",key:"delim"+s}," ─ "))}),e.length>0&&(e.pop(),s=l.a.createElement("div",{className:"m_RoomView_auxPanel_stateViews"},e))}const n=u()({mx_RoomView_auxPanel:!0,mx_RoomView_auxPanel_fullHeight:this.props.fullHeight}),i={};return this.props.fullHeight||(i.maxHeight=this.props.maxHeight),l.a.createElement(f.a,{className:n,style:i},s,t,e,this.props.children)}},r()(i,"defaultProps",{showApps:!0}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n,i=s(18),o=s.n(i),a=s(158),r=s(91),c=s.n(r),l=s(153),d=s(461),u=s(96),h=s(284),m=s(93);let p=Object(m.a)("views.voip.CallViewForRoom")(n=class extends c.a.Component{constructor(e){super(e),o()(this,"dispatcherRef",void 0),o()(this,"onAction",e=>{switch(e.action){case"call_state":this.updateCall()}}),o()(this,"updateCall",()=>{const e=this.getCall();e!==this.state.call&&this.setState({call:e})}),o()(this,"onResizeStart",()=>{this.props.resizeNotifier.startResizing()}),o()(this,"onResize",()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()}),o()(this,"onResizeStop",()=>{this.props.resizeNotifier.stopResizing()}),this.state={call:this.getCall()}}componentDidMount(){this.dispatcherRef=u.a.register(this.onAction),l.e.sharedInstance().addListener(l.b.CallChangeRoom,this.updateCall)}componentWillUnmount(){u.a.unregister(this.dispatcherRef),l.e.sharedInstance().removeListener(l.b.CallChangeRoom,this.updateCall)}getCall(){const e=l.e.sharedInstance().getCallForRoom(this.props.roomId);return e&&[a.e.Ended,a.e.Ringing].includes(e.state)?null:e}render(){if(!this.state.call)return null;const e=this.props.maxVideoHeight-8;return c.a.createElement("div",{className:"mx_CallViewForRoom"},c.a.createElement(h.Resizable,{minHeight:380,maxHeight:e,enable:{top:!1,right:!1,bottom:!0,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this.onResizeStart,onResize:this.onResize,onResizeStop:this.onResizeStop,className:"mx_CallViewForRoom_ResizeWrapper",handleClasses:{bottom:"mx_CallViewForRoom_ResizeHandle"}},c.a.createElement(d.a,{call:this.state.call,pipMode:!1})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return O}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(101),m=s.n(h),p=s(92),g=s(94),v=s(248),f=s(98),b=s(719),y=s(206),_=s(259),E=s(113),S=s(329),w=s(191),C=s(153),k=s(93);let O=Object(k.a)("views.rooms.RoomHeader")((o=i=class extends l.a.Component{constructor(...e){super(...e),r()(this,"_onRoomStateEvents",(e,t)=>{this.props.room&&e.getRoomId()===this.props.room.roomId&&this._rateLimitedUpdate()}),r()(this,"_rateLimitedUpdate",new v.a((function(){this.forceUpdate()}),500))}componentDidMount(){g.a.get().on("RoomState.events",this._onRoomStateEvents)}componentWillUnmount(){const e=g.a.get();e&&e.removeListener("RoomState.events",this._onRoomStateEvents)}render(){let e=null;this.props.searchInfo&&void 0!==this.props.searchInfo.searchCount&&null!==this.props.searchInfo.searchCount&&(e=l.a.createElement("div",{className:"mx_RoomHeader_searchStatus"}," ",Object(p.a)("(~%(count)s results)",{count:this.props.searchInfo.searchCount})));let t=!1;const s=this.props.room?this.props.room.getJoinedMembers():void 0;if(s&&1===s.length&&s[0].userId===g.a.get().credentials.userId){const e=this.props.room.currentState.getStateEvents("m.room.name","");e&&e.getContent().name||(t=!0)}let n=Object(p.a)("Join Room");this.props.oobData&&this.props.oobData.name&&(n=this.props.oobData.name);const i=m()("mx_RoomHeader_nametext",{mx_RoomHeader_settingsHint:t}),o=l.a.createElement("div",{className:"mx_RoomHeader_name",onClick:this.props.onSettingsClick},l.a.createElement(w.a,{room:this.props.room},e=>{const t=e||n;return l.a.createElement("div",{dir:"auto",className:i,title:t},t)}),e),a=l.a.createElement(S.a,{room:this.props.room},(e,t)=>l.a.createElement("div",{className:"mx_RoomHeader_topic",ref:t,title:e,dir:"auto"},e));let r,c,d,u,h,v;this.props.room&&(r=l.a.createElement(_.a,{room:this.props.room,avatarSize:32,oobData:this.props.oobData,viewAvatarOnClick:!0})),this.props.onForgetClick&&(c=l.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_forgetButton",onClick:this.props.onForgetClick,title:Object(p.a)("Forget room")})),this.props.onAppsClick&&(d=l.a.createElement(E.a,{className:m()("mx_RoomHeader_button mx_RoomHeader_appsButton",{mx_RoomHeader_appsButton_highlight:this.props.appsShown}),onClick:this.props.onAppsClick,title:this.props.appsShown?Object(p.a)("Hide Widgets"):Object(p.a)("Show Widgets")})),this.props.onSearchClick&&this.props.inRoom&&(u=l.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_searchButton",onClick:this.props.onSearchClick,title:Object(p.a)("Search")})),this.props.inRoom&&f.b.getValue("showCallButtonsInComposer")&&(h=l.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_voiceCallButton",onClick:()=>this.props.onCallPlaced(C.c.Voice),title:Object(p.a)("Voice call")}),v=l.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_videoCallButton",onClick:e=>this.props.onCallPlaced(e.shiftKey?C.c.ScreenSharing:C.c.Video),title:Object(p.a)("Video call")}));const k=l.a.createElement("div",{className:"mx_RoomHeader_buttons"},v,h,c,d,u),O=this.props.e2eStatus?l.a.createElement(y.b,{status:this.props.e2eStatus}):void 0;return l.a.createElement("div",{className:"mx_RoomHeader light-panel"},l.a.createElement("div",{className:"mx_RoomHeader_wrapper","aria-owns":"mx_RightPanel"},l.a.createElement("div",{className:"mx_RoomHeader_avatar"},r),l.a.createElement("div",{className:"mx_RoomHeader_e2eIcon"},O),o,a,k,l.a.createElement(b.a,{room:this.props.room})))}},r()(i,"propTypes",{room:u.a.object,oobData:u.a.object,inRoom:u.a.bool,onSettingsClick:u.a.func,onSearchClick:u.a.func,onLeaveClick:u.a.func,e2eStatus:u.a.string,onAppsClick:u.a.func,appsShown:u.a.bool,onCallPlaced:u.a.func}),r()(i,"defaultProps",{editing:!1,inRoom:!1}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(467),d=s(468),u=s(126),h=s(103),m=s(249),p=s(93),g=s(327),v=s(348);const f=[u.c.RoomSummary,u.c.Widget,u.c.FilePanel,u.c.RoomMemberList,u.c.RoomMemberInfo,u.c.EncryptionPanel,u.c.Room3pidMemberInfo],b=({room:e,isHighlighted:t,onClick:s})=>{const n=Object(g.b)("feature_pinning"),i=Object(v.c)(n&&e),o=Object(v.d)(n&&e);if(!n)return null;let a;return i.some(e=>!o.has(e))&&(a=r.a.createElement("div",{className:"mx_RightPanel_pinnedMessagesButton_unreadIndicator"})),r.a.createElement(l.a,{name:"pinnedMessagesButton",title:Object(c.a)("Pinned messages"),isHighlighted:t,onClick:s,analytics:["Right Panel","Pinned Messages Button","click"]},a)};let y=Object(p.a)("views.right_panel.RoomHeaderButtons")(n=class extends d.b{constructor(e){super(e,d.a.Room),o()(this,"onRoomSummaryClicked",()=>{const e=m.a.getSharedInstance().roomPanelPhase;f.includes(e)?this.state.phase===e?this.setPhase(e):this.setPhase(e,m.a.getSharedInstance().roomPanelPhaseParams):this.setPhase(u.c.RoomSummary)}),o()(this,"onNotificationsClicked",()=>{this.setPhase(u.c.NotificationPanel)}),o()(this,"onPinnedMessagesClicked",()=>{this.setPhase(u.c.PinnedMessages)})}onAction(e){e.action===h.a.ViewUser?e.member?this.setPhase(u.c.RoomMemberInfo,{member:e.member}):this.setPhase(u.c.RoomMemberList):"view_3pid_invite"===e.action&&(e.event?this.setPhase(u.c.Room3pidMemberInfo,{event:e.event}):this.setPhase(u.c.RoomMemberList))}renderButtons(){return r.a.createElement(r.a.Fragment,null,r.a.createElement(b,{room:this.props.room,isHighlighted:this.isPhase(u.c.PinnedMessages),onClick:this.onPinnedMessagesClicked}),r.a.createElement(l.a,{name:"notifsButton",title:Object(c.a)("Notifications"),isHighlighted:this.isPhase(u.c.NotificationPanel),onClick:this.onNotificationsClicked,analytics:["Right Panel","Notification List Button","click"]}),r.a.createElement(l.a,{name:"roomSummaryButton",title:Object(c.a)("Room Info"),isHighlighted:this.isPhase(f),onClick:this.onRoomSummaryClicked,analytics:["Right Panel","Room Summary Button","click"]}))}})||n},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(96),a=s(207),r=s(154);t.a=({roomWidth:e})=>{const t=Object(n.useRef)(null),c=Object(n.useRef)(new Map);return Object(n.useEffect)(()=>{const e=()=>{var e;t.current&&(null===(e=t.current)||void 0===e?void 0:e.height)!==r.b.instance.windowHeight&&(t.current.height=r.b.instance.windowHeight)},n=o.a.register(e=>{if(0===e.action.indexOf("effects.")){(async e=>{if(!e)return null;let t=c.current[e]||null;if(null===t){var n;const i=null===(n=a.CHAT_EFFECTS.find(t=>t.command===e))||void 0===n?void 0:n.options;try{const{default:n}=await s(1267)("./"+e);t=new n(i),c.current[e]=t}catch(t){console.warn(`Unable to load effect module at '../../../effects/${e}.`,t)}}return t})(e.action.substr("effects.".length)).then(e=>null==e?void 0:e.start(t.current))}});return t.current.height=r.b.instance.windowHeight,r.b.instance.on(r.a.Resize,e),()=>{o.a.unregister(n),r.b.instance.off(r.a.Resize,e);const t=c.current;for(const e in t){const s=t[e];s&&s.isRunning&&s.stop()}}},[]),i.a.createElement("canvas",{ref:t,width:e,style:{display:"block",zIndex:999999,pointerEvents:"none",position:"fixed",top:0,right:0}})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(18),i=s.n(n);class o{constructor(e){this.event=e,i()(this,"serializedParts",null),i()(this,"caret",null)}setEditorState(e,t){this.caret=e,this.serializedParts=t}hasEditorState(){return!!this.serializedParts}getSerializedParts(){return this.serializedParts}getCaret(){return this.caret}getEvent(){return this.event}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return S})),s.d(t,"b",(function(){return w}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(326),l=s(92),d=s(449),u=s(723),h=s(724),m=s(339),p=s(726),g=s(727),v=s(95),f=s(94),b=s(96),y=s(98),_=s(116),E=s(93);const S="ROOM_SECURITY_TAB";let w=Object(E.a)("views.dialogs.RoomSettingsDialog")(n=class extends r.a.Component{constructor(...e){super(...e),o()(this,"dispatcherRef",void 0),o()(this,"onAction",e=>{"view_home_page"===e.action&&this.props.onFinished(!0)})}componentDidMount(){this.dispatcherRef=b.a.register(this.onAction)}componentWillUnmount(){this.dispatcherRef&&b.a.unregister(this.dispatcherRef)}getTabs(){const e=[];return e.push(new c.a("ROOM_GENERAL_TAB",Object(l.b)("General"),"mx_RoomSettingsDialog_settingsIcon",r.a.createElement(h.a,{roomId:this.props.roomId}))),e.push(new c.a(S,Object(l.b)("Security & Privacy"),"mx_RoomSettingsDialog_securityIcon",r.a.createElement(m.d,{roomId:this.props.roomId}))),e.push(new c.a("ROOM_ROLES_TAB",Object(l.b)("Roles & Permissions"),"mx_RoomSettingsDialog_rolesIcon",r.a.createElement(u.a,{roomId:this.props.roomId}))),e.push(new c.a("ROOM_NOTIFICATIONS_TAB",Object(l.b)("Notifications"),"mx_RoomSettingsDialog_notificationsIcon",r.a.createElement(p.a,{roomId:this.props.roomId}))),y.b.getValue("feature_bridge_state")&&e.push(new c.a("ROOM_BRIDGES_TAB",Object(l.b)("Bridges"),"mx_RoomSettingsDialog_bridgesIcon",r.a.createElement(g.a,{roomId:this.props.roomId}))),y.b.getValue(_.a.AdvancedSettings)&&e.push(new c.a("ROOM_ADVANCED_TAB",Object(l.b)("Advanced"),"mx_RoomSettingsDialog_warningIcon",r.a.createElement(d.a,{roomId:this.props.roomId,closeSettingsFn:()=>this.props.onFinished(!0)}))),e}render(){const e=v.getComponent("views.dialogs.BaseDialog"),t=f.a.get().getRoom(this.props.roomId).name;return r.a.createElement(e,{className:"mx_RoomSettingsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("Room Settings - %(roomName)s",{roomName:t})},r.a.createElement("div",{className:"mx_SettingsDialog_content"},r.a.createElement(c.b,{tabs:this.getTabs(),initialTabId:this.props.initialTabId})))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n,i=s(18),o=s.n(i),a=s(91),r=s.n(a),c=s(92),l=s(94),d=s(95),u=s(100),h=s(99),m=s(93),p=s(110),g=s(142);const v={[p.a.RoomAvatar]:Object(c.b)("Change room avatar"),[p.a.RoomName]:Object(c.b)("Change room name"),[p.a.RoomCanonicalAlias]:Object(c.b)("Change main address for the room"),[p.a.RoomHistoryVisibility]:Object(c.b)("Change history visibility"),[p.a.RoomPowerLevels]:Object(c.b)("Change permissions"),[p.a.RoomTopic]:Object(c.b)("Change topic"),[p.a.RoomTombstone]:Object(c.b)("Upgrade the room"),[p.a.RoomEncryption]:Object(c.b)("Enable room encryption"),[p.a.RoomServerAcl]:Object(c.b)("Change server ACLs"),"im.vector.modular.widgets":Object(c.b)("Modify widgets")},f={[p.a.RoomAvatar]:{isState:!0},[p.a.RoomName]:{isState:!0},[p.a.RoomCanonicalAlias]:{isState:!0},[p.a.RoomHistoryVisibility]:{isState:!0},[p.a.RoomPowerLevels]:{isState:!0},[p.a.RoomTopic]:{isState:!0},[p.a.RoomTombstone]:{isState:!0},[p.a.RoomEncryption]:{isState:!0},[p.a.RoomServerAcl]:{isState:!0},"im.vector.modular.widgets":{isState:!0}};function b(e,t){const s=parseInt(e);return isNaN(s)?t:s}class y extends r.a.Component{constructor(...e){super(...e),o()(this,"onUnbanClick",e=>{l.a.get().unban(this.props.member.roomId,this.props.member.userId).catch(e=>{const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to unban: "+e),h.a.createTrackedDialog("Failed to unban","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Failed to unban")})})})}render(){let e;this.props.canUnban&&(e=r.a.createElement(u.a,{className:"mx_RolesRoomSettingsTab_unbanBtn",kind:"danger_sm",onClick:this.onUnbanClick},Object(c.a)("Unban")));const t=this.props.member.name===this.props.member.userId?null:this.props.member.userId;return r.a.createElement("li",null,e,r.a.createElement("span",{title:Object(c.a)("Banned by %(displayName)s",{displayName:this.props.by})},r.a.createElement("strong",null,this.props.member.name)," ",t,this.props.reason?" "+Object(c.a)("Reason")+": "+this.props.reason:""))}}let _=Object(m.a)("views.settings.tabs.room.RolesRoomSettingsTab")(n=class extends r.a.Component{constructor(...e){super(...e),o()(this,"onRoomMembership",(e,t,s)=>{t.roomId===this.props.roomId&&this.forceUpdate()}),o()(this,"onPowerLevelsChanged",(e,t)=>{const s=l.a.get(),n=s.getRoom(this.props.roomId).currentState.getStateEvents("m.room.power_levels","");let i=n&&n.getContent()||{};i=Object.assign({},i);const o=parseInt(e);if(t.startsWith("event_levels_"))i.events=Object.assign({},i.events||{}),i.events[t.slice("event_levels_".length)]=o;else{const e=t.split(".");let s,n=i;for(const t of e)n[t]||(n[t]={}),s=n,n=n[t];s[e[e.length-1]]=o}s.sendStateEvent(this.props.roomId,"m.room.power_levels",i).catch(e=>{console.error(e);const t=d.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Power level requirement change failed","",t,{title:Object(c.a)("Error changing power level requirement"),description:Object(c.a)("An error occurred changing the room's power level requirements. Ensure you have sufficient permissions and try again.")})})}),o()(this,"onUserPowerLevelChanged",(e,t)=>{const s=l.a.get(),n=s.getRoom(this.props.roomId).currentState.getStateEvents("m.room.power_levels","");let i=n&&n.getContent()||{};i=Object.assign({},i),i.users||(i.users={}),i.users[t]=e,s.sendStateEvent(this.props.roomId,"m.room.power_levels",i).catch(e=>{console.error(e);const t=d.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Power level change failed","",t,{title:Object(c.a)("Error changing power level"),description:Object(c.a)("An error occurred changing the user's power level. Ensure you have sufficient permissions and try again.")})})})}componentDidMount(){l.a.get().on("RoomState.members",this.onRoomMembership)}componentWillUnmount(){const e=l.a.get();e&&e.removeListener("RoomState.members",this.onRoomMembership)}populateDefaultPlEvents(e,t,s){for(const n of Object.keys(f))n in e||(e[n]=f[n].isState?t:s)}render(){const e=d.getComponent("elements.PowerSelector"),t=l.a.get(),s=t.getRoom(this.props.roomId),n=s.currentState.getStateEvents("m.room.power_levels",""),i=n&&n.getContent()||{},o=s.currentState.mayClientSendStateEvent("m.room.power_levels",t),a={users_default:{desc:Object(c.a)("Default role"),defaultValue:0},events_default:{desc:Object(c.a)("Send messages"),defaultValue:0},invite:{desc:Object(c.a)("Invite users"),defaultValue:50},state_default:{desc:Object(c.a)("Change settings"),defaultValue:50},kick:{desc:Object(c.a)("Kick users"),defaultValue:50},ban:{desc:Object(c.a)("Ban users"),defaultValue:50},redact:{desc:Object(c.a)("Remove messages sent by others"),defaultValue:50},"notifications.room":{desc:Object(c.a)("Notify everyone"),defaultValue:50}},u=i.events||{},h=i.users||{},m=b(i.ban,a.ban.defaultValue),p=b(i.users_default,a.users_default.defaultValue);let f=h[t.getUserId()];void 0===f&&(f=p),this.populateDefaultPlEvents(u,b(i.state_default,a.state_default.defaultValue),b(i.events_default,a.events_default.defaultValue));let _,E=r.a.createElement("div",null,Object(c.a)("No users have specific privileges in this room"));if(Object.keys(h).length){const t=[],s=[];Object.keys(h).forEach(n=>{const i=h[n]<f&&o;h[n]>p?t.push(r.a.createElement(e,{value:h[n],disabled:!i,label:n,key:n,powerLevelKey:n,onChange:this.onUserPowerLevelChanged})):h[n]<p&&s.push(r.a.createElement(e,{value:h[n],disabled:!i,label:n,key:n,powerLevelKey:n,onChange:this.onUserPowerLevelChanged}))});const n=(e,t)=>{const s=h[t.key]-h[e.key];return 0!==s?s:Object(g.a)(e.key.toLocaleLowerCase(),t.key.toLocaleLowerCase())};t.sort(n),s.sort(n),t.length&&(E=r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(c.a)("Privileged Users")),t)),s.length&&(_=r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(c.a)("Muted Users")),s))}const S=s.getMembersWithMembership("ban");let w;if(S.length){const e=f>=m;w=r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(c.a)("Banned users")),r.a.createElement("ul",null,S.map(t=>{const n=t.events.member.getContent(),i=s.getMember(t.events.member.getSender());let o=t.events.member.getSender();return i&&(o=i.name),r.a.createElement(y,{key:t.userId,canUnban:e,member:t,reason:n.reason,by:o})})))}const C=Object.keys(a).map((t,s)=>{const n=a[t],c=t.split(".");let l=i;for(const e of c){if(void 0===l)break;l=l[e]}const d=b(l,n.defaultValue);return r.a.createElement("div",{key:s,className:""},r.a.createElement(e,{label:n.desc,value:d,usersDefault:p,disabled:!o||f<d,powerLevelKey:t,onChange:this.onPowerLevelsChanged}))});t.isRoomEncrypted(this.props.roomId)&&delete u["m.room.encryption"];const k=Object.keys(u).map((t,s)=>{let n=v[t];return n=n?Object(c.a)(n):Object(c.a)("Send %(eventType)s events",{eventType:t}),r.a.createElement("div",{className:"",key:t},r.a.createElement(e,{label:n,value:u[t],usersDefault:p,disabled:!o||f<u[t],powerLevelKey:"event_levels_"+t,onChange:this.onPowerLevelsChanged}))});return r.a.createElement("div",{className:"mx_SettingsTab mx_RolesRoomSettingsTab"},r.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(c.a)("Roles & Permissions")),E,_,w,r.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},r.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(c.a)("Permissions")),r.a.createElement("p",null,Object(c.a)("Select the roles required to change various parts of the room")),C,k))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(92),m=s(725),p=s(95),g=s(100),v=s(96),f=s(105),b=s(98),y=s(116),_=s(93);let E=Object(_.a)("views.settings.tabs.room.GeneralRoomSettingsTab")((o=i=class extends l.a.Component{constructor(){super(),r()(this,"_onLeaveClick",()=>{v.a.dispatch({action:"leave_room",room_id:this.props.roomId})}),this.state={isRoomPublished:!1}}render(){const e=p.getComponent("room_settings.AliasSettings"),t=p.getComponent("room_settings.RelatedGroupSettings"),s=p.getComponent("room_settings.UrlPreviewSettings"),n=this.context,i=n.getRoom(this.props.roomId),o=i.currentState.mayClientSendStateEvent("m.room.canonical_alias",n),a=i.currentState.getStateEvents("m.room.canonical_alias",""),r=i.currentState.mayClientSendStateEvent("m.room.related_groups",n),c=i.currentState.getStateEvents("m.room.related_groups","");let d,u=l.a.createElement(l.a.Fragment,null,l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("URL Previews")),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement(s,{room:i})));return b.b.getValue(y.a.URLPreviews)||(u=null),b.b.getValue(y.a.Flair)&&(d=l.a.createElement(l.a.Fragment,null,l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Flair")),l.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},l.a.createElement(t,{roomId:i.roomId,canSetRelatedGroups:r,relatedGroupsEvent:c})))),l.a.createElement("div",{className:"mx_SettingsTab mx_GeneralRoomSettingsTab"},l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(h.a)("General")),l.a.createElement("div",{className:"mx_SettingsTab_section mx_GeneralRoomSettingsTab_profileSection"},l.a.createElement(m.a,{roomId:this.props.roomId})),l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(h.a)("Room Addresses")),l.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},l.a.createElement(e,{roomId:this.props.roomId,canSetCanonicalAlias:o,canSetAliases:!0,canonicalAliasEvent:a})),l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(h.a)("Other")),d,u,l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Leave room")),l.a.createElement("div",{className:"mx_SettingsTab_section"},l.a.createElement(g.a,{kind:"danger",onClick:this._onLeaveClick},Object(h.a)("Leave room"))))}},r()(i,"propTypes",{roomId:u.a.string.isRequired}),r()(i,"contextType",f.a),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(92),m=s(94),p=s(112),g=s(95),v=s(93),f=s(107);let b=Object(v.a)("views.room_settings.RoomProfileSettings")((o=i=class extends l.a.Component{constructor(e){super(e),r()(this,"_uploadAvatar",()=>{this._avatarUpload.current.click()}),r()(this,"_removeAvatar",()=>{this._avatarUpload.current.value="",this.setState({avatarUrl:null,avatarFile:null,enableProfileSave:!0})}),r()(this,"_cancelProfileChanges",async e=>{e.stopPropagation(),e.preventDefault(),this.state.enableProfileSave&&this.setState({enableProfileSave:!1,displayName:this.state.originalDisplayName,topic:this.state.originalTopic,avatarUrl:this.state.originalAvatarUrl,avatarFile:null})}),r()(this,"_saveProfile",async e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.enableProfileSave)return;this.setState({enableProfileSave:!1});const t=m.a.get(),s={},n=this.state.displayName.trim();if(this.state.originalDisplayName!==this.state.displayName&&(await t.setRoomName(this.props.roomId,n),s.originalDisplayName=n,s.displayName=n),this.state.avatarFile){const e=await t.uploadContent(this.state.avatarFile);await t.sendStateEvent(this.props.roomId,"m.room.avatar",{url:e},""),s.avatarUrl=Object(f.b)(e).getSquareThumbnailHttp(96),s.originalAvatarUrl=s.avatarUrl,s.avatarFile=null}else this.state.originalAvatarUrl!==this.state.avatarUrl&&await t.sendStateEvent(this.props.roomId,"m.room.avatar",{},"");this.state.originalTopic!==this.state.topic&&(await t.setRoomTopic(this.props.roomId,this.state.topic),s.originalTopic=this.state.topic),this.setState(s)}),r()(this,"_onDisplayNameChanged",e=>{this.setState({displayName:e.target.value}),this.state.originalDisplayName===e.target.value?this.setState({enableProfileSave:!1}):this.setState({enableProfileSave:!0})}),r()(this,"_onTopicChanged",e=>{this.setState({topic:e.target.value}),this.state.originalTopic===e.target.value?this.setState({enableProfileSave:!1}):this.setState({enableProfileSave:!0})}),r()(this,"_onAvatarChanged",e=>{if(!e.target.files||!e.target.files.length)return void this.setState({avatarUrl:this.state.originalAvatarUrl,avatarFile:null,enableProfileSave:!1});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarUrl:e.target.result,avatarFile:t,enableProfileSave:!0})},s.readAsDataURL(t)});const t=m.a.get(),s=t.getRoom(e.roomId);if(!s)throw new Error("Expected a room for ID: ",e.roomId);const n=s.currentState.getStateEvents("m.room.avatar","");let i=n&&n.getContent()?n.getContent().url:null;i&&(i=Object(f.b)(i).getSquareThumbnailHttp(96));const o=s.currentState.getStateEvents("m.room.topic",""),a=o&&o.getContent()?o.getContent().topic:"",l=s.currentState.getStateEvents("m.room.name",""),d=l&&l.getContent()?l.getContent().name:"";this.state={originalDisplayName:d,displayName:d,originalAvatarUrl:i,avatarUrl:i,avatarFile:null,originalTopic:a,topic:a,enableProfileSave:!1,canSetName:s.currentState.maySendStateEvent("m.room.name",t.getUserId()),canSetTopic:s.currentState.maySendStateEvent("m.room.topic",t.getUserId()),canSetAvatar:s.currentState.maySendStateEvent("m.room.avatar",t.getUserId())},this._avatarUpload=Object(c.createRef)()}render(){const e=g.getComponent("elements.AccessibleButton"),t=g.getComponent("settings.AvatarSetting");let s;return(this.state.canSetName||this.state.canSetTopic||this.state.canSetAvatar)&&(s=l.a.createElement("div",{className:"mx_ProfileSettings_buttons"},l.a.createElement(e,{onClick:this._cancelProfileChanges,kind:"link",disabled:!this.state.enableProfileSave},Object(h.a)("Cancel")),l.a.createElement(e,{onClick:this._saveProfile,kind:"primary",disabled:!this.state.enableProfileSave},Object(h.a)("Save")))),l.a.createElement("form",{onSubmit:this._saveProfile,autoComplete:"off",noValidate:!0,className:"mx_ProfileSettings_profileForm"},l.a.createElement("input",{type:"file",ref:this._avatarUpload,className:"mx_ProfileSettings_avatarUpload",onChange:this._onAvatarChanged,accept:"image/*"}),l.a.createElement("div",{className:"mx_ProfileSettings_profile"},l.a.createElement("div",{className:"mx_ProfileSettings_controls"},l.a.createElement(p.a,{label:Object(h.a)("Room Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this._onDisplayNameChanged,disabled:!this.state.canSetName}),l.a.createElement(p.a,{className:"mx_ProfileSettings_controls_topic",id:"profileTopic",label:Object(h.a)("Room Topic"),disabled:!this.state.canSetTopic,type:"text",value:this.state.topic,autoComplete:"off",onChange:this._onTopicChanged,element:"textarea"})),l.a.createElement(t,{avatarUrl:this.state.avatarUrl,avatarName:this.state.displayName||this.props.roomId,avatarAltText:Object(h.a)("Room avatar"),uploadAvatar:this.state.canSetAvatar?this._uploadAvatar:void 0,removeAvatar:this.state.canSetAvatar?this._removeAvatar:void 0})),s)}},r()(i,"propTypes",{roomId:u.a.string.isRequired}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(92),m=s(94),p=s(100),g=s(253),v=s(98),f=s(106),b=s(93);let y=Object(b.a)("views.settings.tabs.room.NotificationsSettingsTab")((o=i=class extends l.a.Component{constructor(){super(),r()(this,"_soundUpload",Object(c.createRef)()),this.state={currentSound:"default",uploadedFile:null}}UNSAFE_componentWillMount(){const e=g.default.getSoundForRoom(this.props.roomId);e&&this.setState({currentSound:e.name||e.url})}async _triggerUploader(e){e.stopPropagation(),e.preventDefault(),this._soundUpload.current.click()}async _onSoundUploadChanged(e){if(!e.target.files||!e.target.files.length)return void this.setState({uploadedFile:null});const t=e.target.files[0];this.setState({uploadedFile:t})}async _onClickSaveSound(e){e.stopPropagation(),e.preventDefault();try{await this._saveSound()}catch(e){console.error("Unable to save notification sound for "+this.props.roomId),console.error(e)}}async _saveSound(){if(!this.state.uploadedFile)return;let e=this.state.uploadedFile.type;"video/ogg"===e&&(e="audio/ogg");const t=await m.a.get().uploadContent(this.state.uploadedFile,{type:e});await v.b.setValue("notificationSound",this.props.roomId,f.a.ROOM_ACCOUNT,{name:this.state.uploadedFile.name,type:e,size:this.state.uploadedFile.size,url:t}),this.setState({uploadedFile:null,currentSound:this.state.uploadedFile.name})}_clearSound(e){e.stopPropagation(),e.preventDefault(),v.b.setValue("notificationSound",this.props.roomId,f.a.ROOM_ACCOUNT,null),this.setState({currentSound:"default"})}render(){let e=null;return this.state.uploadedFile&&(e=l.a.createElement("div",null,l.a.createElement("span",null,Object(h.a)("Uploaded sound"),": ",l.a.createElement("code",null,this.state.uploadedFile.name)))),l.a.createElement("div",{className:"mx_SettingsTab"},l.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(h.a)("Notifications")),l.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},l.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(h.a)("Sounds")),l.a.createElement("div",null,l.a.createElement("span",null,Object(h.a)("Notification sound"),": ",l.a.createElement("code",null,this.state.currentSound)),l.a.createElement("br",null),l.a.createElement(p.a,{className:"mx_NotificationSound_resetSound",disabled:"default"==this.state.currentSound,onClick:this._clearSound.bind(this),kind:"primary"},Object(h.a)("Reset"))),l.a.createElement("div",null,l.a.createElement("h3",null,Object(h.a)("Set a new custom sound")),l.a.createElement("form",{autoComplete:"off",noValidate:!0},l.a.createElement("input",{ref:this._soundUpload,className:"mx_NotificationSound_soundUpload",type:"file",onChange:this._onSoundUploadChanged.bind(this),accept:"audio/*"})),e,l.a.createElement(p.a,{className:"mx_NotificationSound_browse",onClick:this._triggerUploader.bind(this),kind:"primary"},Object(h.a)("Browse")),l.a.createElement(p.a,{className:"mx_NotificationSound_save",disabled:null==this.state.uploadedFile,onClick:this._onClickSaveSound.bind(this),kind:"primary"},Object(h.a)("Save")),l.a.createElement("br",null))))}},r()(i,"propTypes",{roomId:u.a.string.isRequired}),n=o))||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n,i=s(91),o=s.n(i),a=s(92),r=s(94),c=s(728),l=s(93);const d=["uk.half-shot.bridge"];let u=Object(l.a)("views.settings.tabs.room.BridgeSettingsTab")(n=class e extends o.a.Component{renderBridgeCard(e,t){const s=e.getContent();return s&&s.channel&&s.protocol?o.a.createElement(c.a,{key:e.getId(),room:t,ev:e}):null}static getBridgeStateEvents(e){const t=r.a.get().getRoom(e).currentState;return d.map(e=>t.getStateEvents(e)).flat(1)}render(){const t=e.getBridgeStateEvents(this.props.roomId),s=r.a.get().getRoom(this.props.roomId);let n;return n=t.length>0?o.a.createElement("div",null,o.a.createElement("p",null,Object(a.a)("This room is bridging messages to the following platforms. <a>Learn more.</a>",{},{a:e=>o.a.createElement("a",{href:"https://matrix.org/bridges/",target:"_blank",rel:"noreferrer noopener"},e)})),o.a.createElement("ul",{className:"mx_RoomSettingsDialog_BridgeList"},t.map(e=>this.renderBridgeCard(e,s)))):o.a.createElement("p",null,Object(a.a)("This room isn’t bridging messages to any platforms. <a>Learn more.</a>",{},{a:e=>o.a.createElement("a",{href:"https://matrix.org/bridges/",target:"_blank",rel:"noreferrer noopener"},e)})),o.a.createElement("div",{className:"mx_SettingsTab"},o.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(a.a)("Bridges")),o.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},n))}})||n},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(92),m=s(469),p=s(122),g=s(130),v=s(98),f=s(134),b=s(93),y=s(107);let _=Object(b.a)("views.settings.BridgeTile")((o=i=class extends l.a.PureComponent{render(){var e,t;const s=this.props.ev.getContent();if(null===(e=s.channel)||void 0===e||!e.id||null===(t=s.protocol)||void 0===t||!t.id)return console.warn(`Bridge info event ${this.props.ev.getId()} has missing content. Tile will not render`),null;s.bridgebot||(console.warn(`Bridge info event ${this.props.ev.getId()} does not provide a 'bridgebot' key whichis deprecated behaviour. Using sender for now.`),s.bridgebot=this.props.ev.getSender());const{channel:n,network:i,protocol:o}=s,a=o.displayname||o.id,r=n.displayname||n.id;let c=null;s.creator&&(c=l.a.createElement("li",null,Object(h.a)("This bridge was provisioned by <user />.",{},{user:()=>l.a.createElement(m.a,{type:m.a.TYPE_USER_MENTION,room:this.props.room,url:Object(p.h)(s.creator),shouldShowPillAvatar:v.b.getValue("Pill.shouldShowPillAvatar")})})));const d=l.a.createElement("li",null,Object(h.a)("This bridge is managed by <user />.",{},{user:()=>l.a.createElement(m.a,{type:m.a.TYPE_USER_MENTION,room:this.props.room,url:Object(p.h)(s.bridgebot),shouldShowPillAvatar:v.b.getValue("Pill.shouldShowPillAvatar")})}));let u;if(o.avatar_url){const e=Object(y.b)(o.avatar_url).getSquareThumbnailHttp(64);u=l.a.createElement(g.a,{className:"protocol-icon",width:48,height:48,resizeMethod:"crop",name:a,idName:a,url:e})}else u=l.a.createElement("div",{className:"noProtocolIcon"});let b=null;if(i){const e=i.displayname||i.id;let t=l.a.createElement("span",null,e);"string"==typeof i.external_url&&Object(f.e)(i.external_url)&&(t=l.a.createElement("a",{href:i.external_url,target:"_blank",rel:"noreferrer noopener"},e)),b=Object(h.a)("Workspace: <networkLink/>",{},{networkLink:()=>t})}let _=l.a.createElement("span",null,r);"string"==typeof n.external_url&&Object(f.e)(n.external_url)&&(_=l.a.createElement("a",{href:n.external_url,target:"_blank",rel:"noreferrer noopener"},r));const E=this.props.ev.getId();return l.a.createElement("li",{key:E},l.a.createElement("div",{className:"column-icon"},u),l.a.createElement("div",{className:"column-data"},l.a.createElement("h3",null,a),l.a.createElement("p",{className:"workspace-channel-details"},b,l.a.createElement("span",{className:"channel"},Object(h.a)("Channel: <channelLink/>",{},{channelLink:()=>_}))),l.a.createElement("ul",{className:"metadata"},c," ",d)))}},r()(i,"propTypes",{ev:u.a.object.isRequired,room:u.a.object.isRequired}),n=o))||n},,function(e,t,s){"use strict";(function(e){var n=s(91),i=s.n(n),o=s(110),a=s(105),r=s(187),c=s(127),l=s(92),d=s(100),u=s(356),h=s(129),m=s(96),p=s(103),g=s(145),v=s(280),f=s(137),b=s(228),y=s(722);t.a=()=>{const t=Object(n.useContext)(a.a),{room:s,roomId:_}=Object(n.useContext)(r.a),E=c.a.shared().getUserIdForRoomId(_);let S;if(E){let e;s.getJoinedMemberCount()+s.getInvitedMemberCount()===2&&(e=Object(l.a)("Only the two of you are in this conversation, unless either of you invites anyone to join."));const t=null==s?void 0:s.getMember(E),n=(null==t?void 0:t.rawDisplayName)||E;S=i.a.createElement(i.a.Fragment,null,i.a.createElement(h.a,{room:s,width:u.a,height:u.a,onClick:()=>{m.a.dispatch({action:p.a.ViewUser,member:t||{userId:E}})}}),i.a.createElement("h2",null,s.name),i.a.createElement("p",null,Object(l.a)("This is the beginning of your direct message history with <displayName/>.",{},{displayName:()=>i.a.createElement("b",null,n)})),e&&i.a.createElement("p",null,e))}else{var w,C,k,O,R,I,x;const n=s&&"join"===s.getMyMembership(),a=null===(w=s.currentState.getStateEvents(o.a.RoomTopic,""))||void 0===w||null===(C=w.getContent())||void 0===C?void 0:C.topic,r=n&&s.currentState.maySendStateEvent(o.a.RoomTopic,t.getUserId()),c=()=>{m.a.dispatch({action:"open_room_settings",room_id:_},!0),e(()=>{window.document.getElementById("profileTopic").focus()})};let p;r&&a?p=Object(l.a)("Topic: %(topic)s (<a>edit</a>)",{topic:a},{a:e=>i.a.createElement(d.a,{kind:"link",onClick:c},e)}):a?p=Object(l.a)("Topic: %(topic)s ",{topic:a}):r&&(p=Object(l.a)("<a>Add a topic</a> to help people know what it is about.",{},{a:e=>i.a.createElement(d.a,{kind:"link",onClick:c},e)}));const f=null===(k=s.currentState.getStateEvents(o.a.RoomCreate,""))||void 0===k?void 0:k.getSender(),b=(null==s||null===(O=s.getMember(f))||void 0===O?void 0:O.rawDisplayName)||f;let y,E,T;y=f===t.getUserId()?Object(l.a)("You created this room."):Object(l.a)("%(displayName)s created this room.",{displayName:b}),null!==(R=g.f.instance.activeSpace)&&void 0!==R&&R.canInvite(t.getUserId())&&g.f.instance.getSpaceFilteredRoomIds(g.f.instance.activeSpace).has(s.roomId)&&(E=g.f.instance.activeSpace),E?T=i.a.createElement("div",{className:"mx_NewRoomIntro_buttons"},i.a.createElement(d.a,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{Object(v.e)(E)}},Object(l.a)("Invite to %(spaceName)s",{spaceName:E.name})),s.canInvite(t.getUserId())&&i.a.createElement(d.a,{className:"mx_NewRoomIntro_inviteButton",kind:"primary_outline",onClick:()=>{m.a.dispatch({action:"view_invite",roomId:_})}},Object(l.a)("Invite to just this room"))):s.canInvite(t.getUserId())&&(T=i.a.createElement("div",{className:"mx_NewRoomIntro_buttons"},i.a.createElement(d.a,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:()=>{m.a.dispatch({action:"view_invite",roomId:_})}},Object(l.a)("Invite to this room"))));const j=null===(I=s.currentState.getStateEvents(o.a.RoomAvatar,""))||void 0===I||null===(x=I.getContent())||void 0===x?void 0:x.url;S=i.a.createElement(i.a.Fragment,null,i.a.createElement(u.b,{hasAvatar:!!j,noAvatarLabel:Object(l.a)("Add a photo, so people can easily spot your room."),setAvatarUrl:e=>t.sendStateEvent(_,o.a.RoomAvatar,{url:e},"")},i.a.createElement(h.a,{room:s,width:u.a,height:u.a})),i.a.createElement("h2",null,s.name),i.a.createElement("p",null,y," ",Object(l.a)("This is the start of <roomName/>.",{},{roomName:()=>i.a.createElement("b",null,s.name)})),i.a.createElement("p",null,p),T)}function T(e){e.preventDefault(),m.a.dispatch({action:"open_room_settings",initial_tab_id:y.a})}const j=Object(l.a)("Your private messages are normally encrypted, but this room isn't. Usually this is due to an unsupported device or method being used, like email invites. <a>Enable encryption in settings.</a>",{},{a:e=>i.a.createElement("a",{onClick:T,href:"#"},e)});return i.a.createElement("div",{className:"mx_NewRoomIntro"},!function(e,t){const s=e.isRoomEncrypted(t.roomId);return"public"===t.getJoinRule()||!Object(f.f)()||s}(t,s)&&i.a.createElement(b.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon_warning",title:Object(l.a)("End-to-end encryption isn't enabled"),subtitle:j}),S)}}).call(this,s(169).setImmediate)},function(e,t,s){"use strict";var n=s(91),i=s.n(n),o=s(144),a=s(165),r=s(491);t.a=({description:e,acceptLabel:t,dismissLabel:s,onAccept:n,onDismiss:c,toastKey:l,numSeconds:d})=>{const u=()=>{c&&c(),o.a.sharedInstance().dismissToast(l)},h=Object(r.a)(u,1e3,d);let m=s;return h>0&&(m+=` (${h})`),i.a.createElement(a.a,{description:e,acceptLabel:t,onAccept:n,rejectLabel:m,onReject:u})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(97),c=s.n(r),l=s(296),d=s.n(l),u=s(92),h=s(305),m=s.n(h),p=s(96),g=s(94),v=s(101),f=s.n(v),b=s(105),y=s(125);class _ extends a.a.PureComponent{constructor(e,t){super(e,t),i()(this,"onAction",e=>{"client_started"===e.action&&this.forceUpdate()}),this._dispatcherRef=null,this.state={page:""}}translate(e){return m()(Object(u.a)(e))}componentDidMount(){this._unmounted=!1,this.props.url&&(d()({method:"GET",url:this.props.url},(e,t,s)=>{if(!this._unmounted){if(e||t.status<200||t.status>=300)return console.warn("Error loading page: "+e),void this.setState({page:Object(u.a)("Couldn't load page")});s=s.replace(/_t\(['"]([\s\S]*?)['"]\)/gm,(e,t)=>this.translate(t)),this.props.replaceMap&&Object.keys(this.props.replaceMap).forEach(e=>{s=s.split(e).join(this.props.replaceMap[e])}),this.setState({page:s})}}),this._dispatcherRef=p.a.register(this.onAction))}componentWillUnmount(){this._unmounted=!0,null!==this._dispatcherRef&&p.a.unregister(this._dispatcherRef)}render(){const e=this.context||g.a.get(),t=!e||e.isGuest(),s=this.props.className,n=f()({[s]:!0,[s+"_guest"]:t,[s+"_loggedIn"]:!!e}),i=a.a.createElement("div",{className:s+"_body",dangerouslySetInnerHTML:{__html:this.state.page}});return this.props.scrollbar?a.a.createElement(y.a,{className:n},i):a.a.createElement("div",{className:n},i)}}i()(_,"propTypes",{url:c.a.string,className:c.a.string,scrollbar:c.a.bool,replaceMap:c.a.object}),i()(_,"contextType",b.a)},function(e,t){e.exports="img/icons-create-room.817ede2.svg"},function(e,t){e.exports="img/cancel-small.495f44c.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return h})),s.d(t,"b",(function(){return m}));var n=s(91),i=s.n(n),o=s(147),a=s.n(o),r=s(94),c=s(98),l=s(263),d=s(469),u=s(122);function h(e,t,s){const n=r.a.get().getRoom(t.getRoomId()),o=c.b.getValue("Pill.shouldShowPillAvatar");let m=e[0];for(;m;){let e=!1;if("A"===m.tagName&&m.getAttribute("href")){const t=m.getAttribute("href"),r=Object(u.i)(t);if(r&&!r.eventId){const r=document.createElement("span"),c=i.a.createElement(d.a,{url:t,inMessage:!0,room:n,shouldShowPillAvatar:o});a.a.render(c,r),m.parentNode.replaceChild(r,m),s.push(r),e=!0,m=r}}else if(m.nodeType===Node.TEXT_NODE&&!m.parentElement.classList.contains("mx_AtRoomPill")){let e=m;const c=[];for(;null!==e;){const t=d.a.roomNotifPos(e.textContent);let s=null;if(t>-1){let n=e;t>0&&(n=n.splitText(t)),n.textContent.length>d.a.roomNotifLen()&&(s=n.splitText(d.a.roomNotifLen())),c.push(n)}e=s}if(c.length>0){const e=new l.a(r.a.get()),u=e.getPushRuleById(".m.rule.roomnotif");if(u&&e.ruleMatchesEvent(u,t)){for(const e of c){m=e.nextSibling;const t=document.createElement("span"),r=i.a.createElement(d.a,{type:d.a.TYPE_AT_ROOM_MENTION,inMessage:!0,room:n,shouldShowPillAvatar:o});a.a.render(r,t),e.parentNode.replaceChild(t,e),s.push(t)}continue}}}m.childNodes&&m.childNodes.length&&!e&&h(m.childNodes,t,s),m=m.nextSibling}}function m(e){for(const t of e)a.a.unmountComponentAtNode(t)}},,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return F}));var n=s(178),i=s(91),o=s.n(i),a=s(92),r=s(629),c=s(164),l=s(96);class d extends c.a{onChange(e,t,s){l.a.dispatch({action:"feature_custom_status_changed"})}}var u=s(421),h=s(94);class m extends c.a{constructor(e,t){super(),this.setter=e,this.inverse=t}onChange(e,t,s){this.setter.call(h.a.get(),this.inverse?!s:s)}}var p=s(118);class g extends c.a{onChange(e,t,s){p.a.get().reload()}}var v=s(103);class f extends c.a{constructor(){super()}onChange(e,t,s){l.a.dispatch({action:v.a.UpdateFontSize,size:s})}}var b=s(98);class y extends c.a{constructor(){super()}onChange(e,t,s){l.a.dispatch({action:v.a.UpdateSystemFont,useSystemFont:b.b.getValue("useSystemFont"),font:s})}}class _ extends c.a{constructor(){super()}onChange(e,t,s){l.a.dispatch({action:v.a.UpdateSystemFont,useSystemFont:s,font:b.b.getValue("systemFont")})}}var E=s(106),S=s(126),w=s(111);class C extends c.a{constructor(e,t=!1){super(),this.uiFeatureName=e,this.forcedValue=t}getValueOverride(e,t,s,n){return this.settingDisabled?this.forcedValue:null}get settingDisabled(){return!b.b.getValue(this.uiFeatureName)}}var k=s(116);class O extends c.a{constructor(e){super(),this.controllers=e}getValueOverride(e,t,s,n){for(const i of this.controllers){const o=i.getValueOverride(e,t,s,n);if(null!=o)return o}return null}onChange(e,t,s){for(const n of this.controllers)n.onChange(e,t,s)}get settingDisabled(){for(const e of this.controllers)if(e.settingDisabled)return!0;return!1}}var R=s(155);class I extends c.a{getValueOverride(e,t,s,n){return!this.prefersReducedMotion()&&null}get settingDisabled(){return this.prefersReducedMotion()}prefersReducedMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}}class x extends c.a{constructor(e,t=!1){super(),this.settingName=e,this.forcedValue=t}getValueOverride(e,t,s,n){return this.incompatibleSettingEnabled?this.forcedValue:null}get incompatibleSettingEnabled(){return b.b.getValue(this.settingName)}}var T=s(102);const j=[E.a.DEVICE,E.a.ROOM_DEVICE,E.a.ROOM_ACCOUNT,E.a.ACCOUNT,E.a.CONFIG],N=[E.a.ROOM_ACCOUNT,E.a.ACCOUNT],P=[E.a.DEVICE,E.a.ROOM_DEVICE,E.a.ROOM_ACCOUNT,E.a.ACCOUNT,E.a.CONFIG,E.a.ROOM],D=[E.a.DEVICE,E.a.ACCOUNT,E.a.CONFIG],A=[E.a.DEVICE,E.a.CONFIG],M=[E.a.DEVICE],U=[E.a.DEVICE,E.a.CONFIG],L=[E.a.CONFIG],F={feature_report_to_moderators:{isFeature:!0,displayName:Object(a.b)("Report to moderators prototype. In rooms that support moderation, the `report` button will let you report abuse to room moderators"),supportedLevels:A,default:!1},feature_spaces:{isFeature:!0,displayName:Object(a.b)("Spaces prototype. Incompatible with Communities, Communities v2 and Custom Tags. Requires compatible homeserver for some features."),supportedLevels:A,default:!1,controller:new g,betaInfo:{title:Object(a.b)("Spaces"),caption:Object(a.b)("Spaces are a new way to group rooms and people."),disclaimer:e=>e?o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(a.a)("If you leave, %(brand)s will reload with Spaces disabled. Communities and custom tags will be visible again.",{brand:T.a.get().brand})),o.a.createElement("p",null,Object(a.a)("Beta available for web, desktop and Android. Thank you for trying the beta."))):o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(a.a)("%(brand)s will reload with Spaces enabled. Communities and custom tags will be hidden.",{brand:T.a.get().brand})),o.a.createElement("b",null,Object(a.a)("You can leave the beta any time from settings or tapping on a beta badge, like the one above.")),o.a.createElement("p",null,Object(a.a)("Beta available for web, desktop and Android. Some features may be unavailable on your homeserver."))),image:s(1215),feedbackSubheading:Object(a.b)("Your feedback will help make spaces better. The more detail you can go into, the better."),feedbackLabel:"spaces-feedback",extraSettings:["feature_spaces.all_rooms","feature_spaces.space_member_dms","feature_spaces.space_dm_badges"]}},"feature_spaces.all_rooms":{displayName:Object(a.b)("Show all rooms in Home"),supportedLevels:A,default:!0,controller:new g},"feature_spaces.space_member_dms":{displayName:Object(a.b)("Show people in spaces"),description:Object(a.b)("If disabled, you can still add Direct Messages to Personal Spaces. If enabled, you'll automatically see everyone who is a member of the Space."),supportedLevels:A,default:!0,controller:new g},"feature_spaces.space_dm_badges":{displayName:Object(a.b)("Show notification badges for People in Spaces"),supportedLevels:A,default:!0,controller:new g},feature_dnd:{isFeature:!0,displayName:Object(a.b)("Show options to enable 'Do not disturb' mode"),supportedLevels:A,default:!1},feature_voice_messages:{isFeature:!0,displayName:Object(a.b)("Send and receive voice messages"),supportedLevels:A,default:!1},feature_latex_maths:{isFeature:!0,displayName:Object(a.b)("Render LaTeX maths in messages"),supportedLevels:A,default:!1},feature_communities_v2_prototypes:{isFeature:!0,displayName:Object(a.b)("Communities v2 prototypes. Requires compatible homeserver. Highly experimental - use with caution."),supportedLevels:A,default:!1,controller:new x("feature_spaces")},feature_new_spinner:{isFeature:!0,displayName:Object(a.b)("New spinner design"),supportedLevels:A,default:!0},feature_pinning:{isFeature:!0,displayName:Object(a.b)("Message Pinning"),supportedLevels:A,default:!0},feature_custom_status:{isFeature:!0,displayName:Object(a.b)("Custom user status messages"),supportedLevels:A,default:!1,controller:new d},feature_custom_tags:{isFeature:!0,displayName:Object(a.b)("Group & filter rooms by custom tags (refresh to apply changes)"),supportedLevels:A,default:!1,controller:new x("feature_spaces")},feature_state_counters:{isFeature:!0,displayName:Object(a.b)("Render simple counters in room header"),supportedLevels:A,default:!1},feature_many_integration_managers:{isFeature:!0,displayName:Object(a.b)("Multiple integration managers"),supportedLevels:A,default:!1},feature_mjolnir:{isFeature:!0,displayName:Object(a.b)("Try out new ways to ignore people (experimental)"),supportedLevels:A,default:!1},feature_custom_themes:{isFeature:!0,displayName:Object(a.b)("Support adding custom themes"),supportedLevels:A,default:!1},feature_roomlist_preview_reactions_dms:{isFeature:!0,displayName:Object(a.b)("Show message previews for reactions in DMs"),supportedLevels:A,default:!0,controller:new x("feature_roomlist_preview_reactions_all")},feature_roomlist_preview_reactions_all:{isFeature:!0,displayName:Object(a.b)("Show message previews for reactions in all rooms"),supportedLevels:A,default:!0},feature_dehydration:{isFeature:!0,displayName:Object(a.b)("Offline encrypted messaging using dehydrated devices"),supportedLevels:A,default:!1},scShowUpdateAnnouncementRoomToast:{supportedLevels:U,default:!0},advancedRoomListLogging:{displayName:Object(a.b)("Enable advanced debugging for the room list"),supportedLevels:M,default:!1},doNotDisturb:{supportedLevels:[E.a.DEVICE],default:!1},mjolnirRooms:{supportedLevels:[E.a.ACCOUNT],default:[]},mjolnirPersonalRoom:{supportedLevels:[E.a.ACCOUNT],default:null},feature_bridge_state:{isFeature:!0,supportedLevels:A,displayName:Object(a.b)("Show info about bridges in room settings"),default:!1},"RoomList.backgroundImage":{supportedLevels:D,default:null},baseFontSize:{displayName:Object(a.b)("Font size"),supportedLevels:D,default:10,controller:new f},useCustomFontSize:{displayName:Object(a.b)("Use custom size"),supportedLevels:D,default:!1},"MessageComposerInput.suggestEmoji":{supportedLevels:D,displayName:Object(a.b)("Enable Emoji suggestions while typing"),default:!0,invertedSettingName:"MessageComposerInput.dontSuggestEmoji"},"MessageComposerInput.showStickersButton":{supportedLevels:D,displayName:Object(a.b)("Show stickers button"),default:!0},"Notifications.alwaysShowBadgeCounts":{supportedLevels:N,default:!1},useCompactLayout:{supportedLevels:M,displayName:Object(a.b)("Use a more compact ‘Modern’ layout"),default:!1},showRedactions:{supportedLevels:P,displayName:Object(a.b)("Show a placeholder for removed messages"),default:!1,invertedSettingName:"hideRedactions"},showJoinLeaves:{supportedLevels:P,displayName:Object(a.b)("Show join/leave messages (invites/kicks/bans unaffected)"),default:!0,invertedSettingName:"hideJoinLeaves"},showAvatarChanges:{supportedLevels:P,displayName:Object(a.b)("Show avatar changes"),default:!0,invertedSettingName:"hideAvatarChanges"},showDisplaynameChanges:{supportedLevels:P,displayName:Object(a.b)("Show display name changes"),default:!0,invertedSettingName:"hideDisplaynameChanges"},showReadReceipts:{supportedLevels:j,displayName:Object(a.b)("Show read receipts sent by other users"),default:!0,invertedSettingName:"hideReadReceipts"},showTwelveHourTimestamps:{supportedLevels:D,displayName:Object(a.b)("Show timestamps in 12 hour format (e.g. 2:30pm)"),default:!1},alwaysShowTimestamps:{supportedLevels:D,displayName:Object(a.b)("Always show message timestamps"),default:!0},autoplayGifsAndVideos:{supportedLevels:D,displayName:Object(a.b)("Autoplay GIFs and videos"),default:!0},enableSyntaxHighlightLanguageDetection:{supportedLevels:D,displayName:Object(a.b)("Enable automatic language detection for syntax highlighting"),default:!1},expandCodeByDefault:{supportedLevels:D,displayName:Object(a.b)("Expand code blocks by default"),default:!1},showCodeLineNumbers:{supportedLevels:D,displayName:Object(a.b)("Show line numbers in code blocks"),default:!0},scrollToBottomOnMessageSent:{supportedLevels:D,displayName:Object(a.b)("Jump to the bottom of the timeline when you send a message"),default:!0},"Pill.shouldShowPillAvatar":{supportedLevels:D,displayName:Object(a.b)("Show avatars in user and room mentions"),default:!0,invertedSettingName:"Pill.shouldHidePillAvatar"},"TextualBody.enableBigEmoji":{supportedLevels:D,displayName:Object(a.b)("Enable big emoji in chat"),default:!0,invertedSettingName:"TextualBody.disableBigEmoji"},"MessageComposerInput.isRichTextEnabled":{supportedLevels:D,default:!1},"MessageComposer.showFormatting":{supportedLevels:D,default:!1},sendTypingNotifications:{supportedLevels:D,displayName:Object(a.b)("Send typing notifications"),default:!0,invertedSettingName:"dontSendTypingNotifications"},showTypingNotifications:{supportedLevels:D,displayName:Object(a.b)("Show typing notifications"),default:!0},ctrlFForSearch:{supportedLevels:D,displayName:w.b?Object(a.b)("Use Command + F to search"):Object(a.b)("Use Ctrl + F to search"),default:!0},"MessageComposerInput.ctrlEnterToSend":{supportedLevels:D,displayName:w.b?Object(a.b)("Use Command + Enter to send a message"):Object(a.b)("Use Ctrl + Enter to send a message"),default:!1},"MessageComposerInput.autoReplaceEmoji":{supportedLevels:D,displayName:Object(a.b)("Automatically replace plain text Emoji"),default:!1},"VideoView.flipVideoHorizontally":{supportedLevels:D,displayName:Object(a.b)("Mirror local video feed"),default:!1},"TagPanel.enableTagPanel":{supportedLevels:D,displayName:Object(a.b)("Enable Community Filter Panel"),default:!0,invertedSettingName:"TagPanel.disableTagPanel",controller:new C(k.a.Communities,!0)},theme:{supportedLevels:D,default:"light",controller:new u.a},custom_themes:{supportedLevels:D,default:[]},use_system_theme:{supportedLevels:M,default:!0,displayName:Object(a.b)("Match system theme")},useSystemFont:{supportedLevels:M,default:!1,displayName:Object(a.b)("Use a system font"),controller:new _},systemFont:{supportedLevels:M,default:"",displayName:Object(a.b)("System font name"),controller:new y},webRtcAllowPeerToPeer:{supportedLevels:U,displayName:Object(a.b)("Allow Peer-to-Peer for 1:1 calls (if you enable this, the other party might be able to see your IP address)"),default:!0,invertedSettingName:"webRtcForceTURN"},webrtc_audiooutput:{supportedLevels:M,default:null},webrtc_audioinput:{supportedLevels:M,default:null},webrtc_videoinput:{supportedLevels:M,default:null},language:{supportedLevels:U,default:"en"},breadcrumb_rooms:{supportedLevels:[E.a.ACCOUNT],default:[]},recent_emoji:{supportedLevels:[E.a.ACCOUNT],default:[]},room_directory_servers:{supportedLevels:[E.a.ACCOUNT],default:[]},integrationProvisioning:{supportedLevels:[E.a.ACCOUNT],default:!0},allowedWidgets:{supportedLevels:[E.a.ROOM_ACCOUNT,E.a.ROOM_DEVICE],supportedLevelsAreOrdered:!0,default:{}},analyticsOptIn:{supportedLevels:U,displayName:Object(a.b)("Send analytics data"),default:!1},showCookieBar:{supportedLevels:U,default:!0},autocompleteDelay:{supportedLevels:U,default:200},readMarkerInViewThresholdMs:{supportedLevels:U,default:3e3},readMarkerOutOfViewThresholdMs:{supportedLevels:U,default:3e4},blacklistUnverifiedDevices:{supportedLevels:[E.a.ROOM_DEVICE,E.a.DEVICE],supportedLevelsAreOrdered:!0,displayName:{default:Object(a.b)("Never send encrypted messages to unverified sessions from this session"),"room-device":Object(a.b)("Never send encrypted messages to unverified sessions in this room from this session")},default:!1,controller:new C(k.a.AdvancedEncryption)},urlPreviewsEnabled:{supportedLevels:P,displayName:{default:Object(a.b)("Enable inline URL previews by default"),"room-account":Object(a.b)("Enable URL previews for this room (only affects you)"),room:Object(a.b)("Enable URL previews by default for participants in this room")},default:!0,controller:new C(k.a.URLPreviews)},urlPreviewsEnabled_e2ee:{supportedLevels:[E.a.ROOM_DEVICE,E.a.ROOM_ACCOUNT],displayName:{"room-account":Object(a.b)("Enable URL previews for this room (only affects you)")},default:!1,controller:new C(k.a.URLPreviews)},roomColor:{supportedLevels:P,displayName:Object(a.b)("Room Colour"),default:{primary_color:null,secondary_color:null}},notificationsEnabled:{supportedLevels:M,default:!1,controller:new r.b},notificationSound:{supportedLevels:N,default:!1},notificationBodyEnabled:{supportedLevels:M,default:!0,controller:new r.a},audioNotificationsEnabled:{supportedLevels:M,default:!0},enableWidgetScreenshots:{supportedLevels:D,displayName:Object(a.b)("Enable widget screenshots on supported widgets"),default:!1},promptBeforeInviteUnknownUsers:{supportedLevels:D,displayName:Object(a.b)("Prompt before sending invites to potentially invalid matrix IDs"),default:!0},showDeveloperTools:{supportedLevels:D,displayName:Object(a.b)("Show developer tools"),default:!1},widgetOpenIDPermissions:{supportedLevels:M,default:{allow:[],deny:[]}},"RoomList.orderAlphabetically":{supportedLevels:D,displayName:Object(a.b)("Order rooms by name"),default:!1},"RoomList.orderByImportance":{supportedLevels:D,displayName:Object(a.b)("Show rooms with unread notifications first"),default:!0},unifiedRoomList:{supportedLevels:D,displayName:Object(a.b)("Show people and rooms in a combined list"),default:!0,controller:new g},breadcrumbs:{supportedLevels:D,displayName:Object(a.b)("Show shortcuts to recently viewed rooms above the room list"),default:!0},showHiddenEventsInTimeline:{displayName:Object(a.b)("Show hidden events in timeline"),supportedLevels:M,default:!1},lowBandwidth:{supportedLevels:U,displayName:Object(a.b)("Low bandwidth mode"),default:!1,controller:new g},fallbackICEServerAllowed:{supportedLevels:M,displayName:Object(a.b)("Allow fallback call assist server turn.matrix.org when your homeserver does not offer one (your IP address would be shared during a call)"),default:null},showImages:{supportedLevels:D,displayName:Object(a.b)("Show previews/thumbnails for images"),default:!0},showRightPanelInRoom:{supportedLevels:M,default:!1},showRightPanelInGroup:{supportedLevels:M,default:!1},lastRightPanelPhaseForRoom:{supportedLevels:M,default:S.c.RoomSummary},lastRightPanelPhaseForGroup:{supportedLevels:M,default:S.c.GroupMemberList},enableEventIndexing:{supportedLevels:M,displayName:Object(a.b)("Enable message search in encrypted rooms"),default:!0},crawlerSleepTime:{supportedLevels:M,displayName:Object(a.b)("How fast should messages be downloaded."),default:3e3},showCallButtonsInComposer:{supportedLevels:U,default:!0,controller:new C(k.a.Voip)},"e2ee.manuallyVerifyAllSessions":{supportedLevels:M,displayName:Object(a.b)("Manually verify all remote sessions"),default:!1,controller:new O([new C(k.a.AdvancedEncryption),new m(n.b.prototype.setCryptoTrustCrossSignedDevices,!0)])},ircDisplayNameWidth:{supportedLevels:[E.a.ROOM_DEVICE,E.a.DEVICE],supportedLevelsAreOrdered:!0,displayName:Object(a.b)("IRC display name width"),default:80},layout:{supportedLevels:D,default:R.a.Bubble},singleSideBubbles:{supportedLevels:P,displayName:Object(a.b)("Show message bubbles on one side only"),default:!1},adaptiveSideBubbles:{supportedLevels:P,displayName:Object(a.b)("Show message bubbles depending on the width either on both sides or only on one side"),default:!0},showChatEffects:{supportedLevels:P,displayName:Object(a.b)("Show chat effects (animations when receiving e.g. confetti)"),default:!0,controller:new I},"Widgets.pinned":{supportedLevels:N,default:{}},"Widgets.layout":{supportedLevels:N,default:{}},"Widgets.leftPanel":{supportedLevels:D,default:null},[k.a.RoomHistorySettings]:{supportedLevels:L,default:!0},[k.a.AdvancedEncryption]:{supportedLevels:L,default:!0},[k.a.URLPreviews]:{supportedLevels:L,default:!0},[k.a.Widgets]:{supportedLevels:L,default:!0},[k.a.Voip]:{supportedLevels:L,default:!0},[k.a.Feedback]:{supportedLevels:L,default:!0},[k.a.Registration]:{supportedLevels:L,default:!0},[k.a.PasswordReset]:{supportedLevels:L,default:!0},[k.a.Deactivate]:{supportedLevels:L,default:!0},[k.a.ShareQRCode]:{supportedLevels:L,default:!0},[k.a.ShareSocial]:{supportedLevels:L,default:!0},[k.a.IdentityServer]:{supportedLevels:L,default:!0,controller:new C(k.a.ThirdPartyID)},[k.a.ThirdPartyID]:{supportedLevels:L,default:!0},[k.a.Flair]:{supportedLevels:L,default:!0,controller:new C(k.a.Communities)},[k.a.Communities]:{supportedLevels:L,default:!0,controller:new x("feature_spaces")},[k.a.AdvancedSettings]:{supportedLevels:L,default:!0}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return Ae})),s.d(t,"b",(function(){return Me}));var n=s(104),i=s.n(n),o=s(18),a=s.n(o),r=s(91),c=s.n(r),l=s(152),d=s(215),u=s(168),h=(s(1009),s(1010),s(132)),m=s(120);function p(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function g(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?p(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):p(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class v{constructor(e,t){this.failedEventId=e,this.errorCode=t,a()(this,"ts",void 0),this.ts=Date.now()}}class f{constructor(e,t){if(this.fn=e,this.errorCodeMapFn=t,a()(this,"failures",[]),a()(this,"failureCounts",{}),a()(this,"trackedEventHashMap",{}),a()(this,"checkInterval",null),a()(this,"trackInterval",null),!e||"function"!=typeof e)throw new Error("DecryptionFailureTracker requires tracking function");if(t&&"function"!=typeof t)throw new Error("DecryptionFailureTracker second constructor argument should be a function")}eventDecrypted(e,t){t?this.addDecryptionFailure(new v(e.getId(),t.code)):this.removeDecryptionFailuresForEvent(e)}addDecryptionFailure(e){this.failures.push(e)}removeDecryptionFailuresForEvent(e){this.failures=this.failures.filter(t=>t.failedEventId!==e.getId())}start(){this.checkInterval=setInterval(()=>this.checkFailures(Date.now()),f.CHECK_INTERVAL_MS),this.trackInterval=setInterval(()=>this.trackFailures(),f.TRACK_INTERVAL_MS)}stop(){clearInterval(this.checkInterval),clearInterval(this.trackInterval),this.failures=[],this.failureCounts={}}checkFailures(e){const t=[],s=[];for(;this.failures.length>0;){const n=this.failures.shift();e>n.ts+f.GRACE_PERIOD_MS?t.push(n):s.push(n)}this.failures=s;const n=t.reduce((e,t)=>this.trackedEventHashMap[t.failedEventId]?e:e.set(t.failedEventId,t),new Map),i=[...n.keys()];this.trackedEventHashMap=i.reduce((e,t)=>g(g({},e),{},{[t]:!0}),this.trackedEventHashMap);const o=n.values();this.aggregateFailures(o)}aggregateFailures(e){for(const t of e){const e=t.errorCode;this.failureCounts[e]=(this.failureCounts[e]||0)+1}}trackFailures(){for(const e of Object.keys(this.failureCounts))if(this.failureCounts[e]>0){const t=this.errorCodeMapFn?this.errorCodeMapFn(e):e;this.fn(this.failureCounts[e],t),this.failureCounts[e]=0}}}a()(f,"TRACK_INTERVAL_MS",6e4),a()(f,"CHECK_INTERVAL_MS",5e3),a()(f,"GRACE_PERIOD_MS",6e4);var b=s(94),y=s(118),_=s(102),E=s(96),S=s(253),w=s(99),C=s(335),k=s(95),O=s(157),R=s(242),I=s(361),x=s(287),T=s(299);const j={deferredAction:null};class N extends T.Store{constructor(){super(E.a),a()(this,"state",j)}setState(e){this.state=Object.assign(this.state,e),this.__emitChange()}__onDispatch(e){switch(e.action){case"do_after_sync_prepared":this.setState({deferredAction:e.deferred_action});break;case"cancel_after_sync_prepared":this.setState({deferredAction:null});break;case"syncstate":{if("PREPARED"!==e.state)break;if(!this.state.deferredAction)break;const t=Object.assign({},this.state.deferredAction);this.setState({deferredAction:null}),E.a.dispatch(t);break}case"on_client_not_viable":case"on_logged_out":this.reset()}}reset(){this.state=Object.assign({},j)}}let P=null;P||(P=new N);var D=s(632),A=s(137),M=s(92),U=s(98),L=s(421),F=s(633),B=s(289),V=s(634),K=s(258),W=s(127),G=s(334),q=s(635),H=s(497),$=s(149),z=s(144),Y=s(337),J=s(103),Q=s(100),X=s(165);const Z=()=>{E.a.dispatch({action:"accept_cookies"})},ee=()=>{E.a.dispatch({action:"reject_cookies"})},te=()=>{h.a.showDetailsModal()},se=()=>{z.a.sharedInstance().dismissToast("analytics")};var ne=s(106);const ie=()=>{const e=_.a.get().sc_update_announcement_room,t={action:"view_room",auto_join:!0};"!"===e.room_id_or_alias[0]?t.room_id=e.room_id_or_alias:"#"===e.room_id_or_alias[0]&&(t.room_alias=e.room_id_or_alias),e.via_servers&&(t.opts={viaServers:e.via_servers},t.via_servers=e.via_servers),E.a.dispatch(t),U.b.setValue("scShowUpdateAnnouncementRoomToast",null,ne.a.DEVICE,!1),ae()},oe=()=>{U.b.setValue("scShowUpdateAnnouncementRoomToast",null,ne.a.DEVICE,!1),ae()},ae=()=>{z.a.sharedInstance().dismissToast("scupdateannouncementroom")};var re=s(428),ce=s(135),le=s(174),de=s(188),ue=s(636),he=s(637),me=s(116),pe=s(182),ge=s(638);const ve=()=>{window.location.href="mobile_guide/"},fe=()=>{document.cookie="element_mobile_redirect_to_guide=false;path=/;max-age=14400",be()},be=()=>{z.a.sharedInstance().dismissToast("mobileguide")};var ye=s(354),_e=s(145),Ee=s(93),Se=s(159),we=s(146),Ce=s(221);let ke;!function(e){e.APP_STARTUP="mx_AppStartup",e.PAGE_CHANGE="mx_PageChange",e.RESEND_EVENT="mx_ResendEvent",e.SEND_E2EE_EVENT="mx_SendE2EEEvent",e.SEND_ATTACHMENT="mx_SendAttachment",e.SWITCH_ROOM="mx_SwithRoom",e.JUMP_TO_ROOM="mx_JumpToRoom",e.JOIN_ROOM="mx_JoinRoom",e.CREATE_DM="mx_CreateDM",e.PEEK_ROOM="mx_PeekRoom",e.VERIFY_E2EE_USER="mx_VerifyE2EEUser",e.LOGIN="mx_Login",e.REGISTER="mx_Register",e.SETUP_VOIP_CALL="mx_SetupVoIPCall"}(ke||(ke={}));class Oe{constructor(){a()(this,"START_PREFIX","start:"),a()(this,"STOP_PREFIX","stop:"),a()(this,"listeners",[]),a()(this,"entries",[])}static get instance(){return Oe._instance||(Oe._instance=new Oe),Oe._instance}start(e,t){if(!this.supportsPerformanceApi())return;const s=this.buildKey(e,t);performance.getEntriesByName(this.START_PREFIX+s).length>0?console.warn("Recording already started for: "+e):performance.mark(this.START_PREFIX+s)}stop(e,t){if(!this.supportsPerformanceApi())return;const s=this.buildKey(e,t);if(0===performance.getEntriesByName(this.START_PREFIX+s).length)return void console.warn("No recording started for: "+e);performance.mark(this.STOP_PREFIX+s),performance.measure(s,this.START_PREFIX+s,this.STOP_PREFIX+s),this.clear(e,t);const n=performance.getEntriesByName(s).pop();return this.entries.push(n),this.listeners.forEach(e=>{this.shouldEmit(e,n)&&e.callback([n])}),n}clear(e,t){if(!this.supportsPerformanceApi())return;const s=this.buildKey(e,t);performance.clearMarks(this.START_PREFIX+s),performance.clearMarks(this.STOP_PREFIX+s)}getEntries({name:e,type:t}={}){return this.entries.filter(s=>{const n=!e||s.name===e,i=!t||s.entryType===t;return n&&i})}addPerformanceDataCallback(e,t=!1){if(this.listeners.push(e),t){const t=this.entries.filter(t=>this.shouldEmit(e,t));t.length>0&&e.callback(t)}}removePerformanceDataCallback(e){e?this.listeners.splice(this.listeners.findIndex(t=>t.callback===e),1):this.listeners=[]}supportsPerformanceApi(){return void 0!==performance&&void 0!==performance.mark}shouldEmit(e,t){return!e.entryNames||e.entryNames.includes(t.name)}buildKey(e,t){return`${e}${t?":"+t:""}`}}a()(Oe,"_instance",void 0),window.mxPerformanceMonitor=Oe.instance,window.mxPerformanceEntryNames=ke;var Re,Ie,xe,Te=s(154);function je(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}let Ne;!function(e){e[e.LOADING=0]="LOADING",e[e.WELCOME=1]="WELCOME",e[e.LOGIN=2]="LOGIN",e[e.REGISTER=3]="REGISTER",e[e.FORGOT_PASSWORD=4]="FORGOT_PASSWORD",e[e.COMPLETE_SECURITY=5]="COMPLETE_SECURITY",e[e.E2E_SETUP=6]="E2E_SETUP",e[e.LOGGED_IN=7]="LOGGED_IN",e[e.SOFT_LOGOUT=8]="SOFT_LOGOUT"}(Ne||(Ne={}));const Pe=["register","login","forgot_password","start_sso","start_cas"],De=[J.a.ViewUserSettings,"view_create_chat","view_create_room","view_create_group"];let Ae=Object(Ee.a)("structures.MatrixChat")((xe=Ie=class extends c.a.PureComponent{constructor(e,t){if(super(e,t),a()(this,"firstSyncComplete",void 0),a()(this,"firstSyncPromise",void 0),a()(this,"screenAfterLogin",void 0),a()(this,"pageChanging",void 0),a()(this,"tokenLogin",void 0),a()(this,"accountPassword",void 0),a()(this,"accountPasswordTimer",void 0),a()(this,"focusComposer",void 0),a()(this,"subTitleStatus",void 0),a()(this,"prevWindowWidth",void 0),a()(this,"loggedInView",void 0),a()(this,"dispatcherRef",void 0),a()(this,"themeWatcher",void 0),a()(this,"fontWatcher",void 0),a()(this,"onAction",e=>{const t=k.getComponent("dialogs.QuestionDialog");if(b.a.get()&&b.a.get().isGuest()&&De.includes(e.action))return E.a.dispatch({action:"do_after_sync_prepared",deferred_action:e}),void E.a.dispatch({action:"require_registration"});switch(e.action){case"MatrixActions.accountData":if("m.identity_server"===e.event_type){const t=e.event_content?e.event_content.base_url:null;t?(b.a.get().setIdentityServerUrl(t),localStorage.removeItem("mx_is_access_token"),localStorage.setItem("mx_is_url",t)):(b.a.get().setIdentityServerUrl(null),localStorage.removeItem("mx_is_access_token"),localStorage.removeItem("mx_is_url")),E.a.dispatch({action:"id_server_changed"})}break;case"logout":E.a.dispatch({action:"hangup_all"}),x.i();break;case"require_registration":Object(F.b)(e);break;case"start_registration":if(x.g()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.startRegistration(e.params||{});break;case"start_login":if(x.g()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.viewLogin();break;case"start_password_recovery":this.setStateForNewView({view:Ne.FORGOT_PASSWORD}),this.notifyNewScreen("forgot_password");break;case"start_chat":Object(A.b)({dmUserId:e.user_id});break;case"leave_room":this.leaveRoom(e.room_id);break;case"forget_room":this.forgetRoom(e.room_id);break;case"reject_invite":w.a.createTrackedDialog("Reject invitation","",t,{title:Object(M.a)("Reject invitation"),description:Object(M.a)("Are you sure you want to reject the invitation?"),onFinished:t=>{if(t){const t=k.getComponent("elements.Spinner"),s=w.a.createDialog(t,null,"mx_Dialog_spinner");b.a.get().leave(e.room_id).then(()=>{s.close(),this.state.currentRoomId===e.room_id&&E.a.dispatch({action:"view_home_page"})},e=>{s.close(),w.a.createTrackedDialog("Failed to reject invitation","",ce.a,{title:Object(M.a)("Failed to reject invitation"),description:e.toString()})})}}});break;case"view_user_info":this.viewUser(e.userId,e.subAction);break;case"view_room":{const t=this.viewRoom(e);e.deferred_action&&t.then(()=>{E.a.dispatch(e.deferred_action)});break}case J.a.ViewUserSettings:{const t=e,s=k.getComponent("dialogs.UserSettingsDialog");w.a.createTrackedDialog("User settings","",s,{initialTabId:t.initialTabId},null,!1,!0),this.viewSomethingBehindModal();break}case"view_create_room":this.createRoom(e.public,e.defaultName);break;case"view_create_group":{let e=k.getComponent("dialogs.CreateGroupDialog");U.b.getValue("feature_communities_v2_prototypes")&&(e=ue.a),w.a.createTrackedDialog("Create Community","",e);break}case J.a.ViewRoomDirectory:if(_e.f.instance.activeSpace)E.a.dispatch({action:"view_room",room_id:_e.f.instance.activeSpace.roomId});else{const t=k.getComponent("structures.RoomDirectory");w.a.createTrackedDialog("Room directory","",t,{initialText:e.initialText},"mx_RoomDirectory_dialogWrapper",!1,!0)}this.viewSomethingBehindModal();break;case"view_my_groups":this.setPage(D.a.MyGroups),this.notifyNewScreen("groups");break;case"view_group":this.viewGroup(e);break;case"view_welcome_page":this.viewWelcome();break;case"view_home_page":this.viewHome(e.justRegistered);break;case"view_start_chat_or_reuse":this.chatCreateOrReuse(e.user_id);break;case"view_create_chat":Object(O.h)(e.initialText||"");break;case"view_invite":Object(O.g)(e.roomId);break;case"view_last_screen":this.showScreenAfterLogin();break;case"toggle_my_groups":localStorage.setItem("mx_seenSpacesBeta","1"),this.state.page_type===D.a.MyGroups?E.a.dispatch({action:"view_last_screen"}):E.a.dispatch({action:"view_my_groups"});break;case"hide_left_panel":this.setState({collapseLhs:!0},()=>{this.state.resizeNotifier.notifyLeftHandleResized()});break;case"focus_room_filter":case"show_left_panel":this.setState({collapseLhs:!1},()=>{this.state.resizeNotifier.notifyLeftHandleResized()});break;case J.a.OpenDialPad:w.a.createTrackedDialog("Dial pad","",ge.a,{},"mx_Dialog_dialPadWrapper");break;case"on_logged_in":this.tokenLogin||x.g()||this.state.view===Ne.LOGIN||this.state.view===Ne.REGISTER||this.state.view===Ne.COMPLETE_SECURITY||this.state.view===Ne.E2E_SETUP||this.onLoggedIn();break;case"on_client_not_viable":this.onSoftLogout();break;case"on_logged_out":this.onLoggedOut();break;case"will_start_client":this.setState({ready:!1},()=>{this.onWillStartClient()});break;case"client_started":this.onClientStarted();break;case"send_event":this.onSendEvent(e.room_id,e.event);break;case"aria_hide_main_app":this.setState({hideToSRUsers:!0});break;case"aria_unhide_main_app":this.setState({hideToSRUsers:!1});break;case"accept_cookies":U.b.setValue("analyticsOptIn",null,ne.a.DEVICE,!0),U.b.setValue("showCookieBar",null,ne.a.DEVICE,!1),se(),h.a.canEnable()&&h.a.enable(),m.a.instance.canEnable()&&m.a.instance.enable(!1);break;case"reject_cookies":U.b.setValue("analyticsOptIn",null,ne.a.DEVICE,!1),U.b.setValue("showCookieBar",null,ne.a.DEVICE,!1),se()}}),a()(this,"handleResize",()=>{const e=Te.b.instance.windowWidth;this.prevWindowWidth<1e3&&e>=1e3&&E.a.dispatch({action:"show_left_panel"}),this.prevWindowWidth>=1e3&&e<1e3&&E.a.dispatch({action:"hide_left_panel"}),this.prevWindowWidth=e,this.state.resizeNotifier.notifyWindowResized()}),a()(this,"onRegisterClick",()=>{this.showScreen("register")}),a()(this,"onLoginClick",()=>{this.showScreen("login")}),a()(this,"onForgotPasswordClick",()=>{this.showScreen("forgot_password")}),a()(this,"onRegisterFlowComplete",(e,t)=>this.onUserCompletedLoginFlow(e,t)),a()(this,"onServerConfigChange",e=>{this.setState({serverConfig:e})}),a()(this,"makeRegistrationUrl",e=>(this.props.startingFragmentQueryParams.referrer&&(e.referrer=this.props.startingFragmentQueryParams.referrer),this.props.makeRegistrationUrl(e))),a()(this,"onUserCompletedLoginFlow",async(e,t)=>{this.accountPassword=t,null!==this.accountPasswordTimer&&clearTimeout(this.accountPasswordTimer),this.accountPasswordTimer=setTimeout(()=>{this.accountPassword=null,this.accountPasswordTimer=null},3e5),await x.l(e),await this.postLoginSetup(),Oe.instance.stop(ke.LOGIN),Oe.instance.stop(ke.REGISTER)}),a()(this,"onCompleteSecurityE2eSetupFinished",()=>{this.onLoggedIn()}),this.state={view:Ne.LOADING,collapseLhs:!1,hideToSRUsers:!1,syncError:null,resizeNotifier:new V.a,ready:!1},this.loggedInView=Object(r.createRef)(),_.a.put(this.props.config),this.firstSyncComplete=!1,this.firstSyncPromise=Object($.a)(),this.props.config.sync_timeline_limit&&(b.a.opts.initialSyncLimit=this.props.config.sync_timeline_limit),this.screenAfterLogin=this.props.initialScreenAfterLogin,this.screenAfterLogin){const e=this.screenAfterLogin.params||{};if(this.screenAfterLogin.screen.startsWith("room/")&&e.signurl&&e.email){const t=this.screenAfterLogin.screen.substring("room/".length);he.a.instance.storeInvite(t,e)}}this.prevWindowWidth=Te.b.instance.windowWidth||1e3,Te.b.instance.on(Te.a.Resize,this.handleResize),this.pageChanging=!1,C.a.tint(),this.state.resizeNotifier.on("middlePanelResized",this.dispatchTimelineResize),x.g()&&x.h(),this.accountPassword=null,this.accountPasswordTimer=null,this.dispatcherRef=E.a.register(this.onAction),this.themeWatcher=new G.a,this.fontWatcher=new q.a,this.themeWatcher.start(),this.fontWatcher.start(),this.focusComposer=!1,this.subTitleStatus="",this.onAliasClick&&(I.a.onAliasClick=this.onAliasClick),this.onUserClick&&(I.a.onUserClick=this.onUserClick),this.onGroupClick&&(I.a.onGroupClick=this.onGroupClick),x.g()||x.a(this.props.realQueryParams,this.props.defaultDeviceDisplayName,this.getFragmentAfterLogin()).then(async e=>{var t;if(null!==(t=this.props.realQueryParams)&&void 0!==t&&t.loginToken&&this.props.onTokenLoginCompleted(),e)return this.tokenLogin=!0,await x.k({ignoreGuest:!0}),this.postLoginSetup();const s=this.screenAfterLogin?this.screenAfterLogin.screen:null;if("login"!==s&&"register"!==s&&"forgot_password"!==s)return this.loadSession();this.showScreenAfterLogin()}),U.b.getValue("analyticsOptIn")&&h.a.enable(),m.a.instance.enable(!0)}async postLoginSetup(){const e=b.a.get(),t=e.isCryptoEnabled();t||this.onLoggedIn();const s=[this.firstSyncPromise.promise];if(t&&s.push(e.downloadKeys([e.getUserId()])),this.setState({pendingInitialSync:!0}),await Promise.all(s),!t)return void this.setState({pendingInitialSync:!1});e.getStoredCrossSigningForUser(e.getUserId())?!1===Ce.a.SHOW_ENCRYPTION_SETUP_UI?this.onLoggedIn():this.setStateForNewView({view:Ne.COMPLETE_SECURITY}):await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing")?this.setStateForNewView({view:Ne.E2E_SETUP}):this.onLoggedIn(),this.setState({pendingInitialSync:!1})}UNSAFE_componentWillUpdate(e,t){this.shouldTrackPageChange(this.state,t)&&this.startPageChangeTimer()}componentDidUpdate(e,t){if(this.shouldTrackPageChange(t,this.state)){const e=this.stopPageChangeTimer();h.a.trackPageChange(e),m.a.instance.trackPageChange(e)}this.focusComposer&&(E.a.fire(J.a.FocusComposer),this.focusComposer=!1)}componentWillUnmount(){x.n(),E.a.unregister(this.dispatcherRef),this.themeWatcher.stop(),this.fontWatcher.stop(),Te.b.destroy(),this.state.resizeNotifier.removeListener("middlePanelResized",this.dispatchTimelineResize),null!==this.accountPasswordTimer&&clearTimeout(this.accountPasswordTimer)}getFallbackHsUrl(){return this.props.serverConfig&&this.props.serverConfig.isDefault?this.props.config.fallback_hs_url:null}getServerProperties(){let e=this.state.serverConfig;return e||(e=this.props.serverConfig),e||(e=_.a.get().validated_server_config),{serverConfig:e}}loadSession(){return Promise.resolve().then(()=>x.h({fragmentQueryParams:this.props.startingFragmentQueryParams,enableGuest:this.props.enableGuest,guestHsUrl:this.getServerProperties().serverConfig.hsUrl,guestIsUrl:this.getServerProperties().serverConfig.isUrl,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName})).then(e=>{e?U.b.getValue("analyticsOptIn")&&m.a.instance.enable(!1):he.a.instance.pickBestInvite()?E.a.dispatch({action:"start_registration"}):E.a.dispatch({action:"view_welcome_page"})})}startPageChangeTimer(){Oe.instance.start(ke.PAGE_CHANGE)}stopPageChangeTimer(){const e=Oe.instance;e.stop(ke.PAGE_CHANGE);const t=e.getEntries({name:ke.PAGE_CHANGE}).pop();return t?t.duration:null}shouldTrackPageChange(e,t){return e.currentRoomId!==t.currentRoomId||e.view!==t.view||e.page_type!==t.page_type}setStateForNewView(e){if(void 0===e.view)throw new Error("setStateForNewView with no view!");const t={currentUserId:null,justRegistered:!1};Object.assign(t,e),this.setState(t)}setPage(e){this.setState({page_type:e})}async startRegistration(e){const t={view:Ne.REGISTER};e.client_secret&&e.session_id&&e.hs_url&&e.is_url&&e.sid&&(t.serverConfig=await K.b.validateServerConfigWithStaticUrls(e.hs_url,e.is_url),t.register_client_secret=e.client_secret,t.register_session_id=e.session_id,t.register_id_sid=e.sid),this.setStateForNewView(t),L.a.isLogin=!0,this.themeWatcher.recheck(),this.notifyNewScreen("register")}viewRoom(e){this.focusComposer=!0,e.room_alias?console.log(`Switching to room alias ${e.room_alias} at event `+e.event_id):console.log(`Switching to room id ${e.room_id} at event `+e.event_id);let t=Promise.resolve(null);if(!this.firstSyncComplete){if(!this.firstSyncPromise)return void console.warn("Cannot view a room before first sync. room_id:",e.room_id);t=this.firstSyncPromise.promise}return t.then(()=>{let t=e.room_alias||e.room_id;const s=b.a.get().getRoom(e.room_id);if(s){s.decryptAllEvents();const e=R.a(s);e&&(t=e,Object(H.b)(e,s.roomId)),localStorage&&localStorage.setItem("mx_last_room_id",s.roomId)}const n="#"===t[0]&&e.room_id===this.state.currentRoomId;e.event_id&&e.highlighted&&(t+="/"+e.event_id),this.setState({view:Ne.LOGGED_IN,currentRoomId:e.room_id||null,page_type:D.a.RoomView,threepidInvite:e.threepid_invite,roomOobData:e.oob_data,ready:!0,roomJustCreatedOpts:e.justCreatedOpts},()=>{this.notifyNewScreen("room/"+t,n)})})}async viewGroup(e){const t=e.group_id;if(!this.firstSyncComplete){if(!this.firstSyncPromise)return void console.warn("Cannot view a group before first sync. group_id:",t);await this.firstSyncPromise.promise}this.setState({view:Ne.LOGGED_IN,currentGroupId:t,currentGroupIsNew:e.group_is_new}),this.setPage(D.a.GroupView),this.notifyNewScreen("group/"+t)}viewSomethingBehindModal(){this.state.view===Ne.LOGGED_IN?this.state.currentGroupId||this.state.currentRoomId||this.viewHome():this.viewWelcome()}viewWelcome(){if(Object(ye.b)(_.a.get()))return this.viewLogin();this.setStateForNewView({view:Ne.WELCOME}),this.notifyNewScreen("welcome"),L.a.isLogin=!0,this.themeWatcher.recheck()}viewLogin(e){this.setStateForNewView(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?je(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):je(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({view:Ne.LOGIN},e)),this.notifyNewScreen("login"),L.a.isLogin=!0,this.themeWatcher.recheck()}viewHome(e=!1){this.setStateForNewView({view:Ne.LOGGED_IN,justRegistered:e}),this.setPage(D.a.HomePage),this.notifyNewScreen("home"),L.a.isLogin=!1,this.themeWatcher.recheck()}viewUser(e,t){(this.firstSyncPromise?this.firstSyncPromise.promise:Promise.resolve()).then(()=>{"chat"!==t?(this.notifyNewScreen("user/"+e),this.setState({currentUserId:e}),this.setPage(D.a.UserView)):this.chatCreateOrReuse(e)})}async createRoom(e=!1,t){const s=pe.a.instance.getSelectedCommunityId();if(s&&!pe.a.instance.isAdminOf(s))return void w.a.createTrackedDialog("Pre-failure to create room","",ce.a,{title:Object(M.a)("Cannot create rooms in this community"),description:Object(M.a)("You do not have permission to create rooms in this community.")});const n=k.getComponent("dialogs.CreateRoomDialog"),i=w.a.createTrackedDialog("Create Room","",n,{defaultPublic:e,defaultName:t}),[o,a]=await i.finished;o&&Object(A.b)(a)}chatCreateOrReuse(e){if(b.a.get().isGuest())return e!==this.props.config.welcomeUserId&&E.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"view_start_chat_or_reuse",user_id:e}}),void E.a.dispatch({action:"require_registration",go_welcome_on_cancel:!0,screen_after:{screen:"user/"+this.props.config.welcomeUserId,params:{action:"chat"}}});const t=b.a.get(),s=new W.a(t).getDMRoomsForUserId(e);s.length>0?E.a.dispatch({action:"view_room",room_id:s[0]}):E.a.dispatch({action:"start_chat",user_id:e})}leaveRoomWarnings(e){const t=b.a.get().getRoom(e),s=U.b.getValue("feature_spaces")&&(null==t?void 0:t.isSpaceRoom()),n=[];if(1===t.currentState.getJoinedMemberCount())return n.push(c.a.createElement("span",{className:"warning",key:"only_member_warning"}," ",Object(M.a)("You are the only person here. If you leave, no one will be able to join in the future, including you."))),n;const i=t.currentState.getStateEvents("m.room.join_rules","");if(i){"public"!==i.getContent().join_rule&&n.push(c.a.createElement("span",{className:"warning",key:"non_public_warning"}," ",s?Object(M.a)("This space is not public. You will not be able to rejoin without an invite."):Object(M.a)("This room is not public. You will not be able to rejoin without an invite.")))}return n}leaveRoom(e){const t=k.getComponent("dialogs.QuestionDialog"),s=b.a.get().getRoom(e),n=this.leaveRoomWarnings(e),i=U.b.getValue("feature_spaces")&&(null==s?void 0:s.isSpaceRoom());w.a.createTrackedDialog(i?"Leave space":"Leave room","",t,{title:i?Object(M.a)("Leave space"):Object(M.a)("Leave room"),description:c.a.createElement("span",null,i?Object(M.a)("Are you sure you want to leave the space '%(spaceName)s'?",{spaceName:s.name}):Object(M.a)("Are you sure you want to leave the room '%(roomName)s'?",{roomName:s.name}),n),button:Object(M.a)("Leave"),onFinished:t=>{if(t){const t=Object(de.d)(e),s=k.getComponent("elements.Spinner"),n=w.a.createDialog(s,null,"mx_Dialog_spinner");t.finally(()=>n.close()),E.a.dispatch({action:"after_leave_room",room_id:e})}}})}forgetRoom(e){const t=b.a.get().getRoom(e);b.a.get().forget(e).then(()=>{this.state.currentRoomId===e&&E.a.dispatch({action:"view_home_page"}),Se.b.instance.manualRoomUpdate(t,we.c.RoomRemoved)}).catch(e=>{const t=e.errcode||Object(M.b)("unknown error code");w.a.createTrackedDialog("Failed to forget room","",ce.a,{title:Object(M.a)("Failed to forget room %(errCode)s",{errCode:t}),description:e&&e.message?e.message:Object(M.a)("Operation failed")})})}async startWelcomeUserChat(){let e;e=this.firstSyncComplete?Promise.resolve():this.firstSyncPromise.promise,await e;if(0===W.a.shared().getDMRoomsForUserId(this.props.config.welcomeUserId).length){const e=await Object(A.b)({dmUserId:this.props.config.welcomeUserId,andView:!this.state.currentRoomId,spinner:!1}),t=e=>{"m.direct"===e.getType()&&e.getContent()&&e.getContent()[this.props.config.welcomeUserId]&&(b.a.get().store.save(!0),b.a.get().removeListener("accountData",t))};return b.a.get().on("accountData",t),e}return null}async onLoggedIn(){if(L.a.isLogin=!1,this.themeWatcher.recheck(),this.setStateForNewView({view:Ne.LOGGED_IN}),this.screenAfterLogin&&this.screenAfterLogin.screen)this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=null;else if(b.a.currentUserIsJustRegistered())if(b.a.setJustRegisteredUserId(null),this.props.config.welcomeUserId&&Object(M.d)().startsWith("en")){null===await this.startWelcomeUserChat()&&E.a.dispatch({action:"view_home_page",justRegistered:!0})}else if(he.a.instance.pickBestInvite()){const e=he.a.instance.pickBestInvite(),t=he.a.instance.translateToWireFormat(e);this.showScreen("room/"+e.roomId,t)}else E.a.dispatch({action:"view_home_page",justRegistered:!0});else this.showScreenAfterLogin();var e;(Y.g(),await Object($.c)(30),U.b.getValue("showCookieBar")&&(h.a.canEnable()||m.a.instance.canEnable()))&&(e=>{const t=_.a.get().brand;z.a.sharedInstance().addOrReplaceToast({key:"analytics",title:Object(M.a)("Help us improve %(brand)s",{brand:t}),props:{description:Object(M.a)("Send <UsageDataLink>anonymous usage data</UsageDataLink> which helps us improve %(brand)s. This will use a <PolicyLink>cookie</PolicyLink>.",{brand:t},{UsageDataLink:e=>c.a.createElement(Q.a,{kind:"link",onClick:te},e),PolicyLink:t=>e?c.a.createElement("a",{target:"_blank",href:e},t):t}),acceptLabel:Object(M.a)("Yes"),onAccept:Z,rejectLabel:Object(M.a)("No"),onReject:ee},component:X.a,className:"mx_AnalyticsToast",priority:10})})(null===(e=this.props.config.piwik)||void 0===e?void 0:e.policyUrl);_.a.get().mobileGuideToast&&(()=>{const e=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,t=/Android/.test(navigator.userAgent);(e||t)&&(document.cookie.includes("element_mobile_redirect_to_guide=false")||z.a.sharedInstance().addOrReplaceToast({key:"mobileguide",title:Object(M.a)("Use app for a better experience"),props:{description:Object(M.a)("Element Web is experimental on mobile. For a better experience and the latest features, use our free native app."),acceptLabel:Object(M.a)("Use app"),onAccept:ve,rejectLabel:Object(M.a)("Dismiss"),onReject:fe},component:X.a,priority:99}))})(),U.b.getValue("scShowUpdateAnnouncementRoomToast")&&y.a.get().canSelfUpdate().then(e=>{e||_.a.get().sc_update_announcement_room&&z.a.sharedInstance().addOrReplaceToast({key:"scupdateannouncementroom",title:Object(M.a)("Update notifications"),props:{description:Object(M.a)("Do you want to join a room notifying you about new releases? This is especially useful if your platform doesn't support automatic updates for SchildiChat (e.g. Windows and macOS)."),acceptLabel:Object(M.a)("Join"),onAccept:ie,rejectLabel:Object(M.a)("Don't ask again"),onReject:oe},component:X.a,priority:20})}).catch(e=>{console.error("Error getting vector version: ",e)})}showScreenAfterLogin(){this.screenAfterLogin&&this.screenAfterLogin.screen?(this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=null):localStorage&&localStorage.getItem("mx_last_room_id")?this.viewLastRoom():b.a.get().isGuest()?E.a.dispatch({action:"view_welcome_page"}):E.a.dispatch({action:"view_home_page"})}viewLastRoom(){E.a.dispatch({action:"view_room",room_id:localStorage.getItem("mx_last_room_id")})}onLoggedOut(){this.viewLogin({ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle()}onSoftLogout(){this.notifyNewScreen("soft_logout"),this.setStateForNewView({view:Ne.SOFT_LOGOUT,ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle()}onWillStartClient(){this.firstSyncComplete=!1,this.firstSyncPromise=Object($.a)();const e=b.a.get();e.setCanResetTimelineCallback(e=>(console.log("Request to reset timeline in room ",e," viewing:",this.state.currentRoomId),e!==this.state.currentRoomId||(!this.loggedInView.current||this.loggedInView.current.canResetTimelineInRoom(e)))),e.on("sync",(e,t,s)=>{E.a.dispatch({action:"sync_state",prevState:t,state:e}),"ERROR"===e||"RECONNECTING"===e?(s.error instanceof d.b&&x.d(s.error),this.setState({syncError:s.error||!0})):this.state.syncError&&this.setState({syncError:null}),this.updateStatusIndicator(e,t),"SYNCING"===e&&"SYNCING"===t||(console.info("MatrixClient sync state => %s",e),"PREPARED"===e&&(this.firstSyncComplete=!0,this.firstSyncPromise.resolve(),S.default.shouldShowPrompt()&&!b.a.userRegisteredWithinLastHours(24)&&Object(re.b)(!1),E.a.fire(J.a.FocusComposer),this.setState({ready:!0})))}),e.on("Session.logged_out",(function(e){if(!x.f()){if(w.a.closeCurrentModal("Session.logged_out"),401===e.httpStatus&&e.data&&e.data.soft_logout)return console.warn("Soft logout issued by server - avoiding data deletion"),void x.m();w.a.createTrackedDialog("Signed out","",ce.a,{title:Object(M.a)("Signed Out"),description:Object(M.a)("For security, this session has been signed out. Please sign in again.")}),E.a.dispatch({action:"logout"})}})),e.on("no_consent",(function(t,s){const n=k.getComponent("dialogs.QuestionDialog");w.a.createTrackedDialog("No Consent Dialog","",n,{title:Object(M.a)("Terms and Conditions"),description:c.a.createElement("div",null,c.a.createElement("p",null," ",Object(M.a)("To continue using the %(homeserverDomain)s homeserver you must review and agree to our terms and conditions.",{homeserverDomain:e.getDomain()}))),button:Object(M.a)("Review terms and conditions"),cancelButton:Object(M.a)("Dismiss"),onFinished:e=>{if(e){window.open(s,"_blank").opener=null}}},null,!0)}));const t=new f((e,t)=>{h.a.trackEvent("E2E","Decryption failure",t,String(e)),m.a.instance.track("decryption_failure",{errorCode:t},null,{sum:e})},e=>{switch(e){case"MEGOLM_UNKNOWN_INBOUND_SESSION_ID":return"olm_keys_not_sent_error";case"OLM_UNKNOWN_MESSAGE_INDEX":return"olm_index_error";case void 0:return"unexpected_error";default:return"unspecified_error"}});t.start(),e.on("Session.logged_out",()=>t.stop()),e.on("Event.decrypted",(e,s)=>t.eventDecrypted(e,s)),e.on("Room",e=>{if(b.a.get().isCryptoEnabled()){const t=U.b.getValueAt(ne.a.ROOM_DEVICE,"blacklistUnverifiedDevices",e.roomId,!0);e.setBlacklistUnverifiedDevices(t)}}),e.on("crypto.warning",e=>{switch(e){case"CRYPTO_WARNING_OLD_VERSION_DETECTED":w.a.createTrackedDialog("Crypto migrated","",ce.a,{title:Object(M.a)("Old cryptography data detected"),description:Object(M.a)("Data from an older version of %(brand)s has been detected. This will have caused end-to-end cryptography to malfunction in the older version. End-to-end encrypted messages exchanged recently whilst using the older version may not be decryptable in this version. This may also cause messages exchanged with this version to fail. If you experience problems, log out and back in again. To retain message history, export and re-import your keys.",{brand:_.a.get().brand})})}}),e.on("crypto.keyBackupFailed",async e=>{let t,n;if(b.a.get().getKeyBackupEnabled())t=!0;else try{n=await b.a.get().getKeyBackupVersion(),null!==n&&(t=!0)}catch(e){return void console.error("Saw key backup error but failed to check backup version!",e)}t?w.a.createTrackedDialogAsync("New Recovery Method","New Recovery Method",s.e(31).then(s.bind(null,1325)),{newVersionInfo:n}):w.a.createTrackedDialogAsync("Recovery Method Removed","Recovery Method Removed",s.e(32).then(s.bind(null,1326)))}),e.on("crypto.keySignatureUploadFailure",(e,t,s)=>{const n=k.getComponent("views.dialogs.KeySignatureUploadFailedDialog");w.a.createTrackedDialog("Failed to upload key signatures","Failed to upload key signatures",n,{failures:e,source:t,continuation:s})}),e.on("crypto.verification.request",e=>{if(e.verifier){const t=k.getComponent("views.dialogs.IncomingSasDialog");w.a.createTrackedDialog("Incoming Verification","",t,{verifier:e.verifier},null,!1,!0)}else e.pending&&z.a.sharedInstance().addOrReplaceToast({key:"verifreq_"+e.channel.transactionId,title:Object(M.a)("Verification requested"),icon:"verification",props:{request:e},component:k.getComponent("toasts.VerificationRequestToast"),priority:90})});const n=U.b.getValue("roomColor");C.a.tint(n.primary_color,n.secondary_color)}onClientStarted(){const e=b.a.get();if(e.isCryptoEnabled()){const t=U.b.getValueAt(ne.a.DEVICE,"blacklistUnverifiedDevices");e.setGlobalBlacklistUnverifiedDevices(t),e.setGlobalErrorOnUnknownDevices(!1)}}showScreen(e,t){const s=b.a.get();if(!s||s.isGuest()||!Pe.includes(e))if("register"===e)E.a.dispatch({action:"start_registration",params:t}),Oe.instance.start(ke.REGISTER);else if("login"===e)E.a.dispatch({action:"start_login",params:t}),Oe.instance.start(ke.LOGIN);else if("forgot_password"===e)E.a.dispatch({action:"start_password_recovery",params:t});else if("soft_logout"===e)s.getUserId()&&!x.g()?this.viewLastRoom():E.a.dispatch({action:"start_login",params:t});else if("new"===e)E.a.dispatch({action:"view_create_room"});else if("settings"===e)E.a.fire(J.a.ViewUserSettings);else if("welcome"===e)E.a.dispatch({action:"view_welcome_page"});else if("home"===e)E.a.dispatch({action:"view_home_page"});else if("start"===e)this.showScreen("home"),E.a.dispatch({action:"require_registration"});else if("directory"===e)this.state.view===Ne.WELCOME&&m.a.instance.track("onboarding_room_directory"),E.a.fire(J.a.ViewRoomDirectory);else if("start_sso"===e||"start_cas"===e){let t=b.a.get();if(!t){const{hsUrl:e,isUrl:s}=this.props.serverConfig;t=Object(l.createClient)({baseUrl:e,idBaseUrl:s})}const s="start_sso"===e?"sso":"cas";y.a.get().startSingleSignOn(t,s,this.getFragmentAfterLogin())}else if("groups"===e){if(U.b.getValue("feature_spaces"))return void E.a.dispatch({action:"view_home_page"});E.a.dispatch({action:"view_my_groups"})}else if(0===e.indexOf("room/")){var n,i,o;const s=e.substring(5),a=s.indexOf(":")+1;let r=s.length;s.substring(a).indexOf("/")>-1&&(r=a+s.substring(a).indexOf("/"));const c=s.substring(0,r);let l,d=s.substring(r+1);if(d||(d=void 0),t.signurl&&t.email&&(l=he.a.instance.storeInvite(c,t)),!l){l=he.a.instance.getInvites().find(e=>e.roomId===c)}let u=[];t.via&&(u="string"==typeof t.via?[t.via]:t.via);const h={action:"view_room",event_id:d,via_servers:u,highlighted:Boolean(d),threepid_invite:l,oob_data:{name:null===(n=l)||void 0===n?void 0:n.roomName,avatarUrl:null===(i=l)||void 0===i?void 0:i.roomAvatarUrl,inviterName:null===(o=l)||void 0===o?void 0:o.inviterName},room_alias:void 0,room_id:void 0};"#"===c[0]?h.room_alias=c:h.room_id=c,E.a.dispatch(h)}else if(0===e.indexOf("user/")){const s=e.substring(5);E.a.dispatch({action:"view_user_info",userId:s,subAction:t.action})}else if(0===e.indexOf("group/")){if(U.b.getValue("feature_spaces"))return void E.a.dispatch({action:"view_home_page"});const t=e.substring(6);E.a.dispatch({action:"view_group",group_id:t})}else console.info("Ignoring showScreen for '%s'",e);else E.a.dispatch({action:"view_home_page"})}notifyNewScreen(e,t=!1){this.props.onNewScreen&&this.props.onNewScreen(e,t),this.setPageSubtitle()}onAliasClick(e,t){e.preventDefault(),E.a.dispatch({action:"view_room",room_alias:t})}onUserClick(e,t){e.preventDefault();const s=new u.a(null,t);s&&E.a.dispatch({action:J.a.ViewUser,member:s})}onGroupClick(e,t){e.preventDefault(),E.a.dispatch({action:"view_group",group_id:t})}onLogoutClick(e){E.a.dispatch({action:"logout"}),e.stopPropagation(),e.preventDefault()}dispatchTimelineResize(){E.a.dispatch({action:"timeline_resize"})}onRoomCreated(e){E.a.dispatch({action:"view_room",room_id:e})}onRegistered(e){return x.l(e)}onSendEvent(e,t){const s=b.a.get();s?s.sendEvent(e,t.getType(),t.getContent()).then(()=>{E.a.dispatch({action:"message_sent"})},e=>{E.a.dispatch({action:"message_send_failed"})}):E.a.dispatch({action:"message_send_failed"})}setPageSubtitle(e=""){if(this.state.currentRoomId){const t=b.a.get(),s=t&&t.getRoom(this.state.currentRoomId);s&&(e=`${this.subTitleStatus} | ${s.name} ${e}`)}else e=`${this.subTitleStatus} ${e}`;const t=`${_.a.get().brand} ${e}`;document.title!==t&&(document.title=t)}updateStatusIndicator(e,t){const s=le.a.instance.globalState.numUnreadStates;y.a.get()&&(y.a.get().setErrorStatus("ERROR"===e),y.a.get().setNotificationCount(s)),this.subTitleStatus="","ERROR"===e&&(this.subTitleStatus+=`[${Object(M.a)("Offline")}] `),s>0&&(this.subTitleStatus+=`[${s}]`),this.setPageSubtitle()}onCloseAllSettings(){E.a.dispatch({action:"close_settings"})}getFragmentAfterLogin(){let e="";const t=this.props.initialScreenAfterLogin;return t&&!["welcome","login","register","start_sso","start_cas"].includes(t.screen)&&(e="/"+t.screen),e}render(){const e=this.getFragmentAfterLogin();let t=null;if(this.state.view===Ne.LOADING){const e=k.getComponent("elements.Spinner");t=c.a.createElement("div",{className:"mx_MatrixChat_splash"},c.a.createElement(e,null))}else if(this.state.view===Ne.COMPLETE_SECURITY){const e=k.getComponent("structures.auth.CompleteSecurity");t=c.a.createElement(e,{onFinished:this.onCompleteSecurityE2eSetupFinished})}else if(this.state.view===Ne.E2E_SETUP){const e=k.getComponent("structures.auth.E2eSetup");t=c.a.createElement(e,{onFinished:this.onCompleteSecurityE2eSetupFinished,accountPassword:this.accountPassword,tokenLogin:!!this.tokenLogin})}else if(this.state.view===Ne.LOGGED_IN){const e=this.state.syncError&&this.state.syncError instanceof d.b;if(this.state.ready&&this.state.page_type&&!e){const e=k.getComponent("structures.LoggedInView");t=c.a.createElement(e,i()({},this.props,this.state,{ref:this.loggedInView,matrixClient:b.a.get(),onRoomCreated:this.onRoomCreated,onCloseAllSettings:this.onCloseAllSettings,onRegistered:this.onRegistered,currentRoomId:this.state.currentRoomId}))}else{const s=k.getComponent("elements.Spinner");let n;this.state.syncError&&!e&&(n=c.a.createElement("div",{className:"mx_MatrixChat_syncError"},Object(B.b)(this.state.syncError))),t=c.a.createElement("div",{className:"mx_MatrixChat_splash"},n,c.a.createElement(s,null),c.a.createElement("a",{href:"#",className:"mx_MatrixChat_splashButtons",onClick:this.onLogoutClick},Object(M.a)("Logout")))}}else if(this.state.view===Ne.WELCOME){const e=k.getComponent("auth.Welcome");t=c.a.createElement(e,null)}else if(this.state.view===Ne.REGISTER&&U.b.getValue(me.a.Registration)){var s;const n=k.getComponent("structures.auth.Registration"),o=null===(s=he.a.instance.pickBestInvite())||void 0===s?void 0:s.toEmail;t=c.a.createElement(n,i()({clientSecret:this.state.register_client_secret,sessionId:this.state.register_session_id,idSid:this.state.register_id_sid,email:o,brand:this.props.config.brand,makeRegistrationUrl:this.makeRegistrationUrl,onLoggedIn:this.onRegisterFlowComplete,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,fragmentAfterLogin:e},this.getServerProperties()))}else if(this.state.view===Ne.FORGOT_PASSWORD&&U.b.getValue(me.a.PasswordReset)){const e=k.getComponent("structures.auth.ForgotPassword");t=c.a.createElement(e,i()({onComplete:this.onLoginClick,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange},this.getServerProperties()))}else if(this.state.view===Ne.LOGIN){const s=U.b.getValue(me.a.PasswordReset),n=k.getComponent("structures.auth.Login");t=c.a.createElement(n,i()({isSyncing:this.state.pendingInitialSync,onLoggedIn:this.onUserCompletedLoginFlow,onRegisterClick:this.onRegisterClick,fallbackHsUrl:this.getFallbackHsUrl(),defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,onForgotPasswordClick:s?this.onForgotPasswordClick:void 0,onServerConfigChange:this.onServerConfigChange,fragmentAfterLogin:e,defaultUsername:this.props.startingFragmentQueryParams.defaultUsername},this.getServerProperties()))}else if(this.state.view===Ne.SOFT_LOGOUT){const s=k.getComponent("structures.auth.SoftLogout");t=c.a.createElement(s,{realQueryParams:this.props.realQueryParams,onTokenLoginCompleted:this.props.onTokenLoginCompleted,fragmentAfterLogin:e})}else console.error("Unknown view "+this.state.view);const n=k.getComponent("elements.ErrorBoundary");return c.a.createElement(n,null,t)}},a()(Ie,"displayName","MatrixChat"),a()(Ie,"defaultProps",{realQueryParams:{},startingFragmentQueryParams:{},config:{},onTokenLoginCompleted:()=>{}}),Re=xe))||Re;function Me(){const e=window.matrixChat;return e&&e.state.view===Ne.LOGGED_IN}},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n=s(18),i=s.n(n),o=s(138),a=s(121);var r=s(94),c=s(604),l=s(99),d=s(605),u=s(745);const h={};var m=s(606),p=s(161),g=s(110),v=s(207),f=s(286),b=s(96),y=s(122);class _ extends o.WidgetDriver{constructor(e,t,s,n){if(super(),this.forWidget=t,this.forWidgetKind=s,this.inRoomId=n,i()(this,"allowedCapabilities",void 0),this.allowedCapabilities=new Set([...e,o.MatrixCapabilities.Screenshots]),p.a.JITSI.matches(this.forWidget.type)&&s===o.WidgetKind.Room)this.allowedCapabilities.add(o.MatrixCapabilities.AlwaysOnScreen);else if(p.a.STICKERPICKER.matches(this.forWidget.type)&&s===o.WidgetKind.Account){const e=o.WidgetEventCapability.forRoomEvent(o.EventDirection.Send,g.a.Sticker).raw;this.allowedCapabilities.add(o.MatrixCapabilities.StickerSending),this.allowedCapabilities.add(e),this.allowedCapabilities.add("visibility")}}async validateCapabilities(e){const t=(s=e,n=this.allowedCapabilities,Object(a.a)(Array.from(s),Array.from(n)));var s,n;const i=new Set(t.removed),o=new Set(this.allowedCapabilities);if(Object(u.b)(this.forWidget).forEach(e=>{o.add(e),i.delete(e)}),h.preapproveCapabilities){const t=await h.preapproveCapabilities(this.forWidget,e);t&&t.forEach(e=>{o.add(e),i.delete(e)})}if(i.size>0)try{const[e]=await l.a.createTrackedDialog("Approve Widget Caps","",u.a,{requestedCapabilities:i,widget:this.forWidget,widgetKind:this.forWidgetKind}).finished;(e.approved||[]).forEach(e=>o.add(e))}catch(e){console.error("Non-fatal error getting capabilities: ",e)}return new Set(function(e,t){return Object(a.k)(Array.from(e),Array.from(t))}(o,e))}async sendEvent(e,t,s=null){const n=r.a.get(),i=c.a.activeRoomId;if(!n||!i)throw new Error("Not in a room or not attached to a client");let o=null;return null!==s?o=await n.sendStateEvent(i,e,t,s):(o=await n.sendEvent(i,e,t),e===g.a.RoomMessage&&v.CHAT_EFFECTS.forEach(e=>{Object(f.containsEmoji)(t,e.emojis)&&b.a.dispatch({action:"effects."+e.command})})),{roomId:i,eventId:o.event_id}}async readRoomEvents(e,t,s){s=s>0?Math.min(s,25):25;const n=r.a.get(),i=c.a.activeRoomId,o=n.getRoom(i);if(!n||!i||!o)throw new Error("Not in a room or not attached to a client");const a=[],l=o.getLiveTimeline().getEvents();for(let n=l.length-1;n>0&&!(a.length>=s);n--){const s=l[n];s.getType()===e&&(e===g.a.RoomMessage&&t&&t!==s.getContent().msgtype||a.push(s))}return a.map(e=>e.event)}async readStateEvents(e,t,s){s=s>0?Math.min(s,100):100;const n=r.a.get(),i=c.a.activeRoomId,o=n.getRoom(i);if(!n||!i||!o)throw new Error("Not in a room or not attached to a client");const a=[],l=o.currentState.events.get(e);if(l)if(""===t||t){const e=l.get(t);e&&a.push(e)}else a.push(...Array.from(l.values()));return a.slice(0,s).map(e=>e.event)}async askOpenID(e){const t=m.b.instance.getOIDCState(this.forWidget,this.forWidgetKind,this.inRoomId),s=()=>r.a.get().getOpenIdToken();return t===m.a.Denied?e.update({state:o.OpenIDRequestState.Blocked}):t===m.a.Allowed?e.update({state:o.OpenIDRequestState.Allowed,token:await s()}):(e.update({state:o.OpenIDRequestState.PendingUserConfirmation}),void l.a.createTrackedDialog("OpenID widget permissions","",d.a,{widget:this.forWidget,widgetKind:this.forWidgetKind,inRoomId:this.inRoomId,onFinished:async t=>t?e.update({state:o.OpenIDRequestState.Allowed,token:await s()}):e.update({state:o.OpenIDRequestState.Blocked})}))}async navigate(e){const t=Object(y.l)(e);if(!t||t===e)throw new Error("Failed to transform URI");window.location.hash=t}}},function(e,t,s){"use strict";s.d(t,"c",(function(){return r.d})),s.d(t,"a",(function(){return r.a})),s.d(t,"b",(function(){return r.c}));var n=s(0),i=s(1),o=s(139),a=s(313),r=s(314);const c=a.a.DeviceVerification;function l(e){Object(i.y)(this,r.e,e),this._sessionPrepared=!1,this._prepPromise=null}function d(e){Object(i.y)(this,r.b,e)}i.r(l,r.e),l.prototype._ensureSession=function(e){if(this._prepPromise)return this._prepPromise;if(this._sessionPrepared)return Promise.resolve();const t=this;return this._prepPromise=t._crypto.downloadKeys(e).then((function(s){return t._crypto.ensureOlmSessionsForUsers(e)})).then((function(){t._sessionPrepared=!0})).finally((function(){t._prepPromise=null})),this._prepPromise},l.prototype.encryptMessage=async function(e,t,s){const n=(await e.getEncryptionTargetMembers()).map((function(e){return e.userId})),i=this;await this._ensureSession(n);const a={room_id:e.roomId,type:t,content:s},r={algorithm:o.OLM_ALGORITHM,sender_key:i._olmDevice.deviceCurve25519Key,ciphertext:{}},l=[];for(let e=0;e<n.length;++e){const t=n[e],s=i._crypto.getStoredDevicesForUser(t);for(let e=0;e<s.length;++e){const n=s[e];n.getIdentityKey()!=i._olmDevice.deviceCurve25519Key&&(n.verified!=c.BLOCKED&&l.push(o.encryptMessageForDevice(r.ciphertext,i._userId,i._deviceId,i._olmDevice,t,n,a)))}}return await Promise.all(l).then(()=>r)},i.r(d,r.b),d.prototype.decryptEvent=async function(e){const t=e.getWireContent(),s=t.sender_key,n=t.ciphertext;if(!n)throw new r.c("OLM_MISSING_CIPHERTEXT","Missing ciphertext");if(!(this._olmDevice.deviceCurve25519Key in n))throw new r.c("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");const i=n[this._olmDevice.deviceCurve25519Key];let o;try{o=await this._decryptMessage(s,i)}catch(e){throw new r.c("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:s,err:e})}const a=JSON.parse(o);if(a.recipient!=this._userId)throw new r.c("OLM_BAD_RECIPIENT","Message was intented for "+a.recipient);if(a.recipient_keys.ed25519!=this._olmDevice.deviceEd25519Key)throw new r.c("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:a.recipient_keys.ed25519,our_key:this._olmDevice.deviceEd25519Key});if(a.sender!=e.getSender())throw new r.c("OLM_FORWARDED_MESSAGE","Message forwarded from "+a.sender,{reported_sender:e.getSender()});if(a.room_id!==e.getRoomId())throw new r.c("OLM_BAD_ROOM","Message intended for room "+a.room_id,{reported_room:e.room_id});return{clearEvent:a,senderCurve25519Key:s,claimedEd25519Key:(a.keys||{}).ed25519||null}},d.prototype._decryptMessage=async function(e,t){if(0!==t.type)return this._reallyDecryptMessage(e,t);{const s=this._olmDevice._olmPrekeyPromise.then(()=>this._reallyDecryptMessage(e,t));return this._olmDevice._olmPrekeyPromise=s.catch(()=>{}),await s}},d.prototype._reallyDecryptMessage=async function(e,t){const s=await this._olmDevice.getSessionIdsForDevice(e),i={};for(let o=0;o<s.length;o++){const a=s[o];try{const s=await this._olmDevice.decryptMessage(e,a,t.type,t.body);return n.a.log("Decrypted Olm message from "+e+" with session "+a),s}catch(s){if(await this._olmDevice.matchesSession(e,a,t.type,t.body))throw new Error("Error decrypting prekey message with existing session id "+a+": "+s.message);i[a]=s.message}}if(0!==t.type){if(0===s.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(i))}let o;try{o=await this._olmDevice.createInboundSession(e,t.type,t.body)}catch(e){throw i["(new)"]=e.message,new Error("Error decrypting prekey message: "+JSON.stringify(i))}return n.a.log("created new inbound Olm session ID "+o.session_id+" with "+e),o.payload},Object(r.g)(o.OLM_ALGORITHM,l,d);s(557)},function(e,t,s){"use strict";s.d(t,"b",(function(){return y})),s.d(t,"a",(function(){return _}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(124),c=s(92),l=s(138),d=s(141),u=s(148),h=s(192),m=s(173),p=s(110),g=s(607);class v{static bylineFor(e){return e.isState?e.keyStr?Object(c.a)("with state key %(stateKey)s",{stateKey:e.keyStr}):Object(c.a)("with an empty state key"):null}static for(e,t){if(v.simpleCaps[e]){const s=v.simpleCaps[e];if(s[t])return{primary:Object(c.a)(s[t])};if(s.generic)return{primary:Object(c.a)(s.generic)}}const[s]=l.WidgetEventCapability.findEventCapabilities([e]);if(s){if(!s.isState&&s.eventType===p.a.RoomMessage)return v.forRoomMessageCap(s,t);const e=s.isState?v.stateSendRecvCaps:v.nonStateSendRecvCaps;if(e[s.eventType]){const n=e[s.eventType],i=n[t]||n.generic;if(i&&i[s.direction])return{primary:Object(c.a)(i[s.direction])}}return t===l.WidgetKind.Room?s.direction===l.EventDirection.Send?{primary:Object(c.a)("Send <b>%(eventType)s</b> events as you in this room",{eventType:s.eventType},{b:e=>a.a.createElement("b",null,e)}),byline:v.bylineFor(s)}:{primary:Object(c.a)("See <b>%(eventType)s</b> events posted to this room",{eventType:s.eventType},{b:e=>a.a.createElement("b",null,e)}),byline:v.bylineFor(s)}:s.direction===l.EventDirection.Send?{primary:Object(c.a)("Send <b>%(eventType)s</b> events as you in your active room",{eventType:s.eventType},{b:e=>a.a.createElement("b",null,e)}),byline:v.bylineFor(s)}:{primary:Object(c.a)("See <b>%(eventType)s</b> events posted to your active room",{eventType:s.eventType},{b:e=>a.a.createElement("b",null,e)}),byline:v.bylineFor(s)}}return{primary:Object(c.a)("The <b>%(capability)s</b> capability",{capability:e},{b:e=>a.a.createElement("b",null,e)})}}static forRoomMessageCap(e,t){if(!e.keyStr)return e.direction===l.EventDirection.Send?{primary:t===l.WidgetKind.Room?Object(c.a)("Send messages as you in this room"):Object(c.a)("Send messages as you in your active room")}:{primary:t===l.WidgetKind.Room?Object(c.a)("See messages posted to this room"):Object(c.a)("See messages posted to your active room")};switch(e.keyStr){case p.b.Text:return e.direction===l.EventDirection.Send?{primary:t===l.WidgetKind.Room?Object(c.a)("Send text messages as you in this room"):Object(c.a)("Send text messages as you in your active room")}:{primary:t===l.WidgetKind.Room?Object(c.a)("See text messages posted to this room"):Object(c.a)("See text messages posted to your active room")};case p.b.Emote:return e.direction===l.EventDirection.Send?{primary:t===l.WidgetKind.Room?Object(c.a)("Send emotes as you in this room"):Object(c.a)("Send emotes as you in your active room")}:{primary:t===l.WidgetKind.Room?Object(c.a)("See emotes posted to this room"):Object(c.a)("See emotes posted to your active room")};case p.b.Image:return e.direction===l.EventDirection.Send?{primary:t===l.WidgetKind.Room?Object(c.a)("Send images as you in this room"):Object(c.a)("Send images as you in your active room")}:{primary:t===l.WidgetKind.Room?Object(c.a)("See images posted to this room"):Object(c.a)("See images posted to your active room")};case p.b.Video:return e.direction===l.EventDirection.Send?{primary:t===l.WidgetKind.Room?Object(c.a)("Send videos as you in this room"):Object(c.a)("Send videos as you in your active room")}:{primary:t===l.WidgetKind.Room?Object(c.a)("See videos posted to this room"):Object(c.a)("See videos posted to your active room")};case p.b.File:return e.direction===l.EventDirection.Send?{primary:t===l.WidgetKind.Room?Object(c.a)("Send general files as you in this room"):Object(c.a)("Send general files as you in your active room")}:{primary:t===l.WidgetKind.Room?Object(c.a)("See general files posted to this room"):Object(c.a)("See general files posted to your active room")};default:{let s;return s=e.direction===l.EventDirection.Send?t===l.WidgetKind.Room?Object(c.a)("Send <b>%(msgtype)s</b> messages as you in this room",{msgtype:e.keyStr},{b:e=>a.a.createElement("b",null,e)}):Object(c.a)("Send <b>%(msgtype)s</b> messages as you in your active room",{msgtype:e.keyStr},{b:e=>a.a.createElement("b",null,e)}):t===l.WidgetKind.Room?Object(c.a)("See <b>%(msgtype)s</b> messages posted to this room",{msgtype:e.keyStr},{b:e=>a.a.createElement("b",null,e)}):Object(c.a)("See <b>%(msgtype)s</b> messages posted to your active room",{msgtype:e.keyStr},{b:e=>a.a.createElement("b",null,e)}),{primary:s}}}}}i()(v,"simpleCaps",{[l.MatrixCapabilities.AlwaysOnScreen]:{[l.WidgetKind.Room]:Object(c.b)("Remain on your screen when viewing another room, when running"),generic:Object(c.b)("Remain on your screen while running")},[l.MatrixCapabilities.StickerSending]:{[l.WidgetKind.Room]:Object(c.b)("Send stickers into this room"),generic:Object(c.b)("Send stickers into your active room")},[g.a.CanChangeViewedRoom]:{generic:Object(c.b)("Change which room you're viewing")},[l.MatrixCapabilities.MSC2931Navigate]:{generic:Object(c.b)("Change which room, message, or user you're viewing")}}),i()(v,"stateSendRecvCaps",{[p.a.RoomTopic]:{[l.WidgetKind.Room]:{[l.EventDirection.Send]:Object(c.b)("Change the topic of this room"),[l.EventDirection.Receive]:Object(c.b)("See when the topic changes in this room")},generic:{[l.EventDirection.Send]:Object(c.b)("Change the topic of your active room"),[l.EventDirection.Receive]:Object(c.b)("See when the topic changes in your active room")}},[p.a.RoomName]:{[l.WidgetKind.Room]:{[l.EventDirection.Send]:Object(c.b)("Change the name of this room"),[l.EventDirection.Receive]:Object(c.b)("See when the name changes in this room")},generic:{[l.EventDirection.Send]:Object(c.b)("Change the name of your active room"),[l.EventDirection.Receive]:Object(c.b)("See when the name changes in your active room")}},[p.a.RoomAvatar]:{[l.WidgetKind.Room]:{[l.EventDirection.Send]:Object(c.b)("Change the avatar of this room"),[l.EventDirection.Receive]:Object(c.b)("See when the avatar changes in this room")},generic:{[l.EventDirection.Send]:Object(c.b)("Change the avatar of your active room"),[l.EventDirection.Receive]:Object(c.b)("See when the avatar changes in your active room")}},[p.a.RoomMember]:{[l.WidgetKind.Room]:{[l.EventDirection.Send]:Object(c.b)("Kick, ban, or invite people to this room, and make you leave"),[l.EventDirection.Receive]:Object(c.b)("See when people join, leave, or are invited to this room")},generic:{[l.EventDirection.Send]:Object(c.b)("Kick, ban, or invite people to your active room, and make you leave"),[l.EventDirection.Receive]:Object(c.b)("See when people join, leave, or are invited to your active room")}}}),i()(v,"nonStateSendRecvCaps",{[p.a.Sticker]:{[l.WidgetKind.Room]:{[l.EventDirection.Send]:Object(c.b)("Send stickers to this room as you"),[l.EventDirection.Receive]:Object(c.b)("See when a sticker is posted in this room")},generic:{[l.EventDirection.Send]:Object(c.b)("Send stickers to your active room as you"),[l.EventDirection.Receive]:Object(c.b)("See when anyone posts a sticker to your active room")}}});var f,b=s(93);function y(e){return JSON.parse(localStorage.getItem(`widget_${e.id}_approved_caps`)||"[]")}let _=Object(b.a)("views.dialogs.WidgetCapabilitiesPromptDialog")(f=class extends a.a.PureComponent{constructor(e){super(e),i()(this,"eventPermissionsMap",new Map),i()(this,"onToggle",e=>{const t=Object(d.f)(this.state.booleanStates);t[e]=!t[e],this.setState({booleanStates:t})}),i()(this,"onRememberSelectionChange",e=>{this.setState({rememberSelection:e})}),i()(this,"onSubmit",async e=>{this.closeAndTryRemember(Object.entries(this.state.booleanStates).filter(([e,t])=>t).map(([e])=>e))}),i()(this,"onReject",async e=>{this.closeAndTryRemember([])});l.WidgetEventCapability.findEventCapabilities(this.props.requestedCapabilities).forEach(e=>this.eventPermissionsMap.set(e.raw,e));const t={};this.props.requestedCapabilities.forEach(e=>t[e]=!0),this.state={booleanStates:t,rememberSelection:!0}}closeAndTryRemember(e){var t,s;this.state.rememberSelection&&(t=this.props.widget,s=e,localStorage.setItem(`widget_${t.id}_approved_caps`,JSON.stringify(s))),this.props.onFinished({approved:e})}render(){const e=Object.entries(this.state.booleanStates).map(([e,t],s)=>{const n=v.for(e,this.props.widgetKind),i=n.byline?a.a.createElement("span",{className:"mx_WidgetCapabilitiesPromptDialog_byline"},n.byline):null;return a.a.createElement("div",{className:"mx_WidgetCapabilitiesPromptDialog_cap",key:e+s},a.a.createElement(u.a,{checked:t,onChange:()=>this.onToggle(e)},n.primary),i)});return a.a.createElement(r.a,{className:"mx_WidgetCapabilitiesPromptDialog",onFinished:this.props.onFinished,title:Object(c.a)("Approve widget permissions")},a.a.createElement("form",{onSubmit:this.onSubmit},a.a.createElement("div",{className:"mx_Dialog_content"},a.a.createElement("div",{className:"text-muted"},Object(c.a)("This widget would like to:")),e,a.a.createElement(h.a,{primaryButton:Object(c.a)("Approve"),cancelButton:Object(c.a)("Decline All"),onPrimaryButtonClick:this.onSubmit,onCancel:this.onReject,additive:a.a.createElement(m.a,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:Object(c.a)("Remember my selection for this widget")})}))))}})||f},function(e,t,s){"use strict";s.d(t,"a",(function(){return j}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(97),c=s.n(r),l=s(101),d=s.n(l),u=s(284),h=s(285),m=s(96),p=s(95),g=s(570),v=s(140),f=s(244),b=s(183),y=s(98),_=s(634),E=s(458),S=s(460),w=s(459),C=s(190),k=s(9);var O,R,I,x=s(93),T=s(154);let j=Object(x.a)("views.rooms.AppsDrawer")((I=R=class extends a.a.Component{constructor(e){super(e),i()(this,"onIsResizing",e=>{this.setState({resizingVertical:e}),e||this._relaxResizer()}),i()(this,"_collectResizer",e=>{this._resizeContainer&&this.resizer.detach(),e&&(this.resizer.container=e,this.resizer.attach()),this._resizeContainer=e,this._loadResizerPreferences()}),i()(this,"_getAppsHash",e=>e.map(e=>e.id).join("~")),i()(this,"_relaxResizer",()=>{const e=this.resizer.getDistributors();e.forEach(e=>e.start()),e.forEach(e=>e.finish())}),i()(this,"_loadResizerPreferences",()=>{const e=C.d.instance.getResizerDistributions(this.props.room,C.a.Top);if(this.state.apps&&this.state.apps.length-1===e.length)e.forEach((e,t)=>{const s=this.resizer.forHandleAt(t);s&&(s.size=e,s.finish())});else if(this.state.apps){const e=this.resizer.getDistributors();e.forEach(e=>e.item.clearSize()),e.forEach(e=>e.start()),e.forEach(e=>e.finish())}}),i()(this,"onAction",e=>{const t=this.props.room.roomId+"_hide_widget_drawer";switch(e.action){case"appsDrawer":e.show?localStorage.setItem(t,"false"):localStorage.setItem(t,"true")}}),i()(this,"_getApps",()=>C.d.instance.getContainerWidgets(this.props.room,C.a.Top)),i()(this,"_updateApps",()=>{this.setState({apps:this._getApps()})}),this.state={apps:this._getApps(),resizingVertical:!1,resizingHorizontal:!1},this._resizeContainer=null,this.resizer=this._createResizer(),this.props.resizeNotifier.on("isResizing",this.onIsResizing)}componentDidMount(){g.b(),C.d.instance.on(C.d.emissionForRoom(this.props.room),this._updateApps),this.dispatcherRef=m.a.register(this.onAction)}componentWillUnmount(){g.c(),C.d.instance.off(C.d.emissionForRoom(this.props.room),this._updateApps),this.dispatcherRef&&m.a.unregister(this.dispatcherRef),this._resizeContainer&&this.resizer.detach(),this.props.resizeNotifier.off("isResizing",this.onIsResizing)}_createResizer(){const e={onResizeStart:()=>{this._resizeContainer.classList.add("mx_AppsDrawer_resizing"),this.setState({resizingHorizontal:!0})},onResizeStop:()=>{this._resizeContainer.classList.remove("mx_AppsDrawer_resizing"),C.d.instance.setResizerDistributions(this.props.room,C.a.Top,this.state.apps.slice(1).map((e,t)=>this.resizer.forHandleAt(t).size)),this.setState({resizingHorizontal:!1})}},t=new S.a({},w.a,e);return t.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle_vertical",reverse:"mx_ResizeHandle_reverse"}),t}componentDidUpdate(e,t){e.userId!==this.props.userId||e.room!==this.props.room?this._updateApps():this._getAppsHash(this.state.apps)!==this._getAppsHash(t.apps)&&this._loadResizerPreferences()}isResizing(){return this.state.resizingVertical||this.state.resizingHorizontal}_launchManageIntegrations(){y.b.getValue("feature_many_integration_managers")?b.a.sharedInstance().openAll():b.a.sharedInstance().getPrimaryManager().open(this.props.room,"add_integ")}render(){if(!this.props.showApps)return a.a.createElement("div",null);const e=this.state.apps.map((e,t,s)=>a.a.createElement(h.a,{key:e.id,app:e,fullWidth:s.length<2,room:this.props.room,userId:this.props.userId,creatorUserId:e.creatorUserId,widgetPageTitle:v.a.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad,pointerEvents:this.isResizing()?"none":void 0}));if(0===e.length)return a.a.createElement("div",null);let t;if(0===e.length&&f.a.roomHasPendingWidgets(this.props.room.roomId,v.a.getRoomWidgets(this.props.room))){const e=p.getComponent("elements.Spinner");t=a.a.createElement(e,null)}const s=d()({mx_AppsDrawer:!0,mx_AppsDrawer_fullWidth:e.length<2,mx_AppsDrawer_resizing:this.state.resizing,mx_AppsDrawer_2apps:2===e.length,mx_AppsDrawer_3apps:3===e.length});return a.a.createElement("div",{className:s},a.a.createElement(N,{room:this.props.room,minHeight:100,maxHeight:this.props.maxHeight?this.props.maxHeight-50:void 0,handleClass:"mx_AppsContainer_resizerHandle",handleWrapperClass:"mx_AppsContainer_resizerHandleContainer",className:"mx_AppsContainer_resizer",resizeNotifier:this.props.resizeNotifier},a.a.createElement("div",{className:"mx_AppsContainer",ref:this._collectResizer},e.map((t,s)=>s<1?t:a.a.createElement(a.a.Fragment,{key:t.key},a.a.createElement(E.a,{reverse:s>e.length/2}),t)))),t)}},i()(R,"propTypes",{userId:c.a.string.isRequired,room:c.a.object.isRequired,resizeNotifier:c.a.instanceOf(_.a).isRequired,showApps:c.a.bool}),i()(R,"defaultProps",{showApps:!0}),O=I))||O;const N=({room:e,minHeight:t,maxHeight:s,className:n,handleWrapperClass:i,handleClass:r,resizeNotifier:c,children:l})=>{let d=C.d.instance.getContainerHeight(e,C.a.Top);t||(t=100),s||(s=T.b.instance.windowHeight/4*3),d?(d=Object(k.a)(d,0,100),d=Object(k.d)(d/100,t,s)):d=280;const[h,m]=((e,t)=>{const[s,n]=Object(o.useState)(e);return[s,e=>{n(e),t(e)}]})(d,n=>{n=100*Object(k.c)(n,t,s),C.d.instance.setContainerHeight(e,C.a.Top,n)});return a.a.createElement(u.Resizable,{size:{height:Math.min(h,s)},minHeight:t,maxHeight:s,onResizeStart:()=>{c.startResizing()},onResize:()=>{c.notifyTimelineHeightChanged()},onResizeStop:(e,t,s,n)=>{m(h+n.height),c.stopResizing()},handleWrapperClass:i,handleClasses:{bottom:r},className:n,enable:{bottom:!0}},l)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return D})),s.d(t,"b",(function(){return A}));var n=s(18),i=s.n(n),o=s(138),a=s(743),r=s(8),c=s(245),l=s(133),d=s(94),u=s(212),h=s(140),m=s(183),p=s(98),g=s(161),v=s(278),f=s(141),b=s(96),y=s(5),_=s(156),E=s(99),S=s(608);function w(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function C(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?w(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):w(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class k extends _.a{constructor(){super(b.a,{}),i()(this,"modalInstance",null),i()(this,"openSourceWidgetId",null),i()(this,"canOpenModalWidget",()=>!this.modalInstance),i()(this,"openModalWidget",(e,t,s)=>{this.modalInstance||(this.openSourceWidgetId=t.id,this.modalInstance=E.a.createTrackedDialog("Modal Widget","",S.a,{widgetDefinition:C({},e),widgetRoomId:s,sourceWidgetId:t.id,onFinished:(e,s)=>{e?this.closeModalWidget(t,s):this.closeModalWidget(t,{"m.exited":!0}),this.openSourceWidgetId=null,this.modalInstance=null}},null,!1,!0))}),i()(this,"closeModalWidget",(e,t)=>{if(this.modalInstance&&this.openSourceWidgetId===e.id){this.openSourceWidgetId=null,this.modalInstance.close(),this.modalInstance=null;const s=c.a.instance.getMessaging(e);if(!s)return void console.error("No source widget messaging for modal widget");s.notifyModalWidgetClose(t)}})}static get instance(){return k.internalInstance}async onAction(e){}}i()(k,"internalInstance",new k),window.mxModalWidgetStore=k.instance;var O=s(334),R=s(252),I=s(120),x=s(607),T=s(609),j=s(92);function N(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function P(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?N(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):N(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class D extends o.Widget{constructor(e){super(e),this.rawDefinition=e}get templateUrl(){var e;return g.a.JITSI.matches(this.type)?h.a.getLocalJitsiWrapperUrl({forLocalRender:!0,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):super.templateUrl}get popoutTemplateUrl(){var e;return g.a.JITSI.matches(this.type)?h.a.getLocalJitsiWrapperUrl({forLocalRender:!1,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):this.templateUrl}get rawData(){let e=super.rawData.conferenceId;if(void 0===e){e=new URL(super.templateUrl).searchParams.get("confId")}let t=super.rawData.domain;void 0===t&&(t="jitsi.riot.im");let s=(new O.a).getEffectiveTheme();if(s.startsWith("custom-")){const e=Object(R.c)(s.substr(7));s=e.is_dark?"dark":"light"}return s=s.includes("light")?"light":"dark",P(P({},super.rawData),{},{theme:s,conferenceId:e,domain:t})}getCompleteUrl(e,t=!1){return Object(o.runTemplate)(t?this.popoutTemplateUrl:this.templateUrl,P(P({},this.rawDefinition),{},{data:this.rawData}),e)}}class A extends r.EventEmitter{constructor(e){var t;super(),this.appTileProps=e,i()(this,"messaging",void 0),i()(this,"mockWidget",void 0),i()(this,"scalarToken",void 0),i()(this,"roomId",void 0),i()(this,"kind",void 0),i()(this,"onOpenModal",async e=>{e.preventDefault(),k.instance.canOpenModalWidget()?(k.instance.openModalWidget(e.detail.data,this.mockWidget),this.messaging.transport.reply(e.detail,{})):this.messaging.transport.reply(e.detail,{error:{message:"Unable to open modal at this time"}})}),i()(this,"onEvent",e=>{d.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()||e.isDecryptionFailure()||e.getRoomId()===this.eventListenerRoomId&&this.feedEvent(e)}),i()(this,"onEventDecrypted",e=>{e.isDecryptionFailure()||e.getRoomId()===this.eventListenerRoomId&&this.feedEvent(e)});let s=e.app;s.creatorUserId||(s=Object(f.f)(s),s.creatorUserId=d.a.get().getUserId()),this.mockWidget=new D(s),this.roomId=null===(t=e.room)||void 0===t?void 0:t.roomId,this.kind=e.userWidget?o.WidgetKind.Account:o.WidgetKind.Room}get eventListenerRoomId(){return this.roomId?this.roomId:l.a.getRoomId()}get widgetApi(){return this.messaging}get embedUrl(){return this.runUrlTemplate({asPopout:!1})}get popoutUrl(){return this.runUrlTemplate({asPopout:!0})}runUrlTemplate(e={asPopout:!1}){const t=this.mockWidget.getCompleteUrl({widgetRoomId:this.roomId,currentUserId:d.a.get().getUserId(),userDisplayName:u.a.instance.displayName,userHttpAvatarUrl:u.a.instance.getHttpAvatarUrl(),clientId:T.a,clientTheme:p.b.getValue("theme"),clientLanguage:Object(j.g)()},null==e?void 0:e.asPopout),s=new URL(t);return null!=e&&e.asPopout||(s.searchParams.set("widgetId",this.mockWidget.id),s.searchParams.set("parentUrl",window.location.href.split("#",2)[0]),this.scalarToken&&s.searchParams.set("scalar_token",this.scalarToken)),s.toString().replace(/%24/g,"$")}get isManagedByManager(){return!!this.scalarToken}get started(){return!!this.messaging}get widgetId(){return this.messaging.widget.id}start(e){if(this.started)return;const t=this.appTileProps.whitelistCapabilities||[],s=new a.a(t,this.mockWidget,this.kind,this.roomId);this.messaging=new o.ClientWidgetApi(this.mockWidget,e,s),this.messaging.on("preparing",()=>this.emit("preparing")),this.messaging.on("ready",()=>this.emit("ready")),this.messaging.on("action:"+o.WidgetApiFromWidgetAction.OpenModalWidget,this.onOpenModal),c.a.instance.storeMessaging(this.mockWidget,this.messaging),!this.appTileProps.userWidget&&this.appTileProps.room&&v.a.setRoomId(this.mockWidget.id,this.appTileProps.room.roomId),this.messaging.on("action:"+y.a.ViewRoom,e=>{e.preventDefault();const t=(e.detail.data||{}).room_id;return t?this.messaging.hasCapability(x.a.CanChangeViewedRoom)?(b.a.dispatch({action:"view_room",room_id:t}),void this.messaging.transport.reply(e.detail,{})):this.messaging.transport.reply(e.detail,{error:{message:"This widget does not have permission for this action (denied)."}}):this.messaging.transport.reply(e.detail,{error:{message:"Room ID not supplied."}})}),d.a.get().on("event",this.onEvent),d.a.get().on("Event.decrypted",this.onEventDecrypted),this.messaging.on("action:"+o.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,e=>{this.messaging.hasCapability(o.MatrixCapabilities.AlwaysOnScreen)&&(g.a.JITSI.matches(this.mockWidget.type)&&I.a.instance.trackJoinCall(this.appTileProps.room.roomId,!0,!0),v.a.setWidgetPersistence(this.mockWidget.id,e.detail.data.value),e.preventDefault(),this.messaging.transport.reply(e.detail,{}))}),this.messaging.on("action:"+o.WidgetApiFromWidgetAction.SendSticker,e=>{this.messaging.hasCapability(o.MatrixCapabilities.StickerSending)&&(e.preventDefault(),this.messaging.transport.reply(e.detail,{}),b.a.dispatch({action:"m.sticker",data:e.detail.data,widgetId:this.mockWidget.id}))}),g.a.STICKERPICKER.matches(this.mockWidget.type)&&this.messaging.on("action:"+y.a.OpenIntegrationManager,e=>{e.preventDefault(),this.messaging.transport.reply(e.detail,{}),b.a.dispatch({action:"stickerpicker_close"});const t=e.detail.data,s=null==t?void 0:t.integType,n=null==t?void 0:t.integId;p.b.getValue("feature_many_integration_managers")?m.a.sharedInstance().openAll(d.a.get().getRoom(l.a.getRoomId()),"type_"+s,n):m.a.sharedInstance().getPrimaryManager().open(d.a.get().getRoom(l.a.getRoomId()),"type_"+s,n)})}async prepare(){if(this.scalarToken)return;const e=c.a.instance.getMessaging(this.mockWidget);e&&(this.messaging=e);try{if(h.a.isScalarUrl(this.mockWidget.templateUrl)){const e=m.a.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();if(h.a.isScalarUrl(t.apiUrl)){const e=t.getScalarClient();this.scalarToken=await e.getScalarToken()}}}}catch(e){console.error("Error preparing widget communications: ",e)}}stop(e={forceDestroy:!1}){null!=e&&e.forceDestroy||v.a.getPersistentWidgetId()!==this.mockWidget.id?this.started&&(c.a.instance.stopMessaging(this.mockWidget),v.a.delRoomId(this.mockWidget.id),d.a.get()&&(d.a.get().off("event",this.onEvent),d.a.get().off("Event.decrypted",this.onEventDecrypted))):console.log("Skipping destroy - persistent widget")}feedEvent(e){if(!this.messaging)return;const t=e.event;this.messaging.feedEvent(t).catch(e=>{console.error("Error sending event to widget: ",e)})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(18),i=s.n(n);class o{constructor(e){this.tagId=e,i()(this,"_n",0),i()(this,"_previews",!0),i()(this,"_collapsed",!1);const t=localStorage.getItem(this.key);if(t){const e=JSON.parse(t);this._n=e.numTiles,this._previews=e.showPreviews,this._collapsed=e.collapsed}}get isCollapsed(){return this._collapsed}set isCollapsed(e){this._collapsed=e,this.save()}get showPreviews(){return this._previews}set showPreviews(e){this._previews=e,this.save()}get tileHeight(){return 60}get key(){return`mx_sublist_layout_${this.tagId}_boxed`}get visibleTiles(){return 0===this._n?this.defaultVisibleTiles:Math.max(this._n,this.minVisibleTiles)}set visibleTiles(e){this._n=e,this.save()}get minVisibleTiles(){return 1}get defaultVisibleTiles(){return 50}tilesWithPadding(e,t){return this.pixelsToTiles(this.tilesToPixelsWithPadding(e,t))}tilesToPixelsWithPadding(e,t){return this.tilesToPixels(e)+t}tilesToPixels(e){return e*this.tileHeight}pixelsToTiles(e){return e/this.tileHeight}reset(){localStorage.removeItem(this.key)}save(){localStorage.setItem(this.key,JSON.stringify(this.serialize()))}serialize(){return{numTiles:this.visibleTiles,showPreviews:this.showPreviews,collapsed:this.isCollapsed}}}var a=s(156),r=s(96);class c extends a.a{constructor(){super(r.a),i()(this,"layoutMap",new Map)}static get instance(){return c.internalInstance||(c.internalInstance=new c),c.internalInstance}ensureLayoutExists(e){this.layoutMap.has(e)||this.layoutMap.set(e,new o(e))}getLayoutFor(e){return this.layoutMap.has(e)||this.layoutMap.set(e,new o(e)),this.layoutMap.get(e)}async resetLayouts(){console.warn("Resetting layouts for room list");for(const e of this.layoutMap.values())e.reset()}async onNotReady(){this.layoutMap.clear()}async onAction(e){return Promise.resolve()}}i()(c,"internalInstance",void 0),window.mxRoomListLayoutStore=c.instance},,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";(function(e){class n{constructor(){this.components=null}getComponent(e){if(!e)throw new Error("Invalid component name: "+e);if(null===this.components)throw new Error(`Attempted to get a component (${e}) before a skin has been loaded. This is probably because either: a) Your app has not called sdk.loadSkin(), or b) A component has called getComponent at the root level`);const t=(t=>{if(!t)return null;let s=t[e];return s||(s=t["views."+e]),s})(this.components);if(!t)return null;if(!("function"==typeof t||t.render))throw new Error(`Not a valid component: ${e} (type = ${typeof t}).`);return t}load(e){if(null!==this.components)throw new Error("Attempted to load a skin while a skin is already loadedIf you want to change the active skin, call resetSkin first");this.components={};const t=Object.keys(e.components);for(let s=0;s<t.length;++s){const n=e.components[t[s]];this.addComponent(t[s],n)}const n=s(1315);if(!n||!n.components)throw new Error("Invalid react-sdk component index");for(const e in n.components)this.components[e]||(this.components[e]=n.components[e])}addComponent(e,t){let s=e;void 0!==t.replaces&&(s=t.replaces.indexOf(".")>-1?t.replaces:e.substr(0,e.lastIndexOf(".")+1)+t.replaces.split(".").pop()),this.components[s]=t}reset(){this.components=null}}void 0===e.mxSkinner&&(e.mxSkinner=new n),t.a=e.mxSkinner}).call(this,s(7))},,,function(e,t){e.exports="img/feather-customised/check.5745b4e.svg"},function(e,t){e.exports="img/element-desktop-logo.7bf805d.svg"},,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(18),i=s.n(n),o=s(91),a=s.n(o),r=s(95),c=s(92);class l extends a.a.Component{constructor(...e){super(...e),i()(this,"unmounted",!1),i()(this,"state",{component:null,error:null}),i()(this,"onWrapperCancelClick",()=>{this.props.onFinished(!1)})}componentDidMount(){console.log("Starting load of AsyncWrapper for modal"),this.props.prom.then(e=>{if(this.unmounted)return;const t=e.default?e.default:e;this.setState({component:t})}).catch(e=>{console.warn("AsyncWrapper promise failed",e),this.setState({error:e})})}componentWillUnmount(){this.unmounted=!0}render(){if(this.state.component){const e=this.state.component;return a.a.createElement(e,this.props)}if(this.state.error){const e=r.getComponent("views.dialogs.BaseDialog"),t=r.getComponent("views.elements.DialogButtons");return a.a.createElement(e,{onFinished:this.props.onFinished,title:Object(c.a)("Error")},Object(c.a)("Unable to load! Check your network connectivity and try again."),a.a.createElement(t,{primaryButton:Object(c.a)("Dismiss"),onPrimaryButtonClick:this.onWrapperCancelClick,hasCancel:!1}))}{const e=r.getComponent("elements.Spinner");return a.a.createElement(e,null)}}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){},,,,,,,,,,,,function(e,t){},,,,function(e,t,s){"use strict";(function(e){s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var n=s(0);let i,o=0;const a=[];let r=Date.now;function c(e,t){(t=t||0)<0&&(t=0);const s=Array.prototype.slice.call(arguments,2),n=r()+t,i=o++,c={runAt:n,func:e,params:s,key:i},l=h(a,(function(e){return e.runAt-n}));return a.splice(l,0,c),d(),i}function l(e){if(0===a.length)return;let t;for(t=0;t<a.length;t++){if(a[t].key==e){a.splice(t,1);break}}0===t&&d()}function d(){i&&e.clearTimeout(i);const t=a[0];if(!t)return;const s=r(),n=Math.min(t.runAt-s,1e3);i=e.setTimeout(u,n)}function u(){let t;const s=r(),i=[];for(;;){const e=a[0];if(!e||e.runAt>s)break;t=a.shift(),t.key,i.push(t)}d();for(let s=0;s<i.length;s++){t=i[s];try{t.func.apply(e,t.params)}catch(e){n.a.error("Uncaught exception in callback function",e.stack||e)}}}function h(e,t){let s=0,n=e.length;for(;s<n;){const i=s+n>>1;t(e[i])>0?n=i:s=i+1}return s}}).call(this,s(7))},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return p}));var n=s(210),i=s(230),o=s(239),a=s(1),r=s(294),c=s(167),l=s(263),d=s(0),u=s(215);function h(e,t){return"FILTER_SYNC_"+e+(t?"_"+t:"")}function m(...e){d.a.log(...e)}function p(e,t){this.client=e,(t=t||{}).initialSyncLimit=void 0===t.initialSyncLimit?8:t.initialSyncLimit,t.resolveInvitesToProfiles=t.resolveInvitesToProfiles||!1,t.pollTimeout=t.pollTimeout||3e4,t.pendingEventOrdering=t.pendingEventOrdering||"chronological",t.canResetEntireTimeline||(t.canResetEntireTimeline=function(e){return!1}),this.opts=t,this._peekRoom=null,this._currentSyncRequest=null,this._syncState=null,this._syncStateData=null,this._catchingUp=!1,this._running=!1,this._keepAliveTimer=null,this._connectionReturnedDefer=null,this._notifEvents=[],this._failedSyncCount=0,this._storeIsInvalid=!1,e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),["Room.timeline","Room.timelineReset"])}function g(e,t){const s=new n.a(t);return e.reEmitter.reEmit(s,["User.avatarUrl","User.displayName","User.presence","User.currentlyActive","User.lastPresenceTs"]),s}p.prototype.createRoom=function(e){const t=this.client,{timelineSupport:s,unstableClientRelationAggregation:n}=t,o=new i.b(e,t,t.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:s,unstableClientRelationAggregation:n});return t.reEmitter.reEmit(o,["Room.name","Room.timeline","Room.redaction","Room.redactionCancelled","Room.receipt","Room.tags","Room.timelineReset","Room.localEchoUpdated","Room.accountData","Room.myMembership","Room.replaceEvent"]),this._registerStateListeners(o),o},p.prototype.createGroup=function(e){const t=this.client,s=new o.a(e);return t.reEmitter.reEmit(s,["Group.profile","Group.myMembership"]),t.store.storeGroup(s),s},p.prototype._registerStateListeners=function(e){const t=this.client;t.reEmitter.reEmit(e.currentState,["RoomState.events","RoomState.members","RoomState.newMember"]),e.currentState.on("RoomState.newMember",(function(e,s,n){n.user=t.getUser(n.userId),t.reEmitter.reEmit(n,["RoomMember.name","RoomMember.typing","RoomMember.powerLevel","RoomMember.membership"])}))},p.prototype._deregisterStateListeners=function(e){e.currentState.removeAllListeners("RoomState.events"),e.currentState.removeAllListeners("RoomState.members"),e.currentState.removeAllListeners("RoomState.newMember")},p.prototype.syncLeftRooms=function(){const e=this.client,t=this,s=new r.a(this.client.credentials.userId);s.setTimelineLimit(1),s.setIncludeLeaveRooms(!0);const n=this.opts.pollTimeout+8e4,i={timeout:0};return e.getOrCreateFilter(h(e.credentials.userId,"LEFT_ROOMS"),s).then((function(t){return i.filter=t,e.http.authedRequest(void 0,"GET","/sync",i,void 0,n)})).then((function(s){let n=[];s.rooms&&s.rooms.leave&&(n=t._mapSyncResponseToRoomArray(s.rooms.leave));const i=[];return n.forEach((function(s){const n=s.room;if(i.push(n),!s.isBrandNewRoom)return;s.timeline=s.timeline||{};const o=t._mapSyncEventsFormat(s.timeline,n),a=t._mapSyncEventsFormat(s.state,n);n.getLiveTimeline().setPaginationToken(s.timeline.prev_batch,c.a.BACKWARDS),t._processRoomEvents(n,a,o),n.recalculate(),e.store.storeRoom(n),e.emit("Room",n),t._processEventsForNotifs(n,o)})),i}))},p.prototype.peek=function(e){if(this._peekRoom&&this._peekRoom.roomId===e)return Promise.resolve(this._peekRoom);const t=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,20).then(e=>{e.messages=e.messages||{},e.messages.chunk=e.messages.chunk||[],e.state=e.state||[];const s=a.h(e.state).map(t.getEventMapper()),n=e.state.map(t.getEventMapper()),i=e.messages.chunk.map(t.getEventMapper());return e.presence&&Array.isArray(e.presence)&&e.presence.map(t.getEventMapper()).forEach((function(e){let s=t.store.getUser(e.getContent().user_id);s?s.setPresenceEvent(e):(s=g(t,e.getContent().user_id),s.setPresenceEvent(e),t.store.storeUser(s)),t.emit("event",e)})),e.messages.start&&(this._peekRoom.oldState.paginationToken=e.messages.start),this._peekRoom.oldState.setStateEvents(s),this._peekRoom.currentState.setStateEvents(n),this._resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(i.reverse(),!0,this._peekRoom.getLiveTimeline(),e.messages.start),t.store.storeRoom(this._peekRoom),t.emit("Room",this._peekRoom),this._peekPoll(this._peekRoom),this._peekRoom})},p.prototype.stopPeeking=function(){this._peekRoom=null},p.prototype._peekPoll=function(e,t){if(this._peekRoom!==e)return void m("Stopped peeking in room %s",e.roomId);const s=this;this.client.http.authedRequest(void 0,"GET","/events",{room_id:e.roomId,timeout:3e4,from:t},void 0,5e4).then((function(t){if(s._peekRoom!==e)return void m("Stopped peeking in room %s",e.roomId);t.chunk.filter((function(e){return"m.presence"===e.type})).map(s.client.getEventMapper()).forEach((function(e){let t=s.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=g(s.client,e.getContent().user_id),t.setPresenceEvent(e),s.client.store.storeUser(t)),s.client.emit("event",e)}));const n=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(s.client.getEventMapper());e.addLiveEvents(n),s._peekPoll(e,t.end)}),(function(n){d.a.error("[%s] Peek poll failed: %s",e.roomId,n),setTimeout((function(){s._peekPoll(e,t)}),3e4)}))},p.prototype.getSyncState=function(){return this._syncState},p.prototype.getSyncStateData=function(){return this._syncStateData},p.prototype.recoverFromSyncStartupError=async function(e,t){await e;const s=this._startKeepAlives();this._updateSyncState("ERROR",{error:t}),await s},p.prototype._wasLazyLoadingToggled=async function(e){e=!!e;let t=!1;if(!await this.client.store.isNewlyCreated()){const s=await this.client.store.getClientOptions();return s&&(t=!!s.lazyLoadMembers),t!==e}return!1},p.prototype._shouldAbortSync=function(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(d.a.warn("Token no longer valid - assuming logout"),this.stop(),!0)},p.prototype.sync=function(){const t=this.client,s=this;this._running=!0,e.window&&e.window.addEventListener&&(this._onOnlineBound=this._onOnline.bind(this),e.window.addEventListener("online",this._onOnlineBound,!1));let n=Promise.resolve(),i=null;function o(){const e=new r.a(t.credentials.userId);return e.setTimelineLimit(s.opts.initialSyncLimit),e}const a=async()=>{if(m("Checking lazy load status..."),this.opts.lazyLoadMembers&&t.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers){m("Checking server lazy load support...");await t.doesServerSupportLazyLoading()?(m("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=o()),this.opts.filter.setLazyLoadMembers(!0)):(m("LL: lazy loading requested but not supported by server, so disabling"),this.opts.lazyLoadMembers=!1)}m("Checking whether lazy loading has changed in store...");if(await this._wasLazyLoadingToggled(this.opts.lazyLoadMembers)){this._storeIsInvalid=!0;const e=u.b.TOGGLED_LAZY_LOADING,t=new u.b(e,!!this.opts.lazyLoadMembers);return this._updateSyncState("ERROR",{error:t}),void d.a.warn("InvalidStoreError: store is not usable: stopping sync.")}this.opts.lazyLoadMembers&&this.opts.crypto&&this.opts.crypto.enableLazyLoading();try{m("Storing client options..."),await this.client.storeClientOptions(),m("Stored client options")}catch(e){throw d.a.error("Storing client options failed",e),e}!async function e(){let a,r;m("Getting filter..."),a=s.opts.filter?s.opts.filter:o();try{r=await t.getOrCreateFilter(h(t.credentials.userId),a)}catch(t){if(d.a.error("Getting filter failed",t),s._shouldAbortSync(t))return;return m("Waiting for saved sync before retrying filter..."),await s.recoverFromSyncStartupError(n,t),void e()}t.resetNotifTimelineSet(),null===s._currentSyncRequest&&(m("Sending first sync request..."),s._currentSyncRequest=s._doSyncRequest({filterId:r},i));m("Waiting for saved sync before starting sync processing..."),await n,s._sync({filterId:r})}()};t.isGuest()?s._sync({}):(m("Getting saved sync token..."),n=t.store.getSavedSyncToken().then(e=>(m("Got saved sync token"),i=e,m("Getting saved sync..."),t.store.getSavedSync())).then(e=>{if(m("Got reply from saved sync, exists? "+!!e),e)return s._syncFromCache(e)}).catch(e=>{d.a.error("Getting saved sync failed",e)}),async function e(){try{m("Getting push rules...");const e=await t.getPushRules();m("Got push rules"),t.pushRules=e}catch(t){if(d.a.error("Getting push rules failed",t),s._shouldAbortSync(t))return;return m("Waiting for saved sync before retrying push rules..."),await s.recoverFromSyncStartupError(n,t),void e()}a()}())},p.prototype.stop=function(){m("SyncApi.stop"),e.window&&(e.window.removeEventListener("online",this._onOnlineBound,!1),this._onOnlineBound=void 0),this._running=!1,this._currentSyncRequest&&this._currentSyncRequest.abort(),this._keepAliveTimer&&(clearTimeout(this._keepAliveTimer),this._keepAliveTimer=null)},p.prototype.retryImmediately=function(){return!!this._connectionReturnedDefer&&(this._startKeepAlives(0),!0)},p.prototype._syncFromCache=async function(e){m("sync(): not doing HTTP hit, instead returning stored /sync data");const t=e.nextBatch;this.client.store.setSyncToken(t);const s={oldSyncToken:null,nextSyncToken:t,catchingUp:!1,fromCache:!0},n={next_batch:t,rooms:e.roomsData,groups:e.groupsData,account_data:{events:e.accountData}};try{await this._processSyncResponse(s,n)}catch(e){d.a.error("Error processing cached sync",e.stack||e)}this._storeIsInvalid||this._updateSyncState("PREPARED",s)},p.prototype._sync=async function(e){const t=this.client;if(!this._running)return m("Sync no longer running: exiting."),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");const s=t.store.getSyncToken();let n;try{null===this._currentSyncRequest&&(this._currentSyncRequest=this._doSyncRequest(e,s)),n=await this._currentSyncRequest}catch(t){return void this._onSyncError(t,e)}finally{this._currentSyncRequest=null}t.store.setSyncToken(n.next_batch),this._failedSyncCount=0,await t.store.setSyncData(n);const i={oldSyncToken:s,nextSyncToken:n.next_batch,catchingUp:this._catchingUp};this.opts.crypto&&await this.opts.crypto.onSyncWillProcess(i);try{await this._processSyncResponse(i,n)}catch(e){d.a.error("Caught /sync error",e.stack||e),this.client.emit("sync.unexpectedError",e)}i.catchingUp=this._catchingUp,e.hasSyncedBefore||(this._updateSyncState("PREPARED",i),e.hasSyncedBefore=!0),this.opts.crypto&&await this.opts.crypto.onSyncCompleted(i),this._updateSyncState("SYNCING",i),t.store.wantsSave()&&(this.opts.crypto&&await this.opts.crypto.saveDeviceList(0),t.store.save()),this._sync(e)},p.prototype._doSyncRequest=function(e,t){const s=this._getSyncParams(e,t);return this.client.http.authedRequest(void 0,"GET","/sync",s,void 0,s.timeout+8e4)},p.prototype._getSyncParams=function(e,t){let s=this.opts.pollTimeout;("SYNCING"!==this.getSyncState()||this._catchingUp)&&(this._catchingUp=!0,s=0);let n=e.filterId;this.client.isGuest()&&!n&&(n=this._getGuestFilter());const i={filter:n,timeout:s};return this.opts.disablePresence&&(i.set_presence="offline"),t?i.since=t:i._cacheBuster=Date.now(),"ERROR"!=this.getSyncState()&&"RECONNECTING"!=this.getSyncState()||(i.timeout=0),i},p.prototype._onSyncError=function(e,t){if(!this._running)return m("Sync no longer running: exiting"),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");d.a.error("/sync error %s",e),d.a.error(e),this._shouldAbortSync(e)||(this._failedSyncCount++,d.a.log("Number of consecutive failed sync requests:",this._failedSyncCount),m("Starting keep-alive"),this._startKeepAlives().then(e=>{e&&"ERROR"===this.getSyncState()&&this._updateSyncState("CATCHUP",{oldSyncToken:null,nextSyncToken:null,catchingUp:!0}),this._sync(t)}),this._currentSyncRequest=null,this._updateSyncState(this._failedSyncCount>=3?"ERROR":"RECONNECTING",{error:e}))},p.prototype._processSyncResponse=async function(e,t){const s=this.client,n=this;if(t.presence&&Array.isArray(t.presence.events)&&t.presence.events.map(s.getEventMapper()).forEach((function(e){let t=s.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=g(s,e.getSender()),t.setPresenceEvent(e),s.store.storeUser(t)),s.emit("event",e)})),t.account_data&&Array.isArray(t.account_data.events)){const e=t.account_data.events.map(s.getEventMapper()),n=e.reduce((e,t)=>(e[t.getId()]=s.store.getAccountData(t.getType()),e),{});s.store.storeAccountDataEvents(e),e.forEach((function(e){if("m.push_rules"===e.getType()){const t=e.getContent();s.pushRules=l.a.rewriteDefaultRules(t)}const t=n[e.getId()];return s.emit("accountData",e,t),e}))}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){const e=[];t.to_device.events.map(s.getEventMapper()).map(t=>{if("m.key.verification.cancel"===t.getType()){const s=t.getContent().transaction_id;s&&e.push(s)}return t}).forEach((function(t){const n=t.getContent();if("m.room.message"!=t.getType()||"m.bad.encrypted"!=n.msgtype){if("m.key.verification.start"===t.getType()||"m.key.verification.request"===t.getType()){const s=n.transaction_id;e.includes(s)&&t.flagCancelled()}s.emit("toDeviceEvent",t)}else d.a.log("Ignoring undecryptable to-device event from "+t.getSender())}))}else this._catchingUp=!1;t.groups&&(t.groups.invite&&this._processGroupSyncEntry(t.groups.invite,"invite"),t.groups.join&&this._processGroupSyncEntry(t.groups.join,"join"),t.groups.leave&&this._processGroupSyncEntry(t.groups.leave,"leave"));let i=[],o=[],r=[];if(t.rooms&&(t.rooms.invite&&(i=this._mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(o=this._mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(r=this._mapSyncResponseToRoomArray(t.rooms.leave))),this._notifEvents=[],i.forEach((function(e){const t=e.room,i=n._mapSyncEventsFormat(e.invite_state,t);n._processRoomEvents(t,i),e.isBrandNewRoom&&(t.recalculate(),s.store.storeRoom(t),s.emit("Room",t)),i.forEach((function(e){s.emit("event",e)})),t.updateMyMembership("invite")})),await a.A(o,(async function(t){const i=t.room,o=n._mapSyncEventsFormat(t.state,i),r=n._mapSyncEventsFormat(t.timeline,i,!1),l=n._mapSyncEventsFormat(t.ephemeral),d=n._mapSyncEventsFormat(t.account_data),u=s.isRoomEncrypted(i.roomId);if(t.unread_notifications&&(i.setUnreadNotificationCount("total",t.unread_notifications.notification_count),(!u||u&&i.getUnreadNotificationCount("highlight")<=0)&&i.setUnreadNotificationCount("highlight",t.unread_notifications.highlight_count)),t.timeline=t.timeline||{},t.isBrandNewRoom)i.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,c.a.BACKWARDS);else if(t.timeline.limited){let o=!0;for(let e=r.length-1;e>=0;e--){const t=r[e].getId();if(i.getTimelineForEvent(t)){m("Already have event "+t+" in limited sync - not resetting"),o=!1,r.splice(0,e);break}}o&&(n._deregisterStateListeners(i),i.resetLiveTimeline(t.timeline.prev_batch,n.opts.canResetEntireTimeline(i.roomId)?null:e.oldSyncToken),s.resetNotifTimelineSet(),n._registerStateListeners(i))}async function h(e){if(s.emit("event",e),e.isState()&&"m.room.encryption"==e.getType()&&n.opts.crypto&&await n.opts.crypto.onCryptoEvent(e),e.isState()&&"im.vector.user_status"===e.getType()){let t=s.store.getUser(e.getStateKey());t?t.unstable_updateStatusMessage(e):(t=g(s,e.getStateKey()),t.unstable_updateStatusMessage(e),s.store.storeUser(t))}}n._processRoomEvents(i,o,r,e.fromCache),t.summary&&i.setSummary(t.summary),i.addEphemeralEvents(l),i.addAccountData(d),i.recalculate(),t.isBrandNewRoom&&(s.store.storeRoom(i),s.emit("Room",i)),n._processEventsForNotifs(i,r),await a.A(o,h),await a.A(r,h),l.forEach((function(e){s.emit("event",e)})),d.forEach((function(e){s.emit("event",e)})),i.updateMyMembership("join"),i.decryptCriticalEvents()})),r.forEach((function(e){const t=e.room,i=n._mapSyncEventsFormat(e.state,t),o=n._mapSyncEventsFormat(e.timeline,t),a=n._mapSyncEventsFormat(e.account_data);n._processRoomEvents(t,i,o),t.addAccountData(a),t.recalculate(),e.isBrandNewRoom&&(s.store.storeRoom(t),s.emit("Room",t)),n._processEventsForNotifs(t,o),i.forEach((function(e){s.emit("event",e)})),o.forEach((function(e){s.emit("event",e)})),a.forEach((function(e){s.emit("event",e)})),t.updateMyMembership("leave")})),e.oldSyncToken&&this._notifEvents.length&&(this._notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this._notifEvents.forEach((function(e){s.getNotifTimelineSet().addLiveEvent(e)}))),t.device_lists&&this.opts.crypto&&await this.opts.crypto.handleDeviceListChanges(e,t.device_lists),this.opts.crypto&&t.device_one_time_keys_count){const e=t.device_one_time_keys_count.signed_curve25519||0;this.opts.crypto.updateOneTimeKeyCount(e)}if(this.opts.crypto&&t["org.matrix.msc2732.device_unused_fallback_key_types"]){const e=t["org.matrix.msc2732.device_unused_fallback_key_types"];this.opts.crypto.setNeedsNewFallback(e instanceof Array&&!e.includes("signed_curve25519"))}},p.prototype._startKeepAlives=function(e){void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this._keepAliveTimer&&clearTimeout(this._keepAliveTimer);const t=this;return e>0?t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t),e):t._pokeKeepAlive(),this._connectionReturnedDefer||(this._connectionReturnedDefer=a.j()),this._connectionReturnedDefer.promise},p.prototype._pokeKeepAlive=function(e){void 0===e&&(e=!1);const t=this;function s(){clearTimeout(t._keepAliveTimer),t._connectionReturnedDefer&&(t._connectionReturnedDefer.resolve(e),t._connectionReturnedDefer=null)}this.client.http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3}).then((function(){s()}),(function(n){400==n.httpStatus||404==n.httpStatus?t._keepAliveTimer=setTimeout(s,2e3):(e=!0,t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t,e),5e3+Math.floor(5e3*Math.random())),t._updateSyncState("ERROR",{error:n}))}))},p.prototype._processGroupSyncEntry=function(e,t){for(const s of Object.keys(e)){const n=e[s];let i=this.client.store.getGroup(s);const o=null===i;null===i&&(i=this.createGroup(s)),n.profile&&i.setProfile(n.profile.name,n.profile.avatar_url),n.inviter&&i.setInviter({userId:n.inviter}),i.setMyMembership(t),o&&this.client.emit("Group",i)}},p.prototype._mapSyncResponseToRoomArray=function(e){const t=this.client,s=this;return Object.keys(e).map((function(n){const i=e[n];let o=t.store.getRoom(n),a=!1;return o||(o=s.createRoom(n),a=!0),i.room=o,i.isBrandNewRoom=a,i}))},p.prototype._mapSyncEventsFormat=function(e,t,s=!0){if(!e||!Array.isArray(e.events))return[];const n=this.client.getEventMapper({decrypt:s});return e.events.map((function(e){return t&&(e.room_id=t.roomId),n(e)}))},p.prototype._resolveInvites=function(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership("invite").forEach((function(s){if(s._requestedProfileInfo)return;s._requestedProfileInfo=!0;const n=t.getUser(s.userId);let i;i=n?Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):t.getProfileInfo(s.userId),i.then((function(t){const n=s.events.member;"invite"===n.getContent().membership&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,s.setMembershipEvent(n,e.currentState))}),(function(e){}))}))},p.prototype._processRoomEvents=function(e,t,s,n){const i=e.getLiveTimeline(),o=0==i.getEvents().length;if(o){for(const e of t)this.client.getPushActionsForEvent(e);i.initialiseState(t)}this._resolveInvites(e),e.recalculate(),o||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),e.addLiveEvents(s||[],null,n)},p.prototype._processEventsForNotifs=function(e,t){if(this.client.getNotifTimelineSet())for(let e=0;e<t.length;e++){const s=this.client.getPushActionsForEvent(t[e]);s&&s.notify&&s.tweaks&&s.tweaks.highlight&&this._notifEvents.push(t[e])}},p.prototype._getGuestFilter=function(){return"{}"},p.prototype._updateSyncState=function(e,t){const s=this._syncState;this._syncState=e,this._syncStateData=t,this.client.emit("sync",this._syncState,s,t)},p.prototype._onOnline=function(){m("Browser thinks we are back online"),this._startKeepAlives(0)}}).call(this,s(7))},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(115),i=s.n(n);class o{constructor(){i()(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeGroup(e){}getGroup(e){return null}getGroups(){return[]}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}storeEvents(e,t,s,n){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve({})}storeClientOptions(e){return Promise.resolve()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(115),i=s.n(n),o=s(0),a=s(158),r=s(110);class c{constructor(e){i()(this,"client",void 0),i()(this,"calls",void 0),i()(this,"callEventBuffer",void 0),i()(this,"candidateEventsByCall",void 0),i()(this,"evaluateEventBuffer",async()=>{if("SYNCING"===this.client.getSyncState()){await Promise.all(this.callEventBuffer.map(e=>{this.client.decryptEventIfNeeded(e)}));const e=new Set;for(const t of this.callEventBuffer)t.getType()!==r.a.CallAnswer&&t.getType()!==r.a.CallHangup||e.add(t.getContent().call_id);for(const t of this.callEventBuffer)if(t.getType()!==r.a.CallInvite||!e.has(t.getContent().call_id))try{this.handleCallEvent(t)}catch(e){o.a.error("Caught exception handling call event",e)}this.callEventBuffer=[]}}),i()(this,"onEvent",e=>{this.client.decryptEventIfNeeded(e),(this.eventIsACall(e)||e.isBeingDecrypted())&&this.callEventBuffer.push(e),(e.isBeingDecrypted()||e.isDecryptionFailure())&&e.once("Event.decrypted",()=>{if(this.eventIsACall(e))if(this.callEventBuffer.includes(e))this.evaluateEventBuffer();else try{this.handleCallEvent(e)}catch(e){o.a.error("Caught exception handling call event",e)}})}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on("sync",this.evaluateEventBuffer),this.client.on("event",this.onEvent)}stop(){this.client.removeListener("sync",this.evaluateEventBuffer),this.client.removeListener("event",this.onEvent)}eventIsACall(e){const t=e.getType();return t.startsWith("m.call.")||t.startsWith("org.matrix.call.")}handleCallEvent(e){const t=e.getContent();let s=t.call_id?this.calls.get(t.call_id):void 0;if(e.getType()===r.a.CallInvite){if(e.getSender()===this.client.credentials.userId)return;if(e.getLocalAge()>t.lifetime-3e3)return;if(s&&s.state===a.e.Ended)return;s&&o.a.log(`WARN: Already have a MatrixCall with id ${t.call_id} but got an invite. Clobbering.`);const n=this.client.getTurnServersExpiry()-Date.now();if(o.a.info("Current turn creds expire in "+n+" ms"),s=Object(a.g)(this.client,e.getRoomId(),{forceTURN:this.client.forceTURN}),!s)return void o.a.log("Incoming call ID "+t.call_id+" but this client doesn't support WebRTC");if(s.callId=t.call_id,s.initWithInvite(e),this.calls.set(s.callId,s),this.candidateEventsByCall.get(s.callId))for(const e of this.candidateEventsByCall.get(s.callId))s.onRemoteIceCandidatesReceived(e);let i;for(const e of this.calls.values()){const t=[a.e.WaitLocalMedia,a.e.CreateOffer,a.e.InviteSent].includes(e.state);if(s.roomId===e.roomId&&e.direction===a.a.Outbound&&t){i=e;break}}i?i.state===a.e.WaitLocalMedia||i.state===a.e.CreateOffer||i.callId>s.callId?(o.a.log("Glare detected: answering incoming call "+s.callId+" and canceling outgoing call "+i.callId),i.replacedBy(s),s.answer()):(o.a.log("Glare detected: rejecting incoming call "+s.callId+" and keeping outgoing call "+i.callId),s.hangup(a.b.Replaced,!0)):this.client.emit("Call.incoming",s)}else if(e.getType()===r.a.CallAnswer){if(!s)return;e.getSender()===this.client.credentials.userId?s.state===a.e.Ringing&&s.onAnsweredElsewhere(t):s.onAnswerReceived(e)}else if(e.getType()===r.a.CallCandidates){if(e.getSender()===this.client.credentials.userId)return;s?s.onRemoteIceCandidatesReceived(e):(this.candidateEventsByCall.has(t.call_id)||this.candidateEventsByCall.set(t.call_id,[]),this.candidateEventsByCall.get(t.call_id).push(e))}else if([r.a.CallHangup,r.a.CallReject].includes(e.getType()))s?s.state!==a.e.Ended&&(e.getType()===r.a.CallHangup?s.onHangupReceived(t):s.onRejectReceived(t),this.calls.delete(t.call_id)):(s=Object(a.g)(this.client,e.getRoomId()),s&&(s.callId=t.call_id,s.initWithHangup(e),this.calls.set(t.call_id,s)));else if(e.getType()===r.a.CallSelectAnswer){if(!s)return;if(e.getContent().party_id===s.ourPartyId)return;s.onSelectAnswerReceived(e)}else if(e.getType()===r.a.CallNegotiate){if(!s)return;if(e.getContent().party_id===s.ourPartyId)return;s.onNegotiateReceived(e)}else if(e.getType()===r.a.CallAssertedIdentity||e.getType()===r.a.CallAssertedIdentityPrefix){if(!s)return;if(e.getContent().party_id===s.ourPartyId)return;s.onAssertedIdentityReceived(e)}}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(115),i=s.n(n),o=s(160);class a{constructor(e){this.cryptoStore=e,i()(this,"roomEncryption",{})}async init(){await this.cryptoStore.doTxn("readwrite",[o.a.STORE_ROOMS],e=>{this.cryptoStore.getEndToEndRooms(e,e=>{this.roomEncryption=e})})}getRoomEncryption(e){return this.roomEncryption[e]||null}isRoomEncrypted(e){return Boolean(this.getRoomEncryption(e))}async setRoomEncryption(e,t){this.roomEncryption[e]=t,await this.cryptoStore.doTxn("readwrite",[o.a.STORE_ROOMS],s=>{this.cryptoStore.storeEndToEndRoom(e,t,s)})}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return a})),s.d(t,"c",(function(){return r}));var n=s(0),i=s(1);const o=10;class a{constructor(e){this._db=e,this._nextTxnId=0,e.onversionchange=t=>{n.a.log(`versionchange for indexeddb ${this._dbName}: closing`),e.close()}}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return new Promise((s,i)=>{const o=this._db.transaction("outgoingRoomKeyRequests","readwrite");o.onerror=i,this._getOutgoingRoomKeyRequest(o,t,i=>{if(i)return n.a.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),void s(i);n.a.log(`enqueueing key request for ${t.room_id} / `+t.session_id),o.oncomplete=()=>{s(e)};o.objectStore("outgoingRoomKeyRequests").add(e)})})}getOutgoingRoomKeyRequest(e){return new Promise((t,s)=>{const n=this._db.transaction("outgoingRoomKeyRequests","readonly");n.onerror=s,this._getOutgoingRoomKeyRequest(n,e,e=>{t(e)})})}_getOutgoingRoomKeyRequest(e,t,s){e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]).onsuccess=e=>{const n=e.target.result;if(!n)return void s(null);const o=n.value;i.g(o.requestBody,t)?s(o):n.continue()}}getOutgoingRoomKeyRequestByState(e){if(0===e.length)return Promise.resolve(null);let t,s=0;const n=this._db.transaction("outgoingRoomKeyRequests","readonly"),i=n.objectStore("outgoingRoomKeyRequests"),o=e[s];return i.index("state").openCursor(o).onsuccess=function n(i){const o=i.target.result;if(o)return void(t=o.value);if(s++,s>=e.length)return;const a=e[s];i.target.source.openCursor(a).onsuccess=n},l(n).then(()=>t)}getAllOutgoingRoomKeyRequestsByState(e){return new Promise((t,s)=>{const n=this._db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(e);n.onsuccess=e=>t(e.target.result),n.onerror=e=>s(e.target.error)})}getOutgoingRoomKeyRequestsByTarget(e,t,s){let n=0;const i=[];const o=this._db.transaction("outgoingRoomKeyRequests","readonly"),a=o.objectStore("outgoingRoomKeyRequests"),r=s[n];return a.index("state").openCursor(r).onsuccess=function o(a){const r=a.target.result;if(r){const s=r.value;s.recipients.includes({userId:e,deviceId:t})&&i.push(s),r.continue()}else{if(n++,n>=s.length)return;const e=s[n];a.target.source.openCursor(e).onsuccess=o}},l(o).then(()=>i)}updateOutgoingRoomKeyRequest(e,t,s){let i=null;const o=this._db.transaction("outgoingRoomKeyRequests","readwrite");return o.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(e){const o=e.target.result;if(!o)return;const a=o.value;a.state==t?(Object.assign(a,s),o.update(a),i=a):n.a.warn(`Cannot update room key request from ${t} as it was already updated to `+a.state)},l(o).then(()=>i)}deleteOutgoingRoomKeyRequest(e,t){const s=this._db.transaction("outgoingRoomKeyRequests","readwrite");return s.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=e=>{const s=e.target.result;if(!s)return;const i=s.value;i.state==t?s.delete():n.a.warn(`Cannot delete room key request in state ${i.state} (expected ${t})`)},l(s)}getAccount(e,t){const s=e.objectStore("account").get("-");s.onsuccess=function(){try{t(s.result||null)}catch(t){c(e,t)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){const s=e.objectStore("account").get("crossSigningKeys");s.onsuccess=function(){try{t(s.result||null)}catch(t){c(e,t)}}}getSecretStorePrivateKey(e,t,s){const n=e.objectStore("account").get("ssss_cache:"+s);n.onsuccess=function(){try{t(n.result||null)}catch(t){c(e,t)}}}storeCrossSigningKeys(e,t){e.objectStore("account").put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,s){e.objectStore("account").put(s,"ssss_cache:"+t)}countEndToEndSessions(e,t){const s=e.objectStore("sessions").count();s.onsuccess=function(){try{t(s.result)}catch(t){c(e,t)}}}getEndToEndSessions(e,t,s){const n=t.objectStore("sessions").index("deviceKey").openCursor(e),i={};n.onsuccess=function(){const e=n.result;if(e)i[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{s(i)}catch(e){c(t,e)}}}getEndToEndSession(e,t,s,n){const i=s.objectStore("sessions").get([e,t]);i.onsuccess=function(){try{i.result?n({session:i.result.session,lastReceivedMessageTs:i.result.lastReceivedMessageTs}):n(null)}catch(e){c(s,e)}}}getAllEndToEndSessions(e,t){const s=e.objectStore("sessions").openCursor();s.onsuccess=function(){try{const e=s.result;e?(t(e.value),e.continue()):t(null)}catch(t){c(e,t)}}}storeEndToEndSession(e,t,s,n){n.objectStore("sessions").put({deviceKey:e,sessionId:t,session:s.session,lastReceivedMessageTs:s.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,s){const n=this._db.transaction("session_problems","readwrite");return n.objectStore("session_problems").put({deviceKey:e,type:t,fixed:s,time:Date.now()}),l(n)}async getEndToEndSessionProblem(e,t){let s;const n=this._db.transaction("session_problems","readwrite"),i=n.objectStore("session_problems").index("deviceKey").getAll(e);return i.onsuccess=e=>{const n=i.result;if(!n.length)return void(s=null);n.sort((e,t)=>e.time-t.time);const o=n[n.length-1];for(const e of n)if(e.time>t)return void(s=Object.assign({},e,{fixed:o.fixed}));s=o.fixed?null:o},await l(n),s}async filterOutNotifiedErrorDevices(e){const t=this._db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),s=[];return await Promise.all(e.map(e=>new Promise(n=>{const{userId:i,deviceInfo:o}=e,a=t.get([i,o.deviceId]);a.onsuccess=function(){a.result||(t.put({userId:i,deviceId:o.deviceId}),s.push(e)),n()}}))),s}getEndToEndInboundGroupSession(e,t,s,n){let i=!1,o=!1;const a=s.objectStore("inbound_group_sessions").get([e,t]);a.onsuccess=function(){try{i=a.result?a.result.session:null,!1!==o&&n(i,o)}catch(e){c(s,e)}};const r=s.objectStore("inbound_group_sessions_withheld").get([e,t]);r.onsuccess=function(){try{o=r.result?r.result.session:null,!1!==i&&n(i,o)}catch(e){c(s,e)}}}getAllEndToEndInboundGroupSessions(e,t){const s=e.objectStore("inbound_group_sessions").openCursor();s.onsuccess=function(){const n=s.result;if(n){try{t({senderKey:n.value.senderCurve25519Key,sessionId:n.value.sessionId,sessionData:n.value.session})}catch(t){c(e,t)}n.continue()}else try{t(null)}catch(t){c(e,t)}}}addEndToEndInboundGroupSession(e,t,s,i){const o=i.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:s});o.onerror=s=>{"ConstraintError"===o.error.name?(s.stopPropagation(),s.preventDefault(),n.a.log("Ignoring duplicate inbound group session: "+e+" / "+t)):c(i,new Error("Failed to add inbound group session: "+o.error))}}storeEndToEndInboundGroupSession(e,t,s,n){n.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:s})}storeEndToEndInboundGroupSessionWithheld(e,t,s,n){n.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:s})}getEndToEndDeviceData(e,t){const s=e.objectStore("device_data").get("-");s.onsuccess=function(){try{t(s.result||null)}catch(t){c(e,t)}}}storeEndToEndDeviceData(e,t){t.objectStore("device_data").put(e,"-")}storeEndToEndRoom(e,t,s){s.objectStore("rooms").put(t,e)}getEndToEndRooms(e,t){const s={},n=e.objectStore("rooms").openCursor();n.onsuccess=function(){const i=n.result;if(i)s[i.key]=i.value,i.continue();else try{t(s)}catch(t){c(e,t)}}}getSessionsNeedingBackup(e){return new Promise((t,s)=>{const n=[],i=this._db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");i.onerror=s,i.oncomplete=function(){t(n)};const o=i.objectStore("sessions_needing_backup"),a=i.objectStore("inbound_group_sessions"),r=o.openCursor();r.onsuccess=function(){const t=r.result;if(t){const s=a.get(t.key);s.onsuccess=function(){n.push({senderKey:s.result.senderCurve25519Key,sessionId:s.result.sessionId,sessionData:s.result.session})},(!e||n.length<e)&&t.continue()}}})}countSessionsNeedingBackup(e){e||(e=this._db.transaction("sessions_needing_backup","readonly"));const t=e.objectStore("sessions_needing_backup");return new Promise((e,s)=>{const n=t.count();n.onerror=s,n.onsuccess=()=>e(n.result)})}unmarkSessionsNeedingBackup(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));const s=t.objectStore("sessions_needing_backup");return Promise.all(e.map(e=>new Promise((t,n)=>{const i=s.delete([e.senderKey,e.sessionId]);i.onsuccess=t,i.onerror=n})))}markSessionsNeedingBackup(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));const s=t.objectStore("sessions_needing_backup");return Promise.all(e.map(e=>new Promise((t,n)=>{const i=s.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});i.onsuccess=t,i.onerror=n})))}addSharedHistoryInboundGroupSession(e,t,s,n){n||(n=this._db.transaction("shared_history_inbound_group_sessions","readwrite"));const i=n.objectStore("shared_history_inbound_group_sessions"),o=i.get([e]);o.onsuccess=()=>{const{sessions:n}=o.result||{sessions:[]};n.push([t,s]),i.put({roomId:e,sessions:n})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this._db.transaction("shared_history_inbound_group_sessions","readonly"));const s=t.objectStore("shared_history_inbound_group_sessions").get([e]);return new Promise((e,t)=>{s.onsuccess=()=>{const{sessions:t}=s.result||{sessions:[]};e(t)},s.onerror=t})}doTxn(e,t,s,i=n.a){const o=this._db.transaction(t,e),a=l(o),r=s(o);return a.then(()=>r)}}function r(e,t){if(n.a.log("Upgrading IndexedDBCryptoStore from version "+t+" to "+o),t<1&&function(e){const t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e),t<2&&e.createObjectStore("account"),t<3){e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")}if(t<4&&e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]}),t<5&&e.createObjectStore("device_data"),t<6&&e.createObjectStore("rooms"),t<7&&e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]}),t<8&&e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]}),t<9){e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})}t<10&&e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})}function c(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function l(e){return new Promise((t,s)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&s(e._mx_abortexception),t()},e.onerror=t=>{void 0!==e._mx_abortexception?s(e._mx_abortexception):(n.a.log("Error performing indexeddb txn",t),s(t.target.error))},e.onabort=t=>{void 0!==e._mx_abortexception?s(e._mx_abortexception):(n.a.log("Error performing indexeddb txn",t),s(t.target.error))}})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n,i=s(115),o=s.n(i),a=s(8),r=s(0),c=s(313),l=s(315),d=s(139),u=s(160),h=s(1);!function(e){e[e.NotTracked=0]="NotTracked",e[e.PendingDownload=1]="PendingDownload",e[e.DownloadInProgress=2]="DownloadInProgress",e[e.UpToDate=3]="UpToDate"}(n||(n={}));class m extends a.EventEmitter{constructor(e,t,s,n=250){super(),this.cryptoStore=t,this.keyDownloadChunkSize=n,o()(this,"devices",{}),o()(this,"crossSigningInfo",{}),o()(this,"userByIdentityKey",{}),o()(this,"deviceTrackingStatus",{}),o()(this,"syncToken",null),o()(this,"keyDownloadsInProgressByUser",{}),o()(this,"dirty",!1),o()(this,"savePromise",null),o()(this,"resolveSavePromise",null),o()(this,"savePromiseTime",null),o()(this,"saveTimer",null),o()(this,"hasFetched",null),o()(this,"serialiser",void 0),this.serialiser=new p(e,s,this)}async load(){await this.cryptoStore.doTxn("readonly",[u.a.STORE_DEVICE_DATA],e=>{this.cryptoStore.getEndToEndDeviceData(e,e=>{this.hasFetched=Boolean(e&&e.devices),this.devices=e?e.devices:{},this.crossSigningInfo=e&&e.crossSigningInfo||{},this.deviceTrackingStatus=e?e.trackingStatus:{},this.syncToken=e?e.syncToken:null,this.userByIdentityKey={};for(const e of Object.keys(this.devices)){const t=this.devices[e];for(const s of Object.keys(t)){const n=t[s].keys["curve25519:"+s];void 0!==n&&(this.userByIdentityKey[n]=e)}}})});for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]==n.DownloadInProgress&&(this.deviceTrackingStatus[e]=n.PendingDownload)}stop(){null!==this.saveTimer&&clearTimeout(this.saveTimer)}async saveIfDirty(e=500){if(!this.dirty)return Promise.resolve(!1);const t=Date.now()+e;this.savePromiseTime&&t<this.savePromiseTime&&(clearTimeout(this.saveTimer),this.saveTimer=null,this.savePromiseTime=null);let s=this.savePromise;if(null===s&&(s=new Promise((e,t)=>{this.resolveSavePromise=e}),this.savePromise=s),null===this.saveTimer){const s=this.resolveSavePromise;this.savePromiseTime=t,this.saveTimer=setTimeout(()=>{r.a.log("Saving device tracking data",this.syncToken),this.savePromiseTime=null,this.saveTimer=null,this.savePromise=null,this.resolveSavePromise=null,this.cryptoStore.doTxn("readwrite",[u.a.STORE_DEVICE_DATA],e=>{this.cryptoStore.storeEndToEndDeviceData({devices:this.devices,crossSigningInfo:this.crossSigningInfo,trackingStatus:this.deviceTrackingStatus,syncToken:this.syncToken},e)}).then(()=>{this.dirty=!1,s(!0)},e=>{r.a.error("Failed to save device tracking data",this.syncToken),r.a.error(e)})},e)}return s}getSyncToken(){return this.syncToken}setSyncToken(e){this.syncToken=e}downloadKeys(e,t){const s=[],i=[];if(e.forEach(e=>{const o=this.deviceTrackingStatus[e];this.keyDownloadsInProgressByUser[e]?(r.a.log("downloadKeys: already have a download in progress for "+e+": awaiting its result"),i.push(this.keyDownloadsInProgressByUser[e])):(t||o!=n.UpToDate)&&s.push(e)}),0!=s.length){r.a.log("downloadKeys: downloading for",s);const e=this.doKeyDownload(s);i.push(e)}return 0===i.length&&r.a.log("downloadKeys: already have all necessary keys"),Promise.all(i).then(()=>this.getDevicesFromStore(e))}getDevicesFromStore(e){const t={};return e.map(e=>{t[e]={};(this.getStoredDevicesForUser(e)||[]).map((function(s){t[e][s.deviceId]=s}))}),t}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(e){const t=this.devices[e];if(!t)return null;const s=[];for(const e in t)t.hasOwnProperty(e)&&s.push(c.a.fromStorage(t[e],e));return s}getRawStoredDevicesForUser(e){return this.devices[e]}getStoredCrossSigningForUser(e){return this.crossSigningInfo[e]?l.a.fromStorage(this.crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this.crossSigningInfo[e]=t,this.dirty=!0}getStoredDevice(e,t){const s=this.devices[e];if(s&&s[t])return c.a.fromStorage(s[t],t)}getUserByIdentityKey(e,t){return e!==d.OLM_ALGORITHM&&e!==d.MEGOLM_ALGORITHM?null:this.userByIdentityKey[t]}getDeviceByIdentityKey(e,t){const s=this.getUserByIdentityKey(e,t);if(!s)return null;const n=this.devices[s];if(!n)return null;for(const e in n){if(!n.hasOwnProperty(e))continue;const s=n[e];for(const n in s.keys){if(!s.keys.hasOwnProperty(n))continue;if(0!==n.indexOf("curve25519:"))continue;if(s.keys[n]==t)return c.a.fromStorage(s,e)}}return null}storeDevicesForUser(e,t){if(void 0!==this.devices[e])for(const[t,s]of Object.entries(this.devices[e])){const e=s.keys["curve25519:"+t];delete this.userByIdentityKey[e]}this.devices[e]=t;for(const[s,n]of Object.entries(t)){const t=n.keys["curve25519:"+s];this.userByIdentityKey[t]=e}this.dirty=!0}startTrackingDeviceList(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this.deviceTrackingStatus[e]||(r.a.log("Now tracking device list for "+e),this.deviceTrackingStatus[e]=n.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(e){this.deviceTrackingStatus[e]&&(r.a.log("No longer tracking device list for "+e),this.deviceTrackingStatus[e]=n.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]=n.NotTracked;this.dirty=!0}invalidateUserDeviceList(e){this.deviceTrackingStatus[e]&&(r.a.log("Marking device list outdated for",e),this.deviceTrackingStatus[e]=n.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const e=[];for(const t of Object.keys(this.deviceTrackingStatus)){this.deviceTrackingStatus[t]==n.PendingDownload&&e.push(t)}return this.doKeyDownload(e)}setRawStoredDevicesForUser(e,t){if(void 0!==this.devices[e])for(const[t,s]of Object.entries(this.devices[e])){const e=s.keys["curve25519:"+t];delete this.userByIdentityKey[e]}this.devices[e]=t;for(const[s,n]of Object.entries(t)){const t=n.keys["curve25519:"+s];this.userByIdentityKey[t]=e}}setRawStoredCrossSigningForUser(e,t){this.crossSigningInfo[e]=t}doKeyDownload(e){if(0===e.length)return Promise.resolve();const t=this.serialiser.updateDevicesForUsers(e,this.syncToken).then(()=>{s(!0)},t=>{throw r.a.error("Error downloading keys for "+e+":",t),s(!1),t});e.forEach(e=>{this.keyDownloadsInProgressByUser[e]=t;this.deviceTrackingStatus[e]==n.PendingDownload&&(this.deviceTrackingStatus[e]=n.DownloadInProgress)});const s=s=>{this.emit("crypto.willUpdateDevices",e,!this.hasFetched),e.forEach(e=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser[e]!==t)return void r.a.log("Another update in the queue for",e,"- not marking up-to-date");delete this.keyDownloadsInProgressByUser[e];this.deviceTrackingStatus[e]==n.DownloadInProgress&&(s?(this.deviceTrackingStatus[e]=n.UpToDate,r.a.log("Device list for",e,"now up to date")):this.deviceTrackingStatus[e]=n.PendingDownload)}),this.saveIfDirty(),this.emit("crypto.devicesUpdated",e,!this.hasFetched),this.hasFetched=!0};return t}}class p{constructor(e,t,s){this.baseApis=e,this.olmDevice=t,this.deviceList=s,o()(this,"downloadInProgress",!1),o()(this,"keyDownloadsQueuedByUser",{}),o()(this,"queuedQueryDeferred",null),o()(this,"syncToken",null)}updateDevicesForUsers(e,t){return e.forEach(e=>{this.keyDownloadsQueuedByUser[e]=!0}),this.queuedQueryDeferred||(this.queuedQueryDeferred=Object(h.j)()),this.syncToken=t,this.downloadInProgress?(r.a.log("Queued key download for",e),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){if(this.downloadInProgress)throw new Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");const e=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};const t=this.queuedQueryDeferred;this.queuedQueryDeferred=null,r.a.log("Starting key download for",e),this.downloadInProgress=!0;const s={};this.syncToken&&(s.token=this.syncToken);const n=[];for(let t=0;t<e.length;t+=this.deviceList.keyDownloadChunkSize){const i=e.slice(t,t+this.deviceList.keyDownloadChunkSize);n.push(()=>this.baseApis.downloadKeysForUsers(i,s))}return Object(h.f)(n,3).then(async t=>{const s=Object.assign({},...t.map(e=>e.device_keys||{})),n=Object.assign({},...t.map(e=>e.master_keys||{})),i=Object.assign({},...t.map(e=>e.self_signing_keys||{})),o=Object.assign({},...t.map(e=>e.user_signing_keys||{}));for(const t of e){await Object(h.F)(5);try{await this.processQueryResponseForUser(t,s[t],{master:n[t],self_signing:i[t],user_signing:o[t]})}catch(e){r.a.error(`Error processing keys for ${t}:`,e)}}}).then(()=>{r.a.log("Completed key download for "+e),this.downloadInProgress=!1,t.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()},s=>{r.a.warn("Error downloading keys for "+e+":",s),this.downloadInProgress=!1,t.reject(s)}),t.promise}async processQueryResponseForUser(e,t,s){r.a.log("got device keys for "+e+":",t),r.a.log("got cross-signing keys for "+e+":",s);{const s={},n=this.deviceList.getRawStoredDevicesForUser(e);n&&Object.keys(n).forEach(e=>{const t=c.a.fromStorage(n[e],e);s[e]=t}),await async function(e,t,s,n,i,o){let a=!1;for(const e in s)if(s.hasOwnProperty(e)&&!(e in n)){if(t===i&&e===o){r.a.warn(`Local device ${e} missing from sync, skipping removal`);continue}r.a.log("Device "+t+":"+e+" has been removed"),delete s[e],a=!0}for(const i in n){if(!n.hasOwnProperty(i))continue;const o=n[i];o.user_id===t?o.device_id===i?await g(e,s,o)&&(a=!0):r.a.warn("Mismatched device_id "+o.device_id+" in keys from "+t+":"+i):r.a.warn("Mismatched user_id "+o.user_id+" in keys from "+t+":"+i)}return a}(this.olmDevice,e,s,t||{},this.baseApis.getUserId(),this.baseApis.deviceId);const i={};Object.keys(s).forEach(e=>{i[e]=s[e].toStorage()}),this.deviceList.setRawStoredDevicesForUser(e,i)}if(s&&(s.master||s.self_signing||s.user_signing)){const t=this.deviceList.getStoredCrossSigningForUser(e)||new l.a(e);t.setKeys(s),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage()),this.deviceList.emit("userCrossSigningUpdated",e)}}}async function g(e,t,s){if(!s.keys)return!1;const n=s.device_id,i=s.user_id,o="ed25519:"+n,a=s.keys[o];if(!a)return r.a.warn("Device "+i+":"+n+" has no ed25519 key"),!1;const l=s.unsigned||{},u=s.signatures||{};try{await d.verifySignature(e,s,i,n,a)}catch(e){return r.a.warn("Unable to verify signature on device "+i+":"+n+":"+e),!1}let h;if(n in t){if(h=t[n],h.getFingerprint()!=a)return r.a.warn("Ed25519 key for device "+i+":"+n+" has changed"),!1}else t[n]=h=new c.a(n);return h.keys=s.keys||{},h.algorithms=s.algorithms||[],h.unsigned=l,h.signatures=u,!0}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(0),i=s(114),o=s(8),a=s(315),r=s(160),c=s(271);class l{constructor(e,t){this.accountDataClientAdapter=new u(e),this.crossSigningCallbacks=new h,this.ssssCryptoCallbacks=new m(t),this._crossSigningKeys=null,this._keySignatures=null,this._keyBackupInfo=null}addCrossSigningKeys(e,t){this._crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this._keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this._sessionBackupPrivateKey=e}addKeySignature(e,t,s){this._keySignatures||(this._keySignatures={});const n=this._keySignatures[e]||{};this._keySignatures[e]=n,n[t]=s}setAccountData(e,t){return this.accountDataClientAdapter.setAccountData(e,t)}buildOperation(){const e=this.accountDataClientAdapter._values;return new d(e,this._crossSigningKeys,this._keyBackupInfo,this._keySignatures)}async persist(e){if(this._crossSigningKeys){const t=Object(a.d)(e.cryptoStore,e.olmDevice);for(const e of["master","self_signing","user_signing"]){n.a.log(`Cache ${e} cross-signing private key locally`);const s=this.crossSigningCallbacks.privateKeys.get(e);await t.storeCrossSigningKeyCache(e,s)}await e.cryptoStore.doTxn("readwrite",[r.a.STORE_ACCOUNT],t=>{e.cryptoStore.storeCrossSigningKeys(t,this._crossSigningKeys.keys)})}this._sessionBackupPrivateKey&&await e.storeSessionBackupPrivateKey(this._sessionBackupPrivateKey)}}class d{constructor(e,t,s,n){this._accountData=e,this._crossSigningKeys=t,this._keyBackupInfo=s,this._keySignatures=n}async apply(e){const t=e.baseApis;if(this._crossSigningKeys){const s={};for(const[e,t]of Object.entries(this._crossSigningKeys.keys))s[e+"_key"]=t;await this._crossSigningKeys.authUpload(e=>t.uploadDeviceSigningKeys(e,s)),e.crossSigningInfo.setKeys(this._crossSigningKeys.keys)}if(this._accountData)for(const[e,s]of this._accountData)await t.setAccountData(e,s);this._keySignatures&&await t.uploadKeySignatures(this._keySignatures),this._keyBackupInfo&&(this._keyBackupInfo.version?await t.http.authedRequest(void 0,"PUT","/room_keys/version/"+this._keyBackupInfo.version,void 0,{algorithm:this._keyBackupInfo.algorithm,auth_data:this._keyBackupInfo.auth_data},{prefix:c.i}):await t.http.authedRequest(void 0,"POST","/room_keys/version",void 0,this._keyBackupInfo,{prefix:c.i}))}}class u extends o.EventEmitter{constructor(e){super(),this._existingValues=e,this._values=new Map}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){const t=this._values.get(e);if(t)return t;const s=this._existingValues[e];return s?s.getContent():null}setAccountData(e,t){const s=this._values.get(e);return this._values.set(e,t),Promise.resolve().then(()=>{const n=new i.b({type:e,content:t});this.emit("accountData",n,s)})}}class h{constructor(){this.privateKeys=new Map}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){return Promise.resolve(this.privateKeys.get(e))}saveCrossSigningKeys(e){for(const[t,s]of Object.entries(e))this.privateKeys.set(t,s)}}class m{constructor(e){this._privateKeys=new Map,this._delegateCryptoCallbacks=e}async getSecretStorageKey({keys:e},t){for(const t of Object.keys(e)){const e=this._privateKeys.get(t);if(e)return[t,e]}if(this._delegateCryptoCallbacks){const s=await this._delegateCryptoCallbacks.getSecretStorageKey({keys:e},t);if(s){const[e,t]=s;this._privateKeys.set(e,t)}return s}}addPrivateKey(e,t,s){this._privateKeys.set(e,s),this._delegateCryptoCallbacks&&this._delegateCryptoCallbacks.cacheSecretStorageKey&&this._delegateCryptoCallbacks.cacheSecretStorageKey(e,t,s)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(8),i=s(0),o=s(139),a=s(186),r=s(274);const c="m.secret_storage.v1.aes-hmac-sha2";class l extends n.EventEmitter{constructor(e,t){super(),this._baseApis=e,this._cryptoCallbacks=t,this._requests={},this._incomingRequests={}}async getDefaultKeyId(){const e=await this._baseApis.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise(async(t,s)=>{const n=s=>{"m.secret_storage.default_key"===s.getType()&&s.getContent().key===e&&(this._baseApis.removeListener("accountData",n),t())};this._baseApis.on("accountData",n);try{await this._baseApis.setAccountData("m.secret_storage.default_key",{key:e})}catch(e){this._baseApis.removeListener("accountData",n),s(e)}})}async addKey(e,t,s){const n={algorithm:e};if(t||(t={}),t.name&&(n.name=t.name),e!==c)throw new Error("Unknown key algorithm "+t.algorithm);if(t.passphrase&&(n.passphrase=t.passphrase),t.key){const{iv:e,mac:s}=await l._calculateKeyCheck(t.key);n.iv=e,n.mac=s}if(!s)do{s=Object(a.b)(32)}while(await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+s));return await this._baseApis.setAccountData("m.secret_storage.key."+s,n),{keyId:s,keyInfo:n}}async getKey(e){if(e||(e=await this.getDefaultKeyId()),!e)return null;const t=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e);return t?[e,t]:null}async hasKey(e){return!!await this.getKey(e)}async checkKey(e,t){if(t.algorithm===c){if(t.mac){const{mac:s}=await l._calculateKeyCheck(e,t.iv);return t.mac.replace(/=+$/g,"")===s.replace(/=+$/g,"")}return!0}throw new Error("Unknown algorithm")}static async _calculateKeyCheck(e,t){return await Object(r.b)("\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",e,"",t)}async store(e,t,s){const n={};if(!s){const e=await this.getDefaultKeyId();if(!e)throw new Error("No keys specified and no default key present");s=[e]}if(0===s.length)throw new Error("Zero keys given to encrypt with!");for(const o of s){const s=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+o);if(!s)throw new Error("Unknown key: "+o);if(s.algorithm===c){const i={[o]:s},[,a]=await this._getSecretStorageKey(i,e);n[o]=await a.encrypt(t)}else i.a.warn("unknown algorithm for secret storage key "+o+": "+s.algorithm)}await this._baseApis.setAccountData(e,{encrypted:n})}async _fixupStoredSecret(e,t){const s=Object.keys(t);if(1===s.length&&"encrypted"!==s[0]&&t[s[0]].passthrough){if(await this.hasKey(s[0])){i.a.log("Fixing up passthrough secret: "+e),await this.storePassthrough(e,s[0]);return await this._baseApis.getAccountDataFromServer(e)}}return null}async get(e){let t=await this._baseApis.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted&&(t=await this._fixupStoredSecret(e,t),!t||!t.encrypted))throw new Error("Content is not encrypted!");const s={};for(const e of Object.keys(t.encrypted)){const n=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e),i=t.encrypted[e];n.algorithm===c&&i.iv&&i.ciphertext&&i.mac&&(s[e]=n)}if(0===Object.keys(s).length)throw new Error(`Could not decrypt ${e} because none of the keys it is encrypted with are for a supported algorithm`);let n,i;try{[n,i]=await this._getSecretStorageKey(s,e);const a=t.encrypted[n];return a.passthrough?Object(o.encodeBase64)(i.get_private_key()):await i.decrypt(a)}finally{i&&i.free&&i.free()}}async isStored(e,t){let s=await this._baseApis.getAccountDataFromServer(e);if(!s)return null;if(!s.encrypted&&(s=await this._fixupStoredSecret(e,s),!s||!s.encrypted))return null;void 0===t&&(t=!0);const n={};for(const e of Object.keys(s.encrypted)){const t=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e);if(!t)continue;const i=s.encrypted[e];t.algorithm===c&&i.iv&&i.ciphertext&&i.mac&&(n[e]=t)}return Object.keys(n).length?n:null}request(e,t){const s=this._baseApis.makeTxnId(),n=this._requests[s]={name:e,devices:t},o=new Promise((e,t)=>{n.resolve=e,n.reject=t}),a={name:e,action:"request",requesting_device_id:this._baseApis.deviceId,request_id:s},r={};for(const e of t)r[e]=a;return i.a.info(`Request secret ${e} from ${t}, id ${s}`),this._baseApis.sendToDevice("m.secret.request",{[this._baseApis.getUserId()]:r}),{request_id:s,promise:o,cancel:e=>{const i={action:"request_cancellation",requesting_device_id:this._baseApis.deviceId,request_id:s},o={};for(const e of t)o[e]=i;this._baseApis.sendToDevice("m.secret.request",{[this._baseApis.getUserId()]:o}),n.reject(new Error(e||"Cancelled"))}}}async _onRequestReceived(e){const t=e.getSender(),s=e.getContent();if(t!==this._baseApis.getUserId()||!(s.name&&s.action&&s.requesting_device_id&&s.request_id))return;const n=s.requesting_device_id;if("request_cancellation"===s.action)this._incomingRequests[n]&&this._incomingRequests[n][s.request_id]&&(i.a.info("received request cancellation for secret ("+t+", "+n+", "+s.request_id+")"),this._baseApis.emit("crypto.secrets.requestCancelled",{user_id:t,device_id:n,request_id:s.request_id}));else if("request"===s.action){if(n===this._baseApis.deviceId)return;if(i.a.info("received request for secret ("+t+", "+n+", "+s.request_id+")"),!this._cryptoCallbacks.onSecretRequested)return;const e=await this._cryptoCallbacks.onSecretRequested(t,n,s.request_id,s.name,this._baseApis.checkDeviceTrust(t,n));if(e){i.a.info(`Preparing ${s.name} secret for ${n}`);const a={type:"m.secret.send",content:{request_id:s.request_id,secret:e}},r={algorithm:o.OLM_ALGORITHM,sender_key:this._baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{}};await o.ensureOlmSessionsForDevices(this._baseApis.crypto.olmDevice,this._baseApis,{[t]:[this._baseApis.getStoredDevice(t,n)]}),await o.encryptMessageForDevice(r.ciphertext,this._baseApis.getUserId(),this._baseApis.deviceId,this._baseApis.crypto.olmDevice,t,this._baseApis.getStoredDevice(t,n),a);const c={[t]:{[n]:r}};i.a.info(`Sending ${s.name} secret for ${n}`),this._baseApis.sendToDevice("m.room.encrypted",c)}else i.a.info(`Request denied for ${s.name} secret for ${n}`)}}_onSecretReceived(e){if(e.getSender()!==this._baseApis.getUserId())return;const t=e.getContent();i.a.log("got secret share for request",t.request_id);const s=this._requests[t.request_id];if(s){const n=this._baseApis.crypto.deviceList.getDeviceByIdentityKey(o.OLM_ALGORITHM,e.getSenderKey());if(!n)return void i.a.log("secret share from unknown device with key",e.getSenderKey());if(!s.devices.includes(n.deviceId))return void i.a.log("unsolicited secret share from device",n.deviceId);i.a.log(`Successfully received secret ${s.name} from `+n.deviceId),s.resolve(t.secret)}}async _getSecretStorageKey(e,t){if(!this._cryptoCallbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const s=await this._cryptoCallbacks.getSecretStorageKey({keys:e},t);if(!s)throw new Error("getSecretStorageKey callback returned falsey");if(s.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[n,i]=s;if(!e[n])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[n].algorithm===c){return[n,{encrypt:async function(e){return await Object(r.b)(e,i,t)},decrypt:async function(e){return await Object(r.a)(e,i,t)}}]}throw new Error("Unknown key type: "+e[n].algorithm)}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return c}));var n=s(0);const i=0,o=1,a=2,r=3;class c{constructor(e,t,s){this._baseApis=e,this._deviceId=t,this._cryptoStore=s,this._sendOutgoingRoomKeyRequestsTimer=null,this._sendOutgoingRoomKeyRequestsRunning=!1,this._clientRunning=!1}start(){this._clientRunning=!0}stop(){n.a.log("stopping OutgoingRoomKeyRequestManager"),this._clientRunning=!1}sendQueuedRequests(){this._startTimer()}async queueRoomKeyRequest(e,t,s=!1){const c=await this._cryptoStore.getOutgoingRoomKeyRequest(e);if(c)switch(c.state){case r:case i:return;case a:{const e=s?r:o;await this._cryptoStore.updateOutgoingRoomKeyRequest(c.requestId,a,{state:e,cancellationTxnId:this._baseApis.makeTxnId()});break}case o:if(s){const i=r,a=await this._cryptoStore.updateOutgoingRoomKeyRequest(c.requestId,o,{state:i,cancellationTxnId:this._baseApis.makeTxnId(),requestTxnId:this._baseApis.makeTxnId()});if(!a)return await this.queueRoomKeyRequest(e,t,s);try{await this._sendOutgoingRoomKeyRequestCancellation(a,!0)}catch(e){n.a.error("Error sending room key request cancellation; will retry later.",e)}}break;default:throw new Error("unhandled state: "+c.state)}else await this._cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this._baseApis.makeTxnId(),state:i})}cancelRoomKeyRequest(e){return this._cryptoStore.getOutgoingRoomKeyRequest(e).then(t=>{if(t)switch(t.state){case a:case r:return;case i:return n.a.log("deleting unnecessary room key request for "+l(e)),this._cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,i);case o:return this._cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,o,{state:a,cancellationTxnId:this._baseApis.makeTxnId()}).then(t=>{t?this._sendOutgoingRoomKeyRequestCancellation(t).catch(e=>{n.a.error("Error sending room key request cancellation; will retry later.",e),this._startTimer()}):n.a.log("Tried to cancel room key request for "+l(e)+" but it was already cancelled in another tab")});default:throw new Error("unhandled state: "+t.state)}})}getOutgoingSentRoomKeyRequest(e,t){return this._cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[o])}async cancelAndResendAllOutgoingRequests(){const e=await this._cryptoStore.getAllOutgoingRoomKeyRequestsByState(o);return Promise.all(e.map(({requestBody:e,recipients:t})=>this.queueRoomKeyRequest(e,t,!0)))}_startTimer(){if(this._sendOutgoingRoomKeyRequestsTimer)return;this._sendOutgoingRoomKeyRequestsTimer=e.setTimeout(()=>{if(this._sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this._sendOutgoingRoomKeyRequestsRunning=!0,this._sendOutgoingRoomKeyRequests().finally(()=>{this._sendOutgoingRoomKeyRequestsRunning=!1}).catch(e=>{n.a.warn("error in OutgoingRoomKeyRequestManager: "+e)})},500)}_sendOutgoingRoomKeyRequests(){return this._clientRunning?this._cryptoStore.getOutgoingRoomKeyRequestByState([a,r,i]).then(e=>{if(!e)return void(this._sendOutgoingRoomKeyRequestsTimer=null);let t;switch(e.state){case i:t=this._sendOutgoingRoomKeyRequest(e);break;case a:t=this._sendOutgoingRoomKeyRequestCancellation(e);break;case r:t=this._sendOutgoingRoomKeyRequestCancellation(e,!0)}return t.then(()=>this._sendOutgoingRoomKeyRequests()).catch(e=>{n.a.error("Error sending room key request; will retry later.",e),this._sendOutgoingRoomKeyRequestsTimer=null})}):(this._sendOutgoingRoomKeyRequestsTimer=null,Promise.resolve())}_sendOutgoingRoomKeyRequest(e){n.a.log("Requesting keys for "+l(e.requestBody)+" from "+d(e.recipients)+`(id ${e.requestId})`);const t={action:"request",requesting_device_id:this._deviceId,request_id:e.requestId,body:e.requestBody};return this._sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then(()=>this._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,i,{state:o}))}_sendOutgoingRoomKeyRequestCancellation(e,t){n.a.log("Sending cancellation for key request for "+l(e.requestBody)+" to "+d(e.recipients)+" "+`(cancellation id ${e.cancellationTxnId})`);const s={action:"request_cancellation",requesting_device_id:this._deviceId,request_id:e.requestId};return this._sendMessageToDevices(s,e.recipients,e.cancellationTxnId).then(()=>t?this._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,r,{state:i}):this._cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,a))}_sendMessageToDevices(e,t,s){const n={};for(const s of t)n[s.userId]||(n[s.userId]={}),n[s.userId][s.deviceId]=e;return this._baseApis.sendToDevice("m.room_key_request",n,s)}}function l(e){return e.room_id+" / "+e.session_id}function d(e){return"["+e.map(e=>`${e.userId}:${e.deviceId}`).join(",")+"]"}}).call(this,s(7))},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return I}));var n=s(391),i=s(311),o=s.n(i),a=s(276),r=s(0);const c="m.key.verification.start",l=["m.key.verification.accept","m.key.verification.key","m.key.verification.mac"];let d;const u=Object(a.a)("m.mismatched_sas","Mismatched short authentication string"),h=Object(a.a)("m.mismatched_commitment","Mismatched commitment");const m=[["🐶","dog"],["🐱","cat"],["🦁","lion"],["🐎","horse"],["🦄","unicorn"],["🐷","pig"],["🐘","elephant"],["🐰","rabbit"],["🐼","panda"],["🐓","rooster"],["🐧","penguin"],["🐢","turtle"],["🐟","fish"],["🐙","octopus"],["🦋","butterfly"],["🌷","flower"],["🌳","tree"],["🌵","cactus"],["🍄","mushroom"],["🌏","globe"],["🌙","moon"],["☁️","cloud"],["🔥","fire"],["🍌","banana"],["🍎","apple"],["🍓","strawberry"],["🌽","corn"],["🍕","pizza"],["🎂","cake"],["❤️","heart"],["🙂","smiley"],["🤖","robot"],["🎩","hat"],["👓","glasses"],["🔧","spanner"],["🎅","santa"],["👍","thumbs up"],["☂️","umbrella"],["⌛","hourglass"],["⏰","clock"],["🎁","gift"],["💡","light bulb"],["📕","book"],["✏️","pencil"],["📎","paperclip"],["✂️","scissors"],["🔒","lock"],["🔑","key"],["🔨","hammer"],["☎️","telephone"],["🏁","flag"],["🚂","train"],["🚲","bicycle"],["✈️","aeroplane"],["🚀","rocket"],["🏆","trophy"],["⚽","ball"],["🎸","guitar"],["🎺","trumpet"],["🔔","bell"],["⚓️","anchor"],["🎧","headphones"],["📁","folder"],["📌","pin"]];const p={decimal:function(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]},emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map(e=>m[e])}};function g(e,t){const s={};for(const n of t)n in p&&(s[n]=p[n](e));return s}const v={"hkdf-hmac-sha256":"calculate_mac","hmac-sha256":"calculate_mac_long_kdf"};function f(e,t){return function(...s){const n=e[v[t]].apply(e,s);return r.a.log("SAS calculateMAC:",t,s,n),n}}const b={"curve25519-hkdf-sha256":function(e,t,s){const n=`${e._baseApis.getUserId()}|${e._baseApis.deviceId}|`+e.ourSASPubKey+"|",i=`${e.userId}|${e.deviceId}|${e.theirSASPubKey}|`,o="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?n+i:i+n)+e._channel.transactionId;return t.generate_bytes(o,s)},curve25519:function(e,t,s){const n=`${e._baseApis.getUserId()}${e._baseApis.deviceId}`,i=`${e.userId}${e.deviceId}`,o="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?n+i:i+n)+e._channel.transactionId;return t.generate_bytes(o,s)}},y=["curve25519-hkdf-sha256","curve25519"],_=["sha256"],E=["hkdf-hmac-sha256","hmac-sha256"],S=Object.keys(p),w=new Set(y),C=new Set(_),k=new Set(E),O=new Set(S);function R(e,t){return e instanceof Array?e.filter(e=>t.has(e)):[]}class I extends n.b{static get NAME(){return"m.sas.v1"}get events(){return l}async _doVerification(){await e.Olm.init(),d=d||new e.Olm.Utility,await this._baseApis.downloadKeys([this.userId]);let t=!1;do{try{return this.initiatedByMe?await this._doSendVerification():await this._doRespondVerification()}catch(e){if(!(e instanceof n.a))throw e;this.startEvent=e.startEvent,t=!0}}while(t)}canSwitchStartEvent(e){if(e.getType()!==c)return!1;const t=e.getContent();return t&&t.method===I.NAME&&this._waitingForAccept}async _sendStart(){const e=this._channel.completeContent(c,{method:I.NAME,from_device:this._baseApis.deviceId,key_agreement_protocols:y,hashes:_,message_authentication_codes:E,short_authentication_string:S});return await this._channel.sendCompleted(c,e),e}async _doSendVerification(){let t,s;if(this._waitingForAccept=!0,t=this.startEvent?this._channel.completedContentFromEvent(this.startEvent):await this._sendStart(),!this.initiatedByMe)throw new n.a(this.startEvent);try{s=await this._waitForEvent("m.key.verification.accept")}finally{this._waitingForAccept=!1}let i=s.getContent();const r=R(i.short_authentication_string,O);if(!(w.has(i.key_agreement_protocol)&&C.has(i.hash)&&k.has(i.message_authentication_code)&&r.length))throw Object(a.g)();if("string"!=typeof i.commitment)throw Object(a.c)();const c=i.key_agreement_protocol,l=i.message_authentication_code,m=i.commitment,p=new e.Olm.SAS;try{this.ourSASPubKey=p.get_pubkey(),await this._send("m.key.verification.key",{key:this.ourSASPubKey}),s=await this._waitForEvent("m.key.verification.key"),i=s.getContent();const e=i.key+o.a.stringify(t);if(d.sha256(e)!==m)throw h();this.theirSASPubKey=i.key,p.set_their_key(i.key);const n=b[c](this,p,6),v=new Promise((e,t)=>{this.sasEvent={sas:g(n,r),confirm:async()=>{try{await this._sendMAC(p,l),e()}catch(e){t(e)}},cancel:()=>t(Object(a.h)()),mismatch:()=>t(u())},this.emit("show_sas",this.sasEvent)});[s]=await Promise.all([this._waitForEvent("m.key.verification.mac").then(e=>(this._expectedEvent="m.key.verification.done",e)),v]),i=s.getContent(),await this._checkMAC(p,i,l)}finally{p.free()}}async _doRespondVerification(){let t=this._channel.completedContentFromEvent(this.startEvent);const s=R(y,new Set(t.key_agreement_protocols))[0],n=R(_,new Set(t.hashes))[0],i=R(E,new Set(t.message_authentication_codes))[0],r=R(t.short_authentication_string,O);if(void 0===s||void 0===n||void 0===i||!r.length)throw Object(a.g)();const c=new e.Olm.SAS;try{const e=c.get_pubkey()+o.a.stringify(t);await this._send("m.key.verification.accept",{key_agreement_protocol:s,hash:n,message_authentication_code:i,short_authentication_string:r,commitment:d.sha256(e)});let l=await this._waitForEvent("m.key.verification.key");t=l.getContent(),this.theirSASPubKey=t.key,c.set_their_key(t.key),this.ourSASPubKey=c.get_pubkey(),await this._send("m.key.verification.key",{key:this.ourSASPubKey});const h=b[s](this,c,6),m=new Promise((e,t)=>{this.sasEvent={sas:g(h,r),confirm:async()=>{try{await this._sendMAC(c,i),e()}catch(e){t(e)}},cancel:()=>t(Object(a.h)()),mismatch:()=>t(u())},this.emit("show_sas",this.sasEvent)});[l]=await Promise.all([this._waitForEvent("m.key.verification.mac").then(e=>(this._expectedEvent="m.key.verification.done",e)),m]),t=l.getContent(),await this._checkMAC(c,t,i)}finally{c.free()}}_sendMAC(e,t){const s={},n=[],i="MATRIX_KEY_VERIFICATION_MAC"+this._baseApis.getUserId()+this._baseApis.deviceId+this.userId+this.deviceId+this._channel.transactionId,o="ed25519:"+this._baseApis.deviceId;s[o]=f(e,t)(this._baseApis.getDeviceEd25519Key(),i+o),n.push(o);const a=this._baseApis.getCrossSigningId();if(a){const o="ed25519:"+a;s[o]=f(e,t)(a,i+o),n.push(o)}const r=f(e,t)(n.sort().join(","),i+"KEY_IDS");return this._send("m.key.verification.mac",{mac:s,keys:r})}async _checkMAC(e,t,s){const n="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this._baseApis.getUserId()+this._baseApis.deviceId+this._channel.transactionId;if(t.keys!==f(e,s)(Object.keys(t.mac).sort().join(","),n+"KEY_IDS"))throw Object(a.d)();await this._verifyKeys(this.userId,t.mac,(t,i,o)=>{if(o!==f(e,s)(i.keys[t],n+t))throw Object(a.d)()})}}}).call(this,s(7))},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return a}));var n=s(216),i=s(0);class o{constructor(e,t,s=null){this._client=e,this._roomId=t,this.userId=s,this._requestEventId=null}get receiveStartFromOtherDevices(){return!0}get roomId(){return this._roomId}get transactionId(){return this._requestEventId}static getOtherPartyUserId(e,t){if(o.getEventType(e)!==n.i)return;const s=t.getUserId(),i=e.getSender(),a=e.getContent().to;return i===s?a:a===s?i:void 0}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===n.i}static getTransactionId(e){if(o.getEventType(e)===n.i)return e.getId();{const t=e.getRelation();if(t&&"m.reference"===t.rel_type)return t.event_id}}static validateEvent(e,t){const s=o.getTransactionId(e);if("string"!=typeof s||0===s.length)return!1;const a=o.getEventType(e),r=e.getContent();if(a===n.i){if(!r||"string"!=typeof r.to||!r.to.length)return i.a.log("InRoomChannel: validateEvent: no valid to "+(r&&r.to)),!1;if(!o.getOtherPartyUserId(e,t))return i.a.log("InRoomChannel: validateEvent: not directed to or sent by me: "+e.getSender()+", "+(r&&r.to)),!1}return n.k.validateEvent(a,e,t)}static getEventType(e){const t=e.getType();if("m.room.message"===t){const t=e.getContent();if(t){const{msgtype:e}=t;if(e===n.i)return n.i}}return t&&t!==n.i?t:""}async handleEvent(e,t,s){if(t.hasEventId(e.getId()))return;const n=o.getEventType(e);if(e.getRoomId()!==this._roomId)return;if(null===this.userId){const t=o.getOtherPartyUserId(e,this._client);t&&(this.userId=t)}const a=this._client.getUserId(),r=e.getSender();if(null!==this.userId&&r!==a&&r!==this.userId)return void i.a.log("InRoomChannel: ignoring verification event from non-participating sender "+r);null===this._requestEventId&&(this._requestEventId=o.getTransactionId(e));const c=!!e.getUnsigned().transaction_id,l=e.getSender()===this._client.getUserId();return await t.handleEvent(n,e,s,c,l)}completedContentFromEvent(e){const t=Object.assign({},e.getContent());return t["m.relates_to"]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),e!==n.i&&e!==n.h&&e!==n.j||(t.from_device=this._client.getDeviceId()),e===n.i?t={body:this._client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:n.i,to:this.userId,from_device:t.from_device,methods:t.methods}:t["m.relates_to"]={rel_type:"m.reference",event_id:this.transactionId},t}send(e,t){const s=this.completeContent(e,t);return this.sendCompleted(e,s)}async sendCompleted(e,t){let s=e;e===n.i&&(s="m.room.message");const i=await this._client.sendEvent(this._roomId,s,t);e===n.i&&(this._requestEventId=i.event_id)}}class a{constructor(){this._requestsByRoomId=new Map}getRequest(e){const t=e.getRoomId(),s=o.getTransactionId(e);return this._getRequestByTxnId(t,s)}getRequestByChannel(e){return this._getRequestByTxnId(e.roomId,e.transactionId)}_getRequestByTxnId(e,t){const s=this._requestsByRoomId.get(e);if(s)return s.get(t)}setRequest(e,t){this._setRequest(e.getRoomId(),o.getTransactionId(e),t)}setRequestByChannel(e,t){this._setRequest(e.roomId,e.transactionId,t)}_setRequest(e,t,s){let n=this._requestsByRoomId.get(e);n||(n=new Map,this._requestsByRoomId.set(e,n)),n.set(t,s)}removeRequest(e){const t=e.getRoomId(),s=this._requestsByRoomId.get(t);s&&(s.delete(o.getTransactionId(e)),0===s.size&&this._requestsByRoomId.delete(t))}findRequestInProgress(e){const t=this._requestsByRoomId.get(e);if(t)for(const e of t.values())if(e.pending)return e}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var n=s(186),i=s(0),o=s(216),a=s(276),r=s(114);class c{constructor(e,t,s,n=null,i=null){this._client=e,this.userId=t,this._devices=s,this.transactionId=n,this._deviceId=i}isToDevices(e){if(e.length===this._devices.length){for(const t of e){if(!this._devices.find(e=>e.deviceId===t.deviceId))return!1}return!0}return!1}get deviceId(){return this._deviceId}static getEventType(e){return e.getType()}static getTransactionId(e){const t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===o.i||e===o.j}static validateEvent(e,t){if(e.isCancelled())return i.a.warn("Ignoring flagged verification request from "+e.getSender()),!1;const s=e.getContent();if(!s)return i.a.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!s.transaction_id)return i.a.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;const n=e.getType();if(n===o.i){if(!Number.isFinite(s.timestamp))return i.a.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&s.from_device==t.getDeviceId())return i.a.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return o.k.validateEvent(n,e,t)}getTimestamp(e){const t=e.getContent();return t&&t.timestamp}async handleEvent(e,t,s){const n=e.getType(),i=e.getContent();if(n===o.i||n===o.h||n===o.j){this.transactionId||(this.transactionId=i.transaction_id);const e=i.from_device;if(!this._deviceId&&this._devices.includes(e)&&(this._deviceId=e),!this._deviceId||this._deviceId!==e){const t=this.completeContent(Object(a.b)(Object(a.f)()));return this._sendToDevices(o.a,t,[e])}}const r=t.phase===o.f||t.phase===o.d;await t.handleEvent(e.getType(),e,s,!1,!1);const c=t.phase===o.f||t.phase===o.d;if((n===o.j||n===o.h)&&!r&&c&&this._deviceId){const e=this._devices.filter(e=>e!==this._deviceId&&e!==this._client.getDeviceId());if(e.length){const t=this.completeContent({code:"m.accepted",reason:"Verification request accepted by another device"});await this._sendToDevices(o.a,t,e)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==o.i&&e!==o.h&&e!==o.j||(t.from_device=this._client.getDeviceId()),e===o.i&&(t.timestamp=Date.now()),t}send(e,t={}){e!==o.i&&e!==o.j||this.transactionId||(this.transactionId=c.makeTransactionId());const s=this.completeContent(e,t);return this.sendCompleted(e,s)}async sendCompleted(e,t){let s;s=e===o.i?await this._sendToDevices(e,t,this._devices):await this._sendToDevices(e,t,[this._deviceId]);const n=new r.b({sender:this._client.getUserId(),content:t,type:e});return await this._request.handleEvent(e,n,!0,!0,!0),s}_sendToDevices(e,t,s){if(s.length){const n={};for(const e of s)n[e]=t;return this._client.sendToDevice(e,{[this.userId]:n})}return Promise.resolve()}static makeTransactionId(){return Object(n.b)(32)}}class l{constructor(){this._requestsByUserId=new Map}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),c.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){const s=this._requestsByUserId.get(e);if(s)return s.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),c.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,s){let n=this._requestsByUserId.get(e);n||(n=new Map,this._requestsByUserId.set(e,n)),n.set(t,s)}removeRequest(e){const t=e.getSender(),s=this._requestsByUserId.get(t);s&&(s.delete(c.getTransactionId(e)),0===s.size&&this._requestsByUserId.delete(t))}findRequestInProgress(e,t){const s=this._requestsByUserId.get(e);if(s)for(const e of s.values())if(e.pending&&e.channel.isToDevices(t))return e}getRequestsInProgress(e){const t=this._requestsByUserId.get(e);return t?Array.from(t.values()).filter(e=>e.pending):[]}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(391);class i extends n.b{static factory(...e){return new i(...e)}static get NAME(){return"org.matrix.illegal_method"}async _doVerification(){throw new Error("Verification is not possible with this method")}}},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.Error="ERROR",e.Prepared="PREPARED",e.Stopped="STOPPED",e.Syncing="SYNCING",e.Catchup="CATCHUP",e.Reconnecting="RECONNECTING"}(n||(n={}))},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.Master="master",e.SelfSigning="self_signing",e.UserSigning="user_signing"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(114);function i(e,t){const s=Boolean(t.preventReEmit),i=!1!==t.decrypt;return function(t){const o=new n.b(t);return o.isEncrypted()&&(s||e.reEmitter.reEmit(o,["Event.decrypted"]),i&&e.decryptEventIfNeeded(o)),s||e.reEmitter.reEmit(o,["Event.replaced"]),o}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(0),i=s(1);function o(e,t,s){this._workerScript=e,this._dbName=t,this._workerApi=s,this._worker=null,this._nextSeq=0,this._inFlight={},this._startPromise=null}o.prototype={connect:function(){return this._ensureStarted().then(()=>this._doCmd("connect"))},clearDatabase:function(){return this._ensureStarted().then(()=>this._doCmd("clearDatabase"))},isNewlyCreated:function(){return this._doCmd("isNewlyCreated")},getSavedSync:function(){return this._doCmd("getSavedSync")},getNextBatchToken:function(){return this._doCmd("getNextBatchToken")},setSyncData:function(e){return this._doCmd("setSyncData",[e])},syncToDatabase:function(e){return this._doCmd("syncToDatabase",[e])},getOutOfBandMembers:function(e){return this._doCmd("getOutOfBandMembers",[e])},setOutOfBandMembers:function(e,t){return this._doCmd("setOutOfBandMembers",[e,t])},clearOutOfBandMembers:function(e){return this._doCmd("clearOutOfBandMembers",[e])},getClientOptions:function(){return this._doCmd("getClientOptions")},storeClientOptions:function(e){return this._doCmd("storeClientOptions",[e])},getUserPresenceEvents:function(){return this._doCmd("getUserPresenceEvents")},_ensureStarted:function(){return null===this._startPromise&&(this._worker=new this._workerApi(this._workerScript),this._worker.onmessage=this._onWorkerMessage.bind(this),this._startPromise=this._doCmd("_setupWorker",[this._dbName]).then(()=>{n.a.log("IndexedDB worker is ready")})),this._startPromise},_doCmd:function(e,t){return Promise.resolve().then(()=>{const s=this._nextSeq++,n=Object(i.j)();return this._inFlight[s]=n,this._worker.postMessage({command:e,seq:s,args:t}),n.promise})},_onWorkerMessage:function(e){const t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void n.a.error("Got reply from worker with no seq");const e=this._inFlight[t.seq];if(void 0===e)return void n.a.error("Got reply for unknown seq "+t.seq);if(delete this._inFlight[t.seq],"cmd_success"==t.command)e.resolve(t.result);else{const s=new Error(t.error.message);s.name=t.error.name,e.reject(s)}}else n.a.warn("Unrecognised message from worker: "+t)}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return u})),s.d(t,"a",(function(){return h}));var n=s(94),i=s(243),o=s(140),a=s(190),r=s(244),c=s(217),l=s(102);function d(){var e;return l.a.get().widget_build_url?l.a.get().widget_build_url:null===(e=Object(i.a)())||void 0===e?void 0:e.widget_build_url}function u(){return!!d()}async function h(e){const t=n.a.get().getRoom(e);if(!t)return;if(!o.a.canUserModifyWidgets(e))return void console.error("User not allowed to modify widgets in "+e);const s=d();if(!s)return;let i;try{const t=await fetch(`${s}?roomId=${e}`);i=await t.json()}catch(t){return void console.error("Managed hybrid widget builder failed for room "+e,t)}if(!i)return;const{widget_id:l,widget:u,layout:h}=i;let m=c.a.instance.getApps(e);if(m.some(e=>e.id===l)||r.a.roomHasPendingWidgets(e,[]))return void console.error("Managed hybrid widget already present in room "+e);try{await o.a.setRoomWidgetContent(e,l,u)}catch(t){return void console.error("Unable to add managed hybrid widget in room "+e,t)}if(!a.d.instance.canCopyLayoutToRoom(t))return;m=c.a.instance.getApps(e);const p=m.find(e=>e.id===l);p&&(a.d.instance.moveToContainer(t,p,h.container),a.d.instance.setContainerHeight(t,h.container,h.height),a.d.instance.copyLayoutToRoom(t))}},,function(e,t){e.exports="img/plus.53bc1d6.svg"},,,,,,,,,,,,,,,,,,,,,,,function(e,t){e.exports="img/social/facebook.d547f79.png"},function(e,t){e.exports="img/social/twitter-2.6517b36.png"},function(e,t){e.exports="img/social/linkedin.ab157f6.png"},function(e,t){e.exports="img/social/reddit.eeab8e6.png"},function(e,t){e.exports="img/social/email-1.1134895.png"},function(e,t){e.exports="img/element-icons/room/default_app.2034d23.svg"},function(e,t){e.exports="img/element-icons/room/default_video.66250a4.svg"},function(e,t){e.exports="img/element-icons/room/default_cal.65049a4.svg"},function(e,t){e.exports="img/element-icons/room/default_doc.02ee63f.svg"},function(e,t){e.exports="img/element-icons/room/default_clock.e3e0f9b.svg"},,,,function(e,t,s){"use strict";var n=s(18),i=s.n(n),o=s(94),a=s(96),r=s(254);var c;!function(e){e.Online="online",e.Offline="offline",e.Unavailable="unavailable"}(c||(c={}));t.a=new class{constructor(){i()(this,"unavailableTimer",null),i()(this,"dispatcherRef",null),i()(this,"state",null),i()(this,"onAction",e=>{"user_activity"===e.action&&(this.setState(c.Online),this.unavailableTimer.restart())})}async start(){for(this.unavailableTimer=new r.a(18e4),this.dispatcherRef=a.a.register(this.onAction);this.unavailableTimer;)try{await this.unavailableTimer.finished(),this.setState(c.Unavailable)}catch(e){}}stop(){this.dispatcherRef&&(a.a.unregister(this.dispatcherRef),this.dispatcherRef=null),this.unavailableTimer&&(this.unavailableTimer.abort(),this.unavailableTimer=null)}getState(){return this.state}async setState(e){if(e===this.state)return;const t=this.state;if(this.state=e,!o.a.get().isGuest())try{await o.a.get().setPresence({presence:this.state}),console.info("Presence:",e)}catch(e){console.error("Failed to set presence:",e),this.state=t}}}},function(e,t){e.exports="img/e2e/verified.5be6c9f.svg"},,,function(e,t,s){"use strict";t.a={}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){e.exports="img/betas/spaces.475c2e5.png"},function(e,t){e.exports="img/icon-pill-remove.caaa0c9.svg"},function(e,t){e.exports="img/element-icons/info.dc07e19.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(18),i=s.n(n),o=s(1219),a=s(145),r=s(98);class c{constructor(e){this.store=e,i()(this,"filter",void 0),i()(this,"activeSpace",a.f.instance.activeSpace),i()(this,"onSelectedSpaceUpdated",e=>{this.activeSpace=e,this.filter?e||!r.b.getValue("feature_spaces.all_rooms")?this.updateFilter():(this.store.removeFilter(this.filter),this.filter=null):e&&(this.filter=new o.a,this.updateFilter(),this.store.addFilter(this.filter))}),i()(this,"updateFilter",()=>{this.activeSpace&&a.f.instance.traverseSpace(this.activeSpace.roomId,e=>{var t,s;null===(t=this.store.matrixClient)||void 0===t||null===(s=t.getRoom(e))||void 0===s||s.loadMembersIfNeeded()}),this.filter.updateSpace(this.activeSpace)}),r.b.getValue("feature_spaces.all_rooms")||(this.filter=new o.a,this.updateFilter(),e.addFilter(this.filter)),a.f.instance.on(a.d,this.onSelectedSpaceUpdated)}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return l}));var n=s(18),i=s.n(n),o=s(8),a=s(264),r=s(145),c=s(359);class l extends o.EventEmitter{constructor(...t){super(...t),i()(this,"roomIds",new Set),i()(this,"space",null),i()(this,"onStoreUpdate",async()=>{const t=this.roomIds;this.roomIds=new Set(r.f.instance.getSpaceFilteredRoomIds(this.space)),Object(c.a)(t,this.roomIds)&&(this.emit(a.a),e(()=>{this.emit(a.a)}))}),i()(this,"getSpaceEventKey",e=>e?e.roomId:r.a)}get kind(){return a.b.Prefilter}isVisible(e){return this.roomIds.has(e.roomId)}updateSpace(e){r.f.instance.off(this.getSpaceEventKey(this.space),this.onStoreUpdate),r.f.instance.on(this.getSpaceEventKey(this.space=e),this.onStoreUpdate),this.onStoreUpdate()}destroy(){r.f.instance.off(this.getSpaceEventKey(this.space),this.onStoreUpdate)}}}).call(this,s(169).setImmediate)},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(358),i=s(99),o=s(242),a=s(92),r=s(95),c=s(159),l=s(233),d=s(146);class u{static tagRoom(e,t,s,u,h,m){let p=null;const g=c.b.instance;if(u&&g.getTagSorting(u)===l.b.Manual){const e=[...g.orderedLists[u]];e.sort((e,t)=>e.tags[u].order-t.tags[u].order);const t=u===s&&h<m?1:0,n=t+m-1,i=t+m,o=n<=0?0:e[n].tags[u].order,a=i>=e.length?1:e[i].tags[u].order;p={order:(o+a)/2}}return Object(n.a)("RoomListActions.tagRoom",()=>{const n=[],c=t.roomId;if(void 0===s&&u===d.a.DM||s===d.a.DM&&void 0===u)return o.b(t,u===d.a.DM).catch(e=>{const t=r.getComponent("dialogs.ErrorDialog");console.error("Failed to set direct chat tag "+e),i.a.createTrackedDialog("Failed to set direct chat tag","",t,{title:Object(a.a)("Failed to set direct chat tag"),description:e&&e.message?e.message:Object(a.a)("Operation failed")})});const l=s!==u;if(s&&s!==d.a.DM&&l){const t=e.deleteRoomTag(c,s).catch((function(e){const t=r.getComponent("dialogs.ErrorDialog");console.error("Failed to remove tag "+s+" from room: "+e),i.a.createTrackedDialog("Failed to remove tag from room","",t,{title:Object(a.a)("Failed to remove tag %(tagName)s from room",{tagName:s}),description:e&&e.message?e.message:Object(a.a)("Operation failed")})}));n.push(t)}if(u&&u!==d.a.DM&&(l||p)){p=p||{};const t=e.setRoomTag(c,u,p).catch((function(e){const t=r.getComponent("dialogs.ErrorDialog");throw console.error("Failed to add tag "+u+" to room: "+e),i.a.createTrackedDialog("Failed to add tag to room","",t,{title:Object(a.a)("Failed to add tag %(tagName)s to room",{tagName:u}),description:e&&e.message?e.message:Object(a.a)("Operation failed")}),e}));n.push(t)}return Promise.all(n)},()=>({room:t,oldTag:s,newTag:u,metaData:p}))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(682);class i{constructor(){}static forRoom(e){return n.a.instance.getOrCreateChamberForRoom(e)}}},function(e,t,s){"use strict";function n(){window.TouchEvent||(window.TouchEvent=class extends UIEvent{get altKey(){return!1}get changedTouches(){return[]}get ctrlKey(){return!1}get metaKey(){return!1}get shiftKey(){return!1}get targetTouches(){return[]}get touches(){return[]}get rotation(){return 0}get scale(){return 0}constructor(e,t){super(e,t)}})}s.d(t,"a",(function(){return n}))},function(e,t){e.exports="img/element-icons/roomlist/dark-light-mode.f72b785.svg"},,,,,,,,,function(e,t){e.exports="fonts/Twemoji_Mozilla/TwemojiMozilla-colr.5bb743a.woff2"},function(e,t){e.exports="fonts/Twemoji_Mozilla/TwemojiMozilla-sbix.fb38407.woff2"},,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return pe}));var n,i,o,a=s(108),r=s.n(a),c=s(18),l=s.n(c),d=s(91),u=s.n(d),h=s(101),m=s.n(h),p=s(230),g=s(265),v=s(92),f=s(122),b=s(256),y=s(99),_=s(95),E=s(153),S=s(96),w=s(335),C=s(248),k=s(242),O=s(1265),R=s(330),I=s(331),x=s(133),T=s(1266),j=s(244),N=s(98),P=s(155),D=s(100),A=s(249),M=s(195),U=s(187),L=s(105),F=s(420),B=s(103),V=s(466),K=s(444),W=s(413),G=s(712),q=s(714),H=s(715),$=s(716),z=s(718),Y=s(720),J=s(286),Q=s(207),X=s(217),Z=s(123),ee=s(253),te=s(428),se=s(174),ne=s(190),ie=s(184),oe=s(141),ae=s(295),re=s(93),ce=s(154),le=s(721);function de(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function ue(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?de(Object(s),!0).forEach((function(t){l()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):de(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let he=function(e){};const me="sandbox"in document.createElement("iframe");let pe=Object(re.a)("structures.RoomView")((o=i=class extends u.a.Component{constructor(t,s){super(t,s),l()(this,"dispatcherRef",void 0),l()(this,"roomStoreToken",void 0),l()(this,"rightPanelStoreToken",void 0),l()(this,"settingWatchers",void 0),l()(this,"unmounted",!1),l()(this,"permalinkCreators",{}),l()(this,"searchId",void 0),l()(this,"roomView",Object(d.createRef)()),l()(this,"searchResultsPanel",Object(d.createRef)()),l()(this,"messagePanel",void 0),l()(this,"onWidgetStoreUpdate",()=>{this.state.room&&this.checkWidgets(this.state.room)}),l()(this,"checkWidgets",e=>{this.setState({hasPinnedWidgets:ne.d.instance.getContainerWidgets(e,ne.a.Top).length>0,showApps:this.shouldShowApps(e)})}),l()(this,"onReadReceiptsChange",()=>{this.setState({showReadReceipts:N.b.getValue("showReadReceipts",this.state.roomId)})}),l()(this,"onRoomViewStoreUpdate",e=>{if(this.unmounted)return;if(!e&&this.state.roomId!==x.a.getRoomId())return;const t=x.a.getRoomId(),s={roomId:t,roomAlias:x.a.getRoomAlias(),roomLoading:x.a.isRoomLoading(),roomLoadError:x.a.getRoomLoadError(),joining:x.a.isJoining(),initialEventId:x.a.getInitialEventId(),isInitialEventHighlighted:x.a.isInitialEventHighlighted(),replyToEvent:x.a.getQuotingEvent(),shouldPeek:this.state.matrixClientIsReady&&x.a.shouldPeek(),showReadReceipts:N.b.getValue("showReadReceipts",t),showRedactions:N.b.getValue("showRedactions",t),showJoinLeaves:N.b.getValue("showJoinLeaves",t),showAvatarChanges:N.b.getValue("showAvatarChanges",t),showDisplaynameChanges:N.b.getValue("showDisplaynameChanges",t),wasContextSwitch:x.a.getWasContextSwitch()};if(this.settingWatchers=this.settingWatchers.concat([N.b.watchSetting("showReadReceipts",null,()=>this.setState({showReadReceipts:N.b.getValue("showReadReceipts",t)})),N.b.watchSetting("showRedactions",null,()=>this.setState({showRedactions:N.b.getValue("showRedactions",t)})),N.b.watchSetting("showJoinLeaves",null,()=>this.setState({showJoinLeaves:N.b.getValue("showJoinLeaves",t)})),N.b.watchSetting("showAvatarChanges",null,()=>this.setState({showAvatarChanges:N.b.getValue("showAvatarChanges",t)})),N.b.watchSetting("showDisplaynameChanges",null,()=>this.setState({showDisplaynameChanges:N.b.getValue("showDisplaynameChanges",t)}))]),e||!this.state.shouldPeek||s.shouldPeek||this.context.stopPeeking(),console.log("RVS update:",s.roomId,s.roomAlias,"loading?",s.roomLoading,"joining?",s.joining,"initial?",e,"shouldPeek?",s.shouldPeek),e&&(s.room=this.context.getRoom(s.roomId),s.room&&(s.showApps=this.shouldShowApps(s.room),this.onRoomLoaded(s.room))),null===this.state.roomId&&null!==s.roomId&&!s.initialEventId){const e=T.a.getScrollState(s.roomId);e&&(s.initialEventId=e.focussedEvent,s.initialEventPixelOffset=e.pixelOffset)}this.state.initialEventId!==s.initialEventId&&(s.searchResults=null),this.setState(s),e&&this.setupRoom(s.room,s.roomId,s.joining,s.shouldPeek)}),l()(this,"getRoomId",()=>this.state.room?this.state.room.roomId:this.state.roomId),l()(this,"onWidgetEchoStoreUpdate",()=>{this.state.room&&this.setState({hasPinnedWidgets:ne.d.instance.getContainerWidgets(this.state.room,ne.a.Top).length>0,showApps:this.shouldShowApps(this.state.room)})}),l()(this,"onWidgetLayoutChange",()=>{this.onWidgetEchoStoreUpdate()}),l()(this,"onUserScroll",()=>{this.state.initialEventId&&this.state.isInitialEventHighlighted&&S.a.dispatch({action:"view_room",room_id:this.state.room.roomId,event_id:this.state.initialEventId,highlighted:!1,replyingToEvent:this.state.replyToEvent})}),l()(this,"onRightPanelStoreUpdate",()=>{this.setState({showRightPanel:A.a.getSharedInstance().isOpenForRoom})}),l()(this,"onPageUnload",e=>b.a.sharedInstance().getCurrentUploads().length>0?e.returnValue=Object(v.a)("You seem to be uploading files, are you sure you want to quit?"):this.getCallForRoom()&&"ended"!==this.state.callState?e.returnValue=Object(v.a)("You seem to be in a call, are you sure you want to quit?"):void 0),l()(this,"onReactKeyDown",e=>{let t=!1;switch(Object(ie.f)().getRoomAction(e)){case ie.d.DismissReadMarker:this.messagePanel.forgetReadMarker(),this.jumpToLiveTimeline(),t=!0;break;case ie.d.JumpToOldestUnread:this.jumpToReadMarker(),t=!0;break;case ie.d.UploadFile:S.a.dispatch({action:"upload_file"},!0),t=!0}t&&(e.stopPropagation(),e.preventDefault())}),l()(this,"onAction",t=>{var s;switch(t.action){case"message_sent":this.checkDesktopNotifications();break;case"post_sticker_message":this.injectSticker(t.data.content.url,t.data.content.info,t.data.description||t.data.name);break;case"picture_snapshot":b.a.sharedInstance().sendContentListToRoom([t.file],this.state.room.roomId,this.context);break;case"notifier_enabled":case B.a.UploadStarted:case B.a.UploadFinished:case B.a.UploadCanceled:this.forceUpdate();break;case"call_state":{if(!t.room_id)return;const e=this.getCallForRoom();this.setState({callState:e?e.state:null});break}case"appsDrawer":this.setState({showApps:t.show});break;case"reply_to_event":this.state.searchResults&&t.event.getRoomId()===this.state.roomId&&!this.unmounted&&this.onCancelSearchClick();break;case"quote":if(this.state.searchResults){const s=t.event.getRoomId();s===this.state.roomId&&this.onCancelSearchClick(),e(()=>{S.a.dispatch({action:"view_room",room_id:s,deferred_action:t})})}break;case"sync_state":this.state.matrixClientIsReady||this.setState({matrixClientIsReady:this.context&&this.context.isInitialSyncComplete()},()=>{this.onRoomViewStoreUpdate(!0)});break;case"focus_search":this.onSearchClick();break;case"edit_event":{const e=t.event?new le.a(t.event):null;this.setState({editState:e},()=>{var e;t.event&&(null===(e=this.messagePanel)||void 0===e||e.scrollToEventIfNeeded(t.event.getId()))});break}case B.a.ComposerInsert:this.state.editState?S.a.dispatch(ue(ue({},t),{},{action:"edit_composer_insert"})):S.a.dispatch(ue(ue({},t),{},{action:"send_composer_insert"}));break;case"scroll_to_bottom":null===(s=this.messagePanel)||void 0===s||s.jumpToLiveTimeline()}}),l()(this,"onRoomTimeline",(e,t,s,n,i)=>{this.unmounted||t&&this.state.room&&t.roomId==this.state.room.roomId&&i.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&("org.matrix.room.preview_urls"===e.getType()&&this.updatePreviewUrlVisibility(t),"m.room.encryption"===e.getType()&&this.updateE2EStatus(t),!s&&i&&i.liveEvent&&(this.state.joining||e.getSender()!==this.context.credentials.userId&&(!this.state.searchResults&&this.state.atEndOfLiveTimeline||Object(g.a)(e,this.state)||this.setState((e,t)=>({numUnreadMessages:e.numUnreadMessages+1})))))}),l()(this,"onEventDecrypted",e=>{e.isDecryptionFailure()||this.handleEffects(e)}),l()(this,"onEvent",e=>{e.isBeingDecrypted()||e.isDecryptionFailure()||this.handleEffects(e)}),l()(this,"handleEffects",e=>{if(!this.state.room||!this.state.matrixClientIsReady)return;if(e.getRoomId()!==this.state.room.roomId)return;se.a.instance.getRoomState(this.state.room).isUnread&&Q.CHAT_EFFECTS.forEach(t=>{(Object(J.containsEmoji)(e.getContent(),t.emojis)||e.getContent().msgtype===t.msgType)&&S.a.dispatch({action:"effects."+t.command})})}),l()(this,"onRoomName",e=>{this.state.room&&e.roomId==this.state.room.roomId&&this.forceUpdate()}),l()(this,"onKeyBackupStatus",()=>{this.forceUpdate()}),l()(this,"canResetTimeline",()=>!this.messagePanel||this.messagePanel.canResetTimeline()),l()(this,"onRoomLoaded",e=>{ne.d.instance.on(ne.d.emissionForRoom(e),this.onWidgetLayoutChange),this.onWidgetLayoutChange(),this.calculatePeekRules(e),this.updatePreviewUrlVisibility(e),this.loadMembersIfJoined(e),this.calculateRecommendedVersion(e),this.updateE2EStatus(e),this.updatePermissions(e),this.checkWidgets(e)}),l()(this,"onRoom",e=>{e&&e.roomId===this.state.roomId&&(this.state.room&&ne.d.instance.off(ne.d.emissionForRoom(this.state.room),this.onWidgetLayoutChange),this.setState({room:e},()=>{this.onRoomLoaded(e)}))}),l()(this,"onDeviceVerificationChanged",(e,t)=>{const s=this.state.room;s.currentState.getMember(e)&&this.updateE2EStatus(s)}),l()(this,"onUserVerificationChanged",(e,t)=>{const s=this.state.room;s&&s.currentState.getMember(e)&&this.updateE2EStatus(s)}),l()(this,"onCrossSigningKeysChanged",()=>{const e=this.state.room;e&&this.updateE2EStatus(e)}),l()(this,"onAccountData",e=>{const t=e.getType();"org.matrix.preview_urls"!==t&&"im.vector.web.settings"!==t||!this.state.room||this.updatePreviewUrlVisibility(this.state.room)}),l()(this,"onRoomAccountData",(e,t)=>{if(t.roomId==this.state.roomId){const s=e.getType();if("org.matrix.room.color_scheme"===s){const t=e.getContent();console.log("Tinter.tint from onRoomAccountData"),w.a.tint(t.primary_color,t.secondary_color)}else"org.matrix.room.preview_urls"!==s&&"im.vector.web.settings"!==s||this.updatePreviewUrlVisibility(t)}}),l()(this,"onRoomStateEvents",(e,t)=>{this.state.room&&this.state.room.roomId===t.roomId&&this.updatePermissions(this.state.room)}),l()(this,"onRoomStateMember",(e,t,s)=>{this.state.room&&s.roomId===this.state.room.roomId&&this.updateRoomMembers(s)}),l()(this,"onMyMembership",(e,t,s)=>{e.roomId===this.state.roomId&&(this.forceUpdate(),this.loadMembersIfJoined(e),this.updatePermissions(e))}),l()(this,"updateRoomMembers",Object(C.a)(()=>{this.updateDMState(),this.updateE2EStatus(this.state.room)},500)),l()(this,"onSearchResultsFillRequest",e=>{if(!e)return Promise.resolve(!1);if(this.state.searchResults.next_batch){he("requesting more search results");const e=Object(O.b)(this.state.searchResults);return this.handleSearchResult(e)}return he("no more search results"),Promise.resolve(!1)}),l()(this,"onInviteButtonClick",()=>{S.a.dispatch({action:"view_invite",roomId:this.state.room.roomId})}),l()(this,"onJoinButtonClicked",()=>{this.context&&this.context.isGuest()?(S.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"view_room",room_id:this.getRoomId()}}),S.a.dispatch({action:"require_registration"})):Promise.resolve().then(()=>{var e;const t=null===(e=this.props.threepidInvite)||void 0===e?void 0:e.signUrl;return S.a.dispatch({action:B.a.JoinRoom,roomId:this.getRoomId(),opts:{inviteSignUrl:t},_type:"unknown"}),Promise.resolve()})}),l()(this,"onMessageListScroll",e=>{this.messagePanel.isAtEndOfLiveTimeline()?this.setState({numUnreadMessages:0,atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.updateTopUnreadMessagesBar()}),l()(this,"onDragEnter",e=>{e.stopPropagation(),e.preventDefault(),this.setState({dragCounter:this.state.dragCounter+1}),(e.dataTransfer.types.includes("Files")||e.dataTransfer.types.includes("application/x-moz-file"))&&this.setState({draggingFile:!0})}),l()(this,"onDragLeave",e=>{e.stopPropagation(),e.preventDefault(),this.setState({dragCounter:this.state.dragCounter-1}),0===this.state.dragCounter&&this.setState({draggingFile:!1})}),l()(this,"onDragOver",e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="none",(e.dataTransfer.types.includes("Files")||e.dataTransfer.types.includes("application/x-moz-file"))&&(e.dataTransfer.dropEffect="copy")}),l()(this,"onDrop",e=>{e.stopPropagation(),e.preventDefault(),b.a.sharedInstance().sendContentListToRoom(e.dataTransfer.files,this.state.room.roomId,this.context),S.a.fire(B.a.FocusComposer),this.setState({draggingFile:!1,dragCounter:this.state.dragCounter-1})}),l()(this,"onSearch",(e,t)=>{let s;this.setState({searchTerm:e,searchScope:t,searchResults:{},searchHighlights:[]}),this.searchResultsPanel.current&&this.searchResultsPanel.current.resetScrollState(),this.searchId=(new Date).getTime(),t===q.a.Room&&(s=this.state.room.roomId),he("sending search request");const n=Object(O.a)(e,s);this.handleSearchResult(n)}),l()(this,"onCallPlaced",e=>{S.a.dispatch({action:"place_call",type:e,room_id:this.state.room.roomId})}),l()(this,"onSettingsClick",()=>{S.a.dispatch({action:"open_room_settings"})}),l()(this,"onAppsClick",()=>{S.a.dispatch({action:"appsDrawer",show:!this.state.showApps})}),l()(this,"onLeaveClick",()=>{S.a.dispatch({action:"leave_room",room_id:this.state.room.roomId})}),l()(this,"onForgetClick",()=>{S.a.dispatch({action:"forget_room",room_id:this.state.room.roomId})}),l()(this,"onRejectButtonClicked",()=>{this.setState({rejecting:!0}),this.context.leave(this.state.roomId).then(()=>{S.a.dispatch({action:"view_home_page"}),this.setState({rejecting:!1})},e=>{console.error("Failed to reject invite: %s",e);const t=e.message?e.message:JSON.stringify(e),s=_.getComponent("dialogs.ErrorDialog");y.a.createTrackedDialog("Failed to reject invite","",s,{title:Object(v.a)("Failed to reject invite"),description:t}),this.setState({rejecting:!1,rejectError:e})})}),l()(this,"onRejectAndIgnoreClick",async()=>{this.setState({rejecting:!0});try{const e=this.state.room.getMember(this.context.getUserId()).events.member,t=this.context.getIgnoredUsers();t.push(e.getSender()),await this.context.setIgnoredUsers(t),await this.context.leave(this.state.roomId),S.a.dispatch({action:"view_home_page"}),this.setState({rejecting:!1})}catch(e){console.error("Failed to reject invite: %s",e);const t=e.message?e.message:JSON.stringify(e),s=_.getComponent("dialogs.ErrorDialog");y.a.createTrackedDialog("Failed to reject invite","",s,{title:Object(v.a)("Failed to reject invite"),description:t}),this.setState({rejecting:!1,rejectError:e})}}),l()(this,"onRejectThreepidInviteButtonClicked",()=>{S.a.fire(B.a.ViewRoomDirectory)}),l()(this,"onSearchClick",()=>{this.setState({searching:!this.state.searching})}),l()(this,"onCancelSearchClick",()=>{this.setState({searching:!1,searchResults:null})}),l()(this,"jumpToLiveTimeline",()=>{this.state.initialEventId&&this.state.isInitialEventHighlighted?S.a.dispatch({action:"view_room",room_id:this.state.room.roomId}):(this.messagePanel.jumpToLiveTimeline(),S.a.fire(B.a.FocusComposer))}),l()(this,"jumpToReadMarker",()=>{this.messagePanel.jumpToReadMarker()}),l()(this,"forgetReadMarker",e=>{e.stopPropagation(),this.messagePanel.forgetReadMarker()}),l()(this,"updateTopUnreadMessagesBar",()=>{if(!this.messagePanel)return;const e=this.messagePanel.canJumpToReadMarker();this.state.showTopUnreadMessagesBar!=e&&this.setState({showTopUnreadMessagesBar:e})}),l()(this,"onResize",()=>{let e=ce.b.instance.windowHeight-261;if(e<50&&(e=50),this.state.auxPanelMaxHeight!==e&&this.setState({auxPanelMaxHeight:e}),this.state.layout==P.a.Bubble&&this.state.adaptiveSideBubbles&&this.roomView.current){const e=this.roomView.current.getElementsByClassName("mx_RoomView_MessageList");let t=0;for(let s=0;s<e.length;s++){const n=e[s].getBoundingClientRect();n.width>t&&(t=n.width)}t<1280?this.setState({singleSideBubbles:!1}):this.setState({singleSideBubbles:!0})}}),l()(this,"onStatusBarVisible",()=>{this.unmounted||this.state.statusBarVisible||this.setState({statusBarVisible:!0})}),l()(this,"onStatusBarHidden",()=>{!this.unmounted&&this.state.statusBarVisible&&this.setState({statusBarVisible:!1})}),l()(this,"handleScrollKey",e=>{let t;this.searchResultsPanel.current?t=this.searchResultsPanel.current:this.messagePanel&&(t=this.messagePanel),t&&t.handleScrollKey(e)}),l()(this,"gatherTimelinePanelRef",e=>{this.messagePanel=e}),l()(this,"onHiddenHighlightsClick",()=>{const e=this.getOldRoom();e&&S.a.dispatch({action:"view_room",room_id:e.roomId})});const n=this.context.hasLazyLoadMembersEnabled();this.state={roomId:null,roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!n,numUnreadMessages:0,draggingFile:!1,searching:!1,searchResults:null,callState:null,guestsCanJoin:!1,canPeek:!1,showApps:!1,isPeeking:!1,showRightPanel:A.a.getSharedInstance().isOpenForRoom,joining:!1,atEndOfLiveTimeline:!0,atEndOfLiveTimelineInit:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canReply:!1,layout:N.b.getValue("layout"),singleSideBubbles:N.b.getValue("singleSideBubbles"),adaptiveSideBubbles:N.b.getValue("adaptiveSideBubbles"),lowBandwidth:N.b.getValue("lowBandwidth"),showReadReceipts:!0,showRedactions:!0,showJoinLeaves:!0,showAvatarChanges:!0,showDisplaynameChanges:!0,matrixClientIsReady:this.context&&this.context.isInitialSyncComplete(),dragCounter:0},this.dispatcherRef=S.a.register(this.onAction),this.context.on("Room",this.onRoom),this.context.on("Room.timeline",this.onRoomTimeline),this.context.on("Room.name",this.onRoomName),this.context.on("Room.accountData",this.onRoomAccountData),this.context.on("RoomState.events",this.onRoomStateEvents),this.context.on("RoomState.members",this.onRoomStateMember),this.context.on("Room.myMembership",this.onMyMembership),this.context.on("accountData",this.onAccountData),this.context.on("crypto.keyBackupStatus",this.onKeyBackupStatus),this.context.on("deviceVerificationChanged",this.onDeviceVerificationChanged),this.context.on("userTrustStatusChanged",this.onUserVerificationChanged),this.context.on("crossSigning.keysChanged",this.onCrossSigningKeysChanged),this.context.on("Event.decrypted",this.onEventDecrypted),this.context.on("event",this.onEvent),this.roomStoreToken=x.a.addListener(this.onRoomViewStoreUpdate),this.rightPanelStoreToken=A.a.getSharedInstance().addListener(this.onRightPanelStoreUpdate),j.a.on(Z.b,this.onWidgetEchoStoreUpdate),X.a.instance.on(Z.b,this.onWidgetStoreUpdate),this.settingWatchers=[N.b.watchSetting("layout",null,()=>this.setState({layout:N.b.getValue("layout")})),N.b.watchSetting("singleSideBubbles",null,()=>this.setState({singleSideBubbles:N.b.getValue("singleSideBubbles")})),N.b.watchSetting("adaptiveSideBubbles",null,()=>this.setState({adaptiveSideBubbles:N.b.getValue("adaptiveSideBubbles"),singleSideBubbles:N.b.getValue("singleSideBubbles")})),N.b.watchSetting("lowBandwidth",null,()=>this.setState({lowBandwidth:N.b.getValue("lowBandwidth")}))]}getPermalinkCreatorForRoom(e){return this.permalinkCreators[e.roomId]||(this.permalinkCreators[e.roomId]=new f.a(e),this.state.room&&e.roomId===this.state.room.roomId?this.permalinkCreators[e.roomId].start():this.permalinkCreators[e.roomId].load()),this.permalinkCreators[e.roomId]}stopAllPermalinkCreators(){if(this.permalinkCreators)for(const e of Object.keys(this.permalinkCreators))this.permalinkCreators[e].stop()}setupRoom(e,t,s,n){!s&&t&&(!e&&n?(console.info("Attempting to peek into room %s",t),this.setState({peekLoading:!0,isPeeking:!0}),this.context.peekInRoom(t).then(e=>{this.unmounted||(this.setState({room:e,peekLoading:!1}),this.onRoomLoaded(e))}).catch(e=>{if(!this.unmounted){if(this.setState({isPeeking:!1}),"M_GUEST_ACCESS_FORBIDDEN"!==e.errcode&&"M_FORBIDDEN"!==e.errcode)throw e;this.setState({peekLoading:!1})}})):e&&(this.context.stopPeeking(),this.setState({isPeeking:!1})))}shouldShowApps(e){if(!me||!e)return!1;const t="false"===localStorage.getItem(e.roomId+"_hide_widget_drawer");return ne.d.instance.getContainerWidgets(e,ne.a.Top).length>0||t}componentDidMount(){this.onRoomViewStoreUpdate(!0);const e=this.getCallForRoom(),t=e?e.state:null;this.setState({callState:t}),window.addEventListener("beforeunload",this.onPageUnload),this.props.resizeNotifier&&this.props.resizeNotifier.on("middlePanelResized",this.onResize),this.onResize()}shouldComponentUpdate(e,t){const s=Object(oe.d)(this.props,e),n=this.state,{upgradeRecommendation:i}=n,o=r()(n,["upgradeRecommendation"]),{upgradeRecommendation:a}=t,c=r()(t,["upgradeRecommendation"]),l=(null==a?void 0:a.needsUpgrade)!==(null==i?void 0:i.needsUpgrade)||Object(oe.d)(o,c);return s||l}componentDidUpdate(){if(this.roomView.current){const e=this.roomView.current;e.ondrop||(e.addEventListener("drop",this.onDrop),e.addEventListener("dragover",this.onDragOver),e.addEventListener("dragenter",this.onDragEnter),e.addEventListener("dragleave",this.onDragLeave))}this.messagePanel&&!this.state.atEndOfLiveTimelineInit&&this.setState({atEndOfLiveTimelineInit:!0,atEndOfLiveTimeline:this.messagePanel.isAtEndOfLiveTimeline()}),this.onResize()}componentWillUnmount(){if(this.unmounted=!0,this.state.roomId&&T.a.setScrollState(this.state.roomId,this.getScrollState()),this.state.shouldPeek&&this.context.stopPeeking(),this.stopAllPermalinkCreators(),this.roomView.current){const e=this.roomView.current;e.removeEventListener("drop",this.onDrop),e.removeEventListener("dragover",this.onDragOver),e.removeEventListener("dragenter",this.onDragEnter),e.removeEventListener("dragleave",this.onDragLeave)}S.a.unregister(this.dispatcherRef),this.context&&(this.context.removeListener("Room",this.onRoom),this.context.removeListener("Room.timeline",this.onRoomTimeline),this.context.removeListener("Room.name",this.onRoomName),this.context.removeListener("Room.accountData",this.onRoomAccountData),this.context.removeListener("RoomState.events",this.onRoomStateEvents),this.context.removeListener("Room.myMembership",this.onMyMembership),this.context.removeListener("RoomState.members",this.onRoomStateMember),this.context.removeListener("accountData",this.onAccountData),this.context.removeListener("crypto.keyBackupStatus",this.onKeyBackupStatus),this.context.removeListener("deviceVerificationChanged",this.onDeviceVerificationChanged),this.context.removeListener("userTrustStatusChanged",this.onUserVerificationChanged),this.context.removeListener("crossSigning.keysChanged",this.onCrossSigningKeysChanged),this.context.removeListener("Event.decrypted",this.onEventDecrypted),this.context.removeListener("event",this.onEvent)),window.removeEventListener("beforeunload",this.onPageUnload),this.props.resizeNotifier&&this.props.resizeNotifier.removeListener("middlePanelResized",this.onResize),this.roomStoreToken&&this.roomStoreToken.remove(),this.rightPanelStoreToken&&this.rightPanelStoreToken.remove(),j.a.removeListener(Z.b,this.onWidgetEchoStoreUpdate),X.a.instance.removeListener(Z.b,this.onWidgetStoreUpdate),this.state.room&&ne.d.instance.off(ne.d.emissionForRoom(this.state.room),this.onWidgetLayoutChange),this.updateRoomMembers.cancelPendingCall();for(const e of this.settingWatchers)N.b.unwatchSetting(e)}async calculateRecommendedVersion(e){this.setState({upgradeRecommendation:await e.getRecommendedVersion()})}async loadMembersIfJoined(e){if(this.context.hasLazyLoadMembersEnabled()&&e&&"join"===e.getMyMembership())try{await e.loadMembersIfNeeded(),this.unmounted||this.setState({membersLoaded:!0})}catch(t){const s=`Fetching room members for ${e.roomId} failed. Room members will appear incomplete.`;console.error(s),console.error(t)}}calculatePeekRules(e){const t=e.currentState.getStateEvents("m.room.guest_access","");t&&"can_join"===t.getContent().guest_access&&this.setState({guestsCanJoin:!0});const s=e.currentState.getStateEvents("m.room.history_visibility","");s&&"world_readable"===s.getContent().history_visibility&&this.setState({canPeek:!0})}updatePreviewUrlVisibility({roomId:e}){const t=this.context.isRoomEncrypted(e)?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled";this.setState({showUrlPreview:N.b.getValue(t,e)})}async updateE2EStatus(e){this.context.isRoomEncrypted(e.roomId)&&(this.context.isCryptoEnabled()?this.setState({e2eStatus:await Object(F.b)(this.context,e)}):this.setState({e2eStatus:F.a.Warning}))}updatePermissions(e){if(e){const t=this.context.getUserId(),s="join"===e.getMyMembership()&&e.currentState.maySendEvent("m.reaction",t),n=e.maySendMessage();this.setState({canReact:s,canReply:n})}}checkDesktopNotifications(){this.state.room.getJoinedMemberCount()+this.state.room.getInvitedMemberCount()>1&&ee.default.shouldShowPrompt()&&Object(te.b)(!0)}updateDMState(){const e=this.state.room;if("join"!=e.getMyMembership())return;const t=e.getDMInviter();t&&k.c(e.roomId,t)}injectSticker(e,t,s){this.context.isGuest()?S.a.dispatch({action:"require_registration"}):b.a.sharedInstance().sendStickerContentToRoom(e,this.state.room.roomId,t,s,this.context).then(void 0,e=>{e.name})}handleSearchResult(e){const t=this.searchId;return this.setState({searchInProgress:!0}),e.then(e=>{if(he("search complete"),this.unmounted||!this.state.searching||this.searchId!=t)return void console.error("Discarding stale search results");let s=e.highlights;s.indexOf(this.state.searchTerm)<0&&(s=s.concat(this.state.searchTerm)),s=s.sort((function(e,t){return t.length-e.length})),this.setState({searchHighlights:s,searchResults:e})},e=>{const t=_.getComponent("dialogs.ErrorDialog");console.error("Search failed",e),y.a.createTrackedDialog("Search failed","",t,{title:Object(v.a)("Search failed"),description:e&&e.message?e.message:Object(v.a)("Server may be unavailable, overloaded, or search timed out :(")})}).finally(()=>{this.setState({searchInProgress:!1})})}getSearchResultTiles(){const e=_.getComponent("rooms.SearchResultTile"),t=_.getComponent("elements.Spinner"),s=[];var n,i;(this.state.searchInProgress&&s.push(u.a.createElement("li",{key:"search-spinner"},u.a.createElement(t,null))),this.state.searchResults.next_batch)||(null!==(n=this.state.searchResults)&&void 0!==n&&null!==(i=n.results)&&void 0!==i&&i.length?s.push(u.a.createElement("li",{key:"search-top-marker"},u.a.createElement("h2",{className:"mx_RoomView_topMarker"},Object(v.a)("No more results")))):s.push(u.a.createElement("li",{key:"search-top-marker"},u.a.createElement("h2",{className:"mx_RoomView_topMarker"},Object(v.a)("No results")))));const o=()=>{const e=this.searchResultsPanel.current;e&&e.checkScroll()};let a;for(let t=((null===(r=this.state.searchResults)||void 0===r||null===(c=r.results)||void 0===c?void 0:c.length)||0)-1;t>=0;t--){var r,c;const n=this.state.searchResults.results[t],i=n.context.getEvent(),l=i.getRoomId(),d=this.context.getRoom(l);if(!d){console.log("Hiding search result from an unknown room",l);continue}if(!Object(M.b)(i))continue;"All"===this.state.searchScope&&l!==a&&(s.push(u.a.createElement("li",{key:i.getId()+"-room"},u.a.createElement("h2",null,Object(v.a)("Room"),": ",d.name))),a=l);const h="#/room/"+l+"/"+i.getId();s.push(u.a.createElement(e,{key:i.getId(),searchResult:n,searchHighlights:this.state.searchHighlights,resultLink:h,permalinkCreator:this.getPermalinkCreatorForRoom(d),onHeightChanged:o,layout:this.state.layout,singleSideBubbles:this.state.singleSideBubbles}))}return s}getScrollState(){const e=this.messagePanel;if(!e)return null;if(this.state.atEndOfLiveTimeline)return null;const t=e.getScrollState();return!t||t.stuckAtBottom?null:{focussedEvent:t.trackedScrollToken,pixelOffset:t.pixelOffset}}getCallForRoom(){return this.state.room?E.e.sharedInstance().getCallForRoom(this.state.room.roomId):null}getOldRoom(){const e=this.state.room.currentState.getStateEvents("m.room.create","");return e&&e.getContent().predecessor?this.context.getRoom(e.getContent().predecessor.room_id):null}getHiddenHighlightCount(){const e=this.getOldRoom();return e?e.getUnreadNotificationCount("highlight"):0}render(){var e;if(!this.state.room){const e=!this.state.matrixClientIsReady||this.state.roomLoading||this.state.peekLoading;if(e){const t=!this.state.matrixClientIsReady||!this.state.roomId||this.state.peekLoading;return u.a.createElement("div",{className:"mx_RoomView"},u.a.createElement(W.a,null,u.a.createElement(G.a,{canPreview:!1,previewLoading:t&&!this.state.roomLoadError,error:this.state.roomLoadError,loading:e,joining:this.state.joining,oobData:this.props.oobData})))}{var t,n;let e=void 0;this.props.oobData&&(e=this.props.oobData.inviterName);const s=null===(t=this.props.threepidInvite)||void 0===t?void 0:t.toEmail,i=this.state.roomAlias;return u.a.createElement("div",{className:"mx_RoomView"},u.a.createElement(W.a,null,u.a.createElement(G.a,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,canPreview:!1,error:this.state.roomLoadError,roomAlias:i,joining:this.state.joining,inviterName:e,invitedEmail:s,oobData:this.props.oobData,signUrl:null===(n=this.props.threepidInvite)||void 0===n?void 0:n.signUrl,room:this.state.room})))}}const i=this.state.room.getMyMembership();if(!("invite"!==i||N.b.getValue("feature_spaces")&&this.state.room.isSpaceRoom())){if(this.state.joining||this.state.rejecting)return u.a.createElement(W.a,null,u.a.createElement(G.a,{canPreview:!1,error:this.state.roomLoadError,joining:this.state.joining,rejecting:this.state.rejecting}));{const e=this.context.credentials.userId,t=this.state.room.getMember(e),s=t?t.events.member:null;let n=Object(v.a)("Unknown");return s&&(n=s.sender?s.sender.name:s.getSender()),u.a.createElement("div",{className:"mx_RoomView"},u.a.createElement(W.a,null,u.a.createElement(G.a,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectButtonClicked,onRejectAndIgnoreClick:this.onRejectAndIgnoreClick,inviterName:n,canPreview:!1,joining:this.state.joining,room:this.state.room})))}}let o=null;this.state.draggingFile&&(o=u.a.createElement("div",{className:"mx_RoomView_fileDropTarget"},u.a.createElement("img",{src:s(1268),className:"mx_RoomView_fileDropTarget_image"}),Object(v.a)("Drop file here to upload")));let a=null;{const e=this.getCallForRoom();e&&"ended"!==this.state.callState&&"ringing"!==this.state.callState&&(a=e)}const r=m()({mx_RoomView_scrollheader:!0});let c,l=!0;if(b.a.sharedInstance().getCurrentUploads().length>0){const e=_.getComponent("structures.UploadBar");c=u.a.createElement(e,{room:this.state.room})}else if(!this.state.searchResults){const e=_.getComponent("structures.RoomStatusBar");l=this.state.statusBarVisible,c=u.a.createElement(e,{room:this.state.room,isPeeking:"join"!==i,onInviteClick:this.onInviteButtonClick,onVisible:this.onStatusBarVisible,onHidden:this.onStatusBarHidden})}const d=this.state.upgradeRecommendation,h=d&&d.needsUpgrade&&this.state.room.userMayUpgradeRoom(this.context.credentials.userId),g=this.getHiddenHighlightCount();let f,y=null;if(this.state.searching)y=u.a.createElement(q.b,{searchInProgress:this.state.searchInProgress,onCancelClick:this.onCancelSearchClick,onSearch:this.onSearch,isRoomEncrypted:this.context.isRoomEncrypted(this.state.room.roomId)});else if(h)y=u.a.createElement(H.a,{room:this.state.room,recommendation:d});else if("join"!==i){var E,S;let e=void 0;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(E=this.props.threepidInvite)||void 0===E?void 0:E.toEmail;if(f=u.a.createElement(G.a,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,canPreview:this.state.canPeek,room:this.state.room}),!(this.state.canPeek||N.b.getValue("feature_spaces")&&null!==(S=this.state.room)&&void 0!==S&&S.isSpaceRoom()))return u.a.createElement("div",{className:"mx_RoomView"},f)}else g>0&&(y=u.a.createElement(D.a,{element:"div",className:"mx_RoomView_auxPanel_hiddenHighlights",onClick:this.onHiddenHighlightsClick},Object(v.a)("You have %(count)s unread notifications in a prior version of this room.",{count:g})));if(null!==(e=this.state.room)&&void 0!==e&&e.isSpaceRoom())return u.a.createElement(ae.b,{space:this.state.room,justCreatedOpts:this.props.justCreatedOpts,resizeNotifier:this.props.resizeNotifier,onJoinButtonClicked:this.onJoinButtonClicked,onRejectButtonClicked:this.props.threepidInvite?this.onRejectThreepidInviteButtonClicked:this.onRejectButtonClicked});const w=u.a.createElement($.a,{room:this.state.room,fullHeight:!1,userId:this.context.credentials.userId,maxHeight:this.state.auxPanelMaxHeight,showApps:this.state.showApps,onResize:this.onResize,resizeNotifier:this.props.resizeNotifier},y);let C,k;if("join"===i&&!this.state.searchResults){const e=_.getComponent("rooms.MessageComposer");C=u.a.createElement(e,{room:this.state.room,callState:this.state.callState,showApps:this.state.showApps,e2eStatus:this.state.e2eStatus,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.getPermalinkCreatorForRoom(this.state.room),layout:this.state.layout})}this.state.searchResults&&(k={searchTerm:this.state.searchTerm,searchScope:this.state.searchScope,searchCount:this.state.searchResults.count});const O={mx_IRCLayout:this.state.layout==P.a.IRC,mx_GroupLayout:this.state.layout==P.a.Group,sc_BubbleLayout:this.state.layout==P.a.Bubble,sc_BubbleLayout_singleSide:this.state.layout==P.a.Bubble&&this.state.singleSideBubbles};let x,T=!1;if(this.state.searchResults){if(void 0===this.state.searchResults.count)x=u.a.createElement("div",{className:"mx_RoomView_messagePanel mx_RoomView_messagePanelSearchSpinner"});else{const e=m()("mx_RoomView_messagePanel","mx_RoomView_searchResultsPanel",O);x=u.a.createElement(V.a,{ref:this.searchResultsPanel,className:e,onFillRequest:this.onSearchResultsFillRequest,resizeNotifier:this.props.resizeNotifier},u.a.createElement("li",{className:r}),this.getSearchResultTiles())}T=!0}let j=null;this.state.isInitialEventHighlighted&&(j=this.state.initialEventId);const A=m()("mx_RoomView_messagePanel",O),M=u.a.createElement(K.a,{ref:this.gatherTimelinePanelRef,timelineSet:this.state.room.getUnfilteredTimelineSet(),showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!this.state.isPeeking,sendReadReceiptOnLoad:!this.state.wasContextSwitch,manageReadMarkers:!this.state.isPeeking,hidden:T,highlightedEventId:j,eventId:this.state.initialEventId,eventPixelOffset:this.state.initialEventPixelOffset,onScroll:this.onMessageListScroll,onUserScroll:this.onUserScroll,onReadMarkerUpdated:this.updateTopUnreadMessagesBar,showUrlPreview:this.state.showUrlPreview,className:A,membersLoaded:this.state.membersLoaded,permalinkCreator:this.getPermalinkCreatorForRoom(this.state.room),resizeNotifier:this.props.resizeNotifier,showReactions:!0,layout:this.state.layout,singleSideBubbles:this.state.singleSideBubbles,editState:this.state.editState});let L,F=null;if(this.state.showTopUnreadMessagesBar&&!this.state.searchResults){const e=_.getComponent("rooms.TopUnreadMessagesBar");F=u.a.createElement(e,{onScrollUpClick:this.jumpToReadMarker,onCloseClick:this.forgetReadMarker})}if(!this.state.atEndOfLiveTimeline&&!this.state.searchResults){const e=_.getComponent("rooms.JumpToBottomButton");L=u.a.createElement(e,{highlight:this.state.room.getUnreadNotificationCount(p.a.Highlight)>0,numUnreadMessages:this.state.numUnreadMessages,onScrollToBottomClick:this.jumpToLiveTimeline,roomId:this.state.roomId})}const B=m()("mx_RoomView_statusArea",{mx_RoomView_statusArea_expanded:l}),J=this.state.room&&this.state.showRightPanel?u.a.createElement(I.a,{room:this.state.room,resizeNotifier:this.props.resizeNotifier}):null,Q=m()("mx_RoomView_timeline",{mx_RoomView_timeline_rr_enabled:this.state.showReadReceipts}),X=m()("mx_RoomView",{mx_RoomView_inCall:Boolean(a)}),Z=N.b.getValue("showChatEffects");return u.a.createElement(U.a.Provider,{value:this.state},u.a.createElement("main",{className:X,ref:this.roomView,onKeyDown:this.onReactKeyDown},Z&&this.roomView.current&&u.a.createElement(Y.a,{roomWidth:this.roomView.current.offsetWidth}),u.a.createElement(W.a,null,u.a.createElement(z.a,{room:this.state.room,searchInfo:k,oobData:this.props.oobData,inRoom:"join"===i,onSearchClick:this.onSearchClick,onSettingsClick:this.onSettingsClick,onForgetClick:"leave"===i?this.onForgetClick:null,onLeaveClick:"join"===i?this.onLeaveClick:null,e2eStatus:this.state.e2eStatus,onAppsClick:this.state.hasPinnedWidgets?this.onAppsClick:null,appsShown:this.state.showApps,onCallPlaced:this.onCallPlaced}),u.a.createElement(R.a,{panel:J,resizeNotifier:this.props.resizeNotifier},u.a.createElement("div",{className:"mx_RoomView_body"},w,u.a.createElement("div",{className:Q},o,F,L,M,x),u.a.createElement("div",{className:B},u.a.createElement("div",{className:"mx_RoomView_statusAreaBox"},u.a.createElement("div",{className:"mx_RoomView_statusAreaBox_line"}),c)),f,C)))))}},l()(i,"contextType",L.a),n=o))||n}).call(this,s(169).setImmediate)},,,function(e,t,s){"use strict";s.d(t,"b",(function(){return g})),s.d(t,"a",(function(){return v}));var n=s(231),i=s(94);async function o(e,t){const s=i.a.get(),n={limit:10};void 0!==t&&(n.rooms=[t]);const o={search_categories:{room_events:{search_term:e,filter:n,order_by:"recent",event_context:{before_limit:1,after_limit:1,include_profile:!0}}}};return{response:await s.search({body:o}),query:o}}async function a(e,t){const s=i.a.get(),n=await o(e,t),a={_query:n.query,results:[],highlights:[]};return s.processRoomEventsSearch(a,n.response)}function r(e,t){const s=e.result,n=t.result;return s.origin_server_ts>n.origin_server_ts?-1:s.origin_server_ts<n.origin_server_ts?1:0}async function c(e,t,s=!0){const i=n.a.get(),o={search_term:e,before_limit:1,after_limit:1,limit:10,order_by_recency:!0,room_id:void 0};void 0!==t&&(o.room_id=t);const a=await i.search(o);o.next_batch=a.next_batch;return{response:a,query:o}}function l(e,t){try{const s=e.results[e.results.length-1].result,n=t.results[t.results.length-1].result;return s.origin_server_ts<=n.origin_server_ts?-1:1}catch{return 0}}function d(e,t,s,n){const i=s.concat(n).sort(r);t.results=i.slice(0,10),e.cachedEvents=i.slice(10)}function u(e,t,s){const n=function(e,t,s){const n={},i=e.cachedEvents;let o=e.oldestEventFrom;return n.highlights=e.highlights,t&&s&&s.results?(l(t,s)<0&&(o="local"),d(e,n,t.results,s.results),n.highlights=t.highlights.concat(s.highlights)):t?(l(t,i)<0&&(o="local"),d(e,n,t.results,i)):s&&s.results?(l(s,i)<0&&(o="server"),d(e,n,s.results,i)):(n.results=i,e.cachedEvents=[]),e.oldestEventFrom=o,n}(e,t,s);return e.count?n.count=e.count:n.count=t.count+s.count,t&&(e.seshatQuery.next_batch=t.next_batch),s&&(e.serverSideNextBatch=s.next_batch),e.seshatQuery.next_batch?n.next_batch=e.seshatQuery.next_batch:e.serverSideNextBatch&&(n.next_batch=e.serverSideNextBatch),!n.next_batch&&e.cachedEvents.length>0&&(n.next_batch="cached"),n}function h(e=[]){for(let t=0;t<e.length;t++){const s=e[t].context.getTimeline();for(let e=0;e<s.length;e++){const t=s[e];t.event.curve25519Key&&(t.makeEncrypted("m.room.encrypted",{algorithm:t.event.algorithm},t.event.curve25519Key,t.event.ed25519Key),t.forwardingCurve25519KeyChain=t.event.forwardingCurve25519KeyChain,delete t.event.curve25519Key,delete t.event.ed25519Key,delete t.event.algorithm,delete t.event.forwardingCurve25519KeyChain)}}}function m(e,t){let s;return s=void 0!==t?i.a.get().isRoomEncrypted(t)?async function(e,t){const s={results:[],highlights:[]};if(""===e)return s;const n=await c(e,t);s.seshatQuery=n.query;const o={search_categories:{room_events:n.response}},a=i.a.get().processRoomEventsSearch(s,o);return h(a.results),a}(e,t):a(e,t):async function(e){const t=i.a.get(),s=o(e),n=c(e);await Promise.all([s,n]);const a=await n,r=await s,l=r.query,d=r.response,m=a.query,p=a.response,g={seshatQuery:m,_query:l,serverSideNextBatch:d.next_batch,cachedEvents:[],oldestEventFrom:"server",results:[],highlights:[]},v={search_categories:{room_events:u(g,p,d.search_categories.room_events)}},f=t.processRoomEventsSearch(g,v);return h(f.results),f}(e),s}function p(e){const t=i.a.get(),s=e.seshatQuery,o=e._query;if(s){if(o){const t=async function(e){const t=n.a.get(),s=i.a.get(),o=e.seshatQuery,a=e.oldestEventFrom;let r,c,l;if(!o.next_batch||e.serverSideNextBatch&&"server"!==a||(r=await t.search(o)),e.serverSideNextBatch&&("local"===a||!o.next_batch)){const t={body:e._query,next_batch:e.serverSideNextBatch};c=await s.search(t)}c&&(l=c.search_categories.room_events);const d={search_categories:{room_events:u(e,r,l)}},m=e.results?e.results.length:0,p=s.processRoomEventsSearch(e,d),g=p.results.length-m;return h(p.results.slice(Math.max(p.results.length-g,0))),e.pendingRequest=null,p}(e);return e.pendingRequest=t,t}{const t=async function(e){const t=n.a.get(),s=e.seshatQuery,o=await t.search(s);e.seshatQuery.next_batch=o.next_batch;const a=o.results.length,r={search_categories:{room_events:o}},c=i.a.get().processRoomEventsSearch(e,r);return h(c.results.slice(Math.max(c.results.length-a,0))),e.pendingRequest=null,c}(e);return e.pendingRequest=t,t}}return t.backPaginateRoomEventsSearch(e)}function g(e){const t=n.a.get(),s=i.a.get();return e.pendingRequest?e.pendingRequest:null===t?s.backPaginateRoomEventsSearch(e):p(e)}function v(e,t){return null===n.a.get()?a(e,t):m(e,t)}},function(e,t,s){"use strict";(function(e){class s{constructor(){this._scrollStateMap={}}getScrollState(e){return this._scrollStateMap[e]}setScrollState(e,t){this._scrollStateMap[e]=t}}void 0===e.mx_RoomScrollStateStore&&(e.mx_RoomScrollStateStore=new s),t.a=e.mx_RoomScrollStateStore}).call(this,s(7))},function(e,t,s){var n={"./":[207,9],"./ICanvasEffect":[738,7,6],"./ICanvasEffect.ts":[738,7,6],"./confetti":[344,9,0],"./confetti/":[344,9,0],"./confetti/index":[344,9,0],"./confetti/index.ts":[344,9,0],"./effect":[739,7,7],"./effect.ts":[739,7,7],"./fireworks":[345,9,1],"./fireworks/":[345,9,1],"./fireworks/index":[345,9,1],"./fireworks/index.ts":[345,9,1],"./index":[207,9],"./index.ts":[207,9],"./snowfall":[346,9,2],"./snowfall/":[346,9,2],"./snowfall/index":[346,9,2],"./snowfall/index.ts":[346,9,2],"./spaceinvaders":[347,9,3],"./spaceinvaders/":[347,9,3],"./spaceinvaders/index":[347,9,3],"./spaceinvaders/index.ts":[347,9,3],"./utils":[286,9],"./utils.ts":[286,9]};function i(e){if(!s.o(n,e))return Promise.resolve().then((function(){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=n[e],i=t[0];return Promise.all(t.slice(2).map(s.e)).then((function(){return s.t(i,t[1])}))}i.keys=function(){return Object.keys(n)},i.id=1267,e.exports=i},function(e,t){e.exports="img/upload-big.f4f6b61.svg"},function(e,t){e.exports="img/element-icons/brands/apple.5160971.svg"},function(e,t){e.exports="img/element-icons/brands/facebook.c3243cf.svg"},function(e,t){e.exports="img/element-icons/brands/github.bf60283.svg"},function(e,t){e.exports="img/element-icons/brands/gitlab.d4ee177.svg"},function(e,t){e.exports="img/element-icons/brands/google.04f5e48.svg"},function(e,t){e.exports="img/element-icons/brands/twitter.892d1c7.svg"},,function(e,t){e.exports="img/feather-customised/files.d6a33b8.svg"},function(e,t){e.exports="img/download.dc05f15.svg"},,,,,,function(e,t){e.exports="img/stickerpack-placeholder.9c54c13.png"},function(e,t){e.exports="img/room_replaced.80042bb.svg"},function(e,t){e.exports="img/icons-room-add.bd36e26.svg"},function(e,t){e.exports="img/camera.2f271b6.svg"},function(e,t){e.exports="img/icons-groups.2e501f9.svg"},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return g}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(97),u=s.n(d),h=s(92),m=s(120),p=s(93);let g=Object(p.a)("views.auth.CaptchaForm")((o=i=class extends l.a.Component{constructor(e){super(e),this.state={errorText:null},this._captchaWidgetId=null,this._recaptchaContainer=Object(c.createRef)(),m.a.instance.track("onboarding_grecaptcha_begin")}componentDidMount(){if(e.grecaptcha)this._onCaptchaLoaded();else{console.log("Loading recaptcha script..."),window.mx_on_recaptcha_loaded=()=>{this._onCaptchaLoaded()};const e=document.createElement("script");e.setAttribute("src","https://www.recaptcha.net/recaptcha/api.js?onload=mx_on_recaptcha_loaded&render=explicit"),this._recaptchaContainer.current.appendChild(e)}}componentWillUnmount(){this._resetRecaptcha()}_renderRecaptcha(t){if(!e.grecaptcha)throw console.error("grecaptcha not loaded!"),new Error("Recaptcha did not load successfully");const s=this.props.sitePublicKey;if(!s)throw console.error("No public key for recaptcha!"),new Error("This server has not supplied enough information for Recaptcha authentication");console.info("Rendering to %s",t),this._captchaWidgetId=e.grecaptcha.render(t,{sitekey:s,callback:this.props.onCaptchaResponse})}_resetRecaptcha(){null!==this._captchaWidgetId&&e.grecaptcha.reset(this._captchaWidgetId)}_onCaptchaLoaded(){console.log("Loaded recaptcha script.");try{this._renderRecaptcha("mx_recaptcha"),this.setState({errorText:null}),m.a.instance.track("onboarding_grecaptcha_loaded")}catch(e){this.setState({errorText:e.toString()}),m.a.instance.track("onboarding_grecaptcha_error",{error:e.toString()})}}render(){let e=null;return this.state.errorText&&(e=l.a.createElement("div",{className:"error"},this.state.errorText)),l.a.createElement("div",{ref:this._recaptchaContainer},l.a.createElement("p",null,Object(h.a)("This homeserver would like to make sure you are not a robot.")),l.a.createElement("div",{id:"mx_recaptcha"}),e)}},r()(i,"propTypes",{sitePublicKey:u.a.string,onCaptchaResponse:u.a.func}),r()(i,"defaultProps",{onCaptchaResponse:()=>{}}),n=o))||n}).call(this,s(7))},function(e,t){e.exports="img/icon_context_delete.f02c798.svg"},function(e,t){e.exports="img/search-icon-vector.c463bb6.svg"},function(e,t){e.exports="img/icon-email-user.af133ff.svg"},function(e,t){e.exports="img/icon-address-delete.40c8a04.svg"},,,function(e,t){e.exports="img/icons-show-stickers.72da54e.svg"},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return M}));var n,i,o,a=s(18),r=s.n(a),c=s(91),l=s.n(c),d=s(147),u=s.n(d),h=s(97),m=s.n(h),p=s(675),g=s.n(p),v=s(134),f=s(150),b=s(95),y=s(99),_=s(96),E=s(92),S=s(109),w=s(98),C=s(234),k=s(735),O=s(183),R=s(122),I=s(142),x=s(113),T=s(93),j=s(154),N=s(1297),P=s(103);function D(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function A(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?D(Object(s),!0).forEach((function(t){r()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):D(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let M=Object(T.a)("views.messages.TextualBody")((o=i=class extends l.a.Component{constructor(t){super(t),r()(this,"onCancelClick",t=>{this.setState({widgetHidden:!0}),e.localStorage&&e.localStorage.setItem("hide_preview_"+this.props.mxEvent.getId(),"1"),this.forceUpdate()}),r()(this,"onEmoteSenderClick",e=>{const t=this.props.mxEvent;_.a.dispatch,N.ComposerInsertPayload,P.a.ComposerInsert,t.getSender()}),r()(this,"getEventTileOps",()=>({isWidgetHidden:()=>this.state.widgetHidden,unhideWidget:()=>{this.setState({widgetHidden:!1}),e.localStorage&&e.localStorage.removeItem("hide_preview_"+this.props.mxEvent.getId())}})),r()(this,"onStarterLinkClick",(e,t)=>{t.preventDefault();const s=O.a.sharedInstance();if(!s.hasManager())return void s.openNoManagerDialog();const n=s.getPrimaryManager(),i=n.getScalarClient();i.connect().then(()=>{const t=i.getStarterLink(e),s=b.getComponent("dialogs.QuestionDialog"),o=n.uiUrl;y.a.createTrackedDialog("Add an integration","",s,{title:Object(E.a)("Add an Integration"),description:l.a.createElement("div",null,Object(E.a)("You are about to be taken to a third-party site so you can authenticate your account for use with %(integrationsUrl)s. Do you wish to continue?",{integrationsUrl:o})),button:Object(E.a)("Continue"),onFinished(e){if(!e)return;const s=window.screen.width>1024?1024:window.screen.width,n=window.screen.height>800?800:window.screen.height,i=(window.screen.width-s)/2,o=`height=${n}, width=${s}, top=${(window.screen.height-n)/2}, left=${i},`;window.open(t,"_blank",o).opener=null}})})}),r()(this,"_openHistoryDialog",async()=>{const e=b.getComponent("views.dialogs.MessageEditHistoryDialog");y.a.createDialog(e,{mxEvent:this.props.mxEvent})}),this._content=Object(c.createRef)(),this.state={links:[],widgetHidden:!1}}componentDidMount(){this._unmounted=!1,this._pills=[],this.props.editState||this._applyFormatting()}_applyFormatting(){const e=w.b.getValue("showCodeLineNumbers");if(this.activateSpoilers([this._content.current]),Object(k.a)([this._content.current],this.props.mxEvent,this._pills),v.g(this._content.current),this.calculateUrlPreview(),"org.matrix.custom.html"===this.props.mxEvent.getContent().format){const t=u.a.findDOMNode(this).getElementsByTagName("pre");if(t.length>0)for(let s=0;s<t.length;s++){if("mx_EventTile_pre_container"==t[s].parentNode.className)continue;0==t[s].getElementsByTagName("code").length&&this._addCodeElement(t[s]);const n=this._wrapInDiv(t[s]);this._handleCodeBlockExpansion(t[s]),this._addCodeExpansionButton(n,t[s]),this._addCodeCopyButton(n),e&&this._addLineNumbers(t[s])}const s=u.a.findDOMNode(this).getElementsByTagName("code");s.length>0&&setTimeout(()=>{if(!this._unmounted)for(let e=0;e<s.length;e++)s[e].className.includes("hljs")||this._highlightCode(s[e])},10)}}_addCodeElement(e){const t=document.createElement("code");t.append(...e.childNodes),e.appendChild(t)}_addCodeExpansionButton(e,t){if(t.offsetHeight/j.b.instance.windowHeight*100<30)return;const s=document.createElement("span");s.className="mx_EventTile_button ","mx_EventTile_collapsedCodeBlock"==t.className?s.className+="mx_EventTile_expandButton":s.className+="mx_EventTile_collapseButton",s.onclick=async()=>{s.className="mx_EventTile_button ","mx_EventTile_collapsedCodeBlock"==t.className?(t.className="",s.className+="mx_EventTile_collapseButton"):(t.className="mx_EventTile_collapsedCodeBlock",s.className+="mx_EventTile_expandButton"),this.props.onHeightChanged()},e.appendChild(s)}_addCodeCopyButton(e){const t=document.createElement("span");t.className="mx_EventTile_button mx_EventTile_copyButton ";e.getElementsByClassName("mx_EventTile_button").length>0&&(t.className+="mx_EventTile_buttonBottom"),t.onclick=async()=>{const e=t.parentNode.getElementsByTagName("code")[0],s=await Object(I.c)(e.textContent),n=t.getBoundingClientRect(),i=b.getComponent("context_menus.GenericTextContextMenu"),{close:o}=S.n(i,A(A({},Object(S.p)(n,2)),{},{message:s?Object(E.a)("Copied!"):Object(E.a)("Failed to copy")}));t.onmouseleave=o},e.appendChild(t)}_wrapInDiv(e){const t=document.createElement("div");return t.className="mx_EventTile_pre_container",t.dir="auto",e.parentNode.replaceChild(t,e),t.appendChild(e),t}_handleCodeBlockExpansion(e){w.b.getValue("expandCodeByDefault")||(e.className="mx_EventTile_collapsedCodeBlock")}_addLineNumbers(e){const t=e.innerHTML.replace(/\n(<\/code>)?$/,"").split(/\n/).length;e.innerHTML='<span class="mx_EventTile_lineNumbers"></span>'+e.innerHTML+"<span></span>";const s=e.getElementsByClassName("mx_EventTile_lineNumbers")[0];for(let e=1;e<=t;e++)s.innerHTML+='<span class="mx_EventTile_lineNumber">'+e+"</span>"}_highlightCode(e){if(w.b.getValue("enableSyntaxHighlightLanguageDetection"))g.a.highlightBlock(e);else{0!=e.className.split(/\s+/).filter((function(e){return e.startsWith("language-")&&!e.startsWith("language-_")})).length&&g.a.highlightBlock(e)}}componentDidUpdate(e){if(!this.props.editState){const t=e.editState&&!this.props.editState;(e.replacingEventId!==this.props.replacingEventId||t)&&this._applyFormatting()}}componentWillUnmount(){this._unmounted=!0,Object(k.b)(this._pills)}shouldComponentUpdate(e,t){return e.mxEvent.getId()!==this.props.mxEvent.getId()||e.highlights!==this.props.highlights||e.replacingEventId!==this.props.replacingEventId||e.highlightLink!==this.props.highlightLink||e.showUrlPreview!==this.props.showUrlPreview||e.editState!==this.props.editState||t.links!==this.state.links||t.widgetHidden!==this.state.widgetHidden}calculateUrlPreview(){if(this.props.showUrlPreview){let t=this.findLinks([this._content.current]);if(t.length){if(t=Array.from(new Set(t.map(e=>{const t=new URL(e);return t.hash="",t.toString()}))),this.setState({links:t}),e.localStorage){const t=e.localStorage.getItem("hide_preview_"+this.props.mxEvent.getId());this.setState({widgetHidden:t})}}else this.state.links.length&&this.setState({links:[]})}}activateSpoilers(e){let t=e[0];for(;t;){if("SPAN"===t.tagName&&"string"==typeof t.getAttribute("data-mx-spoiler")){const e=document.createElement("span"),s=t.getAttribute("data-mx-spoiler"),n=b.getComponent("elements.Spoiler");t.removeAttribute("data-mx-spoiler");const i=l.a.createElement(n,{reason:s,contentHtml:t.outerHTML});u.a.render(i,e),t.parentNode.replaceChild(e,t),t=e}t.childNodes&&t.childNodes.length&&this.activateSpoilers(t.childNodes),t=t.nextSibling}}findLinks(e){let t=[];for(let s=0;s<e.length;s++){const n=e[s];if("A"===n.tagName&&n.getAttribute("href"))this.isLinkPreviewable(n)&&t.push(n.getAttribute("href"));else{if("PRE"===n.tagName||"CODE"===n.tagName||"BLOCKQUOTE"===n.tagName)continue;n.children&&n.children.length&&(t=t.concat(this.findLinks(n.children)))}}return t}isLinkPreviewable(e){if(!e.getAttribute("href").startsWith("http://")&&!e.getAttribute("href").startsWith("https://"))return!1;if(e.textContent.indexOf("/")>-1)return!0;{const t=e.getAttribute("href").match(/^https?:\/\/(.*?)(\/|$)/)[1];return!Object(R.d)(t)&&!e.textContent.toLowerCase().trim().startsWith(t.toLowerCase())}}_renderEditedMarker(){const e=this.props.mxEvent.replacingEventDate(),t=e&&Object(f.a)(e),s=l.a.createElement("div",null,l.a.createElement("div",{className:"mx_Tooltip_title"},Object(E.a)("Edited at %(date)s",{date:t})),l.a.createElement("div",{className:"mx_Tooltip_sub"},Object(E.a)("Click to view edits")));return l.a.createElement(x.a,{className:"mx_EventTile_edited",onClick:this._openHistoryDialog,title:Object(E.a)("Edited at %(date)s. Click to view edits.",{date:t}),tooltip:s},l.a.createElement("span",null,`(${Object(E.a)("edited")})`))}render(){if(this.props.editState){const e=b.getComponent("rooms.EditMessageComposer");return l.a.createElement(e,{editState:this.props.editState,className:"mx_EventTile_content",dir:"auto"})}const e=this.props.mxEvent,t=e.getContent(),s=!e.replacingEvent()&&C.a.getParentEventId(e);let n,i=v.b(t,this.props.highlights,{disableBigEmoji:"m.emote"===t.msgtype||!w.b.getValue("TextualBody.enableBigEmoji"),stripReplyFallback:s,ref:this._content});if(this.props.replacingEventId&&(i=l.a.createElement(l.a.Fragment,null,i,this._renderEditedMarker())),this.props.highlightLink?i=l.a.createElement("a",{href:this.props.highlightLink},i):t.data&&"string"==typeof t.data["org.matrix.neb.starter_link"]&&(i=l.a.createElement("a",{href:"#",onClick:this.onStarterLinkClick.bind(this,t.data["org.matrix.neb.starter_link"])},i)),this.state.links.length&&!this.state.widgetHidden&&this.props.showUrlPreview){const e=b.getComponent("rooms.LinkPreviewWidget");n=this.state.links.map(t=>l.a.createElement(e,{key:t,link:t,mxEvent:this.props.mxEvent,onCancelClick:this.onCancelClick,onHeightChanged:this.props.onHeightChanged}))}switch(t.msgtype){case"m.emote":return l.a.createElement("span",{className:"mx_MEmoteBody mx_EventTile_content",dir:"auto"},"* ",l.a.createElement("span",{className:"mx_MEmoteBody_sender",onClick:this.onEmoteSenderClick},e.sender?e.sender.name:e.getSender())," ",i,n,this.props.scBubbleGroupTimestamp);case"m.notice":return l.a.createElement("span",{className:"mx_MNoticeBody mx_EventTile_content",dir:"auto"},i,n,this.props.scBubbleGroupTimestamp);default:return l.a.createElement("span",{className:"mx_MTextBody mx_EventTile_content",dir:"auto"},i,n,this.props.scBubbleGroupTimestamp)}}},r()(i,"propTypes",{mxEvent:m.a.object.isRequired,highlights:m.a.array,highlightLink:m.a.string,showUrlPreview:m.a.bool,onHeightChanged:m.a.func,tileShape:m.a.string,scBubbleGroupTimestamp:m.a.object}),n=o))||n}).call(this,s(7))},function(e,t){},function(e,t,s){"use strict";(function(e){var t=s(152),n=s(1299),i=s.n(n),o=s(1300),a=s.n(o);let r;t.request((function(e,t){return e.qs=a.a.stringify(e.qs||{},e.qsStringifyOptions),i()(e,t)}));try{r=e.indexedDB}catch(e){}r&&t.setCryptoStoreFactory((function(){return new t.IndexedDBCryptoStore(r,"matrix-js-sdk:crypto")}));e.matrixcs=t}).call(this,s(7))},,,,,function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return c}));var n=s(229),i=s.n(n);function o(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function a(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?o(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):o(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const r={bgColor:"#d00",textColor:"#fff",fontFamily:"sans-serif",fontWeight:"bold",isUp:!1,isLeft:!1};class c{constructor(e={}){i()(this,"browser",{ff:void 0!==window.InstallTrigger,opera:!!window.opera||navigator.userAgent.includes("Opera")}),i()(this,"params",void 0),i()(this,"canvas",void 0),i()(this,"baseImage",void 0),i()(this,"context",void 0),i()(this,"icons",void 0),i()(this,"isReady",!1),i()(this,"readyCb",()=>{}),this.params=a(a({},r),e),this.icons=c.getIcons(),this.canvas=document.createElement("canvas"),this.baseImage=document.createElement("img");const t=this.icons[this.icons.length-1];t.hasAttribute("href")?(this.baseImage.setAttribute("crossOrigin","anonymous"),this.baseImage.onload=()=>{this.canvas.height=this.baseImage.height>0?this.baseImage.height:32,this.canvas.width=this.baseImage.width>0?this.baseImage.width:32,this.context=this.canvas.getContext("2d"),this.ready()},this.baseImage.setAttribute("src",t.getAttribute("href"))):(this.canvas.height=this.baseImage.height=32,this.canvas.width=this.baseImage.width=32,this.context=this.canvas.getContext("2d"),this.ready())}reset(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.baseImage,0,0,this.canvas.width,this.canvas.height)}options(e,t){const s={n:"number"==typeof e?Math.abs(e):e,len:(""+e).length,x:.4,y:.4,w:.6,h:.6};return t.isUp&&(s.y<.6?s.y=s.y-.4:s.y=s.y-2*s.y+(1-s.w)),t.isLeft&&(s.x<.6?s.x=s.x-.4:s.x=s.x-2*s.x+(1-s.h)),s.x=this.canvas.width*s.x,s.y=this.canvas.height*s.y,s.w=this.canvas.width*s.w,s.h=this.canvas.height*s.h,s}circle(e,t){const s=a(a({},this.params),t),n=this.options(e,s);let i=!1;2===n.len?(n.x=n.x-.4*n.w,n.w=1.4*n.w,i=!0):n.len>=3&&(n.x=n.x-.65*n.w,n.w=1.65*n.w,i=!0),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.baseImage,0,0,this.canvas.width,this.canvas.height),this.context.beginPath();const o=Math.floor(n.h*(n.n>99?.85:1))+"px";if(this.context.font=`${s.fontWeight} ${o} ${s.fontFamily}`,this.context.textAlign="center",i?(this.context.moveTo(n.x+n.w/2,n.y),this.context.lineTo(n.x+n.w-n.h/2,n.y),this.context.quadraticCurveTo(n.x+n.w,n.y,n.x+n.w,n.y+n.h/2),this.context.lineTo(n.x+n.w,n.y+n.h-n.h/2),this.context.quadraticCurveTo(n.x+n.w,n.y+n.h,n.x+n.w-n.h/2,n.y+n.h),this.context.lineTo(n.x+n.h/2,n.y+n.h),this.context.quadraticCurveTo(n.x,n.y+n.h,n.x,n.y+n.h-n.h/2),this.context.lineTo(n.x,n.y+n.h/2),this.context.quadraticCurveTo(n.x,n.y,n.x+n.h/2,n.y)):this.context.arc(n.x+n.w/2,n.y+n.h/2,n.h/2,0,2*Math.PI),this.context.fillStyle=s.bgColor,this.context.fill(),this.context.closePath(),this.context.beginPath(),this.context.stroke(),this.context.fillStyle=s.textColor,"number"==typeof n.n&&n.n>999){const e=(n.n>9999?9:Math.floor(n.n/1e3))+"k+";this.context.fillText(e,Math.floor(n.x+n.w/2),Math.floor(n.y+n.h-.2*n.h))}else this.context.fillText(""+n.n,Math.floor(n.x+n.w/2),Math.floor(n.y+n.h-.15*n.h));this.context.closePath()}ready(){this.isReady||(this.isReady=!0,this.readyCb())}setIcon(t){e(()=>{this.setIconSrc(t.toDataURL("image/png"))})}setIconSrc(e){if(this.browser.ff||this.browser.opera){const t=this.icons[this.icons.length-1],s=window.document.createElement("link");this.icons=[s],s.setAttribute("rel","icon"),s.setAttribute("type","image/png"),window.document.getElementsByTagName("head")[0].appendChild(s),s.setAttribute("href",e),t.parentNode&&t.parentNode.removeChild(t)}else this.icons.forEach(t=>{t.setAttribute("href",e)})}badge(e,t){this.isReady?("string"==typeof e||e>0?this.circle(e,t):this.reset(),this.setIcon(this.canvas)):this.readyCb=()=>{this.badge(e,t)}}static getLinks(){const e=[],t=window.document.getElementsByTagName("head")[0].getElementsByTagName("link");for(let s=0;s<t.length;s++)/(^|\s)icon(\s|$)/i.test(t[s].getAttribute("rel"))&&e.push(t[s]);return e}static getIcons(){let e=c.getLinks();return 0===e.length&&(e=[window.document.createElement("link")],e[0].setAttribute("rel","icon"),window.document.getElementsByTagName("head")[0].appendChild(e[0])),e.forEach(e=>{e.setAttribute("type","image/png")}),e}}}).call(this,s(169).setImmediate)},,,,,,,,,,,,function(e,t,s){"use strict";s.r(t),s.d(t,"components",(function(){return aE}));var n=s(125),i=s(109),o=s(91),a=s.n(o),r=s(354),c=s(92),l=s(102),d=s(95),u=s(96),h=s(103),m=s(130),p=s(212),g=s(100),v=s(123),f=s(131),b=s(105),y=s(356),_=s(132),E=s(120);const S=()=>{_.a.trackEvent("home_page","button","dm"),E.a.instance.track("home_page_button",{button:"dm"}),u.a.dispatch({action:"view_create_chat"})},w=()=>{_.a.trackEvent("home_page","button","room_directory"),E.a.instance.track("home_page_button",{button:"room_directory"}),u.a.fire(h.a.ViewRoomDirectory)},C=()=>{_.a.trackEvent("home_page","button","create_room"),E.a.instance.track("home_page_button",{button:"create_room"}),u.a.dispatch({action:"view_create_room"})},k=e=>({displayName:p.a.instance.displayName||e,avatarUrl:p.a.instance.getHttpAvatarUrl(y.a)}),O=()=>{const e=Object(o.useContext)(b.a),t=e.getUserId(),[s,n]=Object(o.useState)(k(t));return Object(f.a)(p.a.instance,v.b,()=>{n(k(t))}),o.createElement("div",null,o.createElement(y.b,{hasAvatar:!!s.avatarUrl,hasAvatarLabel:Object(c.a)("Great, that'll help people know it's you"),noAvatarLabel:Object(c.a)("Add a photo so people know it's you."),setAvatarUrl:t=>e.setAvatarUrl(t)},o.createElement(m.a,{idName:t,name:s.displayName,url:s.avatarUrl,width:y.a,height:y.a,resizeMethod:"crop"})),o.createElement("h1",null,Object(c.a)("Welcome %(name)s",{name:s.displayName})),o.createElement("h4",null,Object(c.a)("Now, let's help you get started")))};var R=({justRegistered:e=!1})=>{const t=l.a.get(),s=Object(r.a)(t);if(s){const e=d.getComponent("structures.EmbeddedPage");return o.createElement(e,{className:"mx_HomePage",url:s,scrollbar:!0})}let i;if(e)i=o.createElement(O,null);else{const e=t.branding;let s="themes/element/img/logos/element-logo.svg";e&&e.authHeaderLogoUrl&&(s=e.authHeaderLogoUrl),i=o.createElement(o.Fragment,null,o.createElement("img",{src:s,alt:t.brand}),o.createElement("h1",null,Object(c.a)("Welcome to %(appName)s",{appName:t.brand})),o.createElement("h4",null,Object(c.a)("Liberate your communication")))}return o.createElement(n.a,{className:"mx_HomePage mx_HomePage_default"},o.createElement("div",{className:"mx_HomePage_default_wrapper"},i,o.createElement("div",{className:"mx_HomePage_default_buttons"},o.createElement(g.a,{onClick:S,className:"mx_HomePage_button_sendDm"},Object(c.a)("Send a Direct Message")),o.createElement(g.a,{onClick:w,className:"mx_HomePage_button_explore"},Object(c.a)("Explore Public Rooms")),o.createElement(g.a,{onClick:C,className:"mx_HomePage_button_createGroup"},Object(c.a)("Create a Group Chat")))))},I=s(18),x=s.n(I),T=s(176);class j extends v.a{constructor(){super(u.a,{hostSignupActive:!1})}static get instance(){return j.internalInstance}get isHostSignupActive(){return this.state.hostSignupActive}async setHostSignupActive(e){return this.updateState({hostSignupActive:e})}onDispatch(e){}}x()(j,"internalInstance",new j);var N,P=s(93);let D=Object(P.a)("structures.HostSignupAction")(N=class extends a.a.PureComponent{constructor(...e){super(...e),x()(this,"openDialog",async()=>{var e,t;null===(e=(t=this.props).onClick)||void 0===e||e.call(t),await j.instance.setHostSignupActive(!0)})}render(){const e=l.a.get().hostSignup;return null!=e&&e.brand?a.a.createElement(T.c,null,a.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconHosting",label:Object(c.a)("Upgrade to %(hostSignupBrand)s",{hostSignupBrand:e.brand}),onClick:this.openDialog})):null}})||N;var A=s(101),M=s.n(A),U=s(177),L=s(358);class F{static fetchJoinedGroups(e){return Object(L.a)("GroupActions.fetchJoinedGroups",()=>e.getJoinedGroups(),null)}}var B,V=s(98),K=s(113);let W=Object(P.a)("views.elements.UserTagTile")(B=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"tagStoreRef",void 0),x()(this,"onTagStoreUpdate",()=>{const e=0===U.a.getSelectedTags().length;this.setState({selected:e})}),x()(this,"onTileClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"deselect_tags"})}),this.state={selected:0===U.a.getSelectedTags().length}}componentDidMount(){this.tagStoreRef=U.a.addListener(this.onTagStoreUpdate)}componentWillUnmount(){this.tagStoreRef.remove()}render(){const e=M()({mx_TagTile:!0,mx_TagTile_prototype:!0,mx_TagTile_selected_prototype:this.state.selected,mx_TagTile_home:!0});return a.a.createElement(K.a,{className:e,onClick:this.onTileClick,title:Object(c.a)("Home")},a.a.createElement("div",{className:"mx_TagTile_avatar"},a.a.createElement("div",{className:"mx_TagTile_homeIcon"})))}})||B;var G,q,H;var $,z=Object(P.a)("structures.GroupFilterPanel")((H=q=class extends a.a.Component{constructor(...e){super(...e),x()(this,"state",{orderedTags:[],selectedTags:[]}),x()(this,"_onGroupMyMembership",()=>{this.unmounted||u.a.dispatch(F.fetchJoinedGroups(this.context))}),x()(this,"_onClientSync",(e,t)=>{"ERROR"!==e&&t!==e&&u.a.dispatch(F.fetchJoinedGroups(this.context))}),x()(this,"onClick",e=>{this.state.selectedTags.length>0&&u.a.dispatch({action:"deselect_tags"})}),x()(this,"onClearFilterClick",e=>{u.a.dispatch({action:"deselect_tags"})})}componentDidMount(){this.unmounted=!1,this.context.on("Group.myMembership",this._onGroupMyMembership),this.context.on("sync",this._onClientSync),this._groupFilterOrderStoreToken=U.a.addListener(()=>{this.unmounted||this.setState({orderedTags:U.a.getOrderedTags()||[],selectedTags:U.a.getSelectedTags()})}),u.a.dispatch(F.fetchJoinedGroups(this.context))}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("Group.myMembership",this._onGroupMyMembership),this.context.removeListener("sync",this._onClientSync),this._groupFilterOrderStoreToken&&this._groupFilterOrderStoreToken.remove()}renderGlobalIcon(){return V.b.getValue("feature_communities_v2_prototypes")?a.a.createElement("div",null,a.a.createElement(W,null),a.a.createElement("hr",{className:"mx_GroupFilterPanel_divider"})):null}render(){const e=d.getComponent("elements.DNDTagTile"),t=d.getComponent("elements.ActionButton"),s=this.state.orderedTags.map((t,s)=>a.a.createElement(e,{key:t,tag:t,index:s,selected:this.state.selectedTags.includes(t)})),i=this.state.selectedTags.length>0,o=M()("mx_GroupFilterPanel",{mx_GroupFilterPanel_items_selected:i});let r;V.b.getBetaInfo("feature_spaces")&&!localStorage.getItem("mx_seenSpacesBeta")&&(r=a.a.createElement("div",{className:"mx_BetaDot"}));let l=a.a.createElement(t,{tooltip:!0,label:Object(c.a)("Communities"),action:"toggle_my_groups",className:"mx_TagTile mx_TagTile_plus"},r);return V.b.getValue("feature_communities_v2_prototypes")&&(l=a.a.createElement(t,{tooltip:!0,label:Object(c.a)("Create community"),action:"view_create_group",className:"mx_TagTile mx_TagTile_plus"})),a.a.createElement("div",{className:o,onClick:this.onClearFilterClick},a.a.createElement(n.a,{className:"mx_GroupFilterPanel_scroller",onClick:this.onClick},a.a.createElement("div",{className:"mx_GroupFilterPanel_tagTileContainer"},this.renderGlobalIcon(),s,a.a.createElement("div",null,l))))}},x()(q,"contextType",b.a),G=H))||G,Y=s(498),J=s(162);let Q=Object(P.a)("structures.CustomRoomTagPanel")($=class extends a.a.Component{constructor(e){super(e),this.state={tags:Y.a.getSortedTags()}}componentDidMount(){this._tagStoreToken=Y.a.addListener(()=>{this.setState({tags:Y.a.getSortedTags()})})}componentWillUnmount(){this._tagStoreToken&&this._tagStoreToken.remove()}render(){const e=this.state.tags.map(e=>a.a.createElement(X,{tag:e,key:e.name})),t=M()("mx_CustomRoomTagPanel",{mx_CustomRoomTagPanel_empty:0===this.state.tags.length});return a.a.createElement("div",{className:t},a.a.createElement("div",{className:"mx_CustomRoomTagPanel_divider"}),a.a.createElement(n.a,{className:"mx_CustomRoomTagPanel_scroller"},e))}})||$;class X extends a.a.Component{constructor(...e){super(...e),x()(this,"onClick",()=>{u.a.dispatch({action:"select_custom_room_tag",tag:this.props.tag.name})})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=d.getComponent("elements.AccessibleTooltipButton"),s=this.props.tag,n=M()({CustomRoomTagPanel_tileSelected:s.selected}),i=s.name,o=s.badgeNotifState;let r;if(o){const e=M()({mx_TagTile_badge:!0,mx_TagTile_badgeHighlight:o.hasMentions});r=a.a.createElement("div",{className:e},J.c(o.count))}return a.a.createElement(t,{className:n,onClick:this.onClick,title:i},a.a.createElement("div",{className:"mx_TagTile_avatar"},a.a.createElement(e,{name:s.avatarLetter,idName:i,width:40,height:40}),r))}}var Z,ee,te,se=Q,ne=s(110),ie=s(175),oe=s(159),ae=s(133),re=s(146),ce=s(454),le=s(94),de=s(104),ue=s.n(de),he=s(108),me=s.n(he),pe=s(107);let ge=Object(P.a)("views.avatars.GroupAvatar")((te=ee=class extends a.a.Component{getGroupAvatarUrl(){return this.props.groupAvatarUrl?Object(pe.b)(this.props.groupAvatarUrl).getThumbnailOfSourceHttp(this.props.width,this.props.height,this.props.resizeMethod):null}render(){const e=this.props,{groupId:t,groupAvatarUrl:s,groupName:n}=e,i=me()(e,["groupId","groupAvatarUrl","groupName"]);return a.a.createElement(m.a,ue()({name:n||this.props.groupId[1],idName:this.props.groupId,url:this.getGroupAvatarUrl()},i))}},x()(ee,"defaultProps",{width:36,height:36,resizeMethod:"crop"}),Z=te))||Z;var ve=s(180);class fe extends a.a.Component{constructor(e){super(e),x()(this,"onTileMouseEnter",()=>{this.setState({hover:!0})}),x()(this,"onTileMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){var e;const t=M()({mx_ExtraTile:!0,mx_RoomTile:!0,mx_RoomTile_selected:this.props.isSelected,mx_RoomTile_minimized:this.props.isMinimized});let s;this.props.notificationState&&(s=a.a.createElement(ve.a,{notification:this.props.notificationState,forceCount:!1}));let n=this.props.displayName;"string"!=typeof n&&(n=""),n=n.replace(":",":​");const i=M()({mx_RoomTile_name:!0,mx_RoomTile_nameHasUnreadEvents:null===(e=this.props.notificationState)||void 0===e?void 0:e.isUnread});let o=a.a.createElement("div",{className:"mx_RoomTile_nameContainer"},a.a.createElement("div",{title:n,className:i,tabIndex:-1,dir:"auto"},n));this.props.isMinimized&&(o=null);let r=ie.a;return this.props.isMinimized&&(r=ie.b),a.a.createElement(a.a.Fragment,null,a.a.createElement(r,{className:t,onMouseEnter:this.onTileMouseEnter,onMouseLeave:this.onTileMouseLeave,onClick:this.props.onClick,role:"treeitem",title:this.props.isMinimized?n:void 0},a.a.createElement("div",{className:"mx_RoomTile_avatarContainer"},this.props.avatar),o,a.a.createElement("div",{className:"mx_RoomTile_badgeContainer"},s)))}}var be,ye=s(247),_e=s(174),Ee=s(121),Se=s(141),we=s(182),Ce=s(145),ke=s(280),Oe=s(129);const Re=[re.a.Invite,re.a.Favourite,re.a.Unified,re.a.DM,re.a.Untagged,re.a.LowPriority,re.a.ServerNotice,re.a.Suggested,re.a.Archived],Ie=re.a.LowPriority,xe=[re.a.DM,re.a.Untagged],Te=[re.a.Unified],je={[re.a.Invite]:{sectionLabel:Object(c.b)("Invites"),isInvite:!0,defaultHidden:!1},[re.a.Favourite]:{sectionLabel:Object(c.b)("Favourites"),isInvite:!1,defaultHidden:!1},[re.a.Unified]:{sectionLabel:Object(c.b)("Normal priority"),isInvite:!1,defaultHidden:!1,addDirectRoomLabel:Object(c.b)("Start chat"),addGroupRoomLabel:Object(c.b)("Create new room"),onAddDirectRoom:e=>{(e||u.a).dispatch({action:"view_create_chat"})},onAddGroupRoom:e=>{(e||u.a).dispatch({action:"view_create_room"})}},[re.a.DM]:{sectionLabel:Object(c.b)("People"),isInvite:!1,defaultHidden:!1,addRoomLabel:Object(c.b)("Start chat"),onAddRoom:e=>{(e||u.a).dispatch({action:"view_create_chat"})}},[re.a.Untagged]:{sectionLabel:Object(c.b)("Rooms"),isInvite:!1,defaultHidden:!1,addRoomLabel:Object(c.b)("Add room"),addRoomContextMenu:e=>{if(Ce.f.instance.activeSpace){const t=Ce.f.instance.activeSpace.currentState.maySendStateEvent(ne.a.SpaceChild,le.a.get().getUserId());return a.a.createElement(T.c,{first:!0},a.a.createElement(T.b,{label:Object(c.a)("Create new room"),iconClassName:"mx_RoomList_iconPlus",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),Object(ke.d)(le.a.get(),Ce.f.instance.activeSpace)},disabled:!t,tooltip:t?void 0:Object(c.a)("You do not have permissions to create new rooms in this space")}),a.a.createElement(T.b,{label:Object(c.a)("Add existing room"),iconClassName:"mx_RoomList_iconHash",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),Object(ke.c)(le.a.get(),Ce.f.instance.activeSpace)},disabled:!t,tooltip:t?void 0:Object(c.a)("You do not have permissions to add rooms to this space")}),a.a.createElement(T.b,{label:Object(c.a)("Explore rooms"),iconClassName:"mx_RoomList_iconBrowse",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),u.a.fire(h.a.ViewRoomDirectory)}}))}return a.a.createElement(T.c,{first:!0},a.a.createElement(T.b,{label:Object(c.a)("Create new room"),iconClassName:"mx_RoomList_iconPlus",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),u.a.dispatch({action:"view_create_room"})}}),a.a.createElement(T.b,{label:we.a.instance.getSelectedCommunityId()?Object(c.a)("Explore community rooms"):Object(c.a)("Explore public rooms"),iconClassName:"mx_RoomList_iconExplore",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),u.a.fire(h.a.ViewRoomDirectory)}}))}},[re.a.LowPriority]:{sectionLabel:Object(c.b)("Low priority"),isInvite:!1,defaultHidden:!1},[re.a.ServerNotice]:{sectionLabel:Object(c.b)("System Alerts"),isInvite:!1,defaultHidden:!1},[re.a.Archived]:{sectionLabel:Object(c.b)("Historical"),isInvite:!1,defaultHidden:!0},[re.a.Suggested]:{sectionLabel:Object(c.b)("Suggested Rooms"),isInvite:!1,defaultHidden:!1}};let Ne=Object(P.a)("views.rooms.RoomList")(be=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"dispatcherRef",void 0),x()(this,"customTagStoreRef",void 0),x()(this,"roomStoreToken",void 0),x()(this,"unifiedRoomListWatcherRef",void 0),x()(this,"onUnifiedRoomListChange",()=>{this.setState({unifiedRoomList:V.b.getValue("unifiedRoomList")})}),x()(this,"onRoomViewStoreUpdate",()=>{this.setState({currentRoomId:ae.a.getRoomId()})}),x()(this,"onAction",e=>{if(e.action===h.a.ViewRoomDelta){const t=e,s=ae.a.getRoomId(),n=this.getRoomDelta(s,t.delta,t.unread);n&&u.a.dispatch({action:"view_room",room_id:n.roomId,show_room_tile:!0})}else e.action===h.a.PstnSupportUpdated&&this.updateLists()}),x()(this,"getRoomDelta",(e,t,s=!1)=>{const n=oe.b.instance.orderedLists,i=[];Re.forEach(t=>{let o=n[t];s&&(o=o.filter(t=>{const s=_e.a.instance.getRoomState(t);return s.room.roomId===e||s.isUnread})),i.push(...o)});const o=i.findIndex(t=>t.roomId===e),[a]=i.slice((o+t)%i.length);return a}),x()(this,"updateSuggestedRooms",e=>{this.setState({suggestedRooms:e})}),x()(this,"updateLists",()=>{const e=oe.b.instance.orderedLists;V.b.getValue("advancedRoomListLogging")&&console.log("new lists",e);const t=Object.keys(this.state.sublists),s=Object.keys(e).filter(e=>!Object(re.d)(e)||Y.a.getTags()[e]),n=!!oe.b.instance.getFirstNameFilterCondition();let i=this.state.isNameFiltering!==n||Object(Ee.d)(t,s);if(!i)for(const t of s){const s=this.state.sublists[t],n=e[t];if(s.length!==n.length){i=!0;break}}if(i){const t=Object(Se.g)(e,s),i=Object(Se.f)(t,(e,t)=>Object(Ee.b)(t));this.setState({sublists:i,isNameFiltering:n},()=>{this.props.onResize()})}}),x()(this,"onStartChat",()=>{var e;const t=null===(e=oe.b.instance.getFirstNameFilterCondition())||void 0===e?void 0:e.search;u.a.dispatch({action:"view_create_chat",initialText:t})}),x()(this,"onExplore",()=>{var e;const t=null===(e=oe.b.instance.getFirstNameFilterCondition())||void 0===e?void 0:e.search;u.a.dispatch({action:h.a.ViewRoomDirectory,initialText:t})}),x()(this,"onSpaceInviteClick",()=>{var e;const t=null===(e=oe.b.instance.getFirstNameFilterCondition())||void 0===e?void 0:e.search;Object(ke.e)(this.props.activeSpace,t)}),this.state={sublists:{},isNameFiltering:!!oe.b.instance.getFirstNameFilterCondition(),suggestedRooms:Ce.f.instance.suggestedRooms,unifiedRoomList:V.b.getValue("unifiedRoomList")},this.unifiedRoomListWatcherRef=V.b.watchSetting("unifiedRoomList",null,this.onUnifiedRoomListChange)}componentDidMount(){this.dispatcherRef=u.a.register(this.onAction),this.roomStoreToken=ae.a.addListener(this.onRoomViewStoreUpdate),Ce.f.instance.on(Ce.b,this.updateSuggestedRooms),oe.b.instance.on(oe.a,this.updateLists),this.customTagStoreRef=Y.a.addListener(this.updateLists),this.updateLists()}componentWillUnmount(){Ce.f.instance.off(Ce.b,this.updateSuggestedRooms),oe.b.instance.off(oe.a,this.updateLists),u.a.unregister(this.dispatcherRef),this.customTagStoreRef&&this.customTagStoreRef.remove(),this.roomStoreToken&&this.roomStoreToken.remove(),V.b.unwatchSetting(this.unifiedRoomListWatcherRef)}renderSuggestedRooms(){return this.state.suggestedRooms.map(e=>{var t;const s=e.name||e.canonical_alias||(null===(t=e.aliases)||void 0===t?void 0:t[0])||Object(c.a)("Empty room"),n=a.a.createElement(Oe.a,{oobData:{name:s,avatarUrl:e.avatar_url},width:32,height:32,resizeMethod:"crop"});return a.a.createElement(fe,{isMinimized:this.props.isMinimized,isSelected:this.state.currentRoomId===e.room_id,displayName:s,avatar:n,onClick:()=>{var t;u.a.dispatch({action:"view_room",room_alias:e.canonical_alias||(null===(t=e.aliases)||void 0===t?void 0:t[0]),room_id:e.room_id,via_servers:e.viaServers,oobData:{avatarUrl:e.avatar_url,name:s}})},key:"suggestedRoomTile_"+e.room_id})})}renderCommunityInvites(){return V.b.getValue("feature_spaces")?[]:le.a.get().getGroups().filter(e=>"invite"===e.myMembership).map(e=>{const t=a.a.createElement(ge,{groupId:e.groupId,groupName:e.name,groupAvatarUrl:e.avatarUrl,width:32,height:32,resizeMethod:"crop"});return a.a.createElement(fe,{isMinimized:this.props.isMinimized,isSelected:!1,displayName:e.name,avatar:t,notificationState:ye.a.RED_EXCLAMATION,onClick:()=>{u.a.dispatch({action:"view_group",group_id:e.groupId})},key:"temporaryGroupTile_"+e.groupId})})}renderSublists(){const e=!this.state.isNameFiltering&&Object.values(oe.b.instance.unfilteredLists).every(e=>!(null!=e&&e.length));return Re.reduce((e,t)=>{if(t===Ie){const t=Object.keys(this.state.sublists).filter(e=>Object(re.d)(e));e.push(...t)}return e.push(t),e},[]).map(t=>{let s=null;t===re.a.Invite?s=this.renderCommunityInvites():t===re.a.Suggested&&(s=this.renderSuggestedRooms());const n=Object(re.d)(t)?((i=t).startsWith("u.")&&(i=i.substring(2)),{sectionLabel:Object(c.b)("Custom Tag"),sectionLabelRaw:i,isInvite:!1,defaultHidden:!1}):je[t];var i;if(!n)throw new Error(`Tag ${t} does not have aesthetics`);return a.a.createElement(ce.b,{key:"sublist-"+t,tagId:t,forRooms:!0,startAsHidden:n.defaultHidden,label:n.sectionLabelRaw?n.sectionLabelRaw:Object(c.a)(n.sectionLabel),onAddRoom:n.onAddRoom,onAddGroupRoom:n.onAddGroupRoom,onAddDirectRoom:n.onAddDirectRoom,addRoomLabel:n.addRoomLabel?Object(c.a)(n.addRoomLabel):n.addRoomLabel,addGroupRoomLabel:n.addGroupRoomLabel?Object(c.a)(n.addGroupRoomLabel):n.addGroupRoomLabel,addDirectRoomLabel:n.addDirectRoomLabel?Object(c.a)(n.addDirectRoomLabel):n.addDirectRoomLabel,addRoomContextMenu:n.addRoomContextMenu,isMinimized:this.props.isMinimized,showSkeleton:e,extraTiles:s,resizeNotifier:this.props.resizeNotifier,alwaysVisible:(this.state.unifiedRoomList?Te:xe).includes(t),onListCollapse:this.props.onListCollapse})})}render(){const e=le.a.get().getUserId();let t;var s,n;if(!this.props.isMinimized)if(this.state.isNameFiltering)t=a.a.createElement("div",{className:"mx_RoomList_explorePrompt"},a.a.createElement("div",null,Object(c.a)("Can't see what you’re looking for?")),a.a.createElement(g.a,{className:"mx_RoomList_explorePrompt_startChat",kind:"link",onClick:this.onStartChat},Object(c.a)("Start a new chat")),a.a.createElement(g.a,{className:"mx_RoomList_explorePrompt_explore",kind:"link",onClick:this.onExplore},this.props.activeSpace?Object(c.a)("Explore rooms"):Object(c.a)("Explore all public rooms")));else if(null!==(s=this.props.activeSpace)&&void 0!==s&&s.canInvite(e)||"join"===(null===(n=this.props.activeSpace)||void 0===n?void 0:n.getMyMembership()))t=a.a.createElement("div",{className:"mx_RoomList_explorePrompt"},a.a.createElement("div",null,Object(c.a)("Quick actions")),this.props.activeSpace.canInvite(e)&&a.a.createElement(g.a,{className:"mx_RoomList_explorePrompt_spaceInvite",onClick:this.onSpaceInviteClick},Object(c.a)("Invite people")),"join"===this.props.activeSpace.getMyMembership()&&a.a.createElement(g.a,{className:"mx_RoomList_explorePrompt_spaceExplore",onClick:this.onExplore},Object(c.a)("Explore rooms")));else if(Object.values(this.state.sublists).some(e=>e.length>0)){const e=oe.b.instance.unfilteredLists,s=e[re.a.Untagged]||[],n=e[re.a.Archived]||[],i=e[re.a.Favourite]||[];s.length<1&&n<1&&i<1&&(t=a.a.createElement("div",{className:"mx_RoomList_explorePrompt"},a.a.createElement("div",null,Object(c.a)("Use the + to make a new room or explore existing ones below")),a.a.createElement(g.a,{className:"mx_RoomList_explorePrompt_startChat",kind:"link",onClick:this.onStartChat},Object(c.a)("Start a new chat")),a.a.createElement(g.a,{className:"mx_RoomList_explorePrompt_explore",kind:"link",onClick:this.onExplore},Object(c.a)("Explore all public rooms"))))}const i=this.renderSublists();return a.a.createElement(ie.c,{handleHomeEnd:!0,onKeyDown:this.props.onKeyDown},({onKeyDownHandler:e})=>a.a.createElement("div",{onFocus:this.props.onFocus,onBlur:this.props.onBlur,onKeyDown:e,className:"mx_RoomList",role:"tree","aria-label":Object(c.a)("Rooms")},i,t))}})||be;var Pe,De=s(153),Ae=s(208),Me=s(143),Ue=s(112),Le=s(99),Fe=s(438);let Be=Object(P.a)("views.dialogs.BugReportDialog")(Pe=class extends a.a.Component{constructor(e){super(e),x()(this,"unmounted",void 0),x()(this,"onCancel",()=>{this.props.onFinished(!1)}),x()(this,"onSubmit",()=>{if(!(this.state.text&&this.state.text.trim()||this.state.issueUrl&&this.state.issueUrl.trim()))return void this.setState({err:Object(c.a)("Please tell us what went wrong or, better, create a GitHub issue that describes the problem.")});const e=(this.state.text.length>0?this.state.text+"\n\n":"")+"Issue: "+(this.state.issueUrl.length>0?this.state.issueUrl:"No issue link given");this.setState({busy:!0,progress:null,err:null}),this.sendProgressCallback(Object(c.a)("Preparing to send logs")),Object(Fe.a)(l.a.get().bug_report_endpoint_url,{userText:e,sendLogs:!0,progressCallback:this.sendProgressCallback,label:this.props.label}).then(()=>{if(!this.unmounted){this.props.onFinished(!1);const e=d.getComponent("dialogs.QuestionDialog");Le.a.createTrackedDialog("Bug report sent","",e,{title:Object(c.a)("Logs sent"),description:Object(c.a)("Thank you!"),hasCancelButton:!1})}},e=>{this.unmounted||this.setState({busy:!1,progress:null,err:Object(c.a)("Failed to send logs: ")+""+e.message})})}),x()(this,"onDownload",async()=>{this.setState({downloadBusy:!0}),this.downloadProgressCallback(Object(c.a)("Preparing to download logs"));try{await Object(Fe.b)({sendLogs:!0,progressCallback:this.downloadProgressCallback,label:this.props.label}),this.setState({downloadBusy:!1,downloadProgress:null})}catch(e){this.unmounted||this.setState({downloadBusy:!1,downloadProgress:Object(c.a)("Failed to send logs: ")+""+e.message})}}),x()(this,"onTextChange",e=>{this.setState({text:e.currentTarget.value})}),x()(this,"onIssueUrlChange",e=>{this.setState({issueUrl:e.currentTarget.value})}),x()(this,"sendProgressCallback",e=>{this.unmounted||this.setState({progress:e})}),x()(this,"downloadProgressCallback",e=>{this.unmounted||this.setState({downloadProgress:e})}),this.state={sendLogs:!0,busy:!1,err:null,issueUrl:"",text:e.initialText||"",progress:null,downloadBusy:!1,downloadProgress:null},this.unmounted=!1}componentWillUnmount(){this.unmounted=!0}render(){const e=d.getComponent("elements.Spinner"),t=d.getComponent("views.dialogs.BaseDialog"),s=d.getComponent("views.elements.DialogButtons"),n=d.getComponent("elements.Field");let i=null;this.state.err&&(i=a.a.createElement("div",{className:"error"},this.state.err));let o,r=null;return this.state.busy&&(r=a.a.createElement("div",{className:"progress"},a.a.createElement(e,null),this.state.progress," ...")),window.Modernizr&&Object.values(window.Modernizr).some(e=>!1===e)&&(o=a.a.createElement("p",null,a.a.createElement("b",null,Object(c.a)("Reminder: Your browser is unsupported, so your experience may be unpredictable.")))),a.a.createElement(t,{className:"mx_BugReportDialog",onFinished:this.onCancel,title:Object(c.a)("Submit debug logs"),contentId:"mx_Dialog_content"},a.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},o,a.a.createElement("p",null,Object(c.a)("Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited and the usernames of other users. They do not contain messages.")),a.a.createElement("p",null,a.a.createElement("b",null,Object(c.a)("Before submitting logs, you must <a>create a GitHub issue</a> to describe your problem.",{},{a:e=>a.a.createElement("a",{target:"_blank",href:"https://github.com/SchildiChat/schildichat-desktop/issues/new"},e)}))),a.a.createElement("div",{className:"mx_BugReportDialog_download"},a.a.createElement(g.a,{onClick:this.onDownload,kind:"link",disabled:this.state.downloadBusy},Object(c.a)("Download logs")),this.state.downloadProgress&&a.a.createElement("span",null,this.state.downloadProgress," ...")),a.a.createElement(n,{type:"text",className:"mx_BugReportDialog_field_input",label:Object(c.a)("GitHub issue"),onChange:this.onIssueUrlChange,value:this.state.issueUrl,placeholder:"https://github.com/vector-im/element-web/issues/..."}),a.a.createElement(n,{className:"mx_BugReportDialog_field_input",element:"textarea",label:Object(c.a)("Notes"),rows:5,onChange:this.onTextChange,value:this.state.text,placeholder:Object(c.a)("If there is additional context that would help in analysing the issue, such as what you were doing at the time, room IDs, user IDs, etc., please include those things here.")}),r,i),a.a.createElement(s,{primaryButton:Object(c.a)("Send logs"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}})||Pe;var Ve=s(226),Ke=s(291);var We,Ge=e=>{const[t,s]=Object(o.useState)(""),[n,i]=Object(o.useState)(""),r=()=>{e.onFinished(),Le.a.createTrackedDialog("Bug Report Dialog","",Be,{})},d=E.a.instance.canEnable(),u=l.a.get().brand;let h,m;d&&(h=a.a.createElement(a.a.Fragment,null,a.a.createElement("hr",null),a.a.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_rateApp"},a.a.createElement("h3",null,Object(c.a)("Rate %(brand)s",{brand:u})),a.a.createElement("p",null,Object(c.a)("Tell us below how you feel about %(brand)s so far.",{brand:u})),a.a.createElement("p",null,Object(c.a)("Please go into as much detail as you like, so we can track down the problem.")),a.a.createElement(Ke.a,{name:"feedbackRating",value:t,onChange:s,definitions:[{value:"1",label:"😠"},{value:"2",label:"😞"},{value:"3",label:"😑"},{value:"4",label:"😄"},{value:"5",label:"😍"}]}),a.a.createElement(Ue.a,{id:"feedbackComment",label:Object(c.a)("Add comment"),placeholder:Object(c.a)("Comment"),type:"text",autoComplete:"off",value:n,element:"textarea",onChange:e=>{i(e.target.value)}})))),d&&(m=a.a.createElement("h2",null,Object(c.a)("There are two ways you can provide feedback and help us improve %(brand)s.",{brand:u})));let p=null;return l.a.get().bug_report_endpoint_url&&(p=a.a.createElement("p",null,Object(c.a)("PRO TIP: If you start a bug, please submit <debugLogsLink>debug logs</debugLogsLink> to help us track down the problem.",{},{debugLogsLink:e=>a.a.createElement(g.a,{kind:"link",onClick:r},e)}))),a.a.createElement(Me.a,{className:"mx_FeedbackDialog",hasCancelButton:!!d,title:Object(c.a)("Feedback"),description:a.a.createElement(a.a.Fragment,null,m,a.a.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_reportBug"},a.a.createElement("h3",null,Object(c.a)("Report a bug")),a.a.createElement("p",null,Object(c.a)("Please view <existingIssuesLink>existing bugs on Github</existingIssuesLink> first. No match? <newIssueLink>Start a new one</newIssueLink>.",{},{existingIssuesLink:e=>a.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://github.com/SchildiChat/schildichat-desktop/issues?q=is%3Aopen+is%3Aissue+sort%3Areactions-%2B1-desc"},e),newIssueLink:e=>a.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://github.com/SchildiChat/schildichat-desktop/issues/new"},e)})),p),h),button:d?Object(c.a)("Send feedback"):Object(c.a)("Go back"),buttonDisabled:d&&""===t,onFinished:s=>{d&&s&&(E.a.instance.reportFeedback(parseInt(t,10),n),Le.a.createTrackedDialog("Feedback sent","",Ve.a,{title:Object(c.a)("Feedback sent"),description:Object(c.a)("Thank you!")})),e.onFinished()}})},qe=s(250);let He=Object(P.a)("views.dialogs.LogoutDialog")(We=class extends a.a.Component{constructor(){super(),x()(this,"defaultProps",{onFinished:function(){}}),this._onSettingsLinkClick=this._onSettingsLinkClick.bind(this),this._onExportE2eKeysClicked=this._onExportE2eKeysClicked.bind(this),this._onFinished=this._onFinished.bind(this),this._onSetRecoveryMethodClick=this._onSetRecoveryMethodClick.bind(this),this._onLogoutConfirm=this._onLogoutConfirm.bind(this);const e=le.a.get(),t=e.isCryptoEnabled()&&!e.getKeyBackupEnabled();this.state={shouldLoadBackupStatus:t,loading:t,backupInfo:null,error:null},t&&this._loadBackupStatus()}async _loadBackupStatus(){try{const e=await le.a.get().getKeyBackupVersion();this.setState({loading:!1,backupInfo:e})}catch(e){console.log("Unable to fetch key backup status",e),this.setState({loading:!1,error:e})}}_onSettingsLinkClick(){this.props.onFinished()}_onExportE2eKeysClicked(){Le.a.createTrackedDialogAsync("Export E2E Keys","",s.e(4).then(s.bind(null,1306)),{matrixClient:le.a.get()})}_onFinished(e){e&&u.a.dispatch({action:"logout"}),this.props.onFinished()}_onSetRecoveryMethodClick(){this.state.backupInfo?Le.a.createTrackedDialog("Restore Backup","",qe.a,null,null,!1,!0):Le.a.createTrackedDialogAsync("Key Backup","Key Backup",s.e(5).then(s.bind(null,737)),null,null,!1,!0),this.props.onFinished()}_onLogoutConfirm(){u.a.dispatch({action:"logout"}),this.props.onFinished()}render(){if(this.state.shouldLoadBackupStatus){const e=d.getComponent("views.dialogs.BaseDialog"),t=a.a.createElement("div",null,a.a.createElement("p",null,Object(c.a)("Encrypted messages are secured with end-to-end encryption. Only you and the recipient(s) have the keys to read these messages.")),a.a.createElement("p",null,Object(c.a)("Back up your keys before signing out to avoid losing them.")));let s;if(this.state.loading){const e=d.getComponent("views.elements.Spinner");s=a.a.createElement(e,null)}else{const e=d.getComponent("views.elements.DialogButtons");let n;n=this.state.backupInfo?Object(c.a)("Connect this session to Key Backup"):Object(c.a)("Start using Key Backup"),s=a.a.createElement("div",null,a.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},t),a.a.createElement(e,{primaryButton:n,hasCancel:!1,onPrimaryButtonClick:this._onSetRecoveryMethodClick,focus:!0},a.a.createElement("button",{onClick:this._onLogoutConfirm},Object(c.a)("I don't want my encrypted messages"))),a.a.createElement("details",null,a.a.createElement("summary",null,Object(c.a)("Advanced")),a.a.createElement("p",null,a.a.createElement("button",{onClick:this._onExportE2eKeysClicked},Object(c.a)("Manually export keys")))))}return a.a.createElement(e,{title:Object(c.a)("You'll lose access to your encrypted messages"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this._onFinished},s)}{const e=d.getComponent("views.dialogs.QuestionDialog");return a.a.createElement(e,{hasCancelButton:!0,title:Object(c.a)("Sign out"),description:Object(c.a)("Are you sure you want to sign out?"),button:Object(c.a)("Sign out"),onFinished:this._onFinished})}}})||We;var $e,ze=s(252),Ye=s(106),Je=s(157),Qe=s(126),Xe=s(135),Ze=s(124),et=s(170);let tt=Object(P.a)("views.dialogs.EditCommunityPrototypeDialog")($e=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"avatarUploadRef",a.a.createRef()),x()(this,"onNameChange",e=>{this.setState({name:e.target.value})}),x()(this,"onSubmit",async e=>{if(e.preventDefault(),e.stopPropagation(),!this.state.busy){this.setState({busy:!0});try{let e=this.state.currentAvatarUrl||"";this.state.avatarFile&&(e=await le.a.get().uploadContent(this.state.avatarFile)),await le.a.get().setGroupProfile(this.props.communityId,{name:this.state.name,avatar_url:e}),await et.a.refreshGroupProfile(le.a.get(),this.props.communityId),this.props.onFinished(!0)}catch(e){console.error(e),this.setState({busy:!1,error:Object(c.a)("There was an error updating your community. The server is unable to process your request.")})}}}),x()(this,"onAvatarChanged",e=>{if(e.target.files&&e.target.files.length){this.setState({busy:!0});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarFile:t,busy:!1,avatarPreview:e.target.result})},s.readAsDataURL(t)}else this.setState({avatarFile:null})}),x()(this,"onChangeAvatar",()=>{this.avatarUploadRef.current&&this.avatarUploadRef.current.click()});const t=we.a.instance.getCommunityProfile(e.communityId);this.state={name:(null==t?void 0:t.name)||"",error:null,busy:!1,avatarFile:null,avatarPreview:null,currentAvatarUrl:null==t?void 0:t.avatarUrl}}render(){let e=a.a.createElement("img",{src:this.state.avatarPreview,className:"mx_EditCommunityPrototypeDialog_avatar"});if(!this.state.avatarPreview)if(this.state.currentAvatarUrl){const t=Object(pe.b)(this.state.currentAvatarUrl).srcHttp;e=a.a.createElement("img",{src:t,className:"mx_EditCommunityPrototypeDialog_avatar"})}else e=a.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_placeholderAvatar"});return a.a.createElement(Ze.a,{className:"mx_EditCommunityPrototypeDialog",onFinished:this.props.onFinished,title:Object(c.a)("Update community")},a.a.createElement("form",{onSubmit:this.onSubmit},a.a.createElement("div",{className:"mx_Dialog_content"},a.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_rowName"},a.a.createElement(Ue.a,{value:this.state.name,onChange:this.onNameChange,placeholder:Object(c.a)("Enter name"),label:Object(c.a)("Enter name")})),a.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_rowAvatar"},a.a.createElement("input",{type:"file",style:{display:"none"},ref:this.avatarUploadRef,accept:"image/*",onChange:this.onAvatarChanged}),a.a.createElement(g.a,{onClick:this.onChangeAvatar,className:"mx_EditCommunityPrototypeDialog_avatarContainer"},e),a.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_tip"},a.a.createElement("b",null,Object(c.a)("Add image (optional)")),a.a.createElement("span",null,Object(c.a)("An image will help people identify your community.")))),a.a.createElement(g.a,{kind:"primary",onClick:this.onSubmit,disabled:this.state.busy},Object(c.a)("Save")))))}})||$e;var st,nt=s(116),it=s(191),ot=s(172);let at=Object(P.a)("views.elements.TooltipButton")(st=class extends a.a.Component{constructor(e){super(e),x()(this,"onMouseOver",()=>{this.setState({hover:!0})}),x()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const e=d.getComponent("elements.Tooltip"),t=this.state.hover?a.a.createElement(e,{className:"mx_TooltipButton_container",tooltipClassName:"mx_TooltipButton_helpText",label:this.props.helpText}):a.a.createElement("div",null);return a.a.createElement("div",{className:"mx_TooltipButton",onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},"?",t)}})||st;var rt;let ct=Object(P.a)("structures.UserMenu")(rt=class extends a.a.Component{constructor(e){super(e),x()(this,"dispatcherRef",void 0),x()(this,"themeWatcherRef",void 0),x()(this,"dndWatcherRef",void 0),x()(this,"buttonRef",Object(o.createRef)()),x()(this,"tagStoreRef",void 0),x()(this,"onRoom",e=>{this.removePendingJoinRoom(e.roomId)}),x()(this,"onTagStoreUpdate",()=>{this.forceUpdate()}),x()(this,"onProfileUpdate",async()=>{this.forceUpdate()}),x()(this,"onSelectedSpaceUpdate",async e=>{this.setState({selectedSpace:e})}),x()(this,"onThemeChanged",()=>{this.setState({isDarkTheme:this.isUserOnDarkTheme()})}),x()(this,"onAction",e=>{switch(e.action){case h.a.ToggleUserMenu:this.state.contextMenuPosition?this.setState({contextMenuPosition:null}):this.buttonRef.current&&this.buttonRef.current.click();break;case h.a.JoinRoom:this.addPendingJoinRoom(e.roomId);break;case h.a.JoinRoomReady:case h.a.JoinRoomError:this.removePendingJoinRoom(e.roomId)}}),x()(this,"onOpenMenuClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})}),x()(this,"onContextMenu",e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,width:20,height:0}})}),x()(this,"onCloseMenu",()=>{this.setState({contextMenuPosition:null})}),x()(this,"onSwitchThemeClick",e=>{e.preventDefault(),e.stopPropagation(),V.b.setValue("use_system_theme",null,Ye.a.DEVICE,!1);const t=this.state.isDarkTheme?"light":"dark";V.b.setValue("theme",null,Ye.a.DEVICE,t)}),x()(this,"onSettingsOpen",(e,t)=>{e.preventDefault(),e.stopPropagation();const s={action:h.a.ViewUserSettings,initialTabId:t};u.a.dispatch(s),this.setState({contextMenuPosition:null})}),x()(this,"onShowArchived",e=>{e.preventDefault(),e.stopPropagation(),console.log("TODO: Show archived rooms")}),x()(this,"onProvideFeedback",e=>{e.preventDefault(),e.stopPropagation(),Le.a.createTrackedDialog("Feedback Dialog","",Ge),this.setState({contextMenuPosition:null})}),x()(this,"onSignOutClick",async e=>{var t;e.preventDefault(),e.stopPropagation();const s=le.a.get();s&&s.isCryptoEnabled()&&null!==(t=await s.exportRoomKeys())&&void 0!==t&&t.length?Le.a.createTrackedDialog("Logout from LeftPanel","",He):u.a.dispatch({action:"logout"}),this.setState({contextMenuPosition:null})}),x()(this,"onSignInClick",()=>{u.a.dispatch({action:"start_login"}),this.setState({contextMenuPosition:null})}),x()(this,"onRegisterClick",()=>{u.a.dispatch({action:"start_registration"}),this.setState({contextMenuPosition:null})}),x()(this,"onHomeClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"view_home_page"}),this.setState({contextMenuPosition:null})}),x()(this,"onCommunitySettingsClick",e=>{e.preventDefault(),e.stopPropagation(),Le.a.createTrackedDialog("Edit Community","",tt,{communityId:we.a.instance.getSelectedCommunityId()}),this.setState({contextMenuPosition:null})}),x()(this,"onCommunityMembersClick",e=>{e.preventDefault(),e.stopPropagation();const t=we.a.instance.getSelectedCommunityGeneralChat();t?(u.a.dispatch({action:"view_room",room_id:t.roomId},!0),u.a.dispatch({action:h.a.SetRightPanelPhase,phase:Qe.c.RoomMemberList})):Le.a.createTrackedDialog("Failed to find general chat","",Xe.a,{title:Object(c.a)("Failed to find the general chat for this community"),description:Object(c.a)("Failed to find the general chat for this community")}),this.setState({contextMenuPosition:null})}),x()(this,"onCommunityInviteClick",e=>{e.preventDefault(),e.stopPropagation(),Object(Je.e)(we.a.instance.getSelectedCommunityId()),this.setState({contextMenuPosition:null})}),x()(this,"onDndToggle",e=>{e.stopPropagation();const t=V.b.getValue("doNotDisturb");V.b.setValue("doNotDisturb",null,Ye.a.DEVICE,!t)}),x()(this,"renderContextMenu",()=>{if(!this.state.contextMenuPosition)return null;const e=we.a.instance.getSelectedCommunityName();let t;const n=l.a.get().hostSignup;if(le.a.get().isGuest())t=a.a.createElement("div",{className:"mx_UserMenu_contextMenu_header mx_UserMenu_contextMenu_guestPrompts"},Object(c.a)("Got an account? <a>Sign in</a>",{},{a:e=>a.a.createElement(g.a,{kind:"link",onClick:this.onSignInClick},e)}),Object(c.a)("New here? <a>Create an account</a>",{},{a:e=>a.a.createElement(g.a,{kind:"link",onClick:this.onRegisterClick},e)}));else if(n&&n&&n.url){const e=n.domains||[],s=le.a.get().getDomain(),i=e.filter(e=>e===s||s.endsWith("."+e));(!n.domains||i.length>0)&&(t=a.a.createElement(D,{onClick:this.onCloseMenu}))}let i,o=null;this.hasHomePage&&(o=a.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconHome",label:Object(c.a)("Home"),onClick:this.onHomeClick})),V.b.getValue(nt.a.Feedback)&&(i=a.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconMessage",label:Object(c.a)("Feedback"),onClick:this.onProvideFeedback}));let r=a.a.createElement("div",{className:"mx_UserMenu_contextMenu_name"},a.a.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},p.a.instance.displayName),a.a.createElement("span",{className:"mx_UserMenu_contextMenu_userId"},le.a.get().getUserId())),d=a.a.createElement(a.a.Fragment,null,a.a.createElement(T.c,null,o,a.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconBell",label:Object(c.a)("Notification settings"),onClick:e=>this.onSettingsOpen(e,Ae.a.Notifications)}),a.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconLock",label:Object(c.a)("Security & privacy"),onClick:e=>this.onSettingsOpen(e,Ae.a.Security)}),a.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(c.a)("All settings"),onClick:e=>this.onSettingsOpen(e,null)}),i),a.a.createElement(T.c,{red:!0},a.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconSignOut",label:Object(c.a)("Sign out"),onClick:this.onSignOutClick}))),u=null;if(e){const t=we.a.instance.getSelectedCommunityId();let s,n;r=a.a.createElement("div",{className:"mx_UserMenu_contextMenu_name"},a.a.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},e)),we.a.instance.canInviteTo(t)&&(n=a.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconInvite",label:Object(c.a)("Invite"),onClick:this.onCommunityInviteClick})),we.a.instance.isAdminOf(t)&&(s=a.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(c.a)("Settings"),"aria-label":Object(c.a)("Community settings"),onClick:this.onCommunitySettingsClick})),d=a.a.createElement(T.c,null,s,a.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconMembers",label:Object(c.a)("Members"),onClick:this.onCommunityMembersClick}),n),u=a.a.createElement(a.a.Fragment,null,a.a.createElement("hr",null),a.a.createElement("div",{className:"mx_UserMenu_contextMenu_header"},a.a.createElement("div",{className:"mx_UserMenu_contextMenu_name"},a.a.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},p.a.instance.displayName),a.a.createElement("span",{className:"mx_UserMenu_contextMenu_userId"},le.a.get().getUserId()))),a.a.createElement(T.c,null,a.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(c.a)("Settings"),"aria-label":Object(c.a)("User settings"),onClick:e=>this.onSettingsOpen(e,null)}),i),a.a.createElement(T.c,{red:!0},a.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconSignOut",label:Object(c.a)("Sign out"),onClick:this.onSignOutClick})))}else le.a.get().isGuest()&&(d=a.a.createElement(a.a.Fragment,null,a.a.createElement(T.c,null,o,a.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(c.a)("Settings"),onClick:e=>this.onSettingsOpen(e,null)}),i)));const h=M()({mx_UserMenu_contextMenu:!0,mx_UserMenu_contextMenu_prototype:!!e});return a.a.createElement(T.e,{left:this.state.contextMenuPosition.width+this.state.contextMenuPosition.left-10,top:this.state.contextMenuPosition.top+this.state.contextMenuPosition.height+8,onFinished:this.onCloseMenu,className:h},a.a.createElement("div",{className:"mx_UserMenu_contextMenu_header"},r,a.a.createElement(K.a,{className:"mx_UserMenu_contextMenu_themeButton",onClick:this.onSwitchThemeClick,title:this.state.isDarkTheme?Object(c.a)("Switch to light mode"):Object(c.a)("Switch to dark mode")},a.a.createElement("img",{src:s(1223),alt:Object(c.a)("Switch theme"),width:16}))),t,d,u)}),this.state={contextMenuPosition:null,isDarkTheme:this.isUserOnDarkTheme(),pendingRoomJoin:new Set},p.a.instance.on(v.b,this.onProfileUpdate),V.b.getValue("feature_spaces")&&Ce.f.instance.on(Ce.d,this.onSelectedSpaceUpdate),this.dndWatcherRef=V.b.watchSetting("doNotDisturb",null,()=>this.forceUpdate())}get hasHomePage(){return!!Object(r.a)(l.a.get())}componentDidMount(){this.dispatcherRef=u.a.register(this.onAction),this.themeWatcherRef=V.b.watchSetting("theme",null,this.onThemeChanged),this.tagStoreRef=U.a.addListener(this.onTagStoreUpdate),le.a.get().on("Room",this.onRoom)}componentWillUnmount(){this.themeWatcherRef&&V.b.unwatchSetting(this.themeWatcherRef),this.dndWatcherRef&&V.b.unwatchSetting(this.dndWatcherRef),this.dispatcherRef&&u.a.unregister(this.dispatcherRef),p.a.instance.off(v.b,this.onProfileUpdate),this.tagStoreRef.remove(),V.b.getValue("feature_spaces")&&Ce.f.instance.off(Ce.d,this.onSelectedSpaceUpdate),le.a.get().removeListener("Room",this.onRoom)}isUserOnDarkTheme(){if(V.b.getValue("use_system_theme"))return window.matchMedia("(prefers-color-scheme: dark)").matches;{const e=V.b.getValue("theme");return e.startsWith("custom-")?Object(ze.c)(e.substring("custom-".length)).is_dark:"dark"===e}}addPendingJoinRoom(e){this.setState({pendingRoomJoin:new Set(this.state.pendingRoomJoin).add(e)})}removePendingJoinRoom(e){this.state.pendingRoomJoin.delete(e)&&this.setState({pendingRoomJoin:new Set(this.state.pendingRoomJoin)})}render(){const e=le.a.get().getUserId(),t=p.a.instance.displayName||e,s=p.a.instance.getHttpAvatarUrl(32),n=we.a.instance.getSelectedCommunityName();let o,r=!1,l=Object(c.a)("User menu"),d=a.a.createElement("span",{className:"mx_UserMenu_userName"},t),u=a.a.createElement("span",{className:"mx_UserMenu_headerButtons"});if(this.state.selectedSpace)d=a.a.createElement("div",{className:"mx_UserMenu_doubleName"},a.a.createElement("span",{className:"mx_UserMenu_userName"},t),a.a.createElement(it.a,{room:this.state.selectedSpace},e=>a.a.createElement("span",{className:"mx_UserMenu_subUserName"},e)));else if(n)d=a.a.createElement("div",{className:"mx_UserMenu_doubleName"},a.a.createElement("span",{className:"mx_UserMenu_userName"},n),a.a.createElement("span",{className:"mx_UserMenu_subUserName"},t)),l=Object(c.a)("Community and user menu"),r=!0;else if(V.b.getValue("feature_communities_v2_prototypes"))d=a.a.createElement("div",{className:"mx_UserMenu_doubleName"},a.a.createElement("span",{className:"mx_UserMenu_userName"},Object(c.a)("Home")),a.a.createElement("span",{className:"mx_UserMenu_subUserName"},t)),r=!0;else if(V.b.getValue("feature_dnd")){const e=V.b.getValue("doNotDisturb");o=a.a.createElement(g.a,{onClick:this.onDndToggle,className:M()({mx_UserMenu_dnd:!0,mx_UserMenu_dnd_noisy:!e,mx_UserMenu_dnd_muted:e})})}this.props.isMinimized&&(d=null,u=null);const h=M()({mx_UserMenu:!0,mx_UserMenu_minimized:this.props.isMinimized,mx_UserMenu_prototype:r});return a.a.createElement(a.a.Fragment,null,a.a.createElement(i.c,{className:h,onClick:this.onOpenMenuClick,inputRef:this.buttonRef,label:l,isExpanded:!!this.state.contextMenuPosition,onContextMenu:this.onContextMenu},a.a.createElement("div",{className:"mx_UserMenu_row"},a.a.createElement("span",{className:"mx_UserMenu_userAvatarContainer"},a.a.createElement(m.a,{idName:e,name:t,url:s,width:32,height:32,resizeMethod:"crop",className:"mx_UserMenu_userAvatar"})),d,this.state.pendingRoomJoin.size>0&&a.a.createElement(ot.a,null,a.a.createElement(at,{helpText:Object(c.a)("Currently joining %(count)s rooms",{count:this.state.pendingRoomJoin.size})})),o,u)),this.renderContextMenu())}})||rt;var lt=s(692),dt=s(156),ut=s(1);class ht extends dt.a{constructor(){super(u.a),x()(this,"waitingRooms",[]),x()(this,"onMyMembership",async e=>{const t=V.b.getValue("breadcrumbs",null,!0);this.meetsRoomRequirement&&Object(ut.t)(t)&&await V.b.setValue("breadcrumbs",null,Ye.a.ACCOUNT,!0)}),x()(this,"onRoom",async e=>{const t=this.waitingRooms.find(t=>t.roomId===e.roomId);t&&(this.waitingRooms.splice(this.waitingRooms.indexOf(t),1),Date.now()-t.addedTs>9e4||await this.appendRoom(e))}),V.b.monitorSetting("breadcrumb_rooms",null),V.b.monitorSetting("breadcrumbs",null)}static get instance(){return ht.internalInstance}get rooms(){return this.state.rooms||[]}get visible(){return this.state.enabled&&this.meetsRoomRequirement}get meetsRoomRequirement(){return this.matrixClient&&this.matrixClient.getVisibleRooms().length>=20}async onAction(e){if(this.matrixClient)if("setting_updated"===e.action)"breadcrumb_rooms"===e.settingName?await this.updateRooms():"breadcrumbs"===e.settingName&&await this.updateState({enabled:V.b.getValue("breadcrumbs",null)});else if("view_room"===e.action)if(e.auto_join&&!this.matrixClient.getRoom(e.room_id))this.waitingRooms.push({roomId:e.room_id,addedTs:Date.now()});else{const t=this.matrixClient.getRoom(e.room_id);t&&await this.appendRoom(t)}}async onReady(){await this.updateRooms(),await this.updateState({enabled:V.b.getValue("breadcrumbs",null)}),this.matrixClient.on("Room.myMembership",this.onMyMembership),this.matrixClient.on("Room",this.onRoom)}async onNotReady(){this.matrixClient.removeListener("Room.myMembership",this.onMyMembership),this.matrixClient.removeListener("Room",this.onRoom)}async updateRooms(){let e=V.b.getValue("breadcrumb_rooms");e&&0!==e.length||(e=[]);const t=e.map(e=>this.matrixClient.getRoom(e)).filter(e=>!!e),s=this.state.rooms||[];Object(Ee.d)(t,s)&&await this.updateState({rooms:t})}async appendRoom(e){if(V.b.getValue("feature_spaces")&&e.isSpaceRoom())return;let t=!1;const s=(this.state.rooms||[]).slice(),n=this.matrixClient.getRoomUpgradeHistory(e.roomId);if(n.length>1){e=n[n.length-1];for(let e=0;e<n.length-1;e++){const i=s.findIndex(t=>t.roomId===n[e].roomId);-1!==i&&(s.splice(i,1),t=!0)}}const i=s.findIndex(t=>t.roomId===e.roomId);if(0!==i&&(-1!==i&&s.splice(i,1),s.splice(0,0,e),t=!0),s.length>20&&(s.splice(20,s.length-20),t=!0),t){await this.updateState({rooms:s});const e=s.map(e=>e.roomId);e.length>0&&await V.b.setValue("breadcrumb_rooms",null,Ye.a.ACCOUNT,e)}}}x()(ht,"internalInstance",new ht);var mt=s(259),pt=s(1224),gt=s(111);var vt,ft=e=>{let{children:t}=e,s=me()(e,["children"]);return a.a.createElement(ie.c,{handleHomeEnd:!0,onKeyDown:(e,t)=>{const s=e.target;if("INPUT"===s.tagName)return;let n=!0;switch(e.key){case gt.a.ARROW_UP:case gt.a.ARROW_DOWN:s.hasAttribute("aria-haspopup")&&s.click();break;case gt.a.ARROW_LEFT:case gt.a.ARROW_RIGHT:if(t.refs.length>0){const s=t.refs.findIndex(e=>e===t.activeRef),n=e.key===gt.a.ARROW_RIGHT?1:-1;t.refs.slice((s+n)%t.refs.length)[0].current.focus()}break;default:n=!1}n&&(e.preventDefault(),e.stopPropagation())}},({onKeyDownHandler:e})=>a.a.createElement("div",ue()({},s,{onKeyDown:e,role:"toolbar"}),t))};let bt=Object(P.a)("views.rooms.RoomBreadcrumbs")(vt=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"isMounted",!0),x()(this,"onBreadcrumbsUpdate",()=>{this.isMounted&&(this.setState({doAnimation:!1,skipFirst:!0}),setTimeout(()=>this.setState({doAnimation:!0,skipFirst:!1}),0))}),x()(this,"viewRoom",(e,t)=>{_.a.trackEvent("Breadcrumbs","click_node",String(t)),u.a.dispatch({action:"view_room",room_id:e.roomId})}),this.state={doAnimation:!0,skipFirst:!1},ht.instance.on(v.b,this.onBreadcrumbsUpdate)}componentWillUnmount(){this.isMounted=!1,ht.instance.off(v.b,this.onBreadcrumbsUpdate)}render(){const e=ht.instance.rooms.map((e,t)=>a.a.createElement(ie.b,{className:"mx_RoomBreadcrumbs_crumb",key:e.roomId,onClick:()=>this.viewRoom(e,t),"aria-label":Object(c.a)("Room %(name)s",{name:e.name}),title:e.name,tooltipClassName:"mx_RoomBreadcrumbs_Tooltip"},a.a.createElement(mt.a,{room:e,avatarSize:32,displayBadge:!0,forceCount:!0})));return e.length>0?a.a.createElement(pt.CSSTransition,{appear:!0,in:this.state.doAnimation,timeout:640,classNames:"mx_RoomBreadcrumbs"},a.a.createElement(ft,{className:"mx_RoomBreadcrumbs","aria-label":Object(c.a)("Recently visited rooms")},e.slice(this.state.skipFirst?1:0))):a.a.createElement("div",{className:"mx_RoomBreadcrumbs"},a.a.createElement("div",{className:"mx_RoomBreadcrumbs_placeholder"},Object(c.a)("No recently visited rooms")))}})||vt;var yt,_t,Et,St=s(97),wt=s.n(St);let Ct=Object(P.a)("structures.IndicatorScrollbar")((Et=_t=class extends a.a.Component{constructor(e){super(e),x()(this,"onMouseWheel",e=>{if(this.props.verticalScrollsHorizontally&&this._scrollElement){const t=0,s=1,n=(new Date).getTime();if(Math.abs(e.deltaX)>0?(this._likelyTrackpadUser=!0,this._checkAgainForTrackpad=n+6e4):this._likelyTrackpadUser&&n>=this._checkAgainForTrackpad&&(this._likelyTrackpadUser=!1),this._likelyTrackpadUser)return;if(Math.abs(e.deltaX)<=t){const t=e.deltaY<0?-50:50,n=Math.abs(e.deltaY)<25?e.deltaY+t:e.deltaY;this._scrollElement.scrollLeft+=n*s}}}),this._collectScroller=this._collectScroller.bind(this),this._collectScrollerComponent=this._collectScrollerComponent.bind(this),this.checkOverflow=this.checkOverflow.bind(this),this._scrollElement=null,this._autoHideScrollbar=null,this._likelyTrackpadUser=null,this._checkAgainForTrackpad=0,this.state={leftIndicatorOffset:0,rightIndicatorOffset:0}}moveToOrigin(){this._scrollElement&&(this._scrollElement.scrollLeft=0,this._scrollElement.scrollTop=0)}_collectScroller(e){e&&!this._scrollElement&&(this._scrollElement=e,this._scrollElement.addEventListener("scroll",this.checkOverflow,{passive:!0}),this.checkOverflow())}_collectScrollerComponent(e){this._autoHideScrollbar=e}componentDidUpdate(e){(e&&e.children&&e.children.length||0)!==(this.props.children&&this.props.children.length||0)&&this.checkOverflow()}componentDidMount(){this.checkOverflow()}checkOverflow(){const e=this._scrollElement.scrollTop>0,t=this._scrollElement.scrollHeight>this._scrollElement.scrollTop+this._scrollElement.clientHeight,s=this._scrollElement.scrollLeft>0,n=this._scrollElement.scrollWidth>this._scrollElement.scrollLeft+this._scrollElement.clientWidth;e?this._scrollElement.classList.add("mx_IndicatorScrollbar_topOverflow"):this._scrollElement.classList.remove("mx_IndicatorScrollbar_topOverflow"),t?this._scrollElement.classList.add("mx_IndicatorScrollbar_bottomOverflow"):this._scrollElement.classList.remove("mx_IndicatorScrollbar_bottomOverflow"),s?this._scrollElement.classList.add("mx_IndicatorScrollbar_leftOverflow"):this._scrollElement.classList.remove("mx_IndicatorScrollbar_leftOverflow"),n?this._scrollElement.classList.add("mx_IndicatorScrollbar_rightOverflow"):this._scrollElement.classList.remove("mx_IndicatorScrollbar_rightOverflow"),this.props.trackHorizontalOverflow&&this.setState({leftIndicatorOffset:s?this._scrollElement.scrollLeft+"px":"0",rightIndicatorOffset:n?`-${this._scrollElement.scrollLeft}px`:"0"})}getScrollTop(){return this._autoHideScrollbar.getScrollTop()}componentWillUnmount(){this._scrollElement&&this._scrollElement.removeEventListener("scroll",this.checkOverflow)}render(){const e=this.props,{children:t,trackHorizontalOverflow:s,verticalScrollsHorizontally:i}=e,o=me()(e,["children","trackHorizontalOverflow","verticalScrollsHorizontally"]),r={left:this.state.leftIndicatorOffset},c={right:this.state.rightIndicatorOffset},l=s?a.a.createElement("div",{className:"mx_IndicatorScrollbar_leftOverflowIndicator",style:r}):null,d=s?a.a.createElement("div",{className:"mx_IndicatorScrollbar_rightOverflowIndicator",style:c}):null;return a.a.createElement(n.a,ue()({ref:this._collectScrollerComponent,wrappedRef:this._collectScroller,onWheel:this.onMouseWheel},o),l,t,d)}},x()(_t,"propTypes",{trackHorizontalOverflow:wt.a.bool,verticalScrollsHorizontally:wt.a.bool}),yt=Et))||yt;var kt=({onVisibilityChange:e})=>{const[t,s]=Object(o.useState)(null);return Object(f.a)(oe.b.instance,oe.a,()=>{if(oe.b.instance.getFirstNameFilterCondition()){const e=Object.values(oe.b.instance.orderedLists).flat(1).length;s(e)}else s(null)}),Object(o.useEffect)(()=>{e&&e()},[t,e]),"number"!=typeof t?null:a.a.createElement("div",{className:"mx_LeftPanel_roomListFilterCount"},Ce.f.instance.spacePanelSpaces.length?Object(c.a)("%(count)s results in all spaces",{count:t}):Object(c.a)("%(count)s results",{count:t}))},Ot=s(284);const Rt=(e,t)=>{try{const s=window.localStorage.getItem(e);return s?JSON.parse(s):t}catch(e){return t}},It=(e,t)=>{const s="mx_"+e,[n,i]=Object(o.useState)(Rt(s,t));Object(o.useEffect)(()=>{i(Rt(s,t))},[s,t]);return[n,Object(o.useCallback)(e=>{window.localStorage.setItem(s,JSON.stringify(e)),i(e)},[s])]};var xt=s(140);const Tt=e=>e?e.getContent():void 0;var jt=s(285),Nt=s(327),Pt=s(154);var Dt,At=()=>{const e=Object(o.useContext)(b.a),t=((e,t)=>{const[s,n]=Object(o.useState)(()=>Tt(e.getAccountData(t))),i=Object(o.useCallback)(e=>{e.getType()===t&&n(e.getContent())},[t]);return Object(f.a)(e,"accountData",i),s||{}})(e,"m.widgets"),s=Object(Nt.b)("Widgets.leftPanel"),n=Object(o.useMemo)(()=>{if(!t||!s)return null;const e=Object.values(t).find(e=>e.id===s);return e?xt.a.makeAppConfig(e.state_key,e.content,e.sender,null,e.id):null},[t,s]),[i,r]=It("left-panel-widget-height",280),[c,l]=It("left-panel-widget-expanded",!0),[d,u,h]=Object(ie.e)(),m=u?0:-1;if(!n)return null;let p;return c&&(p=a.a.createElement(Ot.Resizable,{size:{height:i},minHeight:100,maxHeight:Math.min(Pt.b.instance.windowHeight/2,500),onResizeStop:(e,t,s,n)=>{r(i+n.height)},handleWrapperClass:"mx_LeftPanelWidget_resizerHandles",handleClasses:{top:"mx_LeftPanelWidget_resizerHandle"},className:"mx_LeftPanelWidget_resizeBox",enable:{top:!0}},a.a.createElement(jt.a,{app:n,fullWidth:!0,show:!0,showMenubar:!1,userWidget:!0,userId:e.getUserId(),creatorUserId:n.creatorUserId,widgetPageTitle:xt.a.getWidgetDataTitle(n),waitForIframeLoad:n.waitForIframeLoad}))),a.a.createElement("div",{className:"mx_LeftPanelWidget"},a.a.createElement("div",{onFocus:d,className:"mx_LeftPanelWidget_headerContainer",onKeyDown:e=>{switch(e.key){case gt.a.ARROW_LEFT:e.stopPropagation(),l(!1);break;case gt.a.ARROW_RIGHT:e.stopPropagation(),l(!0)}}},a.a.createElement("div",{className:"mx_LeftPanelWidget_stickable"},a.a.createElement(g.a,{onFocus:d,inputRef:h,tabIndex:m,className:"mx_LeftPanelWidget_headerText",role:"treeitem","aria-expanded":c,"aria-level":1,onClick:()=>{l(e=>!e)}},a.a.createElement("span",{className:M()({mx_LeftPanelWidget_collapseBtn:!0,mx_LeftPanelWidget_collapseBtn_collapsed:!c})}),a.a.createElement("span",null,xt.a.getWidgetName(n))))),p)},Mt=s(184);const Ut=["mx_RoomSearch_input","mx_RoomSearch_minimizedHandle","mx_RoomSublist_headerText","mx_RoomTile","mx_RoomSublist_showNButton"];let Lt=Object(P.a)("structures.LeftPanel")(Dt=class extends o.Component{constructor(e){super(e),x()(this,"ref",Object(o.createRef)()),x()(this,"listContainerRef",Object(o.createRef)()),x()(this,"groupFilterPanelWatcherRef",void 0),x()(this,"bgImageWatcherRef",void 0),x()(this,"focusedElement",null),x()(this,"isDoingStickyHeaders",!1),x()(this,"updateActiveSpace",e=>{this.setState({activeSpace:e})}),x()(this,"onDialPad",()=>{u.a.fire(h.a.OpenDialPad)}),x()(this,"onExplore",()=>{u.a.fire(h.a.ViewRoomDirectory)}),x()(this,"refreshStickyHeaders",()=>{this.listContainerRef.current&&this.handleStickyHeaders(this.listContainerRef.current)}),x()(this,"onBreadcrumbsUpdate",()=>{const e=ht.instance.visible;if(e!==this.state.showBreadcrumbs){if(this.setState({showBreadcrumbs:e}),!this.listContainerRef.current)return;this.handleStickyHeaders(this.listContainerRef.current)}}),x()(this,"onBackgroundImageUpdate",()=>{let e=p.a.instance.getHttpAvatarUrl(32);const t=V.b.getValue("RoomList.backgroundImage");t&&(e=Object(pe.b)(t).getSquareThumbnailHttp(32));const s=`url(${e})`;e?document.body.style.getPropertyValue("--avatar-url")!==s&&document.body.style.setProperty("--avatar-url",s):document.body.style.removeProperty("--avatar-url")}),x()(this,"onScroll",e=>{const t=e.target;this.handleStickyHeaders(t)}),x()(this,"onFocus",e=>{this.focusedElement=e.target}),x()(this,"onBlur",()=>{this.focusedElement=null}),x()(this,"onKeyDown",e=>{if(!this.focusedElement)return;const t=Object(Mt.f)().getRoomListAction(e);switch(t){case Mt.e.NextRoom:case Mt.e.PrevRoom:e.stopPropagation(),e.preventDefault(),this.onMoveFocus(t===Mt.e.PrevRoom)}}),x()(this,"selectRoom",()=>{const e=this.listContainerRef.current.querySelector(".mx_RoomTile");if(e)return e.click(),!0}),x()(this,"onMoveFocus",e=>{let t,s=this.focusedElement,n=!1;do{const i=e?s.lastElementChild:s.firstElementChild,o=e?s.previousElementSibling:s.nextElementSibling;n?i?s=i:o?s=o:(n=!1,s=s.parentElement):o?(s=o,n=!0):s=s.parentElement,s&&(t=s.classList)}while(s&&(!Ut.some(e=>t.contains(e))||null===s.offsetParent));s&&(s.focus(),this.focusedElement=s)}),this.state={showBreadcrumbs:ht.instance.visible,showGroupFilterPanel:V.b.getValue("TagPanel.enableTagPanel"),activeSpace:Ce.f.instance.activeSpace},ht.instance.on(v.b,this.onBreadcrumbsUpdate),oe.b.instance.on(oe.a,this.onBreadcrumbsUpdate),p.a.instance.on(v.b,this.onBackgroundImageUpdate),Ce.f.instance.on(Ce.d,this.updateActiveSpace),this.bgImageWatcherRef=V.b.watchSetting("RoomList.backgroundImage",null,this.onBackgroundImageUpdate),this.groupFilterPanelWatcherRef=V.b.watchSetting("TagPanel.enableTagPanel",null,()=>{this.setState({showGroupFilterPanel:V.b.getValue("TagPanel.enableTagPanel")})})}componentDidMount(){var e;Pt.b.instance.trackElementDimensions("ListContainer",this.listContainerRef.current),Pt.b.instance.on("ListContainer",this.refreshStickyHeaders),null===(e=this.listContainerRef.current)||void 0===e||e.addEventListener("scroll",this.onScroll,{passive:!0})}componentWillUnmount(){var e;V.b.unwatchSetting(this.groupFilterPanelWatcherRef),V.b.unwatchSetting(this.bgImageWatcherRef),ht.instance.off(v.b,this.onBreadcrumbsUpdate),oe.b.instance.off(oe.a,this.onBreadcrumbsUpdate),p.a.instance.off(v.b,this.onBackgroundImageUpdate),Ce.f.instance.off(Ce.d,this.updateActiveSpace),Pt.b.instance.stopTrackingElementDimensions("ListContainer"),Pt.b.instance.removeListener("ListContainer",this.refreshStickyHeaders),null===(e=this.listContainerRef.current)||void 0===e||e.removeEventListener("scroll",this.onScroll)}componentDidUpdate(e,t){t.activeSpace!==this.state.activeSpace&&this.refreshStickyHeaders()}handleStickyHeaders(e){this.isDoingStickyHeaders||(this.isDoingStickyHeaders=!0,window.requestAnimationFrame(()=>{this.doStickyHeaders(e),this.isDoingStickyHeaders=!1}))}doStickyHeaders(e){const t=e.scrollTop,s=e.offsetHeight+e.scrollTop,n=e.querySelectorAll(".mx_RoomSublist:not(.mx_RoomSublist_hidden)"),i=new Map;let o,a;for(const e of n){const r=e.querySelector(".mx_RoomSublist_stickable");r.style.removeProperty("display");const c=.4,l=e.offsetTop+c*ce.a<=t,d=e.offsetTop+c*ce.a>=s;l||e===n[0]?(i.set(r,{stickyTop:!0}),o&&(o.style.display="none",i.set(o,{makeInvisible:!0})),o=r):d&&!a?(i.set(r,{stickyBottom:!0}),a=r):i.set(r,{})}for(const t of i.keys()){const s=i.get(t);if(s.makeInvisible)t.style.display="none";else{if(s.stickyTop){t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")||t.classList.add("mx_RoomSublist_headerContainer_stickyTop");const s=e.parentElement.offsetTop+"px";t.style.top!==s&&(t.style.top=s)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyTop"),t.style.top&&t.style.removeProperty("top");if(s.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")||t.classList.add("mx_RoomSublist_headerContainer_stickyBottom");const s=Pt.b.instance.windowHeight-(e.parentElement.offsetTop+e.parentElement.offsetHeight)+"px";t.style.bottom!==s&&(t.style.bottom=s)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyBottom"),t.style.bottom&&t.style.removeProperty("bottom");if(s.stickyTop||s.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_sticky")||t.classList.add("mx_RoomSublist_headerContainer_sticky");const e=Pt.b.instance.getElementDimensions("ListContainer");if(e){const s=15,n=e.width-s+"px";t.style.width!==n&&(t.style.width=n)}}else s.stickyTop||s.stickyBottom||(t.classList.contains("mx_RoomSublist_headerContainer_sticky")&&t.classList.remove("mx_RoomSublist_headerContainer_sticky"),t.style.width&&t.style.removeProperty("width"))}}const r=e.parentElement;o?r.classList.add("mx_LeftPanel_roomListWrapper_stickyTop"):r.classList.remove("mx_LeftPanel_roomListWrapper_stickyTop"),a?r.classList.add("mx_LeftPanel_roomListWrapper_stickyBottom"):r.classList.remove("mx_LeftPanel_roomListWrapper_stickyBottom")}renderHeader(){return o.createElement("div",{className:"mx_LeftPanel_userHeader"},o.createElement(ct,{isMinimized:this.props.isMinimized}))}renderBreadcrumbs(){if(this.state.showBreadcrumbs&&!this.props.isMinimized)return o.createElement(Ct,{className:"mx_LeftPanel_breadcrumbsContainer mx_AutoHideScrollbar",verticalScrollsHorizontally:!0,tabIndex:-1},o.createElement(bt,null))}renderSearchDialExplore(){let e=null;return De.e.sharedInstance().getSupportsPstnProtocol()&&(e=o.createElement(K.a,{className:M()("mx_LeftPanel_dialPadButton",{}),onClick:this.onDialPad,title:Object(c.a)("Open dial pad")})),o.createElement("div",{className:"mx_LeftPanel_filterContainer",onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown},o.createElement(lt.a,{isMinimized:this.props.isMinimized,onKeyDown:this.onKeyDown,onSelectRoom:this.selectRoom}),e,o.createElement(K.a,{className:M()("mx_LeftPanel_exploreButton",{mx_LeftPanel_exploreButton_space:!!this.state.activeSpace}),onClick:this.onExplore,title:Object(c.a)("Explore rooms")}))}render(){let e;this.state.showGroupFilterPanel&&(e=o.createElement("div",{className:"mx_LeftPanel_GroupFilterPanelContainer"},o.createElement(z,null),V.b.getValue("feature_custom_tags")?o.createElement(se,null):null));const t=o.createElement(Ne,{onKeyDown:this.onKeyDown,resizeNotifier:this.props.resizeNotifier,onFocus:this.onFocus,onBlur:this.onBlur,isMinimized:this.props.isMinimized,activeSpace:this.state.activeSpace,onResize:this.refreshStickyHeaders,onListCollapse:this.refreshStickyHeaders}),s=M()({mx_LeftPanel:!0,mx_LeftPanel_minimized:this.props.isMinimized}),n=M()("mx_LeftPanel_actualRoomListContainer","mx_AutoHideScrollbar");return o.createElement("div",{className:s,ref:this.ref},e,o.createElement("aside",{className:"mx_LeftPanel_roomListContainer"},this.renderHeader(),this.renderSearchDialExplore(),this.renderBreadcrumbs(),o.createElement(kt,{onVisibilityChange:this.refreshStickyHeaders}),o.createElement("div",{className:"mx_LeftPanel_roomListWrapper"},o.createElement("div",{className:n,ref:this.listContainerRef,tabIndex:-1},t)),!this.props.isMinimized&&o.createElement(At,null)))}})||Dt;var Ft=s(178),Bt=s(632),Vt=s(292);async function Kt(){console.log("Checking for COLR support");const{userAgent:e}=navigator;if(e.includes("Firefox"))return console.log("Browser is Firefox - assuming COLR is supported"),!0;if(!e.includes("Chrome")&&e.includes("Safari"))return function(e){console.log("Browser is Safari - checking version for COLR support");try{const t=e.match(/Mac OS X ([\d|_]+).*Version\/([\d|.]+).*Safari/);if(t){const e=t[1],s=t[2],n=e.split("_").map(e=>parseInt(e,10)),i=s.split(".").map(e=>parseInt(e,10)),o=n[0]>=10&&n[1]>=14&&i[0]>=12;return console.log(`COLR support on Safari requires macOS 10.14 and Safari 12, detected Safari ${s} on macOS ${e}, COLR supported: `+o),o}}catch(e){console.error("Error in Safari COLR version check",e)}return console.warn("Couldn't determine Safari version to check COLR font support, assuming no."),!1}(e);try{const e=document.createElement("canvas"),t=e.getContext("2d"),s=new Image,n=`\n        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="100" style="background:#fff;fill:#000;">\n            <style type="text/css">\n                @font-face {\n                    font-family: "chromacheck-colr";\n                    src: url(data:application/x-font-woff;base64,${"d09GRgABAAAAAAKAAAwAAAAAAowAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABDT0xSAAACVAAAABYAAAAYAAIAJUNQQUwAAAJsAAAAEgAAABLJAAAQT1MvMgAAAYAAAAA6AAAAYBfxJ0pjbWFwAAABxAAAACcAAAAsAAzpM2dseWYAAAH0AAAAGgAAABoNIh0kaGVhZAAAARwAAAAvAAAANgxLumdoaGVhAAABTAAAABUAAAAkCAEEAmhtdHgAAAG8AAAABgAAAAYEAAAAbG9jYQAAAewAAAAGAAAABgANAABtYXhwAAABZAAAABsAAAAgAg4AHW5hbWUAAAIQAAAAOAAAAD4C5wsecG9zdAAAAkgAAAAMAAAAIAADAAB4AWNgZGAAYQ5+qdB4fpuvDNIsDCBwaQGTAIi+VlscBaJZGMDiHAxMIAoAtjIF/QB4AWNgZGBgYQACOAkUQQWMAAGRABAAAAB4AWNgZGBgYGJgAdMMUJILJMQgAWICAAH3AC4AeAFjYGFhYJzAwMrAwDST6QwDA0M/hGZ8zWDMyMmAChgFkDgKQMBw4CXDSwYWEBdIYgAFBgYA/8sIdAAABAAAAAAAAAB4AWNgYGBkYAZiBgYeBhYGBSDNAoRA/kuG//8hpDgjWJ4BAFVMBiYAAAAAAAANAAAAAQAAAAAEAAQAAAMAABEhESEEAPwABAD8AAAAeAEtxgUNgAAAAMHHIQTShTlOAty9/4bf7AARCwlBNhBw4L/43qXjYGUmf19TMuLcj/BJL3XfBg54AWNgZsALAAB9AAR4AWNgYGAEYj4gFgGygGwICQACOwAoAAAAAAABAAEAAQAAAA4AAAAAyP8AAA=="}) format("woff");\n                }\n            </style>\n            <text x="0" y="0" font-size="20">\n                <tspan font-family="chromacheck-colr" x="0" dy="20">&#xe900;</tspan>\n            </text>\n        </svg>`;e.width=20,e.height=100,s.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(n),console.log("Waiting for COLR SVG to load"),await new Promise(e=>s.onload=e),console.log("Drawing canvas to detect COLR support"),t.drawImage(s,0,0);const i=200===t.getImageData(10,10,1,1).data[0];return console.log("Canvas check revealed COLR is supported? "+i),i}catch(e){return console.error("Couldn't load COLR font",e),!1}}let Wt=!1;async function Gt(){if(!Wt)if(Wt=!0,await Kt()){const e=`url('${s(1232)}')`;document.fonts.add(new FontFace("Twemoji",e,{})),document.fonts.add(new FontFace("Twemoji",e,{weight:600})),document.fonts.add(new FontFace("Twemoji",e,{weight:700}))}else{const e=`url('${s(1233)}')`;document.fonts.add(new FontFace("Twemoji",e,{})),document.fonts.add(new FontFace("Twemoji",e,{weight:600})),document.fonts.add(new FontFace("Twemoji",e,{weight:700}))}}var qt=s(458),Ht=s(341),$t=(s(459),s(696));class zt extends $t.a{notifyCollapsed(e){const t=this.resizer.config.onCollapsed;t&&t(e,this.id,this.domNode)}get isCollapsed(){return(0,this.resizer.config.isItemCollapsed)(this.domNode)}}class Yt extends Ht.a{static createItem(e,t,s){return new zt(e,t,s)}constructor(e){var t,s;super(e),x()(this,"toggleSize",void 0),x()(this,"isCollapsed",void 0),this.toggleSize=null===(t=e.resizer)||void 0===t||null===(s=t.config)||void 0===s?void 0:s.toggleSize,this.isCollapsed=e.isCollapsed}resize(e){const t=e<this.toggleSize;t&&!this.isCollapsed?(this.isCollapsed=!0,this.item.notifyCollapsed(!0)):!t&&this.isCollapsed&&(this.item.notifyCollapsed(!1),this.isCollapsed=!1),t||super.resize(e)}}var Jt=s(460),Qt=s(442),Xt=s(118),Zt=s(165),es=s(144),ts=s(289);const ss=()=>{es.a.sharedInstance().dismissToast("serverlimit")};var ns,is=s(158);let os=Object(P.a)("views.voip.IncomingCallBox")(ns=class extends a.a.Component{constructor(e){super(e),x()(this,"dispatcherRef",void 0),x()(this,"onAction",e=>{switch(e.action){case"call_state":{const t=De.e.sharedInstance().getCallForRoom(e.room_id);t&&t.state===is.e.Ringing?this.setState({incomingCall:t,silenced:!1}):this.setState({incomingCall:null})}}}),x()(this,"onAnswerClick",e=>{e.stopPropagation(),u.a.dispatch({action:"answer",room_id:De.e.sharedInstance().roomIdForCall(this.state.incomingCall)})}),x()(this,"onRejectClick",e=>{e.stopPropagation(),u.a.dispatch({action:"reject",room_id:De.e.sharedInstance().roomIdForCall(this.state.incomingCall)})}),x()(this,"onSilenceClick",e=>{e.stopPropagation();const t=!this.state.silenced;this.setState({silenced:t}),t?De.e.sharedInstance().pause(De.a.Ring):De.e.sharedInstance().play(De.a.Ring)}),this.dispatcherRef=u.a.register(this.onAction),this.state={incomingCall:null,silenced:!1}}componentWillUnmount(){u.a.unregister(this.dispatcherRef)}render(){if(!this.state.incomingCall)return null;let e=null;this.state.incomingCall&&(e=le.a.get().getRoom(De.e.sharedInstance().roomIdForCall(this.state.incomingCall)));const t=e?e.name:Object(c.a)("Unknown caller");let s=null;this.state.incomingCall&&(s="voice"===this.state.incomingCall.type?Object(c.a)("Incoming voice call"):"video"===this.state.incomingCall.type?Object(c.a)("Incoming video call"):Object(c.a)("Incoming call"));const n=M()({mx_IncomingCallBox_iconButton:!0,mx_IncomingCallBox_unSilence:this.state.silenced,mx_IncomingCallBox_silence:!this.state.silenced});return a.a.createElement("div",{className:"mx_IncomingCallBox"},a.a.createElement("div",{className:"mx_IncomingCallBox_CallerInfo"},a.a.createElement(Oe.a,{room:e,height:32,width:32}),a.a.createElement("div",null,a.a.createElement("h1",null,t),a.a.createElement("p",null,s)),a.a.createElement(K.a,{className:n,onClick:this.onSilenceClick,title:this.state.silenced?Object(c.a)("Sound on"):Object(c.a)("Silence call")})),a.a.createElement("div",{className:"mx_IncomingCallBox_buttons"},a.a.createElement(g.a,{className:"mx_IncomingCallBox_decline",onClick:this.onRejectClick,kind:"danger"},Object(c.a)("Decline")),a.a.createElement("div",{className:"mx_IncomingCallBox_spacer"}),a.a.createElement(g.a,{className:"mx_IncomingCallBox_accept",onClick:this.onAnswerClick,kind:"primary"},Object(c.a)("Accept"))))}})||ns;var as,rs=s(461),cs=s(278);let ls=Object(P.a)("views.elements.PersistentApp")(as=class extends a.a.Component{constructor(...e){super(...e),x()(this,"state",{roomId:ae.a.getRoomId(),persistentWidgetId:cs.a.getPersistentWidgetId()}),x()(this,"_onRoomViewStoreUpdate",e=>{ae.a.getRoomId()!==this.state.roomId&&this.setState({roomId:ae.a.getRoomId()})}),x()(this,"_onActiveWidgetStoreUpdate",()=>{this.setState({persistentWidgetId:cs.a.getPersistentWidgetId()})}),x()(this,"_onMyMembership",async(e,t)=>{const s=cs.a.getRoomId(this.state.persistentWidgetId);"join"!==t&&e.roomId===s&&cs.a.destroyPersistentWidget(this.state.persistentWidgetId)})}componentDidMount(){this._roomStoreToken=ae.a.addListener(this._onRoomViewStoreUpdate),cs.a.on("update",this._onActiveWidgetStoreUpdate),le.a.get().on("Room.myMembership",this._onMyMembership)}componentWillUnmount(){this._roomStoreToken&&this._roomStoreToken.remove(),cs.a.removeListener("update",this._onActiveWidgetStoreUpdate),le.a.get()&&le.a.get().removeListener("Room.myMembership",this._onMyMembership)}render(){if(this.state.persistentWidgetId){const e=cs.a.getRoomId(this.state.persistentWidgetId),t=le.a.get().getRoom(e);if(!t)return null;const s=t.getMyMembership();if(this.state.roomId!==e&&"join"===s){const s=xt.a.getRoomWidgets(t).find(e=>e.getStateKey()===cs.a.getPersistentWidgetId()),n=xt.a.makeAppConfig(s.getStateKey(),s.getContent(),s.getSender(),e,s.getId()),i=d.getComponent("elements.AppTile");return a.a.createElement(i,{key:n.id,app:n,fullWidth:!0,room:t,userId:le.a.get().credentials.userId,creatorUserId:n.creatorUserId,widgetPageTitle:xt.a.getWidgetDataTitle(n),waitForIframeLoad:n.waitForIframeLoad,miniMode:!0,showMenubar:!1})}}return null}})||as;var ds;const us=[is.e.Connected,is.e.InviteSent,is.e.Connecting,is.e.CreateAnswer,is.e.CreateOffer,is.e.WaitLocalMedia];function hs(e){let t=null,s=[];for(const n of e)us.includes(n.state)&&(n.isRemoteOnHold()||null!==t?s.push(n):t=n);return null===t&&s.length>0&&(t=s[0],s=s.slice(1)),s.length>1&&console.log("Found more than 1 secondary call! Other calls will not be shown."),[t,s]}let ms=Object(P.a)("views.voip.CallPreview")(ds=class extends a.a.Component{constructor(e){super(e),x()(this,"roomStoreToken",void 0),x()(this,"dispatcherRef",void 0),x()(this,"settingsWatcherRef",void 0),x()(this,"onRoomViewStoreUpdate",e=>{if(ae.a.getRoomId()===this.state.roomId)return;const t=ae.a.getRoomId(),[s,n]=hs(De.e.sharedInstance().getAllActiveCallsNotInRoom(t));this.setState({roomId:t,primaryCall:s,secondaryCall:n[0]})}),x()(this,"onAction",e=>{switch(e.action){case"call_state":this.updateCalls()}}),x()(this,"updateCalls",()=>{const[e,t]=hs(De.e.sharedInstance().getAllActiveCallsNotInRoom(this.state.roomId));this.setState({primaryCall:e,secondaryCall:t[0]})}),x()(this,"onCallRemoteHold",()=>{const[e,t]=hs(De.e.sharedInstance().getAllActiveCallsNotInRoom(this.state.roomId));this.setState({primaryCall:e,secondaryCall:t[0]})});const t=ae.a.getRoomId(),[s,n]=hs(De.e.sharedInstance().getAllActiveCallsNotInRoom(t));this.state={roomId:t,primaryCall:s,secondaryCall:n[0]}}componentDidMount(){De.e.sharedInstance().addListener(De.b.CallChangeRoom,this.updateCalls),this.roomStoreToken=ae.a.addListener(this.onRoomViewStoreUpdate),this.dispatcherRef=u.a.register(this.onAction),le.a.get().on(is.c.RemoteHoldUnhold,this.onCallRemoteHold)}componentWillUnmount(){De.e.sharedInstance().removeListener(De.b.CallChangeRoom,this.updateCalls),le.a.get().removeListener(is.c.RemoteHoldUnhold,this.onCallRemoteHold),this.roomStoreToken&&this.roomStoreToken.remove(),u.a.unregister(this.dispatcherRef),V.b.unwatchSetting(this.settingsWatcherRef)}render(){return this.state.primaryCall?a.a.createElement(rs.a,{call:this.state.primaryCall,secondaryCall:this.state.secondaryCall,pipMode:!0}):a.a.createElement(ls,null)}})||ds;var ps;let gs=Object(P.a)("views.voip.CallContainer")(ps=class extends a.a.PureComponent{render(){return a.a.createElement("div",{className:"mx_CallContainer"},a.a.createElement(os,null),a.a.createElement(ms,null))}})||ps;var vs,fs=s(688);let bs=Object(P.a)("structures.NonUrgentToastContainer")(vs=class extends o.PureComponent{constructor(e,t){super(e,t),x()(this,"onUpdateToasts",()=>{this.setState({toasts:fs.a.instance.components})}),this.state={toasts:fs.a.instance.components},fs.a.instance.on(v.b,this.onUpdateToasts)}componentWillUnmount(){fs.a.instance.off(v.b,this.onUpdateToasts)}render(){const e=this.state.toasts.map((e,t)=>o.createElement("div",{className:"mx_NonUrgentToastContainer_toast",key:"toast-"+t},o.createElement(e,{})));return o.createElement("div",{className:"mx_NonUrgentToastContainer",role:"alert"},e)}})||vs;var ys=s(332);let _s;var Es;!function(e){e.CloseDialog="close_dialog",e.HostSignupAccountDetails="host_signup_account_details",e.HostSignupAccountDetailsRequest="host_signup_account_details_request",e.Minimize="host_signup_minimize",e.Maximize="host_signup_maximize",e.SetupComplete="setup_complete"}(_s||(_s={}));let Ss=Object(P.a)("views.dialogs.HostSignupDialog")(Es=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"iframeRef",a.a.createRef()),x()(this,"config",void 0),x()(this,"messageHandler",async e=>{if(this.config.url.startsWith(e.origin))switch(e.data.action){case _s.HostSignupAccountDetailsRequest:this.onAccountDetailsRequest();break;case _s.Maximize:this.setState({minimized:!1});break;case _s.Minimize:this.setState({minimized:!0});break;case _s.SetupComplete:this.setState({completed:!0});break;case _s.CloseDialog:return this.closeDialog()}}),x()(this,"maximizeDialog",()=>{this.setState({minimized:!1}),this.sendMessage({action:_s.Maximize})}),x()(this,"minimizeDialog",()=>{this.setState({minimized:!0}),this.sendMessage({action:_s.Minimize})}),x()(this,"closeDialog",async()=>(window.removeEventListener("message",this.messageHandler),ys.a.destroyElement("host_signup"),j.instance.setHostSignupActive(!1))),x()(this,"onCloseClick",async()=>{if(this.state.completed)return this.closeDialog();Le.a.createDialog(Me.a,{title:Object(c.a)("Confirm abort of host creation"),description:Object(c.a)("Are you sure you wish to abort creation of the host? The process cannot be continued."),button:Object(c.a)("Abort"),onFinished:e=>{if(e)return this.closeDialog()}})}),x()(this,"sendMessage",e=>{this.iframeRef.current.contentWindow.postMessage(e,this.config.url)}),x()(this,"onAccountDetailsDialogFinished",async e=>e?this.sendAccountDetails():this.closeDialog()),x()(this,"onAccountDetailsRequest",()=>{const e=a.a.createElement(a.a.Fragment,null,a.a.createElement("p",null,Object(c.a)("Continuing temporarily allows the %(hostSignupBrand)s setup process to access your account to fetch verified email addresses. This data is not stored.",{hostSignupBrand:this.config.brand})),a.a.createElement("p",null,Object(c.a)("Learn more in our <privacyPolicyLink />, <termsOfServiceLink /> and <cookiePolicyLink />.",{},{cookiePolicyLink:()=>a.a.createElement("a",{href:this.config.cookiePolicyUrl,target:"_blank",rel:"noreferrer noopener"},Object(c.a)("Cookie Policy")),privacyPolicyLink:()=>a.a.createElement("a",{href:this.config.privacyPolicyUrl,target:"_blank",rel:"noreferrer noopener"},Object(c.a)("Privacy Policy")),termsOfServiceLink:()=>a.a.createElement("a",{href:this.config.termsOfServiceUrl,target:"_blank",rel:"noreferrer noopener"},Object(c.a)("Terms of Service"))})));Le.a.createDialog(Me.a,{title:Object(c.a)("You should know"),description:e,button:Object(c.a)("Continue"),onFinished:this.onAccountDetailsDialogFinished})}),this.state={completed:!1,error:null,minimized:!1},this.config=l.a.get().hostSignup}async sendAccountDetails(){const e=await le.a.get().getOpenIdToken();if(!e||!e.access_token)return console.warn("Failed to connect to homeserver for OpenID token."),void this.setState({completed:!0,error:Object(c.a)("Failed to connect to your homeserver. Please close this dialog and try again.")});this.sendMessage({action:_s.HostSignupAccountDetails,account:{accessToken:await le.a.get().getAccessToken(),name:p.a.instance.displayName,openIdToken:e.access_token,serverName:await le.a.get().getDomain(),userLocalpart:await le.a.get().getUserIdLocalpart(),termsAccepted:!0}})}componentDidMount(){window.addEventListener("message",this.messageHandler)}componentWillUnmount(){if(j.instance.isHostSignupActive)return this.closeDialog()}render(){return a.a.createElement("div",{className:"mx_HostSignup_persisted"},a.a.createElement(ys.a,{key:"host_signup",persistKey:"host_signup"},a.a.createElement("div",{className:M()({mx_Dialog_wrapper:!this.state.minimized})},a.a.createElement("div",{className:M()("mx_Dialog",{mx_HostSignupDialog_minimized:this.state.minimized,mx_HostSignupDialog:!this.state.minimized})},this.state.minimized&&a.a.createElement("div",{className:"mx_Dialog_header mx_Dialog_headerWithButton"},a.a.createElement("div",{className:"mx_Dialog_title"},Object(c.a)("%(hostSignupBrand)s Setup",{hostSignupBrand:this.config.brand})),a.a.createElement(g.a,{className:"mx_HostSignup_maximize_button",onClick:this.maximizeDialog,"aria-label":Object(c.a)("Maximize dialog"),title:Object(c.a)("Maximize dialog")})),!this.state.minimized&&a.a.createElement("div",{className:"mx_Dialog_header mx_Dialog_headerWithCancel"},a.a.createElement(g.a,{onClick:this.minimizeDialog,className:"mx_HostSignup_minimize_button","aria-label":Object(c.a)("Minimize dialog"),title:Object(c.a)("Minimize dialog")}),a.a.createElement(g.a,{onClick:this.onCloseClick,className:"mx_Dialog_cancelButton","aria-label":Object(c.a)("Close dialog"),title:Object(c.a)("Close dialog")})),this.state.error&&a.a.createElement("div",null,this.state.error),!this.state.error&&a.a.createElement("iframe",{src:this.config.url,ref:this.iframeRef,sandbox:"allow-forms allow-scripts allow-same-origin allow-popups"})))))}})||Es;var ws=()=>{const[e,t]=Object(o.useState)(j.instance.isHostSignupActive);return Object(f.a)(j.instance,v.b,()=>{t(j.instance.isHostSignupActive)}),a.a.createElement("div",{className:"mx_HostSignupContainer"},e&&a.a.createElement(Ss,null))},Cs=s(1234),ks=s(402),Os=s.n(ks),Rs=s(137),Is=s(448),xs=s(290),Ts=s(163),js=s(295),Ns=s(241),Ps=s(340);function Ds(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function As(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?Ds(Object(s),!0).forEach((function(t){x()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):Ds(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const Ms=({title:e,description:t,className:s,onClick:n})=>a.a.createElement(g.a,{className:M()("mx_SpaceCreateMenuType",s),onClick:n},a.a.createElement("h3",null,e),a.a.createElement("span",null,t));var Us;!function(e){e[e.Public=0]="Public",e[e.Private=1]="Private"}(Us||(Us={}));const Ls=Object(Ts.a)({rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>Object(c.a)("Please enter a name for the space")}]}),Fs=(e,t)=>`#${e.trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9_-]+/gi,"")}:${t}`;var Bs=({onFinished:e})=>{const t=Object(o.useContext)(b.a),[s,n]=Object(o.useState)(null),[r,l]=Object(o.useState)(!1),[d,m]=Object(o.useState)(""),p=Object(o.useRef)(),[v,f]=Object(o.useState)(""),y=Object(o.useRef)(),[_,E]=Object(o.useState)(null),[S,w]=Object(o.useState)(""),C=async n=>{if(n.preventDefault(),r)return;if(l(!0),!await p.current.validate({allowEmpty:!1}))return p.current.focus(),p.current.validate({allowEmpty:!1,focused:!0}),void l(!1);if(s===Us.Public&&!await y.current.validate({allowEmpty:!0}))return y.current.focus(),y.current.validate({allowEmpty:!0,focused:!0}),void l(!1);const i=[{type:ne.a.RoomHistoryVisibility,content:{history_visibility:s===Us.Public?"world_readable":"invited"}}];if(_){const e=await t.uploadContent(_);i.push({type:ne.a.RoomAvatar,content:{url:e}})}try{await Object(Rs.b)({createOpts:{preset:s===Us.Public?Ns.a.PublicChat:Ns.a.PrivateChat,name:d,creation_content:{[ne.d]:ne.e.Space},initial_state:i,power_level_content_override:As({events_default:100},Us.Public?{invite:0}:{}),room_alias_name:s===Us.Public&&v?v.substr(1,v.indexOf(":")-1):void 0,topic:S},spinner:!1,encryption:!1,andView:!0,inlineErrors:!0}),e()}catch(n){console.error(n)}};let k;if(null===s)k=a.a.createElement(a.a.Fragment,null,a.a.createElement("h2",null,Object(c.a)("Create a space")),a.a.createElement("p",null,Object(c.a)("Spaces are a new way to group rooms and people. To join an existing space you'll need an invite.")),a.a.createElement(Ms,{title:Object(c.a)("Public"),description:Object(c.a)("Open space for anyone, best for communities"),className:"mx_SpaceCreateMenuType_public",onClick:()=>n(Us.Public)}),a.a.createElement(Ms,{title:Object(c.a)("Private"),description:Object(c.a)("Invite only, best for yourself or teams"),className:"mx_SpaceCreateMenuType_private",onClick:()=>n(Us.Private)}),a.a.createElement("p",null,Object(c.a)("You can change this later")),a.a.createElement(js.a,{onClick:e}));else{const e=t.getDomain();k=a.a.createElement(a.a.Fragment,null,a.a.createElement(K.a,{className:"mx_SpaceCreateMenu_back",onClick:()=>n(null),title:Object(c.a)("Go back")}),a.a.createElement("h2",null,s===Us.Public?Object(c.a)("Your public space"):Object(c.a)("Your private space")),a.a.createElement("p",null,Object(c.a)("Add some details to help people recognise it.")," ",Object(c.a)("You can change these anytime.")),a.a.createElement("form",{className:"mx_SpaceBasicSettings",onSubmit:C},a.a.createElement(Is.a,{setAvatar:E,avatarDisabled:r}),a.a.createElement(Ue.a,{name:"spaceName",label:Object(c.a)("Name"),autoFocus:!0,value:d,onChange:t=>{const s=t.target.value;v&&v!==Fs(d,e)||f(Fs(s,e)),m(s)},ref:p,onValidate:Ls,disabled:r}),s===Us.Public?a.a.createElement(Ps.a,{ref:y,onChange:f,domain:e,value:v,placeholder:d?Fs(d,e):Object(c.a)("e.g. my-space"),label:Object(c.a)("Address")}):null,a.a.createElement(Ue.a,{name:"spaceTopic",element:"textarea",label:Object(c.a)("Description"),value:S,onChange:e=>w(e.target.value),rows:3,disabled:r})),a.a.createElement(g.a,{kind:"primary",onClick:C,disabled:r},r?Object(c.a)("Creating..."):Object(c.a)("Create")))}return a.a.createElement(i.b,{left:72,top:62,chevronOffset:0,chevronFace:i.a.None,onFinished:e,wrapperClassName:"mx_SpaceCreateMenu_wrapper",managed:!1},a.a.createElement(Os.a,{returnFocus:!0},a.a.createElement(xs.a,{onClick:()=>{e(),u.a.dispatch({action:h.a.ViewUserSettings,initialTabId:Ae.a.Labs})}}),k))};const Vs=(e,t)=>{let s="";if(t)for(const e of t.entries())s+=e+"/";return"mx_space_collapsed_"+(s+e)};class Ks{static get instance(){return Ks.internalInstance||(Ks.internalInstance=new Ks),Ks.internalInstance}setSpaceCollapsedState(e,t,s){localStorage.setItem(Vs(e,t),s.toString())}getSpaceCollapsedState(e,t,s){const n=localStorage.getItem(Vs(e,t));return n?"true"===n:s}}x()(Ks,"internalInstance",void 0);var Ws=s(453),Gs=s(262),qs=s(203);class Hs extends a.a.PureComponent{constructor(e){super(e),x()(this,"buttonRef",Object(o.createRef)()),x()(this,"onSpaceUpdate",()=>{this.setState({childSpaces:this.childSpaces})}),x()(this,"toggleCollapse",e=>{this.props.onExpand&&this.isCollapsed&&this.props.onExpand();const t=!this.isCollapsed;Ks.instance.setSpaceCollapsedState(this.props.space.roomId,this.props.parents,t),this.setState({collapsed:t}),e.stopPropagation()}),x()(this,"onContextMenu",e=>{"join"===this.props.space.getMyMembership()&&(e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{right:e.clientX,top:e.clientY,height:0}}))}),x()(this,"onKeyDown",e=>{var t;let s=!0;const n=Object(Mt.f)().getRoomListAction(e),i=null===(t=this.state.childSpaces)||void 0===t?void 0:t.length;switch(n){case Mt.e.CollapseSection:if(i&&!this.isCollapsed)this.toggleCollapse(e);else{var o,a,r;const e=null===(o=this.buttonRef)||void 0===o||null===(a=o.current)||void 0===a||null===(r=a.parentElement)||void 0===r?void 0:r.parentElement,t=null==e?void 0:e.previousElementSibling;null==t||t.focus()}break;case Mt.e.ExpandSection:if(i)if(this.isCollapsed)this.toggleCollapse(e);else{var c,l,d;const e=null===(c=this.buttonRef)||void 0===c||null===(l=c.current)||void 0===l?void 0:l.nextElementSibling,t=null==e?void 0:e.querySelector(".mx_SpaceItem");null==t||null===(d=t.querySelector(".mx_SpaceButton"))||void 0===d||d.focus()}break;default:s=!1}s&&(e.stopPropagation(),e.preventDefault())}),x()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),Ce.f.instance.setActiveSpace(this.props.space)}),x()(this,"onMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})}),x()(this,"onMenuClose",()=>{this.setState({contextMenuPosition:null})}),x()(this,"onInviteClick",e=>{e.preventDefault(),e.stopPropagation(),Object(ke.e)(this.props.space),this.setState({contextMenuPosition:null})}),x()(this,"onSettingsClick",e=>{e.preventDefault(),e.stopPropagation(),Object(ke.f)(this.context,this.props.space),this.setState({contextMenuPosition:null})}),x()(this,"onLeaveClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"leave_room",room_id:this.props.space.roomId}),this.setState({contextMenuPosition:null})}),x()(this,"onNewRoomClick",e=>{e.preventDefault(),e.stopPropagation(),Object(ke.d)(this.context,this.props.space),this.setState({contextMenuPosition:null})}),x()(this,"onAddExistingRoomClick",e=>{e.preventDefault(),e.stopPropagation(),Object(ke.c)(this.context,this.props.space),this.setState({contextMenuPosition:null})}),x()(this,"onMembersClick",e=>{e.preventDefault(),e.stopPropagation(),ae.a.getRoomId()||u.a.dispatch({action:"view_room",room_id:this.props.space.roomId},!0),u.a.dispatch({action:h.a.SetRightPanelPhase,phase:Qe.c.SpaceMemberList,refireParams:{space:this.props.space}}),this.setState({contextMenuPosition:null})}),x()(this,"onExploreRoomsClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"view_room",room_id:this.props.space.roomId}),this.setState({contextMenuPosition:null})});const t=Ks.instance.getSpaceCollapsedState(e.space.roomId,this.props.parents,!e.isNested);this.state={collapsed:t,contextMenuPosition:null,childSpaces:this.childSpaces},Ce.f.instance.on(this.props.space.roomId,this.onSpaceUpdate)}componentWillUnmount(){Ce.f.instance.off(this.props.space.roomId,this.onSpaceUpdate)}get childSpaces(){return Ce.f.instance.getChildSpaces(this.props.space.roomId).filter(e=>{var t;return!(null!==(t=this.props.parents)&&void 0!==t&&t.has(e.roomId))})}get isCollapsed(){return this.state.collapsed||this.props.isPanelCollapsed}renderContextMenu(){if("join"!==this.props.space.getMyMembership())return null;let e=null;if(this.state.contextMenuPosition){const t=this.context.getUserId();let s,n,o;("public"===this.props.space.getJoinRule()||this.props.space.canInvite(t))&&(s=a.a.createElement(T.b,{className:"mx_SpacePanel_contextMenu_inviteButton",iconClassName:"mx_SpacePanel_iconInvite",label:Object(c.a)("Invite people"),onClick:this.onInviteClick})),Object(ke.b)(this.context,this.props.space)?n=a.a.createElement(T.b,{iconClassName:"mx_SpacePanel_iconSettings",label:Object(c.a)("Settings"),onClick:this.onSettingsClick}):o=a.a.createElement(T.c,{red:!0,first:!0},a.a.createElement(T.b,{iconClassName:"mx_SpacePanel_iconLeave",label:Object(c.a)("Leave space"),onClick:this.onLeaveClick}));const r=this.props.space.currentState.maySendStateEvent(ne.a.SpaceChild,t);let l;this.props.space.currentState.maySendStateEvent(ne.a.SpaceChild,t)&&(l=a.a.createElement(T.c,{first:!0},a.a.createElement(T.b,{iconClassName:"mx_SpacePanel_iconPlus",label:Object(c.a)("Create new room"),onClick:this.onNewRoomClick}),a.a.createElement(T.b,{iconClassName:"mx_SpacePanel_iconHash",label:Object(c.a)("Add existing room"),onClick:this.onAddExistingRoomClick}))),e=a.a.createElement(T.e,ue()({},Object(i.p)(this.state.contextMenuPosition,0),{onFinished:this.onMenuClose,className:"mx_SpacePanel_contextMenu",compact:!0}),a.a.createElement("div",{className:"mx_SpacePanel_contextMenu_header"},this.props.space.name),a.a.createElement(T.c,{first:!0},s,a.a.createElement(T.b,{iconClassName:"mx_SpacePanel_iconMembers",label:Object(c.a)("Members"),onClick:this.onMembersClick}),n,a.a.createElement(T.b,{iconClassName:"mx_SpacePanel_iconExplore",label:r?Object(c.a)("Manage & explore rooms"):Object(c.a)("Explore rooms"),onClick:this.onExploreRoomsClick})),l,o)}return a.a.createElement(a.a.Fragment,null,a.a.createElement(Gs.a,{className:"mx_SpaceButton_menuButton",onClick:this.onMenuOpenClick,title:Object(c.a)("Space options"),isExpanded:!!this.state.contextMenuPosition}),e)}render(){var e,t,s;const n=this.props,{space:i,activeSpaces:o,isNested:r,isPanelCollapsed:l,onExpand:d,parents:u,innerRef:h}=n,m=me()(n,["space","activeSpaces","isNested","isPanelCollapsed","onExpand","parents","innerRef"]),p=this.isCollapsed,v=o.includes(i),f=M()(this.props.className,{mx_SpaceItem:!0,mx_SpaceItem_narrow:l,collapsed:p,hasSubSpaces:null===(e=this.state.childSpaces)||void 0===e?void 0:e.length}),b="invite"===i.getMyMembership(),y=M()("mx_SpaceButton",{mx_SpaceButton_active:v,mx_SpaceButton_hasMenuOpen:!!this.state.contextMenuPosition,mx_SpaceButton_narrow:l,mx_SpaceButton_invite:b}),_=b?ye.a.forSymbol("!",qs.a.Red):Ce.f.instance.getNotificationState(i.roomId);let E,S;null!==(t=this.state.childSpaces)&&void 0!==t&&t.length&&!p&&(E=a.a.createElement($s,{spaces:this.state.childSpaces,activeSpaces:o,isNested:!0,parents:new Set(u).add(i.roomId)})),_&&(S=a.a.createElement("div",{className:"mx_SpacePanel_badgeContainer"},a.a.createElement(ve.a,{forceCount:!1,notification:_})));const w=r?24:32,C=null!==(s=this.state.childSpaces)&&void 0!==s&&s.length?a.a.createElement(g.a,{className:"mx_SpaceButton_toggleCollapse",onClick:this.toggleCollapse,tabIndex:-1,"aria-label":p?Object(c.a)("Expand"):Object(c.a)("Collapse")}):null;return a.a.createElement("li",ue()({},m,{className:f,ref:h}),a.a.createElement(Ws.a,{className:y,title:i.name,onClick:this.onClick,onContextMenu:this.onContextMenu,forceHide:!l||!!this.state.contextMenuPosition,role:"treeitem","aria-expanded":!p,inputRef:this.buttonRef,onKeyDown:this.onKeyDown},C,a.a.createElement("div",{className:"mx_SpaceButton_selectionWrapper"},a.a.createElement(Oe.a,{width:w,height:w,room:i}),!l&&a.a.createElement("span",{className:"mx_SpaceButton_name"},i.name),S,this.renderContextMenu())),E)}}x()(Hs,"contextType",b.a);const $s=({spaces:e,activeSpaces:t,isNested:s,parents:n})=>a.a.createElement("ul",{className:"mx_SpaceTreeLevel"},e.map(e=>a.a.createElement(Hs,{key:e.roomId,activeSpaces:t,space:e,isNested:s,parents:n})));var zs=$s;const Ys=({space:e,className:t,selected:s,onClick:n,tooltip:i,notificationState:o,isNarrow:r,children:c})=>{const l=M()("mx_SpaceButton",t,{mx_SpaceButton_active:s,mx_SpaceButton_narrow:r});let d,u,h=a.a.createElement("div",{className:"mx_SpaceButton_avatarPlaceholder"},a.a.createElement("div",{className:"mx_SpaceButton_icon"}));return e&&(h=a.a.createElement(Oe.a,{width:32,height:32,room:e})),o&&(d=a.a.createElement("div",{className:"mx_SpacePanel_badgeContainer"},a.a.createElement(ve.a,{forceCount:!1,notification:o}))),u=r?a.a.createElement(ie.b,{className:l,title:i,onClick:n,role:"treeitem"},a.a.createElement("div",{className:"mx_SpaceButton_selectionWrapper"},h,d,c)):a.a.createElement(ie.a,{className:l,onClick:n,role:"treeitem"},a.a.createElement("div",{className:"mx_SpaceButton_selectionWrapper"},h,a.a.createElement("span",{className:"mx_SpaceButton_name"},i),d,c)),a.a.createElement("li",{className:M()({mx_SpaceItem:!0,collapsed:r})},u)},Js=a.a.memo(({children:e,isPanelCollapsed:t,setPanelCollapsed:s})=>{const[n,i,r]=(()=>{const[e,t]=Object(o.useState)(Ce.f.instance.invitedSpaces);Object(f.a)(Ce.f.instance,Ce.c,t);const[s,n]=Object(o.useState)(Ce.f.instance.spacePanelSpaces);Object(f.a)(Ce.f.instance,Ce.e,n);const[i,a]=Object(o.useState)(Ce.f.instance.activeSpace);return Object(f.a)(Ce.f.instance,Ce.d,a),[e,s,i]})(),l=r?[r]:[],d=V.b.getValue("feature_spaces.all_rooms")?_e.a.instance.globalState:Ce.f.instance.getNotificationState(Ce.a);return a.a.createElement("div",{className:"mx_SpaceTreeLevel"},a.a.createElement(Ys,{className:"mx_SpaceButton_home",onClick:()=>Ce.f.instance.setActiveSpace(null),selected:!r,tooltip:V.b.getValue("feature_spaces.all_rooms")?Object(c.a)("All rooms"):Object(c.a)("Home"),notificationState:d,isNarrow:t}),n.map(e=>a.a.createElement(Hs,{key:e.roomId,space:e,activeSpaces:l,isPanelCollapsed:t,onExpand:()=>s(!1)})),i.map((e,n)=>a.a.createElement(Cs.Draggable,{key:e.roomId,draggableId:e.roomId,index:n},(n,i)=>a.a.createElement(Hs,ue()({},n.draggableProps,n.dragHandleProps,{key:e.roomId,innerRef:n.innerRef,className:i.isDragging?"mx_SpaceItem_dragging":void 0,space:e,activeSpaces:l,isPanelCollapsed:t,onExpand:()=>s(!1)})))),e)});var Qs,Xs,Zs,en=()=>{const[e,t,s,r]=Object(i.q)(),[l,d]=Object(o.useState)(!0);Object(o.useEffect)(()=>{!l&&e&&r()},[l]);let u=null;e&&(u=a.a.createElement(Bs,{onFinished:r}));const h=(e,t)=>{let s,n=!1;do{const i=t?e.lastElementChild:e.firstElementChild,o=t?e.previousElementSibling:e.nextElementSibling;n?i?e=i:o?e=o:(n=!1,e=e.parentElement):o?(e=o,n=!0):e=e.parentElement,e&&(e.classList.contains("mx_ContextualMenu")&&(e=t?e.lastElementChild:e.firstElementChild,n=!0),s=e.classList)}while(e&&!s.contains("mx_SpaceButton"));e&&e.focus()},m=e?r:()=>{l||d(!0),s()};return a.a.createElement(Cs.DragDropContext,{onDragEnd:e=>{e.destination&&Ce.f.instance.moveRootSpace(e.source.index,e.destination.index)}},a.a.createElement(ie.c,{handleHomeEnd:!0,onKeyDown:e=>{let t=!0;switch(e.key){case gt.a.ARROW_UP:h(e.target,!0);break;case gt.a.ARROW_DOWN:h(e.target,!1);break;default:t=!1}t&&(e.stopPropagation(),e.preventDefault())}},({onKeyDownHandler:t})=>a.a.createElement("ul",{className:M()("mx_SpacePanel",{collapsed:l}),onKeyDown:t},a.a.createElement(Cs.Droppable,{droppableId:"top-level-spaces"},(t,s)=>a.a.createElement(n.a,ue()({},t.droppableProps,{wrappedRef:t.innerRef,className:"mx_SpacePanel_spaceTreeWrapper",style:s.isDraggingOver?{pointerEvents:"none"}:void 0}),a.a.createElement(Js,{isPanelCollapsed:l,setPanelCollapsed:d},t.placeholder),a.a.createElement(Ys,{className:M()("mx_SpaceButton_new",{mx_SpaceButton_newCancel:e}),tooltip:e?Object(c.a)("Cancel"):Object(c.a)("Create a space"),onClick:m,isNarrow:l}))),a.a.createElement(K.a,{className:M()("mx_SpacePanel_toggleCollapse",{expanded:!l}),onClick:()=>d(!l),title:l?Object(c.a)("Expand space panel"):Object(c.a)("Collapse space panel")}),u)))},tn=s(390),sn=s(0);class nn extends a.a.Component{constructor(...e){super(...e),x()(this,"element",Object(o.createRef)()),x()(this,"onAudioOutputChanged",e=>{const t=this.element.current;if(e)try{t.setSinkId(e)}catch(e){console.error("Couldn't set requested audio output device: using default",e),sn.a.warn("Couldn't set requested audio output device: using default",e)}}),x()(this,"onNewStream",()=>{this.playMedia()})}componentDidMount(){Vt.b.instance.addListener(Vt.a.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.addListener(tn.b.NewStream,this.onNewStream),this.playMedia()}componentWillUnmount(){Vt.b.instance.removeListener(Vt.a.AudioOutputChanged,this.onAudioOutputChanged),this.props.feed.removeListener(tn.b.NewStream,this.onNewStream),this.stopMedia()}playMedia(){const e=this.element.current;this.onAudioOutputChanged(Vt.b.getAudioOutput()),e.muted=!1,e.srcObject=this.props.feed.stream,e.autoplay=!0;try{e.play()}catch(e){sn.a.info("Failed to play media element with feed",this.props.feed,e)}}stopMedia(){const e=this.element.current;e.pause(),e.src=null}render(){return a.a.createElement("audio",{ref:this.element})}}class on extends a.a.Component{constructor(e){super(e),x()(this,"onFeedsChanged",()=>{this.setState({feeds:this.props.call.getRemoteFeeds()})}),this.state={feeds:[]}}componentDidMount(){this.props.call.addListener(is.c.FeedsChanged,this.onFeedsChanged)}componentWillUnmount(){this.props.call.removeListener(is.c.FeedsChanged,this.onFeedsChanged)}render(){return this.state.feeds.map((e,t)=>a.a.createElement(nn,{feed:e,key:t}))}}function an(e){return"INPUT"===e.tagName||"TEXTAREA"===e.tagName||"SELECT"===e.tagName||!!e.getAttribute("contenteditable")}var rn,cn,ln,dn=Object(P.a)("structures.LoggedInView")((Zs=Xs=class extends o.Component{constructor(e,t){super(e,t),x()(this,"_matrixClient",void 0),x()(this,"_roomView",void 0),x()(this,"_resizeContainer",void 0),x()(this,"compactLayoutWatcherRef",void 0),x()(this,"resizer",void 0),x()(this,"onCallsChanged",()=>{this.setState({activeCalls:De.e.sharedInstance().getAllActiveCalls()})}),x()(this,"canResetTimelineInRoom",e=>!this._roomView.current||this._roomView.current.canResetTimeline()),x()(this,"onAccountData",e=>{"m.ignored_user_list"===e.getType()&&u.a.dispatch({action:"ignore_state_changed"})}),x()(this,"onCompactLayoutChanged",(e,t,s,n,i)=>{this.setState({useCompactLayout:n})}),x()(this,"onSync",(e,t,s)=>{const n=this.state.syncErrorData&&this.state.syncErrorData.error&&this.state.syncErrorData.error.errcode,i=s&&s.error&&s.error.errcode;e===t&&n===i||("ERROR"===e?this.setState({syncErrorData:s}):this.setState({syncErrorData:null}),"PREPARED"===t&&"SYNCING"===e?this._updateServerNoticeEvents():this._calculateServerLimitToast(this.state.syncErrorData,this.state.usageLimitEventContent))}),x()(this,"onRoomStateEvents",(e,t)=>{const s=oe.b.instance.orderedLists[re.a.ServerNotice];s&&s.some(t=>t.roomId===e.getRoomId())&&this._updateServerNoticeEvents()}),x()(this,"onUsageLimitDismissed",()=>{this.setState({usageLimitDismissed:!0})}),x()(this,"_updateServerNoticeEvents",async()=>{const e=oe.b.instance.orderedLists[re.a.ServerNotice];if(!e)return[];const t=[];let s=0;for(const n of e){const e=n.currentState.getStateEvents("m.room.pinned_events","");if(!e||!e.getContent().pinned)continue;s=e.getTs();const i=e.getContent().pinned.slice(0,2);for(const e of i){const s=(await this._matrixClient.getEventTimeline(n.getUnfilteredTimelineSet(),e)).getEvents().find(t=>t.getId()===e);s&&t.push(s)}}if(s&&this.state.usageLimitEventTs>s)return;const n=t.find(e=>e&&"m.room.message"===e.getType()&&"m.server_notice.usage_limit_reached"===e.getContent().server_notice_type),i=n&&n.getContent();this._calculateServerLimitToast(this.state.syncErrorData,i),this.setState({usageLimitEventContent:i,usageLimitEventTs:s,usageLimitDismissed:!1})}),x()(this,"_onPaste",e=>{let t=!1,s=e.target;for(;!t&&s;)t=an(s),s=s.parentElement;t||u.a.fire(h.a.FocusComposer,!0)}),x()(this,"_onReactKeyDown",e=>{this._onKeyDown(e)}),x()(this,"_onNativeKeyDown",e=>{e.target===document.body&&this._onKeyDown(e)}),x()(this,"_onKeyDown",e=>{let t=!1;switch(Object(Mt.f)().getRoomAction(e)){case Mt.d.ScrollUp:case Mt.d.RoomScrollDown:case Mt.d.JumpToFirstMessage:case Mt.d.JumpToLatestMessage:this._onScrollKeyPressed(e),t=!0;break;case Mt.d.FocusSearch:u.a.dispatch({action:"focus_search"}),t=!0}if(t)return e.stopPropagation(),void e.preventDefault();switch(Object(Mt.f)().getNavigationAction(e)){case Mt.c.FocusRoomSearch:u.a.dispatch({action:"focus_room_filter"}),t=!0;break;case Mt.c.ToggleUserMenu:u.a.fire(h.a.ToggleUserMenu),t=!0;break;case Mt.c.ToggleShortCutDialog:Qt.f(),t=!0;break;case Mt.c.GoToHome:u.a.dispatch({action:"view_home_page"}),Le.a.closeCurrentModal("homeKeyboardShortcut"),t=!0;break;case Mt.c.ToggleRoomSidePanel:"room_view"!==this.props.page_type&&"group_view"!==this.props.page_type||(u.a.dispatch({action:h.a.ToggleRightPanel,type:"room_view"===this.props.page_type?"room":"group"}),t=!0);break;case Mt.c.SelectPrevRoom:u.a.dispatch({action:h.a.ViewRoomDelta,delta:-1,unread:!1}),t=!0;break;case Mt.c.SelectNextRoom:u.a.dispatch({action:h.a.ViewRoomDelta,delta:1,unread:!1}),t=!0;break;case Mt.c.SelectPrevUnreadRoom:u.a.dispatch({action:h.a.ViewRoomDelta,delta:-1,unread:!0});break;case Mt.c.SelectNextUnreadRoom:u.a.dispatch({action:h.a.ViewRoomDelta,delta:1,unread:!0});break;default:t=Xt.a.get().onKeyDown(e)}if(t)return e.stopPropagation(),void e.preventDefault();if(!(e.key===gt.a.ALT||e.key===gt.a.CONTROL||e.key===gt.a.META||e.key===gt.a.SHIFT||e.altKey||e.ctrlKey||e.metaKey)){const t=e.target!==document.body&&(e.key===gt.a.SPACE||e.key===gt.a.ENTER);if(e.key===gt.a.CONTEXT_MENU)return;t||e.key===gt.a.TAB||an(e.target)||(u.a.fire(h.a.FocusComposer,!0),e.stopPropagation())}}),x()(this,"_onScrollKeyPressed",e=>{this._roomView.current&&this._roomView.current.handleScrollKey(e)}),this.state={syncErrorData:void 0,useCompactLayout:V.b.getValue("useCompactLayout"),usageLimitDismissed:!1,activeCalls:[]},this._matrixClient=this.props.matrixClient,Vt.b.loadDevices(),Gt(),this._roomView=o.createRef(),this._resizeContainer=o.createRef()}componentDidMount(){document.addEventListener("keydown",this._onNativeKeyDown,!1),De.e.sharedInstance().addListener(De.b.CallsChanged,this.onCallsChanged),this._updateServerNoticeEvents(),this._matrixClient.on("accountData",this.onAccountData),this._matrixClient.on("sync",this.onSync),this.onSync(this._matrixClient.getSyncState(),null,this._matrixClient.getSyncStateData()),this._matrixClient.on("RoomState.events",this.onRoomStateEvents),this.compactLayoutWatcherRef=V.b.watchSetting("useCompactLayout",null,this.onCompactLayoutChanged),this.resizer=this._createResizer(),this.resizer.attach(),this._loadResizerPreferences()}componentWillUnmount(){document.removeEventListener("keydown",this._onNativeKeyDown,!1),De.e.sharedInstance().removeListener(De.b.CallsChanged,this.onCallsChanged),this._matrixClient.removeListener("accountData",this.onAccountData),this._matrixClient.removeListener("sync",this.onSync),this._matrixClient.removeListener("RoomState.events",this.onRoomStateEvents),V.b.unwatchSetting(this.compactLayoutWatcherRef),this.resizer.detach()}_createResizer(){let e,t;const s={toggleSize:156,onCollapsed:e=>{t=e,e?(u.a.dispatch({action:"hide_left_panel"}),window.localStorage.setItem("mx_lhs_size","0")):u.a.dispatch({action:"show_left_panel"})},onResized:t=>{e=t,this.props.resizeNotifier.notifyLeftHandleResized()},onResizeStart:()=>{this.props.resizeNotifier.startResizing()},onResizeStop:()=>{t||window.localStorage.setItem("mx_lhs_size",""+e),this.props.resizeNotifier.stopResizing()},isItemCollapsed:e=>e.classList.contains("mx_LeftPanel_minimized")},n=new Jt.a(this._resizeContainer.current,Yt,s);return n.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle_vertical",reverse:"mx_ResizeHandle_reverse"}),n}_loadResizerPreferences(){let e=parseInt(window.localStorage.getItem("mx_lhs_size"),10);isNaN(e)&&(e=350),this.resizer.forHandleAt(0).resize(e)}_calculateServerLimitToast(e,t){const s=e&&e.error&&"M_RESOURCE_LIMIT_EXCEEDED"===e.error.errcode;s&&(t=e.error.data),t&&this.state.usageLimitDismissed?((e,t,s,n)=>{const i=Object(ts.a)(e,s,{monthly_active_user:Object(c.b)("Your homeserver has exceeded its user limit."),hs_blocked:Object(c.b)("This homeserver has been blocked by it's administrator."),"":Object(c.b)("Your homeserver has exceeded one of its resource limits.")}),o=Object(ts.a)(e,s,{"":Object(c.b)("Contact your <a>server admin</a>.")});es.a.sharedInstance().addOrReplaceToast({key:"serverlimit",title:Object(c.a)("Warning"),props:{description:a.a.createElement(a.a.Fragment,null,i," ",o),acceptLabel:Object(c.a)("Ok"),onAccept:()=>{ss(),t&&t()}},component:Zt.a,priority:70})})(t.limit_type,this.onUsageLimitDismissed,t.admin_contact):ss()}render(){const e=d.getComponent("structures.RoomView"),t=d.getComponent("structures.UserView"),s=d.getComponent("structures.GroupView"),n=d.getComponent("structures.MyGroups"),i=d.getComponent("structures.ToastContainer");let a;switch(this.props.page_type){case Bt.a.RoomView:a=o.createElement(e,{ref:this._roomView,onRegistered:this.props.onRegistered,threepidInvite:this.props.threepidInvite,oobData:this.props.roomOobData,key:this.props.currentRoomId||"roomview",resizeNotifier:this.props.resizeNotifier,justCreatedOpts:this.props.roomJustCreatedOpts});break;case Bt.a.MyGroups:a=o.createElement(n,null);break;case Bt.a.RoomDirectory:break;case Bt.a.HomePage:a=o.createElement(R,{justRegistered:this.props.justRegistered});break;case Bt.a.UserView:a=o.createElement(t,{userId:this.props.currentUserId,resizeNotifier:this.props.resizeNotifier});break;case Bt.a.GroupView:a=o.createElement(s,{groupId:this.props.currentGroupId,isNew:this.props.currentGroupIsNew,resizeNotifier:this.props.resizeNotifier})}let r="mx_MatrixChat";this.state.useCompactLayout&&(r+=" mx_MatrixChat_useCompactLayout");const c=this.state.activeCalls.map(e=>o.createElement(on,{call:e,key:e.callId}));return o.createElement(b.a.Provider,{value:this._matrixClient},o.createElement("div",{onPaste:this._onPaste,onKeyDown:this._onReactKeyDown,className:"mx_MatrixChat_wrapper","aria-hidden":this.props.hideToSRUsers},o.createElement(i,null),o.createElement("div",{ref:this._resizeContainer,className:r},V.b.getValue("feature_spaces")?o.createElement(en,null):null,o.createElement(Lt,{isMinimized:this.props.collapseLhs||!1,resizeNotifier:this.props.resizeNotifier}),o.createElement(qt.a,null),a)),o.createElement(gs,null),o.createElement(bs,null),o.createElement(ws,null),c)}},x()(Xs,"displayName","LoggedInView"),x()(Xs,"propTypes",{matrixClient:St.instanceOf(Ft.b).isRequired,page_type:St.string.isRequired,onRoomCreated:St.func,onRegistered:St.func}),Qs=Zs))||Qs,un=s(742),hn=s(667),mn=s(331),pn=s(134);function gn(e,t){if(!t)return null;for(const s of Object.keys(e))if(e[s].instances||!(e[s].instances instanceof Array))for(const n of e[s].instances)if(n.instance_id==t)return n}function vn(e,t){if(!t)return null;for(const s of Object.keys(e))if(e[s].instances||!(e[s].instances instanceof Array))for(const n of e[s].instances)if(n.instance_id==t)return s}let fn=Object(P.a)("views.dialogs.TextInputDialog")((ln=cn=class extends a.a.Component{constructor(e){super(e),x()(this,"onOk",async e=>{if(e.preventDefault(),this.props.validator&&(this.setState({busy:!0}),await this._field.current.validate({allowEmpty:!1}),!this._field.current.state.valid))return this._field.current.focus(),this._field.current.validate({allowEmpty:!1,focused:!0}),void this.setState({busy:!1});this.props.onFinished(!0,this.state.value)}),x()(this,"onCancel",()=>{this.props.onFinished(!1)}),x()(this,"onChange",e=>{this.setState({value:e.target.value})}),x()(this,"onValidate",async e=>{const t=await this.props.validator(e);return this.setState({valid:t.valid}),t}),this._field=Object(o.createRef)(),this.state={value:this.props.value,busy:!1,valid:!1}}componentDidMount(){this.props.focus&&this._field.current.focus()}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return a.a.createElement(e,{className:"mx_TextInputDialog",onFinished:this.props.onFinished,title:this.props.title,fixedWidth:this.props.fixedWidth},a.a.createElement("form",{onSubmit:this.onOk},a.a.createElement("div",{className:"mx_Dialog_content"},a.a.createElement("div",{className:"mx_TextInputDialog_label"},a.a.createElement("label",{htmlFor:"textinput"}," ",this.props.description," ")),a.a.createElement("div",null,a.a.createElement(Ue.a,{className:"mx_TextInputDialog_input",ref:this._field,type:"text",label:this.props.placeholder,value:this.state.value,onChange:this.onChange,onValidate:this.props.validator?this.onValidate:void 0,size:"64"})))),a.a.createElement(t,{primaryButton:this.state.busy?Object(c.a)(this.props.busyMessage):this.props.button,disabled:this.state.busy,onPrimaryButtonClick:this.onOk,onCancel:this.onCancel,hasCancel:this.props.hasCancel}))}},x()(cn,"propTypes",{title:wt.a.string,description:wt.a.oneOfType([wt.a.element,wt.a.string]),value:wt.a.string,placeholder:wt.a.string,button:wt.a.string,busyMessage:wt.a.string,focus:wt.a.bool,onFinished:wt.a.func.isRequired,hasCancel:wt.a.bool,validator:wt.a.func,fixedWidth:wt.a.bool}),x()(cn,"defaultProps",{title:"",value:"",description:"",busyMessage:Object(c.b)("Loading..."),focus:!0,hasCancel:!0}),rn=ln))||rn;var bn=s(142);const yn=Symbol("ALL_ROOMS"),_n=Object(Ts.a)({deriveData:async({value:e})=>{try{return await le.a.get().publicRooms({limit:1,server:e}),{}}catch(e){return{error:e}}},rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>Object(c.a)("Enter a server name")},{key:"available",final:!0,test:async(e,{error:t})=>!t,valid:()=>Object(c.a)("Looks good"),invalid:({error:e})=>"M_FORBIDDEN"===e.errcode?Object(c.a)("You are not allowed to view this server's rooms list"):Object(c.a)("Can't find this server or its room list")}]});var En,Sn=({onOptionChange:e,protocols:t={},selectedServerName:s,selectedInstanceId:n})=>{const[r,d,u,h]=Object(i.q)(),m=Object(Nt.b)("room_directory_servers"),[p,g]=Object(o.useState)(m),v=(t,s)=>()=>{e(t,s),h()},f=e=>{g(e),V.b.setValue("room_directory_servers",null,Ye.a.ACCOUNT,e)};let b;if(Object(o.useEffect)(()=>{g(m)},[m]),r){const o=l.a.get().roomDirectory||{},r=le.a.getHomeserverName(),u=new Set(o.servers),m=new Set(p.filter(e=>!u.has(e)&&e!==r)),g=[r,...Array.from(u).filter(e=>e!==r).sort(),...Array.from(m).sort()],_=g.map(o=>{const l=o===s,d=[],u=o===r?Object.values(t):[];let p,b;if(u.length>0&&u.push({instances:[{fields:[],network_id:"",instance_id:yn,desc:Object(c.a)("All rooms")}],location_fields:[],user_fields:[],field_types:{},icon:""}),u.forEach(({instances:e=[]})=>{[...e].sort((e,t)=>Object(bn.a)(t.desc,e.desc)).forEach(({desc:e,instance_id:t})=>{d.push(a.a.createElement(i.h,{key:String(t),active:l&&t===n,onClick:v(o,t),label:e,className:"mx_NetworkDropdown_server_network"},e))})}),o===r&&(p=a.a.createElement("div",{className:"mx_NetworkDropdown_server_subtitle"},Object(c.a)("Your server"))),m.has(o)){const t=async()=>{h();const{finished:t}=Le.a.createTrackedDialog("Network Dropdown","Remove server",Me.a,{title:Object(c.a)("Are you sure?"),description:Object(c.a)("Are you sure you want to remove <b>%(serverName)s</b>",{serverName:o},{b:e=>a.a.createElement("b",null,e)}),button:Object(c.a)("Remove"),fixedWidth:!1},"mx_NetworkDropdown_dialog"),[s]=await t;s&&(f(g.filter(e=>e!==o)),l&&e(r,void 0))};b=a.a.createElement(i.f,{onClick:t,label:Object(c.a)("Remove server")})}return a.a.createElement(i.e,{label:o,className:"mx_NetworkDropdown_server",key:o},a.a.createElement("div",{className:"mx_NetworkDropdown_server_title"},o,b),p,a.a.createElement(i.h,{active:l&&!n,onClick:v(o,void 0),label:Object(c.a)("Matrix"),className:"mx_NetworkDropdown_server_network"},Object(c.a)("Matrix")),d)}),E=async()=>{h();const{finished:t}=Le.a.createTrackedDialog("Network Dropdown","Add a new server",fn,{title:Object(c.a)("Add a new server"),description:Object(c.a)("Enter the name of a new server you want to explore."),button:Object(c.a)("Add"),hasCancel:!1,placeholder:Object(c.a)("Server name"),validator:_n,fixedWidth:!1},"mx_NetworkDropdown_dialog"),[s,n]=await t;s&&(p.includes(n)||f([...p,n]),e(n))},S=d.current.getBoundingClientRect();b=a.a.createElement(i.b,ue()({},(y=S,{right:Pt.b.instance.windowWidth-y.right,top:y.top,chevronOffset:0,chevronFace:i.a.None}),{onFinished:h}),a.a.createElement("div",{className:"mx_NetworkDropdown_menu"},_,a.a.createElement(i.f,{className:"mx_NetworkDropdown_server_add",label:void 0,onClick:E},Object(c.a)("Add a new server..."))))}else{let e;if(n===yn)e=Object(c.a)("All rooms");else if(n){const s=gn(t,n);e=Object(c.a)("%(networkName)s rooms",{networkName:s.desc})}else e=Object(c.a)("Matrix rooms");b=a.a.createElement(i.c,{className:"mx_NetworkDropdown_handle",onClick:u,isExpanded:r},a.a.createElement("span",null,e)," ",a.a.createElement("span",{className:"mx_NetworkDropdown_handle_server"},"(",s,")"))}var y;return a.a.createElement("div",{className:"mx_NetworkDropdown",ref:d},b)},wn=s(128);let Cn=Object(P.a)("views.elements.DirectorySearchBox")(En=class extends a.a.Component{constructor(e){super(e),this._collectInput=this._collectInput.bind(this),this._onClearClick=this._onClearClick.bind(this),this._onChange=this._onChange.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._onJoinButtonClick=this._onJoinButtonClick.bind(this),this.input=null,this.state={value:this.props.initialText||""}}_collectInput(e){this.input=e}_onClearClick(){this.setState({value:""}),this.input&&(this.input.focus(),this.props.onClear&&this.props.onClear())}_onChange(e){this.input&&(this.setState({value:e.target.value}),this.props.onChange&&this.props.onChange(e.target.value))}_onKeyUp(e){"Enter"==e.key&&this.props.showJoinButton&&this.props.onJoinClick&&this.props.onJoinClick(this.state.value)}_onJoinButtonClick(){this.props.onJoinClick&&this.props.onJoinClick(this.state.value)}render(){const e=d.getComponent("elements.AccessibleButton");let t;return{mx_DirectorySearchBox:!0}[this.props.className]=!0,this.props.showJoinButton&&(t=a.a.createElement(e,{className:"mx_DirectorySearchBox_joinButton",onClick:this._onJoinButtonClick},Object(c.a)("Join"))),a.a.createElement("div",{className:`mx_DirectorySearchBox ${this.props.className} mx_textinput`},a.a.createElement("input",{type:"text",name:"dirsearch",value:this.state.value,className:"mx_textinput_icon mx_textinput_search",ref:this._collectInput,onChange:this._onChange,onKeyUp:this._onKeyUp,placeholder:this.props.placeholder,autoFocus:!0}),t,a.a.createElement(e,{className:"mx_DirectorySearchBox_clear",onClick:this._onClearClick}))}})||En;Cn.propTypes={className:wt.a.string,onChange:wt.a.func,onClear:wt.a.func,onJoinClick:wt.a.func,placeholder:wt.a.string,showJoinButton:wt.a.bool,initialText:wt.a.string};var kn,On=s(466),Rn=s(119);function In(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function xn(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?In(Object(s),!0).forEach((function(t){x()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):In(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function Tn(e){_.a.trackEvent("RoomDirectory",e)}let jn=Object(P.a)("structures.RoomDirectory")(kn=class extends a.a.Component{constructor(e){super(e),x()(this,"startTime",void 0),x()(this,"unmounted",!1),x()(this,"nextBatch",null),x()(this,"filterTimeout",void 0),x()(this,"protocols",void 0),x()(this,"refreshRoomList",()=>{this.state.selectedCommunityId?this.setState({publicRooms:wn.a.getGroupRooms(this.state.selectedCommunityId).map(e=>({room_id:e.roomId,name:e.name,topic:e.topic,canonical_alias:e.canonicalAlias,num_joined_members:e.numJoinedMembers,avatarUrl:e.avatarUrl,world_readable:e.worldReadable,guest_can_join:e.guestsCanJoin})).filter(e=>{const t=this.state.filterString;if(t){const s=e=>(e||"").toLowerCase().includes(t.toLowerCase());return s(e.name)||s(e.topic)||s(e.canonical_alias)}return!0}),loading:!1}):(this.nextBatch=null,this.setState({publicRooms:[],loading:!0}),this.getMoreRooms())}),x()(this,"onRoomClicked",(e,t)=>{t.shiftKey&&!this.state.selectedCommunityId&&(t.preventDefault(),this.removeFromDirectory(e))}),x()(this,"onOptionChange",(e,t)=>{this.nextBatch=null,this.setState({publicRooms:[],roomServer:e,instanceId:t,error:null},this.refreshRoomList)}),x()(this,"onFillRequest",e=>e||!this.nextBatch?Promise.resolve(!1):this.getMoreRooms()),x()(this,"onFilterChange",e=>{this.setState({filterString:e||null}),this.filterTimeout&&clearTimeout(this.filterTimeout),this.filterTimeout=setTimeout(()=>{this.filterTimeout=null,this.refreshRoomList()},700)}),x()(this,"onFilterClear",()=>{this.setState({filterString:null},this.refreshRoomList),this.filterTimeout&&clearTimeout(this.filterTimeout)}),x()(this,"onJoinFromSearchClick",e=>{if(this.state.instanceId&&this.state.instanceId!==yn){const t=vn(this.protocols,this.state.instanceId),s=gn(this.protocols,this.state.instanceId),n=t?this.getFieldsForThirdPartyLocation(e,this.protocols[t],s):null;if(!n){const e=l.a.get().brand;return void Le.a.createTrackedDialog("Unable to join network","",Xe.a,{title:Object(c.a)("Unable to join network"),description:Object(c.a)("%(brand)s does not know how to join a room on this network",{brand:e})})}le.a.get().getThirdpartyLocation(t,n).then(e=>{e.length>0&&e[0].alias?this.showRoomAlias(e[0].alias,!0):Le.a.createTrackedDialog("Room not found","",Xe.a,{title:Object(c.a)("Room not found"),description:Object(c.a)("Couldn't find a matching Matrix room")})},e=>{Le.a.createTrackedDialog("Fetching third party location failed","",Xe.a,{title:Object(c.a)("Fetching third party location failed"),description:Object(c.a)("Unable to look up room ID from server")})})}else-1==e.indexOf(":")&&(e=e+":"+this.state.roomServer),this.showRoomAlias(e,!0)}),x()(this,"onPreviewClick",(e,t)=>{this.showRoom(t,null,!1,!0),e.stopPropagation()}),x()(this,"onViewClick",(e,t)=>{this.showRoom(t),e.stopPropagation()}),x()(this,"onJoinClick",(e,t)=>{this.showRoom(t,null,!0),e.stopPropagation()}),x()(this,"onCreateRoomClick",()=>{this.onFinished(),u.a.dispatch({action:"view_create_room",public:!0,defaultName:this.state.filterString.trim()})}),x()(this,"onFinished",()=>{E.a.instance.trackRoomDirectory(this.startTime),this.props.onFinished(!1)}),E.a.instance.trackRoomDirectoryBegin(),this.startTime=E.a.getTimestamp();const t=V.b.getValue("feature_communities_v2_prototypes")?U.a.getSelectedTags()[0]:null;let s=!0;le.a.get()?t?(s=!1,et.a.getGroupProfileCached(le.a.get(),this.state.selectedCommunityId).then(e=>{this.setState({communityName:e.name})})):le.a.get().getThirdpartyProtocols().then(e=>{this.protocols=e,this.setState({protocolsLoading:!1})},e=>{if(console.warn("error loading third party protocols: "+e),this.setState({protocolsLoading:!1}),le.a.get().isGuest())return;Tn("Failed to get protocol list from homeserver");const t=l.a.get().brand;this.setState({error:Object(c.a)("%(brand)s failed to get the protocol list from the homeserver. The homeserver may be too old to support third party networks.",{brand:t})})}):s=!1,this.state={publicRooms:[],loading:!0,error:null,instanceId:void 0,roomServer:le.a.getHomeserverName(),filterString:this.props.initialText||"",selectedCommunityId:t,communityName:null,protocolsLoading:s}}componentDidMount(){this.refreshRoomList()}componentWillUnmount(){this.filterTimeout&&clearTimeout(this.filterTimeout),this.unmounted=!0}getMoreRooms(){if(this.state.selectedCommunityId)return Promise.resolve();if(!le.a.get())return Promise.resolve();this.setState({loading:!0});const e=this.state.filterString,t=this.state.roomServer,s=this.nextBatch,n={limit:20};return t!=le.a.getHomeserverName()&&(n.server=t),this.state.instanceId===yn?n.include_all_networks=!0:this.state.instanceId&&(n.third_party_instance_id=this.state.instanceId),this.nextBatch&&(n.since=this.nextBatch),e&&(n.filter={generic_search_term:e}),le.a.get().publicRooms(n).then(n=>{if(e==this.state.filterString&&t==this.state.roomServer&&s==this.nextBatch&&!this.unmounted){if(this.state.filterString){const e=n.total_room_count_estimate||n.chunk.length;E.a.instance.trackRoomDirectorySearch(e,this.state.filterString)}return this.nextBatch=n.next_batch,this.setState(e=>xn(xn({},e),{},{publicRooms:[...e.publicRooms,...n.chunk||[]],loading:!1})),Boolean(n.next_batch)}},n=>{if(e!=this.state.filterString||t!=this.state.roomServer||s!=this.nextBatch)return;if(this.unmounted)return;console.error("Failed to get publicRooms: %s",JSON.stringify(n)),Tn("Failed to get public room list");const i=l.a.get().brand;this.setState({loading:!1,error:Object(c.a)("%(brand)s failed to get the public room list.",{brand:i})+(n&&n.message)?n.message:Object(c.a)("The homeserver may be unavailable or overloaded.")})})}removeFromDirectory(e){const t=Nn(e),s=e.name||t||Object(c.a)("Unnamed room");let n;n=t?Object(c.a)("Delete the room address %(alias)s and remove %(name)s from the directory?",{alias:t,name:s}):Object(c.a)("Remove %(name)s from the directory?",{name:s}),Le.a.createTrackedDialog("Remove from Directory","",Me.a,{title:Object(c.a)("Remove from Directory"),description:n,onFinished:n=>{if(!n)return;const i=Le.a.createDialog(Rn.a);let o=Object(c.a)("remove %(name)s from the directory.",{name:s});le.a.get().setRoomDirectoryVisibility(e.room_id,"private").then(()=>{if(t)return o=Object(c.a)("delete the address."),le.a.get().deleteAlias(t)}).then(()=>{i.close(),this.refreshRoomList()},e=>{i.close(),this.refreshRoomList(),console.error("Failed to "+o+": "+e),Le.a.createTrackedDialog("Remove from Directory Error","",Xe.a,{title:Object(c.a)("Error"),description:e&&e.message?e.message:Object(c.a)("The server may be unavailable or overloaded")})})}})}showRoomAlias(e,t=!1){this.showRoom(null,e,t)}showRoom(e,t,s=!1,n=!1){this.onFinished();const i={action:"view_room",auto_join:s,should_peek:n,_type:"room_directory"};if(e){if(le.a.get().isGuest()&&!e.world_readable&&!e.guest_can_join)return void u.a.dispatch({action:"require_registration"});t||(t=Nn(e)),i.oob_data={avatarUrl:e.avatar_url,name:e.name||t||Object(c.a)("Unnamed room")},this.state.roomServer&&(i.via_servers=[this.state.roomServer],i.opts={viaServers:[this.state.roomServer]})}t?i.room_alias=t:i.room_id=e.room_id,u.a.dispatch(i)}createRoomCells(e){const t=le.a.get(),s=t.getRoom(e.room_id),n=s&&"join"===s.getMyMembership(),i=t.isGuest();let o,r;n||!e.world_readable&&!i||(o=a.a.createElement(g.a,{kind:"secondary",onClick:t=>this.onPreviewClick(t,e)},Object(c.a)("Preview"))),n?r=a.a.createElement(g.a,{kind:"secondary",onClick:t=>this.onViewClick(t,e)},Object(c.a)("View")):i||(r=a.a.createElement(g.a,{kind:"primary",onClick:t=>this.onJoinClick(t,e)},Object(c.a)("Join")));let l=e.name||Nn(e)||Object(c.a)("Unnamed room");l.length>80&&(l=l.substring(0,80)+"...");let d=e.topic||"";d.length>800&&(d=d.substring(0,800)+"..."),d=Object(pn.f)(d);let u=null;return e.avatar_url&&(u=Object(pe.b)(e.avatar_url).getSquareThumbnailHttp(32)),[a.a.createElement("div",{key:e.room_id+"_avatar",onMouseDown:t=>this.onRoomClicked(e,t),className:"mx_RoomDirectory_roomAvatar"},a.a.createElement(m.a,{width:32,height:32,resizeMethod:"crop",name:l,idName:l,url:u})),a.a.createElement("div",{key:e.room_id+"_description",onMouseDown:t=>this.onRoomClicked(e,t),className:"mx_RoomDirectory_roomDescription"},a.a.createElement("div",{className:"mx_RoomDirectory_name",onMouseDown:t=>this.onRoomClicked(e,t)},l)," ",a.a.createElement("div",{className:"mx_RoomDirectory_topic",onMouseDown:t=>this.onRoomClicked(e,t),dangerouslySetInnerHTML:{__html:d}}),a.a.createElement("div",{className:"mx_RoomDirectory_alias",onMouseDown:t=>this.onRoomClicked(e,t)},Nn(e))),a.a.createElement("div",{key:e.room_id+"_memberCount",onMouseDown:t=>this.onRoomClicked(e,t),className:"mx_RoomDirectory_roomMemberCount"},e.num_joined_members),a.a.createElement("div",{key:e.room_id+"_preview",onMouseDown:t=>this.onRoomClicked(e,t),className:"mx_RoomDirectory_preview"},o),a.a.createElement("div",{key:e.room_id+"_join",onMouseDown:t=>this.onRoomClicked(e,t),className:"mx_RoomDirectory_join"},r)]}stringLooksLikeId(e,t){let s=/^#[^\s]+:[^\s]/;return t&&t.regexp&&(s=new RegExp(t.regexp)),s.test(e)}getFieldsForThirdPartyLocation(e,t,s){const n=t.location_fields;if(!n)return null;const i={};for(let e=0;e<n.length-1;++e){const t=n[e];if(void 0===s.fields[t])return null;i[t]=s.fields[t]}return i[n[n.length-1]]=e,i}render(){let e,t;if(this.state.error)e=this.state.error;else if(this.state.protocolsLoading)e=a.a.createElement(Rn.a,null);else{const t=(this.state.publicRooms||[]).reduce((e,t)=>e.concat(this.createRoomCells(t)),[]);let s;this.state.loading&&(s=a.a.createElement(Rn.a,null));const n=a.a.createElement(a.a.Fragment,null,a.a.createElement("hr",null),a.a.createElement(g.a,{kind:"primary",onClick:this.onCreateRoomClick,className:"mx_RoomDirectory_newRoom"},Object(c.a)("Create new room")));let i,o;0!==t.length||this.state.loading?(i=a.a.createElement("div",{className:"mx_RoomDirectory_table"},t),this.state.loading||this.nextBatch||(o=n)):o=a.a.createElement(a.a.Fragment,null,a.a.createElement("h5",null,Object(c.a)('No results for "%(query)s"',{query:this.state.filterString.trim()})),a.a.createElement("p",null,Object(c.a)("Try different words or check for typos. Some results may not be visible as they're private and you need an invite to join them.")),n),e=a.a.createElement(On.a,{className:"mx_RoomDirectory_tableWrapper",onFillRequest:this.onFillRequest,stickyBottom:!1,startAtBottom:!1},i,s,o&&a.a.createElement("div",{className:"mx_RoomDirectory_footer"},o))}if(!this.state.protocolsLoading){const e=vn(this.protocols,this.state.instanceId);let s;if(e&&this.protocols&&this.protocols[e]&&this.protocols[e].location_fields.length>0&&this.protocols[e].field_types){const t=this.protocols[e].location_fields.slice(-1)[0];s=this.protocols[e].field_types[t]}let n=Object(c.a)("Find a room…");this.state.instanceId&&this.state.instanceId!==yn?s&&(n=s.placeholder):n=Object(c.a)("Find a room… (e.g. %(exampleRoom)s)",{exampleRoom:"#example:"+this.state.roomServer});let i=this.stringLooksLikeId(this.state.filterString,s);if(e){const t=gn(this.protocols,this.state.instanceId);null===this.getFieldsForThirdPartyLocation(this.state.filterString,this.protocols[e],t)&&(i=!1)}let o=a.a.createElement(Sn,{protocols:this.protocols,onOptionChange:this.onOptionChange,selectedServerName:this.state.roomServer,selectedInstanceId:this.state.instanceId});this.state.selectedCommunityId&&(o=null),t=a.a.createElement("div",{className:"mx_RoomDirectory_listheader"},a.a.createElement(Cn,{className:"mx_RoomDirectory_searchbox",onChange:this.onFilterChange,onClear:this.onFilterClear,onJoinClick:this.onJoinFromSearchClick,placeholder:n,showJoinButton:i,initialText:this.props.initialText}),o)}const s=Object(c.a)("If you can't find the room you're looking for, ask for an invite or <a>Create a new room</a>.",null,{a:e=>a.a.createElement(g.a,{kind:"secondary",onClick:this.onCreateRoomClick},e)}),n=this.state.selectedCommunityId?Object(c.a)("Explore rooms in %(communityName)s",{communityName:this.state.communityName||this.state.selectedCommunityId}):Object(c.a)("Explore rooms");return a.a.createElement(Ze.a,{className:"mx_RoomDirectory_dialog",hasCancel:!0,onFinished:this.onFinished,title:n},a.a.createElement("div",{className:"mx_RoomDirectory"},s,a.a.createElement("div",{className:"mx_RoomDirectory_list"},t,e)))}})||kn;function Nn(e){var t;return e.canonical_alias||(null===(t=e.aliases)||void 0===t?void 0:t[0])||""}var Pn,Dn=s(1262),An=s(668),Mn=s(326);let Un=Object(P.a)("structures.ToastContainer")(Pn=class extends o.Component{constructor(e,t){super(e,t),x()(this,"_onToastStoreUpdate",()=>{this.setState({toasts:es.a.sharedInstance().getToasts(),countSeen:es.a.sharedInstance().getCountSeen()})}),this.state={toasts:es.a.sharedInstance().getToasts(),countSeen:es.a.sharedInstance().getCountSeen()},es.a.sharedInstance().on("update",this._onToastStoreUpdate)}componentWillUnmount(){es.a.sharedInstance().removeListener("update",this._onToastStoreUpdate)}render(){const e=this.state.toasts.length,t=e>1;let s,n;if(0!==e){const i=this.state.toasts[0],{title:a,icon:r,key:c,component:l,className:d,props:u}=i,h=M()("mx_Toast_toast",{mx_Toast_hasIcon:r,["mx_Toast_icon_"+r]:r},d);let m;(t||this.state.countSeen>0)&&(m=` (${this.state.countSeen+1}/${this.state.countSeen+e})`);const p=Object.assign({},u,{key:c,toastKey:c});s=o.createElement("div",{className:h},o.createElement("div",{className:"mx_Toast_title"},o.createElement("h2",null,a),o.createElement("span",null,m)),o.createElement("div",{className:"mx_Toast_body"},o.createElement(l,p))),n=M()("mx_ToastContainer",{mx_ToastContainer_stacked:t})}return s?o.createElement("div",{className:n,role:"alert"},s):null}})||Pn;var Ln,Fn=s(256),Bn=s(342),Vn=s.n(Bn),Kn=s(447);let Wn=Object(P.a)("structures.UploadBar")(Ln=class extends a.a.Component{constructor(e){super(e),x()(this,"dispatcherRef",void 0),x()(this,"mounted",void 0),x()(this,"onAction",e=>{switch(e.action){case h.a.UploadStarted:case h.a.UploadProgress:case h.a.UploadFinished:case h.a.UploadCanceled:case h.a.UploadFailed:{if(!this.mounted)return;const e=this.getUploadsInRoom();this.setState({currentUpload:e[0],uploadsHere:e});break}}}),x()(this,"onCancelClick",e=>{e.preventDefault(),Fn.a.sharedInstance().cancelUpload(this.state.currentUpload.promise)});const t=this.getUploadsInRoom();this.state={currentUpload:t[0],uploadsHere:t}}componentDidMount(){this.dispatcherRef=u.a.register(this.onAction),this.mounted=!0}componentWillUnmount(){this.mounted=!1,u.a.unregister(this.dispatcherRef)}getUploadsInRoom(){return Fn.a.sharedInstance().getCurrentUploads().filter(e=>e.roomId===this.props.room.roomId)}render(){if(!this.state.currentUpload)return null;const e=Object(c.a)("Uploading %(filename)s and %(count)s others",{filename:this.state.currentUpload.fileName,count:this.state.uploadsHere.length-1}),t=Vn()(this.state.currentUpload.total);return a.a.createElement("div",{className:"mx_UploadBar"},a.a.createElement("div",{className:"mx_UploadBar_filename"},e," (",t,")"),a.a.createElement(g.a,{onClick:this.onCancelClick,className:"mx_UploadBar_cancel"}),a.a.createElement(Kn.a,{value:this.state.currentUpload.loaded,max:this.state.currentUpload.total}))}})||Ln;var Gn,qn=s(288),Hn=s(258);let $n=Object(P.a)("views.auth.AuthPage")(Gn=class extends a.a.PureComponent{render(){const e=d.getComponent("auth.AuthFooter");return a.a.createElement("div",{className:"mx_AuthPage"},a.a.createElement("div",{className:"mx_AuthPage_modal"},this.props.children),a.a.createElement(e,null))}})||Gn;var zn=s(198);const Yn=/^[0-9 -.]+$/;const Jn=127462-"A".charCodeAt(0),Qn=/^[A-Z]{2}$/,Xn=[{iso2:"GB",name:Object(c.b)("United Kingdom"),prefix:"44"},{iso2:"US",name:Object(c.b)("United States"),prefix:"1"},{iso2:"AF",name:Object(c.b)("Afghanistan"),prefix:"93"},{iso2:"AX",name:Object(c.b)("Åland Islands"),prefix:"358"},{iso2:"AL",name:Object(c.b)("Albania"),prefix:"355"},{iso2:"DZ",name:Object(c.b)("Algeria"),prefix:"213"},{iso2:"AS",name:Object(c.b)("American Samoa"),prefix:"1"},{iso2:"AD",name:Object(c.b)("Andorra"),prefix:"376"},{iso2:"AO",name:Object(c.b)("Angola"),prefix:"244"},{iso2:"AI",name:Object(c.b)("Anguilla"),prefix:"1"},{iso2:"AQ",name:Object(c.b)("Antarctica"),prefix:"672"},{iso2:"AG",name:Object(c.b)("Antigua & Barbuda"),prefix:"1"},{iso2:"AR",name:Object(c.b)("Argentina"),prefix:"54"},{iso2:"AM",name:Object(c.b)("Armenia"),prefix:"374"},{iso2:"AW",name:Object(c.b)("Aruba"),prefix:"297"},{iso2:"AU",name:Object(c.b)("Australia"),prefix:"61"},{iso2:"AT",name:Object(c.b)("Austria"),prefix:"43"},{iso2:"AZ",name:Object(c.b)("Azerbaijan"),prefix:"994"},{iso2:"BS",name:Object(c.b)("Bahamas"),prefix:"1"},{iso2:"BH",name:Object(c.b)("Bahrain"),prefix:"973"},{iso2:"BD",name:Object(c.b)("Bangladesh"),prefix:"880"},{iso2:"BB",name:Object(c.b)("Barbados"),prefix:"1"},{iso2:"BY",name:Object(c.b)("Belarus"),prefix:"375"},{iso2:"BE",name:Object(c.b)("Belgium"),prefix:"32"},{iso2:"BZ",name:Object(c.b)("Belize"),prefix:"501"},{iso2:"BJ",name:Object(c.b)("Benin"),prefix:"229"},{iso2:"BM",name:Object(c.b)("Bermuda"),prefix:"1"},{iso2:"BT",name:Object(c.b)("Bhutan"),prefix:"975"},{iso2:"BO",name:Object(c.b)("Bolivia"),prefix:"591"},{iso2:"BA",name:Object(c.b)("Bosnia"),prefix:"387"},{iso2:"BW",name:Object(c.b)("Botswana"),prefix:"267"},{iso2:"BV",name:Object(c.b)("Bouvet Island"),prefix:"47"},{iso2:"BR",name:Object(c.b)("Brazil"),prefix:"55"},{iso2:"IO",name:Object(c.b)("British Indian Ocean Territory"),prefix:"246"},{iso2:"VG",name:Object(c.b)("British Virgin Islands"),prefix:"1"},{iso2:"BN",name:Object(c.b)("Brunei"),prefix:"673"},{iso2:"BG",name:Object(c.b)("Bulgaria"),prefix:"359"},{iso2:"BF",name:Object(c.b)("Burkina Faso"),prefix:"226"},{iso2:"BI",name:Object(c.b)("Burundi"),prefix:"257"},{iso2:"KH",name:Object(c.b)("Cambodia"),prefix:"855"},{iso2:"CM",name:Object(c.b)("Cameroon"),prefix:"237"},{iso2:"CA",name:Object(c.b)("Canada"),prefix:"1"},{iso2:"CV",name:Object(c.b)("Cape Verde"),prefix:"238"},{iso2:"BQ",name:Object(c.b)("Caribbean Netherlands"),prefix:"599"},{iso2:"KY",name:Object(c.b)("Cayman Islands"),prefix:"1"},{iso2:"CF",name:Object(c.b)("Central African Republic"),prefix:"236"},{iso2:"TD",name:Object(c.b)("Chad"),prefix:"235"},{iso2:"CL",name:Object(c.b)("Chile"),prefix:"56"},{iso2:"CN",name:Object(c.b)("China"),prefix:"86"},{iso2:"CX",name:Object(c.b)("Christmas Island"),prefix:"61"},{iso2:"CC",name:Object(c.b)("Cocos (Keeling) Islands"),prefix:"61"},{iso2:"CO",name:Object(c.b)("Colombia"),prefix:"57"},{iso2:"KM",name:Object(c.b)("Comoros"),prefix:"269"},{iso2:"CG",name:Object(c.b)("Congo - Brazzaville"),prefix:"242"},{iso2:"CD",name:Object(c.b)("Congo - Kinshasa"),prefix:"243"},{iso2:"CK",name:Object(c.b)("Cook Islands"),prefix:"682"},{iso2:"CR",name:Object(c.b)("Costa Rica"),prefix:"506"},{iso2:"HR",name:Object(c.b)("Croatia"),prefix:"385"},{iso2:"CU",name:Object(c.b)("Cuba"),prefix:"53"},{iso2:"CW",name:Object(c.b)("Curaçao"),prefix:"599"},{iso2:"CY",name:Object(c.b)("Cyprus"),prefix:"357"},{iso2:"CZ",name:Object(c.b)("Czech Republic"),prefix:"420"},{iso2:"CI",name:Object(c.b)("Côte d’Ivoire"),prefix:"225"},{iso2:"DK",name:Object(c.b)("Denmark"),prefix:"45"},{iso2:"DJ",name:Object(c.b)("Djibouti"),prefix:"253"},{iso2:"DM",name:Object(c.b)("Dominica"),prefix:"1"},{iso2:"DO",name:Object(c.b)("Dominican Republic"),prefix:"1"},{iso2:"EC",name:Object(c.b)("Ecuador"),prefix:"593"},{iso2:"EG",name:Object(c.b)("Egypt"),prefix:"20"},{iso2:"SV",name:Object(c.b)("El Salvador"),prefix:"503"},{iso2:"GQ",name:Object(c.b)("Equatorial Guinea"),prefix:"240"},{iso2:"ER",name:Object(c.b)("Eritrea"),prefix:"291"},{iso2:"EE",name:Object(c.b)("Estonia"),prefix:"372"},{iso2:"ET",name:Object(c.b)("Ethiopia"),prefix:"251"},{iso2:"FK",name:Object(c.b)("Falkland Islands"),prefix:"500"},{iso2:"FO",name:Object(c.b)("Faroe Islands"),prefix:"298"},{iso2:"FJ",name:Object(c.b)("Fiji"),prefix:"679"},{iso2:"FI",name:Object(c.b)("Finland"),prefix:"358"},{iso2:"FR",name:Object(c.b)("France"),prefix:"33"},{iso2:"GF",name:Object(c.b)("French Guiana"),prefix:"594"},{iso2:"PF",name:Object(c.b)("French Polynesia"),prefix:"689"},{iso2:"TF",name:Object(c.b)("French Southern Territories"),prefix:"262"},{iso2:"GA",name:Object(c.b)("Gabon"),prefix:"241"},{iso2:"GM",name:Object(c.b)("Gambia"),prefix:"220"},{iso2:"GE",name:Object(c.b)("Georgia"),prefix:"995"},{iso2:"DE",name:Object(c.b)("Germany"),prefix:"49"},{iso2:"GH",name:Object(c.b)("Ghana"),prefix:"233"},{iso2:"GI",name:Object(c.b)("Gibraltar"),prefix:"350"},{iso2:"GR",name:Object(c.b)("Greece"),prefix:"30"},{iso2:"GL",name:Object(c.b)("Greenland"),prefix:"299"},{iso2:"GD",name:Object(c.b)("Grenada"),prefix:"1"},{iso2:"GP",name:Object(c.b)("Guadeloupe"),prefix:"590"},{iso2:"GU",name:Object(c.b)("Guam"),prefix:"1"},{iso2:"GT",name:Object(c.b)("Guatemala"),prefix:"502"},{iso2:"GG",name:Object(c.b)("Guernsey"),prefix:"44"},{iso2:"GN",name:Object(c.b)("Guinea"),prefix:"224"},{iso2:"GW",name:Object(c.b)("Guinea-Bissau"),prefix:"245"},{iso2:"GY",name:Object(c.b)("Guyana"),prefix:"592"},{iso2:"HT",name:Object(c.b)("Haiti"),prefix:"509"},{iso2:"HM",name:Object(c.b)("Heard & McDonald Islands"),prefix:"672"},{iso2:"HN",name:Object(c.b)("Honduras"),prefix:"504"},{iso2:"HK",name:Object(c.b)("Hong Kong"),prefix:"852"},{iso2:"HU",name:Object(c.b)("Hungary"),prefix:"36"},{iso2:"IS",name:Object(c.b)("Iceland"),prefix:"354"},{iso2:"IN",name:Object(c.b)("India"),prefix:"91"},{iso2:"ID",name:Object(c.b)("Indonesia"),prefix:"62"},{iso2:"IR",name:Object(c.b)("Iran"),prefix:"98"},{iso2:"IQ",name:Object(c.b)("Iraq"),prefix:"964"},{iso2:"IE",name:Object(c.b)("Ireland"),prefix:"353"},{iso2:"IM",name:Object(c.b)("Isle of Man"),prefix:"44"},{iso2:"IL",name:Object(c.b)("Israel"),prefix:"972"},{iso2:"IT",name:Object(c.b)("Italy"),prefix:"39"},{iso2:"JM",name:Object(c.b)("Jamaica"),prefix:"1"},{iso2:"JP",name:Object(c.b)("Japan"),prefix:"81"},{iso2:"JE",name:Object(c.b)("Jersey"),prefix:"44"},{iso2:"JO",name:Object(c.b)("Jordan"),prefix:"962"},{iso2:"KZ",name:Object(c.b)("Kazakhstan"),prefix:"7"},{iso2:"KE",name:Object(c.b)("Kenya"),prefix:"254"},{iso2:"KI",name:Object(c.b)("Kiribati"),prefix:"686"},{iso2:"XK",name:Object(c.b)("Kosovo"),prefix:"383"},{iso2:"KW",name:Object(c.b)("Kuwait"),prefix:"965"},{iso2:"KG",name:Object(c.b)("Kyrgyzstan"),prefix:"996"},{iso2:"LA",name:Object(c.b)("Laos"),prefix:"856"},{iso2:"LV",name:Object(c.b)("Latvia"),prefix:"371"},{iso2:"LB",name:Object(c.b)("Lebanon"),prefix:"961"},{iso2:"LS",name:Object(c.b)("Lesotho"),prefix:"266"},{iso2:"LR",name:Object(c.b)("Liberia"),prefix:"231"},{iso2:"LY",name:Object(c.b)("Libya"),prefix:"218"},{iso2:"LI",name:Object(c.b)("Liechtenstein"),prefix:"423"},{iso2:"LT",name:Object(c.b)("Lithuania"),prefix:"370"},{iso2:"LU",name:Object(c.b)("Luxembourg"),prefix:"352"},{iso2:"MO",name:Object(c.b)("Macau"),prefix:"853"},{iso2:"MK",name:Object(c.b)("Macedonia"),prefix:"389"},{iso2:"MG",name:Object(c.b)("Madagascar"),prefix:"261"},{iso2:"MW",name:Object(c.b)("Malawi"),prefix:"265"},{iso2:"MY",name:Object(c.b)("Malaysia"),prefix:"60"},{iso2:"MV",name:Object(c.b)("Maldives"),prefix:"960"},{iso2:"ML",name:Object(c.b)("Mali"),prefix:"223"},{iso2:"MT",name:Object(c.b)("Malta"),prefix:"356"},{iso2:"MH",name:Object(c.b)("Marshall Islands"),prefix:"692"},{iso2:"MQ",name:Object(c.b)("Martinique"),prefix:"596"},{iso2:"MR",name:Object(c.b)("Mauritania"),prefix:"222"},{iso2:"MU",name:Object(c.b)("Mauritius"),prefix:"230"},{iso2:"YT",name:Object(c.b)("Mayotte"),prefix:"262"},{iso2:"MX",name:Object(c.b)("Mexico"),prefix:"52"},{iso2:"FM",name:Object(c.b)("Micronesia"),prefix:"691"},{iso2:"MD",name:Object(c.b)("Moldova"),prefix:"373"},{iso2:"MC",name:Object(c.b)("Monaco"),prefix:"377"},{iso2:"MN",name:Object(c.b)("Mongolia"),prefix:"976"},{iso2:"ME",name:Object(c.b)("Montenegro"),prefix:"382"},{iso2:"MS",name:Object(c.b)("Montserrat"),prefix:"1"},{iso2:"MA",name:Object(c.b)("Morocco"),prefix:"212"},{iso2:"MZ",name:Object(c.b)("Mozambique"),prefix:"258"},{iso2:"MM",name:Object(c.b)("Myanmar"),prefix:"95"},{iso2:"NA",name:Object(c.b)("Namibia"),prefix:"264"},{iso2:"NR",name:Object(c.b)("Nauru"),prefix:"674"},{iso2:"NP",name:Object(c.b)("Nepal"),prefix:"977"},{iso2:"NL",name:Object(c.b)("Netherlands"),prefix:"31"},{iso2:"NC",name:Object(c.b)("New Caledonia"),prefix:"687"},{iso2:"NZ",name:Object(c.b)("New Zealand"),prefix:"64"},{iso2:"NI",name:Object(c.b)("Nicaragua"),prefix:"505"},{iso2:"NE",name:Object(c.b)("Niger"),prefix:"227"},{iso2:"NG",name:Object(c.b)("Nigeria"),prefix:"234"},{iso2:"NU",name:Object(c.b)("Niue"),prefix:"683"},{iso2:"NF",name:Object(c.b)("Norfolk Island"),prefix:"672"},{iso2:"KP",name:Object(c.b)("North Korea"),prefix:"850"},{iso2:"MP",name:Object(c.b)("Northern Mariana Islands"),prefix:"1"},{iso2:"NO",name:Object(c.b)("Norway"),prefix:"47"},{iso2:"OM",name:Object(c.b)("Oman"),prefix:"968"},{iso2:"PK",name:Object(c.b)("Pakistan"),prefix:"92"},{iso2:"PW",name:Object(c.b)("Palau"),prefix:"680"},{iso2:"PS",name:Object(c.b)("Palestine"),prefix:"970"},{iso2:"PA",name:Object(c.b)("Panama"),prefix:"507"},{iso2:"PG",name:Object(c.b)("Papua New Guinea"),prefix:"675"},{iso2:"PY",name:Object(c.b)("Paraguay"),prefix:"595"},{iso2:"PE",name:Object(c.b)("Peru"),prefix:"51"},{iso2:"PH",name:Object(c.b)("Philippines"),prefix:"63"},{iso2:"PN",name:Object(c.b)("Pitcairn Islands"),prefix:"870"},{iso2:"PL",name:Object(c.b)("Poland"),prefix:"48"},{iso2:"PT",name:Object(c.b)("Portugal"),prefix:"351"},{iso2:"PR",name:Object(c.b)("Puerto Rico"),prefix:"1"},{iso2:"QA",name:Object(c.b)("Qatar"),prefix:"974"},{iso2:"RO",name:Object(c.b)("Romania"),prefix:"40"},{iso2:"RU",name:Object(c.b)("Russia"),prefix:"7"},{iso2:"RW",name:Object(c.b)("Rwanda"),prefix:"250"},{iso2:"RE",name:Object(c.b)("Réunion"),prefix:"262"},{iso2:"WS",name:Object(c.b)("Samoa"),prefix:"685"},{iso2:"SM",name:Object(c.b)("San Marino"),prefix:"378"},{iso2:"SA",name:Object(c.b)("Saudi Arabia"),prefix:"966"},{iso2:"SN",name:Object(c.b)("Senegal"),prefix:"221"},{iso2:"RS",name:Object(c.b)("Serbia"),prefix:"381 p"},{iso2:"SC",name:Object(c.b)("Seychelles"),prefix:"248"},{iso2:"SL",name:Object(c.b)("Sierra Leone"),prefix:"232"},{iso2:"SG",name:Object(c.b)("Singapore"),prefix:"65"},{iso2:"SX",name:Object(c.b)("Sint Maarten"),prefix:"1"},{iso2:"SK",name:Object(c.b)("Slovakia"),prefix:"421"},{iso2:"SI",name:Object(c.b)("Slovenia"),prefix:"386"},{iso2:"SB",name:Object(c.b)("Solomon Islands"),prefix:"677"},{iso2:"SO",name:Object(c.b)("Somalia"),prefix:"252"},{iso2:"ZA",name:Object(c.b)("South Africa"),prefix:"27"},{iso2:"GS",name:Object(c.b)("South Georgia & South Sandwich Islands"),prefix:"500"},{iso2:"KR",name:Object(c.b)("South Korea"),prefix:"82"},{iso2:"SS",name:Object(c.b)("South Sudan"),prefix:"211"},{iso2:"ES",name:Object(c.b)("Spain"),prefix:"34"},{iso2:"LK",name:Object(c.b)("Sri Lanka"),prefix:"94"},{iso2:"BL",name:Object(c.b)("St. Barthélemy"),prefix:"590"},{iso2:"SH",name:Object(c.b)("St. Helena"),prefix:"290 n"},{iso2:"KN",name:Object(c.b)("St. Kitts & Nevis"),prefix:"1"},{iso2:"LC",name:Object(c.b)("St. Lucia"),prefix:"1"},{iso2:"MF",name:Object(c.b)("St. Martin"),prefix:"590"},{iso2:"PM",name:Object(c.b)("St. Pierre & Miquelon"),prefix:"508"},{iso2:"VC",name:Object(c.b)("St. Vincent & Grenadines"),prefix:"1"},{iso2:"SD",name:Object(c.b)("Sudan"),prefix:"249"},{iso2:"SR",name:Object(c.b)("Suriname"),prefix:"597"},{iso2:"SJ",name:Object(c.b)("Svalbard & Jan Mayen"),prefix:"47"},{iso2:"SZ",name:Object(c.b)("Swaziland"),prefix:"268"},{iso2:"SE",name:Object(c.b)("Sweden"),prefix:"46"},{iso2:"CH",name:Object(c.b)("Switzerland"),prefix:"41"},{iso2:"SY",name:Object(c.b)("Syria"),prefix:"963"},{iso2:"ST",name:Object(c.b)("São Tomé & Príncipe"),prefix:"239"},{iso2:"TW",name:Object(c.b)("Taiwan"),prefix:"886"},{iso2:"TJ",name:Object(c.b)("Tajikistan"),prefix:"992"},{iso2:"TZ",name:Object(c.b)("Tanzania"),prefix:"255"},{iso2:"TH",name:Object(c.b)("Thailand"),prefix:"66"},{iso2:"TL",name:Object(c.b)("Timor-Leste"),prefix:"670"},{iso2:"TG",name:Object(c.b)("Togo"),prefix:"228"},{iso2:"TK",name:Object(c.b)("Tokelau"),prefix:"690"},{iso2:"TO",name:Object(c.b)("Tonga"),prefix:"676"},{iso2:"TT",name:Object(c.b)("Trinidad & Tobago"),prefix:"1"},{iso2:"TN",name:Object(c.b)("Tunisia"),prefix:"216"},{iso2:"TR",name:Object(c.b)("Turkey"),prefix:"90"},{iso2:"TM",name:Object(c.b)("Turkmenistan"),prefix:"993"},{iso2:"TC",name:Object(c.b)("Turks & Caicos Islands"),prefix:"1"},{iso2:"TV",name:Object(c.b)("Tuvalu"),prefix:"688"},{iso2:"VI",name:Object(c.b)("U.S. Virgin Islands"),prefix:"1"},{iso2:"UG",name:Object(c.b)("Uganda"),prefix:"256"},{iso2:"UA",name:Object(c.b)("Ukraine"),prefix:"380"},{iso2:"AE",name:Object(c.b)("United Arab Emirates"),prefix:"971"},{iso2:"UY",name:Object(c.b)("Uruguay"),prefix:"598"},{iso2:"UZ",name:Object(c.b)("Uzbekistan"),prefix:"998"},{iso2:"VU",name:Object(c.b)("Vanuatu"),prefix:"678"},{iso2:"VA",name:Object(c.b)("Vatican City"),prefix:"39"},{iso2:"VE",name:Object(c.b)("Venezuela"),prefix:"58"},{iso2:"VN",name:Object(c.b)("Vietnam"),prefix:"84"},{iso2:"WF",name:Object(c.b)("Wallis & Futuna"),prefix:"681"},{iso2:"EH",name:Object(c.b)("Western Sahara"),prefix:"212"},{iso2:"YE",name:Object(c.b)("Yemen"),prefix:"967"},{iso2:"ZM",name:Object(c.b)("Zambia"),prefix:"260"},{iso2:"ZW",name:Object(c.b)("Zimbabwe"),prefix:"263"}];var Zn;const ei={};for(const e of Xn)ei[e.iso2]=e;function ti(e,t){return"+"===e[0]&&(e=e.slice(1)),0==t.name.toUpperCase().indexOf(e.toUpperCase())||(t.iso2==e.toUpperCase()||-1!==t.prefix.indexOf(e))}let si=Object(P.a)("views.auth.CountryDropdown")(Zn=class extends a.a.Component{constructor(e){super(e),this._onSearchChange=this._onSearchChange.bind(this),this._onOptionChange=this._onOptionChange.bind(this),this._getShortOption=this._getShortOption.bind(this);let t=Xn[0];const s=l.a.get().defaultCountryCode;if(s){const e=Xn.find(e=>e.iso2===s.toUpperCase());e&&(t=e)}this.state={searchQuery:"",defaultCountry:t}}componentDidMount(){this.props.value||this.props.onOptionChange(this.state.defaultCountry)}_onSearchChange(e){this.setState({searchQuery:e})}_onOptionChange(e){this.props.onOptionChange(ei[e])}_flagImgForIso2(e){return a.a.createElement("div",{className:"mx_Dropdown_option_emoji"},(t=e,Qn.test(t)?String.fromCodePoint(...t.split("").map(e=>Jn+e.charCodeAt(0))):""));var t}_getShortOption(e){if(!this.props.isSmall)return;let t;return this.props.showPrefix&&(t="+"+ei[e].prefix),a.a.createElement("span",{className:"mx_CountryDropdown_shortOption"},this._flagImgForIso2(e),t)}render(){const e=d.getComponent("elements.Dropdown");let t;if(this.state.searchQuery){if(t=Xn.filter(ti.bind(this,this.state.searchQuery)),2==this.state.searchQuery.length&&ei[this.state.searchQuery.toUpperCase()]){const e=ei[this.state.searchQuery.toUpperCase()];t=t.filter(t=>t.iso2!=e.iso2),t.unshift(e)}}else t=Xn;const s=t.map(e=>a.a.createElement("div",{className:"mx_CountryDropdown_option",key:e.iso2},this._flagImgForIso2(e.iso2),Object(c.a)(e.name)," (+",e.prefix,")")),n=this.props.value||this.state.defaultCountry.iso2;return a.a.createElement(e,{id:"mx_CountryDropdown",className:this.props.className+" mx_CountryDropdown",onOptionChange:this._onOptionChange,onSearchChange:this._onSearchChange,menuWidth:298,getShortOption:this._getShortOption,value:n,searchEnabled:!0,disabled:this.props.disabled,label:Object(c.a)("Country Dropdown")},s)}})||Zn;var ni,ii,oi;si.propTypes={className:wt.a.string,isSmall:wt.a.bool,showPrefix:wt.a.bool,onOptionChange:wt.a.func.isRequired,value:wt.a.string,disabled:wt.a.bool};const ai=/^[0-9()\-\s]*$/;var ri;!function(e){e.Email="login_field_email",e.MatrixId="login_field_mxid",e.Phone="login_field_phone",e.Password="login_field_phone"}(ri||(ri={}));let ci=Object(P.a)("views.auth.PasswordLogin")((oi=ii=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"onForgotPasswordClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onForgotPasswordClick()}),x()(this,"onSubmitForm",async e=>{e.preventDefault();if(!await this.verifyFieldsBeforeSubmit())return void E.a.instance.track("onboarding_registration_submit_failed");let t="",s=null,n=null;switch(this.state.loginType){case ri.Email:case ri.MatrixId:t=this.props.username;break;case ri.Phone:s=this.props.phoneCountry,n=this.props.phoneNumber}this.props.onSubmit(t,s,n,this.state.password)}),x()(this,"onUsernameChanged",e=>{this.props.onUsernameChanged(e.target.value)}),x()(this,"onUsernameFocus",()=>{this.state.loginType===ri.MatrixId?E.a.instance.track("onboarding_login_mxid_focus"):E.a.instance.track("onboarding_login_email_focus")}),x()(this,"onUsernameBlur",e=>{this.state.loginType===ri.MatrixId?E.a.instance.track("onboarding_login_mxid_blur"):E.a.instance.track("onboarding_login_email_blur"),this.props.onUsernameBlur(e.target.value)}),x()(this,"onLoginTypeChange",e=>{const t=e.target.value;this.setState({loginType:t}),this.props.onUsernameChanged(""),E.a.instance.track("onboarding_login_type_changed",{loginType:t})}),x()(this,"onPhoneCountryChanged",e=>{this.props.onPhoneCountryChanged(e.iso2)}),x()(this,"onPhoneNumberChanged",e=>{this.props.onPhoneNumberChanged(e.target.value)}),x()(this,"onPhoneNumberFocus",()=>{E.a.instance.track("onboarding_login_phone_number_focus")}),x()(this,"onPhoneNumberBlur",e=>{E.a.instance.track("onboarding_login_phone_number_blur")}),x()(this,"onPasswordChanged",e=>{this.setState({password:e.target.value})}),x()(this,"validateUsernameRules",Object(Ts.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Enter username")}]})),x()(this,"onUsernameValidate",async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(ri.MatrixId,t.valid),t}),x()(this,"validateEmailRules",Object(Ts.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Enter email address")},{key:"email",test:({value:e})=>!e||zn.a(e),invalid:()=>Object(c.a)("Doesn't look like a valid email address")}]})),x()(this,"onEmailValidate",async e=>{const t=await this.validateEmailRules(e);return this.markFieldValid(ri.Email,t.valid),t}),x()(this,"validatePhoneNumberRules",Object(Ts.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Enter phone number")},{key:"number",test:({value:e})=>!e||ai.test(e),invalid:()=>Object(c.a)("That phone number doesn't look quite right, please check and try again")}]})),x()(this,"onPhoneNumberValidate",async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(ri.Password,t.valid),t}),x()(this,"validatePasswordRules",Object(Ts.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Enter password")}]})),x()(this,"onPasswordValidate",async e=>{const t=await this.validatePasswordRules(e);return this.markFieldValid(ri.Password,t.valid),t}),this.state={fieldValid:{},loginType:ri.MatrixId,password:""}}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[this.state.loginType,ri.Password];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const s=this.findFirstInvalidField(t);return!s||(s.focus(),s.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){const e=Object.keys(this.state.fieldValid);for(let t=0;t<e.length;++t)if(!this.state.fieldValid[e[t]])return!1;return!0}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:s}=this.state;s[e]=t,this.setState({fieldValid:s})}renderLoginField(e,t){const s={error:!1};switch(e){case ri.Email:return s.error=this.props.loginIncorrect&&!this.props.username,a.a.createElement(Ue.a,{className:M()(s),name:"username",key:"email_input",type:"text",label:Object(c.a)("Email"),placeholder:"joe@example.com",value:this.props.username,onChange:this.onUsernameChanged,onFocus:this.onUsernameFocus,onBlur:this.onUsernameBlur,disabled:this.props.disableSubmit,autoFocus:t,onValidate:this.onEmailValidate,ref:e=>this[ri.Email]=e});case ri.MatrixId:return s.error=this.props.loginIncorrect&&!this.props.username,a.a.createElement(Ue.a,{className:M()(s),name:"username",key:"username_input",type:"text",label:Object(c.a)("Username"),placeholder:Object(c.a)("Username").toLocaleLowerCase(),value:this.props.username,onChange:this.onUsernameChanged,onFocus:this.onUsernameFocus,onBlur:this.onUsernameBlur,disabled:this.props.disableSubmit,autoFocus:t,onValidate:this.onUsernameValidate,ref:e=>this[ri.MatrixId]=e});case ri.Phone:{s.error=this.props.loginIncorrect&&!this.props.phoneNumber;const e=a.a.createElement(si,{value:this.props.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChanged});return a.a.createElement(Ue.a,{className:M()(s),name:"phoneNumber",key:"phone_input",type:"text",label:Object(c.a)("Phone"),value:this.props.phoneNumber,prefixComponent:e,onChange:this.onPhoneNumberChanged,onFocus:this.onPhoneNumberFocus,onBlur:this.onPhoneNumberBlur,disabled:this.props.disableSubmit,autoFocus:t,onValidate:this.onPhoneNumberValidate,ref:e=>this[ri.Password]=e})}}}isLoginEmpty(){switch(this.state.loginType){case ri.Email:case ri.MatrixId:return!this.props.username;case ri.Phone:return!this.props.phoneCountry||!this.props.phoneNumber}}render(){let e;this.props.onForgotPasswordClick&&(e=a.a.createElement(g.a,{className:"mx_Login_forgot",disabled:this.props.busy,kind:"link",onClick:this.onForgotPasswordClick},Object(c.a)("Forgot password?")));const t=M()({error:this.props.loginIncorrect&&!this.isLoginEmpty()}),s=!this.isLoginEmpty(),n=this.renderLoginField(this.state.loginType,!s);let i;return l.a.get().disable_3pid_login||(i=a.a.createElement("div",{className:"mx_Login_type_container"},a.a.createElement("label",{className:"mx_Login_type_label"},Object(c.a)("Sign in with")),a.a.createElement(Ue.a,{element:"select",value:this.state.loginType,onChange:this.onLoginTypeChange,disabled:this.props.disableSubmit},a.a.createElement("option",{key:ri.MatrixId,value:ri.MatrixId},Object(c.a)("Username")),a.a.createElement("option",{key:ri.Email,value:ri.Email},Object(c.a)("Email address")),a.a.createElement("option",{key:ri.Password,value:ri.Password},Object(c.a)("Phone"))))),a.a.createElement("div",null,a.a.createElement("form",{onSubmit:this.onSubmitForm},i,n,a.a.createElement(Ue.a,{className:t,type:"password",name:"password",label:Object(c.a)("Password"),value:this.state.password,onChange:this.onPasswordChanged,disabled:this.props.disableSubmit,autoFocus:s,onValidate:this.onPasswordValidate,ref:e=>this[ri.Password]=e}),e,!this.props.busy&&a.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(c.a)("Sign in"),disabled:this.props.disableSubmit})))}},x()(ii,"defaultProps",{onUsernameChanged:function(){},onUsernameBlur:function(){},onPhoneCountryChanged:function(){},onPhoneNumberChanged:function(){},loginIncorrect:!1,disableSubmit:!1}),ni=oi))||ni;var li=s(117);const di=e=>{let{matrixClient:t,loginType:n,fragmentAfterLogin:i,idp:o,primary:r,mini:l}=e,d=me()(e,["matrixClient","loginType","fragmentAfterLogin","idp","primary","mini"]);const u=o?Object(c.a)("Continue with %(provider)s",{provider:o.name}):Object(c.a)("Sign in with single sign-on"),h=()=>{Xt.a.get().startSingleSignOn(t,n,i,null==o?void 0:o.id)};let m,p;const v=o?(e=>{switch(e){case qn.a.Apple:return s(1269);case qn.a.Facebook:return s(1270);case qn.a.Github:return s(1271);case qn.a.Gitlab:return s(1272);case qn.a.Google:return s(1273);case qn.a.Twitter:return s(1274);default:return null}})(o.brand):null;if(v){const e=o.brand.split(".").pop();p="mx_SSOButton_brand_"+e,m=a.a.createElement("img",{src:v,height:"24",width:"24",alt:e})}else if("string"==typeof(null==o?void 0:o.icon)&&o.icon.startsWith("mxc://")){const e=Object(pe.b)(o.icon,t).getSquareThumbnailHttp(24);m=a.a.createElement("img",{src:e,height:"24",width:"24",alt:o.name})}const f=M()("mx_SSOButton",{[p]:p,mx_SSOButton_mini:l,mx_SSOButton_default:!o,mx_SSOButton_primary:r});return l?a.a.createElement(K.a,ue()({},d,{title:u,className:f,onClick:h}),m):a.a.createElement(g.a,ue()({},d,{className:f,onClick:h}),m,u)};var ui,hi=({matrixClient:e,flow:t,loginType:s,fragmentAfterLogin:n,primary:i})=>{const o=t.identity_providers||[];if(o.length<2)return a.a.createElement("div",{className:"mx_SSOButtons"},a.a.createElement(di,{matrixClient:e,loginType:s,fragmentAfterLogin:n,idp:o[0],primary:i}));const r=Math.ceil(o.length/6),c=Math.ceil(o.length/r);return a.a.createElement("div",{className:"mx_SSOButtons"},Object(li.chunk)(o,c).map(t=>a.a.createElement("div",{key:t[0].id,className:"mx_SSOButtons_row"},t.map(t=>a.a.createElement(di,{key:t.id,matrixClient:e,loginType:s,fragmentAfterLogin:n,idp:t,mini:!0,primary:i})))))},mi=s(205),pi=s(240),gi=s(211);let vi=Object(P.a)("views.dialogs.ServerPickerDialog")(ui=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"defaultServer",void 0),x()(this,"fieldRef",Object(o.createRef)()),x()(this,"validatedConf",void 0),x()(this,"onDefaultChosen",()=>{this.setState({defaultChosen:!0})}),x()(this,"onOtherChosen",()=>{this.setState({defaultChosen:!1})}),x()(this,"onHomeserverChange",e=>{this.setState({otherHomeserver:e.target.value})}),x()(this,"validate",Object(Ts.a)({deriveData:async({value:e})=>{let t=e.trim();if(!t.includes("://"))try{const e=await pi.a.findClientConfig(t);return this.validatedConf=Hn.b.buildValidatedConfigFromDiscovery(t,e),{}}catch(e){console.error(`Attempted ${t} as a server_name but it failed`,e)}t.includes("://")||(t="https://"+t);try{return this.validatedConf=await Hn.b.validateServerConfigWithStaticUrls(t),{}}catch(e){console.error(e);if(Hn.b.authComponentStateForError(e).serverErrorIsFatal){let t=Object(c.a)("Unable to validate homeserver");return e.translatedMessage&&(t=e.translatedMessage),{error:t}}try{return this.validatedConf=await Hn.b.validateServerConfigWithStaticUrls(t,null,!0),{}}catch(e){return console.error(e),{error:Object(c.a)("Invalid URL")}}}},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Specify a homeserver")},{key:"valid",test:async function({value:e},{error:t}){return!e||!t},invalid:function({error:e}){return e}}]})),x()(this,"onHomeserverValidate",e=>this.validate(e)),x()(this,"onSubmit",async e=>{e.preventDefault();if(!await this.fieldRef.current.validate({allowEmpty:!1})&&!this.state.defaultChosen)return this.fieldRef.current.focus(),void this.fieldRef.current.validate({allowEmpty:!1,focused:!0});this.props.onFinished(this.state.defaultChosen?this.defaultServer:this.validatedConf)});const t=l.a.get();this.defaultServer=t.validated_server_config;const{serverConfig:s}=this.props;let n="";s.isDefault||(n=s.isNameResolvable&&s.hsName?s.hsName:s.hsUrl),this.state={defaultChosen:s.isDefault,otherHomeserver:n}}render(){let e;"matrix.org"===this.defaultServer.hsName&&(e=Object(c.a)("Matrix.org is the biggest public homeserver in the world, so it’s a good place for many."));let t=this.defaultServer.hsName;return this.defaultServer.hsNameIsDifferent&&(t=a.a.createElement(mi.a,{class:"mx_Login_underlinedServerName",tooltip:this.defaultServer.hsUrl},this.defaultServer.hsName)),a.a.createElement(Ze.a,{title:this.props.title||Object(c.a)("Sign into your homeserver"),className:"mx_ServerPickerDialog",contentId:"mx_ServerPickerDialog",onFinished:this.props.onFinished,fixedWidth:!1,hasCancel:!0},a.a.createElement("form",{className:"mx_Dialog_content",id:"mx_ServerPickerDialog",onSubmit:this.onSubmit},a.a.createElement("p",null,Object(c.a)("We call the places where you can host your account ‘homeservers’.")," ",e),a.a.createElement(gi.a,{name:"defaultChosen",value:"true",checked:this.state.defaultChosen,onChange:this.onDefaultChosen},t),a.a.createElement(gi.a,{name:"defaultChosen",value:"false",className:"mx_ServerPickerDialog_otherHomeserverRadio",checked:!this.state.defaultChosen,onChange:this.onOtherChosen},a.a.createElement(Ue.a,{type:"text",className:"mx_ServerPickerDialog_otherHomeserver",label:Object(c.a)("Other homeserver"),onChange:this.onHomeserverChange,onClick:this.onOtherChosen,ref:this.fieldRef,onValidate:this.onHomeserverValidate,value:this.state.otherHomeserver,validateOnChange:!1,validateOnFocus:!1,id:"mx_homeserverInput"})),a.a.createElement("p",null,Object(c.a)("Use your preferred Matrix homeserver if you have one, or host your own.")),a.a.createElement(g.a,{className:"mx_ServerPickerDialog_continue",kind:"primary",onClick:this.onSubmit},Object(c.a)("Continue")),a.a.createElement("h4",null,Object(c.a)("Learn more")),a.a.createElement("a",{href:"https://matrix.org/faq/#what-is-a-homeserver%3F",target:"_blank",rel:"noreferrer noopener"},Object(c.a)("About homeservers"))))}})||ui;const fi=()=>{Le.a.createTrackedDialog("Custom Server Dialog","",Ve.a,{title:Object(c.a)("Server Options"),description:Object(c.a)("You can use the custom server options to sign into other Matrix servers by specifying a different homeserver URL. This allows you to use Element with an existing Matrix account on a different homeserver."),button:Object(c.a)("Dismiss"),hasCloseButton:!1,fixedWidth:!1},"mx_ServerPicker_helpDialog")};var bi,yi=({title:e,dialogTitle:t,serverConfig:s,onServerConfigChange:n})=>{let i;if(!l.a.get().disable_custom_urls&&n){const e=()=>{((e,t,s)=>{Le.a.createTrackedDialog("Server Picker","",vi,{title:e,serverConfig:t,onFinished:s})})(t,s,e=>{e&&n(e)})};i=a.a.createElement(g.a,{className:"mx_ServerPicker_change",kind:"link",onClick:e},Object(c.a)("Edit"))}let o,r=s.isNameResolvable?s.hsName:s.hsUrl;return s.hsNameIsDifferent&&(r=a.a.createElement(mi.a,{class:"mx_Login_underlinedServerName",tooltip:s.hsUrl},s.hsName)),"matrix.org"===s.hsName&&(o=a.a.createElement("span",{className:"mx_ServerPicker_desc"},Object(c.a)("Join millions for free on the largest public server"))),a.a.createElement("div",{className:"mx_ServerPicker"},a.a.createElement("h3",null,e||Object(c.a)("Homeserver")),a.a.createElement(g.a,{className:"mx_ServerPicker_help",onClick:fi}),a.a.createElement("span",{className:"mx_ServerPicker_server"},r),i,o)};function _i(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function Ei(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?_i(Object(s),!0).forEach((function(t){x()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):_i(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}Object(c.b)("Invalid homeserver discovery response"),Object(c.b)("Failed to get autodiscovery configuration from server"),Object(c.b)("Invalid base_url for m.homeserver"),Object(c.b)("Homeserver URL does not appear to be a valid Matrix homeserver"),Object(c.b)("Invalid identity server discovery response"),Object(c.b)("Invalid base_url for m.identity_server"),Object(c.b)("Identity server URL does not appear to be a valid identity server"),Object(c.b)("General failure");let Si=Object(P.a)("structures.auth.LoginComponent")(bi=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"unmounted",!1),x()(this,"loginLogic",void 0),x()(this,"stepRendererMap",void 0),x()(this,"isBusy",()=>this.state.busy||this.props.busy),x()(this,"onPasswordLogin",async(e,t,s,n)=>{if(!this.state.serverIsAlive){this.setState({busy:!0});let e=!0;try{await Hn.b.validateServerConfigWithStaticUrls(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl),this.setState({serverIsAlive:!0,errorText:""})}catch(t){const s=Hn.b.authComponentStateForError(t);this.setState(Ei({busy:!1,busyLoggingIn:!1},s)),e=!s.serverErrorIsFatal}if(!e)return}this.setState({busy:!0,busyLoggingIn:!0,errorText:null,loginIncorrect:!1}),this.loginLogic.loginViaPassword(e,t,s,n).then(e=>{this.setState({serverIsAlive:!0}),this.props.onLoggedIn(e,n)},t=>{if(this.unmounted)return;let s;const n=e.indexOf("@")>0;if(400===t.httpStatus&&n)s=Object(c.a)("This homeserver does not support login using email address.");else if("M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const e=Object(ts.a)(t.data.limit_type,t.data.admin_contact,{monthly_active_user:Object(c.b)("This homeserver has hit its Monthly Active User limit."),hs_blocked:Object(c.b)("This homeserver has been blocked by it's administrator."),"":Object(c.b)("This homeserver has exceeded one of its resource limits.")}),n=Object(ts.a)(t.data.limit_type,t.data.admin_contact,{"":Object(c.b)("Please <a>contact your service administrator</a> to continue using this service.")});s=a.a.createElement("div",null,a.a.createElement("div",null,e),a.a.createElement("div",{className:"mx_Login_smallError"},n))}else s=401===t.httpStatus||403===t.httpStatus?"M_USER_DEACTIVATED"===t.errcode?Object(c.a)("This account has been deactivated."):l.a.get().disable_custom_urls?a.a.createElement("div",null,a.a.createElement("div",null,Object(c.a)("Incorrect username and/or password.")),a.a.createElement("div",{className:"mx_Login_smallError"},Object(c.a)("Please note you are logging into the %(hs)s server, not matrix.org.",{hs:this.props.serverConfig.hsName}))):Object(c.a)("Incorrect username and/or password."):this.errorTextFromError(t);this.setState({busy:!1,busyLoggingIn:!1,errorText:s,loginIncorrect:401===t.httpStatus||403===t.httpStatus})})}),x()(this,"onUsernameChanged",e=>{this.setState({username:e})}),x()(this,"onUsernameBlur",async e=>{const t="@"===e[0];if(this.setState({username:e,busy:t,errorText:null,canTryLogin:!0}),t){const t=e.split(":").slice(1).join(":");try{const e=await Hn.b.validateServerName(t);this.props.onServerConfigChange(e),this.setState({busy:!1})}catch(e){console.error("Problem parsing URL or unhandled error doing .well-known discovery:",e);let t=Object(c.a)("Failed to perform homeserver discovery");e.translatedMessage&&(t=e.translatedMessage);let s=t,n={};Hn.b.isLivelinessError(e)&&(s=this.state.errorText,n=Hn.b.authComponentStateForError(e)),this.setState(Ei({busy:!1,errorText:s},n))}}}),x()(this,"onPhoneCountryChanged",e=>{this.setState({phoneCountry:e})}),x()(this,"onPhoneNumberChanged",e=>{this.setState({phoneNumber:e})}),x()(this,"onRegisterClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onRegisterClick()}),x()(this,"onTryRegisterClick",e=>{var t,s;const n=null===(t=this.state.flows)||void 0===t?void 0:t.find(e=>"m.login.password"===e.type),i=null===(s=this.state.flows)||void 0===s?void 0:s.find(e=>"m.login.sso"===e.type||"m.login.cas"===e.type);if(i&&!n){e.preventDefault(),e.stopPropagation();const t="m.login.sso"===i.type?"sso":"cas";Xt.a.get().startSingleSignOn(this.loginLogic.createTemporaryClient(),t,this.props.fragmentAfterLogin)}else this.onRegisterClick(e)}),x()(this,"isSupportedFlow",e=>!!this.stepRendererMap[e.type]||(console.log("Skipping flow",e,"due to unsupported login type",e.type),!1)),x()(this,"renderPasswordStep",()=>a.a.createElement(ci,{onSubmit:this.onPasswordLogin,username:this.state.username,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber,onUsernameChanged:this.onUsernameChanged,onUsernameBlur:this.onUsernameBlur,onPhoneCountryChanged:this.onPhoneCountryChanged,onPhoneNumberChanged:this.onPhoneNumberChanged,onForgotPasswordClick:this.props.onForgotPasswordClick,loginIncorrect:this.state.loginIncorrect,serverConfig:this.props.serverConfig,disableSubmit:this.isBusy(),busy:this.props.isSyncing||this.state.busyLoggingIn})),x()(this,"renderSsoStep",e=>{const t=this.state.flows.find(t=>t.type==="m.login."+e);return a.a.createElement(hi,{matrixClient:this.loginLogic.createTemporaryClient(),flow:t,loginType:e,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!this.state.flows.find(e=>"m.login.password"===e.type)})}),this.state={busy:!1,busyLoggingIn:null,errorText:null,loginIncorrect:!1,canTryLogin:!0,flows:null,username:e.defaultUsername?e.defaultUsername:"",phoneCountry:null,phoneNumber:"",serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""},this.stepRendererMap={"m.login.password":this.renderPasswordStep,"m.login.cas":()=>this.renderSsoStep("cas"),"m.login.sso":()=>this.renderSsoStep("sso")},E.a.instance.track("onboarding_login_begin")}UNSAFE_componentWillMount(){this.initLoginLogic(this.props.serverConfig)}componentWillUnmount(){this.unmounted=!0}UNSAFE_componentWillReceiveProps(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.initLoginLogic(e.serverConfig)}async initLoginLogic({hsUrl:e,isUrl:t}){let s=!1;this.props.serverConfig.isDefault&&e===this.props.serverConfig.hsUrl&&t===this.props.serverConfig.isUrl&&(s=!0);const n=s?this.props.fallbackHsUrl:null,i=new qn.b(e,t,n,{defaultDeviceDisplayName:this.props.defaultDeviceDisplayName});this.loginLogic=i,this.setState({busy:!0,loginIncorrect:!1});try{const{warning:s}=await Hn.b.validateServerConfigWithStaticUrls(e,t);s?this.setState(Ei(Ei({},Hn.b.authComponentStateForError(s)),{},{errorText:""})):this.setState({serverIsAlive:!0,errorText:""})}catch(e){this.setState(Ei({busy:!1},Hn.b.authComponentStateForError(e)))}i.getFlows().then(e=>{const t=e.filter(this.isSupportedFlow);t.length>0?this.setState({flows:t}):this.setState({errorText:Object(c.a)("This homeserver doesn't offer any login flows which are supported by this client.")})},e=>{this.setState({errorText:this.errorTextFromError(e),loginIncorrect:!1,canTryLogin:!1})}).finally(()=>{this.setState({busy:!1})})}errorTextFromError(e){let t=e.errcode;!t&&e.httpStatus&&(t="HTTP "+e.httpStatus);let s=Object(c.a)("There was a problem communicating with the homeserver, please try again later.")+(t?" ("+t+")":"");return"rejected"===e.cors&&(s="https:"!==window.location.protocol||!this.props.serverConfig.hsUrl.startsWith("http:")&&this.props.serverConfig.hsUrl.startsWith("http")?a.a.createElement("span",null,Object(c.a)("Can't connect to homeserver - please check your connectivity, ensure your <a>homeserver's SSL certificate</a> is trusted, and that a browser extension is not blocking requests.",{},{a:e=>a.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:this.props.serverConfig.hsUrl},e)})):a.a.createElement("span",null,Object(c.a)("Can't connect to homeserver via HTTP when an HTTPS URL is in your browser bar. Either use HTTPS or <a>enable unsafe scripts</a>.",{},{a:e=>a.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://www.google.com/search?&q=enable%20unsafe%20scripts"},e)}))),s}renderLoginComponentForFlows(){if(!this.state.flows)return null;const e=["m.login.password","m.login.sso"].map(e=>this.state.flows.find(t=>t.type===e)).filter(Boolean);return a.a.createElement(a.a.Fragment,null,e.map(e=>{const t=this.stepRendererMap[e.type];return a.a.createElement(a.a.Fragment,{key:e.type},t())}))}render(){const e=d.getComponent("auth.AuthHeader"),t=d.getComponent("auth.AuthBody"),s=this.isBusy()&&!this.state.busyLoggingIn?a.a.createElement("div",{className:"mx_Login_loader"},a.a.createElement(Rn.a,null)):null,n=this.state.errorText;let i,o,r;if(n&&(i=a.a.createElement("div",{className:"mx_Login_error"},n)),!this.state.serverIsAlive){const e=M()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});o=a.a.createElement("div",{className:e},this.state.serverDeadError)}return this.props.isSyncing||this.state.busyLoggingIn?r=a.a.createElement("div",{className:"mx_AuthBody_paddedFooter"},a.a.createElement("div",{className:"mx_AuthBody_paddedFooter_title"},a.a.createElement(ot.a,{w:20,h:20}),this.props.isSyncing?Object(c.a)("Syncing..."):Object(c.a)("Signing In...")),this.props.isSyncing&&a.a.createElement("div",{className:"mx_AuthBody_paddedFooter_subtitle"},Object(c.a)("If you've joined lots of rooms, this might take a while"))):V.b.getValue(nt.a.Registration)&&(r=a.a.createElement("span",{className:"mx_AuthBody_changeFlow"},Object(c.a)("New? <a>Create account</a>",{},{a:e=>a.a.createElement("a",{onClick:this.onTryRegisterClick,href:"#"},e)}))),a.a.createElement($n,null,a.a.createElement(e,{disableLanguageSelector:this.props.isSyncing||this.state.busyLoggingIn}),a.a.createElement(t,null,a.a.createElement("h2",null,Object(c.a)("Sign in"),s),i,o,a.a.createElement(yi,{serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange}),this.renderLoginComponentForFlows(),r))}})||bi;var wi,Ci=s(152),ki=s(287);function Oi(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}let Ri=Object(P.a)("structures.auth.Registration")(wi=class extends a.a.Component{constructor(e){super(e),x()(this,"loginLogic",void 0),x()(this,"onFormSubmit",e=>{this.setState({errorText:"",busy:!0,formVals:e,doingUIAuth:!0})}),x()(this,"requestEmailToken",(e,t,s,n)=>this.state.matrixClient.requestRegisterEmailToken(e,t,s,this.props.makeRegistrationUrl({client_secret:t,hs_url:this.state.matrixClient.getHomeserverUrl(),is_url:this.state.matrixClient.getIdentityServerUrl(),session_id:n}))),x()(this,"onUIAuthFinished",async(e,t)=>{if(!e){let e=t.message||t.toString();if("M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const s=Object(ts.a)(t.data.limit_type,t.data.admin_contact,{monthly_active_user:Object(c.b)("This homeserver has hit its Monthly Active User limit."),hs_blocked:Object(c.b)("This homeserver has been blocked by it's administrator."),"":Object(c.b)("This homeserver has exceeded one of its resource limits.")}),n=Object(ts.a)(t.data.limit_type,t.data.admin_contact,{"":Object(c.b)("Please <a>contact your service administrator</a> to continue using this service.")});e=a.a.createElement("div",null,a.a.createElement("p",null,s),a.a.createElement("p",null,n))}else if(t.required_stages&&t.required_stages.indexOf("m.login.msisdn")>-1){let s=!1;for(const e of t.available_flows)s=s||e.stages.includes("m.login.msisdn");s||(e=Object(c.a)("This server does not support authentication with a phone number."))}else"M_USER_IN_USE"===t.errcode&&(e=Object(c.a)("That username already exists, please try another."));return void this.setState({busy:!1,doingUIAuth:!1,errorText:e})}le.a.setJustRegisteredUserId(t.user_id);const s={doingUIAuth:!1,registeredUsername:t.user_id,differentLoggedInUserId:null,completedNoSignin:!1,busy:!0},[n,i]=await ki.b();n&&!i&&n!==t.userId&&(console.log(`Found a session for ${n} but ${t.userId} has just registered.`),s.differentLoggedInUserId=n),t.access_token?(await this.props.onLoggedIn({userId:t.user_id,deviceId:t.device_id,homeserverUrl:this.state.matrixClient.getHomeserverUrl(),identityServerUrl:this.state.matrixClient.getIdentityServerUrl(),accessToken:t.access_token},this.state.formVals.password),this.setupPushers()):(s.busy=!1,s.completedNoSignin=!0),this.setState(s)}),x()(this,"onLoginClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()}),x()(this,"onGoToFormClicked",e=>{e.preventDefault(),e.stopPropagation(),this.replaceClient(this.props.serverConfig),this.setState({busy:!1,doingUIAuth:!1})}),x()(this,"makeRegisterRequest",e=>{let t=Boolean(this.state.formVals.email);this.state.formVals.password||(t=null);const s={username:this.state.formVals.username,password:this.state.formVals.password,initial_device_display_name:this.props.defaultDeviceDisplayName,auth:void 0,inhibit_login:void 0};return e&&(s.auth=e),null!=t&&(s.inhibit_login=t),this.state.matrixClient.registerRequest(s)}),x()(this,"onLoginClickWithCheck",async e=>{e.preventDefault();const t=await ki.h({ignoreGuest:!0});return t||this.props.onLoginClick(),t}),this.state={busy:!1,errorText:null,formVals:{email:this.props.email},doingUIAuth:Boolean(this.props.sessionId),flows:null,completedNoSignin:!1,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""};const{hsUrl:t,isUrl:s}=this.props.serverConfig;this.loginLogic=new qn.b(t,s,null,{defaultDeviceDisplayName:"Element login check"})}componentDidMount(){this.replaceClient(this.props.serverConfig)}UNSAFE_componentWillReceiveProps(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this.replaceClient(e.serverConfig)}async replaceClient(e){this.setState({errorText:null,serverDeadError:null,serverErrorIsFatal:!1,busy:!0});try{await Hn.b.validateServerConfigWithStaticUrls(e.hsUrl,e.isUrl),this.setState({serverIsAlive:!0,serverErrorIsFatal:!1})}catch(e){if(this.setState(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?Oi(Object(s),!0).forEach((function(t){x()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):Oi(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({busy:!1},Hn.b.authComponentStateForError(e,"register"))),this.state.serverErrorIsFatal)return}const{hsUrl:t,isUrl:s}=e,n=Object(Ci.createClient)({baseUrl:t,idBaseUrl:s});let i;this.loginLogic.setHomeserverUrl(t),this.loginLogic.setIdentityServerUrl(s);try{i=(await this.loginLogic.getFlows()).find(e=>"m.login.sso"===e.type||"m.login.cas"===e.type)}catch(e){console.error("Failed to get login flows to check for SSO support",e)}this.setState({matrixClient:n,ssoFlow:i,busy:!1});const o=e=>{this.setState({errorText:Object(c.a)("Unable to query for supported registration methods."),flows:[]})};try{this.state.doingUIAuth||(await this.makeRegisterRequest(null),console.log("Expecting 401 from register request but got success!"))}catch(e){401===e.httpStatus?this.setState({flows:e.data.flows}):403===e.httpStatus||"M_FORBIDDEN"===e.errcode?i?u.a.dispatch({action:"start_login"}):this.setState({serverErrorIsFatal:!0,errorText:Object(c.a)("Registration has been disabled on this homeserver."),flows:[]}):(console.log("Unable to query for supported registration methods.",e),o())}}setupPushers(){if(!this.props.brand)return Promise.resolve();const e=le.a.get();return e.getPushers().then(t=>{const s=t.pushers;for(let t=0;t<s.length;++t)if("email"===s[t].kind){const n=s[t];n.data={brand:this.props.brand},e.setPusher(n).then(()=>{console.log("Set email branding to "+this.props.brand)},e=>{console.error("Couldn't set email branding: "+e)})}},e=>{console.error("Couldn't get pushers: "+e)})}getUIAuthInputs(){return{emailAddress:this.state.formVals.email,phoneCountry:this.state.formVals.phoneCountry,phoneNumber:this.state.formVals.phoneNumber}}renderRegisterComponent(){const e=d.getComponent("structures.InteractiveAuth"),t=d.getComponent("elements.Spinner"),s=d.getComponent("auth.RegistrationForm");if(this.state.matrixClient&&this.state.doingUIAuth)return a.a.createElement(e,{matrixClient:this.state.matrixClient,makeRequest:this.makeRegisterRequest,onAuthFinished:this.onUIAuthFinished,inputs:this.getUIAuthInputs(),requestEmailToken:this.requestEmailToken,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.idSid,poll:!0});if(!this.state.matrixClient&&!this.state.busy)return null;if(this.state.busy||!this.state.flows)return a.a.createElement("div",{className:"mx_AuthBody_spinner"},a.a.createElement(t,null));if(this.state.flows.length){let e;if(this.state.ssoFlow){let t;(this.state.ssoFlow.identity_providers||[]).length>1&&(t=a.a.createElement("h3",{className:"mx_AuthBody_centered"},Object(c.a)("Continue with %(ssoButtons)s",{ssoButtons:""}).trim())),e=a.a.createElement(a.a.Fragment,null,t,a.a.createElement(hi,{matrixClient:this.loginLogic.createTemporaryClient(),flow:this.state.ssoFlow,loginType:"m.login.sso"===this.state.ssoFlow.type?"sso":"cas",fragmentAfterLogin:this.props.fragmentAfterLogin}),a.a.createElement("h3",{className:"mx_AuthBody_centered"},Object(c.a)("%(ssoButtons)s Or %(usernamePassword)s",{ssoButtons:"",usernamePassword:""}).trim()))}return a.a.createElement(a.a.Fragment,null,e,a.a.createElement(s,{defaultUsername:this.state.formVals.username,defaultEmail:this.state.formVals.email,defaultPhoneCountry:this.state.formVals.phoneCountry,defaultPhoneNumber:this.state.formVals.phoneNumber,defaultPassword:this.state.formVals.password,onRegisterClick:this.onFormSubmit,flows:this.state.flows,serverConfig:this.props.serverConfig,canSubmit:!this.state.serverErrorIsFatal}))}}render(){const e=d.getComponent("auth.AuthHeader"),t=d.getComponent("auth.AuthBody"),s=d.getComponent("elements.AccessibleButton");let n;const i=this.state.errorText;let o;if(i&&(n=a.a.createElement("div",{className:"mx_Login_error"},i)),!this.state.serverIsAlive){const e=M()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});o=a.a.createElement("div",{className:e},this.state.serverDeadError)}const r=a.a.createElement("span",{className:"mx_AuthBody_changeFlow"},Object(c.a)("Already have an account? <a>Sign in here</a>",{},{a:e=>a.a.createElement("a",{onClick:this.onLoginClick,href:"#"},e)}));let l,h;if(this.state.doingUIAuth&&(l=a.a.createElement("a",{className:"mx_AuthBody_changeFlow",onClick:this.onGoToFormClicked,href:"#"},Object(c.a)("Go back"))),this.state.completedNoSignin){let e;e=this.state.differentLoggedInUserId?a.a.createElement("div",null,a.a.createElement("p",null,Object(c.a)("Your new account (%(newAccountId)s) is registered, but you're already logged into a different account (%(loggedInUserId)s).",{newAccountId:this.state.registeredUsername,loggedInUserId:this.state.differentLoggedInUserId})),a.a.createElement("p",null,a.a.createElement(s,{element:"span",className:"mx_linkButton",onClick:async e=>{await this.onLoginClickWithCheck(e)&&u.a.dispatch({action:"view_welcome_page"})}},Object(c.a)("Continue with previous account")))):this.state.formVals.password?a.a.createElement("h3",null,Object(c.a)("<a>Log in</a> to your new account.",{},{a:e=>a.a.createElement("a",{href:"#/login",onClick:this.onLoginClickWithCheck},e)})):a.a.createElement("h3",null,Object(c.a)("You can now close this window or <a>log in</a> to your new account.",{},{a:e=>a.a.createElement("a",{href:"#/login",onClick:this.onLoginClickWithCheck},e)})),h=a.a.createElement("div",null,a.a.createElement("h2",null,Object(c.a)("Registration Successful")),e)}else h=a.a.createElement("div",null,a.a.createElement("h2",null,Object(c.a)("Create account")),n,o,a.a.createElement(yi,{title:Object(c.a)("Host account on"),dialogTitle:Object(c.a)("Decide where your account is hosted"),serverConfig:this.props.serverConfig,onServerConfigChange:this.state.doingUIAuth?void 0:this.props.onServerConfigChange}),this.renderRegisterComponent(),l,r);return a.a.createElement($n,null,a.a.createElement(e,null),a.a.createElement(t,null,h))}})||wi;var Ii,xi=s(255);const Ti=1,ji=2,Ni=3,Pi=4,Di=5,Ai={"m.login.password":ji,"m.login.cas":Ni,"m.login.sso":Pi};let Mi=Object(P.a)("structures.auth.SoftLogout")(Ii=class extends a.a.Component{constructor(e){super(e),x()(this,"onClearAll",()=>{const e=d.getComponent("dialogs.ConfirmWipeDeviceDialog");Le.a.createTrackedDialog("Clear Data","Soft Logout",e,{onFinished:e=>{e&&(console.log("Clearing data from soft-logged-out session"),ki.i())}})}),x()(this,"onPasswordChange",e=>{this.setState({password:e.target.value})}),x()(this,"onForgotPassword",()=>{u.a.dispatch({action:"start_password_recovery"})}),x()(this,"onPasswordLogin",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});const t=le.a.get().getHomeserverUrl(),s=le.a.get().getIdentityServerUrl(),n={identifier:{type:"m.id.user",user:le.a.get().getUserId()},password:this.state.password,device_id:le.a.get().getDeviceId()};let i=null;try{i=await Object(qn.c)(t,s,"m.login.password",n)}catch(e){let t=Object(c.a)("Failed to re-authenticate due to a homeserver problem");return"M_FORBIDDEN"!==e.errcode||401!==e.httpStatus&&403!==e.httpStatus||(t=Object(c.a)("Incorrect password")),void this.setState({busy:!1,errorText:t})}ki.e(i).catch(e=>{console.error(e),this.setState({busy:!1,errorText:Object(c.a)("Failed to re-authenticate")})})}),this.state={loginView:Ti,keyBackupNeeded:!0,busy:!1,password:"",errorText:"",flows:[]}}componentDidMount(){if(!ki.g())return void u.a.dispatch({action:"start_login"});this.initLogin();const e=le.a.get();e.isCryptoEnabled()&&e.countSessionsNeedingBackup().then(e=>{this.setState({keyBackupNeeded:e>0})})}async initLogin(){const e=this.props.realQueryParams;if(e&&e.loginToken)return this.setState({loginView:Ti}),void this.trySsoLogin();const t=le.a.get(),s=(await t.loginFlows()).flows,n=s.map(e=>Ai[e.type]).filter(e=>!!e)[0]||Di;this.setState({flows:s,loginView:n})}async trySsoLogin(){this.setState({busy:!0});const e=localStorage.getItem(xi.a),t=localStorage.getItem(xi.c)||le.a.get().getIdentityServerUrl(),s={token:this.props.realQueryParams.loginToken,device_id:le.a.get().getDeviceId()};let n=null;try{n=await Object(qn.c)(e,t,"m.login.token",s)}catch(e){return console.error(e),void this.setState({busy:!1,loginView:Di})}ki.e(n).then(()=>{this.props.onTokenLoginCompleted&&this.props.onTokenLoginCompleted()}).catch(e=>{console.error(e),this.setState({busy:!1,loginView:Di})})}renderSignInSection(){if(this.state.loginView===Ti){const e=d.getComponent("elements.Spinner");return a.a.createElement(e,null)}let e=null;if(this.state.keyBackupNeeded&&(e=Object(c.a)("Regain access to your account and recover encryption keys stored in this session. Without them, you won’t be able to read all of your secure messages in any session.")),this.state.loginView===ji){const t=d.getComponent("elements.Field"),s=d.getComponent("elements.AccessibleButton");let n=null;return this.state.errorText&&(n=a.a.createElement("span",{className:"mx_Login_error"},this.state.errorText)),e||(e=Object(c.a)("Enter your password to sign in and regain access to your account.")),a.a.createElement("form",{onSubmit:this.onPasswordLogin},a.a.createElement("p",null,e),n,a.a.createElement(t,{type:"password",label:Object(c.a)("Password"),onChange:this.onPasswordChange,value:this.state.password,disabled:this.state.busy}),a.a.createElement(s,{onClick:this.onPasswordLogin,kind:"primary",type:"submit",disabled:this.state.busy},Object(c.a)("Sign In")),a.a.createElement(s,{onClick:this.onForgotPassword,kind:"link"},Object(c.a)("Forgotten your password?")))}if(this.state.loginView===Pi||this.state.loginView===Ni){e||(e=Object(c.a)("Sign in and regain access to your account."));const t=this.state.loginView===Ni?"cas":"sso",s=this.state.flows.find(e=>e.type==="m.login."+t);return a.a.createElement("div",null,a.a.createElement("p",null,e),a.a.createElement(hi,{matrixClient:le.a.get(),flow:s,loginType:t,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!this.state.flows.find(e=>"m.login.password"===e.type)}))}return a.a.createElement("p",null,Object(c.a)("You cannot sign in to your account. Please contact your homeserver admin for more information."))}render(){const e=d.getComponent("auth.AuthHeader"),t=d.getComponent("auth.AuthBody"),s=d.getComponent("elements.AccessibleButton");return a.a.createElement($n,null,a.a.createElement(e,null),a.a.createElement(t,null,a.a.createElement("h2",null,Object(c.a)("You're signed out")),a.a.createElement("h3",null,Object(c.a)("Sign in")),a.a.createElement("div",null,this.renderSignInSection()),a.a.createElement("h3",null,Object(c.a)("Clear personal data")),a.a.createElement("p",null,Object(c.a)("Warning: Your personal data (including encryption keys) is still stored in this session. Clear it if you're finished using this session, or want to sign in to another account.")),a.a.createElement("div",null,a.a.createElement(s,{onClick:this.onClearAll,kind:"danger"},Object(c.a)("Clear all data")))))}})||Ii;var Ui=s(209),Li=s(257),Fi=s(633),Bi=s(192);const Vi=Object(Ts.a)({rules:[{key:"email",test:({value:e})=>!e||zn.a(e),invalid:()=>Object(c.a)("Doesn't look like a valid email address")}]});var Ki,Wi,Gi,qi,Hi=({onFinished:e})=>{const[t,s]=Object(o.useState)(""),n=Object(o.useRef)(),i=async s=>{if(s.preventDefault(),t){if(!await n.current.validate({allowEmpty:!1}))return n.current.focus(),void n.current.validate({allowEmpty:!1,focused:!0})}e(!0,t)};return o.createElement(Ze.a,{title:Object(c.a)("Continuing without email"),className:"mx_RegistrationEmailPromptDialog",contentId:"mx_RegistrationEmailPromptDialog",onFinished:()=>e(!1),fixedWidth:!1},o.createElement("div",{className:"mx_Dialog_content",id:"mx_RegistrationEmailPromptDialog"},o.createElement("p",null,Object(c.a)("Just a heads up, if you don't add an email and forget your password, you could <b>permanently lose access to your account</b>.",{},{b:e=>o.createElement("b",null,e)})),o.createElement("form",{onSubmit:i},o.createElement(Ue.a,{ref:n,autoFocus:!0,type:"text",label:Object(c.a)("Email (optional)"),value:t,onChange:e=>{s(e.target.value)},onValidate:async e=>await Vi(e),onFocus:()=>E.a.instance.track("onboarding_registration_email2_focus"),onBlur:()=>E.a.instance.track("onboarding_registration_email2_blur")}))),o.createElement(Bi.a,{primaryButton:Object(c.a)("Continue"),onPrimaryButtonClick:i,hasCancel:!1}))};!function(e){e.Email="field_email",e.PhoneNumber="field_phone_number",e.Username="field_username",e.Password="field_password",e.PasswordConfirm="field_password_confirm"}(qi||(qi={}));let $i=Object(P.a)("views.auth.RegistrationForm")((Gi=Wi=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"onSubmit",async e=>{if(e.preventDefault(),e.persist(),!this.props.canSubmit)return;if(await this.verifyFieldsBeforeSubmit())if(""===this.state.email){if(!this.showEmail())return void this.doSubmit(e);E.a.instance.track("onboarding_registration_submit_warn"),Le.a.createTrackedDialog("Email prompt dialog","",Hi,{onFinished:async(t,s)=>{t&&this.setState({email:s},()=>{this.doSubmit(e)})}})}else this.doSubmit(e);else E.a.instance.track("onboarding_registration_submit_failed")}),x()(this,"onEmailChange",e=>{this.setState({email:e.target.value})}),x()(this,"onEmailValidate",async e=>{const t=await this.validateEmailRules(e);return this.markFieldValid(qi.Email,t.valid),t}),x()(this,"validateEmailRules",Object(Ts.a)({description:()=>Object(c.a)("Use an email address to recover your account"),hideDescriptionIfValid:!0,rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this.authStepIsRequired("m.login.email.identity")||!!e},invalid:()=>Object(c.a)("Enter email address (required on this homeserver)")},{key:"email",test:({value:e})=>!e||zn.a(e),invalid:()=>Object(c.a)("Doesn't look like a valid email address")}]})),x()(this,"onPasswordChange",e=>{this.setState({password:e.target.value})}),x()(this,"onPasswordValidate",e=>{this.markFieldValid(qi.Password,e.valid)}),x()(this,"onPasswordConfirmChange",e=>{this.setState({passwordConfirm:e.target.value})}),x()(this,"onPasswordConfirmValidate",async e=>{const t=await this.validatePasswordConfirmRules(e);return this.markFieldValid(qi.PasswordConfirm,t.valid),t}),x()(this,"validatePasswordConfirmRules",Object(Ts.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Confirm password")},{key:"match",test({value:e}){return!e||e===this.state.password},invalid:()=>Object(c.a)("Passwords don't match")}]})),x()(this,"onPhoneCountryChange",e=>{this.setState({phoneCountry:e.iso2})}),x()(this,"onPhoneNumberChange",e=>{this.setState({phoneNumber:e.target.value})}),x()(this,"onPhoneNumberValidate",async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(qi.PhoneNumber,t.valid),t}),x()(this,"validatePhoneNumberRules",Object(Ts.a)({description:()=>Object(c.a)("Other users can invite you to rooms using your contact details"),hideDescriptionIfValid:!0,rules:[{key:"required",test({value:e,allowEmpty:t}){return t||!this.authStepIsRequired("m.login.msisdn")||!!e},invalid:()=>Object(c.a)("Enter phone number (required on this homeserver)")},{key:"email",test:({value:e})=>{return!e||(t=e,Yn.test(t));var t},invalid:()=>Object(c.a)("That phone number doesn't look quite right, please check and try again")}]})),x()(this,"onUsernameChange",e=>{this.setState({username:e.target.value})}),x()(this,"onUsernameValidate",async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(qi.Username,t.valid),t}),x()(this,"validateUsernameRules",Object(Ts.a)({description:()=>Object(c.a)("Use lowercase letters, numbers, dashes and underscores only"),hideDescriptionIfValid:!0,rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Enter username")},{key:"safeLocalpart",test:({value:e})=>!e||Fi.a.test(e),invalid:()=>Object(c.a)("Some characters not allowed")}]})),this.state={fieldValid:{},phoneCountry:this.props.defaultPhoneCountry,username:this.props.defaultUsername||"",email:this.props.defaultEmail||"",phoneNumber:this.props.defaultPhoneNumber||"",password:this.props.defaultPassword||"",passwordConfirm:this.props.defaultPassword||"",passwordComplexity:null},E.a.instance.track("onboarding_registration_begin")}doSubmit(e){const t=this.state.email.trim();E.a.instance.track("onboarding_registration_submit_ok",{email:!!t});const s=this.props.onRegisterClick({username:this.state.username.trim(),password:this.state.password.trim(),email:t,phoneCountry:this.state.phoneCountry,phoneNumber:this.state.phoneNumber});s&&(e.target.disabled=!0,s.finally((function(){e.target.disabled=!1})))}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[qi.Username,qi.Password,qi.PasswordConfirm,qi.Email,qi.PhoneNumber];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const s=this.findFirstInvalidField(t);return!s||(s.focus(),s.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){const e=Object.keys(this.state.fieldValid);for(let t=0;t<e.length;++t)if(!this.state.fieldValid[e[t]])return!1;return!0}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:s}=this.state;s[e]=t,this.setState({fieldValid:s})}authStepIsRequired(e){return this.props.flows.every(t=>t.stages.includes(e))}authStepIsUsed(e){return this.props.flows.some(t=>t.stages.includes(e))}showEmail(){return!!this.authStepIsUsed("m.login.email.identity")}showPhoneNumber(){return!(l.a.get().disable_3pid_login||!this.authStepIsUsed("m.login.msisdn"))}renderEmail(){if(!this.showEmail())return null;const e=this.authStepIsRequired("m.login.email.identity")?Object(c.a)("Email"):Object(c.a)("Email (optional)");return a.a.createElement(Ue.a,{ref:e=>this[qi.Email]=e,type:"text",label:e,value:this.state.email,onChange:this.onEmailChange,onValidate:this.onEmailValidate,onFocus:()=>E.a.instance.track("onboarding_registration_email_focus"),onBlur:()=>E.a.instance.track("onboarding_registration_email_blur")})}renderPassword(){return a.a.createElement(Li.a,{id:"mx_RegistrationForm_password",fieldRef:e=>this[qi.Password]=e,minScore:3,value:this.state.password,onChange:this.onPasswordChange,onValidate:this.onPasswordValidate,onFocus:()=>E.a.instance.track("onboarding_registration_password_focus"),onBlur:()=>E.a.instance.track("onboarding_registration_password_blur")})}renderPasswordConfirm(){return a.a.createElement(Ue.a,{id:"mx_RegistrationForm_passwordConfirm",ref:e=>this[qi.PasswordConfirm]=e,type:"password",autoComplete:"new-password",label:Object(c.a)("Confirm password"),value:this.state.passwordConfirm,onChange:this.onPasswordConfirmChange,onValidate:this.onPasswordConfirmValidate,onFocus:()=>E.a.instance.track("onboarding_registration_passwordConfirm_focus"),onBlur:()=>E.a.instance.track("onboarding_registration_passwordConfirm_blur")})}renderPhoneNumber(){if(!this.showPhoneNumber())return null;const e=d.getComponent("views.auth.CountryDropdown"),t=this.authStepIsRequired("m.login.msisdn")?Object(c.a)("Phone"):Object(c.a)("Phone (optional)"),s=a.a.createElement(e,{value:this.state.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChange});return a.a.createElement(Ue.a,{ref:e=>this[qi.PhoneNumber]=e,type:"text",label:t,value:this.state.phoneNumber,prefixComponent:s,onChange:this.onPhoneNumberChange,onValidate:this.onPhoneNumberValidate})}renderUsername(){return a.a.createElement(Ue.a,{id:"mx_RegistrationForm_username",ref:e=>this[qi.Username]=e,type:"text",autoFocus:!0,label:Object(c.a)("Username"),placeholder:Object(c.a)("Username").toLocaleLowerCase(),value:this.state.username,onChange:this.onUsernameChange,onValidate:this.onUsernameValidate,onFocus:()=>E.a.instance.track("onboarding_registration_username_focus"),onBlur:()=>E.a.instance.track("onboarding_registration_username_blur")})}render(){const e=a.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(c.a)("Register"),disabled:!this.props.canSubmit});let t=null;return this.showEmail()&&(t=this.showPhoneNumber()?a.a.createElement("div",null,Object(c.a)("Add an email to be able to reset your password.")," ",Object(c.a)("Use email or phone to optionally be discoverable by existing contacts.")):a.a.createElement("div",null,Object(c.a)("Add an email to be able to reset your password.")," ",Object(c.a)("Use email to optionally be discoverable by existing contacts."))),a.a.createElement("div",null,a.a.createElement("form",{onSubmit:this.onSubmit},a.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderUsername()),a.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPassword(),this.renderPasswordConfirm()),a.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderEmail(),this.renderPhoneNumber()),t,e))}},x()(Wi,"defaultProps",{onValidationChange:console.error,canSubmit:!0}),Ki=Gi))||Ki;var zi,Yi=s(171),Ji=s(419),Qi=s(699),Xi=s(700),Zi=s(352),eo=s(446),to=s(554),so=s(437),no=s(639),io=s(679);let oo=Object(P.a)("views.dialogs.ConfirmAndWaitRedactDialog")(zi=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"onParentFinished",async e=>{if(e){this.setState({isRedacting:!0});try{await this.props.redact(),this.props.onFinished(!0)}catch(e){const t=e.errcode||e.statusCode;void 0!==t?this.setState({redactionErrorCode:t}):this.props.onFinished(!0)}}else this.props.onFinished(!1)}),this.state={isRedacting:!1,redactionErrorCode:null}}render(){if(this.state.isRedacting){if(this.state.redactionErrorCode){const e=d.getComponent("dialogs.ErrorDialog"),t=this.state.redactionErrorCode;return a.a.createElement(e,{onFinished:this.props.onFinished,title:Object(c.a)("Error"),description:Object(c.a)("You cannot delete this message. (%(code)s)",{code:t})})}{const e=d.getComponent("dialogs.BaseDialog"),t=d.getComponent("elements.Spinner");return a.a.createElement(e,{onFinished:this.props.onFinished,hasCancel:!1,title:Object(c.a)("Removing…")},a.a.createElement(t,null))}}{const e=d.getComponent("dialogs.ConfirmRedactDialog");return a.a.createElement(e,{onFinished:this.onParentFinished})}}})||zi;var ao;let ro=Object(P.a)("views.dialogs.ConfirmRedactDialog")(ao=class extends a.a.Component{render(){const e=d.getComponent("views.dialogs.TextInputDialog");return a.a.createElement(e,{onFinished:this.props.onFinished,title:Object(c.a)("Confirm Removal"),description:Object(c.a)("Are you sure you wish to remove (delete) this event? Note that if you delete a room name or topic change, it could undo the change."),placeholder:Object(c.a)("Reason (optional)"),focus:!0,button:Object(c.a)("Remove")})}})||ao;var co,lo=s(664);let uo=Object(P.a)("views.dialogs.ConfirmWipeDeviceDialog")(co=class extends a.a.Component{constructor(...e){super(...e),x()(this,"onConfirm",()=>{this.props.onFinished(!0)}),x()(this,"onDecline",()=>{this.props.onFinished(!1)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return a.a.createElement(e,{className:"mx_ConfirmWipeDeviceDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Clear all data in this session?")},a.a.createElement("div",{className:"mx_ConfirmWipeDeviceDialog_content"},a.a.createElement("p",null,Object(c.a)("Clearing all data from this session is permanent. Encrypted messages will be lost unless their keys have been backed up."))),a.a.createElement(t,{primaryButton:Object(c.a)("Clear all data"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:Object(c.a)("Cancel"),onCancel:this.onDecline}))}})||co;var ho,mo=s(636);let po=Object(P.a)("views.dialogs.CreateGroupDialog")(ho=class extends a.a.Component{constructor(...e){super(...e),x()(this,"state",{groupName:"",groupId:"",groupIdError:"",creating:!1,createError:null}),x()(this,"onGroupNameChange",e=>{this.setState({groupName:e.currentTarget.value})}),x()(this,"onGroupIdChange",e=>{this.setState({groupId:e.currentTarget.value})}),x()(this,"onGroupIdBlur",()=>{this.checkGroupId()}),x()(this,"onFormSubmit",e=>{if(e.preventDefault(),this.checkGroupId())return;const t={};""!==this.state.groupName&&(t.name=this.state.groupName),this.setState({creating:!0}),le.a.get().createGroup({localpart:this.state.groupId,profile:t}).then(e=>{u.a.dispatch({action:"view_group",group_id:e.group_id,group_is_new:!0}),this.props.onFinished(!0)}).catch(e=>{this.setState({createError:e})}).finally(()=>{this.setState({creating:!1})})}),x()(this,"_onCancel",()=>{this.props.onFinished(!1)})}checkGroupId(){let e=null;return this.state.groupId?/^[a-z0-9=_\-./]*$/.test(this.state.groupId)||(e=Object(c.a)("Community IDs may only contain characters a-z, 0-9, or '=_-./'")):e=Object(c.a)("Community IDs cannot be empty."),this.setState({groupIdError:e,createError:null}),e}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("elements.Spinner");if(this.state.creating)return a.a.createElement(t,null);let s;return this.state.createError&&(s=a.a.createElement("div",{className:"error",role:"alert"},a.a.createElement("div",null,Object(c.a)("Something went wrong whilst creating your community")),a.a.createElement("div",null,this.state.createError.message))),a.a.createElement(e,{className:"mx_CreateGroupDialog",onFinished:this.props.onFinished,title:Object(c.a)("Create Community")},a.a.createElement("form",{onSubmit:this.onFormSubmit},a.a.createElement("div",{className:"mx_Dialog_content"},a.a.createElement("div",{className:"mx_CreateGroupDialog_inputRow"},a.a.createElement("div",{className:"mx_CreateGroupDialog_label"},a.a.createElement("label",{htmlFor:"groupname"},Object(c.a)("Community Name"))),a.a.createElement("div",null,a.a.createElement("input",{id:"groupname",className:"mx_CreateGroupDialog_input",autoFocus:!0,size:64,placeholder:Object(c.a)("Example"),onChange:this.onGroupNameChange,value:this.state.groupName}))),a.a.createElement("div",{className:"mx_CreateGroupDialog_inputRow"},a.a.createElement("div",{className:"mx_CreateGroupDialog_label"},a.a.createElement("label",{htmlFor:"groupid"},Object(c.a)("Community ID"))),a.a.createElement("div",{className:"mx_CreateGroupDialog_input_group"},a.a.createElement("span",{className:"mx_CreateGroupDialog_prefix"},"+"),a.a.createElement("input",{id:"groupid",className:"mx_CreateGroupDialog_input mx_CreateGroupDialog_input_hasPrefixAndSuffix",size:32,placeholder:Object(c.a)("example"),onChange:this.onGroupIdChange,onBlur:this.onGroupIdBlur,value:this.state.groupId}),a.a.createElement("span",{className:"mx_CreateGroupDialog_suffix"},":",le.a.get().getDomain()))),a.a.createElement("div",{className:"error"},this.state.groupIdError),s),a.a.createElement("div",{className:"mx_Dialog_buttons"},a.a.createElement("input",{type:"submit",value:Object(c.a)("Create"),className:"mx_Dialog_primary"}),a.a.createElement("button",{onClick:this._onCancel},Object(c.a)("Cancel")))))}})||ho;var go=s(676),vo=e=>{const t=l.a.get().brand,s=Object(c.a)("You've previously used a newer version of %(brand)s with this session. To use this version again with end to end encryption, you will need to sign out and back in again.",{brand:t}),n=d.getComponent("views.dialogs.BaseDialog"),i=d.getComponent("views.elements.DialogButtons");return a.a.createElement(n,{className:"mx_CryptoStoreTooNewDialog",contentId:"mx_Dialog_content",title:Object(c.a)("Incompatible Database"),hasCancel:!1,onFinished:e.onFinished},a.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},s),a.a.createElement(i,{primaryButton:Object(c.a)("Continue With Encryption Disabled"),hasCancel:!1,onPrimaryButtonClick:e.onFinished},a.a.createElement("button",{onClick:()=>{const s=d.getComponent("dialogs.QuestionDialog");Le.a.createTrackedDialog("Logout e2e db too new","",s,{title:Object(c.a)("Sign out"),description:Object(c.a)("To avoid losing your chat history, you must export your room keys before logging out. You will need to go back to the newer version of %(brand)s to do this",{brand:t}),button:Object(c.a)("Sign out"),focus:!1,onFinished:t=>{t&&(u.a.dispatch({action:"logout"}),e.onFinished(!0))}})}},Object(c.a)("Sign out"))))},fo=s(627),bo=s(450),yo=s(591),_o=s(351),Eo=s(608),So=s(1275);const wo=["sub","sup","del","u"],Co=["text","softbreak","linebreak","paragraph","document"];function ko(e){if(null!=e.literal&&null!=e.literal.match('^<((div|span) data-mx-maths="[^"]*"|/(div|span))>$'))return!0;const t=/^<\/?(.*)>$/.exec(e.literal);if(t&&2==t.length){const e=t[1];return wo.indexOf(e)>-1}return!1}function Oo(e){ko(e)?this.lit(e.literal):this.lit(Object(li.escape)(e.literal))}function Ro(e){let t=e;for(;t.parent;)t=t.parent;return t.firstChild!=t.lastChild}class Io{constructor(e){this.input=e;const t=new So.Parser;this.parsed=t.parse(this.input)}isPlainText(){const e=this.parsed.walker();let t;for(;t=e.next();){const e=t.node;if(!(Co.indexOf(e.type)>-1)){if("html_inline"!=e.type&&"html_block"!=e.type)return!1;if(ko(e))return!1}}return!0}toHTML({externalLinks:e=!1}={}){const t=new So.HtmlRenderer({safe:!1,softbreak:"<br />"}),s=t.paragraph;return t.paragraph=function(e,t){Ro(e)&&s.call(this,e,t)},t.link=function(t,s){const n=this.attrs(t);s?(n.push(["href",this.esc(t.destination)]),t.title&&n.push(["title",this.esc(t.title)]),e&&(n.push(["target","_blank"]),n.push(["rel","noreferrer noopener"])),this.tag("a",n)):this.tag("/a")},t.html_inline=Oo,t.html_block=function(e){Oo.call(this,e)},t.render(this.parsed)}toPlaintext(){const e=new So.HtmlRenderer({safe:!1});e.paragraph;return e.paragraph=function(e,t){Ro(e)&&!t&&e.next&&this.lit("\n\n")},e.html_block=function(e){this.lit(e.literal),Ro(e)&&e.next&&this.lit("\n\n")},e.render(this.parsed)}}var xo;const To=["org.matrix.msc3215.room.moderation.moderated_by"];var jo,No;!function(e){e.DISAGREEMENT="org.matrix.msc3215.abuse.nature.disagreement",e.TOXIC="org.matrix.msc3215.abuse.nature.toxic",e.ILLEGAL="org.matrix.msc3215.abuse.nature.illegal",e.SPAM="org.matrix.msc3215.abuse.nature.spam",e.OTHER="org.matrix.msc3215.abuse.nature.other"}(jo||(jo={})),function(e){e.ADMIN="non-standard.abuse.nature.admin"}(No||(No={}));let Po=Object(P.a)("views.dialogs.ReportEventDialog")(xo=class extends a.a.Component{constructor(e){super(e),x()(this,"moderation",void 0),x()(this,"onReasonChange",({target:{value:e}})=>{this.setState({reason:e})}),x()(this,"onNatureChosen",e=>{this.setState({nature:e.currentTarget.value})}),x()(this,"onCancel",()=>{this.props.onFinished(!1)}),x()(this,"onSubmit",async()=>{let e=this.state.reason||"";if(e=e.trim(),this.moderation){if(!this.state.nature||(this.state.nature==jo.OTHER||this.state.nature==No.ADMIN)&&!e)return void this.setState({err:Object(c.a)("Please fill why you're reporting.")})}else if(!e)return void this.setState({err:Object(c.a)("Please fill why you're reporting.")});this.setState({busy:!0,err:null});try{const e=le.a.get(),t=this.props.mxEvent;if(this.moderation&&this.state.nature!=No.ADMIN){const s=this.state.nature,n=await Object(Rs.c)(e,this.moderation.moderationBotUserId);await e.sendEvent(n,"org.matrix.msc3215.abuse.report",{event_id:t.getId(),room_id:t.getRoomId(),moderated_by_id:this.moderation.moderationRoomId,nature:s,reporter:e.getUserId(),comment:this.state.reason.trim()})}else await e.reportEvent(t.getRoomId(),t.getId(),-100,this.state.reason.trim());this.props.onFinished(!0)}catch(e){this.setState({busy:!1,err:e.message})}});let t=null,s=null;if(V.b.getValue("feature_report_to_moderators")){const n=le.a.get().getRoom(e.mxEvent.getRoomId());for(const e of To){const i=n.currentState.getStateEvents(e,e);if(!i)continue;if(Array.isArray(i))throw new TypeError(`getStateEvents(${e}, ${e}) should return at most one state event`);const o=i.event;if(!("content"in o)||"object"!=typeof o.content){console.debug("Moderation error","state event",e,"should have an object field `content`, got",o);continue}const a=o.content;"room_id"in a&&"string"==typeof a.room_id?"user_id"in a&&"string"==typeof a.user_id?(t=a.room_id,s=a.user_id):console.debug("Moderation error","state event",e,"should have a string field `content.user_id`, got",o):console.debug("Moderation error","state event",e,"should have a string field `content.room_id`, got",o)}t&&s&&(this.moderation={moderationRoomId:t,moderationBotUserId:s})}this.state={reason:"",busy:!1,err:null,nature:null}}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=d.getComponent("elements.Spinner"),n=d.getComponent("elements.Field");let i=null;this.state.err&&(i=a.a.createElement("div",{className:"error"},this.state.err));let o=null;this.state.busy&&(o=a.a.createElement("div",{className:"progress"},a.a.createElement(s,null)));const r=l.a.get().reportEvent&&l.a.get().reportEvent.adminMessageMD;let u;if(r){const e=new Io(r).toHTML({externalLinks:!0});u=a.a.createElement("p",{dangerouslySetInnerHTML:{__html:e}})}if(this.moderation){const s=le.a.get(),r=l.a.get().validated_server_config.hsName;let d;switch(this.state.nature){case jo.DISAGREEMENT:d=Object(c.a)("What this user is writing is wrong.\nThis will be reported to the room moderators.");break;case jo.TOXIC:d=Object(c.a)("This user is displaying toxic behaviour, for instance by insulting other users or sharing  adult-only content in a family-friendly room  or otherwise violating the rules of this room.\nThis will be reported to the room moderators.");break;case jo.ILLEGAL:d=Object(c.a)("This user is displaying illegal behaviour, for instance by doxing people or threatening violence.\nThis will be reported to the room moderators who may escalate this to legal authorities.");break;case jo.SPAM:d=Object(c.a)("This user is spamming the room with ads, links to ads or to propaganda.\nThis will be reported to the room moderators.");break;case No.ADMIN:d=s.isRoomEncrypted(this.props.mxEvent.getRoomId())?Object(c.a)("This room is dedicated to illegal or toxic content or the moderators fail to moderate illegal or toxic content.\nThis will be reported to the administrators of %(homeserver)s. The administrators will NOT be able to read the encrypted content of this room.",{homeserver:r}):Object(c.a)("This room is dedicated to illegal or toxic content or the moderators fail to moderate illegal or toxic content.\n This will be reported to the administrators of %(homeserver)s.",{homeserver:r});break;case jo.OTHER:d=Object(c.a)("Any other reason. Please describe the problem.\nThis will be reported to the room moderators.");break;default:d=Object(c.a)("Please pick a nature and describe what makes this message abusive.")}return a.a.createElement(e,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:Object(c.a)("Report Content"),contentId:"mx_ReportEventDialog"},a.a.createElement("div",null,a.a.createElement(gi.a,{name:"nature",value:jo.DISAGREEMENT,checked:this.state.nature==jo.DISAGREEMENT,onChange:this.onNatureChosen},Object(c.a)("Disagree")),a.a.createElement(gi.a,{name:"nature",value:jo.TOXIC,checked:this.state.nature==jo.TOXIC,onChange:this.onNatureChosen},Object(c.a)("Toxic Behaviour")),a.a.createElement(gi.a,{name:"nature",value:jo.ILLEGAL,checked:this.state.nature==jo.ILLEGAL,onChange:this.onNatureChosen},Object(c.a)("Illegal Content")),a.a.createElement(gi.a,{name:"nature",value:jo.SPAM,checked:this.state.nature==jo.SPAM,onChange:this.onNatureChosen},Object(c.a)("Spam or propaganda")),a.a.createElement(gi.a,{name:"nature",value:No.ADMIN,checked:this.state.nature==No.ADMIN,onChange:this.onNatureChosen},Object(c.a)("Report the entire room")),a.a.createElement(gi.a,{name:"nature",value:jo.OTHER,checked:this.state.nature==jo.OTHER,onChange:this.onNatureChosen},Object(c.a)("Other")),a.a.createElement("p",null,d),a.a.createElement(n,{className:"mx_ReportEventDialog_reason",element:"textarea",label:Object(c.a)("Reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),o,i),a.a.createElement(t,{primaryButton:Object(c.a)("Send report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}return a.a.createElement(e,{className:"mx_ReportEventDialog",onFinished:this.props.onFinished,title:Object(c.a)("Report Content to Your Homeserver Administrator"),contentId:"mx_ReportEventDialog"},a.a.createElement("div",{className:"mx_ReportEventDialog",id:"mx_ReportEventDialog"},a.a.createElement("p",null,Object(c.a)("Reporting this message will send its unique 'event ID' to the administrator of your homeserver. If messages in this room are encrypted, your homeserver administrator will not be able to read the message text or view any files or images.")),u,a.a.createElement(n,{className:"mx_ReportEventDialog_reason",element:"textarea",label:Object(c.a)("Reason"),rows:5,onChange:this.onReasonChange,value:this.state.reason,disabled:this.state.busy}),o,i),a.a.createElement(t,{primaryButton:Object(c.a)("Send report"),onPrimaryButtonClick:this.onSubmit,focus:!0,onCancel:this.onCancel,disabled:this.state.busy}))}})||xo;var Do,Ao=s(722),Mo=s(690);let Uo=Object(P.a)("views.dialogs.SeshatResetDialog")(Do=class extends a.a.PureComponent{render(){return a.a.createElement(Ze.a,{hasCancel:!0,onFinished:this.props.onFinished.bind(null,!1),title:Object(c.a)("Reset event store?")},a.a.createElement("div",null,a.a.createElement("p",null,Object(c.a)("You most likely do not want to reset your event index store"),a.a.createElement("br",null),Object(c.a)("If you do, please note that none of your messages will be deleted, but the search experience might be degraded for a few moments whilst the index is recreated"))),a.a.createElement(Bi.a,{primaryButton:Object(c.a)("Reset event store"),onPrimaryButtonClick:this.props.onFinished.bind(null,!0),primaryButtonClass:"danger",cancelButton:Object(c.a)("Cancel"),onCancel:this.props.onFinished.bind(null,!1)}))}})||Do;var Lo,Fo=s(415),Bo=s(585),Vo=s(136),Ko=s.n(Vo),Wo=s(199);class Go extends a.a.PureComponent{constructor(...e){super(...e),x()(this,"onChange",e=>{this.props.onChange(this.props.url,e.currentTarget.checked)})}render(){return a.a.createElement("input",{type:"checkbox",onChange:this.onChange,checked:this.props.checked})}}let qo=Object(P.a)("views.dialogs.TermsDialog")(Lo=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),x()(this,"onNextClick",()=>{this.props.onFinished(!0,Object.keys(this.state.agreedUrls).filter(e=>this.state.agreedUrls[e]))}),x()(this,"onTermsCheckboxChange",(e,t)=>{this.setState({agreedUrls:Object.assign({},this.state.agreedUrls,{[e]:t})})}),this.state={agreedUrls:{}};for(const t of e.agreedUrls)this.state.agreedUrls[t]=!0}nameForServiceType(e,t){switch(e){case Wo.a.IS:return a.a.createElement("div",null,Object(c.a)("Identity Server"),a.a.createElement("br",null),"(",t,")");case Wo.a.IM:return a.a.createElement("div",null,Object(c.a)("Integration Manager"),a.a.createElement("br",null),"(",t,")")}}summaryForServiceType(e){switch(e){case Wo.a.IS:return a.a.createElement("div",null,Object(c.a)("Find others by phone or email"),a.a.createElement("br",null),Object(c.a)("Be found by phone or email"));case Wo.a.IM:return a.a.createElement("div",null,Object(c.a)("Use bots, bridges, widgets and sticker packs"))}}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=[];for(const e of this.props.policiesAndServicePairs){const t=Ko.a.parse(e.service.baseUrl),n=Object.values(e.policies);for(let i=0;i<n.length;++i){const o=n[i],r=Object(c.i)(Object.keys(o).filter(e=>"version"!==e));let l,d;0===i&&(l=this.nameForServiceType(e.service.serviceType,t.host),d=this.summaryForServiceType(e.service.serviceType)),s.push(a.a.createElement("tr",{key:o[r].url},a.a.createElement("td",{className:"mx_TermsDialog_service"},l),a.a.createElement("td",{className:"mx_TermsDialog_summary"},d),a.a.createElement("td",null,o[r].name,a.a.createElement("a",{rel:"noreferrer noopener",target:"_blank",href:o[r].url},a.a.createElement("span",{className:"mx_TermsDialog_link"}))),a.a.createElement("td",null,a.a.createElement(Go,{url:o[r].url,onChange:this.onTermsCheckboxChange,checked:Boolean(this.state.agreedUrls[o[r].url])}))))}}let n=!1;for(const e of this.props.policiesAndServicePairs){let t=0;for(const s of Object.values(e.policies)){let e=!1;for(const t of Object.keys(s))if("version"!==t&&this.state.agreedUrls[s[t].url]){e=!0;break}e&&++t}if(t===Object.keys(e.policies).length){n=!0;break}}return a.a.createElement(e,{fixedWidth:!1,onFinished:this.onCancelClick,title:Object(c.a)("Terms of Service"),contentId:"mx_Dialog_content",hasCancel:!1},a.a.createElement("div",{id:"mx_Dialog_content"},a.a.createElement("p",null,Object(c.a)("To continue you need to accept the terms of this service.")),a.a.createElement("table",{className:"mx_TermsDialog_termsTable"},a.a.createElement("tbody",null,a.a.createElement("tr",{className:"mx_TermsDialog_termsTableHeader"},a.a.createElement("th",null,Object(c.a)("Service")),a.a.createElement("th",null,Object(c.a)("Summary")),a.a.createElement("th",null,Object(c.a)("Document")),a.a.createElement("th",null,Object(c.a)("Accept"))),s))),a.a.createElement(t,{primaryButton:Object(c.a)("Next"),hasCancel:!0,onCancel:this.onCancelClick,onPrimaryButtonClick:this.onNextClick,primaryDisabled:!n}))}})||Lo;var Ho=s(595);const $o=["image/jpeg","image/gif","image/png","video/mp4","video/webm","video/ogg","audio/mp4","audio/webm","audio/aac","audio/mpeg","audio/ogg","audio/wave","audio/wav","audio/x-wav","audio/x-pn-wav","audio/flac","audio/x-flac"];function zo(e){return $o.includes(e)?e:"application/octet-stream"}var Yo,Jo,Qo;let Xo=Object(P.a)("views.dialogs.UploadConfirmDialog")((Qo=Jo=class extends a.a.Component{constructor(e){super(e),x()(this,"objectUrl",void 0),x()(this,"mimeType",void 0),x()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),x()(this,"onUploadClick",()=>{this.props.onFinished(!0)}),x()(this,"onUploadAllClick",()=>{this.props.onFinished(!0,!0)}),this.mimeType=zo(e.file.type);const t=new Blob([e.file],{type:this.mimeType});this.objectUrl=URL.createObjectURL(t)}componentWillUnmount(){this.objectUrl&&URL.revokeObjectURL(this.objectUrl)}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");let n,i,o;return n=this.props.totalFiles>1&&void 0!==this.props.currentIndex?Object(c.a)("Upload files (%(current)s of %(total)s)",{current:this.props.currentIndex+1,total:this.props.totalFiles}):Object(c.a)("Upload files"),i=this.mimeType.startsWith("image/")?a.a.createElement("div",{className:"mx_UploadConfirmDialog_previewOuter"},a.a.createElement("div",{className:"mx_UploadConfirmDialog_previewInner"},a.a.createElement("div",null,a.a.createElement("img",{className:"mx_UploadConfirmDialog_imagePreview",src:this.objectUrl})),a.a.createElement("div",null,this.props.file.name," (",Vn()(this.props.file.size),")"))):a.a.createElement("div",null,a.a.createElement("div",null,a.a.createElement("img",{className:"mx_UploadConfirmDialog_fileIcon",src:s(1276)}),this.props.file.name," (",Vn()(this.props.file.size),")")),this.props.currentIndex+1<this.props.totalFiles&&(o=a.a.createElement("button",{onClick:this.onUploadAllClick},Object(c.a)("Upload all"))),a.a.createElement(e,{className:"mx_UploadConfirmDialog",fixedWidth:!1,onFinished:this.onCancelClick,title:n,contentId:"mx_Dialog_content"},a.a.createElement("div",{id:"mx_Dialog_content"},i),a.a.createElement(t,{primaryButton:Object(c.a)("Upload"),hasCancel:!1,onPrimaryButtonClick:this.onUploadClick,focus:!0},o))}},x()(Jo,"defaultProps",{totalFiles:1}),Yo=Qo))||Yo;var Zo,ea=s(745),ta=s(594);let sa=Object(P.a)("views.dialogs.security.ConfirmDestroyCrossSigningDialog")(Zo=class extends a.a.Component{constructor(...e){super(...e),x()(this,"onConfirm",()=>{this.props.onFinished(!0)}),x()(this,"onDecline",()=>{this.props.onFinished(!1)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return a.a.createElement(e,{className:"mx_ConfirmDestroyCrossSigningDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Destroy cross-signing keys?")},a.a.createElement("div",{className:"mx_ConfirmDestroyCrossSigningDialog_content"},a.a.createElement("p",null,Object(c.a)("Deleting cross-signing keys is permanent. Anyone you have verified with will see security alerts. You almost certainly don't want to do this, unless you've lost every device you can cross-sign from."))),a.a.createElement(t,{primaryButton:Object(c.a)("Clear cross-signing keys"),onPrimaryButtonClick:this.onConfirm,primaryButtonClass:"danger",cancelButton:Object(c.a)("Cancel"),onCancel:this.onDecline}))}})||Zo;var na,ia,oa,aa=s(436);let ra=Object(P.a)("views.dialogs.InteractiveAuthDialog")((oa=ia=class extends a.a.Component{constructor(...e){super(...e),x()(this,"state",{authError:null,uiaStage:null,uiaStagePhase:null}),x()(this,"_onAuthFinished",(e,t)=>{e?this.props.onFinished(!0,t):t===aa.a?this.props.onFinished(!1,null):this.setState({authError:t})}),x()(this,"_onUpdateStagePhase",(e,t)=>{this.setState({uiaStage:e,uiaStagePhase:t})}),x()(this,"_onDismissClick",()=>{this.props.onFinished(!1)})}_getDefaultDialogAesthetics(){const e={[Ui.c.PHASE_PREAUTH]:{title:Object(c.a)("Use Single Sign On to continue"),body:Object(c.a)("To continue, use Single Sign On to prove your identity."),continueText:Object(c.a)("Single Sign On"),continueKind:"primary"},[Ui.c.PHASE_POSTAUTH]:{title:Object(c.a)("Confirm to continue"),body:Object(c.a)("Click the button below to confirm your identity."),continueText:Object(c.a)("Confirm"),continueKind:"primary"}};return{[Ui.c.LOGIN_TYPE]:e,[Ui.c.UNSTABLE_LOGIN_TYPE]:e}}render(){const e=d.getComponent("structures.InteractiveAuth"),t=d.getComponent("views.dialogs.BaseDialog");let s=this.state.authError?"Error":this.props.title||Object(c.a)("Authentication"),n=this.state.authError?null:this.props.body,i=null,o=null;const r=this.props.aestheticsForStagePhases||this._getDefaultDialogAesthetics();if(!this.state.authError&&r&&r[this.state.uiaStage]){const e=r[this.state.uiaStage][this.state.uiaStagePhase];e&&e.title&&(s=e.title),e&&e.body&&(n=e.body),e&&e.continueText&&(i=e.continueText),e&&e.continueKind&&(o=e.continueKind)}let l;return l=this.state.authError?a.a.createElement("div",{id:"mx_Dialog_content"},a.a.createElement("div",{role:"alert"},this.state.authError.message||this.state.authError.toString()),a.a.createElement("br",null),a.a.createElement(g.a,{onClick:this._onDismissClick,className:"mx_GeneralButton",autoFocus:"true"},Object(c.a)("Dismiss"))):a.a.createElement("div",{id:"mx_Dialog_content"},n,a.a.createElement(e,{ref:this._collectInteractiveAuth,matrixClient:this.props.matrixClient,authData:this.props.authData,makeRequest:this.props.makeRequest,onAuthFinished:this._onAuthFinished,onStagePhaseChange:this._onUpdateStagePhase,continueText:i,continueKind:o})),a.a.createElement(t,{className:"mx_InteractiveAuthDialog",onFinished:this.props.onFinished,title:s,contentId:"mx_Dialog_content"},l)}},x()(ia,"propTypes",{matrixClient:wt.a.object.isRequired,authData:wt.a.shape({flows:wt.a.array,params:wt.a.object,session:wt.a.string}),makeRequest:wt.a.func.isRequired,onFinished:wt.a.func.isRequired,title:wt.a.string,body:wt.a.string,aestheticsForStagePhases:wt.a.object}),na=oa))||na;var ca;let la=Object(P.a)("views.dialogs.security.CreateCrossSigningDialog")(ca=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"doBootstrapUIAuth",async e=>{if(this.state.canUploadKeysWithPasswordOnly&&this.state.accountPassword)await e({type:"m.login.password",identifier:{type:"m.id.user",user:le.a.get().getUserId()},user:le.a.get().getUserId(),password:this.state.accountPassword});else if(this.props.tokenLogin)await e({});else{const t={[Ui.c.PHASE_PREAUTH]:{title:Object(c.a)("Use Single Sign On to continue"),body:Object(c.a)("To continue, use Single Sign On to prove your identity."),continueText:Object(c.a)("Single Sign On"),continueKind:"primary"},[Ui.c.PHASE_POSTAUTH]:{title:Object(c.a)("Confirm encryption setup"),body:Object(c.a)("Click the button below to confirm setting up encryption."),continueText:Object(c.a)("Confirm"),continueKind:"primary"}},{finished:s}=Le.a.createTrackedDialog("Cross-signing keys dialog","",ra,{title:Object(c.a)("Setting up keys"),matrixClient:le.a.get(),makeRequest:e,aestheticsForStagePhases:{[Ui.c.LOGIN_TYPE]:t,[Ui.c.UNSTABLE_LOGIN_TYPE]:t}}),[n]=await s;if(!n)throw new Error("Cross-signing key upload auth canceled")}}),x()(this,"bootstrapCrossSigning",async()=>{this.setState({error:null});const e=le.a.get();try{await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:this.doBootstrapUIAuth}),this.props.onFinished(!0)}catch(e){if(this.props.tokenLogin)return void this.props.onFinished(!1);this.setState({error:e}),console.error("Error bootstrapping cross-signing",e)}}),x()(this,"onCancel",()=>{this.props.onFinished(!1)}),this.state={error:null,canUploadKeysWithPasswordOnly:!!e.accountPassword||null,accountPassword:e.accountPassword||""},this.state.accountPassword||this.queryKeyUploadAuth()}componentDidMount(){this.bootstrapCrossSigning()}async queryKeyUploadAuth(){try{await le.a.get().uploadDeviceSigningKeys(null,{}),console.log("uploadDeviceSigningKeys unexpectedly succeeded without UI auth!")}catch(e){if(!e.data||!e.data.flows)return void console.log("uploadDeviceSigningKeys advertised no flows!");const t=e.data.flows.some(e=>1===e.stages.length&&"m.login.password"===e.stages[0]);this.setState({canUploadKeysWithPasswordOnly:t})}}render(){let e;return e=this.state.error?a.a.createElement("div",null,a.a.createElement("p",null,Object(c.a)("Unable to set up keys")),a.a.createElement("div",{className:"mx_Dialog_buttons"},a.a.createElement(Bi.a,{primaryButton:Object(c.a)("Retry"),onPrimaryButtonClick:this.bootstrapCrossSigning,onCancel:this.onCancel}))):a.a.createElement("div",null,a.a.createElement(Rn.a,null)),a.a.createElement(Ze.a,{className:"mx_CreateCrossSigningDialog",onFinished:this.props.onFinished,title:Object(c.a)("Setting up keys"),hasCancel:!1,fixedWidth:!1},a.a.createElement("div",null,e))}})||ca;var da,ua=s(631),ha=s(443),ma=s(573);let pa=Object(P.a)("views.elements.Draggable")(da=class extends a.a.Component{constructor(e){super(e),x()(this,"onMouseDown",e=>{this.setState({location:{currentX:e.clientX,currentY:e.clientY}}),document.addEventListener("mousemove",this.state.onMouseMove),document.addEventListener("mouseup",this.state.onMouseUp)}),x()(this,"onMouseUp",e=>{document.removeEventListener("mousemove",this.state.onMouseMove),document.removeEventListener("mouseup",this.state.onMouseUp),this.props.onMouseUp(e)}),this.state={onMouseMove:this.onMouseMove.bind(this),onMouseUp:this.onMouseUp.bind(this),location:{currentX:0,currentY:0}}}onMouseMove(e){const t=this.props.dragFunc(this.state.location,e);this.setState({location:t})}render(){return a.a.createElement("div",{className:this.props.className,onMouseDown:this.onMouseDown.bind(this)})}})||da;var ga=s(672),va=s(720),fa=s(338),ba=s(155);var ya,_a=({events:e,children:t,threshold:s=3,onToggle:n,startExpanded:i,summaryMembers:r=[],summaryText:l,layout:d})=>{const[u,h]=Object(fa.a)(i);Object(o.useEffect)(()=>{n&&n()},[u]);const m=e.map(e=>e.getId()).join(",");if(e.length<s)return a.a.createElement("li",{className:"mx_EventListSummary","data-scroll-tokens":m},t);let p;if(u)p=a.a.createElement(a.a.Fragment,null,a.a.createElement("div",{className:"mx_EventListSummary_line"}," "),t);else{const e=r.map(e=>a.a.createElement(Yi.a,{key:e.userId,member:e,width:14,height:14}));p=d===ba.a.Bubble?a.a.createElement("div",{className:"mx_EventTile_line sc_EventTile_bubbleLine sc_EventTile_bubbleLine_info"},a.a.createElement("div",{className:"sc_EventTile_bubbleArea sc_EventTile_bubbleArea_center sc_EventTile_bubbleArea_info"},a.a.createElement("div",{className:"sc_EventTile_bubble sc_EventTile_bubble_info sc_EventTile_bubble_center"},a.a.createElement("span",{className:"mx_EventListSummary_avatars",onClick:h},e),a.a.createElement("span",{className:"mx_TextualEvent mx_EventListSummary_summary"},l)))):a.a.createElement("div",{className:"mx_EventTile_line"},a.a.createElement("div",{className:"mx_EventTile_info"},a.a.createElement("span",{className:"mx_EventListSummary_avatars",onClick:h},e),a.a.createElement("span",{className:"mx_TextualEvent mx_EventListSummary_summary"},l)))}return a.a.createElement("li",{className:"mx_EventListSummary","data-scroll-tokens":m},a.a.createElement(g.a,{className:"mx_EventListSummary_toggle",onClick:h,"aria-expanded":u},u?Object(c.a)("collapse"):Object(c.a)("expand")),p)},Ea=s(651),Sa=s(669);let wa=Object(P.a)("views.elements.IRCTimelineProfileResizer")(ya=class extends a.a.Component{constructor(e){super(e),x()(this,"dragFunc",(e,t)=>{const s=t.clientX-e.currentX,n=this.state.width+s;return n<this.props.minWidth||n>this.props.maxWidth?e:(this.setState({width:n}),this.updateCSSWidth.bind(this)(n),{currentX:t.clientX,currentY:e.currentY})}),this.state={width:V.b.getValue("ircDisplayNameWidth",this.props.roomId),IRCLayoutRoot:null}}componentDidMount(){this.setState({IRCLayoutRoot:document.querySelector(".mx_IRCLayout")},()=>this.updateCSSWidth(this.state.width))}updateCSSWidth(e){this.state.IRCLayoutRoot.style.setProperty("--name-width",e+"px")}onMoueUp(e){this.props.roomId&&V.b.setValue("ircDisplayNameWidth",this.props.roomId,Ye.a.ROOM_DEVICE,this.state.width)}render(){return a.a.createElement(pa,{className:"mx_ProfileResizer",dragFunc:this.dragFunc.bind(this),onMouseUp:this.onMoueUp.bind(this)})}})||ya;var Ca,ka,Oa,Ra,Ia=s(474),xa=s(433),Ta=s(713),ja=s(173);!function(e){e.Joined="joined",e.Left="left",e.JoinedAndLeft="joined_and_left",e.LeftAndJoined="left_and_joined",e.InviteReject="invite_reject",e.InviteWithdrawal="invite_withdrawal",e.Invited="invited",e.Banned="banned",e.Unbanned="unbanned",e.Kicked="kicked",e.ChangedName="changed_name",e.ChangedAvatar="changed_avatar",e.NoChange="no_change",e.ServerAcl="server_acl"}(Ra||(Ra={}));let Na=Object(P.a)("views.elements.MemberEventListSummary")((Oa=ka=class e extends a.a.Component{shouldComponentUpdate(e){return e.events.length!==this.props.events.length||e.events.length<this.props.threshold}generateSummary(t,s){const n=s.map(s=>{const n=t[s],i=this.renderNameList(n),o=s.split(","),a=e.getCanonicalTransitions(o),r=e.coalesceRepeatedTransitions(a).map(t=>e.getDescriptionForTransition(t.transitionType,n.length,t.repeats)),l=Object(J.b)(r);return Object(c.a)("%(nameList)s %(transitionList)s",{nameList:i,transitionList:l})});return n?n.join(", "):null}renderNameList(e){return Object(J.b)(e,this.props.summaryLength)}static getCanonicalTransitions(e){const t={[Ra.Joined]:{after:Ra.Left,newTransition:Ra.JoinedAndLeft},[Ra.Left]:{after:Ra.Joined,newTransition:Ra.LeftAndJoined}},s=[];for(let n=0;n<e.length;n++){const i=e[n],o=e[n+1];let a=i;n<e.length-1&&t[i]&&t[i].after===o&&(a=t[i].newTransition,n++),s.push(a)}return s}static coalesceRepeatedTransitions(e){const t=[];for(let s=0;s<e.length;s++)t.length>0&&t[t.length-1].transitionType===e[s]?t[t.length-1].repeats+=1:t.push({transitionType:e[s],repeats:1});return t}static getDescriptionForTransition(e,t,s){let n=null;switch(e){case"joined":n=t>1?Object(c.a)("%(severalUsers)sjoined %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)sjoined %(count)s times",{oneUser:"",count:s});break;case"left":n=t>1?Object(c.a)("%(severalUsers)sleft %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)sleft %(count)s times",{oneUser:"",count:s});break;case"joined_and_left":n=t>1?Object(c.a)("%(severalUsers)sjoined and left %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)sjoined and left %(count)s times",{oneUser:"",count:s});break;case"left_and_joined":n=t>1?Object(c.a)("%(severalUsers)sleft and rejoined %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)sleft and rejoined %(count)s times",{oneUser:"",count:s});break;case"invite_reject":n=t>1?Object(c.a)("%(severalUsers)srejected their invitations %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)srejected their invitation %(count)s times",{oneUser:"",count:s});break;case"invite_withdrawal":n=t>1?Object(c.a)("%(severalUsers)shad their invitations withdrawn %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)shad their invitation withdrawn %(count)s times",{oneUser:"",count:s});break;case"invited":n=t>1?Object(c.a)("were invited %(count)s times",{count:s}):Object(c.a)("was invited %(count)s times",{count:s});break;case"banned":n=t>1?Object(c.a)("were banned %(count)s times",{count:s}):Object(c.a)("was banned %(count)s times",{count:s});break;case"unbanned":n=t>1?Object(c.a)("were unbanned %(count)s times",{count:s}):Object(c.a)("was unbanned %(count)s times",{count:s});break;case"kicked":n=t>1?Object(c.a)("were kicked %(count)s times",{count:s}):Object(c.a)("was kicked %(count)s times",{count:s});break;case"changed_name":n=t>1?Object(c.a)("%(severalUsers)schanged their name %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)schanged their name %(count)s times",{oneUser:"",count:s});break;case"changed_avatar":n=t>1?Object(c.a)("%(severalUsers)schanged their avatar %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)schanged their avatar %(count)s times",{oneUser:"",count:s});break;case"no_change":n=t>1?Object(c.a)("%(severalUsers)smade no changes %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)smade no changes %(count)s times",{oneUser:"",count:s});break;case"server_acl":n=t>1?Object(c.a)("%(severalUsers)schanged the server ACLs %(count)s times",{severalUsers:"",count:s}):Object(c.a)("%(oneUser)schanged the server ACLs %(count)s times",{oneUser:"",count:s})}return n}static getTransitionSequence(t){return t.map(e.getTransition)}static getTransition(e){if("m.room.third_party_invite"===e.mxEvent.getType())return Object(Je.c)(e.mxEvent)?Ra.Invited:Ra.InviteWithdrawal;if("m.room.server_acl"===e.mxEvent.getType())return Ra.ServerAcl;switch(e.mxEvent.getContent().membership){case"invite":return Ra.Invited;case"ban":return Ra.Banned;case"join":return"join"===e.mxEvent.getPrevContent().membership?e.mxEvent.getContent().displayname!==e.mxEvent.getPrevContent().displayname?Ra.ChangedName:e.mxEvent.getContent().avatar_url!==e.mxEvent.getPrevContent().avatar_url?Ra.ChangedAvatar:Ra.NoChange:Ra.Joined;case"leave":if(e.mxEvent.getSender()===e.mxEvent.getStateKey())switch(e.mxEvent.getPrevContent().membership){case"invite":return Ra.InviteReject;default:return Ra.Left}switch(e.mxEvent.getPrevContent().membership){case"invite":return Ra.InviteWithdrawal;case"ban":return Ra.Unbanned;default:return Ra.Kicked}default:return null}}getAggregate(t){const s={},n={};return Object.keys(t).forEach(i=>{const o=t[i][0],a=o.displayName,r=e.getTransitionSequence(t[i]).join(",");s[r]||(s[r]=[],n[r]=-1),s[r].push(a),(-1===n[r]||o.index<n[r])&&(n[r]=o.index)}),{names:s,indices:n}}render(){const e=this.props.events,t=new Map,s={};e.forEach((e,n)=>{const i="m.room.server_acl"===e.getType()?e.getSender():e.getStateKey();s[i]||(s[i]=[]),"m.room.server_acl"===e.getType()?t.set(i,e.sender):e.target&&t.set(i,e.target);let o=i;"m.room.third_party_invite"===e.getType()?o=e.getContent().display_name:"m.room.server_acl"===e.getType()?o=e.sender.name:e.target&&(o=e.target.name),s[i].push({mxEvent:e,displayName:o,index:n})});const n=this.getAggregate(s),i=Object.keys(n.names).sort((e,t)=>n.indices[e]-n.indices[t]);return a.a.createElement(_a,{events:this.props.events,threshold:this.props.threshold,onToggle:this.props.onToggle,startExpanded:this.props.startExpanded,children:this.props.children,summaryMembers:[...t.values()],summaryText:this.generateSummary(n.names,i),layout:this.props.layout})}},x()(ka,"defaultProps",{summaryLength:1,threshold:3,avatarsMaxLength:5}),Ca=Oa))||Ca;var Pa=s(416),Da=s(329),Aa=s(441),Ma=s(650),Ua=s(626),La=s(148),Fa=s(333),Ba=s(185),Va=s(328);function Ka(){return V.b.getValue("recent_emoji")||[]}function Wa(e=24){let t=Ka();t.length<1&&(!function(){const e=JSON.parse(window.localStorage.mx_reaction_count||"{}"),t=Object.entries(e).sort(([,[e,t]],[,[s,n]])=>n-t).map(([e,[t,s]])=>[e,t]);V.b.setValue("recent_emoji",null,Ye.a.ACCOUNT,t.slice(0,100))}(),t=Ka());return Object(li.orderBy)(t,"1","desc").slice(0,e).map(([e])=>e)}var Ga,qa=s(267);var Ha,$a=Object(P.a)("views.emojipicker.Header")(Ga=class extends a.a.PureComponent{constructor(...e){super(...e),x()(this,"onKeyDown",e=>{let t=!0;switch(e.key){case gt.a.ARROW_LEFT:this.changeCategoryRelative(-1);break;case gt.a.ARROW_RIGHT:this.changeCategoryRelative(1);break;case gt.a.HOME:this.changeCategoryAbsolute(0);break;case gt.a.END:this.changeCategoryAbsolute(this.props.categories.length-1,-1);break;default:t=!1}t&&(e.preventDefault(),e.stopPropagation())})}findNearestEnabled(e,t){e+=this.props.categories.length;const s=[...this.props.categories,...this.props.categories,...this.props.categories];for(;e<s.length&&e>=0;){if(s[e].enabled)return e%this.props.categories.length;e+=t>0?1:-1}}changeCategoryRelative(e){const t=this.props.categories.findIndex(e=>e.visible);this.changeCategoryAbsolute(t+e,e)}changeCategoryAbsolute(e,t=1){const s=this.props.categories[this.findNearestEnabled(e,t)];s&&(this.props.onAnchorClick(s.id),s.ref.current.focus())}render(){return a.a.createElement("nav",{className:"mx_EmojiPicker_header",role:"tablist","aria-label":Object(c.a)("Categories"),onKeyDown:this.onKeyDown},this.props.categories.map(e=>{const t=M()("mx_EmojiPicker_anchor mx_EmojiPicker_anchor_"+e.id,{mx_EmojiPicker_anchor_visible:e.visible});return a.a.createElement("button",{disabled:!e.enabled,key:e.id,ref:e.ref,className:t,onClick:()=>this.props.onAnchorClick(e.id),title:e.name,role:"tab",tabIndex:e.visible?0:-1,"aria-selected":e.visible,"aria-controls":"mx_EmojiPicker_category_"+e.id})}))}})||Ga;var za,Ya=Object(P.a)("views.emojipicker.Search")(Ha=class extends a.a.PureComponent{constructor(...e){super(...e),x()(this,"inputRef",a.a.createRef()),x()(this,"onKeyDown",e=>{e.key===gt.a.ENTER&&(this.props.onEnter(),e.stopPropagation(),e.preventDefault())})}componentDidMount(){setTimeout(()=>this.inputRef.current.focus(),0)}render(){let e;return e=this.props.query?a.a.createElement("button",{onClick:()=>this.props.onChange(""),className:"mx_EmojiPicker_search_icon mx_EmojiPicker_search_clear",title:Object(c.a)("Cancel search")}):a.a.createElement("span",{className:"mx_EmojiPicker_search_icon"}),a.a.createElement("div",{className:"mx_EmojiPicker_search"},a.a.createElement("input",{autoFocus:!0,type:"text",placeholder:"Search",value:this.props.query,onChange:e=>this.props.onChange(e.target.value),onKeyDown:this.onKeyDown,ref:this.inputRef}),e)}})||Ha;var Ja,Qa=Object(P.a)("views.emojipicker.Preview")(za=class extends a.a.PureComponent{render(){const{unicode:e="",annotation:t="",shortcodes:[s=""]}=this.props.emoji||{};return a.a.createElement("div",{className:"mx_EmojiPicker_footer mx_EmojiPicker_preview"},a.a.createElement("div",{className:"mx_EmojiPicker_preview_emoji"},e),a.a.createElement("div",{className:"mx_EmojiPicker_preview_text"},a.a.createElement("div",{className:"mx_EmojiPicker_name mx_EmojiPicker_preview_name"},t),a.a.createElement("div",{className:"mx_EmojiPicker_shortcode"},s)))}})||za;var Xa,Za=Object(P.a)("views.emojipicker.Emoji")(Ja=class extends a.a.PureComponent{render(){const{onClick:e,onMouseEnter:t,onMouseLeave:s,emoji:n,selectedEmojis:o}=this.props,r=o&&o.has(n.unicode);return a.a.createElement(i.f,{element:"li",onClick:()=>e(n),onMouseEnter:()=>t(n),onMouseLeave:()=>s(n),className:"mx_EmojiPicker_item_wrapper",label:n.unicode},a.a.createElement("div",{className:"mx_EmojiPicker_item "+(r?"mx_EmojiPicker_item_selected":"")},n.unicode))}})||Ja;const er=["👍","👎","😄","🎉","😕","❤️","🚀","👀"].map(e=>{const t=Object(qa.e)(e);if(!t)throw new Error(`Emoji ${e} doesn't exist in emojibase`);return t});var tr,sr=Object(P.a)("views.emojipicker.QuickReactions")(Xa=class extends a.a.Component{constructor(e){super(e),x()(this,"onMouseEnter",e=>{this.setState({hover:e})}),x()(this,"onMouseLeave",()=>{this.setState({hover:null})}),this.state={hover:null}}render(){return a.a.createElement("section",{className:"mx_EmojiPicker_footer mx_EmojiPicker_quick mx_EmojiPicker_category"},a.a.createElement("h2",{className:"mx_EmojiPicker_quick_header mx_EmojiPicker_category_label"},this.state.hover?a.a.createElement(a.a.Fragment,null,a.a.createElement("span",{className:"mx_EmojiPicker_name"},this.state.hover.annotation),a.a.createElement("span",{className:"mx_EmojiPicker_shortcode"},this.state.hover.shortcodes[0])):Object(c.a)("Quick Reactions")),a.a.createElement("ul",{className:"mx_EmojiPicker_list","aria-label":Object(c.a)("Quick Reactions")},er.map(e=>a.a.createElement(Za,{key:e.hexcode,emoji:e,onClick:this.props.onClick,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,selectedEmojis:this.props.selectedEmojis}))))}})||Xa;function nr(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}var ir,or=Object(P.a)("views.emojipicker.EmojiPicker")(tr=class e extends a.a.Component{constructor(e){super(e),x()(this,"recentlyUsed",void 0),x()(this,"memoizedDataByCategory",void 0),x()(this,"categories",void 0),x()(this,"bodyRef",a.a.createRef()),x()(this,"onScroll",()=>{const e=this.bodyRef.current;this.setState({scrollTop:e.scrollTop,viewportHeight:e.clientHeight}),this.updateVisibility()}),x()(this,"updateVisibility",()=>{const e=this.bodyRef.current,t=e.getBoundingClientRect();for(const s of this.categories){const n=e.querySelector(`[data-category-id="${s.id}"]`);if(!n){s.visible=!1,s.ref.current.classList.remove("mx_EmojiPicker_anchor_visible");continue}const i=n.getBoundingClientRect(),o=i.y-t.y,a=i.y+i.height-t.y;s.visible=o<t.height&&a>0,s.visible?(s.ref.current.classList.add("mx_EmojiPicker_anchor_visible"),s.ref.current.setAttribute("aria-selected","true"),s.ref.current.setAttribute("tabindex","0")):(s.ref.current.classList.remove("mx_EmojiPicker_anchor_visible"),s.ref.current.setAttribute("aria-selected","false"),s.ref.current.setAttribute("tabindex","-1"))}}),x()(this,"scrollToCategory",e=>{this.bodyRef.current.querySelector(`[data-category-id="${e}"]`).scrollIntoView()}),x()(this,"onChangeFilter",e=>{e=e.toLowerCase();for(const t of this.categories){let s;s=e.includes(this.state.filter)?this.memoizedDataByCategory[t.id]:"recent"===t.id?this.recentlyUsed:qa.a[t.id],s=s.filter(t=>t.filterString.includes(e)),this.memoizedDataByCategory[t.id]=s,t.enabled=s.length>0,t.ref.current.disabled=!t.enabled}this.setState({filter:e}),setTimeout(this.updateVisibility,0)}),x()(this,"onEnterFilter",()=>{const e=this.bodyRef.current.querySelector(".mx_EmojiPicker_item");e&&e.click()}),x()(this,"onHoverEmoji",e=>{this.setState({previewEmoji:e})}),x()(this,"onHoverEmojiEnd",e=>{this.setState({previewEmoji:null})}),x()(this,"onClickEmoji",e=>{!1!==this.props.onChoose(e.unicode)&&function(e){const t=Ka(),s=t.findIndex(([t])=>t===e);let n;s>=0?([n]=t.splice(s,1),n[1]++):n=[e,1],V.b.setValue("recent_emoji",null,Ye.a.ACCOUNT,[n,...t].slice(0,100))}(e.unicode)}),this.state={filter:"",previewEmoji:null,scrollTop:0,viewportHeight:280},this.recentlyUsed=Array.from(new Set(Wa().map(qa.e).filter(Boolean))),this.memoizedDataByCategory=function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?nr(Object(s),!0).forEach((function(t){x()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):nr(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({recent:this.recentlyUsed},qa.a),this.categories=[{id:"recent",name:Object(c.a)("Frequently Used"),enabled:this.recentlyUsed.length>0,visible:this.recentlyUsed.length>0,ref:a.a.createRef()},{id:"people",name:Object(c.a)("Smileys & People"),enabled:!0,visible:!0,ref:a.a.createRef()},{id:"nature",name:Object(c.a)("Animals & Nature"),enabled:!0,visible:!1,ref:a.a.createRef()},{id:"foods",name:Object(c.a)("Food & Drink"),enabled:!0,visible:!1,ref:a.a.createRef()},{id:"activity",name:Object(c.a)("Activities"),enabled:!0,visible:!1,ref:a.a.createRef()},{id:"places",name:Object(c.a)("Travel & Places"),enabled:!0,visible:!1,ref:a.a.createRef()},{id:"objects",name:Object(c.a)("Objects"),enabled:!0,visible:!1,ref:a.a.createRef()},{id:"symbols",name:Object(c.a)("Symbols"),enabled:!0,visible:!1,ref:a.a.createRef()},{id:"flags",name:Object(c.a)("Flags"),enabled:!0,visible:!1,ref:a.a.createRef()}]}static categoryHeightForEmojiCount(e){return 0===e?0:22+37*Math.ceil(e/8)}render(){let t=0;return a.a.createElement("div",{className:"mx_EmojiPicker"},a.a.createElement($a,{categories:this.categories,onAnchorClick:this.scrollToCategory}),a.a.createElement(Ya,{query:this.state.filter,onChange:this.onChangeFilter,onEnter:this.onEnterFilter}),a.a.createElement(n.a,{className:"mx_EmojiPicker_body",wrappedRef:e=>{this.bodyRef.current=e},onScroll:this.onScroll},this.categories.map(s=>{const n=this.memoizedDataByCategory[s.id],i=a.a.createElement(dr,{key:s.id,id:s.id,name:s.name,heightBefore:t,viewportHeight:this.state.viewportHeight,scrollTop:this.state.scrollTop,emojis:n,onClick:this.onClickEmoji,onMouseEnter:this.onHoverEmoji,onMouseLeave:this.onHoverEmojiEnd,selectedEmojis:this.props.selectedEmojis}),o=e.categoryHeightForEmojiCount(n.length);return t+=o,i})),this.state.previewEmoji||!this.props.showQuickReactions?a.a.createElement(Qa,{emoji:this.state.previewEmoji}):a.a.createElement(sr,{onClick:this.onClickEmoji,selectedEmojis:this.props.selectedEmojis}))}})||tr;class ar{constructor(e,t,s){this.topCount=e,this.renderCount=t,this.bottomCount=s}contains(e){return!(!e.renderCount&&this.renderCount)&&(e.topCount>=this.topCount&&e.topCount+e.renderCount<=this.topCount+this.renderCount)}expand(e){if(0===this.renderCount)return this;const t=Math.min(e,this.topCount),s=Math.min(e,this.bottomCount);return new ar(this.topCount-t,this.renderCount+t+s,this.bottomCount-s)}totalSize(){return this.topCount+this.renderCount+this.bottomCount}}let rr=Object(P.a)("views.elements.LazyRenderList")(ir=class e extends a.a.Component{constructor(e){super(e),this.state={}}static getDerivedStateFromProps(t,s){const n=e.getVisibleRangeFromProps(t),i=n.expand(t.overflowMargin),o=n.expand(t.overflowItems);return!(!!s.renderRange&&o.totalSize()!==s.renderRange.totalSize())&&s.renderRange&&s.renderRange.contains(i)?null:{renderRange:o}}static getVisibleRangeFromProps(e){const{items:t,itemHeight:s,scrollTop:n,height:i}=e,o=t?t.length:0,a=Math.min(Math.max(0,Math.floor(n/s)),o),r=o-a,c=0!==i?Math.ceil(i/s):0,l=Math.min(c,r);return new ar(a,l,r-l)}render(){const{itemHeight:e,items:t,renderItem:s}=this.props,{renderRange:n}=this.state,{topCount:i,renderCount:o,bottomCount:r}=n,c=i*e,l=r*e,d=(t||[]).slice(i,i+o),u=this.props.element||"div",h={style:{paddingTop:c+"px",paddingBottom:l+"px"},className:this.props.className};return a.a.createElement(u,h,d.map(s))}})||ir;var cr;rr.defaultProps={overflowItems:20,overflowMargin:5},rr.propTypes={itemHeight:wt.a.number.isRequired,renderItem:wt.a.func.isRequired,scrollTop:wt.a.number.isRequired,height:wt.a.number.isRequired,items:wt.a.array,overflowMargin:wt.a.number,overflowItems:wt.a.number};var lr,dr=Object(P.a)("views.emojipicker.Category")(cr=class extends a.a.PureComponent{constructor(...e){super(...e),x()(this,"renderEmojiRow",e=>{const{onClick:t,onMouseEnter:s,onMouseLeave:n,selectedEmojis:i,emojis:o}=this.props,r=o.slice(8*e,8*(e+1));return a.a.createElement("div",{key:e},r.map(e=>a.a.createElement(Za,{key:e.hexcode,emoji:e,selectedEmojis:i,onClick:t,onMouseEnter:s,onMouseLeave:n})))})}render(){const{emojis:e,name:t,heightBefore:s,viewportHeight:n,scrollTop:i}=this.props;if(!e||0===e.length)return null;const o=new Array(Math.ceil(e.length/8));for(let e=0;e<o.length;++e)o[e]=e;const r=i,c=r+n,l=s+22,d=l+37*o.length,u=Math.max(r,l),h=Math.min(c,d),m=Math.max(0,h-u),p=Math.max(0,i-l);return a.a.createElement("section",{id:"mx_EmojiPicker_category_"+this.props.id,className:"mx_EmojiPicker_category","data-category-id":this.props.id,role:"tabpanel","aria-label":t},a.a.createElement("h2",{className:"mx_EmojiPicker_category_label"},t),a.a.createElement(rr,{element:"ul",className:"mx_EmojiPicker_list",itemHeight:37,items:o,scrollTop:p,height:m,overflowItems:3,overflowMargin:0,renderItem:this.renderEmojiRow}))}})||cr;var ur=Object(P.a)("views.emojipicker.ReactionPicker")(lr=class extends a.a.Component{constructor(e){super(e),x()(this,"onReactionsChange",()=>{this.setState({selectedEmojis:new Set(Object.keys(this.getReactions()))})}),x()(this,"onChoose",e=>{this.componentWillUnmount(),this.props.onFinished();const t=this.getReactions();return t.hasOwnProperty(e)?(le.a.get().redactEvent(this.props.mxEvent.getRoomId(),t[e]),!1):(le.a.get().sendEvent(this.props.mxEvent.getRoomId(),"m.reaction",{"m.relates_to":{rel_type:"m.annotation",event_id:this.props.mxEvent.getId(),key:e}}),u.a.dispatch({action:"message_sent"}),!0)}),this.state={selectedEmojis:new Set(Object.keys(this.getReactions()))},this.addListeners()}componentDidUpdate(e){e.reactions!==this.props.reactions&&(this.addListeners(),this.onReactionsChange())}addListeners(){this.props.reactions&&(this.props.reactions.on("Relations.add",this.onReactionsChange),this.props.reactions.on("Relations.remove",this.onReactionsChange),this.props.reactions.on("Relations.redaction",this.onReactionsChange))}componentWillUnmount(){this.props.reactions&&(this.props.reactions.removeListener("Relations.add",this.onReactionsChange),this.props.reactions.removeListener("Relations.remove",this.onReactionsChange),this.props.reactions.removeListener("Relations.redaction",this.onReactionsChange))}getReactions(){if(!this.props.reactions)return{};const e=le.a.get().getUserId(),t=this.props.reactions.getAnnotationsBySender()[e]||[];return Object.fromEntries([...t].filter(e=>!e.isRedacted()).map(e=>[e.getRelation().key,e.getId()]))}render(){return a.a.createElement(or,{onChoose:this.onChoose,selectedEmojis:this.state.selectedEmojis,showQuickReactions:!0})}})||lr,hr=s(228),mr=s(127);var pr,gr=Object(o.forwardRef)(({mxEvent:e},t)=>{const s=Object(o.useContext)(b.a),n=e.getRoomId(),i=le.a.get().isRoomEncrypted(n);if("m.megolm.v1.aes-sha2"===e.getContent().algorithm&&i){let e;const t=mr.a.shared().getUserIdForRoomId(n);if(t){var r,l;const i=(null==s||null===(r=s.getRoom(n))||void 0===r||null===(l=r.getMember(t))||void 0===l?void 0:l.rawDisplayName)||t;e=Object(c.a)("Messages here are end-to-end encrypted. Verify %(displayName)s in their profile - tap on their avatar.",{displayName:i})}else e=Object(c.a)("Messages in this room are end-to-end encrypted. When people join, you can verify them in their profile, just tap on their avatar.");return a.a.createElement(hr.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:Object(c.a)("Encryption enabled"),subtitle:e})}return i?a.a.createElement(hr.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:Object(c.a)("Encryption enabled"),subtitle:Object(c.a)("Ignored attempt to disable encryption")}):a.a.createElement(hr.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon mx_cryptoEvent_icon_warning",title:Object(c.a)("Encryption not enabled"),subtitle:Object(c.a)("The encryption used by this room isn't supported."),ref:t})}),vr=s(217),fr=s(190);let br=Object(P.a)("views.messages.MJitsiWidgetEvent")(pr=class extends a.a.PureComponent{constructor(e){super(e)}render(){var e;const t=this.props.mxEvent.getContent().url,s=this.props.mxEvent.getPrevContent().url,n=(null===(e=this.props.mxEvent.sender)||void 0===e?void 0:e.name)||this.props.mxEvent.getSender(),i=le.a.get().getRoom(this.props.mxEvent.getRoomId()),o=this.props.mxEvent.getStateKey(),r=vr.a.instance.getRoom(i.roomId,!0).widgets.find(e=>e.id===o);let l=Object(c.a)("Join the conference at the top of this room");return r&&fr.d.instance.isInContainer(i,r,fr.a.Right)?l=Object(c.a)("Join the conference from the room information card on the right"):r||(l=null),t?s?a.a.createElement(hr.a,{className:"mx_MJitsiWidgetEvent",title:Object(c.a)("Video conference updated by %(senderName)s",{senderName:n}),subtitle:l}):a.a.createElement(hr.a,{className:"mx_MJitsiWidgetEvent",title:Object(c.a)("Video conference started by %(senderName)s",{senderName:n}),subtitle:l}):a.a.createElement(hr.a,{className:"mx_MJitsiWidgetEvent",title:Object(c.a)("Video conference ended by %(senderName)s",{senderName:n})})}})||pr;function yr(e,t){const s=le.a.get().getRoom(t),n=s&&s.getMember(e);return n?n.name:e}function _r(e,t){const s=yr(e,t);return s!==e?Object(c.a)("%(name)s (%(userId)s)",{name:s,userId:e}):e}var Er;let Sr=Object(P.a)("views.messages.MKeyVerificationRequest")(Er=class extends a.a.Component{constructor(...e){super(...e),x()(this,"openRequest",()=>{const{verificationRequest:e}=this.props.mxEvent,t=le.a.get().getUser(e.otherUserId);u.a.dispatch({action:h.a.SetRightPanelPhase,phase:Qe.c.EncryptionPanel,refireParams:{verificationRequest:e,member:t}})}),x()(this,"onRequestChanged",()=>{this.forceUpdate()}),x()(this,"onAcceptClicked",async()=>{const e=this.props.mxEvent.verificationRequest;if(e)try{this.openRequest(),await e.accept()}catch(e){console.error(e.message)}}),x()(this,"onRejectClicked",async()=>{const e=this.props.mxEvent.verificationRequest;if(e)try{await e.cancel()}catch(e){console.error(e.message)}})}componentDidMount(){const e=this.props.mxEvent.verificationRequest;e&&e.on("change",this.onRequestChanged)}componentWillUnmount(){const e=this.props.mxEvent.verificationRequest;e&&e.off("change",this.onRequestChanged)}acceptedLabel(e){return e===le.a.get().getUserId()?Object(c.a)("You accepted"):Object(c.a)("%(name)s accepted",{name:yr(e,this.props.mxEvent.getRoomId())})}cancelledLabel(e){const t=le.a.get().getUserId(),{cancellationCode:s}=this.props.mxEvent.verificationRequest,n="m.user"===s;return e===t?n?Object(c.a)("You declined"):Object(c.a)("You cancelled"):n?Object(c.a)("%(name)s declined",{name:yr(e,this.props.mxEvent.getRoomId())}):Object(c.a)("%(name)s cancelled",{name:yr(e,this.props.mxEvent.getRoomId())})}render(){const e=d.getComponent("elements.AccessibleButton"),{mxEvent:t}=this.props,s=t.verificationRequest;if(!s||s.invalid)return null;let n,i,o;if(!s.canAccept){let t;s.ready||s.started||s.done?t=a.a.createElement(e,{onClick:this.openRequest},this.acceptedLabel(s.receivingUserId)):s.cancelled?t=this.cancelledLabel(s.cancellingUserId):s.accepting?t=Object(c.a)("Accepting …"):s.declining&&(t=Object(c.a)("Declining …")),o=a.a.createElement("div",{className:"mx_cryptoEvent_state"},t)}if(s.initiatedByMe)n=Object(c.a)("You sent a verification request"),i=_r(s.receivingUserId,t.getRoomId());else{const r=yr(s.requestingUserId,t.getRoomId());n=Object(c.a)("%(name)s wants to verify",{name:r}),i=_r(s.requestingUserId,t.getRoomId()),s.canAccept&&(o=a.a.createElement("div",{className:"mx_cryptoEvent_buttons"},a.a.createElement(e,{kind:"danger",onClick:this.onRejectClicked},Object(c.a)("Decline")),a.a.createElement(e,{onClick:this.onAcceptClicked},Object(c.a)("Accept"))))}return n?a.a.createElement(hr.a,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:n,subtitle:i},o):null}})||Er;var wr,Cr,kr,Or=s(711),Rr=s.n(Or);function Ir(e){return Object(pe.a)({file:e}).downloadSource().then(e=>e.arrayBuffer()).then(t=>Rr.a.decryptAttachment(t,e)).then(t=>{let s=e.mimetype?e.mimetype.split(";")[0].trim():"";return s=zo(s),new Blob([t],{type:s})})}let xr;function Tr(e){if(!e)return"";const t=window.getComputedStyle(e,null);let s=t.cssText;if(""==s)for(let e=0;e<t.length;e++)s+=t[e]+":",s+=t.getPropertyValue(t[e])+";";return s}!async function(){if(xr)return;const e=await fetch(s(1277)).then(e=>e.text());xr="data:image/svg+xml;base64,"+window.btoa(e)}();let jr=Object(P.a)("views.messages.MFileBody")((kr=Cr=class extends a.a.Component{constructor(e){super(e),this.state={decryptedBlob:this.props.decryptedBlob?this.props.decryptedBlob:null},this._iframe=Object(o.createRef)(),this._dummyLink=Object(o.createRef)()}presentableTextForFile(e,t=!0){let s=Object(c.a)("Attachment");return e.body&&e.body.length>0&&(s=e.body),e.info&&e.info.size&&t&&(s+=" ("+Vn()(e.info.size)+")"),s}_getContentUrl(){return Object(pe.a)(this.props.mxEvent.getContent()).srcHttp}componentDidUpdate(e,t){this.props.onHeightChanged&&!t.decryptedBlob&&this.state.decryptedBlob&&this.props.onHeightChanged()}render(){const e=this.props.mxEvent.getContent(),t=this.presentableTextForFile(e),s=void 0!==e.file,n=e.body&&e.body.length>0?e.body:Object(c.a)("Attachment"),i=this._getContentUrl(),o=e.info?e.info.size:null,r=e.info?e.info.mimetype:"application/octet-stream";let l=null;if(this.props.showGenericPlaceholder&&(l=a.a.createElement("div",{className:"mx_MFileBody_info"},a.a.createElement("span",{className:"mx_MFileBody_info_icon"}),a.a.createElement("span",{className:"mx_MFileBody_info_filename"},this.presentableTextForFile(e,!1)))),s){if(null===this.state.decryptedBlob){let s=!1;const n=t=>{if(s)return!1;s=!0,Ir(e.file).then(e=>{this.setState({decryptedBlob:e})}).catch(e=>{console.warn("Unable to decrypt attachment: ",e),Le.a.createTrackedDialog("Error decrypting attachment","",Xe.a,{title:Object(c.a)("Error"),description:Object(c.a)("Error decrypting attachment")})}).finally(()=>{s=!1})};return a.a.createElement("span",{className:"mx_MFileBody"},l,a.a.createElement("div",{className:"mx_MFileBody_download"},a.a.createElement(g.a,{onClick:n},Object(c.a)("Decrypt %(text)s",{text:t}))),this.props.scBubbleGroupTimestamp)}const s=e=>{e.target.contentWindow.postMessage({imgSrc:xr,imgStyle:null,style:Tr(this._dummyLink.current),blob:this.state.decryptedBlob,download:n,textContent:Object(c.a)("Download %(text)s",{text:t}),auto:!this.props.decryptedBlob},"*")},i="usercontent/";return a.a.createElement("span",{className:"mx_MFileBody"},l,a.a.createElement("div",{className:"mx_MFileBody_download"},a.a.createElement("div",{style:{display:"none"}},a.a.createElement("a",{ref:this._dummyLink})),a.a.createElement("iframe",{src:i,onLoad:s,ref:this._iframe,sandbox:"allow-scripts allow-downloads allow-downloads-without-user-activation"})),this.props.scBubbleGroupTimestamp)}if(i){const s={target:"_blank",rel:"noreferrer noopener",href:i},d="number"!=typeof o||o>524288e3;return["application/pdf"].includes(r)&&!d?s.onClick=e=>{console.log(`Downloading ${r} as blob (unencrypted)`),e.preventDefault(),e.stopPropagation(),fetch(i).then(e=>e.blob()).then(e=>{const t=URL.createObjectURL(e),s=document.createElement("a");s.download=n,s.href=t,document.body.appendChild(s),s.click(),s.remove()})}:s.download=n,"file_grid"===this.props.tileShape?a.a.createElement("span",{className:"mx_MFileBody"},l,a.a.createElement("div",{className:"mx_MFileBody_download"},a.a.createElement("a",ue()({className:"mx_MFileBody_downloadLink"},s),n),a.a.createElement("div",{className:"mx_MImageBody_size"},e.info&&e.info.size?Vn()(e.info.size):"")),this.props.scBubbleGroupTimestamp):a.a.createElement("span",{className:"mx_MFileBody"},l,a.a.createElement("div",{className:"mx_MFileBody_download"},a.a.createElement("a",s,a.a.createElement("span",{className:"mx_MFileBody_download_icon"}),Object(c.a)("Download %(text)s",{text:t}))),this.props.scBubbleGroupTimestamp)}{const e=t?": "+t:"";return a.a.createElement("span",{className:"mx_MFileBody"},l,Object(c.a)("Invalid file%(extra)s",{extra:e}),this.props.scBubbleGroupTimestamp)}}},x()(Cr,"propTypes",{mxEvent:wt.a.object.isRequired,decryptedBlob:wt.a.object,onHeightChanged:wt.a.func,tileShape:wt.a.string,showGenericPlaceholder:wt.a.bool,scBubbleGroupTimestamp:wt.a.object}),x()(Cr,"defaultProps",{showGenericPlaceholder:!0}),wr=kr))||wr;var Nr;let Pr=Object(P.a)("views.messages.MVideoBody")(Nr=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"videoRef",a.a.createRef()),x()(this,"videoOnPlay",async()=>{if(this.hasContentUrl()||this.state.fetchingData||this.state.error)return;this.setState({fetchingData:!0});const e=this.props.mxEvent.getContent();if(!e.file)return void this.setState({error:"No file given in content"});const t=await Ir(e.file),s=URL.createObjectURL(t);this.setState({decryptedUrl:s,decryptedBlob:t,fetchingData:!1},()=>{this.videoRef.current&&this.videoRef.current.play()}),this.props.onHeightChanged()}),this.state={fetchingData:!1,decryptedUrl:null,decryptedThumbnailUrl:null,decryptedBlob:null,error:null}}thumbScale(e,t,s,n){if(!e||!t)return;if(e<s&&t<n)return 1;const i=s/e,o=n/t;return i<o?i:o}getContentUrl(){const e=Object(pe.a)(this.props.mxEvent.getContent());return e.isEncrypted?this.state.decryptedUrl:e.srcHttp}hasContentUrl(){const e=this.getContentUrl();return e&&!e.startsWith("data:")}getThumbUrl(){const e=this.props.mxEvent.getContent(),t=Object(pe.a)(e);return t.isEncrypted?this.state.decryptedThumbnailUrl:t.hasThumbnail?t.thumbnailHttp:null}async componentDidMount(){const e=V.b.getValue("autoplayGifsAndVideos"),t=this.props.mxEvent.getContent();if(void 0!==t.file&&null===this.state.decryptedUrl){let i=Promise.resolve(null);t.info&&t.info.thumbnail_file&&(i=Ir(t.info.thumbnail_file).then((function(e){return URL.createObjectURL(e)})));try{const o=await i;if(e){console.log("Preloading video");const e=await Ir(t.file),s=URL.createObjectURL(e);this.setState({decryptedUrl:s,decryptedThumbnailUrl:o,decryptedBlob:e}),this.props.onHeightChanged()}else{var s,n;console.log("NOT preloading video"),this.setState({decryptedUrl:`data:${null==t||null===(s=t.info)||void 0===s?void 0:s.mimetype},`,decryptedThumbnailUrl:o||`data:${null==t||null===(n=t.info)||void 0===n?void 0:n.mimetype},`,decryptedBlob:null})}}catch(e){console.warn("Unable to decrypt attachment: ",e),this.setState({error:e})}}}componentWillUnmount(){this.state.decryptedUrl&&URL.revokeObjectURL(this.state.decryptedUrl),this.state.decryptedThumbnailUrl&&URL.revokeObjectURL(this.state.decryptedThumbnailUrl)}render(){const e=this.props.mxEvent.getContent(),t=V.b.getValue("autoplayGifsAndVideos");if(null!==this.state.error)return a.a.createElement("span",{className:"mx_MVideoBody"},a.a.createElement("img",{src:s(224),width:"16",height:"16"}),Object(c.a)("Error decrypting video"),this.props.scBubbleActionBar);if(void 0!==e.file&&null===this.state.decryptedUrl&&t)return a.a.createElement("span",{className:"mx_MVideoBody"},a.a.createElement("div",{className:"mx_MImageBody_thumbnail mx_MImageBody_thumbnail_spinner"},a.a.createElement(ot.a,null)),this.props.scBubbleActionBar);const n=this.getContentUrl(),i=this.getThumbUrl();let o=null,r=null,l=null,d="metadata";if(e.info){const t=this.thumbScale(e.info.w,e.info.h,480,360);t&&(r=Math.floor(e.info.w*t),o=Math.floor(e.info.h*t)),i&&(l=i,d="none")}return a.a.createElement("span",{className:"mx_MVideoBody",style:{maxWidth:r+"px"}},a.a.createElement("span",{className:"sc_MVideoBody_video_container"},a.a.createElement("video",{className:"mx_MVideoBody",ref:this.videoRef,src:n,title:e.body,controls:!0,preload:d,muted:t,autoPlay:t,height:o,width:r,poster:l,onPlay:this.videoOnPlay})),a.a.createElement(jr,ue()({},this.props,{decryptedBlob:this.state.decryptedBlob,showGenericPlaceholder:!1})),this.props.scBubbleActionBar)}})||Nr;var Dr=s(8),Ar=s.n(Dr),Mr=s(138);class Ur{constructor(e){this.context=e,x()(this,"clipStart",0),x()(this,"stopped",!0),x()(this,"lastCheck",0),x()(this,"observable",new Mr.SimpleObservable),x()(this,"timerId",void 0),x()(this,"clipDuration",0),x()(this,"checkTime",()=>{const e=this.timeSeconds;this.lastCheck!==e&&(this.observable.update([e,this.durationSeconds]),this.lastCheck=e)})}get durationSeconds(){return this.clipDuration}set durationSeconds(e){this.clipDuration=e,this.observable.update([this.timeSeconds,this.clipDuration])}get timeSeconds(){return(this.context.currentTime-this.clipStart)%this.clipDuration}get liveData(){return this.observable}flagLoadTime(){this.clipStart=this.context.currentTime}flagStart(){this.stopped&&(this.clipStart=this.context.currentTime,this.stopped=!1),this.timerId||(this.timerId=setInterval(this.checkTime,100))}flagStop(){this.stopped=!0}destroy(){this.observable.close(),this.timerId&&clearInterval(this.timerId)}}var Lr=s(1278),Fr=s(1279),Br=s(9),Vr=s(320);const Kr=new Vr.a;class Wr{constructor(){}static for(e,t){if(!e||!t)throw new Error("An instance and key must be supplied");return new Gr(e,t)}static forgetAllFor(e){Kr.delete(e)}static forgetAll(){for(const e of Kr.keys())Kr.remove(e)}}x()(Wr,"Void",Symbol("void"));class Gr{constructor(e,t){this.instance=e,this.key=t}forget(){const e=Kr.get(this.instance);e&&(e.remove(this.key),e.size||Kr.remove(this.instance))}do(e){const t=Kr.getOrCreate(this.instance,new Vr.a);let s=t.get(this.key);return void 0===s&&(s=e(),t.set(this.key,s)),s}}var qr=s(6);let Hr;!function(e){e.Started="started",e.EndingSoon="ending_soon",e.Ended="ended",e.Uploading="uploading",e.Uploaded="uploaded"}(Hr||(Hr={}));class $r extends Ar.a{constructor(e){super(),this.client=e,x()(this,"recorder",void 0),x()(this,"recorderContext",void 0),x()(this,"recorderSource",void 0),x()(this,"recorderStream",void 0),x()(this,"recorderFFT",void 0),x()(this,"recorderWorklet",void 0),x()(this,"recorderProcessor",void 0),x()(this,"buffer",new Uint8Array(0)),x()(this,"lastUpload",void 0),x()(this,"recording",!1),x()(this,"observable",void 0),x()(this,"amplitudes",[]),x()(this,"playback",void 0),x()(this,"onAudioProcess",e=>{this.processAudioUpdate(e.playbackTime)}),x()(this,"processAudioUpdate",e=>{if(!this.recording)return;const t=new Float32Array(this.recorderFFT.fftSize);if(this.recorderFFT.getFloatTimeDomainData)this.recorderFFT.getFloatTimeDomainData(t);else{const e=new Uint8Array(this.recorderFFT.fftSize);this.recorderFFT.getByteTimeDomainData(e);for(let s=0;s<e.length;s++)t[s]=Object(Br.d)(Object(Br.c)(e[s],0,256),-1,1)}const s=[];for(let e=0;e<t.length;e++)s.push(Object(Br.a)(t[e],0,1));this.observable.update({waveform:s,timeSeconds:e});const n=120-this.recorder.encodedSamplePosition/48e3;n<0?this.stop():n<=10&&Wr.for(this,"ending_soon").do(()=>(this.emit(Hr.EndingSoon,{secondsLeft:n}),Wr.Void))})}get contentType(){return"audio/ogg"}get contentLength(){return this.buffer.length}get durationSeconds(){if(!this.recorder)throw new Error("Duration not available without a recording");return this.recorderContext.currentTime}get isRecording(){return this.recording}emit(e,...t){return super.emit(e,...t),super.emit(v.b,e,...t),!0}async makeRecorder(){try{this.recorderStream=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,noiseSuppression:!0,deviceId:Vt.b.getAudioInput()}}),this.recorderContext=Qr({}),this.recorderSource=this.recorderContext.createMediaStreamSource(this.recorderStream),this.recorderFFT=this.recorderContext.createAnalyser(),this.recorderFFT.fftSize=64;const e=document.body.dataset.vectorRecorderWorkletScript;if(!e)throw new Error("Unable to create recorder: no worklet script registered");this.recorderSource.connect(this.recorderFFT),this.recorderContext.audioWorklet?(await this.recorderContext.audioWorklet.addModule(e),this.recorderWorklet=new AudioWorkletNode(this.recorderContext,qr.b),this.recorderSource.connect(this.recorderWorklet),this.recorderWorklet.connect(this.recorderContext.destination),this.recorderWorklet.port.onmessage=e=>{switch(e.data.ev){case qr.a.Timekeep:this.processAudioUpdate(e.data.timeSeconds);break;case qr.a.AmplitudeMark:e.data.forSecond===this.amplitudes.length&&this.amplitudes.push(e.data.amplitude)}}):(this.recorderProcessor=this.recorderContext.createScriptProcessor(1024,1,1),this.recorderSource.connect(this.recorderProcessor),this.recorderProcessor.connect(this.recorderContext.destination),this.recorderProcessor.addEventListener("audioprocess",this.onAudioProcess)),this.recorder=new Lr({encoderPath:Fr.a,encoderSampleRate:48e3,encoderApplication:2048,streamPages:!0,encoderFrameSize:20,numberOfChannels:1,sourceNode:this.recorderSource,encoderBitRate:24e3,encoderComplexity:3,resampleQuality:3}),this.recorder.ondataavailable=e=>{const t=new Uint8Array(e),s=new Uint8Array(this.buffer.length+t.length);s.set(this.buffer,0),s.set(t,this.buffer.length),this.buffer=s}}catch(e){throw console.error("Error starting recording: ",e),e instanceof DOMException&&console.error(`${e.name} (${e.code}): ${e.message}`),this.recorderStream&&this.recorderStream.getTracks().forEach(e=>e.stop()),this.recorderSource&&this.recorderSource.disconnect(),this.recorder&&this.recorder.close(),this.recorderContext&&this.recorderContext.close(),e}}get audioBuffer(){return this.buffer.slice(0)}get liveData(){if(!this.recording)throw new Error("No observable when not recording");return this.observable}get isSupported(){return!!Lr.isRecordingSupported()}get hasRecording(){return this.buffer.length>0}async start(){if(this.lastUpload||this.hasRecording)throw new Error("Recording already prepared");if(this.recording)throw new Error("Recording already in progress");this.observable&&this.observable.close(),this.observable=new Mr.SimpleObservable,await this.makeRecorder(),await this.recorder.start(),this.recording=!0,this.emit(Hr.Started)}async stop(){return Wr.for(this,"stop").do(async()=>{if(!this.recording)throw new Error("No recording to stop");return await this.recorder.stop(),this.recorderSource.disconnect(),this.recorderWorklet&&this.recorderWorklet.disconnect(),this.recorderProcessor&&(this.recorderProcessor.disconnect(),this.recorderProcessor.removeEventListener("audioprocess",this.onAudioProcess)),await this.recorderContext.close(),this.recorderStream.getTracks().forEach(e=>e.stop()),this.recording=!1,await this.recorder.close(),this.emit(Hr.Ended),this.audioBuffer})}getPlayback(){return this.playback=Wr.for(this,"playback").do(()=>new ec(this.audioBuffer.buffer,this.amplitudes)),this.playback}destroy(){var e;this.stop(),this.removeAllListeners(),Wr.forgetAllFor(this),null===(e=this.playback)||void 0===e||e.destroy(),this.observable.close()}async upload(e){if(!this.hasRecording)throw new Error("No recording available to upload");if(this.lastUpload)return this.lastUpload;this.emit(Hr.Uploading);const{url:t,file:s}=await Object(Fn.b)(this.client,e,new Blob([this.audioBuffer],{type:this.contentType}));return this.lastUpload={mxc:t,encrypted:s},this.emit(Hr.Uploaded),this.lastUpload}}var zr=s(1280),Yr=s(1281),Jr=s(1282);function Qr(e){if(window.AudioContext)return new AudioContext(e);if(window.webkitAudioContext)return new window.webkitAudioContext(e);throw new Error("Unsupported browser")}let Xr;!function(e){e.Decoding="decoding",e.Stopped="stopped",e.Paused="paused",e.Playing="playing"}(Xr||(Xr={}));const Zr=Object(Ee.h)(0,39);class ec extends Ar.a{constructor(e,t=Zr){super(),this.buf=e,x()(this,"context",void 0),x()(this,"source",void 0),x()(this,"state",Xr.Decoding),x()(this,"audioBuf",void 0),x()(this,"resampledWaveform",void 0),x()(this,"waveformObservable",new Mr.SimpleObservable),x()(this,"clock",void 0),x()(this,"onPlaybackEnd",async()=>{await this.context.suspend(),this.emit(Xr.Stopped)}),this.context=Qr(),this.resampledWaveform=Object(Ee.c)(null!=t?t:Zr,39),this.waveformObservable.update(this.resampledWaveform),this.clock=new Ur(this.context)}get waveform(){return this.resampledWaveform}get waveformData(){return this.waveformObservable}get clockInfo(){return this.clock}get currentState(){return this.state}get isPlaying(){return this.currentState===Xr.Playing}emit(e,...t){return this.state=e,super.emit(e,...t),super.emit(v.b,e,...t),!0}destroy(){this.stop(),this.removeAllListeners(),this.clock.destroy(),this.waveformObservable.close()}async prepare(){this.audioBuf=await new Promise((e,t)=>{this.context.decodeAudioData(this.buf,t=>e(t),async s=>{console.error("Error decoding recording: ",s),console.warn("Trying to re-encode to WAV instead...");const n=await(i=this.buf,new Promise(e=>{console.log("Decoder WASM path: "+zr.a);const t=new Uint8Array(i),s=new Worker(Jr.a),n=new Worker(Yr.a);s.postMessage({command:"init",decoderSampleRate:48e3,outputBufferSampleRate:48e3}),n.postMessage({command:"init",wavBitDepth:24,wavSampleRate:48e3}),s.onmessage=e=>{null!==e.data?n.postMessage({command:"encode",buffers:e.data},e.data.map(e=>e.buffer)):n.postMessage({command:"done"})},n.onmessage=t=>{"page"===t.data.message&&e(new Blob([t.data.page],{type:"audio/wav"}).arrayBuffer())},s.postMessage({command:"decode",pages:t},[t.buffer])}));var i;this.context.decodeAudioData(n,t=>e(t),e=>{console.error("Still failed to decode recording: ",e),t(e)})})});const e=Array.from(this.audioBuf.getChannelData(0));this.resampledWaveform=function(e){const t=e.map(e=>Math.abs(e)),s=Object(Ee.g)(Object(Ee.i)(t,39),0,1).map(e=>Object(Br.a)(e,.1,.5));return Object(Ee.g)(s,0,1)}(e),this.waveformObservable.update(this.resampledWaveform),this.emit(Xr.Stopped),this.clock.flagLoadTime(),this.clock.durationSeconds=this.audioBuf.duration}async play(){this.state===Xr.Stopped&&(this.source&&(this.source.disconnect(),this.source.removeEventListener("ended",this.onPlaybackEnd)),this.source=this.context.createBufferSource(),this.source.connect(this.context.destination),this.source.buffer=this.audioBuf,this.source.start(),this.source.addEventListener("ended",this.onPlaybackEnd)),await this.context.resume(),this.clock.flagStart(),this.emit(Xr.Playing)}async pause(){await this.context.suspend(),this.emit(Xr.Paused)}async stop(){await this.onPlaybackEnd(),this.clock.flagStop()}async toggle(){this.isPlaying?await this.pause():await this.play()}}var tc,sc,nc;let ic=Object(P.a)("views.voice_messages.Waveform")((nc=sc=class extends a.a.PureComponent{render(){return a.a.createElement("div",{className:"mx_Waveform"},this.props.relHeights.map((e,t)=>{const s=this.props.progress,n=t/this.props.relHeights.length<=s&&s>0,i=M()({mx_Waveform_bar:!0,mx_Waveform_bar_100pct:n});return a.a.createElement("span",{key:t,style:{"--barHeight":e},className:i})}))}},x()(sc,"defaultProps",{progress:1}),tc=nc))||tc;var oc;let ac=Object(P.a)("views.voice_messages.PlaybackWaveform")(oc=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"onWaveformUpdate",e=>{this.setState({heights:this.toHeights(e)})}),x()(this,"onTimeUpdate",e=>{const t=Number(Object(Br.c)(e[0],0,e[1]).toFixed(3));this.setState({progress:t})}),this.state={heights:this.toHeights(this.props.playback.waveform),progress:0},this.props.playback.waveformData.onUpdate(this.onWaveformUpdate),this.props.playback.clockInfo.liveData.onUpdate(this.onTimeUpdate)}toHeights(e){const t=Object(Ee.h)(0,39);return Object(Ee.j)(e,39,t)}render(){return a.a.createElement(ic,{relHeights:this.state.heights,progress:this.state.progress})}})||oc;var rc;let cc=Object(P.a)("views.voice_messages.PlayPauseButton")(rc=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"onClick",async()=>{await this.props.playback.toggle()})}render(){const e=this.props.playback.isPlaying,t=this.props.playbackPhase===Xr.Decoding,s=M()("mx_PlayPauseButton",{mx_PlayPauseButton_play:!e,mx_PlayPauseButton_pause:e,mx_PlayPauseButton_disabled:t});return a.a.createElement(K.a,{className:s,title:e?Object(c.a)("Pause"):Object(c.a)("Play"),onClick:this.onClick,disabled:t})}})||rc;var lc;let dc=Object(P.a)("views.voice_messages.Clock")(lc=class extends a.a.Component{constructor(e){super(e)}shouldComponentUpdate(e,t,s){return Math.floor(this.props.seconds)!==Math.floor(e.seconds)}render(){const e=Math.floor(this.props.seconds/60).toFixed(0).padStart(2,"0"),t=Math.floor(this.props.seconds%60).toFixed(0).padStart(2,"0");return a.a.createElement("span",{className:"mx_Clock"},e,":",t)}})||lc;var uc;let hc=Object(P.a)("views.voice_messages.PlaybackClock")(uc=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"onPlaybackUpdate",e=>{e===Xr.Decoding&&(e=Xr.Stopped),this.setState({playbackPhase:e})}),x()(this,"onTimeUpdate",e=>{this.setState({seconds:e[0],durationSeconds:e[1]})}),this.state={seconds:this.props.playback.clockInfo.timeSeconds,durationSeconds:this.props.playback.clockInfo.durationSeconds,playbackPhase:Xr.Stopped},this.props.playback.on(v.b,this.onPlaybackUpdate),this.props.playback.clockInfo.liveData.onUpdate(this.onTimeUpdate)}render(){let e=this.state.seconds;return this.state.playbackPhase===Xr.Stopped&&(e=this.state.durationSeconds),a.a.createElement(dc,{seconds:e})}})||uc;class mc extends a.a.PureComponent{constructor(e){super(e),x()(this,"onPlaybackUpdate",e=>{this.setState({playbackPhase:e})}),this.state={playbackPhase:Xr.Decoding},this.props.playback.on(v.b,this.onPlaybackUpdate),this.props.playback.prepare()}render(){return a.a.createElement("div",{className:"mx_VoiceMessagePrimaryContainer"},a.a.createElement(cc,{playback:this.props.playback,playbackPhase:this.state.playbackPhase}),a.a.createElement(hc,{playback:this.props.playback}),a.a.createElement(ac,{playback:this.props.playback}))}}var pc;let gc=Object(P.a)("views.messages.MVoiceMessageBody")(pc=class extends a.a.PureComponent{constructor(e){super(e),this.state={}}async componentDidMount(){var e,t;let s;const n=this.props.mxEvent.getContent(),i=Object(pe.a)(n);if(i.isEncrypted)try{const e=await Ir(n.file);s=await e.arrayBuffer(),this.setState({decryptedBlob:e})}catch(e){return this.setState({error:e}),void console.warn("Unable to decrypt voice message",e)}else try{s=await i.downloadSource().then(e=>e.blob()).then(e=>e.arrayBuffer())}catch(e){return this.setState({error:e}),void console.warn("Unable to download voice message",e)}const o=null==n||null===(e=n["org.matrix.msc1767.audio"])||void 0===e||null===(t=e.waveform)||void 0===t?void 0:t.map(e=>e/1024),a=new ec(s,o);this.setState({playback:a})}componentWillUnmount(){var e;null===(e=this.state.playback)||void 0===e||e.destroy()}render(){return this.state.error?a.a.createElement("span",{className:"mx_MVoiceMessageBody"},a.a.createElement("img",{src:s(224),width:"16",height:"16"}),Object(c.a)("Error processing voice message")):this.state.playback?a.a.createElement("span",{className:"mx_MVoiceMessageBody"},a.a.createElement(mc,{playback:this.state.playback}),a.a.createElement(jr,ue()({},this.props,{decryptedBlob:this.state.decryptedBlob,showGenericPlaceholder:!1}))):a.a.createElement("span",{className:"mx_MVoiceMessageBody"},a.a.createElement(ot.a,null))}})||pc;var vc,fc,bc;let yc=Object(P.a)("views.messages.MAudioBody")((bc=fc=class extends a.a.Component{constructor(e){super(e),this.state={playing:!1,decryptedUrl:null,decryptedBlob:null,error:null}}onPlayToggle(){this.setState({playing:!this.state.playing})}_getContentUrl(){const e=Object(pe.a)(this.props.mxEvent.getContent());return e.isEncrypted?this.state.decryptedUrl:e.srcHttp}componentDidMount(){const e=this.props.mxEvent.getContent();if(void 0!==e.file&&null===this.state.decryptedUrl){let t;Ir(e.file).then((function(e){return t=e,URL.createObjectURL(t)})).then(e=>{this.setState({decryptedUrl:e,decryptedBlob:t})},e=>{console.warn("Unable to decrypt attachment: ",e),this.setState({error:e})})}}componentWillUnmount(){this.state.decryptedUrl&&URL.revokeObjectURL(this.state.decryptedUrl)}render(){const e=this.props.mxEvent.getContent();if(null!==this.state.error)return a.a.createElement("span",{className:"mx_MAudioBody"},a.a.createElement("img",{src:s(224),width:"16",height:"16"}),Object(c.a)("Error decrypting audio"));if(void 0!==e.file&&null===this.state.decryptedUrl)return a.a.createElement("span",{className:"mx_MAudioBody"},a.a.createElement(ot.a,null));const t=this._getContentUrl();return a.a.createElement("span",{className:"mx_MAudioBody"},a.a.createElement("audio",{src:t,controls:!0}),a.a.createElement(jr,ue()({},this.props,{decryptedBlob:this.state.decryptedBlob,showGenericPlaceholder:!1})))}},x()(fc,"propTypes",{scBubbleGroupTimestamp:wt.a.object}),vc=bc))||vc;var _c;let Ec=Object(P.a)("views.messages.MVoiceOrAudioBody")(_c=class extends a.a.PureComponent{render(){const e=!!this.props.mxEvent.getContent()["org.matrix.msc2516.voice"]||!!this.props.mxEvent.getContent()["org.matrix.msc3245.voice"],t=V.b.getValue("feature_voice_messages");return e&&t?a.a.createElement(gc,this.props):a.a.createElement(yc,this.props)}})||_c;var Sc,wc,Cc,kc=s(592),Oc=s(246);let Rc=Object(P.a)("views.messages.ReactionsRowButtonTooltip")((Cc=wc=class extends a.a.PureComponent{render(){const{content:e,reactionEvents:t,mxEvent:s,visible:n}=this.props,i=this.context.getRoom(s.getRoomId());let o,r;if(i){const s=[];for(const e of t){const t=i.getMember(e.getSender()),n=t?t.name:e.getSender();s.push(n)}const n=Object(pn.j)(e);o=a.a.createElement("div",null,Object(c.a)("<reactors/><reactedWith>reacted with %(shortName)s</reactedWith>",{shortName:n},{reactors:()=>a.a.createElement("div",{className:"mx_Tooltip_title"},Object(J.b)(s,6)),reactedWith:e=>n?a.a.createElement("div",{className:"mx_Tooltip_sub"},e):null}))}return o&&(r=a.a.createElement(Ba.b,{visible:n,label:o})),r}},x()(wc,"contextType",b.a),Sc=Cc))||Sc;var Ic,xc,Tc;let jc=Object(P.a)("views.messages.ReactionsRowButton")((Tc=xc=class extends a.a.PureComponent{constructor(...e){super(...e),x()(this,"state",{tooltipRendered:!1,tooltipVisible:!1}),x()(this,"onClick",()=>{const{mxEvent:e,myReactionEvent:t,content:s}=this.props;t?this.context.redactEvent(e.getRoomId(),t.getId()):(this.context.sendEvent(e.getRoomId(),"m.reaction",{"m.relates_to":{rel_type:"m.annotation",event_id:e.getId(),key:s}}),u.a.dispatch({action:"message_sent"}))}),x()(this,"onMouseOver",()=>{this.setState({tooltipRendered:!0,tooltipVisible:!0})}),x()(this,"onMouseLeave",()=>{this.setState({tooltipVisible:!1})})}render(){const{mxEvent:e,content:t,count:s,reactionEvents:n,myReactionEvent:i}=this.props,o=M()({mx_ReactionsRowButton:!0,mx_ReactionsRowButton_selected:!!i});let r;this.state.tooltipRendered&&(r=a.a.createElement(Rc,{mxEvent:this.props.mxEvent,content:t,reactionEvents:n,visible:this.state.tooltipVisible}));const l=this.context.getRoom(e.getRoomId());let d;if(l){const e=[];for(const t of n){const s=l.getMember(t.getSender()),n=s?s.name:t.getSender();e.push(n)}d=Object(c.a)("<reactors/><reactedWith> reacted with %(content)s</reactedWith>",{content:t},{reactors:()=>Object(J.b)(e,6),reactedWith:e=>t?e:null})}const u="join"!==l.getMyMembership();return a.a.createElement(g.a,{className:o,"aria-label":d,onClick:this.onClick,disabled:u,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},a.a.createElement("span",{className:"mx_ReactionsRowButton_content","aria-hidden":"true"},t),a.a.createElement("span",{className:"mx_ReactionsRowButton_count","aria-hidden":"true"},s),r)}},x()(xc,"contextType",b.a),Ic=Tc))||Ic;var Nc,Pc,Dc;const Ac=({mxEvent:e,reactions:t})=>{const[s,n,o,r]=Object(i.q)();let l;if(s){const s=n.current.getBoundingClientRect();l=a.a.createElement(i.b,ue()({},Object(i.k)(s),{onFinished:r,managed:!1}),a.a.createElement(ur,{mxEvent:e,reactions:t,onFinished:r}))}return a.a.createElement(a.a.Fragment,null,a.a.createElement(Gs.a,{className:M()("mx_ReactionsRow_addReactionButton",{mx_ReactionsRow_addReactionButton_active:s}),title:Object(c.a)("Add reaction"),onClick:o,onContextMenu:e=>{e.preventDefault(),o()},isExpanded:s,inputRef:n}),l)};let Mc=Object(P.a)("views.messages.ReactionsRow")((Dc=Pc=class extends a.a.PureComponent{constructor(e,t){super(e,t),x()(this,"onDecrypted",()=>{this.forceUpdate()}),x()(this,"onReactionsChange",()=>{this.setState({myReactions:this.getMyReactions()}),this.forceUpdate()}),x()(this,"onShowAllClick",()=>{this.setState({showAll:!0})}),this.state={myReactions:this.getMyReactions(),showAll:!1}}componentDidMount(){const{mxEvent:e,reactions:t}=this.props;(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&e.once("Event.decrypted",this.onDecrypted),t&&(t.on("Relations.add",this.onReactionsChange),t.on("Relations.remove",this.onReactionsChange),t.on("Relations.redaction",this.onReactionsChange))}componentWillUnmount(){const{mxEvent:e,reactions:t}=this.props;e.off("Event.decrypted",this.onDecrypted),t&&(t.off("Relations.add",this.onReactionsChange),t.off("Relations.remove",this.onReactionsChange),t.off("Relations.redaction",this.onReactionsChange))}componentDidUpdate(e){e.reactions!==this.props.reactions&&(this.props.reactions.on("Relations.add",this.onReactionsChange),this.props.reactions.on("Relations.remove",this.onReactionsChange),this.props.reactions.on("Relations.redaction",this.onReactionsChange),this.onReactionsChange())}getMyReactions(){const e=this.props.reactions;if(!e)return null;const t=this.context.getUserId(),s=e.getAnnotationsBySender()[t];return s?[...s.values()]:null}render(){const{mxEvent:e,reactions:t}=this.props,{myReactions:s,showAll:n}=this.state;if(!t||!Object(Oc.c)(e))return null;let i,o=t.getSortedAnnotationsByKey().map(([t,n])=>{const i=n.size;if(!i)return null;const o=s&&s.find(e=>!e.isRedacted()&&e.getRelation().key===t);return a.a.createElement(jc,{key:t,content:t,count:i,mxEvent:e,reactionEvents:n,myReactionEvent:o})}).filter(e=>!!e);if(!o.length)return null;o.length>9&&!n&&(o=o.slice(0,8),i=a.a.createElement("a",{className:"mx_ReactionsRow_showAll",href:"#",onClick:this.onShowAllClick},Object(c.a)("Show all")));const r=this.context;let l;const d=r.getRoom(e.getRoomId());return"join"===d.getMyMembership()&&d.currentState.maySendEvent(ne.a.Reaction,r.getUserId())&&(l=a.a.createElement(Ac,{mxEvent:e,reactions:t})),a.a.createElement("div",{className:"mx_ReactionsRow",role:"toolbar","aria-label":Object(c.a)("Reactions")},o,i,l)}},x()(Pc,"contextType",b.a),Nc=Dc))||Nc;var Uc,Lc=s(410);class Fc extends a.a.Component{constructor(){super(),this.onClick=this.onClick.bind(this)}onClick(e){e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"view_group",group_id:this.props.groupProfile.groupId})}render(){const e=Object(pe.b)(this.props.groupProfile.avatarUrl).getSquareThumbnailHttp(16),t=this.props.groupProfile.name?`${this.props.groupProfile.name} (${this.props.groupProfile.groupId})`:this.props.groupProfile.groupId;return a.a.createElement("img",{src:e,width:"16",height:"16",onClick:this.onClick,title:t})}}Fc.propTypes={groupProfile:wt.a.shape({groupId:wt.a.string.isRequired,name:wt.a.string,avatarUrl:wt.a.string.isRequired})},Fc.contextType=b.a;let Bc=Object(P.a)("views.elements.Flair")(Uc=class extends a.a.Component{constructor(){super(),this.state={profiles:[]}}componentDidMount(){this._unmounted=!1,this._generateAvatars(this.props.groups)}componentWillUnmount(){this._unmounted=!0}UNSAFE_componentWillReceiveProps(e){this._generateAvatars(e.groups)}async _getGroupProfiles(e){const t=[];for(const s of e){let e=null;try{e=await et.a.getGroupProfileCached(this.context,s)}catch(e){console.error("Could not get profile for group",s,e)}t.push(e)}return t.filter(e=>null!==e)}async _generateAvatars(e){if(!e||0===e.length)return;const t=await this._getGroupProfiles(e);this.unmounted||this.setState({profiles:t.filter(e=>!!e&&e.avatarUrl)})}render(){if(0===this.state.profiles.length)return null;const e=this.state.profiles.map((e,t)=>a.a.createElement(Fc,{key:t,groupProfile:e}));return a.a.createElement("span",{className:"mx_Flair"},e)}})||Uc;var Vc,Kc,Wc;Bc.propTypes={groups:wt.a.arrayOf(wt.a.string)},Bc.contextType=b.a;let Gc=Object(P.a)("views.messages.SenderProfile")((Wc=Kc=class extends a.a.Component{constructor(e){super(e),x()(this,"unmounted",void 0),x()(this,"onRoomStateEvents",e=>{"m.room.related_groups"===e.getType()&&e.getRoomId()===this.props.mxEvent.getRoomId()&&this._updateRelatedGroups()});const t=this.props.mxEvent.getSender();this.state={userGroups:et.a.cachedPublicisedGroups(t)||[],relatedGroups:[]}}componentDidMount(){this.unmounted=!1,this._updateRelatedGroups(),0===this.state.userGroups.length&&this.getPublicisedGroups(),this.context.on("RoomState.events",this.onRoomStateEvents)}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("RoomState.events",this.onRoomStateEvents)}async getPublicisedGroups(){if(!this.unmounted){const e=await et.a.getPublicisedGroupsCached(this.context,this.props.mxEvent.getSender());this.setState({userGroups:e})}}_updateRelatedGroups(){if(this.unmounted)return;const e=this.context.getRoom(this.props.mxEvent.getRoomId());if(!e)return;const t=e.currentState.getStateEvents("m.room.related_groups","");this.setState({relatedGroups:t&&t.getContent().groups||[]})}_getDisplayedGroups(e,t){let s=e||[];return s=t&&t.length>0?t.filter(e=>s.includes(e)):[],s}render(){var e,t,s;const{mxEvent:n}=this.props,i=Object(J.f)(n.getSender()),{msgtype:o}=n.getContent(),r=null===(e=n.sender)||void 0===e?void 0:e.disambiguate,c=(null===(t=n.sender)||void 0===t?void 0:t.rawDisplayName)||n.getSender()||"",l=(null===(s=n.sender)||void 0===s?void 0:s.userId)||n.getSender()||"";if("m.emote"===o)return null;let d,u;if(r&&(d=a.a.createElement("span",{className:"mx_SenderProfile_mxid"},l)),this.props.enableFlair){const e=this._getDisplayedGroups(this.state.userGroups,this.state.relatedGroups);u=a.a.createElement(Bc,{key:"flair",userId:n.getSender(),groups:e})}return a.a.createElement("div",{className:"mx_SenderProfile",dir:"auto",onClick:this.props.onClick},a.a.createElement("span",{className:"mx_SenderProfile_displayName "+i},c),d,u)}},x()(Kc,"contextType",b.a),Vc=Wc))||Vc;var qc,Hc=s(204),$c=s(423),zc=s(617),Yc=s(467),Jc=s(468);const Qc=[Qe.c.GroupMemberInfo,Qe.c.GroupMemberList],Xc=[Qe.c.GroupRoomList,Qe.c.GroupRoomInfo];let Zc=Object(P.a)("views.right_panel.GroupHeaderButtons")(qc=class extends Jc.b{constructor(e){super(e,Jc.a.Group),x()(this,"onMembersClicked",()=>{this.state.phase===Qe.c.GroupMemberInfo?this.setPhase(Qe.c.GroupMemberInfo):this.setPhase(Qe.c.GroupMemberList)}),x()(this,"onRoomsClicked",()=>{this.setPhase(Qe.c.GroupRoomList)})}onAction(e){e.action===h.a.ViewUser?e.member?this.setPhase(Qe.c.RoomMemberInfo,{member:e.member}):this.setPhase(Qe.c.GroupMemberList):"view_group"===e.action?this.setPhase(Qe.c.GroupMemberList):"view_group_room"===e.action?this.setPhase(Qe.c.GroupRoomInfo,{groupRoomId:e.groupRoomId,groupId:e.groupId}):"view_group_room_list"===e.action?this.setPhase(Qe.c.GroupRoomList):"view_group_member_list"===e.action?this.setPhase(Qe.c.GroupMemberList):"view_group_user"===e.action&&this.setPhase(Qe.c.GroupMemberInfo,{member:e.member})}renderButtons(){return a.a.createElement(a.a.Fragment,null,a.a.createElement(Yc.a,{name:"groupMembersButton",title:Object(c.a)("Members"),isHighlighted:this.isPhase(Qc),onClick:this.onMembersClicked,analytics:["Right Panel","Group Member List Button","click"]}),a.a.createElement(Yc.a,{name:"roomsButton",title:Object(c.a)("Rooms"),isHighlighted:this.isPhase(Xc),onClick:this.onRoomsClicked,analytics:["Right Panel","Group Room List Button","click"]}))}})||qc;var el=s(348),tl=s(719),sl=s(414),nl=s(616),il=s(618),ol=s(601),al=s(671),rl=s(673);class cl{constructor(e,t){if(x()(this,"commandRegex",void 0),x()(this,"forcedCommandRegex",void 0),e){if(!e.global)throw new Error("commandRegex must have global flag set");this.commandRegex=e}if(t){if(!t.global)throw new Error("forcedCommandRegex must have global flag set");this.forcedCommandRegex=t}}destroy(){}getCurrentCommand(e,t,s=!1){let n,i=this.commandRegex;if(s&&this.shouldForceComplete()&&(i=this.forcedCommandRegex||/\S+/g),!i)return null;for(i.lastIndex=0;null!==(n=i.exec(e));){const e=n.index,s=e+n[0].length;if(t.start<=s&&t.end>=e)return{command:n,range:{start:e,end:s}}}return{command:null,range:{start:-1,end:-1}}}async getCompletions(e,t,s=!1,n=-1){return[]}getName(){return"Default Provider"}renderCompletions(e){return console.error("stub; should be implemented in subclasses"),null}shouldForceComplete(){return!1}}var ll=s(220);const dl=Object(o.forwardRef)((e,t)=>{const{title:s,subtitle:n,description:i,className:o}=e,r=me()(e,["title","subtitle","description","className"]);return a.a.createElement("div",ue()({},r,{className:M()("mx_Autocomplete_Completion_block",o),role:"option",ref:t}),a.a.createElement("span",{className:"mx_Autocomplete_Completion_title"},s),a.a.createElement("span",{className:"mx_Autocomplete_Completion_subtitle"},n),a.a.createElement("span",{className:"mx_Autocomplete_Completion_description"},i))}),ul=Object(o.forwardRef)((e,t)=>{const{title:s,subtitle:n,description:i,className:o,children:r}=e,c=me()(e,["title","subtitle","description","className","children"]);return a.a.createElement("div",ue()({},c,{className:M()("mx_Autocomplete_Completion_pill",o),role:"option",ref:t}),r,a.a.createElement("span",{className:"mx_Autocomplete_Completion_title"},s),a.a.createElement("span",{className:"mx_Autocomplete_Completion_subtitle"},n),a.a.createElement("span",{className:"mx_Autocomplete_Completion_description"},i))});var hl=s(318),ml=s(310);function pl(e){const t=2*Math.PI/e.length;return Array.from(e).map((e,s)=>{if(" "===e)return e;const[n,i]=function(e,t){const s=127*t*Math.cos(e),n=127*t*Math.sin(e);return[s,n]}(s*t,1),[o,a,r]=function(e,t,s){let n=(e+16)/116;const i=.9505*gl(n+t/500),o=1.089*gl(n-s/200);n=gl(n);const a=-.96924364*i+1.8759675*n+.04155506*o,r=.05563008*i-.20397696*n+1.05697151*o;return[vl(3.24096994*i-1.53738318*n-.49861076*o),vl(a),vl(r)]}(75,n,i);return'<font color="#'+o.toString(16).padStart(2,"0")+a.toString(16).padStart(2,"0")+r.toString(16).padStart(2,"0")+'">'+e+"</font>"}).join("")}function gl(e){return e>.2069?Math.pow(e,3):.1284*e-.01771}function vl(e){const t=function(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055}(e),s=Math.min(Math.max(t,0),1);return Math.round(255*s)}var fl=s(214),bl=s(238),yl=s(272),_l=s(122),El=s(161),Sl=s(401),wl=s(517),Cl=s(188),kl=s(207),Ol=s(242);function Rl(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function Il(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?Rl(Object(s),!0).forEach((function(t){x()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):Rl(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const xl=async()=>new Promise(e=>{const t=document.createElement("input");t.setAttribute("type","file"),t.onchange=t=>{const s=t.target.files[0],n=d.getComponent("dialogs.UploadConfirmDialog");Le.a.createTrackedDialog("Upload Files confirmation","",n,{file:s,onFinished:t=>{e(t?le.a.get().uploadContent(s):null)}})},t.click()}),Tl={messages:Object(c.b)("Messages"),actions:Object(c.b)("Actions"),admin:Object(c.b)("Admin"),advanced:Object(c.b)("Advanced"),effects:Object(c.b)("Effects"),other:Object(c.b)("Other")};class jl{constructor(e){x()(this,"command",void 0),x()(this,"aliases",void 0),x()(this,"args",void 0),x()(this,"description",void 0),x()(this,"runFn",void 0),x()(this,"category",void 0),x()(this,"hideCompletionAfterSpace",void 0),x()(this,"_isEnabled",void 0),this.command=e.command,this.aliases=e.aliases||[],this.args=e.args||"",this.description=e.description,this.runFn=e.runFn,this.category=e.category||Tl.other,this.hideCompletionAfterSpace=e.hideCompletionAfterSpace||!1,this._isEnabled=e.isEnabled}getCommand(){return"/"+this.command}getCommandWithArgs(){return this.getCommand()+" "+this.args}run(e,t){return this.runFn?this.runFn.bind(this)(e,t):Nl(Object(c.a)("Command error"))}getUsage(){return Object(c.a)("Usage")+": "+this.getCommandWithArgs()}isEnabled(){return!this._isEnabled||this._isEnabled()}}function Nl(e){return{error:e}}function Pl(e){return{promise:e}}function Dl(e){return Pl(Promise.resolve(e))}const Al=[new jl({command:"spoiler",args:"<message>",description:Object(c.b)("Sends the given message as a spoiler"),runFn:function(e,t){return Dl(hl.makeHtmlMessage(t,`<span data-mx-spoiler>${t}</span>`))},category:Tl.messages}),new jl({command:"shrug",args:"<message>",description:Object(c.b)("Prepends ¯\\_(ツ)_/¯ to a plain-text message"),runFn:function(e,t){let s="¯\\_(ツ)_/¯";return t&&(s=s+" "+t),Dl(hl.makeTextMessage(s))},category:Tl.messages}),new jl({command:"tableflip",args:"<message>",description:Object(c.b)("Prepends (╯°□°）╯︵ ┻━┻ to a plain-text message"),runFn:function(e,t){let s="(╯°□°）╯︵ ┻━┻";return t&&(s=s+" "+t),Dl(hl.makeTextMessage(s))},category:Tl.messages}),new jl({command:"unflip",args:"<message>",description:Object(c.b)("Prepends ┬──┬ ノ( ゜-゜ノ) to a plain-text message"),runFn:function(e,t){let s="┬──┬ ノ( ゜-゜ノ)";return t&&(s=s+" "+t),Dl(hl.makeTextMessage(s))},category:Tl.messages}),new jl({command:"lenny",args:"<message>",description:Object(c.b)("Prepends ( ͡° ͜ʖ ͡°) to a plain-text message"),runFn:function(e,t){let s="( ͡° ͜ʖ ͡°)";return t&&(s=s+" "+t),Dl(hl.makeTextMessage(s))},category:Tl.messages}),new jl({command:"plain",args:"<message>",description:Object(c.b)("Sends a message as plain text, without interpreting it as markdown"),runFn:function(e,t){return Dl(hl.makeTextMessage(t))},category:Tl.messages}),new jl({command:"html",args:"<message>",description:Object(c.b)("Sends a message as html, without interpreting it as markdown"),runFn:function(e,t){return Dl(hl.makeHtmlMessage(t,t))},category:Tl.messages}),new jl({command:"ddg",args:"<query>",description:Object(c.b)("Searches DuckDuckGo for results"),runFn:function(){const e=d.getComponent("dialogs.ErrorDialog");return Le.a.createTrackedDialog("Slash Commands","/ddg is not a command",e,{title:Object(c.a)("/ddg is not a command"),description:Object(c.a)("To use it, just wait for autocomplete results to load and tab through them.")}),Pl()},category:Tl.actions,hideCompletionAfterSpace:!0}),new jl({command:"upgraderoom",args:"<new_version>",description:Object(c.b)("Upgrades a room to a new version"),runFn:function(e,t){if(t){const s=le.a.get(),n=s.getRoom(e);if(!n.currentState.mayClientSendStateEvent("m.room.tombstone",s))return Nl(Object(c.a)("You do not have the required permissions to use this command."));const i=d.getComponent("dialogs.RoomUpgradeWarningDialog"),{finished:o}=Le.a.createTrackedDialog("Slash Commands","upgrade room confirmation",i,{roomId:e,targetVersion:t},null,!1,!0);return Pl(o.then(async([i])=>{if(!i.continue)return;let o;try{const a=s.upgradeRoom(e,t);i.invite&&(o=async e=>{const{replacement_room:t}=await a;if(e.roomId!==t)return;const i=[...n.getMembersWithMembership("join"),...n.getMembersWithMembership("invite")].map(e=>e.userId).filter(e=>e!==s.getUserId());i.length>0&&await Object(Je.b)(t,i),s.removeListener("Room",o)},s.on("Room",o)),await a}catch(e){console.error(e),o&&s.removeListener("Room",o);const t=d.getComponent("dialogs.ErrorDialog");Le.a.createTrackedDialog("Slash Commands","room upgrade error",t,{title:Object(c.a)("Error upgrading room"),description:Object(c.a)("Double check that your server supports the room version chosen and try again.")})}}))}return Nl(this.getUsage())},category:Tl.admin}),new jl({command:"nick",args:"<display_name>",description:Object(c.b)("Changes your display nickname"),runFn:function(e,t){return t?Pl(le.a.get().setDisplayName(t)):Nl(this.getUsage())},category:Tl.actions}),new jl({command:"myroomnick",aliases:["roomnick"],args:"<display_name>",description:Object(c.b)("Changes your display nickname in the current room only"),runFn:function(e,t){if(t){const s=le.a.get(),n=s.getRoom(e).currentState.getStateEvents("m.room.member",s.getUserId()),i=Il(Il({},n?n.getContent():{membership:"join"}),{},{displayname:t});return Pl(s.sendStateEvent(e,"m.room.member",i,s.getUserId()))}return Nl(this.getUsage())},category:Tl.actions}),new jl({command:"roomavatar",args:"[<mxc_url>]",description:Object(c.b)("Changes the avatar of the current room"),runFn:function(e,t){let s=Promise.resolve(t);return t||(s=xl()),Pl(s.then(t=>{if(t)return le.a.get().sendStateEvent(e,"m.room.avatar",{url:t},"")}))},category:Tl.actions}),new jl({command:"myroomavatar",args:"[<mxc_url>]",description:Object(c.b)("Changes your avatar in this current room only"),runFn:function(e,t){const s=le.a.get(),n=s.getRoom(e),i=s.getUserId();let o=Promise.resolve(t);return t||(o=xl()),Pl(o.then(t=>{if(!t)return;const o=n.currentState.getStateEvents("m.room.member",i),a=Il(Il({},o?o.getContent():{membership:"join"}),{},{avatar_url:t});return s.sendStateEvent(e,"m.room.member",a,i)}))},category:Tl.actions}),new jl({command:"myavatar",args:"[<mxc_url>]",description:Object(c.b)("Changes your avatar in all rooms"),runFn:function(e,t){let s=Promise.resolve(t);return t||(s=xl()),Pl(s.then(e=>{if(e)return le.a.get().setAvatarUrl(e)}))},category:Tl.actions}),new jl({command:"topic",args:"[<topic>]",description:Object(c.b)("Gets or sets the room topic"),runFn:function(e,t){const s=le.a.get();if(t)return Pl(s.setRoomTopic(e,t));const n=s.getRoom(e);if(!n)return Nl(Object(c.a)("Failed to set topic"));const i=n.currentState.getStateEvents("m.room.topic",""),a=i&&i.getContent().topic,r=a?Object(pn.f)(a):Object(c.a)("This room has no topic."),l=d.getComponent("dialogs.InfoDialog");return Le.a.createTrackedDialog("Slash Commands","Topic",l,{title:n.name,description:o.createElement("div",{dangerouslySetInnerHTML:{__html:r}}),hasCloseButton:!0}),Pl()},category:Tl.admin}),new jl({command:"roomname",args:"<name>",description:Object(c.b)("Sets the room name"),runFn:function(e,t){return t?Pl(le.a.get().setRoomName(e,t)):Nl(this.getUsage())},category:Tl.admin}),new jl({command:"invite",args:"<user-id> [<reason>]",description:Object(c.b)("Invites user with given id to current room"),runFn:function(e,t){if(t){const[s,n]=t.split(/\s+(.+)/);if(s){let t=Promise.resolve();if("email"===Object(fl.d)(s)&&!le.a.get().getIdentityServerUrl()){const e=Object(yl.c)();if(!e)return Nl(Object(c.a)("Use an identity server to invite by email. Manage in Settings."));{const{finished:s}=Le.a.createTrackedDialog("Slash Commands","Identity server",Me.a,{title:Object(c.a)("Use an identity server"),description:o.createElement("p",null,Object(c.a)("Use an identity server to invite by email. Click continue to use the default identity server (%(defaultIdentityServerName)s) or manage in Settings.",{defaultIdentityServerName:Object(bl.a)(e)})),button:Object(c.a)("Continue")});t=s.then(([e])=>{if(!e)throw new Error(Object(c.a)("Use an identity server to invite by email. Manage in Settings."));Object(yl.d)()})}}const i=new ml.a(e);return Pl(t.then(()=>i.invite([s],n)).then(()=>{if("invited"!==i.getCompletionState(s))throw new Error(i.getErrorText(s))}))}}return Nl(this.getUsage())},category:Tl.actions}),new jl({command:"join",aliases:["j","goto"],args:"<room-address>",description:Object(c.b)("Joins room with given address"),runFn:function(e,t){if(t){const e=t.split(" ");if(e.length<1)return Nl(this.getUsage());let s=!1;if(e[0].startsWith("http:")||e[0].startsWith("https:")){const t=new URL(e[0]),n=t.host||t.hostname;Object(_l.d)(n)&&(s=!0)}if("#"===e[0][0]){let t=e[0];return t.includes(":")||(t+=":"+le.a.get().getDomain()),u.a.dispatch({action:"view_room",room_alias:t,auto_join:!0,_type:"slash_command"}),Pl()}if("!"===e[0][0]){const[t,...s]=e;return u.a.dispatch({action:"view_room",room_id:t,opts:{viaServers:s},via_servers:s,auto_join:!0,_type:"slash_command"}),Pl()}if(s){const t=Object(_l.j)(e[0]);if(!t)return Nl(this.getUsage());if(!t.roomIdOrAlias)return Nl(this.getUsage());const s=t.roomIdOrAlias,n=t.viaServers,i=t.eventId,o={action:"view_room",auto_join:!0,_type:"slash_command"};return"!"===s[0]?o.room_id=s:o.room_alias=s,i&&(o.event_id=i,o.highlighted=!0),n&&(o.opts={viaServers:n},o.via_servers=n),u.a.dispatch(o),Pl()}}return Nl(this.getUsage())},category:Tl.actions}),new jl({command:"part",args:"[<room-address>]",description:Object(c.b)("Leave room"),runFn:function(e,t){const s=le.a.get();let n;if(t){const e=t.match(/^(\S+)$/);if(e){let t=e[1];if("#"!==t[0])return Nl(this.getUsage());t.includes(":")||(t+=":"+s.getDomain());const i=s.getRooms();for(let e=0;e<i.length;e++){const s=i[e].currentState.getStateEvents("m.room.aliases");for(let o=0;o<s.length;o++){const a=s[o].getContent().aliases||[];for(let s=0;s<a.length;s++)if(a[s]===t){n=i[e].roomId;break}if(n)break}if(n)break}if(!n)return Nl(Object(c.a)("Unrecognised room address:")+" "+t)}}return n||(n=e),Pl(Object(Cl.d)(n))},category:Tl.actions}),new jl({command:"kick",args:"<user-id> [reason]",description:Object(c.b)("Kicks user with given id"),runFn:function(e,t){if(t){const s=t.match(/^(\S+?)( +(.*))?$/);if(s)return Pl(le.a.get().kick(e,s[1],s[3]))}return Nl(this.getUsage())},category:Tl.admin}),new jl({command:"ban",args:"<user-id> [reason]",description:Object(c.b)("Bans user with given id"),runFn:function(e,t){if(t){const s=t.match(/^(\S+?)( +(.*))?$/);if(s)return Pl(le.a.get().ban(e,s[1],s[3]))}return Nl(this.getUsage())},category:Tl.admin}),new jl({command:"unban",args:"<user-id>",description:Object(c.b)("Unbans user with given ID"),runFn:function(e,t){if(t){const s=t.match(/^(\S+)$/);if(s)return Pl(le.a.get().unban(e,s[1]))}return Nl(this.getUsage())},category:Tl.admin}),new jl({command:"ignore",args:"<user-id>",description:Object(c.b)("Ignores a user, hiding their messages from you"),runFn:function(e,t){if(t){const e=le.a.get(),s=t.match(/^(@[^:]+:\S+)$/);if(s){const t=s[1],n=e.getIgnoredUsers();return n.push(t),Pl(e.setIgnoredUsers(n).then(()=>{const e=d.getComponent("dialogs.InfoDialog");Le.a.createTrackedDialog("Slash Commands","User ignored",e,{title:Object(c.a)("Ignored user"),description:o.createElement("div",null,o.createElement("p",null,Object(c.a)("You are now ignoring %(userId)s",{userId:t})))})}))}}return Nl(this.getUsage())},category:Tl.actions}),new jl({command:"unignore",args:"<user-id>",description:Object(c.b)("Stops ignoring a user, showing their messages going forward"),runFn:function(e,t){if(t){const e=le.a.get(),s=t.match(/(^@[^:]+:\S+$)/);if(s){const t=s[1],n=e.getIgnoredUsers(),i=n.indexOf(t);return-1!==i&&n.splice(i,1),Pl(e.setIgnoredUsers(n).then(()=>{const e=d.getComponent("dialogs.InfoDialog");Le.a.createTrackedDialog("Slash Commands","User unignored",e,{title:Object(c.a)("Unignored user"),description:o.createElement("div",null,o.createElement("p",null,Object(c.a)("You are no longer ignoring %(userId)s",{userId:t})))})}))}}return Nl(this.getUsage())},category:Tl.actions}),new jl({command:"op",args:"<user-id> [<power-level>]",description:Object(c.b)("Define the power level of a user"),runFn:function(e,t){if(t){const s=t.match(/^(\S+?)( +(-?\d+))?$/);let n=50;if(s){const t=s[1];if(4===s.length&&void 0!==s[3]&&(n=parseInt(s[3],10)),!isNaN(n)){const s=le.a.get(),i=s.getRoom(e);if(!i)return Nl(Object(c.a)("Command failed"));const o=i.getMember(t);if(!o||Object(Cl.b)(o.membership)===Cl.a.Leave)return Nl(Object(c.a)("Could not find user in room"));const a=i.currentState.getStateEvents("m.room.power_levels","");return Pl(s.setPowerLevel(e,t,n,a))}}}return Nl(this.getUsage())},category:Tl.admin}),new jl({command:"deop",args:"<user-id>",description:Object(c.b)("Deops user with given id"),runFn:function(e,t){if(t){if(t.match(/^(\S+)$/)){const s=le.a.get(),n=s.getRoom(e);if(!n)return Nl(Object(c.a)("Command failed"));const i=n.currentState.getStateEvents("m.room.power_levels","");return i.getContent().users[t]?Pl(s.setPowerLevel(e,t,void 0,i)):Nl(Object(c.a)("Could not find user in room"))}}return Nl(this.getUsage())},category:Tl.admin}),new jl({command:"devtools",description:Object(c.b)("Opens the Developer Tools dialog"),runFn:function(e){const t=d.getComponent("dialogs.DevtoolsDialog");return Le.a.createDialog(t,{roomId:e}),Pl()},category:Tl.advanced}),new jl({command:"addwidget",args:"<url | embed code | Jitsi url>",description:Object(c.b)("Adds a custom widget by URL to the room"),isEnabled:()=>V.b.getValue(nt.a.Widgets),runFn:function(e,t){if(!t)return Nl(Object(c.a)("Please supply a widget URL or embed code"));if(t.toLowerCase().startsWith("<iframe ")){const e=Object(wl.parseFragment)(t);if(e&&e.childNodes&&1===e.childNodes.length){const s=e.childNodes[0];if("iframe"===s.tagName.toLowerCase()&&s.attrs){const e=s.attrs.find(e=>"src"===e.name);console.log("Pulling URL out of iframe (embed code)"),t=e.value}}}if(!t.startsWith("https://")&&!t.startsWith("http://"))return Nl(Object(c.a)("Please supply a https:// or http:// widget URL"));if(xt.a.canUserModifyWidgets(e)){const s=le.a.get().getUserId(),n=(new Date).getTime(),i=encodeURIComponent(`${e}_${s}_${n}`);let o=El.a.CUSTOM,a="Custom Widget",r={};const c=Sl.a.getInstance().parsePreferredConferenceUrl(t);return c&&(console.log("Making /addwidget widget a Jitsi conference"),o=El.a.JITSI,a="Jitsi Conference",r=c,t=xt.a.getLocalJitsiWrapperUrl()),Pl(xt.a.setRoomWidget(e,i,o,t,a,r))}return Nl(Object(c.a)("You cannot modify widgets in this room."))},category:Tl.admin}),new jl({command:"verify",args:"<user-id> <device-id> <device-signing-key>",description:Object(c.b)("Verifies a user, session, and pubkey tuple"),runFn:function(e,t){if(t){const e=t.match(/^(\S+) +(\S+) +(\S+)$/);if(e){const t=le.a.get(),s=e[1],n=e[2],i=e[3];return Pl((async()=>{const e=t.getStoredDevice(s,n);if(!e)throw new Error(Object(c.a)("Unknown (user, session) pair:")+` (${s}, ${n})`);if((await t.checkDeviceTrust(s,n)).isVerified())throw e.getFingerprint()===i?new Error(Object(c.a)("Session already verified!")):new Error(Object(c.a)("WARNING: Session already verified, but keys do NOT MATCH!"));if(e.getFingerprint()!==i){const t=e.getFingerprint();throw new Error(Object(c.a)('WARNING: KEY VERIFICATION FAILED! The signing key for %(userId)s and session %(deviceId)s is "%(fprint)s" which does not match the provided key "%(fingerprint)s". This could mean your communications are being intercepted!',{fprint:t,userId:s,deviceId:n,fingerprint:i}))}await t.setDeviceVerified(s,n,!0);const a=d.getComponent("dialogs.InfoDialog");Le.a.createTrackedDialog("Slash Commands","Verified key",a,{title:Object(c.a)("Verified key"),description:o.createElement("div",null,o.createElement("p",null,Object(c.a)("The signing key you provided matches the signing key you received from %(userId)s's session %(deviceId)s. Session marked as verified.",{userId:s,deviceId:n})))})})())}}return Nl(this.getUsage())},category:Tl.advanced}),new jl({command:"discardsession",description:Object(c.b)("Forces the current outbound group session in an encrypted room to be discarded"),runFn:function(e){try{le.a.get().forceDiscardSession(e)}catch(e){return Nl(e.message)}return Pl()},category:Tl.advanced}),new jl({command:"rainbow",description:Object(c.b)("Sends the given message coloured as a rainbow"),args:"<message>",runFn:function(e,t){return t?Dl(hl.makeHtmlMessage(t,pl(t))):Nl(this.getUserId())},category:Tl.messages}),new jl({command:"rainbowme",description:Object(c.b)("Sends the given emote coloured as a rainbow"),args:"<message>",runFn:function(e,t){return t?Dl(hl.makeHtmlEmote(t,pl(t))):Nl(this.getUserId())},category:Tl.messages}),new jl({command:"help",description:Object(c.b)("Displays list of commands with usages and descriptions"),runFn:function(){const e=d.getComponent("dialogs.SlashCommandHelpDialog");return Le.a.createTrackedDialog("Slash Commands","Help",e),Pl()},category:Tl.advanced}),new jl({command:"whois",description:Object(c.b)("Displays information about a user"),args:"<user-id>",runFn:function(e,t){if(!t||!t.startsWith("@")||!t.includes(":"))return Nl(this.getUsage());const s=le.a.get().getRoom(e).getMember(t);return u.a.dispatch({action:h.a.ViewUser,member:s||{userId:t}}),Pl()},category:Tl.advanced}),new jl({command:"rageshake",aliases:["bugreport"],description:Object(c.b)("Send a bug report with logs"),isEnabled:()=>!!l.a.get().bug_report_endpoint_url,args:"<description>",runFn:function(e,t){return Pl(Le.a.createTrackedDialog("Slash Commands","Bug Report Dialog",Be,{initialText:t}).finished)},category:Tl.advanced}),new jl({command:"query",description:Object(c.b)("Opens chat with the given user"),args:"<user-id>",runFn:function(e,t){const s=t&&/^\+?[0123456789]+$/.test(t);return t&&(t.startsWith("@")&&t.includes(":")||s)?Pl((async()=>{if(s){const e=await De.e.sharedInstance().pstnLookup(this.state.value);if(!e||0===e.length||!e[0].userid)throw new Error("Unable to find Matrix ID for phone number");t=e[0].userid}const e=await Object(Rs.c)(le.a.get(),t);u.a.dispatch({action:"view_room",room_id:e})})()):Nl(this.getUsage())},category:Tl.actions}),new jl({command:"msg",description:Object(c.b)("Sends a message to the given user"),args:"<user-id> <message>",runFn:function(e,t){if(t){const e=t.match(/^(\S+?)(?: +(.*))?$/s);if(e){const[t,s]=e.slice(1);if(s&&t&&t.startsWith("@")&&t.includes(":"))return Pl((async()=>{const e=le.a.get(),n=await Object(Rs.c)(e,t);u.a.dispatch({action:"view_room",room_id:n}),e.sendTextMessage(n,s)})())}}return Nl(this.getUsage())},category:Tl.actions}),new jl({command:"holdcall",description:Object(c.b)("Places the call in the current room on hold"),category:Tl.other,runFn:function(e,t){const s=De.e.sharedInstance().getCallForRoom(e);return s?(s.setRemoteOnHold(!0),Pl()):Nl("No active call in this room")}}),new jl({command:"unholdcall",description:Object(c.b)("Takes the call in the current room off hold"),category:Tl.other,runFn:function(e,t){const s=De.e.sharedInstance().getCallForRoom(e);return s?(s.setRemoteOnHold(!1),Pl()):Nl("No active call in this room")}}),new jl({command:"converttodm",description:Object(c.b)("Converts the room to a DM"),category:Tl.other,runFn:function(e,t){const s=le.a.get().getRoom(e);return Pl(Object(Ol.b)(s,!0))}}),new jl({command:"converttoroom",description:Object(c.b)("Converts the DM to a room"),category:Tl.other,runFn:function(e,t){const s=le.a.get().getRoom(e);return Pl(Object(Ol.b)(s,!1))}}),new jl({command:"me",args:"<message>",description:Object(c.b)("Displays action"),category:Tl.messages,hideCompletionAfterSpace:!0}),...kl.CHAT_EFFECTS.map(e=>new jl({command:e.command,description:e.description(),args:"<message>",runFn:function(t,s){return Pl((async()=>{if(s){const n={msgtype:e.msgType,body:s};le.a.get().sendMessage(t,n)}else s=e.fallbackMessage(),le.a.get().sendEmoteMessage(t,s);u.a.dispatch({action:"effects."+e.command})})())},category:Tl.effects}))],Ml=new Map;function Ul(e){if("/"!==(e=e.replace(/\s+$/,""))[0])return{};const t=e.match(/^(\S+?)(?:[ \n]+((.|\n)*))?$/);let s,n;return t?(s=t[1].substring(1).toLowerCase(),n=t[2]):s=e,{cmd:s,args:n}}function Ll(e){const{cmd:t,args:s}=Ul(e);return Ml.has(t)&&Ml.get(t).isEnabled()?{cmd:Ml.get(t),args:s}:{}}Al.forEach(e=>{Ml.set(e.command,e),e.aliases.forEach(t=>{Ml.set(t,e)})});const Fl=/(^\/\w*)(?: .*)?/g;const Bl=/\B\+\S*/g;class Vl extends cl{constructor(){super(Bl),x()(this,"matcher",void 0),this.matcher=new ll.a([],{keys:["groupId","name","shortDescription"]})}async getCompletions(e,t,s=!1,n=-1){const i=d.getComponent("views.avatars.BaseAvatar");if(/^(\/join|\/leave)/.test(e))return[];const o=le.a.get();let r=[];const{command:c,range:l}=this.getCurrentCommand(e,t,s);if(c){const e=o.getGroups().filter(({myMembership:e})=>"join"===e),t=await Promise.all(e.map(async({groupId:e})=>{try{return et.a.getGroupProfileCached(o,e)}catch(t){return Promise.resolve({name:"",groupId:e,avatarUrl:"",shortDescription:""})}}));this.matcher.setObjects(t);const s=c[0];r=this.matcher.match(s,n),r=Object(li.sortBy)(r,[e=>function(e,t){const s=t.indexOf(e);return-1===s?1/0:s}(s,e.groupId),e=>e.groupId.length]).map(({avatarUrl:e,groupId:t,name:s})=>({completion:t,suffix:" ",type:"community",href:Object(_l.f)(t),component:a.a.createElement(ul,{title:s,description:t},a.a.createElement(i,{name:s||t,width:24,height:24,url:e?Object(pe.b)(e).getSquareThumbnailHttp(24):null})),range:l})).slice(0,4)}return r}getName(){return"💬 "+Object(c.a)("Communities")}renderCompletions(e){return a.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"listbox","aria-label":Object(c.a)("Community Autocomplete")},e)}}const Kl=/\/ddg\s+(.+)$/g;class Wl extends cl{constructor(){super(Kl)}static getQueryUri(e){return"https://api.duckduckgo.com/?q="+encodeURIComponent(e)+"&format=json&no_redirect=1&no_html=1&t="+encodeURIComponent("vector")}async getCompletions(e,t,s=!1,n=-1){const{command:i,range:o}=this.getCurrentCommand(e,t);if(!e||!i)return[];const r=await fetch(Wl.getQueryUri(i[1]),{method:"GET"}),c=await r.json(),l=n>-1?n:c.Results.length,d=c.Results.slice(0,l).map(e=>({completion:e.Text,component:a.a.createElement(dl,{title:e.Text,description:e.Result}),range:o}));return c.Answer&&d.unshift({completion:c.Answer,component:a.a.createElement(dl,{title:c.Answer,description:c.AnswerType}),range:o}),c.RelatedTopics&&c.RelatedTopics.length>0&&d.unshift({completion:c.RelatedTopics[0].Text,component:a.a.createElement(dl,{title:c.RelatedTopics[0].Text}),range:o}),c.AbstractText&&d.unshift({completion:c.AbstractText,component:a.a.createElement(dl,{title:c.AbstractText}),range:o}),d}getName(){return"🔍 "+Object(c.a)("Results from DuckDuckGo")}renderCompletions(e){return a.a.createElement("div",{className:"mx_Autocomplete_Completion_container_block",role:"listbox","aria-label":Object(c.a)("DuckDuckGo Results")},e)}}const Gl=/\B#\S*/g;function ql(e,t,s=""){return{room:e,matchName:s,displayedAlias:t}}class Hl extends cl{constructor(){super(Gl),x()(this,"matcher",void 0),this.matcher=new ll.a([],{keys:["displayedAlias","matchName"]})}getRooms(){let e=le.a.get().getVisibleRooms();return V.b.getValue("feature_spaces")&&(e=e.filter(e=>!e.isSpaceRoom())),e}async getCompletions(e,t,s=!1,n=-1){let i=[];const{command:o,range:r}=this.getCurrentCommand(e,t,s);if(o){let e=this.getRooms().reduce((e,t)=>{if(t.getCanonicalAlias()&&(e=e.concat(ql(t,t.getCanonicalAlias(),t.name))),t.getAltAliases().length){const s=t.getAltAliases().map(e=>ql(t,e));e=e.concat(s)}return e},[]);e=e.filter(t=>{const s=t.room.currentState.getStateEvents("m.room.tombstone","");if(s&&s.getContent()&&s.getContent().replacement_room){return!e.some(e=>e.room.roomId===s.getContent().replacement_room)}return!0}),this.matcher.setObjects(e);const t=o[0];i=this.matcher.match(t,n),i=Object(li.sortBy)(i,[e=>{return t=e.displayedAlias,s=e.room,t===s.getCanonicalAlias()?0:1;var t,s},e=>e.displayedAlias.length]),i=Object(li.uniqBy)(i,e=>e.room),i=i.map(e=>({completion:e.displayedAlias,completionId:e.room.roomId,type:"room",suffix:" ",href:Object(_l.g)(e.displayedAlias),component:a.a.createElement(ul,{title:e.room.name,description:e.displayedAlias},a.a.createElement(Oe.a,{width:24,height:24,room:e.room})),range:r})).filter(e=>!!e.completion&&e.completion.length>0)}return i}getName(){return Object(c.a)("Rooms")}renderCompletions(e){return a.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"listbox","aria-label":Object(c.a)("Room Autocomplete")},e)}}const $l=/\B@\S*/g,zl=/[^/,:; \t\n]\S*/g;var Yl=s(729),Jl=s.n(Yl);const Ql=new RegExp("("+Jl.a.source+"|(?:^|\\s):[+-\\w]*:?)$","g"),Xl=qa.b.sort((e,t)=>e.group===t.group?e.order-t.order:e.group-t.group).map((e,t)=>({emoji:e,shortname:`:${e.shortcodes[0]}:`,_orderBy:t}));function Zl(e,t){const s=t.indexOf(e);return-1===s?1/0:s}const ed=/@\S*/g;var td=s(149);class sd extends Hl{getRooms(){return le.a.get().getVisibleRooms().filter(e=>e.isSpaceRoom())}getName(){return Object(c.a)("Spaces")}renderCompletions(e){return a.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"listbox","aria-label":Object(c.a)("Space Autocomplete")},e)}}const nd=[class extends cl{constructor(e){super($l,zl),x()(this,"matcher",void 0),x()(this,"users",void 0),x()(this,"room",void 0),x()(this,"onRoomTimeline",(e,t,s,n,i)=>{t&&(n||t.roomId===this.room.roomId&&i.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&!s&&i&&i.liveEvent&&this.onUserSpoke(e.sender))}),x()(this,"onRoomStateMember",(e,t,s)=>{s.roomId===this.room.roomId&&(this.users=null)}),this.room=e,this.matcher=new ll.a([],{keys:["name"],funcs:[e=>e.userId.slice(1)],shouldMatchWordsOnly:!1}),le.a.get().on("Room.timeline",this.onRoomTimeline),le.a.get().on("RoomState.members",this.onRoomStateMember)}destroy(){le.a.get()&&(le.a.get().removeListener("Room.timeline",this.onRoomTimeline),le.a.get().removeListener("RoomState.members",this.onRoomStateMember))}async getCompletions(e,t,s=!1,n=-1){const i=d.getComponent("views.avatars.MemberAvatar");this.users||this._makeUsers();let o=[];const{command:r,range:c}=this.getCurrentCommand(e,t,s);if(!r)return o;const l=r[0];if(l&&"@"!==l){const e=l.startsWith("@")?l.substring(1):l;o=this.matcher.match(e,n).map(e=>{const s=e.name||e.userId||"";return{completion:e.rawDisplayName,completionId:e.userId,type:"user",suffix:t.beginning&&0===c.start?": ":" ",href:Object(_l.h)(e.userId),component:a.a.createElement(ul,{title:s,description:e.userId},a.a.createElement(i,{member:e,width:24,height:24})),range:c}})}return o}getName(){return Object(c.a)("Users")}_makeUsers(){const e=this.room.getLiveTimeline().getEvents(),t={};for(const s of e)t[s.getSender()]=s.getTs();const s=le.a.get().credentials.userId;this.users=this.room.getJoinedMembers().filter(({userId:e})=>e!==s),this.users=this.users.concat(this.room.getMembersWithMembership("invite")),this.users=Object(li.sortBy)(this.users,e=>1e20-t[e.userId]||1e20),this.matcher.setObjects(this.users)}onUserSpoke(e){this.users&&e&&e.userId!==le.a.get().credentials.userId&&(this.users.splice(this.users.findIndex(t=>t.userId===e.userId),1),this.users=[e,...this.users],this.matcher.setObjects(this.users))}renderCompletions(e){return a.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"listbox","aria-label":Object(c.a)("User Autocomplete")},e)}shouldForceComplete(){return!0}},Hl,class extends cl{constructor(){super(Ql),x()(this,"matcher",void 0),x()(this,"nameMatcher",void 0),this.matcher=new ll.a(Xl,{keys:["emoji.emoticon","shortname"],funcs:[e=>e.emoji.shortcodes.length>1?e.emoji.shortcodes.slice(1).map(e=>`:${e}:`).join(" "):""],shouldMatchWordsOnly:!1}),this.nameMatcher=new ll.a(Xl,{keys:["emoji.annotation"],shouldMatchWordsOnly:!0})}async getCompletions(e,t,s,n=-1){if(!V.b.getValue("MessageComposerInput.suggestEmoji"))return[];let i=[];const{command:o,range:r}=this.getCurrentCommand(e,t);if(o){const e=o[0];i=this.matcher.match(e,n),i=i.concat(this.nameMatcher.match(e));const t=[];t.push(t=>Zl(e,t.emoji.emoticon||"")),t.push(t=>Zl(e,t.shortname)),t.push(t=>Math.min(...t.emoji.shortcodes.map(t=>Zl(e.substring(1),t)))),e.length>1&&t.push(e=>e.shortname.length),t.push(e=>e._orderBy),i=Object(li.sortBy)(Object(li.uniq)(i),t),i=i.map(({shortname:e})=>{const t=Object(pn.i)(e);return{completion:t,component:a.a.createElement(ul,{title:e,"aria-label":t},a.a.createElement("span",null,t)),range:r}}).slice(0,20)}return i}getName(){return"😃 "+Object(c.a)("Emoji")}renderCompletions(e){return a.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"listbox","aria-label":Object(c.a)("Emoji Autocomplete")},e)}},class extends cl{constructor(e){super(ed),x()(this,"room",void 0),this.room=e}async getCompletions(e,t,s=!1,n=-1){const i=d.getComponent("views.avatars.RoomAvatar"),o=le.a.get();if(!this.room.currentState.mayTriggerNotifOfType("room",o.credentials.userId))return[];const{command:r,range:l}=this.getCurrentCommand(e,t,s);return r&&r[0]&&"@room".startsWith(r[0])&&r[0].length>1?[{completion:"@room",completionId:"@room",type:"at-room",suffix:" ",component:a.a.createElement(ul,{title:"@room",description:Object(c.a)("Notify the whole room")},a.a.createElement(i,{width:24,height:24,room:this.room})),range:l}]:[]}getName(){return"❗️ "+Object(c.a)("Room Notification")}renderCompletions(e){return a.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"listbox","aria-label":Object(c.a)("Notification Autocomplete")},e)}},class extends cl{constructor(){super(Fl),x()(this,"matcher",void 0),this.matcher=new ll.a(Al,{keys:["command","args","description"],funcs:[({aliases:e})=>e.join(" ")]})}async getCompletions(e,t,s,n=-1){const{command:i,range:o}=this.getCurrentCommand(e,t);if(!i)return[];let r=[];if(i[0]!==i[1]){const e=i[1].substr(1);if(Ml.has(e)&&Ml.get(e).isEnabled()){if(Ml.get(e).hideCompletionAfterSpace)return[];r=[Ml.get(e)]}}else r="/"===e?Al:this.matcher.match(i[1],n);return r.filter(e=>e.isEnabled()).map(e=>{let t=e.getCommand()+" ";const s=e.aliases.find(e=>"/"+e===i[1]);return(s||e.getCommand()===i[1])&&(t=i[0]),{completion:t,type:"command",component:a.a.createElement(dl,{title:"/"+(s||e.command),subtitle:e.args,description:Object(c.a)(e.description)}),range:o}})}getName(){return"*️⃣ "+Object(c.a)("Commands")}renderCompletions(e){return a.a.createElement("div",{className:"mx_Autocomplete_Completion_container_block",role:"listbox","aria-label":Object(c.a)("Command Autocomplete")},e)}},Wl];V.b.getValue("feature_spaces")?nd.push(sd):nd.push(Vl);class id{constructor(e){x()(this,"room",void 0),x()(this,"providers",void 0),this.room=e,this.providers=nd.map(t=>new t(e))}destroy(){this.providers.forEach(e=>{e.destroy()})}async getCompletions(e,t,s=!1,n=-1){return(await Promise.all(this.providers.map(async i=>await Object(td.d)(i.getCompletions(e,t,s,n),null,3e3)))).map((n,i)=>{if(n&&n.length)return{completions:n,provider:this.providers[i],command:this.providers[i].getCurrentCommand(e,t,s)}}).filter(Boolean)}}var od;const ad=e=>"mx_Autocomplete_Completion_"+e;let rd=Object(P.a)("views.rooms.Autocomplete")(od=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"autocompleter",void 0),x()(this,"queryRequested",void 0),x()(this,"debounceCompletionsRequest",void 0),x()(this,"containerRef",Object(o.createRef)()),x()(this,"hide",()=>{this.setState({hide:!0,selectionOffset:0,completions:[],completionList:[]})}),x()(this,"onCompletionClicked",e=>0!==this.countCompletions()&&0!==e&&(this.props.onConfirm(this.state.completionList[e-1]),this.hide(),!0)),this.autocompleter=new id(e.room),this.state={completions:[],completionList:[],selectionOffset:0,shouldShowCompletions:!0,hide:!1,forceComplete:!1}}componentDidMount(){this.applyNewProps()}applyNewProps(e,t){t&&this.props.room.roomId!==t.roomId&&(this.autocompleter.destroy(),this.autocompleter=new id(this.props.room)),e!==this.props.query&&this.complete(this.props.query,this.props.selection)}componentWillUnmount(){this.autocompleter.destroy()}complete(e,t){if(this.queryRequested=e,this.debounceCompletionsRequest&&clearTimeout(this.debounceCompletionsRequest),""===e)return this.setState({completions:[],completionList:[],selectionOffset:0,hide:!0}),Promise.resolve(null);let s=V.b.getValue("autocompleteDelay");return(this.state.completions.length>0||this.state.forceComplete)&&(s=0),new Promise(n=>{this.debounceCompletionsRequest=setTimeout(()=>{n(this.processQuery(e,t))},s)})}processQuery(e,t){return this.autocompleter.getCompletions(e,t,this.state.forceComplete,20).then(t=>{e===this.queryRequested&&this.processCompletions(t)})}processCompletions(e){const t=Object(li.flatMap)(e,e=>e.completions);let s=0;if(t.length>0){const e=0===this.state.selectionOffset?null:this.state.completionList[this.state.selectionOffset-1].completion;s=t.findIndex(t=>t.completion===e),-1===s?s=0:s++}let n=this.state.hide;n=!e.some(e=>!!e.command.command),this.setState({completions:e,completionList:t,selectionOffset:s,hide:n,forceComplete:!1})}hasSelection(){return this.countCompletions()>0&&0!==this.state.selectionOffset}countCompletions(){return this.state.completionList.length}moveSelection(e){const t=this.countCompletions();if(0===t)return;const s=(this.state.selectionOffset+e+t+1)%(t+1);this.setSelection(s)}onEscape(e){0!==this.countCompletions()&&(e.preventDefault(),this.hide())}forceComplete(){return new Promise(e=>{this.setState({forceComplete:!0,hide:!1},()=>{this.complete(this.props.query,this.props.selection).then(()=>{e(this.countCompletions())})})})}setSelection(e){this.setState({selectionOffset:e,hide:!1}),this.props.onSelectionChange&&this.props.onSelectionChange(this.state.completionList[e-1],e-1)}componentDidUpdate(e){this.applyNewProps(e.query,e.room);const t=this.refs["completion"+this.state.selectionOffset];t?t.scrollIntoView({behavior:"auto",block:"nearest"}):this.containerRef.current&&this.containerRef.current.scrollTo({top:0})}render(){let e=1;const t=this.state.completions.map((t,s)=>{const n=t.completions.map((t,s)=>{const n=e===this.state.selectionOffset,i=M()("mx_Autocomplete_Completion",{selected:n}),o=e;e++;return a.a.cloneElement(t.component,{key:s,ref:"completion"+o,id:ad(o-1),className:i,onClick:()=>{this.onCompletionClicked(o)},"aria-selected":n})});return n.length>0?a.a.createElement("div",{key:s,className:"mx_Autocomplete_ProviderSection"},a.a.createElement("div",{className:"mx_Autocomplete_provider_name"},t.provider.getName()),t.provider.renderCompletions(n)):null}).filter(e=>!!e);return!this.state.hide&&t.length>0?a.a.createElement("div",{className:"mx_Autocomplete",ref:this.containerRef},t):null}})||od;var cd=s(716);class ld{constructor(){x()(this,"stack",[]),x()(this,"newlyTypedCharCount",0),x()(this,"currentIndex",-1),x()(this,"changedSinceLastPush",!1),x()(this,"lastCaret",null),x()(this,"nonWordBoundarySinceLastPush",!1),x()(this,"addedSinceLastPush",!1),x()(this,"removedSinceLastPush",!1)}clear(){this.stack=[],this.newlyTypedCharCount=0,this.currentIndex=-1,this.changedSinceLastPush=!1,this.lastCaret=null,this.nonWordBoundarySinceLastPush=!1,this.addedSinceLastPush=!1,this.removedSinceLastPush=!1}shouldPush(e,t){if(t&&("insertText"===e||"deleteContentForward"===e||"deleteContentBackward"===e)){if(t.added&&(this.addedSinceLastPush=!0),t.removed&&(this.removedSinceLastPush=!0),this.addedSinceLastPush!==this.removedSinceLastPush){const e=t.added?t.added:t.removed,s=" "===e||"\t"===e||"\n"===e;return!(!this.nonWordBoundarySinceLastPush||!s)||(s||(this.nonWordBoundarySinceLastPush=!0),this.newlyTypedCharCount+=e.length,this.newlyTypedCharCount>10)}return!0}return!0}pushState(e,t){for(;this.currentIndex<this.stack.length-1;)this.stack.pop();const s=e.serializeParts();this.stack.push({parts:s,caret:t}),this.currentIndex=this.stack.length-1,this.lastCaret=null,this.changedSinceLastPush=!1,this.newlyTypedCharCount=0,this.nonWordBoundarySinceLastPush=!1,this.addedSinceLastPush=!1,this.removedSinceLastPush=!1}tryPush(e,t,s,n){if("historyUndo"===s||"historyRedo"===s)return!1;const i=this.shouldPush(s,n);return i?this.pushState(e,t):(this.lastCaret=t,this.changedSinceLastPush=!0),i}ensureLastChangesPushed(e){this.changedSinceLastPush&&this.pushState(e,this.lastCaret)}canUndo(){return this.currentIndex>=1||this.changedSinceLastPush}canRedo(){return this.currentIndex<this.stack.length-1}undo(e){if(this.canUndo())return this.ensureLastChangesPushed(e),this.currentIndex-=1,this.stack[this.currentIndex]}redo(){if(this.canRedo())return this.changedSinceLastPush=!1,this.currentIndex+=1,this.stack[this.currentIndex]}}function dd(e,t){const s=!t||"newline"===t.type;return!e.canEdit&&(s||!t.canEdit)}function ud(e,t){return!e.canEdit&&t}function hd(e,t){const s=e.nextSibling;s?e.parentElement.insertBefore(t,s):e.parentElement.appendChild(t)}function md(){const e=document.createElement("span");return e.className="caretNode",e.appendChild(document.createTextNode("\ufeff")),e}function pd(e){"\ufeff"!==e.textContent&&(e.textContent="\ufeff")}function gd(e){return e&&"SPAN"===e.tagName&&"caretNode"===e.className}function vd(e){if(e)for(e=e.nextSibling;e;){const t=e;e=e.nextSibling,t.remove()}}function fd(e,t){const s=t.parts.reduce((e,t)=>{if("newline"===t.type)e.push([]);else{e[e.length-1].push(t)}return e},[[]]);s.forEach((t,s)=>{let n=e.childNodes[s];for(;n&&("DIV"!==n.tagName||n.className);)e.removeChild(n),n=e.childNodes[s];n||(n=document.createElement("div"),e.appendChild(n)),t.length?function(e,t){let s,n;const i=t[t.length-1];for(const o of t){for(s=!n?e.firstChild:s.nextSibling,dd(o,n)&&(gd(s)?(pd(s),s=s.nextSibling):e.insertBefore(md(),s));s&&!o.canUpdateDOMNode(s);){const t=s.nextSibling;e.removeChild(s),s=t}if(s&&o?o.updateDOMNode(s):o&&(s=o.toDOMNode(),e.appendChild(s)),ud(o,o===i))if(gd(s.nextSibling))s=s.nextSibling,pd(s);else{const e=md();hd(s,e),s=e}n=o}vd(s)}(n,t):function(e){let t=!1,s=e.firstChild;for(;s;){const e=s.nextSibling;t||"BR"!==s.tagName?s.remove():t=!0,s=e}t||e.appendChild(document.createElement("br"))}(n)}),s.length?vd(e.children[s.length-1]):function(e){const t=e.firstChild;t&&(vd(t),t.remove())}(e)}const bd=(e,t,s)=>""===s.text[t].trim();class yd{constructor(e,t,s=t){this.model=e,x()(this,"_start",void 0),x()(this,"_end",void 0);const n=t.compare(s)<0;this._start=n?t:s,this._end=n?s:t}moveStart(e){this._start=this._start.forwardsWhile(this.model,()=>(e-=1)>=0)}trim(){this._start=this._start.forwardsWhile(this.model,bd),this._end=this._end.backwardsWhile(this.model,bd)}expandBackwardsWhile(e){this._start=this._start.backwardsWhile(this.model,e)}get text(){let e="";return this._start.iteratePartsBetween(this._end,this.model,(t,s,n)=>{const i=t.text.substring(s,n);e+=i}),e}replace(e){const t=e.reduce((e,t)=>e+t.text.length,0);let s=0;return this._start.iteratePartsBetween(this._end,this.model,(e,t,n)=>{s+=n-t}),this.model.replaceRange(this._start,this._end,e),t-s}get parts(){const e=[];return this._start.iteratePartsBetween(this._end,this.model,(t,s,n)=>{const i=t.serialize();i.text=t.text.substring(s,n);const o=this.model.partCreator.deserializePart(i);e.push(o)}),e}get length(){let e=0;return this._start.iteratePartsBetween(this._end,this.model,(t,s,n)=>{e+=n-s}),e}get start(){return this._start}get end(){return this._end}}function _d(e,t,s){s instanceof yd?function(e,t,s){const n=document.getSelection();n.removeAllRanges();const i=document.createRange(),o=Ed(e,t,s.start);i.setStart(o.node,o.offset);const a=Ed(e,t,s.end);i.setEnd(a.node,a.offset),n.addRange(i)}(e,t,s):function(e,t,s){const n=document.createRange(),{node:i,offset:o}=Ed(e,t,s);n.setStart(i,o),n.collapse(!0);const a=document.getSelection();if(1===a.rangeCount){const e=a.getRangeAt(0);if(e.startContainer===n.startContainer&&e.startOffset===n.startOffset&&e.collapsed===n.collapsed)return}a.removeAllRanges(),a.addRange(n)}(e,t,s)}function Ed(e,t,s){const{offset:n,lineIndex:i,nodeIndex:o}=function(e,t){const{parts:s}=e,n=t.index,i=function(e,t){let s=0,n=-1,i=null;for(let o=0;o<=t;++o){const a=e[o];if("newline"===a.type)s+=1,n=-1,i=null;else{if(n+=1,dd(a,i)&&(n+=1),o<t){const t=e[o+1],s=!t||"newline"===t.type;ud(a,s)&&(n+=1)}i=a}}return{lineIndex:s,nodeIndex:n}}(s,n),{lineIndex:o}=i;let{nodeIndex:a}=i,{offset:r}=t;-1===a?r=0:({nodeIndex:a,offset:r}=function(e,t,s,n){const i=e[t];if(i&&!i.canEdit)if(0===n){s-=1;const o=e[t-1];dd(i,o)||(n=o.text.length)}else s+=1,n=0;return{nodeIndex:s,offset:n}}(s,n,a,r));return{lineIndex:o,nodeIndex:a,offset:r}}(t,s),a=e.childNodes[i];let r;return-1===o?r=a:(r=a.childNodes[o],r.nodeType===Node.ELEMENT_NODE&&r.firstChild&&(r=r.firstChild)),{node:r,offset:n}}function Sd(e,t){const{model:s}=e;s.transform(()=>{const n=e.length,i=e.replace(t),o=e.start.asOffset(s),a=o.add(n+i);return s.startRange(o.asPosition(s),a.asPosition(s))})}function wd(e,t){const{model:s}=e;s.transform(()=>{const n=e.length,i=e.replace(t);return e.start.asOffset(s).add(n+i).asPosition(s)})}function Cd(e){const{model:t}=e,s=0!==e.start.offset,n=0===e.start.index,i=!n&&"newline"===t.parts[e.start.index-1].type;return!s&&(n||i)}function kd(e){const{model:t}=e,s=t.parts[e.end.index],n=e.end.offset!==s.text.length,i=e.end.index===t.parts.length-1,o=!i&&"newline"===t.parts[e.end.index+1].type;return!n&&(i||o)}const Od=e=>!e.text||!/\S/.test(e.text),Rd=e=>"newline"===e.type;function Id(e,t,s=t){const{model:n,parts:i}=e,{partCreator:o}=n,a=[];let r=0;for(let e=2;e<i.length;e++)Od(i[e-2])&&Rd(i[e-1])&&!Rd(i[e])&&!Od(i[e])&&(r=e),Rd(i[e-1])&&Rd(i[e])?(a.push([r,e-1]),r=e+1):Rd(i[e-2])&&Od(i[e-1])&&Rd(i[e])&&(a.push([r,e-2]),r=e+1);const c=i.map(Od).lastIndexOf(!1);r<=c&&a.push([r,c+1]);let l=0;a.forEach(([e,n])=>{const a=e+l,r=n+l;if(r-a>0&&i[a].text.startsWith(t)&&i[r-1].text.endsWith(s)){const e=i[a].serialize();e.text=e.text.substr(t.length),i[a]=o.deserializePart(e);const n=i[r-1].serialize(),c=n.text;n.text=c.substring(0,c.length-s.length),i[r-1]=o.deserializePart(n)}else i.splice(r,0,o.plain(s)),i.splice(a,0,o.plain(t)),l+=2}),Sd(e,i)}class xd{constructor(e,t){this.offset=e,this.atNodeEnd=t}asPosition(e){return e.positionForOffset(this.offset,this.atNodeEnd)}add(e,t=!1){return new xd(this.offset+e,t)}}function Td(e,t,s){let n=e.firstChild;for(;n&&n!==e;){if(t(n)&&n.firstChild)n=n.firstChild;else if(n.nextSibling)n=n.nextSibling;else{for(;!n.nextSibling&&n!==e;)n=n.parentElement,n!==e&&s(n);n!==e&&(n=n.nextSibling)}}}function jd(e,t){const{offset:s,text:n}=Nd(e,t.focusNode,t.focusOffset);return{caret:s,text:n}}function Nd(e,t,s){const{node:n,characterOffset:i}=function(e,t){for(;e&&e.nodeType===Node.ELEMENT_NODE;){const s=e.childNodes.length;if(!s)break;t>=s?t=(e=e.lastChild).nodeType===Node.TEXT_NODE?e.textContent.length:Number.MAX_SAFE_INTEGER:(e=e.childNodes[t],t=0)}return{node:e,characterOffset:t}}(t,s),{text:o,offsetToNode:a}=function(e,t){let s=0,n=!1,i="";function o(e){n||e===t&&(n=!0),"BR"===e.tagName&&e.nextSibling&&(n||(s+=1),i+="\n");const o=e.nodeType===Node.TEXT_NODE&&function(e){const t=e.nodeValue;return gd(e.parentElement)?1!==t.length?t.replace("\ufeff",""):"":t}(e);return o&&(n||(s+=o.length),i+=o),!0}function a(e){"DIV"===e.tagName&&e.nextSibling&&"DIV"===e.nextSibling.tagName&&(i+="\n",n||(s+=1))}return Td(e,o,a),{text:i,offsetToNode:s}}(e,n);return{offset:function(e,t,s){if(!e)return new xd(0,!1);let n=s===e.textContent.length;if(e.nodeType===Node.TEXT_NODE&&gd(e.parentElement)){const t=e.nodeValue.indexOf("\ufeff");-1!==t&&t<s&&(s-=1),n=!0}return new xd(t+s,n)}(n,a,i),text:o}}function Pd(e,t,s){const n=Nd(e,s.focusNode,s.focusOffset).offset,i=Nd(e,s.anchorNode,s.anchorOffset).offset,o=n.asPosition(t),a=i.asPosition(t);return t.startRange(o,a)}class Dd{constructor(e,t,s,n){this.updateCallback=e,this.getAutocompleterComponent=t,this.updateQuery=s,this.partCreator=n,x()(this,"queryPart",void 0),x()(this,"partIndex",void 0)}onEscape(e){this.getAutocompleterComponent().onEscape(e),this.updateCallback({replaceParts:[this.partCreator.plain(this.queryPart.text)],close:!0})}close(){this.updateCallback({close:!0})}hasSelection(){return this.getAutocompleterComponent().hasSelection()}hasCompletions(){const e=this.getAutocompleterComponent();return e&&e.countCompletions()>0}onEnter(){this.updateCallback({close:!0})}async startSelection(){const e=this.getAutocompleterComponent();0===e.countCompletions()&&(await e.forceComplete(),await e.moveSelection(1))}selectPreviousSelection(){this.getAutocompleterComponent().moveSelection(-1)}selectNextSelection(){this.getAutocompleterComponent().moveSelection(1)}onPartUpdate(e,t){return this.queryPart=e,this.partIndex=t.index,this.updateQuery(e.text)}onComponentSelectionChange(e){e?this.updateCallback({replaceParts:this.partForCompletion(e)}):this.updateCallback({replaceParts:[this.queryPart]})}onComponentConfirm(e){this.updateCallback({replaceParts:this.partForCompletion(e),close:!0})}partForCompletion(e){const{completionId:t}=e,s=e.completion;switch(e.type){case"room":return[this.partCreator.roomPill(s,t),this.partCreator.plain(e.suffix)];case"at-room":return[this.partCreator.atRoomPill(t),this.partCreator.plain(e.suffix)];case"user":return this.partCreator.createMentionParts(0===this.partIndex,s,t);case"command":return[this.partCreator.command(s)];default:return[this.partCreator.plain(s)]}}}var Ad,Md=s(194);!function(e){e.Plain="plain",e.Newline="newline",e.Command="command",e.UserPill="user-pill",e.RoomPill="room-pill",e.AtRoomPill="at-room-pill",e.PillCandidate="pill-candidate"}(Ad||(Ad={}));class Ud{constructor(e=""){x()(this,"_text",void 0),this._text=e}acceptsInsertion(e,t,s){return!0}acceptsRemoval(e,t){return!0}merge(e){return!1}split(e){const t=this.text.substr(e);return this._text=this.text.substr(0,e),new Fd(t)}remove(e,t){const s=this.text.substr(0,e)+this.text.substr(e+t);for(let n=e;n<t+e;++n){const e=this.text.charAt(n);if(!this.acceptsRemoval(n,e))return s}this._text=s}appendUntilRejected(e,t){const s=this.text.length;for(let n=0;n<e.length;++n){const i=e.charAt(n);if(!this.acceptsInsertion(i,s+n,t))return this._text=this._text+e.substr(0,n),e.substr(n)}this._text=this._text+e}validateAndInsert(e,t,s){for(let n=0;n<t.length;++n){const i=t.charAt(n);if(!this.acceptsInsertion(i,e+n,s))return!1}const n=this._text.substr(0,e),i=this._text.substr(e);return this._text=n+t+i,!0}createAutoComplete(e){}trim(e){const t=this._text.substr(e);return this._text=this._text.substr(0,e),t}get text(){return this._text}get canEdit(){return!0}toString(){return`${this.type}(${this.text})`}serialize(){return{type:this.type,text:this.text}}}class Ld extends Ud{acceptsInsertion(e,t,s){return"\n"!==e&&("insertFromPaste"===s||"insertFromDrop"===s||("@"!==e&&"#"!==e&&":"!==e&&"+"!==e||0!==t&&(" "!==this._text[t-1]&&("+"!==this._text[t-1]||":"!==e))))}toDOMNode(){return document.createTextNode(this.text)}merge(e){return e.type===this.type&&(this._text=this.text+e.text,!0)}updateDOMNode(e){e.textContent!==this.text&&(e.textContent=this.text)}canUpdateDOMNode(e){return e.nodeType===Node.TEXT_NODE}}class Fd extends Ld{get type(){return Ad.Plain}}class Bd extends Ud{constructor(e,t){super(t),this.resourceId=e}acceptsInsertion(e){return" "!==e}acceptsRemoval(e,t){return 0!==e}toDOMNode(){const e=document.createElement("span");return e.setAttribute("spellcheck","false"),e.className=this.className,e.appendChild(document.createTextNode(this.text)),this.setAvatar(e),e}updateDOMNode(e){const t=e.childNodes[0];t.textContent!==this.text&&(t.textContent=this.text),e.className!==this.className&&(e.className=this.className),this.setAvatar(e)}canUpdateDOMNode(e){return e.nodeType===Node.ELEMENT_NODE&&"SPAN"===e.nodeName&&1===e.childNodes.length&&e.childNodes[0].nodeType===Node.TEXT_NODE}_setAvatarVars(e,t,s){const n=`url('${t}')`,i=`'${s}'`;e.style.getPropertyValue("--avatar-background")!==n&&e.style.setProperty("--avatar-background",n),e.style.getPropertyValue("--avatar-letter")!==i&&e.style.setProperty("--avatar-letter",i)}serialize(){return{type:this.type,text:this.text,resourceId:this.resourceId}}get canEdit(){return!1}}class Vd extends Ud{acceptsInsertion(e,t){return 0===t&&"\n"===e}acceptsRemoval(e,t){return!0}toDOMNode(){return document.createElement("br")}merge(){return!1}updateDOMNode(){}canUpdateDOMNode(e){return"BR"===e.tagName}get type(){return Ad.Newline}get canEdit(){return!1}}class Kd extends Bd{constructor(e,t,s){super(e,t),this.room=s}setAvatar(e){let t="",s=Md.b(this.room,16,16,"crop");s||(t=Md.e(this.room?this.room.name:this.resourceId),s=Md.d(this.room?this.room.roomId:this.resourceId)),this._setAvatarVars(e,s,t)}get type(){return Ad.RoomPill}get className(){return"mx_RoomPill mx_Pill"}}class Wd extends Kd{constructor(e,t){super(e,e,t)}get type(){return Ad.AtRoomPill}serialize(){return{type:this.type,text:this.text}}}class Gd extends Bd{constructor(e,t,s){super(e,t),this.member=s}setAvatar(e){if(!this.member)return;const t=this.member.name||this.member.userId,s=Md.d(this.member.userId),n=Md.a(this.member,16,16,"crop");let i="";n===s&&(i=Md.e(t)),this._setAvatarVars(e,n,i)}get type(){return Ad.UserPill}get className(){return"mx_UserPill mx_Pill"}}class qd extends Ld{constructor(e,t){super(e),this.autoCompleteCreator=t}createAutoComplete(e){return this.autoCompleteCreator.create(e)}acceptsInsertion(e,t,s){return 0===t||super.acceptsInsertion(e,t,s)}merge(){return!1}acceptsRemoval(e,t){return!0}get type(){return Ad.PillCandidate}}class Hd extends class{constructor(e,t,s=null){this.room=e,this.client=t,x()(this,"autoCompleteCreator",void 0),this.autoCompleteCreator={create:s&&s(this)}}setAutoCompleteCreator(e){this.autoCompleteCreator.create=e(this)}createPartForInput(e,t,s){switch(e[0]){case"#":case"@":case":":case"+":return this.pillCandidate("");case"\n":return new Vd;default:return new Fd}}createDefaultPart(e){return this.plain(e)}deserializePart(e){switch(e.type){case Ad.Plain:return this.plain(e.text);case Ad.Newline:return this.newline();case Ad.AtRoomPill:return this.atRoomPill(e.text);case Ad.PillCandidate:return this.pillCandidate(e.text);case Ad.RoomPill:return this.roomPill(e.resourceId);case Ad.UserPill:return this.userPill(e.text,e.resourceId)}}plain(e){return new Fd(e)}newline(){return new Vd("\n")}pillCandidate(e){return new qd(e,this.autoCompleteCreator)}roomPill(e,t){let s;return s=t||"#"!==e[0]?this.client.getRoom(t||e):this.client.getRooms().find(t=>t.getCanonicalAlias()===e||t.getAltAliases().includes(e)),new Kd(e,s?s.name:e,s)}atRoomPill(e){return new Wd(e,this.room)}userPill(e,t){const s=this.room.getMember(t);return new Gd(t,e,s)}createMentionParts(e,t,s){return[this.userPill(t,s),this.plain(e?": ":" ")]}}{createPartForInput(e,t){return 0===t&&"/"===e[0]?this.command(""):super.createPartForInput(e,t)}command(e){return new $d(e,this.autoCompleteCreator)}deserializePart(e){return"command"===e.type?this.command(e.text):super.deserializePart(e)}}class $d extends qd{get type(){return Ad.Command}}function zd(e,t){const s=[];return e.split("@room").forEach((e,n,i)=>{e.length&&s.push(t.plain(e));n===i.length-1||s.push(t.atRoomPill("@room"))}),s}function Yd(e,t,s,n){switch(e.nodeName){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":return function(e,t){const s=parseInt(e.nodeName.substr(1),10);return t.plain("#".repeat(s)+" ")}(e,t);case"A":return function(e,t){const{href:s}=e,n=Object(_l.c)(s);switch(n?n[0]:void 0){case"@":return t.userPill(e.textContent,n);case"#":return t.roomPill(n);default:return s===e.textContent?t.plain(e.textContent):t.plain(`[${e.textContent.replace(/[[\\\]]/g,e=>"\\"+e)}](${s})`)}}(e,t);case"IMG":return function(e,t){const{src:s}=e;return t.plain(`![${e.alt.replace(/[[\\\]]/g,e=>"\\"+e)}](${s})`)}(e,t);case"BR":return t.newline();case"EM":return t.plain(`_${e.textContent}_`);case"STRONG":return t.plain(`**${e.textContent}**`);case"PRE":return function(e,t){const s=[];let n="";if(e.firstChild&&"CODE"===e.firstChild.nodeName)for(const t of e.firstChild.classList)if(t.startsWith("language-")&&!t.startsWith("language-_")){n=t.substr("language-".length);break}const i=("```"+n+"\n"+e.textContent+"```").split("\n");return i.forEach((e,n)=>{s.push(t.plain(e)),n<i.length-1&&s.push(t.newline())}),s}(e,t);case"CODE":return t.plain(`\`${e.textContent}\``);case"DEL":return t.plain(`<del>${e.textContent}</del>`);case"LI":{const s="  ".repeat(n.listDepth-1);if("OL"===e.parentElement.nodeName){const e=n.listIndex[n.listIndex.length-1];return n.listIndex[n.listIndex.length-1]+=1,t.plain(`${s}${e}. `)}return t.plain(s+"- ")}case"P":if(s)return t.newline();break;case"DIV":case"SPAN":if(e.hasAttribute("data-mx-maths")){const s="SPAN"==e.nodeName?((l.a.get().latex_maths_delims||{}).inline||{}).left||"\\(":((l.a.get().latex_maths_delims||{}).display||{}).left||"\\[",n="SPAN"==e.nodeName?((l.a.get().latex_maths_delims||{}).inline||{}).right||"\\)":((l.a.get().latex_maths_delims||{}).display||{}).right||"\\]",i=e.getAttribute("data-mx-maths");return t.plain(s+i+n)}if(!Jd(e))return t.plain(e.textContent);break;case"OL":n.listIndex.push(e.start||1);case"UL":n.listDepth=(n.listDepth||0)+1;default:if(!Jd(e))return t.plain(e.textContent)}}function Jd(e){switch(e.nodeName){case"PRE":return!1;default:return Object(pn.c)(e)}}function Qd(e){return e.nodeType===Node.TEXT_NODE?"\n"===e.nodeValue:e.nodeType!==Node.ELEMENT_NODE||"MX-REPLY"===e.nodeName}function Xd(e,t,s){const n=e.split(/\r\n|\r|\n/g);return n.reduce((e,i,o)=>{s&&e.push(t.plain("> ")),e.push(...zd(i,t));return o===n.length-1||e.push(t.newline()),e},[])}function Zd(e,t,{isQuotedMessage:s=!1}={}){const n=e.getContent();let i;return i="org.matrix.custom.html"===n.format?function(e,t,s){const n=(new DOMParser).parseFromString(e,"text/html").body,i=[];let o,a=s;const r={listIndex:[]};return Td(n,(function(e){if(Qd(e))return!1;"BLOCKQUOTE"===e.nodeName&&(a=!0);const s=[];if(o&&(Object(pn.c)(o)||Object(pn.c)(e))&&s.push(t.newline()),e.nodeType===Node.TEXT_NODE)s.push(...zd(e.nodeValue,t));else if(e.nodeType===Node.ELEMENT_NODE){const n=Yd(e,t,o,r);n&&(Array.isArray(n)?s.push(...n):s.push(n))}if(s.length&&a){!function(e,t,s){e&&t.splice(0,0,s.plain("> "));for(let e=0;e<t.length;e+=1)"newline"===t[e].type&&(t.splice(e+1,0,s.plain("> ")),e+=1)}(0===i.length,s,t)}i.push(...s);const n=Jd(e);return o=n?null:e,n}),(function(e){if(!Qd(e)){switch(e.nodeName){case"BLOCKQUOTE":a=!1;break;case"OL":r.listIndex.pop();case"UL":r.listDepth-=1}o=e}})),i}(n.formatted_body||"",t,s):Xd(n.body||"",t,s),"m.emote"===n.msgtype&&i.unshift(t.plain("/me ")),i}var eu,tu,su,nu=s(630);let iu=Object(P.a)("views.rooms.MessageComposerFormatBar")((su=tu=class extends a.a.PureComponent{constructor(e){super(e),this.state={visible:!1}}render(){const e=M()("mx_MessageComposerFormatBar",{mx_MessageComposerFormatBar_shown:this.state.visible});return a.a.createElement("div",{className:e,ref:e=>this._formatBarRef=e},a.a.createElement(ou,{label:Object(c.a)("Bold"),onClick:()=>this.props.onAction("bold"),icon:"Bold",shortcut:this.props.shortcuts.bold,visible:this.state.visible}),a.a.createElement(ou,{label:Object(c.a)("Italics"),onClick:()=>this.props.onAction("italics"),icon:"Italic",shortcut:this.props.shortcuts.italics,visible:this.state.visible}),a.a.createElement(ou,{label:Object(c.a)("Strikethrough"),onClick:()=>this.props.onAction("strikethrough"),icon:"Strikethrough",visible:this.state.visible}),a.a.createElement(ou,{label:Object(c.a)("Code block"),onClick:()=>this.props.onAction("code"),icon:"Code",visible:this.state.visible}),a.a.createElement(ou,{label:Object(c.a)("Quote"),onClick:()=>this.props.onAction("quote"),icon:"Quote",shortcut:this.props.shortcuts.quote,visible:this.state.visible}))}showAt(e){this.setState({visible:!0});const t=this._formatBarRef.parentElement.getBoundingClientRect();let s;const n=this._formatBarRef.clientWidth;s=e.left+n+6<t.right?e.left-t.left:t.right-t.left-n-6,this._formatBarRef.style.left=s+"px",this._formatBarRef.style.top=e.top-t.top-16-12+"px"}hide(){this.setState({visible:!1})}},x()(tu,"propTypes",{onAction:wt.a.func.isRequired,shortcuts:wt.a.object.isRequired}),eu=su))||eu;class ou extends a.a.PureComponent{render(){const e="mx_MessageComposerFormatBar_button mx_MessageComposerFormatBar_buttonIcon"+this.props.icon;let t;this.props.shortcut&&(t=a.a.createElement("div",{className:"mx_MessageComposerFormatBar_tooltipShortcut"},this.props.shortcut));const s=a.a.createElement("div",null,a.a.createElement("div",{className:"mx_Tooltip_title"},this.props.label),a.a.createElement("div",{className:"mx_Tooltip_sub"},t));return a.a.createElement(K.a,{element:"button",type:"button",onClick:this.props.onClick,title:this.props.label,tooltip:s,className:e})}}var au;x()(ou,"propTypes",{label:wt.a.string.isRequired,onClick:wt.a.func.isRequired,icon:wt.a.string.isRequired,shortcut:wt.a.string,visible:wt.a.bool});const ru=new RegExp("(?:^|\\s)("+Jl.a.source+")\\s$"),cu=-1!==navigator.platform.indexOf("Mac");function lu(e){return(cu?"⌘":"Ctrl")+"+"+e}function du(e){return{anchorNode:e.anchorNode,anchorOffset:e.anchorOffset,focusNode:e.focusNode,focusOffset:e.focusOffset,isCollapsed:e.isCollapsed,rangeCount:e.rangeCount,type:e.type}}var uu;!function(e){e.Bold="bold",e.Italics="italics",e.Strikethrough="strikethrough",e.Code="code",e.Quote="quote"}(uu||(uu={}));let hu=Object(P.a)("views.rooms.BasicMessageEditor")(au=class extends a.a.Component{constructor(e){super(e),x()(this,"editorRef",Object(o.createRef)()),x()(this,"autocompleteRef",Object(o.createRef)()),x()(this,"formatBarRef",Object(o.createRef)()),x()(this,"modifiedFlag",!1),x()(this,"isIMEComposing",!1),x()(this,"hasTextSelected",!1),x()(this,"_isCaretAtEnd",void 0),x()(this,"lastCaret",void 0),x()(this,"lastSelection",void 0),x()(this,"emoticonSettingHandle",void 0),x()(this,"shouldShowPillAvatarSettingHandle",void 0),x()(this,"historyManager",new ld),x()(this,"replaceEmoticon",e=>{const{model:t}=this.props,s=t.startRange(e);let n=8;s.expandBackwardsWhile((e,s)=>{const i=t.parts[e];return n-=1,n>=0&&("plain"===i.type||"pill-candidate"===i.type)});const i=ru.exec(s.text);if(i){const e=i[1].replace("-",""),n=qa.c.get(e)||qa.c.get(e.toLowerCase());if(n){const{partCreator:e}=t,o=" "===i[0][0];return s.moveStart(i.index+(o?1:0)),s.replace([e.plain(n.unicode+" ")])}}}),x()(this,"updateEditorState",(e,t,s)=>{if(fd(this.editorRef.current,this.props.model),e){try{_d(this.editorRef.current,this.props.model,e)}catch(e){console.error(e)}const t=e instanceof yd?e.end:e;this.setLastCaretFromPosition(t)}const{isEmpty:n}=this.props.model;this.props.placeholder&&(n?this.showPlaceholder():this.hidePlaceholder()),n&&this.formatBarRef.current.hide(),this.setState({autoComplete:this.props.model.autoComplete}),this.historyManager.tryPush(this.props.model,e,t,s);let i=!this.props.model.isEmpty;if(i&&"command"===this.props.model.parts[0].type){const{cmd:e}=Ul(this.props.model.parts[0].text),t=Ml.get(e);t&&t.isEnabled()&&t.category===Tl.messages||(i=!1)}nu.a.sharedInstance().setSelfTyping(this.props.room.roomId,i),this.props.onChange&&this.props.onChange()}),x()(this,"onCompositionStart",()=>{this.isIMEComposing=!0,this.hidePlaceholder()}),x()(this,"onCompositionEnd",()=>{this.isIMEComposing=!1;const e=navigator.userAgent.toLowerCase();e.includes("safari/")&&!e.includes("chrome/")?this.onInput({inputType:"insertCompositionText"}):Promise.resolve().then(()=>{this.onInput({inputType:"insertCompositionText"})})}),x()(this,"onCutCopy",(e,t)=>{const s=document.getSelection(),n=s.toString();if(n){const{model:i}=this.props,o=Pd(this.editorRef.current,i,s),a=o.parts.map(e=>e.serialize());e.clipboardData.setData("application/x-element-composer",JSON.stringify(a)),e.clipboardData.setData("text/plain",n),"cut"===t&&(this.modifiedFlag=!0,wd(o,[])),e.preventDefault()}}),x()(this,"onCopy",e=>{this.onCutCopy(e,"copy")}),x()(this,"onCut",e=>{this.onCutCopy(e,"cut")}),x()(this,"onPaste",e=>{if(e.preventDefault(),this.props.onPaste&&this.props.onPaste(e,this.props.model))return!0;const{model:t}=this.props,{partCreator:s}=t,n=e.clipboardData.getData("application/x-element-composer");let i;if(n){i=JSON.parse(n).map(e=>s.deserializePart(e))}else{i=Xd(e.clipboardData.getData("text/plain"),s)}this.modifiedFlag=!0;wd(Pd(this.editorRef.current,t,document.getSelection()),i)}),x()(this,"onInput",e=>{if(this.isIMEComposing)return;this.modifiedFlag=!0;const t=document.getSelection(),{caret:s,text:n}=jd(this.editorRef.current,t);this.props.model.update(n,e.inputType,s)}),x()(this,"onBlur",()=>{document.removeEventListener("selectionchange",this.onSelectionChange)}),x()(this,"onFocus",()=>{document.addEventListener("selectionchange",this.onSelectionChange),this.lastSelection=null,this.refreshLastCaretIfNeeded()}),x()(this,"onSelectionChange",()=>{const{isEmpty:e}=this.props.model;this.refreshLastCaretIfNeeded();const t=document.getSelection();if(this.hasTextSelected&&t.isCollapsed)this.hasTextSelected=!1,this.formatBarRef.current&&this.formatBarRef.current.hide();else if(!t.isCollapsed&&!e&&(this.hasTextSelected=!0,this.formatBarRef.current)){const e=t.getRangeAt(0).getBoundingClientRect();this.formatBarRef.current.showAt(e)}}),x()(this,"onKeyDown",e=>{const t=this.props.model;let s=!1;switch(Object(Mt.f)().getMessageComposerAction(e)){case Mt.b.FormatBold:this.onFormatAction(uu.Bold),s=!0;break;case Mt.b.FormatItalics:this.onFormatAction(uu.Italics),s=!0;break;case Mt.b.FormatQuote:this.onFormatAction(uu.Quote),s=!0;break;case Mt.b.EditRedo:if(this.historyManager.canRedo()){const{parts:e,caret:s}=this.historyManager.redo();t.reset(e,s,"historyRedo")}s=!0;break;case Mt.b.EditUndo:if(this.historyManager.canUndo()){const{parts:e,caret:s}=this.historyManager.undo(this.props.model);t.reset(e,s,"historyUndo")}s=!0;break;case Mt.b.NewLine:this.insertText("\n"),s=!0;break;case Mt.b.MoveCursorToStart:_d(this.editorRef.current,t,{index:0,offset:0}),s=!0;break;case Mt.b.MoveCursorToEnd:_d(this.editorRef.current,t,{index:t.parts.length-1,offset:t.parts[t.parts.length-1].text.length}),s=!0}if(s)return e.preventDefault(),void e.stopPropagation();const n=Object(Mt.f)().getAutocompleteAction(e);if(t.autoComplete&&t.autoComplete.hasCompletions()){const i=t.autoComplete;switch(n){case Mt.a.CompleteOrPrevSelection:case Mt.a.PrevSelection:i.selectPreviousSelection(),s=!0;break;case Mt.a.CompleteOrNextSelection:case Mt.a.NextSelection:i.selectNextSelection(),s=!0;break;case Mt.a.Cancel:i.onEscape(e),s=!0;break;default:return}}else n===Mt.a.CompleteOrPrevSelection||n===Mt.a.CompleteOrNextSelection?(this.tabCompleteName(),s=!0):e.key!==gt.a.BACKSPACE&&e.key!==gt.a.DELETE||this.formatBarRef.current.hide();s&&(e.preventDefault(),e.stopPropagation())}),x()(this,"onAutoCompleteConfirm",e=>{this.modifiedFlag=!0,this.props.model.autoComplete.onComponentConfirm(e)}),x()(this,"onAutoCompleteSelectionChange",(e,t)=>{this.modifiedFlag=!0,this.props.model.autoComplete.onComponentSelectionChange(e),this.setState({completionIndex:t})}),x()(this,"configureEmoticonAutoReplace",()=>{const e=V.b.getValue("MessageComposerInput.autoReplaceEmoji");this.props.model.setTransformCallback(e?this.replaceEmoticon:null)}),x()(this,"configureShouldShowPillAvatar",()=>{const e=V.b.getValue("Pill.shouldShowPillAvatar");this.setState({showPillAvatar:e})}),x()(this,"onFormatAction",e=>{const t=Pd(this.editorRef.current,this.props.model,document.getSelection());if(t.trim(),0!==t.length)switch(this.historyManager.ensureLastChangesPushed(this.props.model),this.modifiedFlag=!0,e){case uu.Bold:Id(t,"**");break;case uu.Italics:Id(t,"_");break;case uu.Strikethrough:Id(t,"<del>","</del>");break;case uu.Code:!function(e){const{model:t,parts:s}=e,{partCreator:n}=t;s.some(e=>"newline"===e.type)?(s.unshift(n.plain("```"),n.newline()),Cd(e)||s.unshift(n.newline()),s.push(n.newline(),n.plain("```")),kd(e)||s.push(n.newline())):(s.unshift(n.plain("`")),s.push(n.plain("`"))),Sd(e,s)}(t);break;case uu.Quote:!function(e){const{model:t,parts:s}=e,{partCreator:n}=t;for(let e=0;e<s.length;++e){"newline"===s[e].type&&s.splice(e+1,0,n.plain("> "))}s.unshift(n.plain("> ")),Cd(e)||s.unshift(n.newline()),kd(e)||s.push(n.newline()),s.push(n.newline()),Sd(e,s)}(t)}}),this.state={showPillAvatar:V.b.getValue("Pill.shouldShowPillAvatar")},this.emoticonSettingHandle=V.b.watchSetting("MessageComposerInput.autoReplaceEmoji",null,this.configureEmoticonAutoReplace),this.configureEmoticonAutoReplace(),this.shouldShowPillAvatarSettingHandle=V.b.watchSetting("Pill.shouldShowPillAvatar",null,this.configureShouldShowPillAvatar)}componentDidUpdate(e){const t=this.props.disabled!==e.disabled,s=this.props.placeholder!==e.placeholder;if(this.props.placeholder&&(s||t)){const{isEmpty:e}=this.props.model;e?this.showPlaceholder():this.hidePlaceholder()}}showPlaceholder(){const e=this.props.placeholder.replace(/'/g,"\\'");this.editorRef.current.style.setProperty("--placeholder",`'${e}'`),this.editorRef.current.classList.add("mx_BasicMessageComposer_inputEmpty")}hidePlaceholder(){this.editorRef.current.classList.remove("mx_BasicMessageComposer_inputEmpty"),this.editorRef.current.style.removeProperty("--placeholder")}isComposing(e){return!!(this.isIMEComposing||e.nativeEvent&&e.nativeEvent.isComposing)}insertText(e,t="insertText"){const s=document.getSelection(),{caret:n,text:i}=jd(this.editorRef.current,s),o=i.substr(0,n.offset)+e+i.substr(n.offset);n.offset+=e.length,this.modifiedFlag=!0,this.props.model.update(o,t,n)}setLastCaretFromPosition(e){const{model:t}=this.props;this._isCaretAtEnd=e.isAtEnd(t),this.lastCaret=e.asOffset(t),this.lastSelection=du(document.getSelection())}refreshLastCaretIfNeeded(){if(!this.editorRef.current)return;const e=document.getSelection();if(!this.lastSelection||(t=this.lastSelection,s=e,t.anchorNode!==s.anchorNode||t.anchorOffset!==s.anchorOffset||t.focusNode!==s.focusNode||t.focusOffset!==s.focusOffset||t.isCollapsed!==s.isCollapsed||t.rangeCount!==s.rangeCount||t.type!==s.type)){this.lastSelection=du(e);const{caret:t,text:s}=jd(this.editorRef.current,e);this.lastCaret=t,this._isCaretAtEnd=t.offset===s.length}var t,s;return this.lastCaret}clearUndoHistory(){this.historyManager.clear()}getCaret(){return this.lastCaret}isSelectionCollapsed(){return!this.lastSelection||this.lastSelection.isCollapsed}isCaretAtStart(){return 0===this.getCaret().offset}isCaretAtEnd(){return this._isCaretAtEnd}async tabCompleteName(){try{await new Promise(e=>this.setState({showVisualBell:!1},e));const{model:e}=this.props,t=this.getCaret(),s=e.positionForOffset(t.offset,t.atNodeEnd),n=e.startRange(s);n.expandBackwardsWhile((e,t,s)=>" "!==s.text[t]&&"+"!==s.text[t]&&("plain"===s.type||"pill-candidate"===s.type||"command"===s.type));const{partCreator:i}=e;await e.transform(()=>{const s=n.replace([i.pillCandidate(n.text)]);return e.positionForOffset(t.offset+s,!0)}),e.autoComplete&&(await e.autoComplete.startSelection(),e.autoComplete.hasSelection()||(this.setState({showVisualBell:!0}),e.autoComplete.close()))}catch(e){console.error(e)}}isModified(){return this.modifiedFlag}componentWillUnmount(){document.removeEventListener("selectionchange",this.onSelectionChange),this.editorRef.current.removeEventListener("input",this.onInput,!0),this.editorRef.current.removeEventListener("compositionstart",this.onCompositionStart,!0),this.editorRef.current.removeEventListener("compositionend",this.onCompositionEnd,!0),V.b.unwatchSetting(this.emoticonSettingHandle),V.b.unwatchSetting(this.shouldShowPillAvatarSettingHandle)}componentDidMount(){const e=this.props.model;e.setUpdateCallback(this.updateEditorState);var t,s;e.partCreator.setAutoCompleteCreator((t=()=>this.autocompleteRef.current,s=e=>new Promise(t=>this.setState({query:e},t)),e=>n=>new Dd(n,t,s,e))),this.updateEditorState(this.getInitialCaretPosition()),this.editorRef.current.addEventListener("input",this.onInput,!0),this.editorRef.current.addEventListener("compositionstart",this.onCompositionStart,!0),this.editorRef.current.addEventListener("compositionend",this.onCompositionEnd,!0),this.editorRef.current.focus()}getInitialCaretPosition(){let e;if(this.props.initialCaret){const t=this.props.initialCaret;e=this.props.model.positionForOffset(t.offset,t.atNodeEnd)}else e=this.props.model.getPositionAtEnd();return e}render(){let e;if(this.state.autoComplete){const t=this.state.query,s=t.length;e=a.a.createElement("div",{className:"mx_BasicMessageComposer_AutoCompleteWrapper"},a.a.createElement(rd,{ref:this.autocompleteRef,query:t,onConfirm:this.onAutoCompleteConfirm,onSelectionChange:this.onAutoCompleteSelectionChange,selection:{beginning:!0,end:s,start:s},room:this.props.room}))}const t=M()("mx_BasicMessageComposer",{mx_BasicMessageComposer_input_error:this.state.showVisualBell}),s=M()("mx_BasicMessageComposer_input",{mx_BasicMessageComposer_input_shouldShowPillAvatar:this.state.showPillAvatar,mx_BasicMessageComposer_input_disabled:this.props.disabled}),n={bold:lu("B"),italics:lu("I"),quote:lu(">")},{completionIndex:i}=this.state;return a.a.createElement("div",{className:t},e,a.a.createElement(iu,{ref:this.formatBarRef,onAction:this.onFormatAction,shortcuts:n}),a.a.createElement("div",{className:s,contentEditable:"true",tabIndex:0,onBlur:this.onBlur,onFocus:this.onFocus,onCopy:this.onCopy,onCut:this.onCut,onPaste:this.onPaste,onKeyDown:this.onKeyDown,ref:this.editorRef,"aria-label":this.props.label,role:"textbox","aria-multiline":"true","aria-autocomplete":"both","aria-haspopup":"listbox","aria-expanded":Boolean(this.state.autoComplete),"aria-activedescendant":i>=0?ad(i):void 0,dir:"auto","aria-disabled":this.props.disabled}))}focus(){this.editorRef.current.focus()}insertMention(e){const{model:t}=this.props,{partCreator:s}=t,n=this.props.room.getMember(e),i=n?n.rawDisplayName:e,o=this.getCaret(),a=t.positionForOffset(o.offset,o.atNodeEnd),r=s.createMentionParts(0===o.offset,i,e);t.transform(()=>{const e=t.insert(r,a);return t.positionForOffset(o.offset+e,!0)}),this.focus()}insertQuotedMessage(e){const{model:t}=this.props,{partCreator:s}=t,n=Zd(e,s,{isQuotedMessage:!0});n.push(s.newline()),n.push(s.newline()),t.transform(()=>{const e=t.insert(n,t.positionForOffset(0));return t.positionForOffset(e,!0)}),this.focus()}insertPlaintext(e){const{model:t}=this.props,{partCreator:s}=t,n=this.getCaret(),i=t.positionForOffset(n.offset,n.atNodeEnd);t.transform(()=>{const o=t.insert([s.plain(e)],i);return t.positionForOffset(n.offset+o,!0)})}})||au;var mu,pu,gu,vu=s(282),fu=s(195),bu=s(611),yu=s(612),_u=s(183),Eu=s(245);let Su=Object(P.a)("views.rooms.Stickerpicker")((gu=pu=class e extends a.a.PureComponent{constructor(e){super(e),x()(this,"_launchManageIntegrations",()=>{V.b.getValue("feature_many_integration_managers")?_u.a.sharedInstance().openAll(this.props.room,"type_"+El.a.STICKERPICKER.preferred,this.state.widgetId):_u.a.sharedInstance().getPrimaryManager().open(this.props.room,"type_"+El.a.STICKERPICKER.preferred,this.state.widgetId)}),this._onShowStickersClick=this._onShowStickersClick.bind(this),this._onHideStickersClick=this._onHideStickersClick.bind(this),this._launchManageIntegrations=this._launchManageIntegrations.bind(this),this._removeStickerpickerWidgets=this._removeStickerpickerWidgets.bind(this),this._updateWidget=this._updateWidget.bind(this),this._onWidgetAction=this._onWidgetAction.bind(this),this._onResize=this._onResize.bind(this),this._onFinished=this._onFinished.bind(this),this.popoverWidth=400,this.popoverHeight=450,this.scalarClient=null,this.state={showStickers:!1,imError:null,stickerpickerX:null,stickerpickerY:null,stickerpickerWidget:null,widgetId:null}}_acquireScalarClient(){return this.scalarClient?Promise.resolve(this.scalarClient):_u.a.sharedInstance().hasManager()?(this.scalarClient=_u.a.sharedInstance().getPrimaryManager().getScalarClient(),this.scalarClient.connect().then(()=>(this.forceUpdate(),this.scalarClient)).catch(e=>{this._imError(Object(c.b)("Failed to connect to integration manager"),e)})):void _u.a.sharedInstance().openNoManagerDialog()}async _removeStickerpickerWidgets(){const e=await this._acquireScalarClient();console.log("Removing Stickerpicker widgets"),this.state.widgetId?e?e.disableWidgetAssets(El.a.STICKERPICKER,this.state.widgetId).then(()=>{console.log("Assets disabled")}).catch(e=>{console.error("Failed to disable assets")}):console.error("Cannot disable assets: no scalar client"):console.warn("No widget ID specified, not disabling assets"),this.setState({showStickers:!1}),xt.a.removeStickerpickerWidgets().then(()=>{this.forceUpdate()}).catch(e=>{console.error("Failed to remove sticker picker widget",e)})}componentDidMount(){window.addEventListener("resize",this._onResize),this.dispatcherRef=u.a.register(this._onWidgetAction),le.a.get().on("accountData",this._updateWidget),this._updateWidget()}componentWillUnmount(){const e=le.a.get();e&&e.removeListener("accountData",this._updateWidget),window.removeEventListener("resize",this._onResize),this.dispatcherRef&&u.a.unregister(this.dispatcherRef)}componentDidUpdate(e,t){this._sendVisibilityToWidget(this.state.showStickers)}_imError(e,t){console.error(e,t),this.setState({showStickers:!1,imError:Object(c.a)(e)})}_updateWidget(){const t=xt.a.getStickerpickerWidgets()[0];if(!t)return e.currentWidget=null,void this.setState({stickerpickerWidget:null,widgetId:null});const s=e.currentWidget;let n=null;s&&s.content&&s.content.url&&(n=s.content.url);let i=null;t&&t.content&&t.content.url&&(i=t.content.url),i!==n&&ys.a.destroyElement("stickerPicker"),e.currentWidget=t,this.setState({stickerpickerWidget:t,widgetId:t?t.id:null})}_onWidgetAction(e){switch(e.action){case"user_widget_updated":this.forceUpdate();break;case"stickerpicker_close":this.setState({showStickers:!1});break;case h.a.AfterRightPanelPhaseChange:case"show_left_panel":case"hide_left_panel":this.setState({showStickers:!1})}}_defaultStickerpickerContent(){return a.a.createElement(g.a,{onClick:this._launchManageIntegrations,className:"mx_Stickers_contentPlaceholder"},a.a.createElement("p",null,Object(c.a)("You don't currently have any stickerpacks enabled")),a.a.createElement("p",{className:"mx_Stickers_addLink"},Object(c.a)("Add some now")),a.a.createElement("img",{src:s(1283),alt:""}))}_errorStickerpickerContent(){return a.a.createElement("div",{style:{"text-align":"center"},className:"error"},a.a.createElement("p",null," ",this.state.imError," "))}_sendVisibilityToWidget(e){if(!this.state.stickerpickerWidget)return;const t=Eu.a.instance.getMessagingForId(this.state.stickerpickerWidget.id);t&&e!==this._prevSentVisibility&&(t.updateVisibility(e).catch(e=>{console.error("Error updating widget visibility: ",e)}),this._prevSentVisibility=e)}_getStickerpickerContent(){if(this.state._imError)return this._errorStickerpickerContent();const e=this.state.stickerpickerWidget;let t;const s=d.getComponent("elements.PersistedElement");if(e&&e.content&&e.content.url){e.content.name=e.name||Object(c.a)("Stickerpack");const n={id:e.id,url:e.content.url,name:e.content.name,type:e.content.type,data:e.content.data};t=a.a.createElement("div",{className:"mx_Stickers_content_container"},a.a.createElement("div",{id:"stickersContent",className:"mx_Stickers_content",style:{border:"none",height:this.popoverHeight,width:this.popoverWidth}},a.a.createElement(s,{persistKey:"stickerPicker",zIndex:3500},a.a.createElement(jt.a,{app:n,room:this.props.room,fullWidth:!0,userId:le.a.get().credentials.userId,creatorUserId:e.sender||le.a.get().credentials.userId,waitForIframeLoad:!0,showMenubar:!0,onEditClick:this._launchManageIntegrations,onDeleteClick:this._removeStickerpickerWidgets,showTitle:!1,showCancel:!1,showPopout:!1,onMinimiseClick:this._onHideStickersClick,handleMinimisePointerEvents:!0,userWidget:!0}))))}else t=this._defaultStickerpickerContent();return t}_onShowStickersClick(e){if(!V.b.getValue("integrationProvisioning"))return _u.a.sharedInstance().showDisabledDialog();const t=e.target.getBoundingClientRect();let s=t.right+window.pageXOffset-41;s=Math.min(s,document.body.clientWidth-412);const n=Math.max(10,2+window.pageXOffset+t.left-s),i=t.top+t.height/2+window.pageYOffset-19;this.setState({showStickers:!0,stickerPickerX:s,stickerPickerY:i,stickerPickerChevronOffset:n})}_onHideStickersClick(e){this.state.showStickers&&this.setState({showStickers:!1})}_onResize(){this.state.showStickers&&this.setState({showStickers:!1})}_onFinished(){this.state.showStickers&&this.setState({showStickers:!1})}render(){let e,t;const s=M()("mx_MessageComposer_button","mx_MessageComposer_stickers","mx_Stickers_hideStickers","mx_MessageComposer_button_highlight");if(this.state.showStickers){t=a.a.createElement(g.a,{id:"stickersButton",key:"controls_hide_stickers",className:s,onClick:this._onHideStickersClick,active:this.state.showStickers.toString(),title:Object(c.a)("Hide Stickers")});const n=d.getComponent("context_menus.GenericElementContextMenu");e=a.a.createElement(i.b,{chevronOffset:this.state.stickerPickerChevronOffset,chevronFace:"bottom",left:this.state.stickerPickerX,top:this.state.stickerPickerY,menuWidth:this.popoverWidth,menuHeight:this.popoverHeight,onFinished:this._onFinished,menuPaddingTop:0,menuPaddingLeft:0,menuPaddingRight:0,zIndex:3500},a.a.createElement(n,{element:this._getStickerpickerContent(),onResize:this._onFinished}))}else t=a.a.createElement(K.a,{id:"stickersButton",key:"controls_show_stickers",className:"mx_MessageComposer_button mx_MessageComposer_stickers",onClick:this._onShowStickersClick,title:Object(c.a)("Show Stickers")});return a.a.createElement(a.a.Fragment,null,t,e)}},x()(pu,"currentWidget",void 0),mu=gu))||mu;var wu,Cu,ku,Ou=s(206);function Ru(){u.a.dispatch({action:"reply_to_event",event:null})}let Iu=Object(P.a)("views.rooms.ReplyPreview")((ku=Cu=class extends a.a.Component{constructor(e){super(e),this.unmounted=!1,this.state={event:ae.a.getQuotingEvent()},this._onRoomViewStoreUpdate=this._onRoomViewStoreUpdate.bind(this),this._roomStoreToken=ae.a.addListener(this._onRoomViewStoreUpdate)}componentWillUnmount(){this.unmounted=!0,this._roomStoreToken&&this._roomStoreToken.remove()}_onRoomViewStoreUpdate(){if(this.unmounted)return;const e=ae.a.getQuotingEvent();this.state.event!==e&&this.setState({event:e})}render(){if(!this.state.event)return null;const e=d.getComponent("rooms.EventTile");return a.a.createElement("div",{className:"mx_ReplyPreview"},a.a.createElement("div",{className:"mx_ReplyPreview_section"},a.a.createElement("div",{className:"mx_ReplyPreview_header mx_ReplyPreview_title"},Object(c.a)("Replying")),a.a.createElement("div",{className:"mx_ReplyPreview_header mx_ReplyPreview_cancel"},a.a.createElement("img",{className:"mx_filterFlipColor",src:s(336),width:"18",height:"18",onClick:Ru})),a.a.createElement("div",{className:"mx_ReplyPreview_clear"}),a.a.createElement(e,{alwaysShowTimestamps:!0,tileShape:"reply_preview",mxEvent:this.state.event,permalinkCreator:this.props.permalinkCreator,isTwelveHour:V.b.getValue("showTwelveHourTimestamps"),enableFlair:V.b.getValue(nt.a.Flair),as:"div"})))}},x()(Cu,"propTypes",{permalinkCreator:wt.a.instanceOf(_l.a).isRequired}),wu=ku))||wu;var xu,Tu,ju,Nu=s(452);let Pu=Object(P.a)("views.voice_messages.LiveRecordingWaveform")((ju=Tu=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"waveform",[]),x()(this,"scheduledUpdate",new Nu.a(()=>this.updateWaveform(),()=>requestAnimationFrame(()=>this.scheduledUpdate.trigger()))),this.state={waveform:[]}}componentDidMount(){this.props.recorder.liveData.onUpdate(e=>{this.waveform=e.waveform,this.scheduledUpdate.mark()})}updateWaveform(){this.setState({waveform:this.waveform})}render(){return a.a.createElement(ic,{relHeights:this.state.waveform})}},x()(Tu,"defaultProps",{progress:1}),xu=ju))||xu;var Du;let Au=Object(P.a)("views.voice_messages.LiveRecordingClock")(Du=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"seconds",0),x()(this,"scheduledUpdate",new Nu.a(()=>this.updateClock(),()=>requestAnimationFrame(()=>this.scheduledUpdate.trigger()))),this.state={seconds:0}}componentDidMount(){this.props.recorder.liveData.onUpdate(e=>{this.seconds=e.timeSeconds,this.scheduledUpdate.mark()})}updateClock(){this.setState({seconds:this.seconds})}render(){return a.a.createElement(dc,{seconds:this.state.seconds})}})||Du;class Mu extends dt.a{constructor(){super(u.a,{})}get activeRecording(){return this.state.recording}static get instance(){return Mu.internalInstance||(Mu.internalInstance=new Mu),Mu.internalInstance}async onAction(e){}startRecording(){if(!this.matrixClient)throw new Error("Cannot start a recording without a MatrixClient");if(this.state.recording)throw new Error("A recording is already in progress");const e=new $r(this.matrixClient);return this.updateState({recording:e}),e}disposeRecording(){return this.state.recording&&this.state.recording.destroy(),this.updateState({recording:null})}}var Uu;x()(Mu,"internalInstance",void 0),window.mxVoiceRecordingStore=Mu.instance;let Lu=Object(P.a)("views.rooms.VoiceRecordComposerTile")(Uu=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"waveform",[]),x()(this,"seconds",0),x()(this,"scheduledAnimationFrame",!1),x()(this,"onRecordingUpdate",e=>{this.waveform=e.waveform,this.seconds=e.timeSeconds,this.scheduledAnimationFrame||(this.scheduledAnimationFrame=!0,requestAnimationFrame(()=>{const e=Object(Ee.c)(Array.from(this.waveform),44);this.setState({relHeights:e.map(e=>Object(Br.c)(e,0,.5)),seconds:this.seconds}),this.scheduledAnimationFrame=!1}))}),x()(this,"onCancel",async()=>{await this.disposeRecording()}),x()(this,"onRecordStartEndClick",async()=>{if(this.state.recorder)return void await this.state.recorder.stop();const e=()=>{Le.a.createTrackedDialog("Microphone Access Error","",Xe.a,{title:Object(c.a)("Unable to access your microphone"),description:a.a.createElement(a.a.Fragment,null,a.a.createElement("p",null,Object(c.a)("We were unable to access your microphone. Please check your browser settings and try again.")))})};try{var t;const e=await Vt.b.getDevices();if(null==e||null===(t=e.audioInput)||void 0===t||!t.length)return void Le.a.createTrackedDialog("No Microphone Error","",Xe.a,{title:Object(c.a)("No microphone found"),description:a.a.createElement(a.a.Fragment,null,a.a.createElement("p",null,Object(c.a)("We didn't find a microphone on your device. Please check your settings and try again.")))})}catch(t){return console.error("Error getting devices: ",t),void e()}try{const e=Mu.instance.startRecording();await e.start(),e.on(v.b,e=>{e!==Hr.EndingSoon&&this.setState({recordingPhase:e})}),this.setState({recorder:e,recordingPhase:Hr.Started})}catch(t){console.error("Error starting recording: ",t),e(),Mu.instance.disposeRecording()}}),this.state={recorder:null,seconds:0,relHeights:Object(Ee.h)(0,44)}}componentDidUpdate(e,t){!t.recorder&&this.state.recorder&&this.state.recorder.liveData.onUpdate(this.onRecordingUpdate)}async componentWillUnmount(){await Mu.instance.disposeRecording()}async send(){if(!this.state.recorder)throw new Error("No recording started - cannot send anything");await this.state.recorder.stop();const e=await this.state.recorder.upload(this.props.room.roomId);le.a.get().sendMessage(this.props.room.roomId,{body:"Voice message",msgtype:ne.b.Audio,url:e.mxc,file:e.encrypted,info:{duration:Math.round(1e3*this.state.recorder.durationSeconds),mimetype:this.state.recorder.contentType,size:this.state.recorder.contentLength},"org.matrix.msc1767.text":"Voice message","org.matrix.msc1767.file":{url:e.mxc,file:e.encrypted,name:"Voice message.ogg",mimetype:this.state.recorder.contentType,size:this.state.recorder.contentLength},"org.matrix.msc1767.audio":{duration:Math.round(1e3*this.state.recorder.durationSeconds),waveform:this.state.recorder.getPlayback().waveform.map(e=>Math.round(1024*e))},"org.matrix.msc3245.voice":{}}),await this.disposeRecording()}async disposeRecording(){await Mu.instance.disposeRecording(),this.setState({recorder:null,recordingPhase:null})}renderWaveformArea(){return this.state.recorder?this.state.recordingPhase!==Hr.Started?a.a.createElement(mc,{playback:this.state.recorder.getPlayback()}):a.a.createElement("div",{className:"mx_VoiceMessagePrimaryContainer mx_VoiceRecordComposerTile_recording"},a.a.createElement(Au,{recorder:this.state.recorder}),a.a.createElement(Pu,{recorder:this.state.recorder})):null}render(){let e,t;if(!this.state.recordingPhase||this.state.recordingPhase===Hr.Started){var s,n;const t=M()({mx_MessageComposer_button:!this.state.recorder,mx_MessageComposer_voiceMessage:!this.state.recorder,mx_VoiceRecordComposerTile_stop:null===(s=this.state.recorder)||void 0===s?void 0:s.isRecording});let i=Object(c.a)("Record a voice message");this.state.recorder&&(i=Object(c.a)("Stop the recording"));let o=a.a.createElement(K.a,{className:t,onClick:this.onRecordStartEndClick,title:i});!this.state.recorder||null!==(n=this.state.recorder)&&void 0!==n&&n.isRecording||(o=null),e=o}return this.state.recorder&&this.state.recordingPhase!==Hr.Uploading&&(t=a.a.createElement(K.a,{className:"mx_VoiceRecordComposerTile_delete",title:Object(c.a)("Delete recording"),onClick:this.onCancel})),a.a.createElement(a.a.Fragment,null,t,this.renderWaveformArea(),e)}})||Uu;var Fu;function Bu(e){const t=d.getComponent("avatars.MemberStatusMessageAvatar");return a.a.createElement("div",{className:"mx_MessageComposer_avatar"},a.a.createElement(t,{member:e.me,width:24,height:24}))}function Vu(e){const t=M()("mx_MessageComposer_sendMessage",{mx_MessageComposer_sendMessage_enabled:e.enabled});return a.a.createElement(K.a,{className:t,onClick:e.onClick,title:Object(c.a)("Send message")})}const Ku=({addEmoji:e})=>{const[t,s,n,o]=Object(i.q)();let r;if(t){const t=s.current.getBoundingClientRect(),n=d.getComponent("emojipicker.EmojiPicker");r=a.a.createElement(i.b,ue()({},Object(i.k)(t),{onFinished:o,managed:!1}),a.a.createElement(n,{onChoose:e,showQuickReactions:!0}))}const l=M()("mx_MessageComposer_button","mx_MessageComposer_emoji",{mx_MessageComposer_button_highlight:t});return a.a.createElement(a.a.Fragment,null,a.a.createElement(i.d,{className:l,onClick:n,isExpanded:t,title:Object(c.a)("Emoji picker"),inputRef:s}),r)};class Wu extends a.a.Component{constructor(e){super(e),x()(this,"uploadInput",a.a.createRef()),x()(this,"dispatcherRef",void 0),x()(this,"onAction",e=>{"upload_file"===e.action&&this.onUploadClick()}),x()(this,"onUploadClick",()=>{le.a.get().isGuest()?u.a.dispatch({action:"require_registration"}):this.uploadInput.current.click()}),x()(this,"onUploadFileInputChange",e=>{if(0===e.target.files.length)return;const t=[];for(let s=0;s<e.target.files.length;++s)t.push(e.target.files[s]);Fn.a.sharedInstance().sendContentListToRoom(t,this.props.roomId,le.a.get()),e.target.value=""}),this.dispatcherRef=u.a.register(this.onAction)}componentWillUnmount(){u.a.unregister(this.dispatcherRef)}render(){return a.a.createElement(K.a,{className:"mx_MessageComposer_button mx_MessageComposer_upload",onClick:this.onUploadClick,title:Object(c.a)("Upload file")},a.a.createElement("input",{ref:this.uploadInput,type:"file",style:{display:"none"},multiple:!0,onChange:this.onUploadFileInputChange}))}}let Gu=Object(P.a)("views.rooms.MessageComposer")(Fu=class extends a.a.Component{constructor(e){super(e),x()(this,"dispatcherRef",void 0),x()(this,"messageComposerInput",void 0),x()(this,"voiceRecordingButton",void 0),x()(this,"onAction",e=>{"reply_to_event"===e.action&&setTimeout(()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()},100)}),x()(this,"onRoomStateEvents",(e,t)=>{e.getRoomId()===this.props.room.roomId&&("m.room.tombstone"===e.getType()&&this.setState({tombstone:this.getRoomTombstone()}),"m.room.power_levels"===e.getType()&&this.setState({canSendMessages:this.props.room.maySendMessage()}))}),x()(this,"onTombstoneClick",e=>{e.preventDefault();const t=this.state.tombstone.getContent().replacement_room,s=le.a.get().getRoom(t);let n=null;if(s){const e=s.currentState.getStateEvents("m.room.create","");e&&e.getId()&&(n=e.getId())}const i=[this.state.tombstone.getSender().split(":").splice(1).join(":")];u.a.dispatch({action:"view_room",highlighted:!0,event_id:n,room_id:t,auto_join:!0,_type:"tombstone",via_servers:i,opts:{viaServers:i}})}),x()(this,"renderPlaceholderText",()=>this.props.replyToEvent?this.props.e2eStatus?Object(c.a)("Send an encrypted reply…"):Object(c.a)("Send a reply…"):this.props.e2eStatus?Object(c.a)("Send an encrypted message…"):Object(c.a)("Send a message…")),x()(this,"sendMessage",async()=>{this.state.haveRecording&&this.voiceRecordingButton?await this.voiceRecordingButton.send():this.messageComposerInput._sendMessage()}),x()(this,"onChange",e=>{this.setState({isComposerEmpty:e.isEmpty})}),x()(this,"onVoiceStoreUpdate",()=>{const e=Mu.instance.activeRecording;this.setState({haveRecording:!!e}),e&&e.on(Hr.EndingSoon,({secondsLeft:e})=>{this.setState({recordingTimeLeftSeconds:e}),setTimeout(()=>this.setState({recordingTimeLeftSeconds:null}),3e3)})}),Mu.instance.on(v.b,this.onVoiceStoreUpdate),this.state={tombstone:this.getRoomTombstone(),canSendMessages:this.props.room.maySendMessage(),isComposerEmpty:!0,haveRecording:!1,recordingTimeLeftSeconds:null}}componentDidMount(){this.dispatcherRef=u.a.register(this.onAction),le.a.get().on("RoomState.events",this.onRoomStateEvents),this.waitForOwnMember()}waitForOwnMember(){const e=this.props.room.getMember(le.a.get().getUserId());e?this.setState({me:e}):this.props.room.loadMembersIfNeeded().then(()=>{const e=this.props.room.getMember(le.a.get().getUserId());this.setState({me:e})})}componentWillUnmount(){le.a.get()&&le.a.get().removeListener("RoomState.events",this.onRoomStateEvents),Mu.instance.off(v.b,this.onVoiceStoreUpdate),u.a.unregister(this.dispatcherRef)}getRoomTombstone(){return this.props.room.currentState.getStateEvents("m.room.tombstone","")}addEmoji(e){u.a.dispatch({action:h.a.ComposerInsert,text:e})}render(){const e=[this.state.me?a.a.createElement(Bu,{key:"controls_avatar",me:this.state.me}):null,this.props.e2eStatus?a.a.createElement(Ou.b,{key:"e2eIcon",status:this.props.e2eStatus,className:"mx_MessageComposer_e2eIcon"}):null];if(!this.state.tombstone&&this.state.canSendMessages){const t=d.getComponent("rooms.SendMessageComposer");e.push(a.a.createElement(t,{ref:e=>this.messageComposerInput=e,key:"controls_input",room:this.props.room,placeholder:this.renderPlaceholderText(),resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.props.permalinkCreator,replyToEvent:this.props.replyToEvent,onChange:this.onChange,disabled:this.state.haveRecording})),this.state.haveRecording||e.push(a.a.createElement(Wu,{key:"controls_upload",roomId:this.props.room.roomId}),a.a.createElement(Ku,{key:"emoji_button",addEmoji:this.addEmoji})),V.b.getValue(nt.a.Widgets)&&V.b.getValue("MessageComposerInput.showStickersButton")&&!this.state.haveRecording&&e.push(a.a.createElement(Su,{key:"stickerpicker_controls_button",room:this.props.room})),V.b.getValue("feature_voice_messages")&&e.push(a.a.createElement(Lu,{key:"controls_voice_record",ref:e=>this.voiceRecordingButton=e,room:this.props.room})),e.push(a.a.createElement(Vu,{key:"controls_send",onClick:this.sendMessage,enabled:!this.state.isComposerEmpty||this.state.haveRecording}))}else if(this.state.tombstone){const t=this.state.tombstone.getContent().replacement_room,n=t?a.a.createElement("a",{href:Object(_l.g)(t),className:"mx_MessageComposer_roomReplaced_link",onClick:this.onTombstoneClick},Object(c.a)("The conversation continues here.")):"";e.push(a.a.createElement("div",{className:"mx_MessageComposer_replaced_wrapper",key:"room_replaced"},a.a.createElement("div",{className:"mx_MessageComposer_replaced_valign"},a.a.createElement("img",{className:"mx_MessageComposer_roomReplaced_icon",src:s(1284)}),a.a.createElement("span",{className:"mx_MessageComposer_roomReplaced_header"},Object(c.a)("This room has been replaced and is no longer active.")),a.a.createElement("br",null),n)))}else e.push(a.a.createElement("div",{key:"controls_error",className:"mx_MessageComposer_noperm_error"},Object(c.a)("You do not have permission to post to this room")));const t=M()("mx_MessageComposer",{mx_GroupLayout:this.props.layout==ba.a.IRC||this.props.layout==ba.a.Group,sc_BubbleLayout:this.props.layout==ba.a.Bubble});let n;const i=Math.round(this.state.recordingTimeLeftSeconds);return i&&(n=a.a.createElement(Ba.b,{label:Object(c.a)("%(seconds)ss left",{seconds:i}),alignment:Ba.a.Top,yOffset:-50})),a.a.createElement("div",{className:t},n,a.a.createElement("div",{className:"mx_MessageComposer_wrapper"},a.a.createElement(Iu,{permalinkCreator:this.props.permalinkCreator}),a.a.createElement("div",{className:"mx_MessageComposer_row"},e)))}})||Fu;var qu=s(730),Hu=s(588),$u=s(411),zu=s(681),Yu=s(714),Ju=s(665);function Qu(e,t=[]){const s=[],n=Object.keys(e.currentState.members);for(let i=0;i<n.length;++i){const o=n[i];e.currentState.members[o].typing&&-1===t.indexOf(o)&&s.push(e.currentState.members[o])}return s}var Xu,Zu,eh,th=s(254);let sh=Object(P.a)("views.rooms.WhoIsTypingTile")((eh=Zu=class extends a.a.Component{constructor(...e){var t;super(...e),x()(this,"state",{usersTyping:(t=this.props.room,Qu(t,[le.a.get().getUserId()])),delayedStopTypingTimers:{}}),x()(this,"isVisible",()=>this._isVisible(this.state)),x()(this,"onRoomTimeline",(e,t)=>{var s;if((null==t?void 0:t.roomId)===(null===(s=this.props.room)||void 0===s?void 0:s.roomId)){const t=e.getSender(),s=this.state.usersTyping.filter(e=>e.userId!==t);s.length!==this.state.usersTyping.length&&this.setState({usersTyping:s}),this.abortUserTimer(t)}}),x()(this,"onRoomMemberTyping",()=>{const e=function(e){return Qu(e,[le.a.get().getUserId()].concat(le.a.get().getIgnoredUsers()))}(this.props.room);this.setState({delayedStopTypingTimers:this.updateDelayedStopTypingTimers(e),usersTyping:e})})}componentDidMount(){le.a.get().on("RoomMember.typing",this.onRoomMemberTyping),le.a.get().on("Room.timeline",this.onRoomTimeline)}componentDidUpdate(e,t){const s=this._isVisible(t),n=this._isVisible(this.state);this.props.onShown&&!s&&n?this.props.onShown():this.props.onHidden&&s&&!n&&this.props.onHidden()}componentWillUnmount(){const e=le.a.get();e&&(e.removeListener("RoomMember.typing",this.onRoomMemberTyping),e.removeListener("Room.timeline",this.onRoomTimeline)),Object.values(this.state.delayedStopTypingTimers).forEach(e=>e.abort())}_isVisible(e){return 0!==e.usersTyping.length||0!==Object.keys(e.delayedStopTypingTimers).length}updateDelayedStopTypingTimers(e){const t=this.state.usersTyping.filter(t=>!e.some(e=>t.userId===e.userId)),s=e.filter(e=>!this.state.usersTyping.some(t=>e.userId===t.userId));s.forEach(e=>{const t=this.state.delayedStopTypingTimers[e.userId];t&&t.abort()});let n=Object.assign({},this.state.delayedStopTypingTimers);return n=s.reduce((e,t)=>(delete e[t.userId],e),n),n=t.reduce((e,t)=>{if(!e[t.userId]){const s=new th.a(5e3);e[t.userId]=s,s.start(),s.finished().then(()=>this.removeUserTimer(t.userId),()=>{})}return e},n),n}abortUserTimer(e){const t=this.state.delayedStopTypingTimers[e];t&&(t.abort(),this.removeUserTimer(e))}removeUserTimer(e){if(this.state.delayedStopTypingTimers[e]){const t=Object.assign({},this.state.delayedStopTypingTimers);delete t[e],this.setState({delayedStopTypingTimers:t})}}renderTypingIndicatorAvatars(e,t){let s=0;e.length>t&&(s=e.length-t+1,e=e.slice(0,t-1));const n=e.map(e=>a.a.createElement(Yi.a,{key:e.userId,member:e,width:24,height:24,resizeMethod:"crop",viewUserOnClick:!0}));return s>0&&n.push(a.a.createElement("span",{className:"mx_WhoIsTypingTile_remainingAvatarPlaceholder",key:"others"},"+",s)),n}render(){let e=this.state.usersTyping;const t=Object.keys(this.state.delayedStopTypingTimers).map(e=>this.props.room.getMember(e));e=e.concat(t),e.sort((e,t)=>Object(bn.a)(e.name,t.name));const s=function(e,t){let s=0;if(e.length>t&&(s=e.length-t+1),0===e.length)return"";if(1===e.length)return Object(c.a)("%(displayName)s is typing …",{displayName:e[0].name});const n=e.map(e=>e.name);if(s>=1)return Object(c.a)("%(names)s and %(count)s others are typing …",{names:n.slice(0,t-1).join(", "),count:s});{const e=n.pop();return Object(c.a)("%(names)s and %(lastPerson)s are typing …",{names:n.join(", "),lastPerson:e})}}(e,this.props.whoIsTypingLimit);return s?a.a.createElement("li",{className:"mx_WhoIsTypingTile","aria-atomic":"true"},a.a.createElement("div",{className:"mx_WhoIsTypingTile_avatars"},this.renderTypingIndicatorAvatars(e,this.props.whoIsTypingLimit)),a.a.createElement("div",{className:"mx_WhoIsTypingTile_label"},s)):null}},x()(Zu,"defaultProps",{whoIsTypingLimit:3}),Xu=eh))||Xu;var nh,ih=s(728),oh=s(654),ah=s(231);let rh=Object(P.a)("views.settings.EventIndexPanel")(nh=class extends a.a.Component{constructor(e){super(e),x()(this,"updateCurrentRoom",async e=>{const t=ah.a.get();let s;try{s=await t.getStats()}catch{return}this.setState({eventIndexSize:s.size,roomCount:s.roomCount})}),x()(this,"onManage",async()=>{Le.a.createTrackedDialogAsync("Message search","Message search",s.e(30).then(s.bind(null,1327)),{onFinished:()=>{}},null,!1,!0)}),x()(this,"onEnable",async()=>{this.setState({enabling:!0}),await ah.a.initEventIndex(),await ah.a.get().addInitialCheckpoints(),await ah.a.get().startCrawler(),await V.b.setValue("enableEventIndexing",null,Ye.a.DEVICE,!0),await this.updateState()}),x()(this,"confirmEventStoreReset",()=>{const{close:e}=Le.a.createDialog(Uo,{onFinished:async t=>{t&&(await V.b.setValue("enableEventIndexing",null,Ye.a.DEVICE,!1),await ah.a.deleteEventIndex(),await this.onEnable(),e())}})}),this.state={enabling:!1,eventIndexSize:0,roomCount:0,eventIndexingEnabled:V.b.getValueAt(Ye.a.DEVICE,"enableEventIndexing")}}componentWillUnmount(){const e=ah.a.get();null!==e&&e.removeListener("changedCheckpoint",this.updateCurrentRoom)}componentDidMount(){this.updateState()}async updateState(){const e=ah.a.get(),t=V.b.getValueAt(Ye.a.DEVICE,"enableEventIndexing");let s=0,n=0;if(null!==e){e.on("changedCheckpoint",this.updateCurrentRoom);try{const t=await e.getStats();s=t.size,n=t.roomCount}catch{}}this.setState({enabling:!1,eventIndexSize:s,roomCount:n,eventIndexingEnabled:t})}render(){let e=null;const t=d.getComponent("elements.InlineSpinner"),s=l.a.get().brand;if(null!==ah.a.get())e=a.a.createElement("div",null,a.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Securely cache encrypted messages locally for them to appear in search results, using %(size)s to store messages from %(rooms)s rooms.",{size:Object(J.a)(this.state.eventIndexSize,0),count:this.state.roomCount,rooms:Object(J.d)(this.state.roomCount)})),a.a.createElement("div",null,a.a.createElement(g.a,{kind:"primary",onClick:this.onManage},Object(c.a)("Manage"))));else if(!this.state.eventIndexingEnabled&&ah.a.supportIsInstalled())e=a.a.createElement("div",null,a.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Securely cache encrypted messages locally for them to appear in search results.")),a.a.createElement("div",null,a.a.createElement(g.a,{kind:"primary",disabled:this.state.enabling,onClick:this.onEnable},Object(c.a)("Enable")),this.state.enabling?a.a.createElement(t,null):a.a.createElement("div",null)));else if(ah.a.platformHasSupport()&&!ah.a.supportIsInstalled()){const t="https://github.com/vector-im/element-desktop/blob/develop/docs/native-node-modules.md#adding-seshat-for-search-in-e2e-encrypted-rooms";e=a.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("%(brand)s is missing some components required for securely caching encrypted messages locally. If you'd like to experiment with this feature, build a custom %(brand)s Desktop with <nativeLink>search components added</nativeLink>.",{brand:s},{nativeLink:e=>a.a.createElement("a",{href:t,target:"_blank",rel:"noreferrer noopener"},e)}))}else e=ah.a.platformHasSupport()?a.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},a.a.createElement("p",null,this.state.enabling?a.a.createElement(t,null):Object(c.a)("Message search initialisation failed")),ah.a.error&&a.a.createElement("details",null,a.a.createElement("summary",null,Object(c.a)("Advanced")),a.a.createElement("code",null,ah.a.error.message),a.a.createElement("p",null,a.a.createElement(g.a,{key:"delete",kind:"danger",onClick:this.confirmEventStoreReset},Object(c.a)("Reset"))))):a.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("%(brand)s can't securely cache encrypted messages locally while running in a web browser. Use <desktopLink>%(brand)s Desktop</desktopLink> for encrypted messages to appear in search results.",{brand:s},{desktopLink:e=>a.a.createElement("a",{href:"https://element.io/get-started",target:"_blank",rel:"noreferrer noopener"},e)}));return e}})||nh;var ch,lh=s(640),dh=s(200);let uh=Object(P.a)("views.settings.SetIdServer")(ch=class extends a.a.Component{constructor(e){super(e),x()(this,"dispatcherRef",void 0),x()(this,"onAction",e=>{"id_server_changed"===e.action&&this.setState({currentClientIdServer:le.a.get().getIdentityServerUrl()})}),x()(this,"onIdentityServerChanged",e=>{const t=e.target.value;this.setState({idServer:t})}),x()(this,"getTooltip",()=>{if(this.state.checking){const e=d.getComponent("views.elements.InlineSpinner");return a.a.createElement("div",null,a.a.createElement(e,null),Object(c.a)("Checking server"))}return this.state.error?a.a.createElement("span",{className:"warning"},this.state.error):null}),x()(this,"idServerChangeEnabled",()=>!!this.state.idServer&&!this.state.busy),x()(this,"saveIdServer",e=>{le.a.get().setAccountData("m.identity_server",{base_url:e}),this.setState({busy:!1,error:null,currentClientIdServer:e,idServer:""})}),x()(this,"checkIdServer",async e=>{e.preventDefault();const{idServer:t,currentClientIdServer:s}=this.state;this.setState({busy:!0,checking:!0,error:null});const n=Object(bl.b)(t);let i=await async function(e){if("https:"!==Ko.a.parse(e).protocol)return Object(c.a)("Identity Server URL must be HTTPS");try{const t=await fetch(e+"/_matrix/identity/api/v1");return t.ok?null:t.status<200||t.status>=300?Object(c.a)("Not a valid Identity Server (status code %(code)s)",{code:t.status}):Object(c.a)("Could not connect to Identity Server")}catch(e){return Object(c.a)("Could not connect to Identity Server")}}(n);if(!i)try{this.setState({checking:!1});const e=new dh.a(n);await e.getAccessToken();let i=!0;if(!await Object(yl.b)(n)){const[e]=await this.showNoTermsWarning(n);i=e}if(i&&s&&n!==s){const[e]=await this.showServerChangeWarning({title:Object(c.a)("Change identity server"),unboundMessage:Object(c.a)("Disconnect from the identity server <current /> and connect to <new /> instead?",{},{current:e=>a.a.createElement("b",null,Object(bl.a)(s)),new:e=>a.a.createElement("b",null,Object(bl.a)(t))}),button:Object(c.a)("Continue")});i=e}i&&this.saveIdServer(n)}catch(e){console.error(e),i=Object(c.a)("Terms of service not accepted or the identity server is invalid.")}this.setState({busy:!1,checking:!1,error:i,currentClientIdServer:le.a.get().getIdentityServerUrl()})}),x()(this,"onDisconnectClicked",async()=>{this.setState({disconnectBusy:!0});try{const[e]=await this.showServerChangeWarning({title:Object(c.a)("Disconnect identity server"),unboundMessage:Object(c.a)("Disconnect from the identity server <idserver />?",{},{idserver:e=>a.a.createElement("b",null,Object(bl.a)(this.state.currentClientIdServer))}),button:Object(c.a)("Disconnect")});e&&this.disconnectIdServer()}finally{this.setState({disconnectBusy:!1})}}),x()(this,"disconnectIdServer",()=>{le.a.get().setAccountData("m.identity_server",{base_url:null});let e="";Object(yl.c)()&&(e=Object(bl.a)(Object(yl.c)())),this.setState({busy:!1,error:null,currentClientIdServer:le.a.get().getIdentityServerUrl(),idServer:e})});let t="";!le.a.get().getIdentityServerUrl()&&Object(yl.c)()&&(t=Object(bl.a)(Object(yl.c)())),this.state={defaultIdServer:t,currentClientIdServer:le.a.get().getIdentityServerUrl(),idServer:"",error:null,busy:!1,disconnectBusy:!1,checking:!1}}componentDidMount(){this.dispatcherRef=u.a.register(this.onAction)}componentWillUnmount(){u.a.unregister(this.dispatcherRef)}showNoTermsWarning(e){const t=d.getComponent("views.dialogs.QuestionDialog"),{finished:s}=Le.a.createTrackedDialog("No Terms Warning","",t,{title:Object(c.a)("Identity server has no terms of service"),description:a.a.createElement("div",null,a.a.createElement("span",{className:"warning"},Object(c.a)("The identity server you have chosen does not have any terms of service.")),a.a.createElement("span",null," ",Object(c.a)("Only continue if you trust the owner of the server."))),button:Object(c.a)("Continue")});return s}async showServerChangeWarning({title:e,unboundMessage:t,button:s}){const{currentClientIdServer:n}=this.state;let i=[],o=!0;try{i=await Object(td.d)(Object(lh.a)(le.a.get()),Promise.reject(new Error("Timeout attempting to reach identity server")),1e4)}catch(e){o=!1,console.warn(`Unable to reach identity server at ${n} to check for 3PIDs during IS change flow`),console.warn(e)}const r=i.filter(e=>e.bound);let l,u=!1;const h={idserver:e=>a.a.createElement("b",null,Object(bl.a)(n)),b:e=>a.a.createElement("b",null,e)};o?r.length?(l=a.a.createElement("div",null,a.a.createElement("p",null,Object(c.a)("You are still <b>sharing your personal data</b> on the identity server <idserver />.",{},h)),a.a.createElement("p",null,Object(c.a)("We recommend that you remove your email addresses and phone numbers from the identity server before disconnecting."))),u=!0,s=Object(c.a)("Disconnect anyway")):l=t:(l=a.a.createElement("div",null,a.a.createElement("p",null,Object(c.a)("You should <b>remove your personal data</b> from identity server <idserver /> before disconnecting. Unfortunately, identity server <idserver /> is currently offline or cannot be reached.",{},h)),a.a.createElement("p",null,Object(c.a)("You should:")),a.a.createElement("ul",null,a.a.createElement("li",null,Object(c.a)("check your browser plugins for anything that might block the identity server (such as Privacy Badger)")),a.a.createElement("li",null,Object(c.a)("contact the administrators of identity server <idserver />",{},{idserver:h.idserver})),a.a.createElement("li",null,Object(c.a)("wait and try again later")))),u=!0,s=Object(c.a)("Disconnect anyway"));const m=d.getComponent("dialogs.QuestionDialog"),{finished:p}=Le.a.createTrackedDialog("Identity Server Bound Warning","",m,{title:e,description:l,button:s,cancelButton:Object(c.a)("Go back"),danger:u});return p}render(){const e=d.getComponent("views.elements.AccessibleButton"),t=d.getComponent("elements.Field"),s=this.state.currentClientIdServer;let n,i,o;if(s?(n=Object(c.a)("Identity Server (%(server)s)",{server:Object(bl.a)(s)}),i=Object(c.a)("You are currently using <server></server> to discover and be discoverable by existing contacts you know. You can change your identity server below.",{},{server:e=>a.a.createElement("b",null,Object(bl.a)(s))}),this.props.missingTerms&&(i=Object(c.a)("If you don't want to use <server /> to discover and be discoverable by existing contacts you know, enter another identity server below.",{},{server:e=>a.a.createElement("b",null,Object(bl.a)(s))}))):(n=Object(c.a)("Identity Server"),i=Object(c.a)("You are not currently using an identity server. To discover and be discoverable by existing contacts you know, add one below.")),s){let t=Object(c.a)("Disconnect"),s=Object(c.a)("Disconnecting from your identity server will mean you won't be discoverable by other users and you won't be able to invite others by email or phone.");if(this.props.missingTerms&&(s=Object(c.a)("Using an identity server is optional. If you choose not to use an identity server, you won't be discoverable by other users and you won't be able to invite others by email or phone."),t=Object(c.a)("Do not use an identity server")),this.state.disconnectBusy){const e=d.getComponent("views.elements.InlineSpinner");t=a.a.createElement(e,null)}o=a.a.createElement("div",null,a.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},s),a.a.createElement(e,{onClick:this.onDisconnectClicked,kind:"danger_sm"},t))}return a.a.createElement("form",{className:"mx_SettingsTab_section mx_SetIdServer",onSubmit:this.checkIdServer},a.a.createElement("span",{className:"mx_SettingsTab_subheading"},n),a.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},i),a.a.createElement(t,{label:Object(c.a)("Enter a new identity server"),type:"text",autoComplete:"off",placeholder:this.state.defaultIdServer,value:this.state.idServer,onChange:this.onIdentityServerChanged,tooltipContent:this.getTooltip(),tooltipClassName:"mx_SetIdServer_tooltip",disabled:this.state.busy,forceValidity:!this.state.error&&null}),a.a.createElement(e,{type:"submit",kind:"primary_sm",onClick:this.checkIdServer,disabled:!this.idServerChangeEnabled()},Object(c.a)("Change")),o)}})||ch;var hh,mh=s(625),ph=s(659),gh=s(449),vh=s(727),fh=s(723),bh=s(339),yh=s(649),_h=s(658),Eh=s(662),Sh=s(656),wh=s(445),Ch=s(587),kh=s(670),Oh=s(731),Rh=s(689);let Ih=Object(P.a)("views.toasts.VerificationRequestToast")(hh=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"intervalHandle",void 0),x()(this,"_checkRequestIsPending",()=>{const{request:e}=this.props;e.canAccept||es.a.sharedInstance().dismissToast(this.props.toastKey)}),x()(this,"cancel",()=>{es.a.sharedInstance().dismissToast(this.props.toastKey);try{this.props.request.cancel()}catch(e){console.error("Error while cancelling verification request",e)}}),x()(this,"accept",async()=>{es.a.sharedInstance().dismissToast(this.props.toastKey);const{request:e}=this.props,t=le.a.get();try{if(e.channel.roomId)u.a.dispatch({action:"view_room",room_id:e.channel.roomId,should_peek:!1}),u.a.dispatch({action:h.a.SetRightPanelPhase,phase:Qe.c.EncryptionPanel,refireParams:{verificationRequest:e,member:t.getUser(e.otherUserId)}});else{const t=d.getComponent("views.dialogs.VerificationRequestDialog");Le.a.createTrackedDialog("Incoming Verification","",t,{verificationRequest:e,onFinished:()=>{e.cancel()}},null,!1,!0)}await e.accept()}catch(e){console.error(e.message)}}),this.state={counter:Math.ceil(e.request.timeout/1e3)}}async componentDidMount(){const{request:e}=this.props;if(e.timeout&&e.timeout>0&&(this.intervalHandle=setInterval(()=>{let{counter:e}=this.state;e=Math.max(0,e-1),this.setState({counter:e})},1e3)),e.on("change",this._checkRequestIsPending),this._checkRequestIsPending(),e.isSelfVerification){const t=le.a.get(),s=(await t.getDevice(e.channel.deviceId)).last_seen_ip;this.setState({device:t.getStoredDevice(t.getUserId(),e.channel.deviceId),ip:s})}}componentWillUnmount(){clearInterval(this.intervalHandle);const{request:e}=this.props;e.off("change",this._checkRequestIsPending)}render(){const{request:e}=this.props;let t,s;if(e.isSelfVerification)this.state.device&&(t=this.state.device.getDisplayName(),s=Object(c.a)("%(deviceId)s from %(ip)s",{deviceId:this.state.device.deviceId,ip:this.state.ip}));else{const s=e.otherUserId,n=e.channel.roomId;if(t=n?_r(s,n):s,t===s){const e=le.a.get().getUser(s);e&&e.displayName&&(t=Object(c.a)("%(name)s (%(userId)s)",{name:e.displayName,userId:s}))}}const n=0===this.state.counter?Object(c.a)("Decline"):Object(c.a)("Decline (%(counter)s)",{counter:this.state.counter});return a.a.createElement(Zt.a,{description:t,detail:s,acceptLabel:Object(c.a)("Accept"),onAccept:this.accept,rejectLabel:n,onReject:this.cancel})}})||hh;var xh,Th,jh,Nh=s(717),Ph=s(434),Dh=s(638),Ah=s(698),Mh=s(732),Uh=s(666);let Lh=Object(P.a)("structures.GenericErrorPage")((jh=Th=class extends a.a.PureComponent{render(){return a.a.createElement("div",{className:"mx_GenericErrorPage"},a.a.createElement("div",{className:"mx_GenericErrorPage_box"},a.a.createElement("h1",null,this.props.title),a.a.createElement("p",null,this.props.message)))}},x()(Th,"propTypes",{title:wt.a.object.isRequired,message:wt.a.object.isRequired}),xh=jh))||xh;var Fh,Bh,Vh,Kh=s(621),Wh=s(330),Gh=s(422),qh=s(239),Hh=s(249);const $h=Object(c.b)('<h1>HTML for your community\'s page</h1>\n<p>\n    Use the long description to introduce new members to the community, or distribute\n    some important <a href="foo">links</a>\n</p>\n<p>\n    You can even add images with Matrix URLs <img src="mxc://url" />\n</p>\n'),zh=wt.a.shape({room_id:wt.a.string.isRequired,profile:wt.a.shape({name:wt.a.string,avatar_url:wt.a.string,canonical_alias:wt.a.string}).isRequired}),Yh=wt.a.shape({summaryInfo:wt.a.shape({user_id:wt.a.string.isRequired,role_id:wt.a.string,avatar_url:wt.a.string,displayname:wt.a.string}).isRequired});class Jh extends a.a.Component{constructor(...e){super(...e),x()(this,"onAddRoomsToSummaryClicked",e=>{e.preventDefault();const t=d.getComponent("dialogs.AddressPickerDialog");Le.a.createTrackedDialog("Add Rooms to Group Summary","",t,{title:Object(c.a)("Add rooms to the community summary"),description:Object(c.a)("Which rooms would you like to add to this summary?"),placeholder:Object(c.a)("Room name or address"),button:Object(c.a)("Add to summary"),pickerType:"room",validAddressTypes:["mx-room-id"],groupId:this.props.groupId,onFinished:(e,t)=>{if(!e)return;const s=[];Promise.allSettled(t.map(e=>wn.a.addRoomToGroupSummary(this.props.groupId,e.address).catch(()=>{s.push(e.address)}))).then(()=>{if(0===s.length)return;const e=d.getComponent("dialogs.ErrorDialog");Le.a.createTrackedDialog("Failed to add the following room to the group summary","",e,{title:Object(c.a)("Failed to add the following rooms to the summary of %(groupId)s:",{groupId:this.props.groupId}),description:s.join(", ")})})}},null,!1,!0)})}render(){const e=d.getComponent("elements.TintableSvg"),t=this.props.editing?a.a.createElement(g.a,{className:"mx_GroupView_featuredThings_addButton",onClick:this.onAddRoomsToSummaryClicked},a.a.createElement(e,{src:s(733),width:"64",height:"64"}),a.a.createElement("div",{className:"mx_GroupView_featuredThings_addButton_label"},Object(c.a)("Add a Room"))):a.a.createElement("div",null),n=this.props.rooms.map(e=>a.a.createElement(Qh,{key:e.room_id,groupId:this.props.groupId,editing:this.props.editing,summaryInfo:e}));let i=a.a.createElement("div",null);return this.props.category&&this.props.category.profile&&(i=a.a.createElement("div",{className:"mx_GroupView_featuredThings_category"},this.props.category.profile.name)),a.a.createElement("div",{className:"mx_GroupView_featuredThings_container"},i,n,t)}}x()(Jh,"propTypes",{rooms:wt.a.arrayOf(zh).isRequired,category:wt.a.shape({profile:wt.a.shape({name:wt.a.string}).isRequired}),groupId:wt.a.string.isRequired,editing:wt.a.bool.isRequired});class Qh extends a.a.Component{constructor(...e){super(...e),x()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"view_room",room_alias:this.props.summaryInfo.profile.canonical_alias,room_id:this.props.summaryInfo.room_id})}),x()(this,"onDeleteClicked",e=>{e.preventDefault(),e.stopPropagation(),wn.a.removeRoomFromGroupSummary(this.props.groupId,this.props.summaryInfo.room_id).catch(e=>{console.error("Error whilst removing room from group summary",e);const t=this.props.summaryInfo.name||this.props.summaryInfo.canonical_alias||this.props.summaryInfo.room_id,s=d.getComponent("dialogs.ErrorDialog");Le.a.createTrackedDialog("Failed to remove room from group summary","",s,{title:Object(c.a)("Failed to remove the room from the summary of %(groupId)s",{groupId:this.props.groupId}),description:Object(c.a)("The room '%(roomName)s' could not be removed from the summary.",{roomName:t})})})})}render(){const e=d.getComponent("avatars.RoomAvatar"),t=this.props.summaryInfo.profile.name||this.props.summaryInfo.profile.canonical_alias||Object(c.a)("Unnamed Room"),n={roomId:this.props.summaryInfo.room_id,avatarUrl:this.props.summaryInfo.profile.avatar_url,name:t};let i=null;this.props.summaryInfo.profile&&this.props.summaryInfo.profile.canonical_alias&&(i=Object(_l.f)(this.props.summaryInfo.profile.canonical_alias));let o=null;o=i?a.a.createElement("a",{href:i,onClick:this.onClick},t):a.a.createElement("span",null,t);const r=this.props.editing?a.a.createElement("img",{className:"mx_GroupView_featuredThing_deleteButton",src:s(734),width:"14",height:"14",alt:"Delete",onClick:this.onDeleteClicked}):a.a.createElement("div",null);return a.a.createElement(g.a,{className:"mx_GroupView_featuredThing",onClick:this.onClick},a.a.createElement(e,{oobData:n,width:64,height:64}),a.a.createElement("div",{className:"mx_GroupView_featuredThing_name"},o),r)}}x()(Qh,"propTypes",{summaryInfo:zh.isRequired,editing:wt.a.bool.isRequired,groupId:wt.a.string.isRequired});class Xh extends a.a.Component{constructor(...e){super(...e),x()(this,"onAddUsersClicked",e=>{e.preventDefault();const t=d.getComponent("dialogs.AddressPickerDialog");Le.a.createTrackedDialog("Add Users to Group Summary","",t,{title:Object(c.a)("Add users to the community summary"),description:Object(c.a)("Who would you like to add to this summary?"),placeholder:Object(c.a)("Name or Matrix ID"),button:Object(c.a)("Add to summary"),validAddressTypes:["mx-user-id"],groupId:this.props.groupId,shouldOmitSelf:!1,onFinished:(e,t)=>{if(!e)return;const s=[];Promise.allSettled(t.map(e=>wn.a.addUserToGroupSummary(e.address).catch(()=>{s.push(e.address)}))).then(()=>{if(0===s.length)return;const e=d.getComponent("dialogs.ErrorDialog");Le.a.createTrackedDialog("Failed to add the following users to the community summary","",e,{title:Object(c.a)("Failed to add the following users to the summary of %(groupId)s:",{groupId:this.props.groupId}),description:s.join(", ")})})}},null,!1,!0)})}render(){const e=d.getComponent("elements.TintableSvg"),t=this.props.editing?a.a.createElement(g.a,{className:"mx_GroupView_featuredThings_addButton",onClick:this.onAddUsersClicked},a.a.createElement(e,{src:s(733),width:"64",height:"64"}),a.a.createElement("div",{className:"mx_GroupView_featuredThings_addButton_label"},Object(c.a)("Add a User"))):a.a.createElement("div",null),n=this.props.users.map(e=>a.a.createElement(Zh,{key:e.user_id,summaryInfo:e,editing:this.props.editing,groupId:this.props.groupId}));let i=a.a.createElement("div",null);return this.props.role&&this.props.role.profile&&(i=a.a.createElement("div",{className:"mx_GroupView_featuredThings_category"},this.props.role.profile.name)),a.a.createElement("div",{className:"mx_GroupView_featuredThings_container"},i,n,t)}}x()(Xh,"propTypes",{users:wt.a.arrayOf(Yh).isRequired,role:wt.a.shape({profile:wt.a.shape({name:wt.a.string}).isRequired}),groupId:wt.a.string.isRequired,editing:wt.a.bool.isRequired});class Zh extends a.a.Component{constructor(...e){super(...e),x()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"view_start_chat_or_reuse",user_id:this.props.summaryInfo.user_id})}),x()(this,"onDeleteClicked",e=>{e.preventDefault(),e.stopPropagation(),wn.a.removeUserFromGroupSummary(this.props.groupId,this.props.summaryInfo.user_id).catch(e=>{console.error("Error whilst removing user from group summary",e);const t=this.props.summaryInfo.displayname||this.props.summaryInfo.user_id,s=d.getComponent("dialogs.ErrorDialog");Le.a.createTrackedDialog("Failed to remove user from community summary","",s,{title:Object(c.a)("Failed to remove a user from the summary of %(groupId)s",{groupId:this.props.groupId}),description:Object(c.a)("The user '%(displayName)s' could not be removed from the summary.",{displayName:t})})})})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=this.props.summaryInfo.displayname||this.props.summaryInfo.user_id,n=Object(_l.h)(this.props.summaryInfo.user_id),i=a.a.createElement("a",{href:n,onClick:this.onClick},t),o=Object(pe.b)(this.props.summaryInfo.avatar_url).getSquareThumbnailHttp(64),r=this.props.editing?a.a.createElement("img",{className:"mx_GroupView_featuredThing_deleteButton",src:s(734),width:"14",height:"14",alt:"Delete",onClick:this.onDeleteClicked}):a.a.createElement("div",null);return a.a.createElement(g.a,{className:"mx_GroupView_featuredThing",onClick:this.onClick},a.a.createElement(e,{name:t,url:o,width:64,height:64}),a.a.createElement("div",{className:"mx_GroupView_featuredThing_name"},i),r)}}x()(Zh,"propTypes",{summaryInfo:Yh.isRequired,editing:wt.a.bool.isRequired,groupId:wt.a.string.isRequired});let em=Object(P.a)("structures.GroupView")((Vh=Bh=class extends a.a.Component{constructor(...e){super(...e),x()(this,"state",{summary:null,isGroupPublicised:null,isUserPrivileged:null,groupRooms:null,groupRoomsLoading:null,error:null,editing:!1,saving:!1,uploadingAvatar:!1,avatarChanged:!1,membershipBusy:!1,publicityBusy:!1,inviterProfile:null,showRightPanel:Hh.a.getSharedInstance().isOpenForGroup}),x()(this,"_onRightPanelStoreUpdate",()=>{this.setState({showRightPanel:Hh.a.getSharedInstance().isOpenForGroup})}),x()(this,"_onGroupMyMembership",e=>{this._unmounted||e.groupId!==this.props.groupId||("leave"===e.myMembership&&this._closeSettings(),this.setState({membershipBusy:!1}))}),x()(this,"onGroupStoreUpdated",e=>{if(this._unmounted)return;const t=wn.a.getSummary(this.props.groupId);t.profile&&["avatar_url","long_description","name","short_description"].forEach(e=>{t.profile[e]=t.profile[e]||""}),this.setState({summary:t,summaryLoading:!wn.a.isStateReady(this.props.groupId,wn.a.STATE_KEY.Summary),isGroupPublicised:wn.a.getGroupPublicity(this.props.groupId),isUserPrivileged:wn.a.isUserPrivileged(this.props.groupId),groupRooms:wn.a.getGroupRooms(this.props.groupId),groupRoomsLoading:!wn.a.isStateReady(this.props.groupId,wn.a.STATE_KEY.GroupRooms),isUserMember:wn.a.getGroupMembers(this.props.groupId).some(e=>e.userId===this._matrixClient.credentials.userId)}),this.props.groupIsNew&&e&&this._onEditClick()}),x()(this,"_onEditClick",()=>{this.setState({editing:!0,profileForm:Object.assign({},this.state.summary.profile),joinableForm:{policyType:this.state.summary.profile.is_openly_joinable?"open":"invite"}})}),x()(this,"_onShareClick",()=>{const e=d.getComponent("dialogs.ShareDialog");Le.a.createTrackedDialog("share community dialog","",e,{target:this._matrixClient.getGroup(this.props.groupId)||new qh.a(this.props.groupId)})}),x()(this,"_onCancelClick",()=>{this._closeSettings()}),x()(this,"_onAction",e=>{switch(e.action){case"close_settings":this.setState({editing:!1,profileForm:null})}}),x()(this,"_closeSettings",()=>{u.a.dispatch({action:"close_settings"})}),x()(this,"_onNameChange",e=>{const t=Object.assign(this.state.profileForm,{name:e});this.setState({profileForm:t})}),x()(this,"_onShortDescChange",e=>{const t=Object.assign(this.state.profileForm,{short_description:e});this.setState({profileForm:t})}),x()(this,"_onLongDescChange",e=>{const t=Object.assign(this.state.profileForm,{long_description:e.target.value});this.setState({profileForm:t})}),x()(this,"_onAvatarSelected",e=>{const t=e.target.files[0];t&&(this.setState({uploadingAvatar:!0}),this._matrixClient.uploadContent(t).then(e=>{const t=Object.assign(this.state.profileForm,{avatar_url:e});this.setState({uploadingAvatar:!1,profileForm:t,avatarChanged:!0})}).catch(e=>{this.setState({uploadingAvatar:!1});const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to upload avatar image",e),Le.a.createTrackedDialog("Failed to upload image","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Failed to upload image")})}))}),x()(this,"_onJoinableChange",e=>{this.setState({joinableForm:{policyType:e.target.value}})}),x()(this,"_onSaveClick",()=>{this.setState({saving:!0});(this.state.isUserPrivileged?this._saveGroup():Promise.resolve()).then(e=>{this.setState({saving:!1,editing:!1,summary:null}),this._initGroupStore(this.props.groupId),this.state.avatarChanged&&et.a.refreshGroupProfile(this._matrixClient,this.props.groupId)}).catch(e=>{this.setState({saving:!1});const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to save community profile",e),Le.a.createTrackedDialog("Failed to update group","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Failed to update community")})}).finally(()=>{this.setState({avatarChanged:!1})})}),x()(this,"_onAcceptInviteClick",async()=>{this.setState({membershipBusy:!0}),await Object(td.c)(500),wn.a.acceptGroupInvite(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=d.getComponent("dialogs.ErrorDialog");Le.a.createTrackedDialog("Error accepting invite","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Unable to accept invite")})})}),x()(this,"_onRejectInviteClick",async()=>{this.setState({membershipBusy:!0}),await Object(td.c)(500),wn.a.leaveGroup(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=d.getComponent("dialogs.ErrorDialog");Le.a.createTrackedDialog("Error rejecting invite","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Unable to reject invite")})})}),x()(this,"_onJoinClick",async()=>{this._matrixClient.isGuest()?u.a.dispatch({action:"require_registration",screen_after:{screen:"group/"+this.props.groupId}}):(this.setState({membershipBusy:!0}),await Object(td.c)(500),wn.a.joinGroup(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=d.getComponent("dialogs.ErrorDialog");Le.a.createTrackedDialog("Error joining room","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Unable to join community")})}))}),x()(this,"_onLeaveClick",()=>{const e=d.getComponent("dialogs.QuestionDialog"),t=this._leaveGroupWarnings();Le.a.createTrackedDialog("Leave Group","",e,{title:Object(c.a)("Leave Community"),description:a.a.createElement("span",null,Object(c.a)("Leave %(groupName)s?",{groupName:this.props.groupId}),t),button:Object(c.a)("Leave"),danger:this.state.isUserPrivileged,onFinished:async e=>{e&&(this.setState({membershipBusy:!0}),await Object(td.c)(500),wn.a.leaveGroup(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=d.getComponent("dialogs.ErrorDialog");Le.a.createTrackedDialog("Error leaving community","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Unable to leave community")})}))}})}),x()(this,"_onAddRoomsClick",()=>{Object(Gh.a)(this.props.groupId)})}componentDidMount(){this._unmounted=!1,this._matrixClient=le.a.get(),this._matrixClient.on("Group.myMembership",this._onGroupMyMembership),this._initGroupStore(this.props.groupId,!0),this._dispatcherRef=u.a.register(this._onAction),this._rightPanelStoreToken=Hh.a.getSharedInstance().addListener(this._onRightPanelStoreUpdate)}componentWillUnmount(){this._unmounted=!0,this._matrixClient.removeListener("Group.myMembership",this._onGroupMyMembership),u.a.unregister(this._dispatcherRef),this._rightPanelStoreToken&&this._rightPanelStoreToken.remove()}UNSAFE_componentWillReceiveProps(e){this.props.groupId!==e.groupId&&this.setState({summary:null,error:null},()=>{this._initGroupStore(e.groupId)})}_initGroupStore(e,t){const s=this._matrixClient.getGroup(e);s&&s.inviter&&s.inviter.userId&&this._fetchInviterProfile(s.inviter.userId),wn.a.registerListener(e,this.onGroupStoreUpdated.bind(this,t));let n=!1;wn.a.on("error",(t,s,i)=>{this._unmounted||e!==s||("M_GUEST_ACCESS_FORBIDDEN"!==t.errcode||n||(u.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"view_group",group_id:e}}),u.a.dispatch({action:"require_registration",screen_after:{screen:"group/"+e}}),n=!0),i===wn.a.STATE_KEY.Summary&&this.setState({summary:null,error:t,editing:!1}))})}_fetchInviterProfile(e){this.setState({inviterProfileBusy:!0}),this._matrixClient.getProfileInfo(e).then(e=>{this._unmounted||this.setState({inviterProfile:{avatarUrl:e.avatar_url,displayName:e.displayname}})}).catch(e=>{console.error("Error getting group inviter profile",e)}).finally(()=>{this._unmounted||this.setState({inviterProfileBusy:!1})})}async _saveGroup(){await this._matrixClient.setGroupProfile(this.props.groupId,this.state.profileForm),await this._matrixClient.setGroupJoinPolicy(this.props.groupId,{type:this.state.joinableForm.policyType})}_leaveGroupWarnings(){const e=[];return this.state.isUserPrivileged&&e.push(a.a.createElement("span",{className:"warning"}," ",Object(c.a)("You are an administrator of this community. You will not be able to rejoin without an invite from another administrator."))),e}_getGroupSection(){const e=M()({mx_GroupView_group:this.state.editing,mx_GroupView_group_disabled:this.state.editing&&!this.state.isUserPrivileged}),t=this.state.editing?a.a.createElement("h2",null," ",Object(c.a)("Community Settings")," "):a.a.createElement("div",null),n=Object(Kh.a)("community-settings");let i=null;n&&this.state.isUserPrivileged&&(i=a.a.createElement("div",{className:"mx_GroupView_hostingSignup"},Object(c.a)("Want more than a community? <a>Get your own server</a>",{},{a:e=>a.a.createElement("a",{href:n,target:"_blank",rel:"noreferrer noopener"},e)}),a.a.createElement("a",{href:n,target:"_blank",rel:"noreferrer noopener"},a.a.createElement("img",{src:s(623),width:"11",height:"10",alt:""}))));const o=this.state.editing&&this.state.isUserPrivileged?a.a.createElement("div",{className:"mx_GroupView_changeDelayWarning"},Object(c.a)("Changes made to your community <bold1>name</bold1> and <bold2>avatar</bold2> might not be seen by other users for up to 30 minutes.",{},{bold1:e=>a.a.createElement("b",null," ",e," "),bold2:e=>a.a.createElement("b",null," ",e," ")})):a.a.createElement("div",null);return a.a.createElement("div",{className:e},t,i,o,this._getJoinableNode(),this._getLongDescriptionNode(),this._getRoomsNode())}_getRoomsNode(){const e=d.getComponent("rooms.RoomDetailList"),t=d.getComponent("elements.AccessibleButton"),n=d.getComponent("elements.TintableSvg"),i=d.getComponent("elements.Spinner"),o=d.getComponent("elements.TooltipButton"),r=this.state.editing?a.a.createElement(o,{helpText:Object(c.a)("These rooms are displayed to community members on the community page. Community members can join the rooms by clicking on them.")}):a.a.createElement("div",null),l=this.state.editing?a.a.createElement(t,{className:"mx_GroupView_rooms_header_addRow",onClick:this._onAddRoomsClick},a.a.createElement("div",{className:"mx_GroupView_rooms_header_addRow_button"},a.a.createElement(n,{src:s(1285),width:"24",height:"24"})),a.a.createElement("div",{className:"mx_GroupView_rooms_header_addRow_label"},Object(c.a)("Add rooms to this community"))):a.a.createElement("div",null);return a.a.createElement("div",{className:"mx_GroupView_rooms"},a.a.createElement("div",{className:"mx_GroupView_rooms_header"},a.a.createElement("h3",null,Object(c.a)("Rooms"),r),l),this.state.groupRoomsLoading?a.a.createElement(i,null):a.a.createElement(e,{rooms:this.state.groupRooms}))}_getFeaturedRoomsNode(){const e=this.state.summary,t=[],s={};e.rooms_section.rooms.forEach(e=>{if(null===e.category_id)t.push(e);else{let t=s[e.category_id];void 0===t&&(t=[],s[e.category_id]=t),t.push(e)}});const n=a.a.createElement(Jh,{rooms:t,groupId:this.props.groupId,editing:this.state.editing}),i=Object.keys(s).map(t=>{const n=e.rooms_section.categories[t];return a.a.createElement(Jh,{key:t,rooms:s[t],category:n,groupId:this.props.groupId,editing:this.state.editing})});return a.a.createElement("div",{className:"mx_GroupView_featuredThings"},a.a.createElement("div",{className:"mx_GroupView_featuredThings_header"},Object(c.a)("Featured Rooms:")),n,i)}_getFeaturedUsersNode(){const e=this.state.summary,t=[],s={};e.users_section.users.forEach(e=>{if(null===e.role_id)t.push(e);else{let t=s[e.role_id];void 0===t&&(t=[],s[e.role_id]=t),t.push(e)}});const n=a.a.createElement(Xh,{users:t,groupId:this.props.groupId,editing:this.state.editing}),i=Object.keys(s).map(t=>{const n=e.users_section.roles[t];return a.a.createElement(Xh,{key:t,users:s[t],role:n,groupId:this.props.groupId,editing:this.state.editing})});return a.a.createElement("div",{className:"mx_GroupView_featuredThings"},a.a.createElement("div",{className:"mx_GroupView_featuredThings_header"},Object(c.a)("Featured Users:")),n,i)}_getMembershipSection(){const e=d.getComponent("elements.Spinner"),t=d.getComponent("avatars.BaseAvatar"),s=this._matrixClient.getGroup(this.props.groupId);if(s&&"invite"===s.myMembership){if(this.state.membershipBusy||this.state.inviterProfileBusy)return a.a.createElement("div",{className:"mx_GroupView_membershipSection"},a.a.createElement(e,null));const n=this.state.inviterProfile&&this.state.inviterProfile.avatarUrl?Object(pe.b)(this.state.inviterProfile.avatarUrl).getSquareThumbnailHttp(36):null,i=s.inviter||{};let o=i.userId;return this.state.inviterProfile&&(o=this.state.inviterProfile.displayName||i.userId),a.a.createElement("div",{className:"mx_GroupView_membershipSection mx_GroupView_membershipSection_invited"},a.a.createElement("div",{className:"mx_GroupView_membershipSubSection"},a.a.createElement("div",{className:"mx_GroupView_membershipSection_description"},a.a.createElement(t,{url:n,name:o,width:36,height:36}),Object(c.a)("%(inviter)s has invited you to join this community",{inviter:o||Object(c.a)("Someone")})),a.a.createElement("div",{className:"mx_GroupView_membership_buttonContainer"},a.a.createElement(g.a,{className:"mx_GroupView_textButton mx_RoomHeader_textButton",onClick:this._onAcceptInviteClick},Object(c.a)("Accept")),a.a.createElement(g.a,{className:"mx_GroupView_textButton mx_RoomHeader_textButton",onClick:this._onRejectInviteClick},Object(c.a)("Decline")))))}let n,i,o,r,l;if((!s||"leave"===s.myMembership)&&this.state.summary&&this.state.summary.profile&&Boolean(this.state.summary.profile.is_openly_joinable))r=Object(c.a)("Join this community"),l=this._onJoinClick,i="mx_GroupView_joinButton",n="mx_GroupView_membershipSection_leave";else{if(!s||"join"!==s.myMembership||!this.state.editing)return null;r=Object(c.a)("Leave this community"),l=this._onLeaveClick,o=this.state.isUserPrivileged?Object(c.a)("You are an administrator of this community"):Object(c.a)("You are a member of this community"),i={mx_GroupView_leaveButton:!0,mx_RoomHeader_textButton_danger:this.state.isUserPrivileged},n="mx_GroupView_membershipSection_joined"}const u=M()(["mx_RoomHeader_textButton","mx_GroupView_textButton"],i),h=M()("mx_GroupView_membershipSection",n);return a.a.createElement("div",{className:h},a.a.createElement("div",{className:"mx_GroupView_membershipSubSection"},this.state.membershipBusy?a.a.createElement(e,null):a.a.createElement("div",null),a.a.createElement("div",{className:"mx_GroupView_membership_buttonContainer"},a.a.createElement(g.a,{className:u,onClick:l,title:o},r))))}_getJoinableNode(){const e=d.getComponent("elements.InlineSpinner");return this.state.editing?a.a.createElement("div",null,a.a.createElement("h3",null,Object(c.a)("Who can join this community?"),this.state.groupJoinableLoading?a.a.createElement(e,null):a.a.createElement("div",null)),a.a.createElement("div",null,a.a.createElement("label",null,a.a.createElement("input",{type:"radio",value:"invite",checked:"invite"===this.state.joinableForm.policyType,onChange:this._onJoinableChange}),a.a.createElement("div",{className:"mx_GroupView_label_text"},Object(c.a)("Only people who have been invited")))),a.a.createElement("div",null,a.a.createElement("label",null,a.a.createElement("input",{type:"radio",value:"open",checked:"open"===this.state.joinableForm.policyType,onChange:this._onJoinableChange}),a.a.createElement("div",{className:"mx_GroupView_label_text"},Object(c.a)("Everyone"))))):null}_getLongDescriptionNode(){const e=this.state.summary;let t=null;e.profile&&e.profile.long_description?t=Object(pn.h)(e.profile.long_description):this.state.isUserPrivileged&&(t=a.a.createElement("div",{className:"mx_GroupView_groupDesc_placeholder",onClick:this._onEditClick},Object(c.a)("Your community hasn't got a Long Description, a HTML page to show to community members.<br />Click here to open settings and give it one!",{},{br:a.a.createElement("br",null)})));const s=M()({mx_GroupView_groupDesc:!0,mx_GroupView_groupDesc_disabled:!this.state.isUserPrivileged});return this.state.editing?a.a.createElement("div",{className:s},a.a.createElement("h3",null," ",Object(c.a)("Long Description (HTML)")," "),a.a.createElement("textarea",{value:this.state.profileForm.long_description,placeholder:Object(c.a)($h),onChange:this._onLongDescChange,tabIndex:"4",key:"editLongDesc"})):a.a.createElement("div",{className:"mx_GroupView_groupDesc"},t)}render(){const e=d.getComponent("avatars.GroupAvatar"),t=d.getComponent("elements.Spinner");if(this.state.summaryLoading&&null===this.state.error||this.state.saving)return a.a.createElement(t,null);if(this.state.summary&&!this.state.error){const i=this.state.summary;let o,r,l;const u=[];if(this.state.editing&&this.state.isUserPrivileged){let e;if(this.state.uploadingAvatar)e=a.a.createElement(t,null);else{const t=d.getComponent("avatars.GroupAvatar");e=a.a.createElement(t,{groupId:this.props.groupId,groupName:this.state.profileForm.name,groupAvatarUrl:this.state.profileForm.avatar_url,width:28,height:28,resizeMethod:"crop"})}o=a.a.createElement("div",{className:"mx_GroupView_avatarPicker"},a.a.createElement("label",{htmlFor:"avatarInput",className:"mx_GroupView_avatarPicker_label"},e),a.a.createElement("div",{className:"mx_GroupView_avatarPicker_edit"},a.a.createElement("label",{htmlFor:"avatarInput",className:"mx_GroupView_avatarPicker_label"},a.a.createElement("img",{src:s(1286),alt:Object(c.a)("Upload avatar"),title:Object(c.a)("Upload avatar"),width:"17",height:"15"})),a.a.createElement("input",{id:"avatarInput",className:"mx_GroupView_uploadInput",type:"file",onChange:this._onAvatarSelected})));const n=d.getComponent("elements.EditableText");r=a.a.createElement(n,{className:"mx_GroupView_editable",placeholderClassName:"mx_GroupView_placeholder",placeholder:Object(c.a)("Community Name"),blurToCancel:!1,initialValue:this.state.profileForm.name,onValueChanged:this._onNameChange,tabIndex:"0",dir:"auto"}),l=a.a.createElement(n,{className:"mx_GroupView_editable",placeholderClassName:"mx_GroupView_placeholder",placeholder:Object(c.a)("Description"),blurToCancel:!1,initialValue:this.state.profileForm.short_description,onValueChanged:this._onShortDescChange,tabIndex:"0",dir:"auto"})}else{const t=this.state.isUserMember?this._onEditClick:null,s=i.profile?i.profile.avatar_url:null,n=i.profile?i.profile.name:null;o=a.a.createElement(e,{groupId:this.props.groupId,groupAvatarUrl:s,groupName:n,onClick:t,width:28,height:28}),r=i.profile&&i.profile.name?a.a.createElement("div",{onClick:t},a.a.createElement("span",null,i.profile.name),a.a.createElement("span",{className:"mx_GroupView_header_groupid"},"(",this.props.groupId,")")):a.a.createElement("span",{onClick:t},this.props.groupId),i.profile&&i.profile.short_description&&(l=a.a.createElement("span",{onClick:t},i.profile.short_description))}this.state.editing?(u.push(a.a.createElement(g.a,{className:"mx_GroupView_textButton mx_RoomHeader_textButton",key:"_saveButton",onClick:this._onSaveClick},Object(c.a)("Save"))),u.push(a.a.createElement(g.a,{className:"mx_RoomHeader_cancelButton",key:"_cancelButton",onClick:this._onCancelClick},a.a.createElement("img",{src:s(336),className:"mx_filterFlipColor",width:"18",height:"18",alt:Object(c.a)("Cancel")})))):(i.user&&"join"===i.user.membership&&u.push(a.a.createElement(g.a,{className:"mx_GroupHeader_button mx_GroupHeader_editButton",key:"_editButton",onClick:this._onEditClick,title:Object(c.a)("Community Settings")})),u.push(a.a.createElement(g.a,{className:"mx_GroupHeader_button mx_GroupHeader_shareButton",key:"_shareButton",onClick:this._onShareClick,title:Object(c.a)("Share Community")})));const h=this.state.showRightPanel?a.a.createElement(mn.a,{groupId:this.props.groupId}):void 0,m={mx_GroupView_header:!0,"light-panel":!0,mx_GroupView_header_view:!this.state.editing,mx_GroupView_header_isUserMember:this.state.isUserMember};return a.a.createElement("main",{className:"mx_GroupView"},a.a.createElement("div",{className:M()(m)},a.a.createElement("div",{className:"mx_GroupView_header_leftCol"},a.a.createElement("div",{className:"mx_GroupView_header_avatar"},o),a.a.createElement("div",{className:"mx_GroupView_header_info"},a.a.createElement("div",{className:"mx_GroupView_header_name"},r),a.a.createElement("div",{className:"mx_GroupView_header_shortDesc"},l))),a.a.createElement("div",{className:"mx_GroupView_header_rightCol"},u),a.a.createElement(Zc,null)),a.a.createElement(Wh.a,{panel:h,resizeNotifier:this.props.resizeNotifier},a.a.createElement(n.a,{className:"mx_GroupView_body"},this._getMembershipSection(),this._getGroupSection())))}if(this.state.error){if(404===this.state.error.httpStatus)return a.a.createElement("div",{className:"mx_GroupView_error"},Object(c.a)("Community %(groupId)s not found",{groupId:this.props.groupId}));{let e;return"M_UNRECOGNIZED"===this.state.error.errcode&&(e=a.a.createElement("div",null,Object(c.a)("This homeserver does not support communities"))),a.a.createElement("div",{className:"mx_GroupView_error"},Object(c.a)("Failed to load %(groupId)s",{groupId:this.props.groupId}),e)}}return console.error("Invalid state for GroupView"),a.a.createElement("div",null)}},x()(Bh,"propTypes",{groupId:wt.a.string.isRequired,groupIsNew:wt.a.bool}),Fh=Vh))||Fh;var tm,sm,nm,im=s(147),om=s.n(im),am=s(265),rm=s(150),cm=s(187),lm=s(309);const dm=["m.sticker","m.room.message"],um=["m.room.member","m.room.third_party_invite","m.room.server_acl"];let hm=Object(P.a)("structures.MessagePanel")((nm=sm=class extends a.a.Component{constructor(e){super(e),x()(this,"onShowTypingNotificationsChange",()=>{this.setState({showTypingNotifications:V.b.getValue("showTypingNotifications")})}),x()(this,"_isUnmounting",()=>!this._isMounted),x()(this,"_collectGhostReadMarker",e=>{e&&requestAnimationFrame(()=>{e.style.width="10%",e.style.opacity="0"})}),x()(this,"_onGhostTransitionEnd",e=>{const t=e.target.dataset.eventid;this.setState({ghostReadMarkers:this.state.ghostReadMarkers.filter(e=>e!==t)})}),x()(this,"_collectEventNode",(e,t)=>{var s;this.eventNodes[e]=null==t||null===(s=t.ref)||void 0===s?void 0:s.current}),x()(this,"_onHeightChanged",()=>{const e=this._scrollPanel.current;e&&e.checkScroll()}),x()(this,"_onTypingShown",()=>{const e=this._scrollPanel.current;e.checkScroll(),e&&e.getScrollState().stuckAtBottom&&e.preventShrinking()}),x()(this,"_onTypingHidden",()=>{const e=this._scrollPanel.current;e&&(e.updatePreventShrinking(),e.checkScroll())}),this.state={ghostReadMarkers:[],showTypingNotifications:V.b.getValue("showTypingNotifications")},this._readReceiptMap={},this._readReceiptsByEvent={},this._readReceiptsByUserId={},this._showHiddenEventsInTimeline=V.b.getValue("showHiddenEventsInTimeline"),this._isMounted=!1,this._readMarkerNode=Object(o.createRef)(),this._whoIsTyping=Object(o.createRef)(),this._scrollPanel=Object(o.createRef)(),this._showTypingNotificationsWatcherRef=V.b.watchSetting("showTypingNotifications",null,this.onShowTypingNotificationsChange)}componentDidMount(){this._isMounted=!0}componentWillUnmount(){this._isMounted=!1,V.b.unwatchSetting(this._showTypingNotificationsWatcherRef)}componentDidUpdate(e,t){if(e.readMarkerVisible&&this.props.readMarkerEventId!==e.readMarkerEventId){const t=this.state.ghostReadMarkers;t.push(e.readMarkerEventId),this.setState({ghostReadMarkers:t})}}getNodeForEventId(e){if(this.eventNodes)return this.eventNodes[e]}isAtBottom(){return this._scrollPanel.current&&this._scrollPanel.current.isAtBottom()}getScrollState(){return this._scrollPanel.current?this._scrollPanel.current.getScrollState():null}getReadMarkerPosition(){const e=this._readMarkerNode.current,t=this._scrollPanel.current;if(!e||!t)return null;const s=om.a.findDOMNode(t).getBoundingClientRect(),n=e.getBoundingClientRect();return n.bottom+2<s.top?-1:n.top<s.bottom?0:1}scrollToTop(){this._scrollPanel.current&&this._scrollPanel.current.scrollToTop()}scrollToBottom(){this._scrollPanel.current&&this._scrollPanel.current.scrollToBottom()}scrollRelative(e){this._scrollPanel.current&&this._scrollPanel.current.scrollRelative(e)}handleScrollKey(e){this._scrollPanel.current&&this._scrollPanel.current.handleScrollKey(e)}scrollToEvent(e,t,s){this._scrollPanel.current&&this._scrollPanel.current.scrollToToken(e,t,s)}scrollToEventIfNeeded(e){const t=this.eventNodes[e];t&&t.scrollIntoView({block:"nearest",behavior:"instant"})}checkFillState(){this._scrollPanel.current&&this._scrollPanel.current.checkFillState()}_shouldShowEvent(e){return(!e.sender||!le.a.get().isUserIgnored(e.sender.userId))&&(!!this._showHiddenEventsInTimeline||!!Object(fu.b)(e)&&(this.props.highlightedEventId===e.getId()||!Object(am.a)(e,this.context)))}_readMarkerForEvent(e,t){const s=!t&&this.props.readMarkerVisible;if(this.props.readMarkerEventId===e){let t;return s&&(t=a.a.createElement("hr",{className:"mx_RoomView_myReadMarker",style:{opacity:1,width:"99%"}})),a.a.createElement("li",{key:"readMarker_"+e,ref:this._readMarkerNode,className:"mx_RoomView_myReadMarker_container","data-scroll-tokens":e},t)}if(this.state.ghostReadMarkers.includes(e)){const t=a.a.createElement("hr",{className:"mx_RoomView_myReadMarker",ref:this._collectGhostReadMarker,onTransitionEnd:this._onGhostTransitionEnd,"data-eventid":e});return a.a.createElement("li",{key:"_readuptoghost_"+e,className:"mx_RoomView_myReadMarker_container"},t)}return null}_getNextEventInfo(e,t){return{nextEvent:t<e.length-1?e[t+1]:null,nextTile:e.slice(t+1).find(e=>this._shouldShowEvent(e))}}get _roomHasPendingEdit(){return this.props.room&&localStorage.getItem("mx_edit_room_"+this.props.room.roomId)}_getEventTiles(){let e,t;this.eventNodes={};let s=-1;for(e=this.props.events.length-1;e>=0;e--){const n=this.props.events[e];if(this._shouldShowEvent(n)&&(void 0===t&&(t=n),!n.status)){s=e;break}}const n=[];let i=null;this._readReceiptsByEvent={},this.props.showReadReceipts&&(this._readReceiptsByEvent=this._getReadReceiptsByShownEvent());let o=null;for(e=0;e<this.props.events.length;e++){const a=this.props.events[e],r=a.getId(),c=a===t,{nextEvent:l,nextTile:d}=this._getNextEventInfo(this.props.events,e);if(o){if(o.shouldGroup(a)){o.add(a);continue}n.push(...o.getTiles()),i=o.getNewPrevEvent(),o=null}for(const e of vm)e.canStartGroup(this,a)&&(o=new e(this,a,i,t,l,d,this.props.layout));if(!o){const t=!1;this._shouldShowEvent(a)&&(n.push(...this._getTilesForEvent(i,a,c,t,l,d)),i=a);const o=this._readMarkerForEvent(r,e>=s);o&&n.push(o)}}return!this.props.editState&&this._roomHasPendingEdit&&u.a.dispatch({action:"edit_event",event:this.props.room.findEventById(this._roomHasPendingEdit)}),o&&n.push(...o.getTiles()),n}_getTilesForEvent(e,t,s,n=!1,i,o){const r=d.getComponent("messages.TileErrorBoundary"),c=d.getComponent("rooms.EventTile"),l=d.getComponent("messages.DateSeparator"),u=[],h=this.props.editState&&this.props.editState.getEvent().getId()===t.getId();let m=t.getTs(),p=t.getDate();t.status&&(p=new Date,m=p.getTime());const g=this._wantsDateSeparator(e,p);if(g&&!n){const e=a.a.createElement("li",{key:m},a.a.createElement(l,{key:m,ts:m}));u.push(e)}let v=!1;i&&(v=this._wantsDateSeparator(t,i.getDate()||new Date));const f=!g&&function(e,t){return!!(e&&e.sender&&t.sender)&&(!(t.getTs()-e.getTs()>3e5)&&(t.isRedacted()===e.isRedacted()&&(!!(t.getType()===e.getType()||dm.includes(t.getType())&&dm.includes(e.getType()))&&(t.sender.userId===e.sender.userId&&t.sender.name===e.sender.name&&t.sender.getMxcAvatarUrl()===e.sender.getMxcAvatarUrl()&&!!Object(fu.b)(e)))))}(e,t),b=t.getId(),y=b===this.props.highlightedEventId,_=this._readReceiptsByEvent[b];let E=!1;const S=e=>!e||"sent"===e,w=S(t.getAssociatedStatus()),C=i&&this._shouldShowEvent(i);return(!C&&w||C&&w&&!S(i.getAssociatedStatus()))&&(E=!0),o&&o!==i&&S(o.getAssociatedStatus())&&(E=!1),E=E&&t.getSender()===le.a.get().getUserId(),u.push(a.a.createElement(r,{key:t.getTxnId()||b,mxEvent:t},a.a.createElement(c,{as:"li",ref:this._collectEventNode.bind(this,b),alwaysShowTimestamps:this.props.alwaysShowTimestamps,mxEvent:t,continuation:f,isRedacted:t.isRedacted(),replacingEventId:t.replacingEventId(),editState:h&&this.props.editState,onHeightChanged:this._onHeightChanged,readReceipts:_,readReceiptMap:this._readReceiptMap,showUrlPreview:this.props.showUrlPreview,checkUnmounting:this._isUnmounting,eventSendStatus:t.getAssociatedStatus(),tileShape:this.props.tileShape,isTwelveHour:this.props.isTwelveHour,permalinkCreator:this.props.permalinkCreator,last:s,lastInSection:v,lastSuccessful:E,isSelectedEvent:y,getRelationsForEvent:this.props.getRelationsForEvent,showReactions:this.props.showReactions,layout:this.props.layout,singleSideBubbles:this.props.singleSideBubbles,enableFlair:this.props.enableFlair,showReadReceipts:this.props.showReadReceipts}))),u}_wantsDateSeparator(e,t){return null==e?!this.props.suppressFirstDateSeparator:Object(rm.f)(e.getDate(),t)}_getReadReceiptsForEvent(e){const t=le.a.get().credentials.userId,{room:s}=this.props;if(!s)return null;const n=[];return s.getReceiptsForEvent(e).forEach(e=>{if(!e.userId||"m.read"!==e.type||e.userId===t)return;if(le.a.get().isUserIgnored(e.userId))return;const i=s.getMember(e.userId);n.push({userId:e.userId,roomMember:i,ts:e.data?e.data.ts:0})}),n}_getReadReceiptsByShownEvent(){const e={},t={};let s;for(const n of this.props.events){if(this._shouldShowEvent(n)&&(s=n.getId()),!s)continue;const i=e[s]||[],o=this._getReadReceiptsForEvent(n);e[s]=i.concat(o);for(const e of o)t[e.userId]={lastShownEventId:s,receipt:e}}for(const s in this._readReceiptsByUserId){if(t[s])continue;const{lastShownEventId:n,receipt:i}=this._readReceiptsByUserId[s],o=e[n]||[];e[n]=o.concat(i),t[s]={lastShownEventId:n,receipt:i}}this._readReceiptsByUserId=t;for(const t in e)e[t].sort((e,t)=>t.ts-e.ts);return e}updateTimelineMinHeight(){const e=this._scrollPanel.current;if(e){const t=e.isAtBottom(),s=this._whoIsTyping.current,n=s&&s.isVisible();t&&n&&e.preventShrinking()}}onTimelineReset(){const e=this._scrollPanel.current;e&&e.clearPreventShrinking()}render(){const e=d.getComponent("elements.ErrorBoundary"),t=d.getComponent("structures.ScrollPanel"),s=d.getComponent("rooms.WhoIsTypingTile"),n=d.getComponent("elements.Spinner");let i,o;this.props.backPaginating&&(i=a.a.createElement("li",{key:"_topSpinner"},a.a.createElement(n,null))),this.props.forwardPaginating&&(o=a.a.createElement("li",{key:"_bottomSpinner"},a.a.createElement(n,null)));const r=this.props.hidden?{display:"none"}:{};let c;this.props.room&&!this.props.tileShape&&this.state.showTypingNotifications&&(c=a.a.createElement(s,{room:this.props.room,onShown:this._onTypingShown,onHidden:this._onTypingHidden,ref:this._whoIsTyping}));let l=null;return this.props.layout==ba.a.IRC&&(l=a.a.createElement(wa,{minWidth:20,maxWidth:600,roomId:this.props.room?this.props.room.roomId:null})),a.a.createElement(e,null,a.a.createElement(t,{ref:this._scrollPanel,className:this.props.className,onScroll:this.props.onScroll,onUserScroll:this.props.onUserScroll,onResize:this.onResize,onFillRequest:this.props.onFillRequest,onUnfillRequest:this.props.onUnfillRequest,style:r,stickyBottom:this.props.stickyBottom,resizeNotifier:this.props.resizeNotifier,fixedChildren:l},i,this._getEventTiles(),c,o))}},x()(sm,"propTypes",{hidden:wt.a.bool,backPaginating:wt.a.bool,forwardPaginating:wt.a.bool,events:wt.a.array.isRequired,highlightedEventId:wt.a.string,room:wt.a.object,showUrlPreview:wt.a.bool,readMarkerEventId:wt.a.string,readMarkerVisible:wt.a.bool,ourUserId:wt.a.string,suppressFirstDateSeparator:wt.a.bool,showReadReceipts:wt.a.bool,stickyBottom:wt.a.bool,onScroll:wt.a.func,onUserScroll:wt.a.func,onFillRequest:wt.a.func,className:wt.a.string.isRequired,tileShape:wt.a.string,isTwelveHour:wt.a.bool,alwaysShowTimestamps:wt.a.bool,getRelationsForEvent:wt.a.func,showReactions:wt.a.bool,layout:ba.b,singleSideBubbles:wt.a.bool,enableFlair:wt.a.bool}),x()(sm,"contextType",cm.a),tm=nm))||tm;class mm{constructor(e,t,s,n,i,o,a){this.panel=e,this.createEvent=t,this.prevEvent=s,this.lastShownEvent=n,this.events=[],this.ejectedEvents=[],this.readMarker=e._readMarkerForEvent(t.getId(),t===n),this.layout=a}shouldGroup(e){const t=this.panel,s=this.createEvent;return!t._shouldShowEvent(e)||!t._wantsDateSeparator(this.createEvent,e.getDate())&&(("m.room.member"!==e.getType()||e.getStateKey()===s.getSender()&&"join"===e.getContent().membership)&&!(!e.isState()||e.getSender()!==s.getSender()))}add(e){const t=this.panel;this.readMarker=this.readMarker||t._readMarkerForEvent(e.getId(),e===this.lastShownEvent),t._shouldShowEvent(e)&&("m.room.encryption"===e.getType()?this.ejectedEvents.push(e):this.events.push(e))}getTiles(){if(!this.events||!this.events.length)return[];const e=d.getComponent("messages.DateSeparator"),t=d.getComponent("views.elements.EventListSummary"),s=this.panel,n=[],i=this.createEvent,o=this.lastShownEvent;if(s._wantsDateSeparator(this.prevEvent,i.getDate())){const t=i.getTs();n.push(a.a.createElement("li",{key:t+"~"},a.a.createElement(e,{key:t+"~",ts:t})))}s._shouldShowEvent(i)&&n.push(...s._getTilesForEvent(i,i));for(const e of this.ejectedEvents)n.push(...s._getTilesForEvent(i,e,i===o,!0));const r=this.events.map(e=>s._getTilesForEvent(e,e,e===o,!0)).reduce((e,t)=>e.concat(t),[]),l=this.events[this.events.length-1];let u;const h=l.getRoomId(),m=l.sender?l.sender.name:l.getSender();return u=mr.a.shared().getUserIdForRoomId(h)?Object(c.a)("%(creator)s created this DM.",{creator:m}):Object(c.a)("%(creator)s created and configured the room.",{creator:m}),n.push(a.a.createElement(qu.a,{key:"newroomintro"})),n.push(a.a.createElement(t,{key:"roomcreationsummary",events:this.events,onToggle:s._onHeightChanged,summaryMembers:[l.sender],summaryText:u,layout:this.layout},r)),this.readMarker&&n.push(this.readMarker),n}getNewPrevEvent(){return this.createEvent}}x()(mm,"canStartGroup",(function(e,t){return"m.room.create"===t.getType()}));class pm{constructor(e,t,s,n,i,o,a){this.panel=e,this.readMarker=e._readMarkerForEvent(t.getId(),t===n),this.events=[t],this.prevEvent=s,this.lastShownEvent=n,this.nextEvent=i,this.nextEventTile=o,this.layout=a}shouldGroup(e){return!this.panel._shouldShowEvent(e)||!this.panel._wantsDateSeparator(this.events[0],e.getDate())&&e.isRedacted()}add(e){this.readMarker=this.readMarker||this.panel._readMarkerForEvent(e.getId(),e===this.lastShownEvent),this.panel._shouldShowEvent(e)&&this.events.push(e)}getTiles(){if(!this.events||!this.events.length)return[];const e=d.getComponent("messages.DateSeparator"),t=d.getComponent("views.elements.EventListSummary"),s=this.panel,n=[],i=this.lastShownEvent;if(s._wantsDateSeparator(this.prevEvent,this.events[0].getDate())){const t=this.events[0].getTs();n.push(a.a.createElement("li",{key:t+"~"},a.a.createElement(e,{key:t+"~",ts:t})))}const o="redactioneventlistsummary-"+(this.prevEvent?this.events[0].getId():"initial"),r=new Set;let l=this.events.map((e,t)=>{r.add(e.sender);const n=0===t?this.prevEvent:this.events[t-1];return s._getTilesForEvent(n,e,e===i,!0,this.nextEvent,this.nextEventTile)}).reduce((e,t)=>e.concat(t),[]);return 0===l.length&&(l=null),n.push(a.a.createElement(t,{key:o,threshold:2,events:this.events,onToggle:s._onHeightChanged,summaryMembers:Array.from(r),summaryText:Object(c.a)("%(count)s messages deleted.",{count:l.length}),layout:this.layout},l)),this.readMarker&&n.push(this.readMarker),n}getNewPrevEvent(){return this.events[this.events.length-1]}}x()(pm,"canStartGroup",(function(e,t){return e._shouldShowEvent(t)&&t.isRedacted()}));class gm{constructor(e,t,s,n,i,o,a){this.panel=e,this.readMarker=e._readMarkerForEvent(t.getId(),t===n),this.events=[t],this.prevEvent=s,this.lastShownEvent=n,this.layout=a}shouldGroup(e){return!this.panel._wantsDateSeparator(this.events[0],e.getDate())&&um.includes(e.getType())}add(e){("m.room.member"!==e.getType()||Object(lm.a)(e))&&(this.readMarker=this.readMarker||this.panel._readMarkerForEvent(e.getId(),e===this.lastShownEvent),this.events.push(e))}getTiles(){if(!this.events||!this.events.length)return[];const e=d.getComponent("messages.DateSeparator"),t=d.getComponent("views.elements.MemberEventListSummary"),s=this.panel,n=this.lastShownEvent,i=[];if(s._wantsDateSeparator(this.prevEvent,this.events[0].getDate())){const t=this.events[0].getTs();i.push(a.a.createElement("li",{key:t+"~"},a.a.createElement(e,{key:t+"~",ts:t})))}const o="membereventlistsummary-"+(this.prevEvent?this.events[0].getId():"initial");let r,c=this.events.map(e=>(e.getId()===s.props.highlightedEventId&&(r=!0),s._getTilesForEvent(e,e,e===n,!0))).reduce((e,t)=>e.concat(t),[]);return 0===c.length&&(c=null),i.push(a.a.createElement(t,{key:o,events:this.events,onToggle:s._onHeightChanged,startExpanded:r,layout:this.layout},c)),this.readMarker&&i.push(this.readMarker),i}getNewPrevEvent(){return this.events[0]}}x()(gm,"canStartGroup",(function(e,t){return e._shouldShowEvent(t)&&um.includes(t.getType())}));const vm=[mm,gm,pm];var fm,bm,ym;let _m=Object(P.a)("structures.MyGroups")((ym=bm=class extends a.a.Component{constructor(...e){super(...e),x()(this,"state",{groups:null,error:null}),x()(this,"_onCreateGroupClick",()=>{u.a.dispatch({action:"view_create_group"})})}componentDidMount(){this._fetch()}_fetch(){this.context.getJoinedGroups().then(e=>{this.setState({groups:e.groups,error:null})},e=>{"M_GUEST_ACCESS_FORBIDDEN"!==e.errcode?this.setState({groups:null,error:e}):this.setState({groups:[],error:null})})}render(){const e=l.a.get().brand,t=d.getComponent("elements.Spinner"),i=d.getComponent("rooms.SimpleRoomHeader"),o=d.getComponent("groups.GroupTile");let r,u;if(this.state.groups){const t=[];this.state.groups.forEach(e=>{t.push(a.a.createElement(o,{key:e,groupId:e}))}),u=t.length>0?a.a.createElement("h3",null,Object(c.a)("Your Communities")):a.a.createElement("div",null),r=t.length>0?a.a.createElement(n.a,{className:"mx_MyGroups_scrollable"},a.a.createElement("div",{className:"mx_MyGroups_microcopy"},a.a.createElement("p",null,Object(c.a)("Did you know: you can use communities to filter your %(brand)s experience!",{brand:e})),a.a.createElement("p",null,Object(c.a)("You can click on an avatar in the filter panel at any time to see only the rooms and people associated with that community."))),a.a.createElement("div",{className:"mx_MyGroups_joinedGroups"},t)):a.a.createElement("div",{className:"mx_MyGroups_placeholder"},Object(c.a)("You're not currently a member of any communities."))}else r=this.state.error?a.a.createElement("div",{className:"mx_MyGroups_error"},Object(c.a)("Error whilst fetching joined communities")):a.a.createElement(t,null);return a.a.createElement("div",{className:"mx_MyGroups"},a.a.createElement(i,{title:Object(c.a)("Communities"),icon:s(1287)}),a.a.createElement("div",{className:"mx_MyGroups_header"},a.a.createElement("div",{className:"mx_MyGroups_headerCard"},a.a.createElement(g.a,{className:"mx_MyGroups_headerCard_button",onClick:this._onCreateGroupClick}),a.a.createElement("div",{className:"mx_MyGroups_headerCard_content"},a.a.createElement("div",{className:"mx_MyGroups_headerCard_header"},Object(c.a)("Create a new community")),Object(c.a)("Create a community to group together users and rooms! Build a custom homepage to mark out your space in the Matrix universe.")))),a.a.createElement(xs.b,{featureId:"feature_spaces",title:Object(c.a)("Communities are changing to Spaces")}),a.a.createElement("div",{className:"mx_MyGroups_content"},u,r))}},x()(bm,"contextType",b.a),fm=ym))||fm;var Em,Sm=s(691),wm=s(281),Cm=s(444),km=s(114),Om=s(168);let Rm=Object(P.a)("structures.UserView")(Em=class extends a.a.Component{static get propTypes(){return{userId:wt.a.string}}constructor(e){super(e),this.state={}}componentDidMount(){this.props.userId&&this._loadProfileInfo()}componentDidUpdate(e){e.userId!==this.props.userId&&this.props.userId&&this._loadProfileInfo()}async _loadProfileInfo(){const e=le.a.get();let t;this.setState({loading:!0});try{t=await e.getProfileInfo(this.props.userId)}catch(e){const t=d.getComponent("dialogs.ErrorDialog");return Le.a.createTrackedDialog(Object(c.a)("Could not load user profile"),"",t,{title:Object(c.a)("Could not load user profile"),description:e&&e.message?e.message:Object(c.a)("Operation failed")}),void this.setState({loading:!1})}const s=new km.b({type:"m.room.member",content:t}),n=new Om.a(null,this.props.userId);n.setMembershipEvent(s),this.setState({member:n,loading:!1})}render(){if(this.state.loading){const e=d.getComponent("elements.Spinner");return a.a.createElement(e,null)}if(this.state.member){const e=d.getComponent("structures.RightPanel"),t=d.getComponent("structures.MainSplit"),s=a.a.createElement(e,{user:this.state.member});return a.a.createElement(t,{panel:s,resizeNotifier:this.props.resizeNotifier},a.a.createElement(R,null))}return a.a.createElement("div",null)}})||Em;var Im,xm,Tm,jm=s(451);let Nm=Object(P.a)("structures.ViewSource")((Tm=xm=class extends a.a.Component{constructor(e){super(e),this.state={isEditing:!1}}onBack(){this.setState({isEditing:!1})}onEdit(){this.setState({isEditing:!0})}viewSourceContent(){const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=e.isEncrypted(),s=e.clearEvent,n=e.event;return t?a.a.createElement(a.a.Fragment,null,a.a.createElement("details",{open:!0,className:"mx_ViewSource_details"},a.a.createElement("summary",null,a.a.createElement("span",{className:"mx_ViewSource_heading"},Object(c.a)("Decrypted event source"))),a.a.createElement(jm.a,{className:"json"},JSON.stringify(s,null,2))),a.a.createElement("details",{className:"mx_ViewSource_details"},a.a.createElement("summary",null,a.a.createElement("span",{className:"mx_ViewSource_heading"},Object(c.a)("Original event source"))),a.a.createElement(jm.a,{className:"json"},JSON.stringify(n,null,2)))):a.a.createElement(a.a.Fragment,null,a.a.createElement("div",{className:"mx_ViewSource_heading"},Object(c.a)("Original event source")),a.a.createElement(jm.a,{className:"json"},JSON.stringify(n,null,2)))}getBaseEventId(){const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=e.isEncrypted(),s=this.props.mxEvent;var n,i,o,a;return t?null!==(n=null===(i=e.event.content["m.relates_to"])||void 0===i?void 0:i.event_id)&&void 0!==n?n:s.getId():null!==(o=null===(a=e.getContent()["m.relates_to"])||void 0===a?void 0:a.event_id)&&void 0!==o?o:s.getId()}editSourceContent(){const e=this.props.mxEvent.replacingEvent()||this.props.mxEvent,t=e.isState(),s=e.getRoomId(),n=e.getContent();if(t)return a.a.createElement(b.a.Consumer,null,t=>a.a.createElement(bo.a,{room:t.getRoom(s),forceStateEvent:!0,onBack:()=>this.onBack(),inputs:{eventType:e.getType(),evContent:JSON.stringify(n,null,"\t"),stateKey:e.getStateKey()}}));{var i,o;const t=null!==(i=null===(o=n["m.new_content"])||void 0===o?void 0:o.body)&&void 0!==i?i:n.body,r={body:" * "+t,msgtype:n.msgtype,"m.new_content":{body:t,msgtype:n.msgtype},"m.relates_to":{rel_type:"m.replace",event_id:this.getBaseEventId()}};return a.a.createElement(b.a.Consumer,null,t=>a.a.createElement(bo.a,{room:t.getRoom(s),forceStateEvent:!1,forceGeneralEvent:!0,onBack:()=>this.onBack(),inputs:{eventType:e.getType(),evContent:JSON.stringify(r,null,"\t")}}))}}canSendStateEvent(e){const t=le.a.get();return t.getRoom(e.getRoomId()).currentState.mayClientSendStateEvent(e.getType(),t)}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=this.props.mxEvent.replacingEvent()||this.props.mxEvent,s=this.state.isEditing,n=t.getRoomId(),i=t.getId(),o=t.isState()?this.canSendStateEvent(t):Object(Oc.a)(this.props.mxEvent);return a.a.createElement(e,{className:"mx_ViewSource",onFinished:this.props.onFinished,title:Object(c.a)("View Source")},a.a.createElement("div",null,a.a.createElement("div",null,"Room ID: ",n),a.a.createElement("div",null,"Event ID: ",i),a.a.createElement("div",{className:"mx_ViewSource_separator"}),s?this.editSourceContent():this.viewSourceContent()),!s&&o&&a.a.createElement("div",{className:"mx_Dialog_buttons"},a.a.createElement("button",{onClick:()=>this.onEdit()},Object(c.a)("Edit"))))}},x()(xm,"propTypes",{onFinished:wt.a.func.isRequired,mxEvent:wt.a.object.isRequired}),Im=Tm))||Im;var Pm,Dm,Am,Mm=s(432),Um=s(430);let Lm=Object(P.a)("structures.auth.CompleteSecurity")((Am=Dm=class extends a.a.Component{constructor(){super(),x()(this,"_onStoreUpdate",()=>{const e=Mm.b.sharedInstance();this.setState({phase:e.phase})});const e=Mm.b.sharedInstance();e.on("update",this._onStoreUpdate),e.start(),this.state={phase:e.phase}}componentWillUnmount(){const e=Mm.b.sharedInstance();e.off("update",this._onStoreUpdate),e.stop()}render(){const e=d.getComponent("auth.AuthPage"),t=d.getComponent("auth.CompleteSecurityBody"),{phase:s}=this.state;let n,i;if(s===Mm.a.Loading)return null;if(s===Mm.a.Intro)n=a.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=Object(c.a)("Verify this login");else if(s===Mm.a.Done)n=a.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_verified"}),i=Object(c.a)("Session verified");else if(s===Mm.a.ConfirmSkip)n=a.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=Object(c.a)("Are you sure?");else{if(s!==Mm.a.Busy)throw new Error("Unknown phase "+s);n=a.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),i=Object(c.a)("Verify this login")}return a.a.createElement(e,null,a.a.createElement(t,null,a.a.createElement("h2",{className:"mx_CompleteSecurity_header"},n,i),a.a.createElement("div",{className:"mx_CompleteSecurity_body"},a.a.createElement(Um.a,{onFinished:this.props.onFinished}))))}},x()(Dm,"propTypes",{onFinished:wt.a.func.isRequired}),Pm=Am))||Pm;var Fm;let Bm=Object(P.a)("views.auth.CompleteSecurityBody")(Fm=class extends a.a.PureComponent{render(){return a.a.createElement("div",{className:"mx_CompleteSecurityBody"},this.props.children)}})||Fm;var Vm,Km,Wm;let Gm=Object(P.a)("structures.auth.E2eSetup")((Wm=Km=class extends a.a.Component{render(){return a.a.createElement($n,null,a.a.createElement(Bm,null,a.a.createElement(la,{onFinished:this.props.onFinished,accountPassword:this.props.accountPassword,tokenLogin:this.props.tokenLogin})))}},x()(Km,"propTypes",{onFinished:wt.a.func.isRequired,accountPassword:wt.a.string,tokenLogin:wt.a.bool}),Vm=Wm))||Vm;class qm{constructor(e,t){this.client=Object(Ci.createClient)({baseUrl:e,idBaseUrl:t}),this.clientSecret=this.client.generateClientSecret(),this.identityServerDomain=t?t.split("://")[1]:null}resetPassword(e,t){return this.password=t,this.client.requestPasswordEmailToken(e,this.clientSecret,1).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_NOT_FOUND"===e.errcode?e.message=Object(c.a)("This email address was not found"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async checkEmailLinkClicked(){const e={sid:this.sessionId,client_secret:this.clientSecret};try{await this.client.setPassword({type:"m.login.email.identity",threepid_creds:e,threepidCreds:e},this.password)}catch(e){throw 401===e.httpStatus?e.message=Object(c.a)("Failed to verify email address: make sure you clicked the link in the email"):404===e.httpStatus?e.message=Object(c.a)("Your email address does not appear to be associated with a Matrix ID on this Homeserver."):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}}var Hm,$m,zm;let Ym=Object(P.a)("structures.auth.ForgotPassword")((zm=$m=class extends a.a.Component{constructor(e){super(e),x()(this,"state",{phase:1,email:"",password:"",password2:"",errorText:null,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""}),x()(this,"onVerify",async e=>{if(e.preventDefault(),this.reset)try{await this.reset.checkEmailLinkClicked(),this.setState({phase:4})}catch(e){this.showErrorDialog(e.message)}else console.error("onVerify called before submitPasswordReset!")}),x()(this,"onSubmitForm",async e=>{if(e.preventDefault(),await this._checkServerLiveliness(this.props.serverConfig),await this.password_field.validate({allowEmpty:!1}),this.state.email)if(this.state.password&&this.state.password2)if(this.state.passwordFieldValid)if(this.state.password!==this.state.password2)this.showErrorDialog(Object(c.a)("New passwords must match each other."));else{const e=d.getComponent("dialogs.QuestionDialog");Le.a.createTrackedDialog("Forgot Password Warning","",e,{title:Object(c.a)("Warning!"),description:a.a.createElement("div",null,Object(c.a)("Changing your password will reset any end-to-end encryption keys on all of your sessions, making encrypted chat history unreadable. Set up Key Backup or export your room keys from another session before resetting your password.")),button:Object(c.a)("Continue"),onFinished:e=>{e&&this.submitPasswordReset(this.state.email,this.state.password)}})}else this.showErrorDialog(Object(c.a)("Please choose a strong password"));else this.showErrorDialog(Object(c.a)("A new password must be entered."));else this.showErrorDialog(Object(c.a)("The email address linked to your account must be entered."))}),x()(this,"onInputChanged",(e,t)=>{this.setState({[e]:t.target.value})}),x()(this,"onLoginClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()}),E.a.instance.track("onboarding_forgot_password_begin")}componentDidMount(){this.reset=null,this._checkServerLiveliness(this.props.serverConfig)}UNSAFE_componentWillReceiveProps(e){e.serverConfig.hsUrl===this.props.serverConfig.hsUrl&&e.serverConfig.isUrl===this.props.serverConfig.isUrl||this._checkServerLiveliness(e.serverConfig)}async _checkServerLiveliness(e){try{await Hn.b.validateServerConfigWithStaticUrls(e.hsUrl,e.isUrl),this.setState({serverIsAlive:!0})}catch(e){this.setState(Hn.b.authComponentStateForError(e,"forgot_password"))}}submitPasswordReset(e,t){this.setState({phase:2}),this.reset=new qm(this.props.serverConfig.hsUrl,this.props.serverConfig.isUrl),this.reset.resetPassword(e,t).then(()=>{this.setState({phase:3})},e=>{this.showErrorDialog(Object(c.a)("Failed to send email")+": "+e.message),this.setState({phase:1})})}showErrorDialog(e,t){const s=d.getComponent("dialogs.ErrorDialog");Le.a.createTrackedDialog("Forgot Password Error","",s,{title:t,description:e})}onPasswordValidate(e){this.setState({passwordFieldValid:e.valid})}renderForgot(){const e=d.getComponent("elements.Field");let t=null;const s=this.state.errorText;let n;if(s&&(t=a.a.createElement("div",{className:"mx_Login_error"},s)),!this.state.serverIsAlive){const e=M()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});n=a.a.createElement("div",{className:e},this.state.serverDeadError)}return a.a.createElement("div",null,t,n,a.a.createElement(yi,{serverConfig:this.props.serverConfig,onServerConfigChange:this.props.onServerConfigChange}),a.a.createElement("form",{onSubmit:this.onSubmitForm},a.a.createElement("div",{className:"mx_AuthBody_fieldRow"},a.a.createElement(e,{name:"reset_email",type:"text",label:Object(c.a)("Email"),value:this.state.email,onChange:this.onInputChanged.bind(this,"email"),autoFocus:!0,onFocus:()=>E.a.instance.track("onboarding_forgot_password_email_focus"),onBlur:()=>E.a.instance.track("onboarding_forgot_password_email_blur")})),a.a.createElement("div",{className:"mx_AuthBody_fieldRow"},a.a.createElement(Li.a,{name:"reset_password",type:"password",label:Object(c.b)("New Password"),value:this.state.password,minScore:3,onChange:this.onInputChanged.bind(this,"password"),fieldRef:e=>this.password_field=e,onValidate:e=>this.onPasswordValidate(e),onFocus:()=>E.a.instance.track("onboarding_forgot_password_newPassword_focus"),onBlur:()=>E.a.instance.track("onboarding_forgot_password_newPassword_blur"),autoComplete:"new-password"}),a.a.createElement(e,{name:"reset_password_confirm",type:"password",label:Object(c.a)("Confirm"),value:this.state.password2,onChange:this.onInputChanged.bind(this,"password2"),onFocus:()=>E.a.instance.track("onboarding_forgot_password_newPassword2_focus"),onBlur:()=>E.a.instance.track("onboarding_forgot_password_newPassword2_blur"),autoComplete:"new-password"})),a.a.createElement("span",null,Object(c.a)("A verification email will be sent to your inbox to confirm setting your new password.")),a.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(c.a)("Send Reset Email")})),a.a.createElement("a",{className:"mx_AuthBody_changeFlow",onClick:this.onLoginClick,href:"#"},Object(c.a)("Sign in instead")))}renderSendingEmail(){const e=d.getComponent("elements.Spinner");return a.a.createElement(e,null)}renderEmailSent(){return a.a.createElement("div",null,Object(c.a)("An email has been sent to %(emailAddress)s. Once you've followed the link it contains, click below.",{emailAddress:this.state.email}),a.a.createElement("br",null),a.a.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.onVerify,value:Object(c.a)("I have verified my email address")}))}renderDone(){return a.a.createElement("div",null,a.a.createElement("p",null,Object(c.a)("Your password has been reset.")),a.a.createElement("p",null,Object(c.a)("You have been logged out of all sessions and will no longer receive push notifications. To re-enable notifications, sign in again on each device.")),a.a.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.props.onComplete,value:Object(c.a)("Return to login screen")}))}render(){const e=d.getComponent("auth.AuthHeader"),t=d.getComponent("auth.AuthBody");let s;switch(this.state.phase){case 1:s=this.renderForgot();break;case 2:s=this.renderSendingEmail();break;case 3:s=this.renderEmailSent();break;case 4:s=this.renderDone()}return a.a.createElement($n,null,a.a.createElement(e,null),a.a.createElement(t,null,a.a.createElement("h2",null," ",Object(c.a)("Set a new password")," "),s))}},x()($m,"propTypes",{serverConfig:wt.a.instanceOf(Hn.a).isRequired,onServerConfigChange:wt.a.func.isRequired,onLoginClick:wt.a.func,onComplete:wt.a.func.isRequired}),Hm=zm))||Hm;var Jm;let Qm=Object(P.a)("views.auth.AuthBody")(Jm=class extends a.a.PureComponent{render(){return a.a.createElement("div",{className:"mx_AuthBody"},this.props.children)}})||Jm;var Xm;let Zm=Object(P.a)("views.auth.AuthFooter")(Xm=class extends a.a.Component{render(){return a.a.createElement("div",{className:"mx_AuthFooter"},a.a.createElement("a",{href:"https://matrix.org",target:"_blank",rel:"noreferrer noopener"},Object(c.a)("powered by Matrix")))}})||Xm;var ep,tp,sp;let np=Object(P.a)("views.auth.AuthHeader")((sp=tp=class extends a.a.Component{render(){const e=d.getComponent("auth.AuthHeaderLogo"),t=d.getComponent("views.auth.LanguageSelector");return a.a.createElement("div",{className:"mx_AuthHeader"},a.a.createElement(e,null),a.a.createElement(t,{disabled:this.props.disableLanguageSelector}))}},x()(tp,"propTypes",{disableLanguageSelector:wt.a.bool}),ep=sp))||ep;var ip;let op=Object(P.a)("views.auth.AuthHeaderLogo")(ip=class extends a.a.PureComponent{render(){return a.a.createElement("div",{className:"mx_AuthHeaderLogo"},"Matrix")}})||ip;var ap,rp=s(1288);function cp(e){Object(c.d)()!==e&&(V.b.setValue("language",null,Ye.a.DEVICE,e),Xt.a.get().reload())}function lp({disabled:e}){if(l.a.get().disable_login_language_selector)return a.a.createElement("div",null);const t=d.getComponent("views.elements.LanguageDropdown");return a.a.createElement(t,{className:"mx_AuthBody_language",onOptionChange:cp,value:Object(c.d)(),disabled:e})}Object(c.b)("Sign in with SSO");let dp=Object(P.a)("views.auth.Welcome")(ap=class extends a.a.PureComponent{constructor(e){super(e),E.a.instance.track("onboarding_welcome")}render(){const e=d.getComponent("structures.EmbeddedPage"),t=d.getComponent("auth.LanguageSelector"),s=l.a.get().embeddedPages;let n=null;return s&&(n=s.welcomeUrl),n||(n="welcome.html"),a.a.createElement($n,null,a.a.createElement("div",{className:M()("mx_Welcome",{mx_WelcomePage_registrationDisabled:!V.b.getValue(nt.a.Registration)})},a.a.createElement(e,{className:"mx_WelcomePage",url:n,replaceMap:{"$riot:ssoUrl":"#/start_sso","$riot:casUrl":"#/start_cas"}}),a.a.createElement(t,null)))}})||ap;var up,hp,mp;let pp=Object(P.a)("views.context_menus.StatusMessageContextMenu")((mp=hp=class extends a.a.Component{constructor(e){super(e),x()(this,"_onStatusMessageCommitted",()=>{this.setState({message:this.comittedStatusMessage,waiting:!1})}),x()(this,"_onClearClick",e=>{le.a.get()._unstable_setStatusMessage(""),this.setState({waiting:!0})}),x()(this,"_onSubmit",e=>{e.preventDefault(),le.a.get()._unstable_setStatusMessage(this.state.message),this.setState({waiting:!0})}),x()(this,"_onStatusChange",e=>{this.setState({message:e.target.value})}),this.state={message:this.comittedStatusMessage}}componentDidMount(){const{user:e}=this.props;e&&e.on("User._unstable_statusMessage",this._onStatusMessageCommitted)}componentWillUnmount(){const{user:e}=this.props;e&&e.removeListener("User._unstable_statusMessage",this._onStatusMessageCommitted)}get comittedStatusMessage(){return this.props.user?this.props.user._unstable_statusMessage:""}render(){const e=d.getComponent("views.elements.Spinner");let t;t=this.comittedStatusMessage?this.state.message===this.comittedStatusMessage?a.a.createElement(g.a,{className:"mx_StatusMessageContextMenu_clear",onClick:this._onClearClick},a.a.createElement("span",null,Object(c.a)("Clear status"))):a.a.createElement(g.a,{className:"mx_StatusMessageContextMenu_submit",onClick:this._onSubmit},a.a.createElement("span",null,Object(c.a)("Update status"))):a.a.createElement(g.a,{className:"mx_StatusMessageContextMenu_submit",disabled:!this.state.message,onClick:this._onSubmit},a.a.createElement("span",null,Object(c.a)("Set status")));let s=null;this.state.waiting&&(s=a.a.createElement(e,{w:"24",h:"24"}));const n=a.a.createElement("form",{className:"mx_StatusMessageContextMenu_form",autoComplete:"off",onSubmit:this._onSubmit},a.a.createElement("input",{type:"text",className:"mx_StatusMessageContextMenu_message",key:"message",placeholder:Object(c.a)("Set a new status..."),autoFocus:!0,maxLength:"60",value:this.state.message,onChange:this._onStatusChange}),a.a.createElement("div",{className:"mx_StatusMessageContextMenu_actionContainer"},t,s));return a.a.createElement("div",{className:"mx_StatusMessageContextMenu"},n)}},x()(hp,"propTypes",{user:wt.a.object}),up=mp))||up;var gp,vp,fp;let bp=Object(P.a)("views.avatars.MemberStatusMessageAvatar")((fp=vp=class extends a.a.Component{constructor(e){super(e),x()(this,"_onStatusMessageCommitted",()=>{this.setState({hasStatus:this.hasStatus})}),x()(this,"openMenu",()=>{this.setState({menuDisplayed:!0})}),x()(this,"closeMenu",()=>{this.setState({menuDisplayed:!1})}),this.state={hasStatus:this.hasStatus,menuDisplayed:!1},this._button=Object(o.createRef)()}componentDidMount(){if(this.props.member.userId!==le.a.get().getUserId())throw new Error("Cannot use MemberStatusMessageAvatar on anyone but the logged in user");if(!V.b.getValue("feature_custom_status"))return;const{user:e}=this.props.member;e&&e.on("User._unstable_statusMessage",this._onStatusMessageCommitted)}componentWillUnmount(){const{user:e}=this.props.member;e&&e.removeListener("User._unstable_statusMessage",this._onStatusMessageCommitted)}get hasStatus(){const{user:e}=this.props.member;return!!e&&!!e._unstable_statusMessage}render(){const e=a.a.createElement(Yi.a,{member:this.props.member,width:this.props.width,height:this.props.height,resizeMethod:this.props.resizeMethod});if(!V.b.getValue("feature_custom_status"))return e;const t=M()({mx_MemberStatusMessageAvatar:!0,mx_MemberStatusMessageAvatar_hasStatus:this.state.hasStatus});let s;if(this.state.menuDisplayed){const e=this._button.current.getBoundingClientRect(),t=16,n=1;s=a.a.createElement(i.b,{chevronOffset:(e.width-t)/2,chevronFace:"bottom",left:e.left+window.pageXOffset,top:e.top+window.pageYOffset-n,menuWidth:226,onFinished:this.closeMenu},a.a.createElement(pp,{user:this.props.member.user,onFinished:this.closeMenu}))}return a.a.createElement(a.a.Fragment,null,a.a.createElement(i.c,{className:t,inputRef:this._button,onClick:this.openMenu,isExpanded:this.state.menuDisplayed,label:Object(c.a)("User Status")},e),s)}},x()(vp,"propTypes",{member:wt.a.object.isRequired,width:wt.a.number,height:wt.a.number,resizeMethod:wt.a.string}),x()(vp,"defaultProps",{width:40,height:40,resizeMethod:"crop"}),gp=fp))||gp;var yp,_p,Ep;let Sp=Object(P.a)("views.context_menus.GenericElementContextMenu")((Ep=_p=class extends a.a.Component{constructor(e){super(e),this.resize=this.resize.bind(this)}componentDidMount(){this.resize=this.resize.bind(this),window.addEventListener("resize",this.resize)}componentWillUnmount(){window.removeEventListener("resize",this.resize)}resize(){this.props.onResize&&this.props.onResize()}render(){return a.a.createElement("div",null,this.props.element)}},x()(_p,"propTypes",{element:wt.a.element.isRequired,onResize:wt.a.func}),yp=Ep))||yp;var wp,Cp,kp,Op=s(677);let Rp=Object(P.a)("views.context_menus.GroupInviteTileContextMenu")((kp=Cp=class extends a.a.Component{constructor(e){super(e),this._onClickReject=this._onClickReject.bind(this)}componentDidMount(){this._unmounted=!1}componentWillUnmount(){this._unmounted=!0}_onClickReject(){const e=d.getComponent("dialogs.QuestionDialog");Le.a.createTrackedDialog("Reject community invite","",e,{title:Object(c.a)("Reject invitation"),description:Object(c.a)("Are you sure you want to reject the invitation?"),onFinished:async e=>{if(!e)return;const t=d.getComponent("elements.Spinner"),s=Le.a.createDialog(t,null,"mx_Dialog_spinner");try{await wn.a.leaveGroup(this.props.group.groupId)}catch(e){console.error("Error rejecting community invite: ",e);const t=d.getComponent("dialogs.ErrorDialog");Le.a.createTrackedDialog("Error rejecting invite","",t,{title:Object(c.a)("Error"),description:Object(c.a)("Unable to reject invite")})}finally{s.close()}}}),this.props.onFinished&&this.props.onFinished()}render(){return a.a.createElement("div",null,a.a.createElement(i.f,{className:"mx_RoomTileContextMenu_leave",onClick:this._onClickReject},a.a.createElement("img",{className:"mx_RoomTileContextMenu_tag_icon",src:s(1289),width:"15",height:"15",alt:""}),Object(c.a)("Reject")))}},x()(Cp,"propTypes",{group:wt.a.instanceOf(qh.a).isRequired,onFinished:wt.a.func}),wp=kp))||wp;var Ip,xp,Tp,jp=s(406),Np=s(355);class Pp{static moveTag(e,t,s){let n=U.a.getOrderedTags(),i=U.a.getRemovedTagsAccountData()||[];if(!n)return;n=n.filter(e=>e!==t),n=[...n.slice(0,s),t,...n.slice(s)],i=i.filter(e=>e!==t);const o=U.a.getStoreId();return Object(L.a)("TagOrderActions.moveTag",()=>(_.a.trackEvent("TagOrderActions","commitTagOrdering"),e.setAccountData("im.vector.web.tag_ordering",{tags:n,removedTags:i,_storeId:o})),()=>({tags:n,removedTags:i}))}static removeTag(e,t){const s=U.a.getOrderedTags(),n=U.a.getRemovedTagsAccountData()||[];if(n.includes(t))return new Np.a(()=>{});n.push(t);const i=U.a.getStoreId();return Object(L.a)("TagOrderActions.removeTag",()=>(_.a.trackEvent("TagOrderActions","removeTag"),e.setAccountData("im.vector.web.tag_ordering",{tags:s,removedTags:n,_storeId:i})),()=>({removedTags:n}))}}let Dp=Object(P.a)("views.context_menus.TagTileContextMenu")((Tp=xp=class extends a.a.Component{constructor(...e){super(...e),x()(this,"_onViewCommunityClick",()=>{u.a.dispatch({action:"view_group",group_id:this.props.tag}),this.props.onFinished()}),x()(this,"_onRemoveClick",()=>{u.a.dispatch(Pp.removeTag(this.context,this.props.tag)),this.props.onFinished()}),x()(this,"_onMoveUp",()=>{u.a.dispatch(Pp.moveTag(this.context,this.props.tag,this.props.index-1)),this.props.onFinished()}),x()(this,"_onMoveDown",()=>{u.a.dispatch(Pp.moveTag(this.context,this.props.tag,this.props.index+1)),this.props.onFinished()})}render(){let e,t;return this.props.index>0&&(e=a.a.createElement(i.f,{className:"mx_TagTileContextMenu_item mx_TagTileContextMenu_moveUp",onClick:this._onMoveUp},Object(c.a)("Move up"))),this.props.index<(U.a.getOrderedTags()||[]).length-1&&(t=a.a.createElement(i.f,{className:"mx_TagTileContextMenu_item mx_TagTileContextMenu_moveDown",onClick:this._onMoveDown},Object(c.a)("Move down"))),a.a.createElement("div",null,a.a.createElement(i.f,{className:"mx_TagTileContextMenu_item mx_TagTileContextMenu_viewCommunity",onClick:this._onViewCommunityClick},Object(c.a)("View Community")),e||t?a.a.createElement("hr",{className:"mx_TagTileContextMenu_separator",role:"separator"}):null,e,t,a.a.createElement("hr",{className:"mx_TagTileContextMenu_separator",role:"separator"}),a.a.createElement(i.f,{className:"mx_TagTileContextMenu_item mx_TagTileContextMenu_hideCommunity",onClick:this._onRemoveClick},Object(c.a)("Unpin")))}},x()(xp,"propTypes",{tag:wt.a.string.isRequired,index:wt.a.number.isRequired,onFinished:wt.a.func.isRequired}),x()(xp,"contextType",b.a),Ip=Tp))||Ip;var Ap,Mp,Up;const Lp={"mx-user-id":Object(c.b)("Matrix ID"),"mx-room-id":Object(c.b)("Matrix Room ID"),email:Object(c.b)("email address")};let Fp=Object(P.a)("views.dialogs.AddressPickerDialog")((Up=Mp=class extends a.a.Component{constructor(e){super(e),x()(this,"onButtonClick",()=>{let e=this.state.selectedList.slice();""!==this._textinput.current.value&&(e=this._addAddressesToList([this._textinput.current.value]),null===e)||this.props.onFinished(!0,e)}),x()(this,"onCancel",()=>{this.props.onFinished(!1)}),x()(this,"onKeyDown",e=>{const t=this._textinput.current?this._textinput.current.value:void 0;e.key===gt.a.ESCAPE?(e.stopPropagation(),e.preventDefault(),this.props.onFinished(!1)):e.key===gt.a.ARROW_UP?(e.stopPropagation(),e.preventDefault(),this.addressSelector&&this.addressSelector.moveSelectionUp()):e.key===gt.a.ARROW_DOWN?(e.stopPropagation(),e.preventDefault(),this.addressSelector&&this.addressSelector.moveSelectionDown()):this.state.suggestedList.length>0&&[gt.a.COMMA,gt.a.ENTER,gt.a.TAB].includes(e.key)?(e.stopPropagation(),e.preventDefault(),this.addressSelector&&this.addressSelector.chooseSelection()):0===t.length&&this.state.selectedList.length&&e.key===gt.a.BACKSPACE?(e.stopPropagation(),e.preventDefault(),this.onDismissed(this.state.selectedList.length-1)()):e.key===gt.a.ENTER?(e.stopPropagation(),e.preventDefault(),""===t?this.onButtonClick():this._addAddressesToList([t])):!t||e.key!==gt.a.COMMA&&e.key!==gt.a.TAB||(e.stopPropagation(),e.preventDefault(),this._addAddressesToList([t]))}),x()(this,"onQueryChanged",e=>{const t=e.target.value;this.queryChangedDebouncer&&clearTimeout(this.queryChangedDebouncer),t.length>0&&"@"!==t&&t.length>=2?this.queryChangedDebouncer=setTimeout(()=>{"user"===this.props.pickerType?this.props.groupId?this._doNaiveGroupSearch(t):this.state.serverSupportsUserDirectory?this._doUserDirectorySearch(t):this._doLocalSearch(t):"room"===this.props.pickerType?this.props.groupId?this._doNaiveGroupRoomSearch(t):this._doRoomSearch(t):console.error("Unknown pickerType",this.props.pickerType)},200):this.setState({suggestedList:[],query:"",searchError:null})}),x()(this,"onDismissed",e=>()=>{const t=this.state.selectedList.slice();t.splice(e,1),this.setState({selectedList:t,suggestedList:[],query:""}),this._cancelThreepidLookup&&this._cancelThreepidLookup()}),x()(this,"onClick",e=>()=>{this.onSelected(e)}),x()(this,"onSelected",e=>{const t=this.state.selectedList.slice();t.push(this._getFilteredSuggestions()[e]),this.setState({selectedList:t,suggestedList:[],query:""}),this._cancelThreepidLookup&&this._cancelThreepidLookup()}),x()(this,"_onPaste",e=>{e.preventDefault();const t=e.clipboardData.getData("text");this._addAddressesToList(t.split(/[\s,]+/))}),x()(this,"onUseDefaultIdentityServerClick",e=>{e.preventDefault(),Object(yl.d)();const{validAddressTypes:t}=this.state;t.push("email"),this.setState({validAddressTypes:t})}),x()(this,"onManageSettingsClick",e=>{e.preventDefault(),u.a.fire(h.a.ViewUserSettings),this.onCancel()}),this._textinput=Object(o.createRef)();let t=this.props.validAddressTypes;!le.a.get().getIdentityServerUrl()&&t.includes("email")&&(t=t.filter(e=>"email"!==e)),this.state={invalidAddressError:!1,selectedList:[],busy:!1,searchError:null,serverSupportsUserDirectory:!0,query:"",suggestedList:[],validAddressTypes:t}}componentDidMount(){this.props.focus&&(this._textinput.current.value=this.props.value)}getPlaceholder(){const{placeholder:e}=this.props;return"string"==typeof e?e:e(this.state.validAddressTypes)}_doNaiveGroupSearch(e){const t=e.toLowerCase();this.setState({busy:!0,query:e,searchError:null}),le.a.get().getGroupUsers(this.props.groupId).then(s=>{const n=[];s.chunk.forEach(e=>{const s=e.user_id.toLowerCase().includes(t),i=(e.displayname||"").toLowerCase().includes(t);(s||i)&&n.push({user_id:e.user_id,avatar_url:e.avatar_url,display_name:e.displayname})}),this._processResults(n,e)}).catch(e=>{console.error("Error whilst searching group rooms: ",e),this.setState({searchError:e.errcode?e.message:Object(c.a)("Something went wrong!")})}).then(()=>{this.setState({busy:!1})})}_doNaiveGroupRoomSearch(e){const t=e.toLowerCase(),s=[];wn.a.getGroupRooms(this.props.groupId).forEach(e=>{const n=(e.name||"").toLowerCase().includes(t),i=(e.topic||"").toLowerCase().includes(t),o=(e.canonical_alias||"").toLowerCase().includes(t);(n||i||o)&&s.push({room_id:e.room_id,avatar_url:e.avatar_url,name:e.name||e.canonical_alias})}),this._processResults(s,e),this.setState({busy:!1})}_doRoomSearch(e){const t=e.toLowerCase(),s=le.a.get().getRooms(),n=[];s.forEach(e=>{let s=1/0;const i=e.currentState.getStateEvents("m.room.name",""),o=i?i.getContent().name:"",a=e.getCanonicalAlias(),r=e.currentState.getStateEvents("m.room.aliases").map(e=>e.getContent().aliases).reduce((e,t)=>e.concat(t),[]),l=(o||"").toLowerCase().includes(t);let d=!1,u=1/0;if(r.forEach(e=>{(e||"").toLowerCase().includes(t)&&(d=!0,u>e.length&&(u=e.length))}),!l&&!d)return;d&&(s=u);const h=e.currentState.getStateEvents("m.room.avatar",""),m=h?h.getContent().url:void 0;n.push({rank:s,room_id:e.roomId,avatar_url:m,name:o||a||r[0]||Object(c.a)("Unnamed Room")})});const i=n.sort((e,t)=>e.rank-t.rank);this._processResults(i,e),this.setState({busy:!1})}_doUserDirectorySearch(e){this.setState({busy:!0,query:e,searchError:null}),le.a.get().searchUserDirectory({term:e}).then(t=>{this.state.query===e&&this._processResults(t.results,e)}).catch(t=>{console.error("Error whilst searching user directory: ",t),this.setState({searchError:t.errcode?t.message:Object(c.a)("Something went wrong!")}),"M_UNRECOGNIZED"===t.errcode&&(this.setState({serverSupportsUserDirectory:!1}),this._doLocalSearch(e))}).then(()=>{this.setState({busy:!1})})}_doLocalSearch(e){this.setState({query:e,searchError:null});const t=e.toLowerCase(),s=[];le.a.get().getUsers().forEach(e=>{-1===e.userId.toLowerCase().indexOf(t)&&-1===e.displayName.toLowerCase().indexOf(t)||s.push({user_id:e.userId,display_name:e.displayName,avatar_url:e.avatarUrl})}),this._processResults(s,e)}_processResults(e,t){const s=[];e.forEach(e=>{if(e.room_id){const t=le.a.get(),n=t.getRoom(e.room_id);if(n){const e=n.currentState.getStateEvents("m.room.tombstone","");if(e&&e.getContent()&&e.getContent().replacement_room){if(t.getRoom(e.getContent().replacement_room))return}}s.push({addressType:"mx-room-id",address:e.room_id,displayName:e.name,avatarMxc:e.avatar_url,isKnown:!0})}else(this.props.includeSelf||e.user_id!==le.a.get().credentials.userId)&&s.push({addressType:"mx-user-id",address:e.user_id,displayName:e.display_name,avatarMxc:e.avatar_url,isKnown:!0})});const n=Object(fl.d)(t);if(this.state.validAddressTypes.includes(n)){if("email"===n&&!zn.a(t))return void this.setState({searchError:Object(c.a)("That doesn't look like a valid email address")});s.unshift({addressType:n,address:t,isKnown:!1}),this._cancelThreepidLookup&&this._cancelThreepidLookup(),"email"===n&&this._lookupThreepid(n,t)}this.setState({suggestedList:s,invalidAddressError:!1},()=>{this.addressSelector&&this.addressSelector.moveSelectionTop()})}_addAddressesToList(e){const t=this.state.selectedList.slice();let s=!1;return e.forEach(e=>{e=e.trim();const n=Object(fl.d)(e),i={addressType:n,address:e,isKnown:!1};if(this.state.validAddressTypes.includes(n)){if("mx-user-id"===n){const e=le.a.get().getUser(i.address);e&&(i.displayName=e.displayName,i.avatarMxc=e.avatarUrl,i.isKnown=!0)}else if("mx-room-id"===n){const e=le.a.get().getRoom(i.address);e&&(i.displayName=e.name,i.avatarMxc=e.avatarUrl,i.isKnown=!0)}}else s=!0;t.push(i)}),this.setState({selectedList:t,suggestedList:[],query:"",invalidAddressError:!!s||this.state.invalidAddressError}),this._cancelThreepidLookup&&this._cancelThreepidLookup(),s?null:t}async _lookupThreepid(e,t){let s=!1;if(this._cancelThreepidLookup=function(){s=!0},await Object(td.c)(500),s)return null;try{const n=new dh.a,i=await n.getAccessToken();if(s)return null;const o=await le.a.get().lookupThreePid(e,t,void 0,i);if(s||null===o||!o.mxid)return null;const a=await le.a.get().getProfileInfo(o.mxid);if(s||null===a)return null;this.setState({suggestedList:[{addressType:e,address:t,displayName:a.displayname,avatarMxc:a.avatar_url,isKnown:!0}]})}catch(e){console.error(e),this.setState({searchError:Object(c.a)("Something went wrong!")})}}_getFilteredSuggestions(){const e={};return this.state.selectedList.forEach(({address:t,addressType:s})=>{e[s]||(e[s]=new Set),e[s].add(t)}),this.state.suggestedList.filter(({address:t,addressType:s})=>!(e[s]&&e[s].has(t)))}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=d.getComponent("elements.AddressSelector");let n;this.scrollElement=null,this.props.description&&(n=a.a.createElement("div",{className:"mx_AddressPickerDialog_label"},a.a.createElement("label",{htmlFor:"textinput"},this.props.description)));const i=[];if(this.state.selectedList.length>0){const e=d.getComponent("elements.AddressTile");for(let t=0;t<this.state.selectedList.length;t++)i.push(a.a.createElement(e,{key:t,address:this.state.selectedList[t],canDismiss:!0,onDismissed:this.onDismissed(t),showAddress:"user"===this.props.pickerType}))}i.push(a.a.createElement("textarea",{key:this.state.selectedList.length,onPaste:this._onPaste,rows:"1",id:"textinput",ref:this._textinput,className:"mx_AddressPickerDialog_input",onChange:this.onQueryChanged,placeholder:this.getPlaceholder(),defaultValue:this.props.value,autoFocus:this.props.focus}));const o=this._getFilteredSuggestions();let r,l,u;if(this.state.invalidAddressError){const e=this.state.validAddressTypes.map(e=>Object(c.a)(Lp[e]));r=a.a.createElement("div",{className:"mx_AddressPickerDialog_error"},Object(c.a)("You have entered an invalid address."),a.a.createElement("br",null),Object(c.a)("Try using one of the following valid address types: %(validTypesList)s.",{validTypesList:e.join(", ")}))}else this.state.searchError?r=a.a.createElement("div",{className:"mx_AddressPickerDialog_error"},this.state.searchError):this.state.query.length>0&&0===o.length&&!this.state.busy?r=a.a.createElement("div",{className:"mx_AddressPickerDialog_error"},Object(c.a)("No results")):l=a.a.createElement(s,{ref:e=>{this.addressSelector=e},addressList:o,showAddress:"user"===this.props.pickerType,onSelected:this.onSelected,truncateAt:40});if("user"===this.props.pickerType&&!this.state.validAddressTypes.includes("email")&&this.props.validAddressTypes.includes("email")){const e=Object(yl.c)();u=e?a.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(c.a)("Use an identity server to invite by email. <default>Use the default (%(defaultIdentityServerName)s)</default> or manage in <settings>Settings</settings>.",{defaultIdentityServerName:Object(bl.a)(e)},{default:e=>a.a.createElement("a",{href:"#",onClick:this.onUseDefaultIdentityServerClick},e),settings:e=>a.a.createElement("a",{href:"#",onClick:this.onManageSettingsClick},e)})):a.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(c.a)("Use an identity server to invite by email. Manage in <settings>Settings</settings>.",{},{settings:e=>a.a.createElement("a",{href:"#",onClick:this.onManageSettingsClick},e)}))}return a.a.createElement(e,{className:"mx_AddressPickerDialog",onKeyDown:this.onKeyDown,onFinished:this.props.onFinished,title:this.props.title},n,a.a.createElement("div",{className:"mx_Dialog_content"},a.a.createElement("div",{className:"mx_AddressPickerDialog_inputContainer"},i),r,l,this.props.extraNode,u),a.a.createElement(t,{primaryButton:this.props.button,onPrimaryButtonClick:this.onButtonClick,onCancel:this.onCancel}))}},x()(Mp,"propTypes",{title:wt.a.string.isRequired,description:wt.a.node,extraNode:wt.a.node,value:wt.a.string,placeholder:wt.a.oneOfType([wt.a.string,wt.a.func]),roomId:wt.a.string,button:wt.a.string,focus:wt.a.bool,validAddressTypes:wt.a.arrayOf(wt.a.oneOf(fl.c)),onFinished:wt.a.func.isRequired,groupId:wt.a.string,pickerType:wt.a.oneOf(["user","room"]),includeSelf:wt.a.bool}),x()(Mp,"defaultProps",{value:"",focus:!0,validAddressTypes:fl.c,pickerType:"user",includeSelf:!1}),Ap=Up))||Ap;var Bp,Vp,Kp;let Wp=Object(P.a)("views.dialogs.IncomingSasDialog")((Kp=Vp=class extends a.a.Component{constructor(e){super(e),x()(this,"_onFinished",()=>{this.props.onFinished(3===this.state.phase)}),x()(this,"_onCancelClick",()=>{this.props.onFinished(3===this.state.phase)}),x()(this,"_onContinueClick",()=>{this.setState({phase:2}),this.props.verifier.verify().then(()=>{this.setState({phase:3})}).catch(e=>{console.log("Verification failed",e)})}),x()(this,"_onVerifierShowSas",e=>{this._showSasEvent=e,this.setState({phase:1,sas:e.sas})}),x()(this,"_onVerifierCancel",e=>{this.setState({phase:4})}),x()(this,"_onSasMatchesClick",()=>{this._showSasEvent.confirm(),this.setState({phase:2})}),x()(this,"_onVerifiedDoneClick",()=>{this.props.onFinished(!0)});let t=0;this.props.verifier.cancelled&&(console.log("Verifier was cancelled in the background."),t=4),this._showSasEvent=null,this.state={phase:t,sasVerified:!1,opponentProfile:null,opponentProfileError:null},this.props.verifier.on("show_sas",this._onVerifierShowSas),this.props.verifier.on("cancel",this._onVerifierCancel),this._fetchOpponentProfile()}componentWillUnmount(){4!==this.state.phase&&3!==this.state.phase&&this.props.verifier.cancel("User cancel"),this.props.verifier.removeListener("show_sas",this._onVerifierShowSas)}async _fetchOpponentProfile(){try{const e=await le.a.get().getProfileInfo(this.props.verifier.userId);this.setState({opponentProfile:e})}catch(e){this.setState({opponentProfileError:e})}}_renderPhaseStart(){const e=d.getComponent("views.elements.DialogButtons"),t=d.getComponent("views.elements.Spinner"),s=d.getComponent("avatars.BaseAvatar"),n=this.props.verifier.userId===le.a.get().getUserId();let i;const o=this.state.opponentProfile;if(o){const e=o.avatar_url?Object(pe.b)(o.avatar_url).getSquareThumbnailHttp(48):null;i=a.a.createElement("div",{className:"mx_IncomingSasDialog_opponentProfile"},a.a.createElement(s,{name:o.displayname,idName:this.props.verifier.userId,url:e,width:48,height:48,resizeMethod:"crop"}),a.a.createElement("h2",null,o.displayname))}else i=this.state.opponentProfileError?a.a.createElement("div",null,a.a.createElement(s,{name:this.props.verifier.userId.slice(1),idName:this.props.verifier.userId,width:48,height:48}),a.a.createElement("h2",null,this.props.verifier.userId)):a.a.createElement(t,null);const r=[a.a.createElement("p",{key:"p1"},Object(c.a)("Verify this user to mark them as trusted. Trusting users gives you extra peace of mind when using end-to-end encrypted messages.")),a.a.createElement("p",{key:"p2"},Object(c.a)("Verifying this user will mark their session as trusted, and also mark your session as trusted to them."))],l=[a.a.createElement("p",{key:"p1"},Object(c.a)("Verify this device to mark it as trusted. Trusting this device gives you and other users extra peace of mind when using end-to-end encrypted messages.")),a.a.createElement("p",{key:"p2"},Object(c.a)("Verifying this device will mark it as trusted, and users who have verified with you will trust this device."))];return a.a.createElement("div",null,i,n?l:r,a.a.createElement(e,{primaryButton:Object(c.a)("Continue"),hasCancel:!0,onPrimaryButtonClick:this._onContinueClick,onCancel:this._onCancelClick}))}_renderPhaseShowSas(){const e=d.getComponent("views.verification.VerificationShowSas");return a.a.createElement(e,{sas:this._showSasEvent.sas,onCancel:this._onCancelClick,onDone:this._onSasMatchesClick,isSelf:this.props.verifier.userId===le.a.get().getUserId(),inDialog:!0})}_renderPhaseWaitForPartnerToConfirm(){const e=d.getComponent("views.elements.Spinner");return a.a.createElement("div",null,a.a.createElement(e,null),a.a.createElement("p",null,Object(c.a)("Waiting for partner to confirm...")))}_renderPhaseVerified(){const e=d.getComponent("views.verification.VerificationComplete");return a.a.createElement(e,{onDone:this._onVerifiedDoneClick})}_renderPhaseCancelled(){const e=d.getComponent("views.verification.VerificationCancelled");return a.a.createElement(e,{onDone:this._onCancelClick})}render(){let e;switch(this.state.phase){case 0:e=this._renderPhaseStart();break;case 1:e=this._renderPhaseShowSas();break;case 2:e=this._renderPhaseWaitForPartnerToConfirm();break;case 3:e=this._renderPhaseVerified();break;case 4:e=this._renderPhaseCancelled()}const t=d.getComponent("dialogs.BaseDialog");return a.a.createElement(t,{title:Object(c.a)("Incoming Verification Request"),onFinished:this._onFinished,fixedWidth:!1},e)}},x()(Vp,"propTypes",{verifier:wt.a.object.isRequired}),Bp=Kp))||Bp;var Gp=s(571),qp=s(568);function Hp({failures:e,source:t,continuation:s,onFinished:n}){const i=d.getComponent("dialogs.BaseDialog"),r=d.getComponent("views.elements.DialogButtons"),u=d.getComponent("elements.Spinner"),[h,m]=Object(o.useState)(2),[p,g]=Object(o.useState)(!1),[v,f]=Object(o.useState)(!1),[b,y]=Object(o.useState)(!1),_=Object(o.useRef)(n),E=new Map([["_afterCrossSigningLocalKeyChange",Object(c.a)("a new master key signature")],["checkOwnCrossSigningTrust",Object(c.a)("a new cross-signing key signature")],["setDeviceVerification",Object(c.a)("a device cross-signing signature")]]),S=Object(c.a)("a key signature"),w=Object(o.useCallback)(async()=>{try{f(!0);const e=new Promise((e,t)=>{_.current=t}).finally(()=>{g(!0)});await Promise.race([s(),e]),y(!0)}catch(e){m(e=>e-1)}finally{_.current=n,f(!1)}},[s,n]);let C;if(!b&&!p&&s&&h>0){const s=E.get(t)||S,n=l.a.get().brand;C=a.a.createElement("div",null,a.a.createElement("p",null,Object(c.a)("%(brand)s encountered an error during upload of:",{brand:n})),a.a.createElement("p",null,s),v&&a.a.createElement(u,null),a.a.createElement("pre",null,JSON.stringify(e,null,2)),a.a.createElement(r,{primaryButton:"Retry",hasCancel:!0,onPrimaryButtonClick:w,onCancel:_.current,primaryDisabled:v}))}else C=a.a.createElement("div",null,b?a.a.createElement("span",null,Object(c.a)("Upload completed")):p?a.a.createElement("span",null,Object(c.a)("Cancelled signature upload")):a.a.createElement("span",null,Object(c.a)("Unable to upload")),a.a.createElement(r,{primaryButton:Object(c.a)("OK"),hasCancel:!1,onPrimaryButtonClick:n}));return a.a.createElement(i,{title:b?Object(c.a)("Signature upload success"):Object(c.a)("Signature upload failed"),fixedWidth:!1,onFinished:()=>{}},C)}var $p,zp,Yp,Jp=e=>{const t=l.a.get().brand,s=Object(c.a)("You've previously used %(brand)s on %(host)s with lazy loading of members enabled. In this version lazy loading is disabled. As the local cache is not compatible between these two settings, %(brand)s needs to resync your account.",{brand:t,host:e.host}),n=Object(c.a)("If the other version of %(brand)s is still open in another tab, please close it as using %(brand)s on the same host with both lazy loading enabled and disabled simultaneously will cause issues.",{brand:t});return a.a.createElement(Me.a,{hasCancelButton:!1,title:Object(c.a)("Incompatible local cache"),description:a.a.createElement("div",null,a.a.createElement("p",null,s),a.a.createElement("p",null,n)),button:Object(c.a)("Clear cache and resync"),onFinished:e.onFinished})},Qp=e=>{const t=l.a.get().brand,s=Object(c.a)("%(brand)s now uses 3-5x less memory, by only loading information about other users when needed. Please wait whilst we resynchronise with the server!",{brand:t});return a.a.createElement(Me.a,{hasCancelButton:!1,title:Object(c.a)("Updating %(brand)s",{brand:t}),description:a.a.createElement("div",null,s),button:Object(c.a)("OK"),onFinished:e.onFinished})};let Xp=Object(P.a)("views.dialogs.ManualDeviceKeyVerificationDialog")((Yp=zp=class extends a.a.Component{constructor(...e){super(...e),x()(this,"_onCancelClick",()=>{this.props.onFinished(!1)}),x()(this,"_onLegacyFinished",e=>{e&&le.a.get().setDeviceVerified(this.props.userId,this.props.device.deviceId,!0),this.props.onFinished(e)})}render(){const e=d.getComponent("dialogs.QuestionDialog");let t;t=le.a.get().getUserId()===this.props.userId?Object(c.a)("Confirm by comparing the following with the User Settings in your other session:"):Object(c.a)("Confirm this user's session by comparing the following with their User Settings:");const s=J.e(this.props.device.getFingerprint()),n=a.a.createElement("div",null,a.a.createElement("p",null,t),a.a.createElement("div",{className:"mx_DeviceVerifyDialog_cryptoSection"},a.a.createElement("ul",null,a.a.createElement("li",null,a.a.createElement("label",null,Object(c.a)("Session name"),":")," ",a.a.createElement("span",null,this.props.device.getDisplayName())),a.a.createElement("li",null,a.a.createElement("label",null,Object(c.a)("Session ID"),":")," ",a.a.createElement("span",null,a.a.createElement("code",null,this.props.device.deviceId))),a.a.createElement("li",null,a.a.createElement("label",null,Object(c.a)("Session key"),":")," ",a.a.createElement("span",null,a.a.createElement("code",null,a.a.createElement("b",null,s)))))),a.a.createElement("p",null,Object(c.a)("If they don't match, the security of your communication may be compromised.")));return a.a.createElement(e,{title:Object(c.a)("Verify session"),description:n,button:Object(c.a)("Verify session"),onFinished:this._onLegacyFinished})}},x()(zp,"propTypes",{userId:wt.a.string.isRequired,device:wt.a.object.isRequired,onFinished:wt.a.func.isRequired}),$p=Yp))||$p;var Zp,eg,tg;let sg=Object(P.a)("views.dialogs.MessageEditHistoryDialog")((tg=eg=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"loadMoreEdits",async e=>{if(e||!this.state.nextBatch&&!this.state.isLoading)return!1;const t={from:this.state.nextBatch},s=this.props.mxEvent.getRoomId(),n=this.props.mxEvent.getId(),i=le.a.get();let o,a,r;const c=new Promise((e,t)=>{a=e,r=t});try{o=await i.relations(s,n,"m.replace","m.room.message",t)}catch(e){return e.errcode&&console.error("fetching /relations failed with error",e),this.setState({error:e},()=>r(e)),c}const l=o.events;return this._locallyRedactEventsIfNeeded(l),this.setState({originalEvent:this.state.originalEvent||o.originalEvent,events:this.state.events.concat(l),nextBatch:o.nextBatch,isLoading:!1},()=>{const e=!!this.state.nextBatch;a(e)}),c}),this.state={originalEvent:null,error:null,events:[],nextBatch:null,isLoading:!0,isTwelveHour:V.b.getValue("showTwelveHourTimestamps")}}_locallyRedactEventsIfNeeded(e){const t=this.props.mxEvent.getRoomId(),s=le.a.get().getRoom(t).getPendingEvents();for(const t of e){const e=s.find(e=>"m.room.redaction"===e.getType()&&e.getAssociatedId()===t.getId());e&&t.markLocallyRedacted(e)}}componentDidMount(){this.loadMoreEdits()}_renderEdits(){const e=d.getComponent("messages.EditHistoryMessage"),t=d.getComponent("messages.DateSeparator"),s=[];let n,i=this.state.events;this.state.originalEvent&&!this.state.nextBatch&&(i=i.concat(this.state.originalEvent));const o=this.props.mxEvent.getId();return i.forEach((r,c)=>{n&&!Object(rm.f)(n.getDate(),r.getDate())||s.push(a.a.createElement("li",{key:r.getTs()+"~"},a.a.createElement(t,{ts:r.getTs()})));const l=r.getId()===o;s.push(a.a.createElement(e,{key:r.getId(),previousEdit:l?null:i[c+1],isBaseEvent:l,mxEvent:r,isTwelveHour:this.state.isTwelveHour})),n=r}),s}render(){let e;if(this.state.error){const{error:t}=this.state;e="M_UNRECOGNIZED"===t.errcode?a.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(c.a)("Your homeserver doesn't seem to support this feature.")):t.errcode?a.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(c.a)("Something went wrong!")):a.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(c.a)("Cannot reach homeserver"),a.a.createElement("br",null),Object(c.a)("Ensure you have a stable internet connection, or get in touch with the server admin"))}else if(this.state.isLoading){const t=d.getComponent("elements.Spinner");e=a.a.createElement(t,null)}else{const t=d.getComponent("structures.ScrollPanel");e=a.a.createElement(t,{className:"mx_MessageEditHistoryDialog_scrollPanel",onFillRequest:this.loadMoreEdits,stickyBottom:!1,startAtBottom:!1},a.a.createElement("ul",{className:"mx_MessageEditHistoryDialog_edits"},this._renderEdits()))}const t=d.getComponent("views.dialogs.BaseDialog");return a.a.createElement(t,{className:"mx_MessageEditHistoryDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Message edits")},e)}},x()(eg,"propTypes",{mxEvent:wt.a.object.isRequired}),Zp=tg))||Zp;var ng,ig,og,ag=s(431);let rg=Object(P.a)("views.dialogs.NewSessionReviewDialog")((og=ig=class extends a.a.PureComponent{constructor(...e){super(...e),x()(this,"onCancelClick",()=>{const e=d.getComponent("dialogs.ErrorDialog");Le.a.createTrackedDialog("Verification failed","insecure",e,{headerImage:s(425),title:Object(c.a)("Your account is not secure"),description:a.a.createElement("div",null,Object(c.a)("One of the following may be compromised:"),a.a.createElement("ul",null,a.a.createElement("li",null,Object(c.a)("Your password")),a.a.createElement("li",null,Object(c.a)("Your homeserver")),a.a.createElement("li",null,Object(c.a)("This session, or the other session")),a.a.createElement("li",null,Object(c.a)("The internet connection either session is using"))),a.a.createElement("div",null,Object(c.a)("We recommend you change your password and Security Key in Settings immediately"))),onFinished:()=>this.props.onFinished(!1)})}),x()(this,"onContinueClick",()=>{const{userId:e,device:t}=this.props,s=le.a.get(),n=s.requestVerification(e,[t.deviceId]);this.props.onFinished(!0),Le.a.createTrackedDialog("New Session Verification","Starting dialog",ag.a,{verificationRequestPromise:n,member:s.getUser(e),onFinished:async()=>{(await n).cancel()}})})}render(){const{device:e}=this.props,t=a.a.createElement("span",{className:"mx_NewSessionReviewDialog_headerIcon mx_E2EIcon_warning"}),s=Object(c.a)("New session"),n=a.a.createElement("h2",{className:"mx_NewSessionReviewDialog_header"},t,s);return a.a.createElement(Ze.a,{title:n,onFinished:this.props.onFinished},a.a.createElement("div",{className:"mx_NewSessionReviewDialog_body"},a.a.createElement("p",null,Object(c.a)("Use this session to verify your new one, granting it access to encrypted messages:")),a.a.createElement("div",{className:"mx_NewSessionReviewDialog_deviceInfo"},a.a.createElement("div",null,a.a.createElement("span",{className:"mx_NewSessionReviewDialog_deviceName"},e.getDisplayName())," ",a.a.createElement("span",{className:"mx_NewSessionReviewDialog_deviceID"},"(",e.deviceId,")"))),a.a.createElement("p",null,Object(c.a)("If you didn’t sign in to this session, your account may be compromised.")),a.a.createElement(Bi.a,{cancelButton:Object(c.a)("This wasn't me"),cancelButtonClass:"danger",primaryButton:Object(c.a)("Continue"),onCancel:this.onCancelClick,onPrimaryButtonClick:this.onContinueClick})))}},x()(ig,"propTypes",{userId:wt.a.string.isRequired,device:wt.a.object.isRequired,onFinished:wt.a.func.isRequired}),ng=og))||ng;var cg,lg,dg,ug=s(674);let hg=Object(P.a)("views.dialogs.RoomUpgradeWarningDialog")((dg=lg=class extends a.a.Component{constructor(e){super(e),x()(this,"_onContinue",()=>{this.props.onFinished({continue:!0,invite:this.state.isPrivate&&this.state.inviteUsersToNewRoom})}),x()(this,"_onCancel",()=>{this.props.onFinished({continue:!1,invite:!1})}),x()(this,"_onInviteUsersToggle",e=>{this.setState({inviteUsersToNewRoom:e})}),x()(this,"_openBugReportDialog",e=>{e.preventDefault(),e.stopPropagation();const t=d.getComponent("dialogs.BugReportDialog");Le.a.createTrackedDialog("Bug Report Dialog","",t,{})});const t=le.a.get().getRoom(this.props.roomId),s=t?t.currentState.getStateEvents("m.room.join_rules",""):null,n=!s||"public"!==s.getContent().join_rule;this.state={currentVersion:t?t.getVersion():"1",isPrivate:n,inviteUsersToNewRoom:!0}}render(){const e=l.a.get().brand,t=d.getComponent("views.dialogs.BaseDialog"),s=d.getComponent("views.elements.DialogButtons");let n=null;this.state.isPrivate&&(n=a.a.createElement(ja.a,{value:this.state.inviteUsersToNewRoom,onChange:this._onInviteUsersToggle,label:Object(c.a)("Automatically invite users")}));const i=this.state.isPrivate?Object(c.a)("Upgrade private room"):Object(c.a)("Upgrade public room");let o=a.a.createElement("p",null,Object(c.a)("This usually only affects how the room is processed on the server. If you're having problems with your %(brand)s, please report a bug.",{brand:e}));return l.a.get().bug_report_endpoint_url&&(o=a.a.createElement("p",null,Object(c.a)("This usually only affects how the room is processed on the server. If you're having problems with your %(brand)s, please <a>report a bug</a>.",{brand:e},{a:e=>a.a.createElement("a",{href:"#",onClick:this._openBugReportDialog},e)}))),a.a.createElement(t,{className:"mx_RoomUpgradeWarningDialog",hasCancel:!0,fixedWidth:!1,onFinished:this.props.onFinished,title:i},a.a.createElement("div",null,a.a.createElement("p",null,Object(c.a)("Upgrading a room is an advanced action and is usually recommended when a room is unstable due to bugs, missing features or security vulnerabilities.")),o,a.a.createElement("p",null,Object(c.a)("You'll upgrade this room from <oldVersion /> to <newVersion />.",{},{oldVersion:()=>a.a.createElement("code",null,this.state.currentVersion),newVersion:()=>a.a.createElement("code",null,this.props.targetVersion)})),n),a.a.createElement(s,{primaryButton:Object(c.a)("Upgrade"),onPrimaryButtonClick:this._onContinue,cancelButton:Object(c.a)("Cancel"),onCancel:this._onCancel}))}},x()(lg,"propTypes",{onFinished:wt.a.func.isRequired,roomId:wt.a.string.isRequired,targetVersion:wt.a.string.isRequired}),cg=dg))||cg;var mg,pg,gg;let vg=Object(P.a)("views.dialogs.SessionRestoreErrorDialog")((gg=pg=class extends a.a.Component{constructor(...e){super(...e),x()(this,"_sendBugReport",()=>{const e=d.getComponent("dialogs.BugReportDialog");Le.a.createTrackedDialog("Session Restore Error","Send Bug Report Dialog",e,{})}),x()(this,"_onClearStorageClick",()=>{const e=d.getComponent("dialogs.QuestionDialog");Le.a.createTrackedDialog("Session Restore Confirm Logout","",e,{title:Object(c.a)("Sign out"),description:a.a.createElement("div",null,Object(c.a)("Sign out and remove encryption keys?")),button:Object(c.a)("Sign out"),danger:!0,onFinished:this.props.onFinished})}),x()(this,"_onRefreshClick",()=>{window.location.reload(!0)})}render(){const e=l.a.get().brand,t=d.getComponent("views.dialogs.BaseDialog"),s=d.getComponent("views.elements.DialogButtons"),n=a.a.createElement("button",{onClick:this._onClearStorageClick,className:"danger"},Object(c.a)("Clear Storage and Sign Out"));let i;return i=l.a.get().bug_report_endpoint_url?a.a.createElement(s,{primaryButton:Object(c.a)("Send Logs"),onPrimaryButtonClick:this._sendBugReport,focus:!0,hasCancel:!1},n):a.a.createElement(s,{primaryButton:Object(c.a)("Refresh"),onPrimaryButtonClick:this._onRefreshClick,focus:!0,hasCancel:!1},n),a.a.createElement(t,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:Object(c.a)("Unable to restore session"),contentId:"mx_Dialog_content",hasCancel:!1},a.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},a.a.createElement("p",null,Object(c.a)("We encountered an error trying to restore your previous session.")),a.a.createElement("p",null,Object(c.a)("If you have previously used a more recent version of %(brand)s, your session may be incompatible with this version. Close this window and return to the more recent version.",{brand:e})),a.a.createElement("p",null,Object(c.a)("Clearing your browser's storage may fix the problem, but will sign you out and cause any encrypted chat history to become unreadable."))),i)}},x()(pg,"propTypes",{error:wt.a.string.isRequired,onFinished:wt.a.func.isRequired}),mg=gg))||mg;function fg(){return le.a.get().idBaseUrl.split("://")[1]}class bg{constructor(){x()(this,"_makeAddThreepidOnlyRequest",e=>le.a.get().addThreePidOnly({sid:this.sessionId,client_secret:this.clientSecret,auth:e})),this.clientSecret=le.a.get().generateClientSecret(),this.sessionId=null,this.submitUrl=null}addEmailAddress(e){return le.a.get().requestAdd3pidEmailToken(e,this.clientSecret,1).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(c.a)("This email address is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async bindEmailAddress(e){if(this.bind=!0,await le.a.get().doesServerSupportSeparateAddAndBind()){const t=new dh.a,s=await t.getAccessToken();return le.a.get().requestEmailToken(e,this.clientSecret,1,void 0,void 0,s).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(c.a)("This email address is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}return this.addEmailAddress(e)}addMsisdn(e,t){return le.a.get().requestAdd3pidMsisdnToken(e,t,this.clientSecret,1).then(e=>(this.sessionId=e.sid,this.submitUrl=e.submit_url,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(c.a)("This phone number is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async bindMsisdn(e,t){if(this.bind=!0,await le.a.get().doesServerSupportSeparateAddAndBind()){const s=new dh.a,n=await s.getAccessToken();return le.a.get().requestMsisdnToken(e,t,this.clientSecret,1,void 0,void 0,n).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(c.a)("This phone number is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}return this.addMsisdn(e,t)}async checkEmailLinkClicked(){try{if(await le.a.get().doesServerSupportSeparateAddAndBind())if(this.bind){const e=new dh.a,t=await e.getAccessToken();await le.a.get().bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:fg(),id_access_token:t})}else try{return void await this._makeAddThreepidOnlyRequest()}catch(e){if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t=d.getComponent("dialogs.InteractiveAuthDialog"),s={[Ui.c.PHASE_PREAUTH]:{title:Object(c.a)("Use Single Sign On to continue"),body:Object(c.a)("Confirm adding this email address by using Single Sign On to prove your identity."),continueText:Object(c.a)("Single Sign On"),continueKind:"primary"},[Ui.c.PHASE_POSTAUTH]:{title:Object(c.a)("Confirm adding email"),body:Object(c.a)("Click the button below to confirm adding this email address."),continueText:Object(c.a)("Confirm"),continueKind:"primary"}},{finished:n}=Le.a.createTrackedDialog("Add Email","",t,{title:Object(c.a)("Add Email Address"),matrixClient:le.a.get(),authData:e.data,makeRequest:this._makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[Ui.c.LOGIN_TYPE]:s,[Ui.c.UNSTABLE_LOGIN_TYPE]:s}});return n}else await le.a.get().addThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:fg()},this.bind)}catch(e){throw 401===e.httpStatus?e.message=Object(c.a)("Failed to verify email address: make sure you clicked the link in the email"):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}async haveMsisdnToken(e){const t=new dh.a,s=await le.a.get().doesServerSupportSeparateAddAndBind();let n;if(this.submitUrl)n=await le.a.get().submitMsisdnTokenOtherUrl(this.submitUrl,this.sessionId,this.clientSecret,e);else{if(!this.bind&&s)throw new Error("The add / bind with MSISDN flow is misconfigured");n=await le.a.get().submitMsisdnToken(this.sessionId,this.clientSecret,e,await t.getAccessToken())}if(n.errcode)throw n;if(s)if(this.bind)await le.a.get().bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:fg(),id_access_token:await t.getAccessToken()});else try{return void await this._makeAddThreepidOnlyRequest()}catch(e){if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t=d.getComponent("dialogs.InteractiveAuthDialog"),s={[Ui.c.PHASE_PREAUTH]:{title:Object(c.a)("Use Single Sign On to continue"),body:Object(c.a)("Confirm adding this phone number by using Single Sign On to prove your identity."),continueText:Object(c.a)("Single Sign On"),continueKind:"primary"},[Ui.c.PHASE_POSTAUTH]:{title:Object(c.a)("Confirm adding phone number"),body:Object(c.a)("Click the button below to confirm adding this phone number."),continueText:Object(c.a)("Confirm"),continueKind:"primary"}},{finished:n}=Le.a.createTrackedDialog("Add MSISDN","",t,{title:Object(c.a)("Add Phone Number"),matrixClient:le.a.get(),authData:e.data,makeRequest:this._makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[Ui.c.LOGIN_TYPE]:s,[Ui.c.UNSTABLE_LOGIN_TYPE]:s}});return n}else await le.a.get().addThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:fg()},this.bind)}}var yg,_g,Eg;let Sg=Object(P.a)("views.dialogs.SetEmailDialog")((Eg=_g=class extends a.a.Component{constructor(...e){super(...e),x()(this,"state",{emailAddress:"",emailBusy:!1}),x()(this,"onEmailAddressChanged",e=>{this.setState({emailAddress:e})}),x()(this,"onSubmit",()=>{const e=d.getComponent("dialogs.ErrorDialog"),t=d.getComponent("dialogs.QuestionDialog"),s=this.state.emailAddress;zn.a(s)?(this._addThreepid=new bg,this._addThreepid.addEmailAddress(s).then(()=>{Le.a.createTrackedDialog("Verification Pending","",t,{title:Object(c.a)("Verification Pending"),description:Object(c.a)("Please check your email and click on the link it contains. Once this is done, click continue."),button:Object(c.a)("Continue"),onFinished:this.onEmailDialogFinished})},t=>{this.setState({emailBusy:!1}),console.error("Unable to add email address "+s+" "+t),Le.a.createTrackedDialog("Unable to add email address","",e,{title:Object(c.a)("Unable to add email address"),description:t&&t.message?t.message:Object(c.a)("Operation failed")})}),this.setState({emailBusy:!0})):Le.a.createTrackedDialog("Invalid Email Address","",e,{title:Object(c.a)("Invalid Email Address"),description:Object(c.a)("This doesn't appear to be a valid email address")})}),x()(this,"onCancelled",()=>{this.props.onFinished(!1)}),x()(this,"onEmailDialogFinished",e=>{e?this.verifyEmailAddress():this.setState({emailBusy:!1})})}verifyEmailAddress(){this._addThreepid.checkEmailLinkClicked().then(()=>{this.props.onFinished(!0)},e=>{if(this.setState({emailBusy:!1}),"M_THREEPID_AUTH_FAILED"==e.errcode){const e=d.getComponent("dialogs.QuestionDialog"),t=Object(c.a)("Unable to verify email address.")+" "+Object(c.a)("Please check your email and click on the link it contains. Once this is done, click continue.");Le.a.createTrackedDialog("Verification Pending","3pid Auth Failed",e,{title:Object(c.a)("Verification Pending"),description:t,button:Object(c.a)("Continue"),onFinished:this.onEmailDialogFinished})}else{const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to verify email address: "+e),Le.a.createTrackedDialog("Unable to verify email address","",t,{title:Object(c.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(c.a)("Operation failed")})}})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("elements.Spinner"),s=d.getComponent("elements.EditableText"),n=this.state.emailBusy?a.a.createElement(t,null):a.a.createElement(s,{initialValue:this.state.emailAddress,className:"mx_SetEmailDialog_email_input",autoFocus:"true",placeholder:Object(c.a)("Email address"),placeholderClassName:"mx_SetEmailDialog_email_input_placeholder",blurToCancel:!1,onValueChanged:this.onEmailAddressChanged});return a.a.createElement(e,{className:"mx_SetEmailDialog",onFinished:this.onCancelled,title:this.props.title,contentId:"mx_Dialog_content"},a.a.createElement("div",{className:"mx_Dialog_content"},a.a.createElement("p",{id:"mx_Dialog_content"},Object(c.a)("This will allow you to reset your password and receive notifications.")),n),a.a.createElement("div",{className:"mx_Dialog_buttons"},a.a.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:Object(c.a)("Continue"),onClick:this.onSubmit}),a.a.createElement("input",{type:"submit",value:Object(c.a)("Skip"),onClick:this.onCancelled})))}},x()(_g,"propTypes",{onFinished:wt.a.func.isRequired}),yg=Eg))||yg;var wg,Cg,kg,Og=({onFinished:e})=>{const t=d.getComponent("dialogs.InfoDialog"),s={};Al.forEach(e=>{e.isEnabled()&&(s[e.category]||(s[e.category]=[]),s[e.category].push(e))});const n=Object.values(Tl).filter(e=>s[e]).map(e=>{const t=[a.a.createElement("tr",{key:"_category_"+e,className:"mx_SlashCommandHelpDialog_headerRow"},a.a.createElement("td",{colSpan:3},a.a.createElement("h2",null,Object(c.a)(e))))];return s[e].forEach(e=>{t.push(a.a.createElement("tr",{key:e.command},a.a.createElement("td",null,a.a.createElement("strong",null,e.getCommand())),a.a.createElement("td",null,e.args),a.a.createElement("td",null,e.description)))}),t});return a.a.createElement(t,{className:"mx_SlashCommandHelpDialog",title:Object(c.a)("Command Help"),description:a.a.createElement("table",null,a.a.createElement("tbody",null,n)),hasCloseButton:!0,onFinished:e})};let Rg=Object(P.a)("views.dialogs.StorageEvictedDialog")((kg=Cg=class extends a.a.Component{constructor(...e){super(...e),x()(this,"_sendBugReport",e=>{e.preventDefault();const t=d.getComponent("dialogs.BugReportDialog");Le.a.createTrackedDialog("Storage evicted","Send Bug Report Dialog",t,{})}),x()(this,"_onSignOutClick",()=>{this.props.onFinished(!0)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");let s;return l.a.get().bug_report_endpoint_url&&(s=Object(c.a)("To help us prevent this in future, please <a>send us logs</a>.",{},{a:e=>a.a.createElement("a",{href:"#",onClick:this._sendBugReport},e)})),a.a.createElement(e,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:Object(c.a)("Missing session data"),contentId:"mx_Dialog_content",hasCancel:!1},a.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},a.a.createElement("p",null,Object(c.a)("Some session data, including encrypted message keys, is missing. Sign out and sign in to fix this, restoring keys from backup.")),a.a.createElement("p",null,Object(c.a)("Your browser likely removed this data when running low on disk space.")," ",s)),a.a.createElement(t,{primaryButton:Object(c.a)("Sign out"),onPrimaryButtonClick:this._onSignOutClick,focus:!0,hasCancel:!1}))}},x()(Cg,"propTypes",{onFinished:wt.a.func.isRequired}),wg=kg))||wg;var Ig,xg,Tg,jg=s(569);let Ng=Object(P.a)("views.dialogs.UploadFailureDialog")((Tg=xg=class extends a.a.Component{constructor(...e){super(...e),x()(this,"_onCancelClick",()=>{this.props.onFinished(!1)}),x()(this,"_onUploadClick",()=>{this.props.onFinished(!0)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");let s,n;if(1===this.props.totalFiles&&1===this.props.badFiles.length)s=Object(c.a)("This file is <b>too large</b> to upload. The file size limit is %(limit)s but this file is %(sizeOfThisFile)s.",{limit:Vn()(this.props.contentMessages.getUploadLimit()),sizeOfThisFile:Vn()(this.props.badFiles[0].size)},{b:e=>a.a.createElement("b",null,e)}),n=a.a.createElement(t,{primaryButton:Object(c.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this._onCancelClick,focus:!0});else if(this.props.totalFiles===this.props.badFiles.length)s=Object(c.a)("These files are <b>too large</b> to upload. The file size limit is %(limit)s.",{limit:Vn()(this.props.contentMessages.getUploadLimit())},{b:e=>a.a.createElement("b",null,e)}),n=a.a.createElement(t,{primaryButton:Object(c.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this._onCancelClick,focus:!0});else{s=Object(c.a)("Some files are <b>too large</b> to be uploaded. The file size limit is %(limit)s.",{limit:Vn()(this.props.contentMessages.getUploadLimit())},{b:e=>a.a.createElement("b",null,e)});const e=this.props.totalFiles-this.props.badFiles.length;n=a.a.createElement(t,{primaryButton:Object(c.a)("Upload %(count)s other files",{count:e}),onPrimaryButtonClick:this._onUploadClick,hasCancel:!0,cancelButton:Object(c.a)("Cancel All"),onCancel:this._onCancelClick,focus:!0})}return a.a.createElement(e,{className:"mx_UploadFailureDialog",onFinished:this._onCancelClick,title:Object(c.a)("Upload Error"),contentId:"mx_Dialog_content"},a.a.createElement("div",{id:"mx_Dialog_content"},s,void 0),n)}},x()(xg,"propTypes",{badFiles:wt.a.arrayOf(wt.a.object).isRequired,totalFiles:wt.a.number.isRequired,contentMessages:wt.a.instanceOf(Fn.a).isRequired,onFinished:wt.a.func.isRequired}),Ig=Tg))||Ig;var Pg,Dg,Ag,Mg=s(605);let Ug=Object(P.a)("views.elements.ActionButton")((Ag=Dg=class extends a.a.Component{constructor(...e){super(...e),x()(this,"state",{showTooltip:!1}),x()(this,"_onClick",e=>{e.stopPropagation(),_.a.trackEvent("Action Button","click",this.props.action),u.a.dispatch({action:this.props.action})}),x()(this,"_onMouseEnter",()=>{this.props.tooltip&&this.setState({showTooltip:!0}),this.props.mouseOverAction&&u.a.dispatch({action:this.props.mouseOverAction})}),x()(this,"_onMouseLeave",()=>{this.setState({showTooltip:!1})})}render(){const e=d.getComponent("elements.TintableSvg");let t;if(this.state.showTooltip){const e=d.getComponent("elements.Tooltip");t=a.a.createElement(e,{className:"mx_RoleButton_tooltip",label:this.props.label})}const s=this.props.iconPath?a.a.createElement(e,{src:this.props.iconPath,width:this.props.size,height:this.props.size}):void 0,n=["mx_RoleButton"];return this.props.className&&n.push(this.props.className),a.a.createElement(g.a,{className:n.join(" "),onClick:this._onClick,onMouseEnter:this._onMouseEnter,onMouseLeave:this._onMouseLeave,"aria-label":this.props.label},s,t,this.props.children)}},x()(Dg,"propTypes",{size:wt.a.string,tooltip:wt.a.bool,action:wt.a.string.isRequired,mouseOverAction:wt.a.string,label:wt.a.string.isRequired,iconPath:wt.a.string,className:wt.a.string,children:wt.a.node}),x()(Dg,"defaultProps",{size:"25",tooltip:!1}),Pg=Ag))||Pg;var Lg,Fg,Bg;let Vg=Object(P.a)("views.elements.AddressSelector")((Bg=Fg=class extends a.a.Component{constructor(e){super(e),x()(this,"moveSelectionTop",()=>{this.state.selected>0&&this.setState({selected:0,hover:!1})}),x()(this,"moveSelectionUp",()=>{this.state.selected>0&&this.setState({selected:this.state.selected-1,hover:!1})}),x()(this,"moveSelectionDown",()=>{this.state.selected<this._maxSelected(this.props.addressList)&&this.setState({selected:this.state.selected+1,hover:!1})}),x()(this,"chooseSelection",()=>{this.selectAddress(this.state.selected)}),x()(this,"onClick",e=>{this.selectAddress(e)}),x()(this,"onMouseEnter",e=>{this.setState({selected:e,hover:!0})}),x()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),x()(this,"selectAddress",e=>{0!==this.props.addressList.length&&(this.props.onSelected(e),this.setState({hover:!1}))}),this.state={selected:void 0===this.props.selected?0:this.props.selected,hover:!1}}UNSAFE_componentWillReceiveProps(e){const t=this.state.selected,s=this._maxSelected(e.addressList);t>s&&this.setState({selected:s})}componentDidUpdate(){if(this.scrollElement&&this.props.addressList.length>0&&!this.state.hover){const e=this.addressListElement.getBoundingClientRect().height;this.scrollElement.scrollTop=this.state.selected*e-e}}createAddressListTiles(){const e=d.getComponent("elements.AddressTile"),t=this._maxSelected(this.props.addressList),n=[];if(this.props.addressList.length>0)for(let i=0;i<=t;i++){const t=M()({mx_AddressSelector_addressListElement:!0,mx_AddressSelector_selected:this.state.selected===i});n.push(a.a.createElement("div",{className:t,onClick:this.onClick.bind(this,i),onMouseEnter:this.onMouseEnter.bind(this,i),onMouseLeave:this.onMouseLeave,key:this.props.addressList[i].addressType+"/"+this.props.addressList[i].address,ref:e=>{this.addressListElement=e}},a.a.createElement(e,{address:this.props.addressList[i],showAddress:this.props.showAddress,justified:!0,networkName:"vector",networkUrl:s(1290)})))}return n}_maxSelected(e){const t=0===e.length?0:e.length-1;return t>this.props.truncateAt-1?this.props.truncateAt-1:t}render(){const e=M()({mx_AddressSelector:!0,mx_AddressSelector_empty:0===this.props.addressList.length});return a.a.createElement("div",{className:e,ref:e=>{this.scrollElement=e}},this.props.header,this.createAddressListTiles())}},x()(Fg,"propTypes",{onSelected:wt.a.func.isRequired,addressList:wt.a.arrayOf(fl.b).isRequired,showAddress:wt.a.bool,truncateAt:wt.a.number.isRequired,selected:wt.a.number,header:wt.a.node}),Lg=Bg))||Lg;var Kg,Wg,Gg;let qg=Object(P.a)("views.elements.AddressTile")((Gg=Wg=class extends a.a.Component{render(){const e=this.props.address,t=e.displayName||e.address,n=[],i=["mx-user-id","mx-room-id"].includes(e.addressType);i&&e.avatarMxc?n.push(Object(pe.b)(e.avatarMxc).getSquareThumbnailHttp(25)):"email"===e.addressType&&n.push(s(1291));const o=d.getComponent("avatars.BaseAvatar"),r=d.getComponent("elements.TintableSvg"),l=M()({mx_AddressTile_name:!0,mx_AddressTile_justified:this.props.justified});let u,h=!1;if(i&&e.isKnown){const s=M()({mx_AddressTile_id:!0,mx_AddressTile_justified:this.props.justified});u=a.a.createElement("div",{className:"mx_AddressTile_mx"},a.a.createElement("div",{className:l},t),this.props.showAddress?a.a.createElement("div",{className:s},e.address):a.a.createElement("div",null))}else if(i){const e=M()({mx_AddressTile_unknownMx:!0,mx_AddressTile_justified:this.props.justified});u=a.a.createElement("div",{className:e},this.props.address.address)}else if("email"===e.addressType){const t=M()({mx_AddressTile_email:!0,mx_AddressTile_justified:this.props.justified});let s=null;e.displayName&&(s=a.a.createElement("div",{className:l},e.displayName)),u=a.a.createElement("div",{className:"mx_AddressTile_mx"},a.a.createElement("div",{className:t},e.address),s)}else{h=!0;const e=M()({mx_AddressTile_unknown:!0,mx_AddressTile_justified:this.props.justified});u=a.a.createElement("div",{className:e},Object(c.a)("Unknown Address"))}const m=M()({mx_AddressTile:!0,mx_AddressTile_error:h});let p;return this.props.canDismiss&&(p=a.a.createElement("div",{className:"mx_AddressTile_dismiss",onClick:this.props.onDismissed},a.a.createElement(r,{src:s(1292),width:"9",height:"9"}))),a.a.createElement("div",{className:m},a.a.createElement("div",{className:"mx_AddressTile_avatar"},a.a.createElement(o,{defaultToInitialLetter:!0,width:25,height:25,name:t,title:t,urls:n})),u,p)}},x()(Wg,"propTypes",{address:fl.b.isRequired,canDismiss:wt.a.bool,onDismissed:wt.a.func,justified:wt.a.bool}),x()(Wg,"defaultProps",{canDismiss:!1,onDismissed:function(){},justified:!1}),Kg=Gg))||Kg;var Hg,$g,zg,Yg=s(602),Jg=s(603);let Qg=Object(P.a)("views.elements.TagTile")((zg=$g=class extends a.a.Component{constructor(...e){super(...e),x()(this,"state",{hover:!1,profile:null}),x()(this,"_onFlairStoreUpdated",()=>{this.unmounted||et.a.getGroupProfileCached(this.context,this.props.tag).then(e=>{this.unmounted||this.setState({profile:e})}).catch(e=>{console.warn("Could not fetch group profile for "+this.props.tag,e)})}),x()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch({action:"select_tag",tag:this.props.tag,ctrlOrCmdKey:Object(gt.c)(e),shiftKey:e.shiftKey}),"+"===this.props.tag[0]&&this._refreshGroup(this.props.tag)}),x()(this,"onMouseOver",()=>{V.b.getValue("feature_communities_v2_prototypes")||this.setState({hover:!0})}),x()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),x()(this,"openMenu",e=>{e.stopPropagation(),e.preventDefault(),V.b.getValue("feature_communities_v2_prototypes")||(this.setState({hover:!1}),this.props.openMenu())})}componentDidMount(){this.unmounted=!1,"+"===this.props.tag[0]&&(et.a.addListener("updateGroupProfile",this._onFlairStoreUpdated),this._onFlairStoreUpdated(),this._refreshGroup(this.props.tag))}componentWillUnmount(){this.unmounted=!0,"+"===this.props.tag[0]&&et.a.removeListener("updateGroupProfile",this._onFlairStoreUpdated)}_refreshGroup(e){wn.a.refreshGroupRooms(e),wn.a.refreshGroupMembers(e)}render(){const e=d.getComponent("avatars.BaseAvatar"),t=this.state.profile||{},s=t.name||this.props.tag,n=t.avatarUrl?Object(pe.b)(t.avatarUrl).getSquareThumbnailHttp(32):null,i=V.b.getValue("feature_communities_v2_prototypes"),o=M()({mx_TagTile:!0,mx_TagTile_prototype:i,mx_TagTile_selected:this.props.selected&&!i,mx_TagTile_selected_prototype:this.props.selected&&i}),r=U.a.getGroupBadge(this.props.tag);let c;if(r&&!this.state.hover&&!this.props.menuDisplayed){const e=M()({mx_TagTile_badge:!0,mx_TagTile_badgeHighlight:r.highlight});c=a.a.createElement("div",{className:e},J.c(r.count))}const l=this.state.hover||this.props.menuDisplayed?a.a.createElement(g.a,{className:"mx_TagTile_context_button",onClick:this.openMenu,inputRef:this.props.contextMenuButtonRef},"···"):a.a.createElement("div",{ref:this.props.contextMenuButtonRef}),u=d.getComponent("elements.AccessibleTooltipButton");return a.a.createElement(u,{className:o,onClick:this.onClick,onContextMenu:this.openMenu,title:s},a.a.createElement("div",{className:"mx_TagTile_avatar",onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},a.a.createElement(e,{name:s,idName:this.props.tag,url:n,width:32,height:32}),l,c))}},x()($g,"propTypes",{tag:wt.a.string,contextMenuButtonRef:wt.a.object,openMenu:wt.a.func,menuDisplayed:wt.a.bool,selected:wt.a.bool}),x()($g,"contextType",b.a),Hg=zg))||Hg;function Xg(e){const[t,s,n,o]=Object(i.q)();let r=null;if(t&&s.current){const t=s.current.getBoundingClientRect(),n=d.getComponent("context_menus.TagTileContextMenu");r=a.a.createElement(i.b,ue()({},Object(i.p)(t),{onFinished:o}),a.a.createElement(n,{tag:e.tag,onFinished:o,index:e.index}))}return a.a.createElement(a.a.Fragment,null,a.a.createElement(Qg,ue()({},e,{contextMenuButtonRef:s,menuDisplayed:t,openMenu:n})),r)}var Zg,ev,tv,sv=s(427);let nv=Object(P.a)("views.elements.EditableText")((tv=ev=class e extends a.a.Component{constructor(t){super(t),x()(this,"state",{phase:e.Phases.Display}),x()(this,"showPlaceholder",e=>{e?(this._editable_div.current.textContent=this.props.placeholder,this._editable_div.current.setAttribute("class",this.props.className+" "+this.props.placeholderClassName),this.placeholder=!0,this.value=""):(this._editable_div.current.textContent=this.value,this._editable_div.current.setAttribute("class",this.props.className),this.placeholder=!1)}),x()(this,"getValue",()=>this.value),x()(this,"setValue",e=>{this.value=e,this.showPlaceholder(!this.value)}),x()(this,"edit",()=>{this.setState({phase:e.Phases.Edit})}),x()(this,"cancelEdit",()=>{this.setState({phase:e.Phases.Display}),this.value=this.props.initialValue,this.showPlaceholder(!this.value),this.onValueChanged(!1),this._editable_div.current.blur()}),x()(this,"onValueChanged",e=>{this.props.onValueChanged(this.value,e)}),x()(this,"onKeyDown",e=>{this.placeholder&&this.showPlaceholder(!1),e.key===gt.a.ENTER&&(e.stopPropagation(),e.preventDefault())}),x()(this,"onKeyUp",e=>{e.target.textContent?this.placeholder||(this.value=e.target.textContent):this.showPlaceholder(!0),e.key===gt.a.ENTER?this.onFinish(e):e.key===gt.a.ESCAPE&&this.cancelEdit()}),x()(this,"onClickDiv",t=>{this.props.editable&&this.setState({phase:e.Phases.Edit})}),x()(this,"onFocus",e=>{const t=e.target.childNodes[0];if(t){const e=document.createRange();e.setStart(t,0),e.setEnd(t,t.length);const s=window.getSelection();s.removeAllRanges(),s.addRange(e)}}),x()(this,"onFinish",(t,s)=>{const n=this,i=t.key===gt.a.ENTER||s;this.setState({phase:e.Phases.Display},()=>{this.value!==this.props.initialValue&&n.onValueChanged(i)})}),x()(this,"onBlur",e=>{window.getSelection().removeAllRanges(),this.props.blurToCancel?this.cancelEdit():this.onFinish(e,this.props.blurToSubmit),this.showPlaceholder(!this.value)}),this.value="",this.placeholder=!1,this._editable_div=Object(o.createRef)()}UNSAFE_componentWillReceiveProps(e){e.initialValue!==this.props.initialValue&&(this.value=e.initialValue,this._editable_div.current&&this.showPlaceholder(!this.value))}componentDidMount(){this.value=this.props.initialValue,this._editable_div.current&&this.showPlaceholder(!this.value)}render(){const{className:t,editable:s,initialValue:n,label:i,labelClassName:o}=this.props;let r;return r=!s||this.state.phase===e.Phases.Display&&(i||o)&&!this.value?a.a.createElement("div",{className:t+" "+o,onClick:this.onClickDiv},i||n):a.a.createElement("div",{ref:this._editable_div,contentEditable:!0,className:t,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onFocus:this.onFocus,onBlur:this.onBlur}),r}},x()(ev,"propTypes",{onValueChanged:wt.a.func,initialValue:wt.a.string,label:wt.a.string,placeholder:wt.a.string,className:wt.a.string,labelClassName:wt.a.string,placeholderClassName:wt.a.string,blurToCancel:wt.a.bool,blurToSubmit:wt.a.bool,editable:wt.a.bool}),x()(ev,"Phases",{Display:"display",Edit:"edit"}),x()(ev,"defaultProps",{onValueChanged(){},initialValue:"",label:"",placeholder:"",editable:!0,className:"mx_EditableText",placeholderClassName:"mx_EditableText_placeholder",blurToSubmit:!1}),Zg=tv))||Zg;var iv;let ov=Object(P.a)("views.elements.EditableTextContainer")(iv=class extends a.a.Component{constructor(e){super(e),this._unmounted=!1,this.state={busy:!1,errorString:null,value:e.initialValue},this._onValueChanged=this._onValueChanged.bind(this)}componentDidMount(){void 0!==this.props.getInitialValue&&(this.setState({busy:!0}),this.props.getInitialValue().then(e=>{this._unmounted||this.setState({busy:!1,value:e})},e=>{this._unmounted||this.setState({errorString:e.toString(),busy:!1})}))}componentWillUnmount(){this._unmounted=!0}_onValueChanged(e,t){t&&(this.setState({busy:!0,errorString:null}),this.props.onSubmit(e).then(()=>{this._unmounted||this.setState({busy:!1,value:e})},e=>{this._unmounted||this.setState({errorString:e.toString(),busy:!1})}))}render(){if(this.state.busy){const e=d.getComponent("elements.Spinner");return a.a.createElement(e,null)}if(this.state.errorString)return a.a.createElement("div",{className:"error"},this.state.errorString);{const e=d.getComponent("elements.EditableText");return a.a.createElement(e,{initialValue:this.state.value,placeholder:this.props.placeholder,onValueChanged:this._onValueChanged,blurToSubmit:this.props.blurToSubmit})}}})||iv;ov.propTypes={getInitialValue:wt.a.func,initialValue:wt.a.string,placeholder:wt.a.string,onSubmit:wt.a.func,blurToSubmit:wt.a.bool},ov.defaultProps={initialValue:"",placeholder:"",blurToSubmit:!1,onSubmit:function(e){return Promise.resolve()}};var av,rv=s(413),cv=s(624),lv=s(469),dv=s(663),uv=s(234);let hv=Object(P.a)("views.elements.Spoiler")(av=class extends a.a.Component{constructor(e){super(e),this.state={visible:!1}}toggleVisible(e){this.state.visible||(e.preventDefault(),e.stopPropagation()),this.setState({visible:!this.state.visible})}render(){const e=this.props.reason?a.a.createElement("span",{className:"mx_EventTile_spoiler_reason"},"("+this.props.reason+")"):null;return a.a.createElement("span",{className:"mx_EventTile_spoiler"+(this.state.visible?" visible":""),onClick:this.toggleVisible.bind(this)},e," ",a.a.createElement("span",{className:"mx_EventTile_spoiler_content",dangerouslySetInnerHTML:{__html:this.props.contentHtml}}))}})||av;var mv,pv,gv,vv=s(335);let fv=Object(P.a)("views.elements.TintableSvg")((gv=pv=class e extends a.a.Component{constructor(...e){super(...e),x()(this,"tint",()=>{vv.a.applySvgFixups(this.fixups)}),x()(this,"onLoad",e=>{this.fixups=vv.a.calcSvgFixups([e.target]),vv.a.applySvgFixups(this.fixups)})}componentDidMount(){this.fixups=[],this.id=e.idSequence++,e.mounts[this.id]=this}componentWillUnmount(){delete e.mounts[this.id]}render(){return a.a.createElement("object",{className:"mx_TintableSvg "+(this.props.className?this.props.className:""),type:"image/svg+xml",data:this.props.src,width:this.props.width,height:this.props.height,onLoad:this.onLoad,tabIndex:"-1"})}},x()(pv,"propTypes",{src:wt.a.string.isRequired,width:wt.a.string.isRequired,height:wt.a.string.isRequired,className:wt.a.string}),x()(pv,"mounts",{}),x()(pv,"idSequence",0),mv=gv))||mv;vv.a.registerTintable((function(){fv.mounts&&Object.keys(fv.mounts).forEach(e=>{fv.mounts[e].tint()})}));var bv,yv,_v,Ev=fv,Sv=s(424);let wv=Object(P.a)("views.groups.GroupInviteTile")((_v=yv=class extends a.a.Component{constructor(e,t){super(e,t),x()(this,"onClick",e=>{u.a.dispatch({action:"view_group",group_id:this.props.group.groupId})}),x()(this,"onMouseEnter",()=>{const e={hover:!0};this.context.isGuest()||(e.badgeHover=!0),this.setState(e)}),x()(this,"onMouseLeave",()=>{this.setState({badgeHover:!1,hover:!1})}),x()(this,"onContextMenuButtonClick",e=>{e.stopPropagation(),e.preventDefault(),this._showContextMenu(e.target.getBoundingClientRect())}),x()(this,"onContextMenu",e=>{e.preventDefault(),this._showContextMenu({right:e.clientX,top:e.clientY,height:0})}),x()(this,"closeMenu",()=>{this.setState({contextMenuPosition:null})}),this.state={hover:!1,badgeHover:!1,menuDisplayed:!1,selected:null===this.props.group.groupId}}_showContextMenu(e){if(le.a.get().isGuest())return;const t={contextMenuPosition:e};this.props.collapsed&&(t.hover=!1),this.setState(t)}render(){const e=d.getComponent("elements.AccessibleButton"),t=d.getComponent("avatars.BaseAvatar"),s=this.props.group.name||this.props.group.groupId,n=this.props.group.avatarUrl?Object(pe.b)(this.props.group.avatarUrl).getSquareThumbnailHttp(24):null,o=a.a.createElement(t,{name:s,width:24,height:24,url:n}),r=Boolean(this.state.contextMenuPosition),l=M()("mx_RoomTile_name mx_RoomTile_invite mx_RoomTile_badgeShown",{mx_RoomTile_badgeShown:this.state.badgeHover||r}),u=a.a.createElement("div",{title:this.props.group.groupId,className:l,tabIndex:-1,dir:"auto"},s),h=this.state.badgeHover||r,m=M()("mx_RoomTile_badge mx_RoomTile_highlight",{mx_RoomTile_badgeButton:h}),p=h?"···":"!";let g;if(this.props.collapsed&&this.state.hover){const e=d.getComponent("elements.Tooltip");g=a.a.createElement(e,{className:"mx_RoomTile_tooltip",label:s,dir:"auto"})}const v=M()("mx_RoomTile mx_RoomTile_highlight",{mx_RoomTile_menuDisplayed:r,mx_RoomTile_selected:this.state.selected,mx_GroupInviteTile:!0});let f;if(r){const e=d.getComponent("context_menus.GroupInviteTileContextMenu");f=a.a.createElement(i.b,ue()({},Object(i.p)(this.state.contextMenuPosition),{onFinished:this.closeMenu}),a.a.createElement(e,{group:this.props.group,onFinished:this.closeMenu}))}return a.a.createElement(a.a.Fragment,null,a.a.createElement(ie.d,null,({onFocus:t,isActive:s,ref:n})=>a.a.createElement(e,{onFocus:t,tabIndex:s?0:-1,inputRef:n,className:v,onClick:this.onClick,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,onContextMenu:this.onContextMenu},a.a.createElement("div",{className:"mx_RoomTile_avatar"},o),a.a.createElement("div",{className:"mx_RoomTile_nameContainer"},u,a.a.createElement(i.c,{className:m,onClick:this.onContextMenuButtonClick,label:Object(c.a)("Options"),isExpanded:r,tabIndex:s?0:-1},p)),g)),f)}},x()(yv,"propTypes",void 0),x()(yv,"contextType",b.a),bv=_v))||bv;var Cv,kv,Ov,Rv=s(613),Iv=s(357);let xv=Object(P.a)("views.groups.GroupMemberTile")((Ov=kv=class extends a.a.Component{constructor(...e){super(...e),x()(this,"onClick",e=>{u.a.dispatch({action:"view_group_user",member:this.props.member,groupId:this.props.groupId})})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=d.getComponent("rooms.EntityTile"),s=this.props.member.displayname||this.props.member.userId,n=this.props.member.avatarUrl?Object(pe.b)(this.props.member.avatarUrl).getSquareThumbnailHttp(36):null,i=a.a.createElement(e,{"aria-hidden":"true",name:this.props.member.displayname||this.props.member.userId,idName:this.props.member.userId,width:36,height:36,url:n});return a.a.createElement(t,{name:s,avatarJsx:i,onClick:this.onClick,suppressOnHover:!0,presenceState:"online",powerStatus:this.props.member.isPrivileged?t.POWER_STATUS_ADMIN:null})}},x()(kv,"propTypes",{groupId:wt.a.string.isRequired,member:Iv.a.isRequired}),x()(kv,"contextType",b.a),Cv=Ov))||Cv;var Tv,jv,Nv;let Pv=Object(P.a)("views.groups.GroupPublicityTile")((Nv=jv=class extends a.a.Component{constructor(...e){super(...e),x()(this,"state",{busy:!1,ready:!1,isGroupPublicised:!1}),x()(this,"_onPublicityToggle",()=>{this.setState({busy:!0,isGroupPublicised:!this.state.isGroupPublicised}),wn.a.setGroupPublicity(this.props.groupId,!this.state.isGroupPublicised).then(()=>{this.setState({busy:!1})})})}componentDidMount(){this._initGroupStore(this.props.groupId)}_initGroupStore(e){this._groupStoreToken=wn.a.registerListener(e,()=>{this.setState({isGroupPublicised:Boolean(wn.a.getGroupPublicity(e)),ready:wn.a.isStateReady(e,wn.a.STATE_KEY.Summary)})})}componentWillUnmount(){this._groupStoreToken&&this._groupStoreToken.unregister()}render(){const e=d.getComponent("groups.GroupTile");return a.a.createElement("div",{className:"mx_GroupPublicity_toggle"},a.a.createElement(e,{groupId:this.props.groupId,showDescription:!1,avatarHeight:40}),a.a.createElement(Fa.a,{checked:this.state.isGroupPublicised,disabled:!this.state.ready||this.state.busy,onChange:this._onPublicityToggle}))}},x()(jv,"propTypes",{groupId:wt.a.string.isRequired}),Tv=Nv))||Tv;var Dv,Av,Mv,Uv=s(615),Lv=s(614);var Fv,Bv,Vv,Kv=Object(P.a)("views.groups.GroupRoomTile")((Mv=Av=class extends a.a.Component{constructor(...e){super(...e),x()(this,"onClick",e=>{u.a.dispatch({action:"view_group_room",groupId:this.props.groupId,groupRoomId:this.props.groupRoom.roomId})})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=d.getComponent("elements.AccessibleButton"),s=this.props.groupRoom.avatarUrl?Object(pe.b)(this.props.groupRoom.avatarUrl).getSquareThumbnailHttp(36):null,n=a.a.createElement(e,{name:this.props.groupRoom.displayname,width:36,height:36,url:s});return a.a.createElement(t,{className:"mx_GroupRoomTile",onClick:this.onClick},a.a.createElement("div",{className:"mx_GroupRoomTile_avatar"},n),a.a.createElement("div",{className:"mx_GroupRoomTile_name"},this.props.groupRoom.displayname))}},x()(Av,"propTypes",{groupId:wt.a.string.isRequired,groupRoom:Iv.b.isRequired}),x()(Av,"contextType",b.a),Dv=Mv))||Dv;var Wv,Gv,qv,Hv=Object(P.a)("views.groups.GroupTile")((Vv=Bv=class extends a.a.Component{constructor(...e){super(...e),x()(this,"state",{profile:null}),x()(this,"onClick",e=>{e.preventDefault(),u.a.dispatch({action:"view_group",group_id:this.props.groupId})}),x()(this,"onPinClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch(Pp.moveTag(this.context,this.props.groupId,0))}),x()(this,"onUnpinClick",e=>{e.preventDefault(),e.stopPropagation(),u.a.dispatch(Pp.removeTag(this.context,this.props.groupId))})}componentDidMount(){et.a.getGroupProfileCached(this.context,this.props.groupId).then(e=>{this.setState({profile:e})}).catch(e=>{console.error("Error whilst getting cached profile for GroupTile",e)})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=d.getComponent("elements.AccessibleButton"),s=this.state.profile||{},n=s.name||this.props.groupId,i=this.props.avatarHeight,o=this.props.showDescription?a.a.createElement("div",{className:"mx_GroupTile_desc"},s.shortDescription):a.a.createElement("div",null),r=s.avatarUrl?Object(pe.b)(s.avatarUrl).getSquareThumbnailHttp(i):null,l=a.a.createElement("div",{className:"mx_GroupTile_avatar"},a.a.createElement(e,{name:n,idName:this.props.groupId,url:r,width:i,height:i}));return a.a.createElement(t,{className:"mx_GroupTile",onClick:this.onClick},l,a.a.createElement("div",{className:"mx_GroupTile_profile"},a.a.createElement("div",{className:"mx_GroupTile_name"},n),o,a.a.createElement("div",{className:"mx_GroupTile_groupId"},this.props.groupId),(U.a.getOrderedTags()||[]).includes(this.props.groupId)?a.a.createElement(t,{kind:"link",onClick:this.onUnpinClick},Object(c.a)("Unpin")):a.a.createElement(t,{kind:"link",onClick:this.onPinClick},Object(c.a)("Pin"))))}},x()(Bv,"propTypes",{groupId:wt.a.string.isRequired,showDescription:wt.a.bool,avatarHeight:wt.a.number}),x()(Bv,"contextType",b.a),x()(Bv,"defaultProps",{showDescription:!0,avatarHeight:50}),Fv=Vv))||Fv,$v=s(661);let zv=Object(P.a)("views.messages.DateSeparator")((qv=Gv=class extends a.a.Component{getLabel(){const e=new Date(this.props.ts),t=new Date,s=new Date,n=[Object(c.a)("Sunday"),Object(c.a)("Monday"),Object(c.a)("Tuesday"),Object(c.a)("Wednesday"),Object(c.a)("Thursday"),Object(c.a)("Friday"),Object(c.a)("Saturday")];return s.setDate(t.getDate()-1),e.toDateString()===t.toDateString()?Object(c.a)("Today"):e.toDateString()===s.toDateString()?Object(c.a)("Yesterday"):t.getTime()-e.getTime()<5184e5?n[e.getDay()]:Object(rm.c)(e)}render(){return a.a.createElement("h2",{className:"mx_DateSeparator",role:"separator",tabIndex:-1},a.a.createElement("hr",{role:"none"}),a.a.createElement("div",null,this.getLabel()),a.a.createElement("hr",{role:"none"}))}},x()(Gv,"propTypes",{ts:wt.a.number.isRequired}),Wv=qv))||Wv;var Yv=s(1293),Jv=s(1294);const Qv=function(){let e=null;return function(t){return e||(e=document.createElement("textarea")),e.innerHTML=t,e.value}}();function Xv(e){const t={stripReplyFallback:!0,returnString:!0};return"org.matrix.custom.html"===e.format?Object(pn.b)(e,null,t):function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(Object(pn.b)(e,null,t))}function Zv(e){const t=document.createElement(Object(pn.c)(e)?"div":"span");return t.className="mx_EditHistoryMessage_insertion",t.appendChild(e),t}function ef(e){const t=document.createElement(Object(pn.c)(e)?"div":"span");return t.className="mx_EditHistoryMessage_deletion",t.appendChild(e),t}function tf(e){if("#text"===e.nodeName)return af(e.data);{const t=document.createElement(e.nodeName);if(e.attributes)for(const[s,n]of Object.entries(e.attributes))t.setAttribute(s,n);if(e.childNodes)for(const s of e.childNodes)t.appendChild(tf(s));return t}}function sf(e,t,s){t?e.insertBefore(s,t):e.appendChild(s)}function nf(e,t){for(let s=0;s<e.length-1;++s)if(e[s]!==t[s])return!1;const s=e.length-1;return t[s]>=e[s]}function of(e,t){if("removeTextElement"===e.action||"removeElement"===e.action){const s=1;for(const n of t)nf(e.route,n.route)&&(n.route[e.route.length-1]+=s)}}function af(e){return document.createTextNode(Qv(e))}function rf(e,t,s){const{refNode:n,refParentNode:i}=function(e,t,s=!1){let n,i=e;const o=s?t.length-1:t.length;for(let e=0;e<o;++e)n=i,i=i.childNodes[t[e]];return{refNode:i,refParentNode:n}}(e,t.route);switch(t.action){case"replaceElement":{const e=document.createElement("span"),s=ef(tf(t.oldValue)),i=Zv(tf(t.newValue));e.appendChild(s),e.appendChild(i),n.parentNode.replaceChild(e,n);break}case"removeTextElement":{const e=ef(af(t.value));n.parentNode.replaceChild(e,n);break}case"removeElement":{const e=ef(tf(t.element));n.parentNode.replaceChild(e,n);break}case"modifyTextElement":{const e=s.diff_main(t.oldValue,t.newValue);s.diff_cleanupSemantic(e);const i=document.createElement("span");for(const[t,s]of e){let e=af(s);t<0?e=ef(e):t>0&&(e=Zv(e)),i.appendChild(e)}n.parentNode.replaceChild(i,n);break}case"addElement":sf(i,n,Zv(tf(t.element)));break;case"addTextElement":sf(i,n,Zv(af("\n"!==t.value?t.value:"")));break;case"removeAttribute":case"addAttribute":case"modifyAttribute":{const e=ef(n.cloneNode(!0)),s=n.cloneNode(!0);"addAttribute"===t.action||"modifyAttribute"===t.action?s.setAttribute(t.name,t.newValue):s.removeAttribute(t.name);const i=Zv(s),o=document.createElement(Object(pn.c)(n)?"div":"span");o.appendChild(e),o.appendChild(i),n.parentNode.replaceChild(o,n);break}default:console.warn("MessageDiffUtils::editBodyDiffToHtml: diff action not supported atm",t)}}function cf(e,t){return e.length===t.length&&!e.some((e,s)=>e!==t[s])}function lf(e,t){const s=`<div>${Xv(e)}</div>`,n=`<div>${Xv(t)}</div>`,i=function(e){const t=e.slice();for(let e=0;e<t.length;++e){const s=t[e];if("removeTextElement"===s.action){const n=t[e+1];n&&"addTextElement"===n.action&&n.text===s.text&&cf(n.route,s.route)&&t.splice(e,2)}}return t}((new Jv.DiffDOM).diff(s,n)),o=new Yv.diff_match_patch,r=(new DOMParser).parseFromString(s,"text/html").body.children[0];for(let e=0;e<i.length;++e){const t=i[e];rf(r,t,o),of(t,i.slice(e+1))}const c=r.innerHTML,l=M()({mx_EventTile_body:!0,"markdown-body":!0});return a.a.createElement("span",{key:"body",className:l,dangerouslySetInnerHTML:{__html:c}})}var df,uf,hf,mf=s(735);function pf(e){const t=e.getOriginalContent();return t["m.new_content"]||t}let gf=Object(P.a)("views.messages.EditHistoryMessage")((hf=uf=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"_onAssociatedStatusChanged",()=>{this.setState({sendStatus:this.props.mxEvent.getAssociatedStatus()})}),x()(this,"_onRedactClick",async()=>{const e=this.props.mxEvent,t=le.a.get(),s=d.getComponent("dialogs.ConfirmAndWaitRedactDialog");Le.a.createTrackedDialog("Confirm Redact Dialog","Edit history",s,{redact:()=>t.redactEvent(e.getRoomId(),e.getId())},"mx_Dialog_confirmredact")}),x()(this,"_onViewSourceClick",()=>{const e=d.getComponent("structures.ViewSource");Le.a.createTrackedDialog("View Event Source","Edit history",e,{mxEvent:this.props.mxEvent},"mx_Dialog_viewsource")});const t=le.a.get(),{userId:s}=t.credentials,n=this.props.mxEvent,i=t.getRoom(n.getRoomId());n.localRedactionEvent()&&n.localRedactionEvent().on("status",this._onAssociatedStatusChanged);const a=i.currentState.maySendRedactionForEvent(n,s);this.state={canRedact:a,sendStatus:n.getAssociatedStatus()},this._content=Object(o.createRef)(),this._pills=[]}pillifyLinks(){this._content.current&&Object(mf.a)(this._content.current.children,this.props.mxEvent,this._pills)}componentDidMount(){this.pillifyLinks()}componentWillUnmount(){Object(mf.b)(this._pills);const e=this.props.mxEvent;e.localRedactionEvent()&&e.localRedactionEvent().off("status",this._onAssociatedStatusChanged)}componentDidUpdate(){this.pillifyLinks()}_renderActionBar(){const e=d.getComponent("elements.AccessibleButton");let t;this.props.mxEvent.isRedacted()||this.props.isBaseEvent||!this.state.canRedact||(t=a.a.createElement(e,{onClick:this._onRedactClick},Object(c.a)("Remove")));const s=a.a.createElement(e,{onClick:this._onViewSourceClick},Object(c.a)("View Source"));return a.a.createElement("div",{className:"mx_MessageActionBar"},t,s)}render(){const{mxEvent:e}=this.props,t=pf(e);let s;if(e.isRedacted())s=a.a.createElement(Lc.a,{mxEvent:this.props.mxEvent});else{let n;if(n=this.props.previousEdit?lf(pf(this.props.previousEdit),t):pn.b(t,null,{stripReplyFallback:!0}),"m.emote"===e.getContent().msgtype){const t=e.sender?e.sender.name:e.getSender();s=a.a.createElement("div",{className:"mx_EventTile_content",ref:this._content},"* ",a.a.createElement("span",{className:"mx_MEmoteBody_sender"},t)," ",n)}else s=a.a.createElement("div",{className:"mx_EventTile_content",ref:this._content},n)}const n=Object(rm.e)(new Date(e.getTs()),this.props.isTwelveHour),i=-1!==["sending","queued","encrypting"].indexOf(this.state.sendStatus),o=M()({mx_EventTile:!0,mx_EventTile_sending:i});return a.a.createElement("li",null,a.a.createElement("div",{className:o},a.a.createElement("div",{className:"mx_EventTile_line"},a.a.createElement("span",{className:"mx_MessageTimestamp"},n),s,this._renderActionBar())))}},x()(uf,"propTypes",{mxEvent:wt.a.instanceOf(km.b).isRequired,previousEdit:wt.a.instanceOf(km.b),isBaseEvent:wt.a.bool}),df=hf))||df;var vf,ff,bf;let yf=Object(P.a)("views.messages.MImageBody")((bf=ff=class extends a.a.Component{constructor(e){super(e),this.onImageError=this.onImageError.bind(this),this.onImageLoad=this.onImageLoad.bind(this),this.onImageEnter=this.onImageEnter.bind(this),this.onImageLeave=this.onImageLeave.bind(this),this.onClientSync=this.onClientSync.bind(this),this.onClick=this.onClick.bind(this),this._isGif=this._isGif.bind(this),this.state={decryptedUrl:null,decryptedThumbnailUrl:null,decryptedBlob:null,error:null,imgError:!1,imgLoaded:!1,loadedImageDimensions:null,hover:!1,showImage:V.b.getValue("showImages")},this._image=Object(o.createRef)()}onClientSync(e,t){if(this.unmounted)return;"ERROR"!==e&&t!==e&&this.state.imgError&&this.setState({imgError:!1})}showImage(){localStorage.setItem("mx_ShowImage_"+this.props.mxEvent.getId(),"true"),this.setState({showImage:!0}),this._downloadImage()}onClick(e){if(0===e.button&&!e.metaKey){if(e.preventDefault(),!this.state.showImage)return void this.showImage();const t=this.props.mxEvent.getContent(),s=this._getContentUrl(),n=d.getComponent("elements.ImageView"),i={src:s,name:t.body&&t.body.length>0?t.body:Object(c.a)("Attachment"),mxEvent:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator};t.info&&(i.width=t.info.w,i.height=t.info.h,i.fileSize=t.info.size),Le.a.createDialog(n,i,"mx_Dialog_lightbox",null,!0)}}_isGif(){const e=this.props.mxEvent.getContent();return e&&e.info&&"image/gif"===e.info.mimetype}onImageEnter(e){if(this.setState({hover:!0}),!this.state.showImage||!this._isGif()||V.b.getValue("autoplayGifsAndVideos"))return;e.target.src=this._getContentUrl()}onImageLeave(e){if(this.setState({hover:!1}),!this.state.showImage||!this._isGif()||V.b.getValue("autoplayGifsAndVideos"))return;e.target.src=this._getThumbUrl()}onImageError(){this.setState({imgError:!0})}onImageLoad(){let e;if(this.props.onHeightChanged(),this._image.current){const{naturalWidth:t,naturalHeight:s}=this._image.current;e={naturalWidth:t,naturalHeight:s}}this.setState({imgLoaded:!0,loadedImageDimensions:e})}_getContentUrl(){const e=Object(pe.a)(this.props.mxEvent.getContent());return e.isEncrypted?this.state.decryptedUrl:e.srcHttp}_getThumbUrl(){const e=this.props.mxEvent.getContent(),t=Object(pe.a)(e);if(t.isEncrypted)return this.state.decryptedThumbnailUrl?this.state.decryptedThumbnailUrl:this.state.decryptedUrl;if(e.info&&"image/svg+xml"===e.info.mimetype&&t.hasThumbnail)return t.getThumbnailHttp(800,600,"scale");{const s=e.info;if(!this._isGif()&&1!==window.devicePixelRatio&&s&&s.w&&s.h&&s.size){const e=s.w>800||s.h>600;return s.size>1048576&&e?t.getThumbnailOfSourceHttp(800,600):t.srcHttp}return t.getThumbnailOfSourceHttp(800,600)}}_downloadImage(){const e=this.props.mxEvent.getContent();if(void 0!==e.file&&null===this.state.decryptedUrl){let t,s=Promise.resolve(null);e.info&&e.info.thumbnail_file&&(s=Ir(e.info.thumbnail_file).then((function(e){return URL.createObjectURL(e)}))),s.then(s=>Ir(e.file).then((function(e){return t=e,URL.createObjectURL(e)})).then(e=>{this.unmounted||this.setState({decryptedUrl:e,decryptedThumbnailUrl:s,decryptedBlob:t})})).catch(e=>{this.unmounted||(console.warn("Unable to decrypt attachment: ",e),this.setState({error:e}))})}}componentDidMount(){this.unmounted=!1,this.context.on("sync",this.onClientSync);(this.state.showImage||"true"===localStorage.getItem("mx_ShowImage_"+this.props.mxEvent.getId()))&&(this._downloadImage(),this.setState({showImage:!0})),this._afterComponentDidMount()}_afterComponentDidMount(){}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("sync",this.onClientSync),this._afterComponentWillUnmount(),this.state.decryptedUrl&&URL.revokeObjectURL(this.state.decryptedUrl),this.state.decryptedThumbnailUrl&&URL.revokeObjectURL(this.state.decryptedThumbnailUrl)}_afterComponentWillUnmount(){}_messageContent(e,t,s){let n,i;if(s&&s.info&&s.info.w&&s.info.h)n=s.info.w,i=s.info.h;else{if(!this.state.loadedImageDimensions){let n;return n=this.state.showImage?a.a.createElement("img",{style:{display:"none"},src:t,ref:this._image,alt:s.body,onError:this.onImageError,onLoad:this.onImageLoad}):a.a.createElement(_f,null),{thumbnail:this.wrapImage(e,n)}}n=this.state.loadedImageDimensions.naturalWidth,i=this.state.loadedImageDimensions.naturalHeight}const o=Math.min(this.props.maxImageHeight||600,i),r=n*o/i;let c=null,l=null,d=null;void 0!==s.file&&null===this.state.decryptedUrl?l=a.a.createElement(ot.a,{w:32,h:32}):this.state.imgLoaded||(l=this.getPlaceholder());let u=Boolean(l);t&&!this.state.imgError&&(c=a.a.createElement("img",{className:"mx_MImageBody_thumbnail",src:t,ref:this._image,style:{maxWidth:r+"px"},alt:s.body,onError:this.onImageError,onLoad:this.onImageLoad,onMouseEnter:this.onImageEnter,onMouseLeave:this.onImageLeave})),this.state.showImage||(c=a.a.createElement(_f,{style:{maxWidth:r+"px"}}),u=!1),!this._isGif()||V.b.getValue("autoplayGifsAndVideos")||this.state.hover||(d=a.a.createElement("p",{className:"mx_MImageBody_gifLabel"},"GIF"));const h=a.a.createElement("div",{className:"mx_MImageBody_thumbnail_container",style:{maxHeight:o+"px"}},a.a.createElement("div",{style:{paddingBottom:100*i/n+"%"}}),u&&a.a.createElement("div",{className:"mx_MImageBody_thumbnail",style:{maxWidth:n+"px"}},a.a.createElement("div",{className:"mx_MImageBody_thumbnail_spinner"},l)),a.a.createElement("div",{style:{display:u?"none":void 0}},c,d),this.state.hover&&this.getTooltip());return{thumbnail:this.wrapImage(e,h),maxWidth:r}}wrapImage(e,t){return a.a.createElement("a",{href:e,onClick:this.onClick},t)}getPlaceholder(){return null}getTooltip(){return null}getFileBody(){return a.a.createElement(jr,ue()({},this.props,{decryptedBlob:this.state.decryptedBlob,showGenericPlaceholder:!1}))}render(){const e=this.props.mxEvent.getContent();if(null!==this.state.error)return a.a.createElement("span",{className:"mx_MImageBody"},a.a.createElement("img",{src:s(224),width:"16",height:"16"}),Object(c.a)("Error decrypting image"),this.props.scBubbleActionBar);const t=this._getContentUrl();let n;n=this._isGif()&&V.b.getValue("autoplayGifsAndVideos")?t:this._getThumbUrl();const{thumbnail:i,maxWidth:o}=this._messageContent(t,n,e),r=this.getFileBody();return a.a.createElement("span",{className:"mx_MImageBody",style:{maxWidth:this.props.scBubble?o+"px":null}},i,r,this.props.scBubbleActionBar)}},x()(ff,"propTypes",{mxEvent:wt.a.object.isRequired,onHeightChanged:wt.a.func.isRequired,maxImageHeight:wt.a.number,permalinkCreator:wt.a.object,scBubble:wt.a.bool,scBubbleGroupTimestamp:wt.a.object,scBubbleActionBar:wt.a.object}),x()(ff,"contextType",b.a),vf=bf))||vf;class _f extends a.a.PureComponent{render(){let e="mx_HiddenImagePlaceholder";return this.props.hover&&(e+=" mx_HiddenImagePlaceholder_hover"),a.a.createElement("div",{className:e},a.a.createElement("div",{className:"mx_HiddenImagePlaceholder_button"},a.a.createElement("span",{className:"mx_HiddenImagePlaceholder_eye"}),a.a.createElement("span",null,Object(c.a)("Show image"))))}}var Ef;x()(_f,"propTypes",{hover:wt.a.bool});let Sf=Object(P.a)("views.messages.MKeyVerificationConclusion")(Ef=class extends a.a.Component{constructor(e){super(e),x()(this,"_onRequestChanged",()=>{this.forceUpdate()}),x()(this,"_onTrustChanged",(e,t)=>{const{mxEvent:s}=this.props,n=s.verificationRequest;n&&n.otherUserId===e&&this.forceUpdate()})}componentDidMount(){const e=this.props.mxEvent.verificationRequest;e&&e.on("change",this._onRequestChanged),le.a.get().on("userTrustStatusChanged",this._onTrustChanged)}componentWillUnmount(){const e=this.props.mxEvent.verificationRequest;e&&e.off("change",this._onRequestChanged);const t=le.a.get();t&&t.removeListener("userTrustStatusChanged",this._onTrustChanged)}_shouldRender(e,t){return!!t&&(!("m.key.verification.cancel"===e.getType()&&!t.cancelled)&&(!("m.key.verification.done"===e.getType()&&!t.done)&&(!t.pending&&!!le.a.get().checkUserTrust(t.otherUserId).isCrossSigningVerified())))}render(){const{mxEvent:e}=this.props,t=e.verificationRequest;if(!this._shouldRender(e,t))return null;const s=le.a.get().getUserId();let n;if(t.done)n=Object(c.a)("You verified %(name)s",{name:yr(t.otherUserId,e)});else if(t.cancelled){const i=t.cancellingUserId;n=i===s?Object(c.a)("You cancelled verifying %(name)s",{name:yr(t.otherUserId,e)}):Object(c.a)("%(name)s cancelled verifying",{name:yr(i,e)})}if(n){const s=M()("mx_cryptoEvent mx_cryptoEvent_icon",{mx_cryptoEvent_icon_verified:t.done});return a.a.createElement(hr.a,{className:s,title:n,subtitle:_r(t.otherUserId,e.getRoomId())})}return null}})||Ef;var wf;Sf.propTypes={mxEvent:wt.a.object.isRequired};let Cf=Object(P.a)("views.messages.MStickerBody")(wf=class extends yf{onClick(e){e.preventDefault(),this.state.showImage||this.showImage()}wrapImage(e,t){let s=null;this.state.showImage||(s=this.onClick);return[a.a.createElement("div",{className:"mx_MStickerBody_wrapper",onClick:s}," ",t," "),this.props.scBubbleGroupTimestamp]}getPlaceholder(){return a.a.createElement("img",{src:s(1295),width:"75",height:"75"})}getTooltip(){const e=this.props.mxEvent&&this.props.mxEvent.getContent();if(!(e&&e.body&&e.info&&e.info.w))return null;const t=d.getComponent("elements.Tooltip");return a.a.createElement("div",{style:{left:e.info.w+"px"},className:"mx_MStickerBody_tooltip"},a.a.createElement(t,{label:e.body}))}getFileBody(){return null}})||wf;var kf,Of,Rf,If=s(407);const xf=({mxEvent:e,getTile:t,getReplyThread:s,permalinkCreator:n,onFocusChange:r})=>{const[l,u,h,m]=Object(i.q)(),[p,g,v]=Object(ie.e)(u);let f;if(Object(o.useEffect)(()=>{r(l)},[r,l]),l){const o=d.getComponent("context_menus.MessageContextMenu"),r=t&&t(),c=s&&s(),l=u.current.getBoundingClientRect();f=a.a.createElement(o,ue()({},Object(i.k)(l),{mxEvent:e,permalinkCreator:n,eventTileOps:r&&r.getEventTileOps?r.getEventTileOps():void 0,collapseReplyThread:c&&c.canCollapse()?c.collapse:void 0,onFinished:m}))}return a.a.createElement(a.a.Fragment,null,a.a.createElement(i.d,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_optionsButton",title:Object(c.a)("Options"),onClick:h,isExpanded:l,inputRef:v,onFocus:p,tabIndex:g?0:-1}),f)},Tf=({mxEvent:e,reactions:t,onFocusChange:s})=>{const[n,r,l,u]=Object(i.q)(),[h,m,p]=Object(ie.e)(r);let g;if(Object(o.useEffect)(()=>{s(n)},[s,n]),n){const s=r.current.getBoundingClientRect(),n=d.getComponent("emojipicker.ReactionPicker");g=a.a.createElement(i.b,ue()({},Object(i.k)(s),{onFinished:u,managed:!1}),a.a.createElement(n,{mxEvent:e,reactions:t,onFinished:u}))}return a.a.createElement(a.a.Fragment,null,a.a.createElement(i.d,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_reactButton",title:Object(c.a)("React"),onClick:l,isExpanded:n,inputRef:p,onFocus:h,tabIndex:m?0:-1}),g)};let jf=Object(P.a)("views.messages.MessageActionBar")((Rf=Of=class extends a.a.PureComponent{constructor(...e){super(...e),x()(this,"onDecrypted",()=>{this.forceUpdate()}),x()(this,"onBeforeRedaction",()=>{this.forceUpdate()}),x()(this,"onSent",()=>{this.forceUpdate()}),x()(this,"onFocusChange",e=>{this.props.onFocusChange&&this.props.onFocusChange(e)}),x()(this,"onReplyClick",e=>{u.a.dispatch({action:"reply_to_event",event:this.props.mxEvent})}),x()(this,"onEditClick",e=>{u.a.dispatch({action:"edit_event",event:this.props.mxEvent})}),x()(this,"onResendClick",e=>{this.runActionOnFailedEv(e=>If.a.resend(e))}),x()(this,"onCancelClick",e=>{this.runActionOnFailedEv(e=>If.a.removeFromQueue(e),e=>Object(jp.a)(e.status))})}componentDidMount(){this.props.mxEvent.status&&this.props.mxEvent.status!==km.a.SENT&&this.props.mxEvent.on("Event.status",this.onSent);le.a.get().decryptEventIfNeeded(this.props.mxEvent),this.props.mxEvent.isBeingDecrypted()&&this.props.mxEvent.once("Event.decrypted",this.onDecrypted),this.props.mxEvent.on("Event.beforeRedaction",this.onBeforeRedaction)}componentWillUnmount(){this.props.mxEvent.off("Event.status",this.onSent),this.props.mxEvent.off("Event.decrypted",this.onDecrypted),this.props.mxEvent.off("Event.beforeRedaction",this.onBeforeRedaction)}runActionOnFailedEv(e,t){t||(t=()=>!0);const s=this.props.mxEvent,n=s.replacingEvent(),i=[s.localRedactionEvent(),n,s];for(const s of i)if(s&&t(s)){e(s);break}}render(){const e=[];Object(Oc.a)(this.props.mxEvent)&&e.push(a.a.createElement(ie.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_editButton",title:Object(c.a)("Edit"),onClick:this.onEditClick,key:"edit"}));const t=a.a.createElement(ie.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_cancelButton",title:Object(c.a)("Delete"),onClick:this.onCancelClick,key:"cancel"}),s=this.props.mxEvent,n=s.replacingEvent()&&s.replacingEvent().status,i=s.localRedactionEvent()&&s.localRedactionEvent().status,o=Object(jp.a)(s.status)||Object(jp.a)(n)||Object(jp.a)(i),r=[s.status,n,i].includes("not_sent");return o&&r?(e.splice(0,0,a.a.createElement(ie.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_resendButton",title:Object(c.a)("Retry"),onClick:this.onResendClick,key:"resend"})),e.push(t)):(Object(Oc.c)(this.props.mxEvent)&&(this.context.canReply&&e.splice(0,0,a.a.createElement(ie.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_replyButton",title:Object(c.a)("Reply"),onClick:this.onReplyClick,key:"reply"})),this.context.canReact&&e.splice(0,0,a.a.createElement(Tf,{mxEvent:this.props.mxEvent,reactions:this.props.reactions,onFocusChange:this.onFocusChange,key:"react"}))),o&&e.push(t),e.push(a.a.createElement(xf,{mxEvent:this.props.mxEvent,getReplyThread:this.props.getReplyThread,getTile:this.props.getTile,permalinkCreator:this.props.permalinkCreator,onFocusChange:this.onFocusChange,key:"menu"}))),a.a.createElement(ft,{className:"mx_MessageActionBar","aria-label":Object(c.a)("Message Actions"),"aria-live":"off"},e)}},x()(Of,"propTypes",{mxEvent:wt.a.object.isRequired,reactions:wt.a.object,permalinkCreator:wt.a.object,getTile:wt.a.func,getReplyThread:wt.a.func,onFocusChange:wt.a.func}),x()(Of,"contextType",cm.a),kf=Rf))||kf;var Nf,Pf,Df,Af=s(589);let Mf=Object(P.a)("views.messages.MjolnirBody")((Df=Pf=class extends a.a.Component{constructor(){super(),x()(this,"_onAllowClick",e=>{e.preventDefault(),e.stopPropagation();const t=`mx_mjolnir_render_${this.props.mxEvent.getRoomId()}__${this.props.mxEvent.getId()}`;localStorage.setItem(t,"true"),this.props.onMessageAllowed()})}render(){return a.a.createElement("div",{className:"mx_MjolnirBody"},a.a.createElement("i",null,Object(c.a)("You have ignored this user, so their message is hidden. <a>Show anyways.</a>",{},{a:e=>a.a.createElement("a",{href:"#",onClick:this._onAllowClick},e)})))}},x()(Pf,"propTypes",{mxEvent:wt.a.object.isRequired,onMessageAllowed:wt.a.func.isRequired}),Nf=Df))||Nf;var Uf,Lf,Ff;let Bf=Object(P.a)("views.messages.RoomAvatarEvent")((Ff=Lf=class extends a.a.Component{constructor(...e){super(...e),x()(this,"onAvatarClick",()=>{const e=le.a.get(),t=this.props.mxEvent,s=Object(pe.b)(t.getContent().url).srcHttp,n=e.getRoom(this.props.mxEvent.getRoomId()),i=Object(c.a)("%(senderDisplayName)s changed the avatar for %(roomName)s",{senderDisplayName:t.sender&&t.sender.name?t.sender.name:t.getSender(),roomName:n?n.name:""}),o=d.getComponent("elements.ImageView"),a={src:s,name:i};Le.a.createDialog(o,a,"mx_Dialog_lightbox",null,!0)})}render(){const e=this.props.mxEvent,t=e.sender&&e.sender.name?e.sender.name:e.getSender(),s=d.getComponent("avatars.RoomAvatar");if(!e.getContent().url||0===e.getContent().url.trim().length)return a.a.createElement("div",{className:"mx_TextualEvent"},Object(c.a)("%(senderDisplayName)s removed the room avatar.",{senderDisplayName:t}));const n=le.a.get().getRoom(e.getRoomId()),i={avatarUrl:e.getContent().url,name:n?n.name:""};return a.a.createElement("div",{className:"mx_RoomAvatarEvent"},Object(c.a)("%(senderDisplayName)s changed the room avatar to <img/>",{senderDisplayName:t},{img:()=>a.a.createElement(g.a,{key:"avatar",className:"mx_RoomAvatarEvent_avatar",onClick:this.onAvatarClick},a.a.createElement(s,{width:14,height:14,oobData:i}))}))}},x()(Lf,"propTypes",{mxEvent:wt.a.object.isRequired}),Uf=Ff))||Uf;var Vf,Kf,Wf;let Gf=Object(P.a)("views.messages.RoomCreate")((Wf=Kf=class extends a.a.Component{constructor(...e){super(...e),x()(this,"_onLinkClicked",e=>{e.preventDefault();const t=this.props.mxEvent.getContent().predecessor;u.a.dispatch({action:"view_room",event_id:t.event_id,highlighted:!0,room_id:t.room_id})})}render(){const e=this.props.mxEvent.getContent().predecessor;if(void 0===e)return a.a.createElement("div",null);const t=le.a.get().getRoom(e.room_id),s=new _l.a(t,e.room_id);s.load();const n=s.forEvent(e.event_id),i=a.a.createElement("a",{href:n,onClick:this._onLinkClicked},Object(c.a)("Click here to see older messages."));return a.a.createElement(hr.a,{className:"mx_CreateEvent",title:Object(c.a)("This room is a continuation of another conversation."),subtitle:i})}},x()(Kf,"propTypes",{mxEvent:wt.a.object.isRequired}),Vf=Wf))||Vf;var qf,Hf,$f,zf=s(1296);let Yf=Object(P.a)("views.messages.TextualEvent")(($f=Hf=class extends a.a.Component{render(){const e=lm.b(this.props.mxEvent,!0);return null==e||0===e.length?null:a.a.createElement("div",{className:"mx_TextualEvent"},e)}},x()(Hf,"propTypes",{mxEvent:wt.a.object.isRequired}),qf=$f))||qf;var Jf;let Qf=Object(P.a)("views.messages.TileErrorBoundary")(Jf=class extends a.a.Component{constructor(e){super(e),x()(this,"_onBugReport",()=>{const e=d.getComponent("dialogs.BugReportDialog");e&&Le.a.createTrackedDialog("Bug Report Dialog","",e,{label:"react-soft-crash-tile"})}),this.state={error:null}}static getDerivedStateFromError(e){return{error:e}}render(){if(this.state.error){const{mxEvent:e}=this.props,t={mx_EventTile:!0,mx_EventTile_info:!0,mx_EventTile_content:!0,mx_EventTile_tileError:!0};let s;return l.a.get().bug_report_endpoint_url&&(s=a.a.createElement("a",{onClick:this._onBugReport,href:"#"},Object(c.a)("Submit logs"))),a.a.createElement("div",{className:M()(t)},a.a.createElement("div",{className:"mx_EventTile_line"},a.a.createElement("span",null,Object(c.a)("Can't load this message"),e&&` (${e.getType()})`,s)))}return this.props.children}})||Jf;var Xf,Zf,eb,tb=s(590);let sb=Object(P.a)("views.messages.ViewSourceEvent")((eb=Zf=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"onToggle",e=>{e.preventDefault();const{expanded:t}=this.state;this.setState({expanded:!t})}),this.state={expanded:!1}}componentDidMount(){const{mxEvent:e}=this.props;le.a.get().decryptEventIfNeeded(e),e.isBeingDecrypted()&&e.once("Event.decrypted",()=>this.forceUpdate())}render(){const{mxEvent:e}=this.props,{expanded:t}=this.state;let s;s=t?a.a.createElement("pre",null,JSON.stringify(e,null,4)):a.a.createElement("code",null,`{ "type": ${e.getType()} }`);const n=M()("mx_ViewSourceEvent mx_EventTile_content",{mx_ViewSourceEvent_expanded:t});return a.a.createElement("span",{className:n},s,a.a.createElement("a",{className:"mx_ViewSourceEvent_toggle",href:"#",onClick:this.onToggle}))}},x()(Zf,"propTypes",{mxEvent:wt.a.object.isRequired}),Xf=eb))||Xf;var nb,ib,ob;const ab=/\+\S+:\S+/;let rb=Object(P.a)("views.room_settings.RelatedGroupSettings")((ob=ib=class extends a.a.Component{constructor(e){super(e),x()(this,"onNewGroupChanged",e=>{this.setState({newGroupId:e})}),x()(this,"onGroupAdded",e=>{if(0===e.length||!this.validateGroupId(e))return;const t=[...this.state.newGroupsList,e];this.setState({newGroupsList:t,newGroupId:""}),this.updateGroups(t)}),x()(this,"onGroupDeleted",e=>{const t=this.state.newGroupsList[e],s=this.state.newGroupsList.filter(e=>e!==t);this.setState({newGroupsList:s}),this.updateGroups(s)}),this.state={newGroupId:"",newGroupsList:e.relatedGroupsEvent&&e.relatedGroupsEvent.getContent().groups||[]}}updateGroups(e){this.context.sendStateEvent(this.props.roomId,"m.room.related_groups",{groups:e},"").catch(e=>{console.error(e),Le.a.createTrackedDialog("Error updating flair","",Xe.a,{title:Object(c.a)("Error updating flair"),description:Object(c.a)("There was an error updating the flair for this room. The server may not allow it or a temporary error occurred.")})})}validateGroupId(e){if(!ab.test(e)){const t=d.getComponent("dialogs.ErrorDialog");return Le.a.createTrackedDialog("Invalid related community ID","",t,{title:Object(c.a)("Invalid community ID"),description:Object(c.a)("'%(groupId)s' is not a valid community ID",{groupId:e})}),!1}return!0}render(){const e=this.context.getDomain(),t=d.getComponent("elements.EditableItemList");return a.a.createElement("div",null,a.a.createElement(t,{id:"relatedGroups",items:this.state.newGroupsList,className:"mx_RelatedGroupSettings",newItem:this.state.newGroupId,canRemove:this.props.canSetRelatedGroups,canEdit:this.props.canSetRelatedGroups,onNewItemChanged:this.onNewGroupChanged,onItemAdded:this.onGroupAdded,onItemRemoved:this.onGroupDeleted,itemsLabel:Object(c.a)("Showing flair for these communities:"),noItemsLabel:Object(c.a)("This room is not showing flair for any communities"),placeholder:Object(c.a)("New community ID (e.g. +foo:%(localDomain)s)",{localDomain:e})}))}},x()(ib,"propTypes",{roomId:wt.a.string.isRequired,canSetRelatedGroups:wt.a.bool.isRequired,relatedGroupsEvent:wt.a.instanceOf(km.b)}),x()(ib,"contextType",b.a),x()(ib,"defaultProps",{canSetRelatedGroups:!1}),nb=ob))||nb;var cb,lb,db,ub=s(725);let hb=Object(P.a)("views.room_settings.UrlPreviewSettings")((db=lb=class extends a.a.Component{constructor(...e){super(...e),x()(this,"_onClickUserSettings",e=>{e.preventDefault(),e.stopPropagation(),u.a.fire(h.a.ViewUserSettings)})}render(){const e=d.getComponent("elements.SettingsFlag"),t=this.props.room.roomId,s=le.a.get().isRoomEncrypted(t);let n=null,i=null;if(s)n=Object(c.a)("In encrypted rooms, like this one, URL previews are disabled by default to ensure that your homeserver (where the previews are generated) cannot gather information about links you see in this room.");else{if(n=V.b.getValueAt(Ye.a.ACCOUNT,"urlPreviewsEnabled")?Object(c.a)("You have <a>enabled</a> URL previews by default.",{},{a:e=>a.a.createElement("a",{onClick:this._onClickUserSettings,href:""},e)}):Object(c.a)("You have <a>disabled</a> URL previews by default.",{},{a:e=>a.a.createElement("a",{onClick:this._onClickUserSettings,href:""},e)}),V.b.canSetValue("urlPreviewsEnabled",t,"room"))i=a.a.createElement("label",null,a.a.createElement(e,{name:"urlPreviewsEnabled",level:Ye.a.ROOM,roomId:t,isExplicit:!0}));else{let e=Object(c.b)("URL previews are enabled by default for participants in this room.");V.b.getValueAt(Ye.a.ROOM,"urlPreviewsEnabled",t,!0)||(e=Object(c.b)("URL previews are disabled by default for participants in this room.")),i=a.a.createElement("label",null,Object(c.a)(e))}}const o=a.a.createElement(e,{name:s?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled",level:Ye.a.ROOM_ACCOUNT,roomId:t});return a.a.createElement("div",null,a.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("When someone puts a URL in their message, a URL preview can be shown to give more information about that link such as the title, description, and an image from the website.")),a.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},n),i,a.a.createElement("label",null,o))}},x()(lb,"propTypes",{room:wt.a.object}),cb=db))||cb;var mb=s(746);function pb(e,t){const s=Math.min(e.length,t.length);for(let n=0;n<s;++n)if(e[n]!==t[n])return n;return s}function gb(e,t,s){const n=s-(t.length-e.length);return function(e,t){const s=Math.min(e.length,t.length),n=e.substr(0,s)===t.substr(0,s);if(n&&e.length>t.length)return{removed:e.substr(s),at:s};if(n&&e.length<t.length)return{added:t.substr(s),at:s};{const s=pb(e,t);return{removed:e.substr(s),added:t.substr(s),at:s}}}(e.substr(0,n),t.substr(0,s))}class vb{constructor(e,t){this.index=e,this.offset=t}compare(e){return this.index===e.index?this.offset-e.offset:this.index-e.index}iteratePartsBetween(e,t,s){if(-1===this.index||-1===e.index)return;const[n,i]=this.compare(e)<0?[this,e]:[e,this];if(n.index===i.index)s(t.parts[this.index],n.offset,i.offset);else{const e=t.parts[n.index];s(e,n.offset,e.text.length);for(let e=n.index+1;e<i.index;++e){const n=t.parts[e];s(n,0,n.text.length)}s(t.parts[i.index],0,i.offset)}}forwardsWhile(e,t){if(-1===this.index)return this;let{index:s,offset:n}=this;const{parts:i}=e;for(;s<i.length;){const e=i[s];for(;n<e.text.length;){if(!t(s,n,e))return new vb(s,n);n+=1}if(s===i.length-1)return new vb(s,n);s+=1,n=0}}backwardsWhile(e,t){if(-1===this.index)return this;let{index:s,offset:n}=this;const i=e.parts;for(;s>=0;){const e=i[s];for(;n>0;){if(!t(s,n-1,e))return new vb(s,n);n-=1}if(0===s)return new vb(s,n);s-=1,n=i[s].text.length}}asOffset(e){if(-1===this.index)return new xd(0,!0);let t=0;for(let s=0;s<this.index;++s)t+=e.parts[s].text.length;t+=this.offset;const s=e.parts[this.index],n=!s||t>=s.text.length;return new xd(t,n)}isAtEnd(e){if(0===e.parts.length)return!0;const t=e.parts.length-1,s=e.parts[t];return this.index===t&&this.offset===s.text.length}isAtStart(){return 0===this.index&&0===this.offset}}class fb{constructor(e,t,s=null){this.updateCallback=s,x()(this,"_parts",void 0),x()(this,"_partCreator",void 0),x()(this,"activePartIdx",null),x()(this,"_autoComplete",null),x()(this,"autoCompletePartIdx",null),x()(this,"autoCompletePartCount",0),x()(this,"transformCallback",null),x()(this,"onAutoComplete",({replaceParts:e,close:t})=>{let s;if(e){this._parts.splice(this.autoCompletePartIdx,this.autoCompletePartCount,...e),this.autoCompletePartCount=e.length;const t=e[e.length-1],n=this.autoCompletePartIdx+e.length-1;s=new vb(n,t.text.length)}t&&(this._autoComplete=null,this.autoCompletePartIdx=null,this.autoCompletePartCount=0),this.updateCallback(s)}),this._parts=e,this._partCreator=t,this.transformCallback=null}setTransformCallback(e){this.transformCallback=e}setUpdateCallback(e){this.updateCallback=e}get partCreator(){return this._partCreator}get isEmpty(){return 0===this._parts.reduce((e,t)=>e+t.text.length,0)}clone(){return new fb(this._parts,this._partCreator,this.updateCallback)}insertPart(e,t){this._parts.splice(e,0,t),this.activePartIdx>=e&&++this.activePartIdx,this.autoCompletePartIdx>=e&&++this.autoCompletePartIdx}removePart(e){this._parts.splice(e,1),e===this.activePartIdx?this.activePartIdx=null:this.activePartIdx>e&&--this.activePartIdx,e===this.autoCompletePartIdx?this.autoCompletePartIdx=null:this.autoCompletePartIdx>e&&--this.autoCompletePartIdx}replacePart(e,t){this._parts.splice(e,1,t)}get parts(){return this._parts}get autoComplete(){return this.activePartIdx===this.autoCompletePartIdx?this._autoComplete:null}getPositionAtEnd(){if(this._parts.length){const e=this._parts.length-1,t=this._parts[e];return new vb(e,t.text.length)}return new vb(-1,0)}serializeParts(){return this._parts.map(e=>e.serialize())}diff(e,t,s){const n=this.parts.reduce((e,t)=>e+t.text,"");return"deleteByDrag"===t?function(e,t){if(e===t)return{};const s=pb(e,t),n=e.length-t.length;return{at:s,removed:e.substr(s,n)}}(n,e):gb(n,e,s.offset)}reset(e,t,s){this._parts=e.map(e=>this._partCreator.deserializePart(e)),t||(t=this.getPositionAtEnd()),this._autoComplete&&(this._autoComplete=null,this.autoCompletePartIdx=null),this.updateCallback(t,s)}insert(e,t){const s=this.splitAt(t);let n=0;for(let t=0;t<e.length;++t){const i=e[t];n+=i.text.length,this.insertPart(s+t,i)}return n}update(e,t,s){const n=this.diff(e,t,s),i=this.positionForOffset(n.at,s.atNodeEnd);let o=0;n.removed&&(o=this.removeText(i,n.removed.length));let a=0;n.added&&(a=this.addText(i,n.added,t)),this.mergeAdjacentParts();const r=n.at-o+a;let c=this.positionForOffset(r,!0);const l="insertFromPaste"!==t&&"insertFromDrop"!==t,d=this.setActivePart(c,l);if(this.transformCallback){const e=this.getTransformAddedLen(c,t,n);c=this.positionForOffset(r+e,!0)}return this.updateCallback(c,t,n),d}getTransformAddedLen(e,t,s){const n=this.transformCallback(e,t,s);return Number.isFinite(n)?n:0}setActivePart(e,t){const{index:s}=e,n=this._parts[s];if(n){if(s!==this.activePartIdx&&(this.activePartIdx=s,t&&this.activePartIdx!==this.autoCompletePartIdx)){const e=n.createAutoComplete(this.onAutoComplete);e&&(this._autoComplete=e,this.autoCompletePartIdx=s,this.autoCompletePartCount=1)}if(this.autoComplete)return this.autoComplete.onPartUpdate(n,e)}else this.activePartIdx=null,this._autoComplete=null,this.autoCompletePartIdx=null,this.autoCompletePartCount=0;return Promise.resolve()}mergeAdjacentParts(){let e;for(let t=0;t<this._parts.length;++t){let s=this._parts[t];const n=!s.text.length,i=!n&&e&&e.merge(s);(n||i)&&(s=e,this.removePart(t),--t),e=s}}removeText(e,t){let{index:s,offset:n}=e,i=0;for(;t>0;){let e=this._parts[s];const o=Math.min(t,e.text.length-n);if(o)if(e.canEdit){const t=e.remove(n,o);"string"==typeof t&&this.replacePart(s,this._partCreator.createDefaultPart(t)),e=this._parts[s],e.text.length?s+=1:this.removePart(s)}else i+=n,this.removePart(s);else s+=1;t-=o,n=0}return i}splitAt(e){if(-1===e.index)return 0;if(0===e.offset)return e.index;const t=this._parts[e.index];if(e.offset>=t.text.length)return e.index+1;const s=t.split(e.offset);return this.insertPart(e.index+1,s),e.index+1}addText(e,t,s){let{index:n}=e;const{offset:i}=e;let o=t.length;const a=this._parts[n];if(a)if(a.canEdit)if(a.validateAndInsert(i,t,s))t=null;else{const e=a.split(i);n+=1,this.insertPart(n,e)}else 0!==i&&(o+=a.text.length-i,n+=1);else n<0&&(n=0);for(;t;){const e=this._partCreator.createPartForInput(t,n,s);t=e.appendUntilRejected(t,s),this.insertPart(n,e),n+=1}return o}positionForOffset(e,t=!1){let s=0;const n=this._parts.findIndex(n=>{const i=n.text.length;return!!(t&&s+i>=e||!t&&s+i>e)||(s+=i,!1)});return-1===n?this.getPositionAtEnd():new vb(n,e-s)}startRange(e,t=e){return new yd(this,e,t)}replaceRange(e,t,s){const n=t.asOffset(this),i=this.splitAt(e);t=n.asPosition(this);for(let e=this.splitAt(t)-1;e>=i;--e)this.removePart(e);let o=i;for(const e of s)this.insertPart(o,e),o+=1;this.mergeAdjacentParts()}transform(e){const t=e();let s=null;return s=t instanceof yd?Promise.resolve():this.setActivePart(t,!0),this.updateCallback(t),s}}var bb=s(375),yb=s(503),_b=s.n(yb);function Eb(e,{forceHTML:t=!1}={}){let s=function(e){return e.parts.reduce((e,t)=>{switch(t.type){case"newline":return e+"\n";case"plain":case"command":case"pill-candidate":case"at-room-pill":return e+t.text;case"room-pill":return e+`[${t.resourceId.replace(/[[\\\]]/g,e=>"\\"+e)}](${Object(_l.e)(t.resourceId)})`;case"user-pill":return e+`[${t.text.replace(/[[\\\]]/g,e=>"\\"+e)}](${Object(_l.e)(t.resourceId)})`}},"")}(e);const n=s;if(V.b.getValue("feature_latex_maths")){const e=["display","inline"],t={tex:{display:"(^)\\$\\$(([^$]|\\\\\\$)+?)\\$\\$$",inline:"(^|\\s|[.,!?:;])(?!\\\\)\\$(?!\\s)(([^$\\n]|\\\\\\$)*([^\\\\\\s\\$]|\\\\\\$)(?:\\\\\\$)?)\\$"},latex:{display:"(^)\\\\\\[(?!\\\\\\])(.*?)\\\\\\]$",inline:"(^|[^\\\\])\\\\\\((?!\\\\\\))(.*?)\\\\\\)"}};["tex","latex"].forEach((function(n){e.forEach((function(e){const i=(((l.a.get().latex_maths_delims||{})[e]||{}).pattern||{})[n]||t[n][e];s=s.replace(RegExp(i,"gms"),(function(t,s,n){const i=bb.AllHtmlEntities.encode(n);switch(e){case"display":return`${s}<div data-mx-maths="${i}">\n\n</div>\n\n`;case"inline":return`${s}<span data-mx-maths="${i}"></span>`}}))}))})),s=s.replace(/(.)<div/g,(function(e,t){return t+"\n<div"}))}const i=new Io(s);if(!i.isPlainText()||t){const e=_b.a.load(i.toHTML(),{_useHtmlParser2:!0,decodeEntities:!1});if(V.b.getValue("feature_latex_maths")){const t=new Io(n),s=_b.a.load(t.toHTML(),{_useHtmlParser2:!0,decodeEntities:!1});s("code").each((function(t){e("code").eq(t).text(s("code").eq(t).text())})),e("div, span").each((function(t,s){const n=e(s).attr("data-mx-maths");n&&e(s).html(`<code>${n}</code>`)}))}return e.html()}if(s.indexOf("\\")>-1)return i.toPlaintext()}function Sb(e){return e.parts.reduce((e,t)=>{switch(t.type){case"newline":return e+"\n";case"plain":case"command":case"pill-candidate":case"at-room-pill":return e+t.text;case"room-pill":return e+""+t.resourceId;case"user-pill":return e+""+t.text}},"")}function wb(e){return Cb(e,"/me ",!1)}function Cb(e,t,s=!0){const n=e.parts[0];let i=n&&n.text;return s||(t=t.toLowerCase(),i=i.toLowerCase()),n&&("plain"===n.type||"command"===n.type)&&i.startsWith(t)}function kb(e){return Ob(e,"/me ")}function Ob(e,t){return(e=e.clone()).removeText({index:0,offset:0},t.length),e}var Rb,Ib,xb,Tb=s(721);class jb{constructor(e,t){x()(this,"history",[]),x()(this,"prefix",void 0),x()(this,"lastIndex",0),x()(this,"currentIndex",0),this.prefix=t+e;let s,n=0;for(;s=sessionStorage.getItem(`${this.prefix}[${n}]`);){try{this.history.push(JSON.parse(s))}catch(e){console.warn("Throwing away unserialisable history",e);break}++n}this.lastIndex=this.history.length-1,this.currentIndex=this.lastIndex+1}static createItem(e,t){return{parts:e.serializeParts(),replyEventId:t?t.getId():void 0}}save(e,t){const s=jb.createItem(e,t);this.history.push(s),this.currentIndex=this.history.length,this.lastIndex+=1,sessionStorage.setItem(`${this.prefix}[${this.lastIndex}]`,JSON.stringify(s))}getItem(e){return this.currentIndex=Object(li.clamp)(this.currentIndex+e,0,this.history.length-1),this.history[this.currentIndex]}}function Nb(e,t){const s=wb(e);s&&(e=kb(e));const n=function(e){const t=e.getContent()["m.relates_to"];return!(!t||!t["m.in_reply_to"])}(t);let i="",o="";n&&(i=function(e){const t=e.getContent().body.split("\n").map(e=>e.trim());return t.length>2&&t[0].startsWith("> ")&&0===t[1].length?t[0]+"\n\n":""}(t),o=function(e){const t=e.getContent().formatted_body;if(!t)return"";const s=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return s&&s.outerHTML||""}(t));const a=Sb(e),r={msgtype:s?"m.emote":"m.text",body:a},c={msgtype:r.msgtype,body:`${i} * ${a}`},l=Eb(e,{forceHTML:n});return l&&(r.format="org.matrix.custom.html",r.formatted_body=l,c.format=r.format,c.formatted_body=`${o} * ${l}`),Object.assign({"m.new_content":r,"m.relates_to":{rel_type:"m.replace",event_id:t.getId()}},c)}let Pb=Object(P.a)("views.rooms.EditMessageComposer")((xb=Ib=class extends a.a.Component{constructor(e,t){super(e,t),x()(this,"_setEditorRef",e=>{this._editorRef=e}),x()(this,"_onKeyDown",e=>{if(this._editorRef.isComposing(e))return;switch(Object(Mt.f)().getMessageComposerAction(e)){case Mt.b.Send:this._sendEdit(),e.preventDefault();break;case Mt.b.CancelEditing:this._cancelEdit();break;case Mt.b.EditPrevMessage:{if(this._editorRef.isModified()||!this._editorRef.isCaretAtStart())return;const t=Object(Oc.b)(this._getRoom(),!1,this.props.editState.getEvent().getId());t&&(u.a.dispatch({action:"edit_event",event:t}),e.preventDefault());break}case Mt.b.EditNextMessage:{if(this._editorRef.isModified()||!this._editorRef.isCaretAtEnd())return;const t=Object(Oc.b)(this._getRoom(),!0,this.props.editState.getEvent().getId());t?u.a.dispatch({action:"edit_event",event:t}):(this._clearStoredEditorState(),u.a.dispatch({action:"edit_event",event:null}),u.a.fire(h.a.FocusComposer)),e.preventDefault();break}}}),x()(this,"_cancelEdit",()=>{this._clearStoredEditorState(),u.a.dispatch({action:"edit_event",event:null}),u.a.fire(h.a.FocusComposer)}),x()(this,"_sendEdit",async()=>{const e=E.a.getTimestamp(),t=this.props.editState.getEvent(),s=Nb(this.model,t),n=s["m.new_content"];let i=!0;if(this._isContentModified(n)){const n=t.getRoomId();if(!wb(this.model)&&this._isSlashCommand()){const[e,t,o]=this._getSlashCommand();if(e)e.category===Tl.messages?s["m.new_content"]=await this._runSlashCommand(e,t,n):(this._runSlashCommand(e,t,n),i=!1);else{const e=d.getComponent("dialogs.QuestionDialog"),{finished:t}=Le.a.createTrackedDialog("Unknown command","",e,{title:Object(c.a)("Unknown Command"),description:a.a.createElement("div",null,a.a.createElement("p",null,Object(c.a)("Unrecognised command: %(commandText)s",{commandText:o})),a.a.createElement("p",null,Object(c.a)("You can use <code>/help</code> to list available commands. Did you mean to send this as a message?",{},{code:e=>a.a.createElement("code",null,e)})),a.a.createElement("p",null,Object(c.a)("Hint: Begin your message with <code>//</code> to start it with a slash.",{},{code:e=>a.a.createElement("code",null,e)}))),button:Object(c.a)("Send as message")}),[s]=await t;if(!s)return}}if(i){this._cancelPreviousPendingEdit();const t=this.context.sendMessage(n,s);this._clearStoredEditorState(),u.a.dispatch({action:"message_sent"}),E.a.instance.trackSendMessage(e,t,n,!0,!1,s)}}u.a.dispatch({action:"edit_event",event:null}),u.a.fire(h.a.FocusComposer)}),x()(this,"_onChange",()=>{this.state.saveDisabled&&this._editorRef&&this._editorRef.isModified()&&this.setState({saveDisabled:!1})}),x()(this,"onAction",e=>{"edit_composer_insert"===e.action&&this._editorRef&&(e.userId?this._editorRef.insertMention(e.userId):e.event?this._editorRef.insertQuotedMessage(e.event):e.text&&this._editorRef.insertPlaintext(e.text))}),this.model=null,this._editorRef=null,this.state={saveDisabled:!0},this._createEditorModel(),window.addEventListener("beforeunload",this._saveStoredEditorState),this.dispatcherRef=u.a.register(this.onAction)}_getRoom(){return this.context.getRoom(this.props.editState.getEvent().getRoomId())}get _editorRoomKey(){return"mx_edit_room_"+this._getRoom().roomId}get _editorStateKey(){return"mx_edit_state_"+this.props.editState.getEvent().getId()}get _shouldSaveStoredEditorState(){return null!==localStorage.getItem(this._editorRoomKey)}_restoreStoredEditorState(e){const t=localStorage.getItem(this._editorStateKey);if(t)try{const{parts:s}=JSON.parse(t);return s.map(t=>e.deserializePart(t))}catch(e){console.error("Error parsing editing state: ",e)}}_clearStoredEditorState(){localStorage.removeItem(this._editorRoomKey),localStorage.removeItem(this._editorStateKey)}_clearPreviousEdit(){localStorage.getItem(this._editorRoomKey)&&localStorage.removeItem("mx_edit_state_"+localStorage.getItem(this._editorRoomKey))}_saveStoredEditorState(){const e=jb.createItem(this.model);this._clearPreviousEdit(),localStorage.setItem(this._editorRoomKey,this.props.editState.getEvent().getId()),localStorage.setItem(this._editorStateKey,JSON.stringify(e))}_isSlashCommand(){const e=this.model.parts[0];if(e){if("command"===e.type&&e.text.startsWith("/")&&!e.text.startsWith("//"))return!0;if(e.text.startsWith("/")&&!e.text.startsWith("//")&&("plain"===e.type||"pill-candidate"===e.type))return!0}return!1}_isContentModified(e){const t=this.props.editState.getEvent().getContent();return!(!this._editorRef.isModified()||t.msgtype===e.msgtype&&t.body===e.body&&t.format===e.format&&t.formatted_body===e.formatted_body)}_getSlashCommand(){const e=this.model.parts.reduce((e,t)=>"user-pill"===t.type?e+t.resourceId:e+t.text,""),{cmd:t,args:s}=Ll(e);return[t,s,e]}async _runSlashCommand(e,t,s){const n=e.run(s,t);let i,o=n.error;if(n.promise)try{e.category===Tl.messages?i=await n.promise:await n.promise}catch(e){o=e}if(o){console.error("Command failure: %s",o);const e=d.getComponent("dialogs.ErrorDialog"),t=!!n.promise?Object(c.b)("Server error"):Object(c.b)("Command error");let s;s="string"==typeof o?o:o.message?o.message:Object(c.a)("Server unavailable, overloaded, or something else went wrong."),Le.a.createTrackedDialog(t,"",e,{title:Object(c.a)(t),description:s})}else if(console.log("Command success."),i)return i}_cancelPreviousPendingEdit(){const e=this.props.editState.getEvent().replacingEvent();!e||e.status!==km.a.QUEUED&&e.status!==km.a.NOT_SENT||this.context.cancelPendingEvent(e)}componentWillUnmount(){const e=document.getSelection();let t;e.focusNode&&(t=jd(this._editorRef,e).caret);const s=this.model.serializeParts();this.props.editState.setEditorState(t,s),window.removeEventListener("beforeunload",this._saveStoredEditorState),this._shouldSaveStoredEditorState&&this._saveStoredEditorState(),u.a.unregister(this.dispatcherRef)}_createEditorModel(){const{editState:e}=this.props,t=this._getRoom(),s=new Hd(t,this.context);let n;n=e.hasEditorState()?e.getSerializedParts().map(e=>s.deserializePart(e)):this._restoreStoredEditorState(s)||Zd(e.getEvent(),s),this.model=new fb(n,s),this._saveStoredEditorState()}_getInitialCaretPosition(){const{editState:e}=this.props;let t;if(e.hasEditorState()&&e.getCaret()){const s=e.getCaret();t=this.model.positionForOffset(s.offset,s.atNodeEnd)}else t=this.model.getPositionAtEnd();return t}render(){const e=d.getComponent("elements.AccessibleButton");return a.a.createElement("div",{className:M()("mx_EditMessageComposer",this.props.className),onKeyDown:this._onKeyDown},a.a.createElement(hu,{ref:this._setEditorRef,model:this.model,room:this._getRoom(),initialCaret:this.props.editState.getCaret(),label:Object(c.a)("Edit message"),onChange:this._onChange}),a.a.createElement("div",{className:"mx_EditMessageComposer_buttons"},a.a.createElement(e,{kind:"secondary",onClick:this._cancelEdit},Object(c.a)("Cancel")),a.a.createElement(e,{kind:"primary",onClick:this._sendEdit,disabled:this.state.saveDisabled},Object(c.a)("Save"))))}},x()(Ib,"propTypes",{editState:wt.a.instanceOf(Tb.a).isRequired}),x()(Ib,"contextType",b.a),Rb=xb))||Rb;var Db,Ab,Mb,Ub=e=>{const t=M()({mx_JumpToBottomButton:!0,mx_JumpToBottomButton_highlight:e.highlight});let s;return e.numUnreadMessages&&(s=React.createElement("div",{className:"mx_JumpToBottomButton_badge"},e.numUnreadMessages)),React.createElement("div",{className:t},React.createElement(g.a,{className:"mx_JumpToBottomButton_scrollDown",title:Object(c.a)("Scroll to most recent messages"),onClick:e.onScrollToBottomClick}),s)};let Lb=Object(P.a)("views.rooms.LinkPreviewWidget")((Mb=Ab=class extends a.a.Component{constructor(e){super(e),x()(this,"onImageClick",e=>{const t=this.state.preview;if(0!=e.button||e.metaKey)return;e.preventDefault();const s=d.getComponent("elements.ImageView");let n=t["og:image"];n&&n.startsWith("mxc://")&&(n=Object(pe.b)(n).srcHttp);const i={src:n,width:t["og:image:width"],height:t["og:image:height"],name:t["og:title"]||t["og:description"]||this.props.link,fileSize:t["matrix:image:size"],link:this.props.link};Le.a.createDialog(s,i,"mx_Dialog_lightbox",null,!0)}),this.state={preview:null},this.unmounted=!1,le.a.get().getUrlPreview(this.props.link,this.props.mxEvent.getTs()).then(e=>{this.unmounted||this.setState({preview:e},this.props.onHeightChanged)},e=>{console.error("Failed to get URL preview: "+e)}),this._description=Object(o.createRef)()}componentDidMount(){this._description.current&&Object(pn.g)(this._description.current)}componentDidUpdate(){this._description.current&&Object(pn.g)(this._description.current)}componentWillUnmount(){this.unmounted=!0}render(){const e=this.state.preview;if(!e||0===Object.keys(e).length)return a.a.createElement("div",null);let t=e["og:image"];V.b.getValue("showImages")||(t=null);t&&t.startsWith("mxc://")&&(t=Object(pe.b)(t).getThumbnailOfSourceHttp(100,100,"scale"));let n,i=100;e["og:image:width"]&&e["og:image:height"]&&(i=function(e,t,s,n){if(!e||!t)return null;if(e<s&&t<n)return t;const i=s/e,o=n/t;return i<o?Math.floor(i*t):Math.floor(o*t)}(e["og:image:width"],e["og:image:height"],100,100)),t&&(n=a.a.createElement("div",{className:"mx_LinkPreviewWidget_image",style:{height:i}},a.a.createElement("img",{style:{maxWidth:100,maxHeight:100},src:t,onClick:this.onImageClick})));const o=bb.AllHtmlEntities.decode(e["og:description"]||""),r=d.getComponent("elements.AccessibleButton");return a.a.createElement("div",{className:"mx_LinkPreviewWidget",dir:"auto"},n,a.a.createElement("div",{className:"mx_LinkPreviewWidget_caption"},a.a.createElement("div",{className:"mx_LinkPreviewWidget_title"},a.a.createElement("a",{href:this.props.link,target:"_blank",rel:"noreferrer noopener"},e["og:title"])),a.a.createElement("div",{className:"mx_LinkPreviewWidget_siteName"},e["og:site_name"]?" - "+e["og:site_name"]:null),a.a.createElement("div",{className:"mx_LinkPreviewWidget_description",ref:this._description},o)),a.a.createElement(r,{className:"mx_LinkPreviewWidget_cancel",onClick:this.props.onCancelClick,"aria-label":Object(c.a)("Close preview")},a.a.createElement("img",{className:"mx_filterFlipColor",alt:"",role:"presentation",src:s(336),width:"18",height:"18"})))}},x()(Ab,"propTypes",{link:wt.a.string.isRequired,mxEvent:wt.a.object.isRequired,onCancelClick:wt.a.func,onHeightChanged:wt.a.func}),Db=Mb))||Db;class Fb extends a.a.Component{constructor(e){super(e),this.nodes={},this._updateChildren(this.props.children)}componentDidUpdate(){this._updateChildren(this.props.children)}_applyStyles(e,t){Object.entries(t).forEach(([t,s])=>{e.style[t]=s})}_updateChildren(e){const t=this.children||{};this.children={},a.a.Children.toArray(e).forEach(e=>{if(t[e.key]){const s=t[e.key],n=om.a.findDOMNode(this.nodes[s.key]);n&&n.style.left!==e.props.style.left&&this._applyStyles(n,{left:e.props.style.left}),this.children[e.key]=a.a.cloneElement(s,e.props,e.props.children)}else{const t={},s=e.props.style,n=this.props.startStyles;if(n.length>0){const e=n[0];t.style=e}t.ref=t=>this._collectNode(e.key,t,s),this.children[e.key]=a.a.cloneElement(e,t)}})}_collectNode(e,t,s){if(t&&void 0===this.nodes[e]&&this.props.startStyles.length>0){const e=this.props.startStyles,n=om.a.findDOMNode(t);for(let t=1;t<e.length;++t)this._applyStyles(n,e[t]);setTimeout(()=>{this._applyStyles(n,s)},0)}this.nodes[e]=t}render(){return a.a.createElement(a.a.Fragment,null,Object.values(this.children))}}x()(Fb,"propTypes",{children:wt.a.any,transition:wt.a.object,startStyles:wt.a.array}),x()(Fb,"defaultProps",{startStyles:[]});var Bb,Vb,Kb,Wb=s(298);let Gb=Object(P.a)("views.rooms.ReadReceiptMarker")((Kb=Vb=class extends a.a.PureComponent{constructor(e){super(e),this._avatar=Object(o.createRef)(),this.state={suppressDisplay:!this.props.suppressAnimation}}componentWillUnmount(){const e=this.props.readReceiptInfo;if(!e)return;if(this.props.checkUnmounting&&this.props.checkUnmounting())return;const t=this._avatar.current;e.top=t.offsetTop,e.left=t.offsetLeft,e.parent=t.offsetParent}componentDidMount(){this.state.suppressDisplay&&this._animateMarker()}componentDidUpdate(e){const t=e.leftOffset!==this.props.leftOffset,s=e.hidden!==this.props.hidden;(t||s)&&this._animateMarker()}_animateMarker(){let e=-15;const t=this.props.readReceiptInfo;t&&t.parent&&(e=t.top+t.parent.getBoundingClientRect().top);const s=this._avatar.current;let n;s.offsetParent?n=e-s.offsetParent.getBoundingClientRect().top:(console.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} in has no offsetParent`),n=0);const i=[];t&&t.left&&i.push({top:n+"px",left:Object(Wb.a)(t.left)}),i.push({top:n+"px",left:"0"}),this.setState({suppressDisplay:!1,startStyles:i})}render(){const e=d.getComponent("avatars.MemberAvatar");if(this.state.suppressDisplay)return a.a.createElement("div",{ref:this._avatar});const t={left:Object(Wb.a)(this.props.leftOffset),top:"0px"};let s;if(this.props.timestamp){const e=Object(rm.a)(new Date(this.props.timestamp),this.props.showTwelveHour);s=this.props.member&&this.props.fallbackUserId!==this.props.member.rawDisplayName?Object(c.a)("Seen by %(displayName)s (%(userName)s) at %(dateTime)s",{displayName:this.props.member.rawDisplayName,userName:this.props.fallbackUserId,dateTime:e}):Object(c.a)("Seen by %(userName)s at %(dateTime)s",{userName:this.props.fallbackUserId,dateTime:e})}return a.a.createElement(Fb,{startStyles:this.state.startStyles},a.a.createElement(e,{member:this.props.member,fallbackUserId:this.props.fallbackUserId,"aria-hidden":"true",width:14,height:14,resizeMethod:"crop",style:t,title:s,onClick:this.props.onClick,inputRef:this._avatar}))}},x()(Vb,"propTypes",{member:wt.a.object,fallbackUserId:wt.a.string.isRequired,leftOffset:wt.a.number,hidden:wt.a.bool,suppressAnimation:wt.a.bool,readReceiptInfo:wt.a.object,checkUnmounting:wt.a.func,onClick:wt.a.func,timestamp:wt.a.number,showTwelveHour:wt.a.bool}),x()(Vb,"defaultProps",{leftOffset:0}),Bb=Kb))||Bb;var qb,Hb,$b;function zb(e){return e.canonicalAlias||(e.aliases?e.aliases[0]:"")}const Yb=wt.a.shape({name:wt.a.string,topic:wt.a.string,roomId:wt.a.string,avatarUrl:wt.a.string,numJoinedMembers:wt.a.number,canonicalAlias:wt.a.string,aliases:wt.a.arrayOf(wt.a.string),worldReadable:wt.a.bool,guestCanJoin:wt.a.bool});let Jb=Object(P.a)("views.rooms.RoomDetailRow")(($b=Hb=class extends a.a.Component{constructor(e){super(e),x()(this,"onClick",e=>{e.preventDefault(),this.props.onClick&&this.props.onClick(e,this.props.room)}),x()(this,"onTopicClick",e=>{e.stopPropagation()}),this._topic=Object(o.createRef)()}componentDidMount(){this._linkifyTopic()}componentDidUpdate(){this._linkifyTopic()}_linkifyTopic(){this._topic.current&&Object(pn.g)(this._topic.current)}render(){const e=d.getComponent("avatars.BaseAvatar"),t=this.props.room,s=t.name||zb(t)||Object(c.a)("Unnamed room"),n=t.worldReadable?a.a.createElement("div",{className:"mx_RoomDirectory_perm"},Object(c.a)("World readable")):a.a.createElement("div",null),i=t.guestCanJoin?a.a.createElement("div",{className:"mx_RoomDirectory_perm"},Object(c.a)("Guests can join")):a.a.createElement("div",null),o=n||i?a.a.createElement("div",{className:"mx_RoomDirectory_perms"},n," ",i):a.a.createElement("div",null);let r=null;return t.avatarUrl&&(r=Object(pe.b)(t.avatarUrl).getSquareThumbnailHttp(24)),a.a.createElement("tr",{key:t.roomId,onClick:this.onClick,onMouseDown:this.props.onMouseDown},a.a.createElement("td",{className:"mx_RoomDirectory_roomAvatar"},a.a.createElement(e,{width:24,height:24,resizeMethod:"crop",name:s,idName:s,url:r})),a.a.createElement("td",{className:"mx_RoomDirectory_roomDescription"},a.a.createElement("div",{className:"mx_RoomDirectory_name"},s)," ",o,a.a.createElement("div",{className:"mx_RoomDirectory_topic",ref:this._topic,onClick:this.onTopicClick},t.topic),a.a.createElement("div",{className:"mx_RoomDirectory_alias"},zb(t))),a.a.createElement("td",{className:"mx_RoomDirectory_roomMemberCount"},t.numJoinedMembers))}},x()(Hb,"propTypes",{room:Yb,onClick:wt.a.func,onMouseDown:wt.a.func}),qb=$b))||qb;var Qb,Xb,Zb;let ey=Object(P.a)("views.rooms.RoomDetailList")((Zb=Xb=class extends a.a.Component{constructor(...e){super(...e),x()(this,"onDetailsClick",(e,t)=>{u.a.dispatch({action:"view_room",room_id:t.roomId,room_alias:t.canonicalAlias||(t.aliases||[])[0]})})}getRows(){if(!this.props.rooms)return[];const e=d.getComponent("rooms.RoomDetailRow");return this.props.rooms.map((t,s)=>a.a.createElement(e,{key:s,room:t,onClick:this.onDetailsClick}))}render(){let e;return e=0===this.getRows().length?a.a.createElement("i",null,Object(c.a)("No rooms to show")):a.a.createElement("table",{className:"mx_RoomDirectory_table"},a.a.createElement("tbody",null,this.getRows())),a.a.createElement("div",{className:M()("mx_RoomDetailList",this.props.className)},e)}},x()(Xb,"propTypes",{rooms:wt.a.arrayOf(Yb),className:wt.a.string}),Qb=Zb))||Qb;var ty,sy,ny,iy=s(718),oy=s(712),ay=s(715);let ry=Object(P.a)("views.rooms.SearchResultTile")((ny=sy=class extends a.a.Component{render(){const e=d.getComponent("messages.DateSeparator"),t=d.getComponent("rooms.EventTile"),s=this.props.searchResult,n=s.context.getEvent(),i=n.getId(),o=n.getTs(),r=[a.a.createElement(e,{key:o+"-search",ts:o})],c=V.b.getValue("alwaysShowTimestamps"),l=s.context.getTimeline();for(let e=0;e<l.length;e++){const n=l[e];let o;const d=e!=s.context.getOurEventIndex();d||(o=this.props.searchHighlights),Object(fu.b)(n)&&r.push(a.a.createElement(t,{key:`${i}+${e}`,mxEvent:n,contextual:d,highlights:o,permalinkCreator:this.props.permalinkCreator,highlightLink:this.props.resultLink,onHeightChanged:this.props.onHeightChanged,isTwelveHour:V.b.getValue("showTwelveHourTimestamps"),alwaysShowTimestamps:c,enableFlair:V.b.getValue(nt.a.Flair),layout:this.props.layout,singleSideBubbles:this.props.singleSideBubbles}))}return a.a.createElement("li",{"data-scroll-tokens":i},r)}},x()(sy,"propTypes",{searchResult:wt.a.object.isRequired,searchHighlights:wt.a.array,resultLink:wt.a.string,onHeightChanged:wt.a.func}),ty=ny))||ty;var cy,ly,dy,uy=s(248),hy=s(286),my=s(530),py=s.n(my);function gy(e,t,s){const n=uv.a.makeReplyMixIn(t);Object.assign(e,n);const i=uv.a.getNestedReplyText(t,s);i&&(e.formatted_body&&(e.formatted_body=i.html+e.formatted_body),e.body=i.body+e.body)}let vy=Object(P.a)("views.rooms.SendMessageComposer")((dy=ly=class extends a.a.Component{constructor(e,t){super(e,t),x()(this,"_setEditorRef",e=>{this._editorRef=e}),x()(this,"_onKeyDown",e=>{if(this._editorRef.isComposing(e))return;const t=Object(Mt.f)().getMessageComposerAction(e);switch(t){case Mt.b.Send:this._sendMessage(),e.preventDefault();break;case Mt.b.SelectPrevSendHistory:case Mt.b.SelectNextSendHistory:this.selectSendHistory(t===Mt.b.SelectPrevSendHistory)&&e.preventDefault();break;case Mt.b.EditPrevMessage:if(this._editorRef.isSelectionCollapsed()&&this._editorRef.isCaretAtStart()){const t=Object(Oc.b)(this.props.room,!1);t&&(e.preventDefault(),u.a.dispatch({action:"edit_event",event:t}))}break;case Mt.b.CancelEditing:u.a.dispatch({action:"reply_to_event",event:null});break;default:this._prepareToEncrypt&&this._prepareToEncrypt()}}),x()(this,"_shouldSaveStoredEditorState",()=>!this.model.isEmpty||this.props.replyToEvent),x()(this,"_saveStoredEditorState",()=>{if(this._shouldSaveStoredEditorState()){const e=jb.createItem(this.model,this.props.replyToEvent);localStorage.setItem(this._editorStateKey,JSON.stringify(e))}else this._clearStoredEditorState()}),x()(this,"onAction",e=>{if(!this.props.disabled)switch(e.action){case"reply_to_event":case h.a.FocusComposer:this._editorRef&&this._editorRef.focus();break;case"send_composer_insert":e.userId?this._editorRef&&this._editorRef.insertMention(e.userId):e.event?this._editorRef&&this._editorRef.insertQuotedMessage(e.event):e.text&&this._editorRef&&this._editorRef.insertPlaintext(e.text)}}),x()(this,"_onPaste",e=>{const{clipboardData:t}=e;if(t.files.length&&!t.types.some(e=>"text/plain"===e))return Fn.a.sharedInstance().sendContentListToRoom(Array.from(t.files),this.props.room.roomId,this.context),!0}),x()(this,"onChange",()=>{this.props.onChange&&this.props.onChange(this.model)}),this.model=null,this._editorRef=null,this.currentlyComposedEditorState=null,this.context.isCryptoEnabled()&&this.context.isRoomEncrypted(this.props.room.roomId)&&(this._prepareToEncrypt=new uy.a(()=>{this.context.prepareToEncrypt(this.props.room)},6e4)),window.addEventListener("beforeunload",this._saveStoredEditorState)}selectSendHistory(e){const t=e?-1:1;if(this.sendHistoryManager.currentIndex===this.sendHistoryManager.history.length){if(!e)return;this.currentlyComposedEditorState=this.model.serializeParts()}else if(this.sendHistoryManager.currentIndex+t===this.sendHistoryManager.history.length)return this.model.reset(this.currentlyComposedEditorState),void(this.sendHistoryManager.currentIndex=this.sendHistoryManager.history.length);const{parts:s,replyEventId:n}=this.sendHistoryManager.getItem(t);u.a.dispatch({action:"reply_to_event",event:n?this.props.room.findEventById(n):null}),s&&(this.model.reset(s),this._editorRef.focus())}_isSlashCommand(){const e=this.model.parts[0];if(e){if("command"===e.type&&e.text.startsWith("/")&&!e.text.startsWith("//"))return!0;if(e.text.startsWith("/")&&!e.text.startsWith("//")&&("plain"===e.type||"pill-candidate"===e.type))return!0}return!1}_sendQuickReaction(){const e=this.props.room.getLiveTimeline().getEvents(),t=this.model.parts[1].text;for(let s=e.length-1;s>=0;s--)if("m.room.message"===e[s].getType()){let n=!0;const i=e[s],o=le.a.get().getUserId(),a=this.props.room.getUnfilteredTimelineSet().getRelationsForEvent(i.getId(),"m.annotation","m.reaction");if(a){n=![...a.getAnnotationsBySender()[o]||[]].filter(e=>!e.isRedacted()).map(e=>e.getRelation().key).includes(t)}n&&(le.a.get().sendEvent(i.getRoomId(),"m.reaction",{"m.relates_to":{rel_type:"m.annotation",event_id:i.getId(),key:t}}),u.a.dispatch({action:"message_sent"}));break}}_getSlashCommand(){const e=this.model.parts.reduce((e,t)=>"user-pill"===t.type?e+t.resourceId:e+t.text,""),{cmd:t,args:s}=Ll(e);return[t,s,e]}async _runSlashCommand(e,t){const s=e.run(this.props.room.roomId,t);let n,i=s.error;if(s.promise)try{e.category===Tl.messages?n=await s.promise:await s.promise}catch(e){i=e}if(i){console.error("Command failure: %s",i);const e=d.getComponent("dialogs.ErrorDialog"),t=!!s.promise?Object(c.b)("Server error"):Object(c.b)("Command error");let n;n="string"==typeof i?i:i.message?i.message:Object(c.a)("Server unavailable, overloaded, or something else went wrong."),Le.a.createTrackedDialog(t,"",e,{title:Object(c.a)(t),description:n})}else if(console.log("Command success."),n)return n}async _sendMessage(){if(this.model.isEmpty)return;const e=this.props.replyToEvent;let t,s=!0;if(!wb(this.model)&&this._isSlashCommand()){const[n,i,o]=this._getSlashCommand();if(n)n.category===Tl.messages?(t=await this._runSlashCommand(n,i),e&&gy(t,e,this.props.permalinkCreator)):(this._runSlashCommand(n,i),s=!1);else{const e=d.getComponent("dialogs.QuestionDialog"),{finished:t}=Le.a.createTrackedDialog("Unknown command","",e,{title:Object(c.a)("Unknown Command"),description:a.a.createElement("div",null,a.a.createElement("p",null,Object(c.a)("Unrecognised command: %(commandText)s",{commandText:o})),a.a.createElement("p",null,Object(c.a)("You can use <code>/help</code> to list available commands. Did you mean to send this as a message?",{},{code:e=>a.a.createElement("code",null,e)})),a.a.createElement("p",null,Object(c.a)("Hint: Begin your message with <code>//</code> to start it with a slash.",{},{code:e=>a.a.createElement("code",null,e)}))),button:Object(c.a)("Send as message")}),[s]=await t;if(!s)return}}if(function(e){const t=e.parts;if(0==t.length)return!1;const s=Sb(e);if(t.length<=2){const e=s.startsWith("+")||s.startsWith("+ "),t=s.match(py.a);if(e&&t&&1==t.length)return t[0]===s.substring(1)||t[0]===s.substring(2)}return!1}(this.model)&&(s=!1,this._sendQuickReaction()),s){const s=E.a.getTimestamp(),{roomId:n}=this.props.room;if(t||(t=function(e,t,s){const n=wb(e);n&&(e=kb(e)),Cb(e,"//")&&(e=Ob(e,"/"));const i={msgtype:n?"m.emote":"m.text",body:Sb(e=function(e){const{parts:t}=e;if(t.length){const s=t[0];"plain"===s.type&&s.text.startsWith("\\/")&&(e=e.clone()).removeText({index:0,offset:0},1)}return e}(e))},o=Eb(e,{forceHTML:!!s});return o&&(i.format="org.matrix.custom.html",i.formatted_body=o),s&&gy(i,s,t),i}(this.model,this.props.permalinkCreator,e)),!t.body.trim())return;const i=this.context.sendMessage(n,t);e&&u.a.dispatch({action:"reply_to_event",event:null}),u.a.dispatch({action:"message_sent"}),kl.CHAT_EFFECTS.forEach(e=>{Object(hy.containsEmoji)(t,e.emojis)&&u.a.dispatch({action:"effects."+e.command})}),E.a.instance.trackSendMessage(s,i,n,!1,!!e,t)}this.sendHistoryManager.save(this.model,e),this.model.reset([]),this._editorRef.clearUndoHistory(),this._editorRef.focus(),this._clearStoredEditorState(),V.b.getValue("scrollToBottomOnMessageSent")&&u.a.dispatch({action:"scroll_to_bottom"})}componentWillUnmount(){u.a.unregister(this.dispatcherRef),window.removeEventListener("beforeunload",this._saveStoredEditorState),this._saveStoredEditorState()}UNSAFE_componentWillMount(){const e=new Hd(this.props.room,this.context),t=this._restoreStoredEditorState(e)||[];this.model=new fb(t,e),this.dispatcherRef=u.a.register(this.onAction),this.sendHistoryManager=new jb(this.props.room.roomId,"mx_cider_history_")}get _editorStateKey(){return"mx_cider_state_"+this.props.room.roomId}_clearStoredEditorState(){localStorage.removeItem(this._editorStateKey)}_restoreStoredEditorState(e){const t=localStorage.getItem(this._editorStateKey);if(t)try{const{parts:s,replyEventId:n}=JSON.parse(t),i=s.map(t=>e.deserializePart(t));return n&&u.a.dispatch({action:"reply_to_event",event:this.props.room.findEventById(n)}),i}catch(e){console.error(e)}}render(){return a.a.createElement("div",{className:"mx_SendMessageComposer",onClick:this.focusComposer,onKeyDown:this._onKeyDown},a.a.createElement(hu,{onChange:this.onChange,ref:this._setEditorRef,model:this.model,room:this.props.room,label:this.props.placeholder,placeholder:this.props.placeholder,onPaste:this._onPaste,disabled:this.props.disabled}))}},x()(ly,"propTypes",{room:wt.a.object.isRequired,placeholder:wt.a.string,permalinkCreator:wt.a.object.isRequired,replyToEvent:wt.a.object,onChange:wt.a.func,disabled:wt.a.bool}),x()(ly,"contextType",b.a),cy=dy))||cy;var fy,by,yy;let _y=Object(P.a)("views.rooms.SimpleRoomHeader")((yy=by=class extends a.a.Component{render(){let e;if(this.props.icon){const t=d.getComponent("elements.TintableSvg");e=a.a.createElement(t,{className:"mx_RoomHeader_icon",src:this.props.icon,width:"25",height:"25"})}return a.a.createElement("div",{className:"mx_RoomHeader mx_RoomHeader_wrapper"},a.a.createElement("div",{className:"mx_RoomHeader_simpleHeader"},e,this.props.title))}},x()(by,"propTypes",{title:wt.a.string,icon:wt.a.string}),fy=yy))||fy;var Ey,Sy,wy;let Cy=Object(P.a)("views.rooms.TopUnreadMessagesBar")((wy=Sy=class extends a.a.Component{render(){return a.a.createElement("div",{className:"mx_TopUnreadMessagesBar"},a.a.createElement(g.a,{className:"mx_TopUnreadMessagesBar_scrollUp",title:Object(c.a)("Jump to first unread message."),onClick:this.props.onScrollUpClick}),a.a.createElement(g.a,{className:"mx_TopUnreadMessagesBar_markAsRead",title:Object(c.a)("Mark all as read"),onClick:this.props.onCloseClick}))}},x()(Sy,"propTypes",{onScrollUpClick:wt.a.func,onCloseClick:wt.a.func}),Ey=wy))||Ey;const ky=({avatarUrl:e,avatarAltText:t,avatarName:s,uploadAvatar:n,removeAvatar:i})=>{const[r,l]=Object(o.useState)(!1),d={onMouseEnter:()=>l(!0),onMouseLeave:()=>l(!1)};let u,h,m=a.a.createElement(g.a,ue()({element:"div",onClick:n,className:"mx_AvatarSetting_avatarPlaceholder"},d));e&&(m=a.a.createElement(g.a,ue()({element:"img",src:e,alt:t,"aria-label":t,onClick:n},d))),n&&(u=a.a.createElement(g.a,ue()({onClick:n,className:"mx_AvatarSetting_uploadButton"},d))),e&&i&&(h=a.a.createElement(g.a,{onClick:i,kind:"link_sm"},Object(c.a)("Remove")));const p=M()({mx_AvatarSetting_avatar:!0,mx_AvatarSetting_avatar_hovering:r&&n});return a.a.createElement("div",{className:p},m,a.a.createElement("div",{className:"mx_AvatarSetting_hover"},a.a.createElement("div",{className:"mx_AvatarSetting_hoverBg"}),a.a.createElement("span",null,Object(c.a)("Upload"))),u,h)};ky.propTypes={avatarUrl:wt.a.string,avatarName:wt.a.string.isRequired,uploadAvatar:wt.a.func,removeAvatar:wt.a.func,avatarAltText:wt.a.string.isRequired};var Oy,Ry,Iy,xy=ky;let Ty=Object(P.a)("views.settings.ChangeAvatar")((Iy=Ry=class e extends a.a.Component{constructor(t){super(t),x()(this,"onRoomStateEvents",e=>{this.props.room&&e.getRoomId()===this.props.room.roomId&&"m.room.avatar"===e.getType()&&e.getSender()===le.a.get().getUserId()&&(e.getContent().url||(this.avatarSet=!1,this.setState({})))}),x()(this,"onFileSelected",e=>(this.avatarSet=!0,this.setAvatarFromFile(e.target.files[0]))),x()(this,"onError",e=>{this.setState({errorText:Object(c.a)("Failed to upload profile picture!")})}),this.state={avatarUrl:this.props.initialAvatarUrl,phase:e.Phases.Display}}componentDidMount(){le.a.get().on("RoomState.events",this.onRoomStateEvents)}UNSAFE_componentWillReceiveProps(e){this.avatarSet||this.setState({avatarUrl:e.initialAvatarUrl})}componentWillUnmount(){le.a.get()&&le.a.get().removeListener("RoomState.events",this.onRoomStateEvents)}setAvatarFromFile(t){let s=null;this.setState({phase:e.Phases.Uploading});const n=this,i=le.a.get().uploadContent(t).then((function(e){return s=e,n.props.room?le.a.get().sendStateEvent(n.props.room.roomId,"m.room.avatar",{url:e},""):le.a.get().setAvatarUrl(e)}));return i.then((function(){n.setState({phase:e.Phases.Display,avatarUrl:Object(pe.b)(s).srcHttp})}),(function(t){n.setState({phase:e.Phases.Error}),n.onError(t)})),i}render(){let t,s;if(this.props.room&&!this.avatarSet){const e=d.getComponent("avatars.RoomAvatar");t=a.a.createElement(e,{room:this.props.room,width:this.props.width,height:this.props.height,resizeMethod:"crop"})}else{const e=d.getComponent("avatars.BaseAvatar");t=a.a.createElement(e,{width:this.props.width,height:this.props.height,resizeMethod:"crop",name:"?",idName:le.a.get().getUserIdLocalpart(),url:this.state.avatarUrl})}switch(this.props.showUploadSection&&(s=a.a.createElement("div",{className:this.props.className},Object(c.a)("Upload new:"),a.a.createElement("input",{type:"file",accept:"image/*",onChange:this.onFileSelected}),this.state.errorText)),this.state.phase){case e.Phases.Display:case e.Phases.Error:return a.a.createElement("div",null,a.a.createElement("div",{className:this.props.className},t),s);case e.Phases.Uploading:return a.a.createElement(Rn.a,null)}}},x()(Ry,"propTypes",{initialAvatarUrl:wt.a.string,room:wt.a.object,showUploadSection:wt.a.bool,width:wt.a.number,height:wt.a.number,className:wt.a.string}),x()(Ry,"Phases",{Display:"display",Uploading:"uploading",Error:"error"}),x()(Ry,"defaultProps",{showUploadSection:!0,className:"",width:80,height:80}),Oy=Iy))||Oy;var jy;let Ny=Object(P.a)("views.settings.ChangeDisplayName")(jy=class extends a.a.Component{constructor(...e){super(...e),x()(this,"_getDisplayName",async()=>{const e=le.a.get();try{return(await e.getProfileInfo(e.getUserId())).displayname}catch(e){throw new Error("Failed to fetch display name")}}),x()(this,"_changeDisplayName",e=>le.a.get().setDisplayName(e).catch((function(e){throw new Error("Failed to set display name",e)})))}render(){const e=d.getComponent("elements.EditableTextContainer");return a.a.createElement(e,{getInitialValue:this._getDisplayName,placeholder:Object(c.a)("No display name"),blurToSubmit:!0,onSubmit:this._changeDisplayName})}})||jy;var Py,Dy,Ay;let My=Object(P.a)("views.settings.ChangePassword")((Ay=Dy=class e extends a.a.Component{constructor(...t){super(...t),x()(this,"state",{fieldValid:{},phase:e.Phases.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""}),x()(this,"_onExportE2eKeysClicked",()=>{Le.a.createTrackedDialogAsync("Export E2E Keys","Change Password",s.e(4).then(s.bind(null,1306)),{matrixClient:le.a.get()})}),x()(this,"onChangeOldPassword",e=>{this.setState({oldPassword:e.target.value})}),x()(this,"onOldPasswordValidate",async e=>{const t=await this.validateOldPasswordRules(e);return this.markFieldValid("field_old_password",t.valid),t}),x()(this,"validateOldPasswordRules",Object(Ts.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Passwords can't be empty")}]})),x()(this,"onChangeNewPassword",e=>{this.setState({newPassword:e.target.value})}),x()(this,"onNewPasswordValidate",e=>{this.markFieldValid("field_new_password",e.valid)}),x()(this,"onChangeNewPasswordConfirm",e=>{this.setState({newPasswordConfirm:e.target.value})}),x()(this,"onNewPasswordConfirmValidate",async e=>{const t=await this.validatePasswordConfirmRules(e);return this.markFieldValid("field_new_password_confirm",t.valid),t}),x()(this,"validatePasswordConfirmRules",Object(Ts.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(c.a)("Confirm password")},{key:"match",test({value:e}){return!e||e===this.state.newPassword},invalid:()=>Object(c.a)("Passwords don't match")}]})),x()(this,"onClickChange",async e=>{e.preventDefault();if(!await this.verifyFieldsBeforeSubmit())return void E.a.instance.track("onboarding_registration_submit_failed");const t=this.state.oldPassword,s=this.state.newPassword,n=this.state.newPasswordConfirm,i=this.props.onCheckPassword(t,s,n);i?this.props.onError(i):this.changePassword(t,s)})}changePassword(e,t){const s=le.a.get();if(!this.props.confirm)return void this._changePassword(s,e,t);const n=d.getComponent("dialogs.QuestionDialog");Le.a.createTrackedDialog("Change Password","",n,{title:Object(c.a)("Warning!"),description:a.a.createElement("div",null,Object(c.a)("Changing password will currently reset any end-to-end encryption keys on all sessions, making encrypted chat history unreadable, unless you first export your room keys and re-import them afterwards. In future this will be improved.")," ",a.a.createElement("a",{href:"https://github.com/vector-im/element-web/issues/2671",target:"_blank",rel:"noreferrer noopener"},"https://github.com/vector-im/element-web/issues/2671")),button:Object(c.a)("Continue"),extraButtons:[a.a.createElement("button",{key:"exportRoomKeys",className:"mx_Dialog_primary",onClick:this._onExportE2eKeysClicked},Object(c.a)("Export E2E room keys"))],onFinished:n=>{n&&this._changePassword(s,e,t)}})}_changePassword(t,s,n){const i={type:"m.login.password",identifier:{type:"m.id.user",user:t.credentials.userId},user:t.credentials.userId,password:s};this.setState({phase:e.Phases.Uploading}),t.setPassword(i,n).then(()=>{if(this.props.shouldAskForEmail)return this._optionallySetEmail().then(e=>{this.props.onFinished({didSetEmail:e})});this.props.onFinished()},e=>{this.props.onError(e)}).finally(()=>{this.setState({phase:e.Phases.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""})})}_optionallySetEmail(){const e=d.getComponent("dialogs.SetEmailDialog");return Le.a.createTrackedDialog("Do you want to set an email address?","",e,{title:Object(c.a)("Do you want to set an email address?")}).finished.then(([e])=>e)}markFieldValid(e,t){const{fieldValid:s}=this.state;s[e]=t,this.setState({fieldValid:s})}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=["field_old_password","field_new_password","field_new_password_confirm"];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const s=this.findFirstInvalidField(t);return!s||(s.focus(),s.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){const e=Object.keys(this.state.fieldValid);for(let t=0;t<e.length;++t)if(!this.state.fieldValid[e[t]])return!1;return!0}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}render(){const t=this.props.rowClassName,s=this.props.buttonClassName;switch(this.state.phase){case e.Phases.Edit:return a.a.createElement("form",{className:this.props.className,onSubmit:this.onClickChange},a.a.createElement("div",{className:t},a.a.createElement(Ue.a,{ref:e=>this.field_old_password=e,type:"password",label:Object(c.a)("Current password"),value:this.state.oldPassword,onChange:this.onChangeOldPassword,onValidate:this.onOldPasswordValidate})),a.a.createElement("div",{className:t},a.a.createElement(Li.a,{fieldRef:e=>this.field_new_password=e,type:"password",label:"New Password",minScore:3,value:this.state.newPassword,autoFocus:this.props.autoFocusNewPasswordInput,onChange:this.onChangeNewPassword,onValidate:this.onNewPasswordValidate,autoComplete:"new-password"})),a.a.createElement("div",{className:t},a.a.createElement(Ue.a,{ref:e=>this.field_new_password_confirm=e,type:"password",label:Object(c.a)("Confirm password"),value:this.state.newPasswordConfirm,onChange:this.onChangeNewPasswordConfirm,onValidate:this.onNewPasswordConfirmValidate,autoComplete:"new-password"})),a.a.createElement(g.a,{className:s,kind:this.props.buttonKind,onClick:this.onClickChange},this.props.buttonLabel||Object(c.a)("Change Password")));case e.Phases.Uploading:return a.a.createElement("div",{className:"mx_Dialog_content"},a.a.createElement(Rn.a,null))}}},x()(Dy,"propTypes",{onFinished:wt.a.func,onError:wt.a.func,onCheckPassword:wt.a.func,rowClassName:wt.a.string,buttonClassName:wt.a.string,buttonKind:wt.a.string,buttonLabel:wt.a.string,confirm:wt.a.bool,autoFocusNewPasswordInput:wt.a.bool}),x()(Dy,"Phases",{Edit:"edit",Uploading:"uploading",Error:"error"}),x()(Dy,"defaultProps",{onFinished(){},onError(){},onCheckPassword:(e,t,s)=>t!==s?{error:Object(c.a)("New passwords don't match")}:t&&0!==t.length?void 0:{error:Object(c.a)("Passwords can't be empty")},confirm:!0}),Py=Ay))||Py;var Uy;let Ly=Object(P.a)("views.settings.CrossSigningPanel")(Uy=class extends a.a.PureComponent{constructor(e){super(e),x()(this,"onAccountData",e=>{const t=e.getType();(t.startsWith("m.cross_signing")||t.startsWith("m.secret_storage"))&&this._getUpdatedStatus()}),x()(this,"_onBootstrapClick",()=>{this._bootstrapCrossSigning({forceReset:!1})}),x()(this,"onStatusChanged",()=>{this._getUpdatedStatus()}),x()(this,"_bootstrapCrossSigning",async({forceReset:e=!1})=>{this.setState({error:null});try{const t=le.a.get();await t.bootstrapCrossSigning({authUploadDeviceSigningKeys:async e=>{const{finished:s}=Le.a.createTrackedDialog("Cross-signing keys dialog","",ra,{title:Object(c.a)("Setting up keys"),matrixClient:t,makeRequest:e}),[n]=await s;if(!n)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:e})}catch(e){this.setState({error:e}),console.error("Error bootstrapping cross-signing",e)}this._unmounted||this._getUpdatedStatus()}),x()(this,"_resetCrossSigning",()=>{Le.a.createDialog(sa,{onFinished:e=>{e&&this._bootstrapCrossSigning({forceReset:!0})}})}),this._unmounted=!1,this.state={error:null,crossSigningPublicKeysOnDevice:null,crossSigningPrivateKeysInStorage:null,masterPrivateKeyCached:null,selfSigningPrivateKeyCached:null,userSigningPrivateKeyCached:null,homeserverSupportsCrossSigning:null,crossSigningReady:null}}componentDidMount(){const e=le.a.get();e.on("accountData",this.onAccountData),e.on("userTrustStatusChanged",this.onStatusChanged),e.on("crossSigning.keysChanged",this.onStatusChanged),this._getUpdatedStatus()}componentWillUnmount(){this._unmounted=!0;const e=le.a.get();e&&(e.removeListener("accountData",this.onAccountData),e.removeListener("userTrustStatusChanged",this.onStatusChanged),e.removeListener("crossSigning.keysChanged",this.onStatusChanged))}async _getUpdatedStatus(){const e=le.a.get(),t=e.getCrossSigningCacheCallbacks(),s=e.crypto.crossSigningInfo,n=e.crypto.secretStorage,i=s.getId(),o=await s.isStoredInSecretStorage(n),a=!(!t||!await t.getCrossSigningKeyCache("master")),r=!(!t||!await t.getCrossSigningKeyCache("self_signing")),c=!(!t||!await t.getCrossSigningKeyCache("user_signing")),l=await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),d=await e.isCrossSigningReady();this.setState({crossSigningPublicKeysOnDevice:i,crossSigningPrivateKeysInStorage:o,masterPrivateKeyCached:a,selfSigningPrivateKeyCached:r,userSigningPrivateKeyCached:c,homeserverSupportsCrossSigning:l,crossSigningReady:d})}render(){const e=d.getComponent("elements.AccessibleButton"),{error:t,crossSigningPublicKeysOnDevice:s,crossSigningPrivateKeysInStorage:n,masterPrivateKeyCached:i,selfSigningPrivateKeyCached:o,userSigningPrivateKeyCached:r,homeserverSupportsCrossSigning:l,crossSigningReady:u}=this.state;let h,m;t&&(h=a.a.createElement("div",{className:"error"},t.toString())),m=void 0===l?a.a.createElement(Rn.a,null):l?u?a.a.createElement("p",null,"✅ ",Object(c.a)("Cross-signing is ready for use.")):n?a.a.createElement("p",null,Object(c.a)("Your account has a cross-signing identity in secret storage, but it is not yet trusted by this session.")):a.a.createElement("p",null,Object(c.a)("Cross-signing is not set up.")):a.a.createElement("p",null,Object(c.a)("Your homeserver does not support cross-signing."));const p=s||n||i||o||r,g=[];let v;return!(s&&n&&i&&o&&r)&&l&&g.push(a.a.createElement(e,{key:"setup",kind:"primary",onClick:this._onBootstrapClick},Object(c.a)("Set up"))),p&&g.push(a.a.createElement(e,{key:"reset",kind:"danger",onClick:this._resetCrossSigning},Object(c.a)("Reset"))),g.length&&(v=a.a.createElement("div",{className:"mx_CrossSigningPanel_buttonRow"},g)),a.a.createElement("div",null,m,a.a.createElement("details",null,a.a.createElement("summary",null,Object(c.a)("Advanced")),a.a.createElement("table",{className:"mx_CrossSigningPanel_statusList"},a.a.createElement("tbody",null,a.a.createElement("tr",null,a.a.createElement("td",null,Object(c.a)("Cross-signing public keys:")),a.a.createElement("td",null,s?Object(c.a)("in memory"):Object(c.a)("not found"))),a.a.createElement("tr",null,a.a.createElement("td",null,Object(c.a)("Cross-signing private keys:")),a.a.createElement("td",null,n?Object(c.a)("in secret storage"):Object(c.a)("not found in storage"))),a.a.createElement("tr",null,a.a.createElement("td",null,Object(c.a)("Master private key:")),a.a.createElement("td",null,i?Object(c.a)("cached locally"):Object(c.a)("not found locally"))),a.a.createElement("tr",null,a.a.createElement("td",null,Object(c.a)("Self signing private key:")),a.a.createElement("td",null,o?Object(c.a)("cached locally"):Object(c.a)("not found locally"))),a.a.createElement("tr",null,a.a.createElement("td",null,Object(c.a)("User signing private key:")),a.a.createElement("td",null,r?Object(c.a)("cached locally"):Object(c.a)("not found locally"))),a.a.createElement("tr",null,a.a.createElement("td",null,Object(c.a)("Homeserver feature support:")),a.a.createElement("td",null,l?Object(c.a)("exists"):Object(c.a)("not found")))))),h,v)}})||Uy;var Fy;let By=Object(P.a)("views.settings.DevicesPanel")(Fy=class extends a.a.Component{constructor(e){super(e),this.state={devices:void 0,deviceLoadError:void 0,selectedDevices:[],deleting:!1},this._unmounted=!1,this._renderDevice=this._renderDevice.bind(this),this._onDeviceSelectionToggled=this._onDeviceSelectionToggled.bind(this),this._onDeleteClick=this._onDeleteClick.bind(this)}componentDidMount(){this._loadDevices()}componentWillUnmount(){this._unmounted=!0}_loadDevices(){le.a.get().getDevices().then(e=>{this._unmounted||this.setState({devices:e.devices||[]})},e=>{if(this._unmounted)return;let t;404==e.httpStatus?t=Object(c.a)("Your homeserver does not support session management."):(console.error("Error loading sessions:",e),t=Object(c.a)("Unable to load session list")),this.setState({deviceLoadError:t})})}_deviceCompare(e,t){const s=(t.last_seen_ts||0)-(e.last_seen_ts||0);if(0!==s)return s;const n=e.device_id,i=t.device_id;return n<i?-1:n>i?1:0}_onDeviceSelectionToggled(e){if(this._unmounted)return;const t=e.device_id;this.setState((e,s)=>{const n=e.selectedDevices.slice(),i=n.indexOf(t);return-1===i?n.push(t):n.splice(i,1),{selectedDevices:n}})}_onDeleteClick(){this.setState({deleting:!0}),this._makeDeleteRequest(null).catch(e=>{if(this._unmounted)return;if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t=d.getComponent("dialogs.InteractiveAuthDialog"),s=this.state.selectedDevices.length,n={[Ui.c.PHASE_PREAUTH]:{title:Object(c.a)("Use Single Sign On to continue"),body:Object(c.a)("Confirm deleting these sessions by using Single Sign On to prove your identity.",{count:s}),continueText:Object(c.a)("Single Sign On"),continueKind:"primary"},[Ui.c.PHASE_POSTAUTH]:{title:Object(c.a)("Confirm deleting these sessions"),body:Object(c.a)("Click the button below to confirm deleting these sessions.",{count:s}),continueText:Object(c.a)("Delete sessions",{count:s}),continueKind:"danger"}};Le.a.createTrackedDialog("Delete Device Dialog","",t,{title:Object(c.a)("Authentication"),matrixClient:le.a.get(),authData:e.data,makeRequest:this._makeDeleteRequest.bind(this),aestheticsForStagePhases:{[Ui.c.LOGIN_TYPE]:n,[Ui.c.UNSTABLE_LOGIN_TYPE]:n}})}).catch(e=>{console.error("Error deleting sessions",e),this._unmounted}).finally(()=>{this.setState({deleting:!1})})}_makeDeleteRequest(e){return le.a.get().deleteMultipleDevices(this.state.selectedDevices,e).then(()=>{this.setState({devices:this.state.devices.filter(e=>!this.state.selectedDevices.includes(e.device_id)),selectedDevices:[]})})}_renderDevice(e){const t=d.getComponent("settings.DevicesPanelEntry");return a.a.createElement(t,{key:e.device_id,device:e,selected:this.state.selectedDevices.includes(e.device_id),onDeviceToggled:this._onDeviceSelectionToggled})}render(){const e=d.getComponent("elements.Spinner"),t=d.getComponent("elements.AccessibleButton");if(void 0!==this.state.deviceLoadError){const e=M()(this.props.className,"error");return a.a.createElement("div",{className:e},this.state.deviceLoadError)}const s=this.state.devices;if(void 0===s){const t=this.props.className;return a.a.createElement(e,{className:t})}s.sort(this._deviceCompare);const n=this.state.deleting?a.a.createElement(e,{w:22,h:22}):a.a.createElement(t,{onClick:this._onDeleteClick,kind:"danger_sm"},Object(c.a)("Delete %(count)s sessions",{count:this.state.selectedDevices.length})),i=M()(this.props.className,"mx_DevicesPanel");return a.a.createElement("div",{className:i},a.a.createElement("div",{className:"mx_DevicesPanel_header"},a.a.createElement("div",{className:"mx_DevicesPanel_deviceId"},Object(c.a)("ID")),a.a.createElement("div",{className:"mx_DevicesPanel_deviceName"},Object(c.a)("Public Name")),a.a.createElement("div",{className:"mx_DevicesPanel_deviceLastSeen"},Object(c.a)("Last seen")),a.a.createElement("div",{className:"mx_DevicesPanel_deviceButtons"},this.state.selectedDevices.length>0?n:null)),s.map(this._renderDevice))}})||Fy;var Vy;By.propTypes={className:wt.a.string};let Ky=Object(P.a)("views.settings.DevicesPanelEntry")(Vy=class extends a.a.Component{constructor(e){super(e),this._unmounted=!1,this.onDeviceToggled=this.onDeviceToggled.bind(this),this._onDisplayNameChanged=this._onDisplayNameChanged.bind(this)}componentWillUnmount(){this._unmounted=!0}_onDisplayNameChanged(e){const t=this.props.device;return le.a.get().setDeviceDetails(t.device_id,{display_name:e}).catch(e=>{throw console.error("Error setting session display name",e),new Error(Object(c.a)("Failed to set display name"))})}onDeviceToggled(){this.props.onDeviceToggled(this.props.device)}render(){const e=d.getComponent("elements.EditableTextContainer"),t=this.props.device;let s="";if(t.last_seen_ts){const e=Object(rm.a)(new Date(t.last_seen_ts));s=t.last_seen_ip+" @ "+e.toLocaleString()}let n="";return t.device_id===le.a.get().getDeviceId()&&(n=" mx_DevicesPanel_myDevice"),a.a.createElement("div",{className:"mx_DevicesPanel_device"+n},a.a.createElement("div",{className:"mx_DevicesPanel_deviceId"},t.device_id),a.a.createElement("div",{className:"mx_DevicesPanel_deviceName"},a.a.createElement(e,{initialValue:t.display_name,onSubmit:this._onDisplayNameChanged,placeholder:t.device_id})),a.a.createElement("div",{className:"mx_DevicesPanel_lastSeen"},s),a.a.createElement("div",{className:"mx_DevicesPanel_deviceButtons"},a.a.createElement(La.a,{onChange:this.onDeviceToggled,checked:this.props.selected})))}})||Vy;Ky.propTypes={device:wt.a.object.isRequired,onDeviceToggled:wt.a.func},Ky.defaultProps={onDeviceToggled:function(){}};var Wy=s(567);let Gy,qy,Hy,$y;!function(e){e.AllMessages="all_messages",e.DirectMessagesMentionsKeywords="dm_mentions_keywords",e.MentionsKeywordsOnly="mentions_keywords",e.Never="never"}(Gy||(Gy={})),function(e){e.Notify="notify",e.DontNotify="dont_notify",e.Coalesce="coalesce",e.MarkUnread="mark_unread"}(qy||(qy={})),function(e){e.Override="override",e.ContentSpecific="content",e.RoomSpecific="room",e.SenderSpecific="sender",e.Underride="underride"}(Hy||(Hy={})),function(e){e.MasterRule=".m.rule.master",e.MessageRule=".m.rule.message",e.EncryptedMessageRule=".m.rule.encrypted",e.RoomOneToOneRule=".m.rule.room_one_to_one",e.EncryptedRoomOneToOneRule=".m.rule.room_one_to_one"}($y||($y={}));class zy{static encodeActions(e){const t=e.notify,s=e.sound,n=e.highlight;if(t){const e=[qy.Notify];return s&&e.push({set_tweak:"sound",value:s}),n?e.push({set_tweak:"highlight"}):e.push({set_tweak:"highlight",value:!1}),e}return[qy.DontNotify]}static decodeActions(e){let t=!1,s=null,n=!1;for(let i=0;i<e.length;++i){const o=e[i];if(o===qy.Notify)t=!0;else if(o===qy.DontNotify)t=!1;else{if("object"!=typeof o)return null;if("sound"===o.set_tweak)s=o.value;else{if("highlight"!==o.set_tweak)return null;n=o.value}}}void 0===n&&(n=!0);const i={notify:t,highlight:n};return null!==s&&(i.sound=s),i}}const Yy=zy.encodeActions;class Jy{}let Qy;x()(Jy,"ACTION_NOTIFY",Yy({notify:!0})),x()(Jy,"ACTION_NOTIFY_DEFAULT_SOUND",Yy({notify:!0,sound:"default"})),x()(Jy,"ACTION_NOTIFY_RING_SOUND",Yy({notify:!0,sound:"ring"})),x()(Jy,"ACTION_HIGHLIGHT",Yy({notify:!0,highlight:!0})),x()(Jy,"ACTION_HIGHLIGHT_DEFAULT_SOUND",Yy({notify:!0,sound:"default",highlight:!0})),x()(Jy,"ACTION_DONT_NOTIFY",Yy({notify:!1})),x()(Jy,"ACTION_DISABLED",null),function(e){e.Off="off",e.On="on",e.Loud="loud"}(Qy||(Qy={}));class Xy{static actionsFor(e){return e===Qy.On?Jy.ACTION_NOTIFY:e===Qy.Loud?Jy.ACTION_HIGHLIGHT_DEFAULT_SOUND:void 0}static contentRuleVectorStateKind(e){const t=zy.decodeActions(e.actions);if(!t)return null;let s=0;t.sound&&s++,t.highlight&&s++;let n=null;switch(s){case 0:n=Qy.On;break;case 2:n=Qy.Loud}return n}}x()(Xy,"OFF",Qy.Off),x()(Xy,"ON",Qy.On),x()(Xy,"LOUD",Qy.Loud),x()(Xy,"states",Qy);class Zy{constructor(e){this.kind=e.kind,this.description=e.description,this.vectorStateToActions=e.vectorStateToActions}ruleToVectorState(e){let t=!1;e&&(t=e.enabled);for(const s in Xy.states){const n=Xy.states[s],i=this.vectorStateToActions[n];if(i){if(t&&JSON.stringify(zy.decodeActions(e.actions))===JSON.stringify(zy.decodeActions(i)))return n}else if(!t)return n}console.error(`Cannot translate rule actions into Vector rule state. Rule: ${JSON.stringify(e)}, Expected: `+JSON.stringify(this.vectorStateToActions))}}const e_={".m.rule.contains_display_name":new Zy({kind:"override",description:Object(c.b)("Messages containing my display name"),vectorStateToActions:{on:Jy.ACTION_NOTIFY,loud:Jy.ACTION_HIGHLIGHT_DEFAULT_SOUND,off:Jy.ACTION_DISABLED}}),".m.rule.contains_user_name":new Zy({kind:"override",description:Object(c.b)("Messages containing my username"),vectorStateToActions:{on:Jy.ACTION_NOTIFY,loud:Jy.ACTION_HIGHLIGHT_DEFAULT_SOUND,off:Jy.ACTION_DISABLED}}),".m.rule.roomnotif":new Zy({kind:"override",description:Object(c.b)("Messages containing @room"),vectorStateToActions:{on:Jy.ACTION_NOTIFY,loud:Jy.ACTION_HIGHLIGHT,off:Jy.ACTION_DISABLED}}),".m.rule.room_one_to_one":new Zy({kind:"underride",description:Object(c.b)("Messages in one-to-one chats"),vectorStateToActions:{on:Jy.ACTION_NOTIFY,loud:Jy.ACTION_NOTIFY_DEFAULT_SOUND,off:Jy.ACTION_DONT_NOTIFY}}),".m.rule.encrypted_room_one_to_one":new Zy({kind:"underride",description:Object(c.b)("Encrypted messages in one-to-one chats"),vectorStateToActions:{on:Jy.ACTION_NOTIFY,loud:Jy.ACTION_NOTIFY_DEFAULT_SOUND,off:Jy.ACTION_DONT_NOTIFY}}),".m.rule.message":new Zy({kind:"underride",description:Object(c.b)("Messages in group chats"),vectorStateToActions:{on:Jy.ACTION_NOTIFY,loud:Jy.ACTION_NOTIFY_DEFAULT_SOUND,off:Jy.ACTION_DONT_NOTIFY}}),".m.rule.encrypted":new Zy({kind:"underride",description:Object(c.b)("Encrypted messages in group chats"),vectorStateToActions:{on:Jy.ACTION_NOTIFY,loud:Jy.ACTION_NOTIFY_DEFAULT_SOUND,off:Jy.ACTION_DONT_NOTIFY}}),".m.rule.invite_for_me":new Zy({kind:"underride",description:Object(c.b)("When I'm invited to a room"),vectorStateToActions:{on:Jy.ACTION_NOTIFY,loud:Jy.ACTION_NOTIFY_DEFAULT_SOUND,off:Jy.ACTION_DISABLED}}),".m.rule.call":new Zy({kind:"underride",description:Object(c.b)("Call invitation"),vectorStateToActions:{on:Jy.ACTION_NOTIFY,loud:Jy.ACTION_NOTIFY_RING_SOUND,off:Jy.ACTION_DISABLED}}),".m.rule.suppress_notices":new Zy({kind:"override",description:Object(c.b)("Messages sent by bot"),vectorStateToActions:{on:Jy.ACTION_DISABLED,loud:Jy.ACTION_NOTIFY_DEFAULT_SOUND,off:Jy.ACTION_DONT_NOTIFY}}),".m.rule.tombstone":new Zy({kind:"override",description:Object(c.b)("When rooms are upgraded"),vectorStateToActions:{on:Jy.ACTION_NOTIFY,loud:Jy.ACTION_HIGHLIGHT,off:Jy.ACTION_DISABLED}})};var t_,s_,n_;const i_={"im.vector.rule.contains_display_name":".m.rule.contains_display_name","im.vector.rule.room_one_to_one":".m.rule.room_one_to_one","im.vector.rule.room_message":".m.rule.message","im.vector.rule.invite_for_me":".m.rule.invite_for_me","im.vector.rule.call":".m.rule.call","im.vector.rule.notices":".m.rule.suppress_notices"};function o_(e){const t=zy.decodeActions(e);return null!==t?zy.encodeActions(t):e}let a_=Object(P.a)("views.settings.Notifications")((n_=s_=class e extends a.a.Component{constructor(...t){super(...t),x()(this,"state",{phase:e.phases.LOADING,masterPushRule:void 0,vectorPushRules:[],vectorContentRules:{vectorState:Xy.ON,rules:[]},externalPushRules:[],externalContentRules:[],threepids:[]}),x()(this,"onEnableNotificationsChange",t=>{const s=this;this.setState({phase:e.phases.LOADING}),le.a.get().setPushRuleEnabled("global",s.state.masterPushRule.kind,s.state.masterPushRule.rule_id,!t).then((function(){s._refreshFromServer()}))}),x()(this,"onEnableDesktopNotificationsChange",e=>{V.b.setValue("notificationsEnabled",null,Ye.a.DEVICE,e).finally(()=>{this.forceUpdate()})}),x()(this,"onEnableDesktopNotificationBodyChange",e=>{V.b.setValue("notificationBodyEnabled",null,Ye.a.DEVICE,e).finally(()=>{this.forceUpdate()})}),x()(this,"onEnableAudioNotificationsChange",e=>{V.b.setValue("audioNotificationsEnabled",null,Ye.a.DEVICE,e).finally(()=>{this.forceUpdate()})}),x()(this,"onEnableEmailNotificationsChange",(e,t)=>{let s;if(t){const t={};t.brand=l.a.get().brand,s=le.a.get().setPusher({kind:"email",app_id:"m.email",pushkey:e,app_display_name:"Email Notifications",device_display_name:e,lang:navigator.language,data:t,append:!0})}else{const t=this.getEmailPusher(this.state.pushers,e);t.kind=null,s=le.a.get().setPusher(t)}s.then(()=>{this._refreshFromServer()},e=>{const t=d.getComponent("dialogs.ErrorDialog");Le.a.createTrackedDialog("Error saving email notification preferences","",t,{title:Object(c.a)("Error saving email notification preferences"),description:Object(c.a)("An error occurred whilst saving your email notification preferences.")})})}),x()(this,"onNotifStateButtonClicked",e=>{const t=e.target.className.split("-")[0],s=e.target.className.split("-")[1];if("_keywords"===t)this._setKeywordsPushRuleVectorState(s);else{const e=this.getRule(t);e&&this._setPushRuleVectorState(e,s)}}),x()(this,"onKeywordsClicked",e=>{let t=[];for(const e in this.state.vectorContentRules.rules){const s=this.state.vectorContentRules.rules[e];t.push(s.pattern)}t.length?(t.sort(),t=t.join(", ")):t="";const s=d.getComponent("dialogs.TextInputDialog");Le.a.createTrackedDialog("Keywords Dialog","",s,{title:Object(c.a)("Keywords"),description:Object(c.a)("Enter keywords separated by a comma:"),button:Object(c.a)("OK"),value:t,onFinished:(e,s)=>{if(e&&s!==t){let e=s.split(",");for(const t in e)e[t]=e[t].trim();e=e.reduce((function(e,t){return""!==t&&e.indexOf(t)<0&&e.push(t),e}),[]),this._setKeywords(e)}}})}),x()(this,"_refreshFromServer",()=>{const t=this,s=le.a.get().getPushRules().then(t._portRulesToNewAPI).then((function(e){le.a.get().pushRules=e;const s={".m.rule.master":"master",".m.rule.contains_display_name":"vector",".m.rule.contains_user_name":"vector",".m.rule.roomnotif":"vector",".m.rule.room_one_to_one":"vector",".m.rule.encrypted_room_one_to_one":"vector",".m.rule.message":"vector",".m.rule.encrypted":"vector",".m.rule.invite_for_me":"vector",".m.rule.call":"vector",".m.rule.suppress_notices":"vector",".m.rule.tombstone":"vector"},n={master:[],vector:{},others:[]};for(const t in e.global)for(let i=0;i<Object.keys(e.global[t]).length;++i){const o=e.global[t][i],a=s[o.rule_id];o.kind=t,"."===o.rule_id[0]&&("vector"===a?n.vector[o.rule_id]=o:"master"===a?n.master.push(o):n.others.push(o))}n.master.length>0&&(t.state.masterPushRule=n.master[0]);const i=class{static parseContentRules(e){const t=this._categoriseContentRules(e);return t.loud.length?{vectorState:Qy.Loud,rules:t.loud,externalRules:[...t.loud_but_disabled,...t.on,...t.on_but_disabled,...t.other]}:t.loud_but_disabled.length?{vectorState:Qy.Off,rules:t.loud_but_disabled,externalRules:[...t.on,...t.on_but_disabled,...t.other]}:t.on.length?{vectorState:Qy.On,rules:t.on,externalRules:[...t.on_but_disabled,...t.other]}:t.on_but_disabled.length?{vectorState:Qy.Off,rules:t.on_but_disabled,externalRules:t.other}:{vectorState:Qy.On,rules:[],externalRules:t.other}}static _categoriseContentRules(e){const t={on:[],on_but_disabled:[],loud:[],loud_but_disabled:[],other:[]};for(const s in e.global)for(let n=0;n<Object.keys(e.global[s]).length;++n){const i=e.global[s][n];if("."!==i.rule_id[0]&&"content"===s)switch(i.kind=s,Xy.contentRuleVectorStateKind(i)){case Qy.On:i.enabled?t.on.push(i):t.on_but_disabled.push(i);break;case Qy.Loud:i.enabled?t.loud.push(i):t.loud_but_disabled.push(i);break;default:t.other.push(i)}}return t}}.parseContentRules(e);t.state.vectorContentRules={vectorState:i.vectorState,rules:i.rules},t.state.externalContentRules=i.externalRules,t.state.vectorPushRules=[],t.state.externalPushRules=[];const o=[".m.rule.contains_display_name",".m.rule.contains_user_name",".m.rule.roomnotif","_keywords",".m.rule.room_one_to_one",".m.rule.encrypted_room_one_to_one",".m.rule.message",".m.rule.encrypted",".m.rule.invite_for_me",".m.rule.call",".m.rule.suppress_notices",".m.rule.tombstone"];for(const e in o){const s=o[e];if("_keywords"===s)t.state.vectorPushRules.push({vectorRuleId:"_keywords",description:a.a.createElement("span",null,Object(c.a)("Messages containing <span>keywords</span>",{},{span:e=>a.a.createElement("span",{className:"mx_UserNotifSettings_keywords",onClick:t.onKeywordsClicked},e)})),vectorState:t.state.vectorContentRules.vectorState});else{const e=e_[s],i=n.vector[s],o=e.ruleToVectorState(i);t.state.vectorPushRules.push({vectorRuleId:s,description:Object(c.a)(e.description),rule:i,vectorState:o}),i&&!o&&(i.description=e.description,t.state.externalPushRules.push(i))}}const r={".m.rule.message":Object(c.a)("Notify for all other messages/rooms"),".m.rule.fallback":Object(c.a)("Notify me for anything else")};for(const e in n.others){const s=n.others[e],i=r[s.rule_id];i&&s.enabled&&!s.default&&(s.description=i,t.state.externalPushRules.push(s))}})),n=le.a.get().getPushers().then((function(e){t.setState({pushers:e.pushers})}));Promise.all([s,n]).then((function(){t.setState({phase:e.phases.DISPLAY})}),(function(s){console.error(s),t.setState({phase:e.phases.ERROR})})).finally(()=>{t.setState({masterPushRule:t.state.masterPushRule,vectorContentRules:t.state.vectorContentRules,vectorPushRules:t.state.vectorPushRules,externalContentRules:t.state.externalContentRules,externalPushRules:t.state.externalPushRules})}),le.a.get().getThreePids().then(e=>this.setState({threepids:e.threepids}))}),x()(this,"_onClearNotifications",()=>{const e=le.a.get();e.getRooms().forEach(t=>{if(t.getUnreadNotificationCount()>0){const s=t.getLiveTimeline().getEvents();s.length&&e.sendReadReceipt(s.pop())}})})}componentDidMount(){this._refreshFromServer()}getEmailPusher(e,t){if(void 0!==e)for(let s=0;s<e.length;++s)if("email"===e[s].kind&&e[s].pushkey===t)return e[s]}getRule(e){for(const t in this.state.vectorPushRules){const s=this.state.vectorPushRules[t];if(s.vectorRuleId===e)return s}}_setPushRuleVectorState(t,s){if(t&&t.vectorState!==s){this.setState({phase:e.phases.LOADING});const n=this,i=le.a.get(),o=[],a=e_[t.vectorRuleId];if(t.rule){const e=a.vectorStateToActions[s];e?o.push(this._updatePushRuleActions(t.rule,e,!0)):o.push(i.setPushRuleEnabled("global",t.rule.kind,t.rule.rule_id,!1))}Promise.all(o).then((function(){n._refreshFromServer()}),(function(e){const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to change settings: "+e),Le.a.createTrackedDialog("Failed to change settings","",t,{title:Object(c.a)("Failed to change settings"),description:e&&e.message?e.message:Object(c.a)("Operation failed"),onFinished:n._refreshFromServer})}))}}_setKeywordsPushRuleVectorState(t){if(this.state.vectorContentRules.vectorState===t||0===this.state.vectorContentRules.rules.length)return;const s=this,n=le.a.get();this.setState({phase:e.phases.LOADING});const i=[];for(const e in this.state.vectorContentRules.rules){const s=this.state.vectorContentRules.rules[e];let o,a;switch(t){case Xy.ON:1!==s.actions.length&&(a=Xy.actionsFor(Xy.ON)),this.state.vectorContentRules.vectorState===Xy.OFF&&(o=!0);break;case Xy.LOUD:3!==s.actions.length&&(a=Xy.actionsFor(Xy.LOUD)),this.state.vectorContentRules.vectorState===Xy.OFF&&(o=!0);break;case Xy.OFF:o=!1}a?i.push(this._updatePushRuleActions(s,a,o)):null!=o&&i.push(n.setPushRuleEnabled("global",s.kind,s.rule_id,o))}Promise.all(i).then((function(e){s._refreshFromServer()}),(function(e){const t=d.getComponent("dialogs.ErrorDialog");console.error("Can't update user notification settings: "+e),Le.a.createTrackedDialog("Can't update user notifcation settings","",t,{title:Object(c.a)("Can't update user notification settings"),description:e&&e.message?e.message:Object(c.a)("Operation failed"),onFinished:s._refreshFromServer})}))}_setKeywords(t){this.setState({phase:e.phases.LOADING});const s=this,n=le.a.get(),i=[],o=[];for(const e in s.state.vectorContentRules.rules){const a=s.state.vectorContentRules.rules[e];o.push(a.pattern),t.indexOf(a.pattern)<0&&i.push(n.deletePushRule("global",a.kind,a.rule_id))}for(const e in s.state.externalContentRules){const o=s.state.externalContentRules[e];t.indexOf(o.pattern)>=0&&i.push(n.deletePushRule("global",o.kind,o.rule_id))}const a=function(e){const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to update keywords: "+e),Le.a.createTrackedDialog("Failed to update keywords","",t,{title:Object(c.a)("Failed to update keywords"),description:e&&e.message?e.message:Object(c.a)("Operation failed"),onFinished:s._refreshFromServer})};Promise.all(i).then((function(e){const i=[];let r=s.state.vectorContentRules.vectorState;r===Xy.OFF&&(r=s.state.vectorContentRules.rules.length?Xy.contentRuleVectorStateKind(s.state.vectorContentRules.rules[0]):Xy.ON);for(const e in t){const a=t[e];o.indexOf(a)<0&&(s.state.vectorContentRules.vectorState!==Xy.OFF?i.push(n.addPushRule("global","content",a,{actions:Xy.actionsFor(r),pattern:a})):i.push(s._addDisabledPushRule("global","content",a,{actions:Xy.actionsFor(r),pattern:a})))}Promise.all(i).then((function(e){s._refreshFromServer()}),a)}),a)}_addDisabledPushRule(e,t,s,n){const i=le.a.get();return i.addPushRule(e,t,s,n).then(()=>i.setPushRuleEnabled(e,t,s,!1))}_portRulesToNewAPI(e){const t=[],s=le.a.get();for(const n in e.global){const i=e.global[n];for(let e=0;e<i.length;++e){const o=i[e];o.rule_id in i_&&(console.log("Porting legacy rule",o),t.push(function(e,t){return s.setPushRuleActions("global",e,i_[t.rule_id],o_(t.actions)).then(()=>s.deletePushRule("global",e,t.rule_id)).catch(e=>{console.warn("Error when porting legacy rule: "+e)})}(n,o)))}}return t.length>0?Promise.all(t).then(()=>s.getPushRules()):e}_updatePushRuleActions(e,t,s){const n=le.a.get();return n.setPushRuleActions("global",e.kind,e.rule_id,t).then((function(){if(null!=s)return n.setPushRuleEnabled("global",e.kind,e.rule_id,s)}))}renderNotifRulesTableRow(e,t,s){return a.a.createElement("tr",{key:t},a.a.createElement("th",null,e),a.a.createElement("th",null,a.a.createElement("input",{className:t+"-"+Xy.OFF,type:"radio",checked:s===Xy.OFF,onChange:this.onNotifStateButtonClicked})),a.a.createElement("th",null,a.a.createElement("input",{className:t+"-"+Xy.ON,type:"radio",checked:s===Xy.ON,onChange:this.onNotifStateButtonClicked})),a.a.createElement("th",null,a.a.createElement("input",{className:t+"-"+Xy.LOUD,type:"radio",checked:s===Xy.LOUD,onChange:this.onNotifStateButtonClicked})))}renderNotifRulesTableRows(){const e=[];for(const t in this.state.vectorPushRules){const s=this.state.vectorPushRules[t];void 0===s.rule&&s.vectorRuleId.startsWith(".m.")?console.warn(`Skipping render of rule ${s.vectorRuleId} due to no underlying rule`):e.push(this.renderNotifRulesTableRow(s.description,s.vectorRuleId,s.vectorState))}return e}hasEmailPusher(e,t){if(void 0===e)return!1;for(let s=0;s<e.length;++s)if("email"===e[s].kind&&e[s].pushkey===t)return!0;return!1}emailNotificationsRow(e,t){return a.a.createElement(ja.a,{value:this.hasEmailPusher(this.state.pushers,e),onChange:this.onEnableEmailNotificationsChange.bind(this,e),label:t,key:"emailNotif_"+t})}render(){let t,s,n;if(this.state.phase===e.phases.LOADING){const e=d.getComponent("elements.Spinner");t=a.a.createElement(e,null)}if(this.state.masterPushRule&&(s=a.a.createElement(ja.a,{value:!this.state.masterPushRule.enabled,onChange:this.onEnableNotificationsChange,label:Object(c.a)("Enable notifications for this account")})),le.a.get().getRooms().some(e=>e.getUnreadNotificationCount()>0)&&(n=a.a.createElement(g.a,{onClick:this._onClearNotifications,kind:"danger"},Object(c.a)("Clear notifications"))),this.state.masterPushRule&&this.state.masterPushRule.enabled)return a.a.createElement("div",null,s,a.a.createElement("div",{className:"mx_UserNotifSettings_notifTable"},Object(c.a)("All notifications are currently disabled for all targets.")),n);const i=this.state.threepids.filter(e=>"email"===e.medium);let o;i.length>0?o=i.map(e=>this.emailNotificationsRow(e.address,`${Object(c.a)("Enable email notifications")} (${e.address})`)):V.b.getValue(nt.a.ThirdPartyID)&&(o=a.a.createElement("div",null,Object(c.a)("Add an email address to configure email notifications")));const r=[];for(const e in this.state.externalPushRules){const t=this.state.externalPushRules[e];r.push(a.a.createElement("li",null,Object(c.a)(t.description)))}let u,h,m=[];for(const e in this.state.externalContentRules){const t=this.state.externalContentRules[e];m.push(t.pattern)}if(m.length&&(m=m.join(", "),r.push(a.a.createElement("li",null,Object(c.a)("Notifications on the following keywords follow rules which can’t be displayed here:"),m))),void 0===this.state.pushers)u=a.a.createElement("div",{className:"error"},Object(c.a)("Unable to fetch notification target list"));else if(0===this.state.pushers.length)u=null;else{const e=[];for(let t=0;t<this.state.pushers.length;++t)e.push(a.a.createElement("tr",{key:t},a.a.createElement("td",null,this.state.pushers[t].app_display_name),a.a.createElement("td",null,this.state.pushers[t].device_display_name)));u=a.a.createElement("table",{className:"mx_UserNotifSettings_devicesTable"},a.a.createElement("tbody",null,e))}if(u&&(u=a.a.createElement("div",null,a.a.createElement("h3",null,Object(c.a)("Notification targets")),u)),r.length){const e=l.a.get().brand;h=a.a.createElement("div",null,a.a.createElement("h3",null,Object(c.a)("Advanced notification settings")),Object(c.a)("There are advanced notifications which are not shown here."),a.a.createElement("br",null),Object(c.a)("You might have configured them in a client other than %(brand)s. You cannot tune them in %(brand)s but they still apply.",{brand:e}),a.a.createElement("ul",null,r))}return a.a.createElement("div",null,s,a.a.createElement("div",{className:"mx_UserNotifSettings_notifTable"},t,a.a.createElement(ja.a,{value:V.b.getValue("notificationsEnabled"),onChange:this.onEnableDesktopNotificationsChange,label:Object(c.a)("Enable desktop notifications for this session")}),a.a.createElement(ja.a,{value:V.b.getValue("notificationBodyEnabled"),onChange:this.onEnableDesktopNotificationBodyChange,label:Object(c.a)("Show message in desktop notification")}),a.a.createElement(ja.a,{value:V.b.getValue("audioNotificationsEnabled"),onChange:this.onEnableAudioNotificationsChange,label:Object(c.a)("Enable audible notifications for this session")}),o,a.a.createElement("div",{className:"mx_UserNotifSettings_pushRulesTableWrapper"},a.a.createElement("table",{className:"mx_UserNotifSettings_pushRulesTable"},a.a.createElement("thead",null,a.a.createElement("tr",null,a.a.createElement("th",{width:"55%"}),a.a.createElement("th",{width:"15%"},Object(c.a)("Off")),a.a.createElement("th",{width:"15%"},Object(c.a)("On")),a.a.createElement("th",{width:"15%"},Object(c.a)("Noisy")))),a.a.createElement("tbody",null,this.renderNotifRulesTableRows()))),h,u,n))}},x()(s_,"phases",{LOADING:"LOADING",DISPLAY:"DISPLAY",ERROR:"ERROR"}),t_=n_))||t_;var r_,c_=s(620),l_=s(653);let d_=Object(P.a)("views.settings.SetIntegrationManager")(r_=class extends a.a.Component{constructor(){super(),x()(this,"onProvisioningToggled",()=>{const e=this.state.provisioningEnabled;V.b.setValue("integrationProvisioning",null,Ye.a.ACCOUNT,!e).catch(t=>{console.error("Error changing integration manager provisioning"),console.error(t),this.setState({provisioningEnabled:e})}),this.setState({provisioningEnabled:!e})});const e=_u.a.sharedInstance().getPrimaryManager();this.state={currentManager:e,provisioningEnabled:V.b.getValue("integrationProvisioning")}}render(){const e=d.getComponent("views.elements.ToggleSwitch"),t=this.state.currentManager;let s,n;return t?(s=`(${t.name})`,n=Object(c.a)("Use an Integration Manager <b>(%(serverName)s)</b> to manage bots, widgets, and sticker packs.",{serverName:t.name},{b:e=>a.a.createElement("b",null,e)})):n=Object(c.a)("Use an Integration Manager to manage bots, widgets, and sticker packs."),a.a.createElement("div",{className:"mx_SetIntegrationManager"},a.a.createElement("div",{className:"mx_SettingsTab_heading"},a.a.createElement("span",null,Object(c.a)("Manage integrations")),a.a.createElement("span",{className:"mx_SettingsTab_subheading"},s),a.a.createElement(e,{checked:this.state.provisioningEnabled,onChange:this.onProvisioningToggled})),a.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},n,a.a.createElement("br",null),a.a.createElement("br",null),Object(c.a)("Integration Managers receive configuration data, and can modify widgets, send room invites, and set power levels on your behalf.")))}})||r_;var u_,h_,m_;class p_ extends a.a.Component{constructor(){super(),x()(this,"_onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),x()(this,"_onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),x()(this,"_onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),le.a.get().deleteThreePid(this.props.email.medium,this.props.email.address).then(()=>this.props.onRemoved(this.props.email)).catch(e=>{const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to remove contact information: "+e),Le.a.createTrackedDialog("Remove 3pid failed","",t,{title:Object(c.a)("Unable to remove contact information"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?a.a.createElement("div",{className:"mx_ExistingEmailAddress"},a.a.createElement("span",{className:"mx_ExistingEmailAddress_promptText"},Object(c.a)("Remove %(email)s?",{email:this.props.email.address})),a.a.createElement(g.a,{onClick:this._onActuallyRemove,kind:"danger_sm",className:"mx_ExistingEmailAddress_confirmBtn"},Object(c.a)("Remove")),a.a.createElement(g.a,{onClick:this._onDontRemove,kind:"link_sm",className:"mx_ExistingEmailAddress_confirmBtn"},Object(c.a)("Cancel"))):a.a.createElement("div",{className:"mx_ExistingEmailAddress"},a.a.createElement("span",{className:"mx_ExistingEmailAddress_email"},this.props.email.address),a.a.createElement(g.a,{onClick:this._onRemove,kind:"danger_sm"},Object(c.a)("Remove")))}}x()(p_,"propTypes",{email:wt.a.object.isRequired,onRemoved:wt.a.func.isRequired});let g_=Object(P.a)("views.settings.account.EmailAddresses")((m_=h_=class extends a.a.Component{constructor(e){super(e),x()(this,"_onRemoved",e=>{const t=this.props.emails.filter(t=>t!==e);this.props.onEmailsChange(t)}),x()(this,"_onChangeNewEmailAddress",e=>{this.setState({newEmailAddress:e.target.value})}),x()(this,"_onAddClick",e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newEmailAddress)return;const t=d.getComponent("dialogs.ErrorDialog"),s=this.state.newEmailAddress;if(!zn.a(s))return void Le.a.createTrackedDialog("Invalid email address","",t,{title:Object(c.a)("Invalid Email Address"),description:Object(c.a)("This doesn't appear to be a valid email address")});const n=new bg;this.setState({verifying:!0,continueDisabled:!0,addTask:n}),n.addEmailAddress(s).then(()=>{this.setState({continueDisabled:!1})}).catch(e=>{console.error("Unable to add email address "+s+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),Le.a.createTrackedDialog("Unable to add email address","",t,{title:Object(c.a)("Unable to add email address"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),x()(this,"_onContinueClick",e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0}),this.state.addTask.checkEmailLinkClicked().then(([e])=>{let t=this.state.newEmailAddress;if(e){const e=this.state.newEmailAddress,s=[...this.props.emails,{address:e,medium:"email"}];this.props.onEmailsChange(s),t=""}this.setState({addTask:null,continueDisabled:!1,verifying:!1,newEmailAddress:t})}).catch(e=>{this.setState({continueDisabled:!1});const t=d.getComponent("dialogs.ErrorDialog");"M_THREEPID_AUTH_FAILED"===e.errcode?Le.a.createTrackedDialog("Email hasn't been verified yet","",t,{title:Object(c.a)("Your email address hasn't been verified yet"),description:Object(c.a)("Click the link in the email you received to verify and then click continue again.")}):(console.error("Unable to verify email address: ",e),Le.a.createTrackedDialog("Unable to verify email address","",t,{title:Object(c.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(c.a)("Operation failed")}))})}),this.state={verifying:!1,addTask:null,continueDisabled:!1,newEmailAddress:""}}render(){const e=this.props.emails.map(e=>a.a.createElement(p_,{email:e,onRemoved:this._onRemoved,key:e.address}));let t=a.a.createElement(g.a,{onClick:this._onAddClick,kind:"primary"},Object(c.a)("Add"));return this.state.verifying&&(t=a.a.createElement("div",null,a.a.createElement("div",null,Object(c.a)("We've sent you an email to verify your address. Please follow the instructions there and then click the button below.")),a.a.createElement(g.a,{onClick:this._onContinueClick,kind:"primary",disabled:this.state.continueDisabled},Object(c.a)("Continue")))),a.a.createElement("div",{className:"mx_EmailAddresses"},e,a.a.createElement("form",{onSubmit:this._onAddClick,autoComplete:"off",noValidate:!0,className:"mx_EmailAddresses_new"},a.a.createElement(Ue.a,{type:"text",label:Object(c.a)("Email Address"),autoComplete:"off",disabled:this.state.verifying,value:this.state.newEmailAddress,onChange:this._onChangeNewEmailAddress}),t))}},x()(h_,"propTypes",{emails:wt.a.array.isRequired,onEmailsChange:wt.a.func.isRequired}),u_=m_))||u_;var v_,f_,b_;class y_ extends a.a.Component{constructor(){super(),x()(this,"_onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),x()(this,"_onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),x()(this,"_onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),le.a.get().deleteThreePid(this.props.msisdn.medium,this.props.msisdn.address).then(()=>this.props.onRemoved(this.props.msisdn)).catch(e=>{const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to remove contact information: "+e),Le.a.createTrackedDialog("Remove 3pid failed","",t,{title:Object(c.a)("Unable to remove contact information"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?a.a.createElement("div",{className:"mx_ExistingPhoneNumber"},a.a.createElement("span",{className:"mx_ExistingPhoneNumber_promptText"},Object(c.a)("Remove %(phone)s?",{phone:this.props.msisdn.address})),a.a.createElement(g.a,{onClick:this._onActuallyRemove,kind:"danger_sm",className:"mx_ExistingPhoneNumber_confirmBtn"},Object(c.a)("Remove")),a.a.createElement(g.a,{onClick:this._onDontRemove,kind:"link_sm",className:"mx_ExistingPhoneNumber_confirmBtn"},Object(c.a)("Cancel"))):a.a.createElement("div",{className:"mx_ExistingPhoneNumber"},a.a.createElement("span",{className:"mx_ExistingPhoneNumber_address"},"+",this.props.msisdn.address),a.a.createElement(g.a,{onClick:this._onRemove,kind:"danger_sm"},Object(c.a)("Remove")))}}x()(y_,"propTypes",{msisdn:wt.a.object.isRequired,onRemoved:wt.a.func.isRequired});let __=Object(P.a)("views.settings.account.PhoneNumbers")((b_=f_=class extends a.a.Component{constructor(e){super(e),x()(this,"_onRemoved",e=>{const t=this.props.msisdns.filter(t=>t!==e);this.props.onMsisdnsChange(t)}),x()(this,"_onChangeNewPhoneNumber",e=>{this.setState({newPhoneNumber:e.target.value})}),x()(this,"_onChangeNewPhoneNumberCode",e=>{this.setState({newPhoneNumberCode:e.target.value})}),x()(this,"_onAddClick",e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newPhoneNumber)return;const t=d.getComponent("dialogs.ErrorDialog"),s=this.state.newPhoneNumber,n=this.state.phoneCountry,i=new bg;this.setState({verifying:!0,continueDisabled:!0,addTask:i}),i.addMsisdn(n,s).then(e=>{this.setState({continueDisabled:!1,verifyMsisdn:e.msisdn})}).catch(e=>{console.error("Unable to add phone number "+s+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),Le.a.createTrackedDialog("Add Phone Number Error","",t,{title:Object(c.a)("Error"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}),x()(this,"_onContinueClick",e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const t=this.state.newPhoneNumberCode,s=this.state.verifyMsisdn;this.state.addTask.haveMsisdnToken(t).then(([e])=>{let t=this.state.newPhoneNumber;if(e){const e=[...this.props.msisdns,{address:s,medium:"msisdn"}];this.props.onMsisdnsChange(e),t=""}this.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyMsisdn:"",verifyError:null,newPhoneNumber:t,newPhoneNumberCode:""})}).catch(e=>{if(this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"!==e.errcode){const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to verify phone number: "+e),Le.a.createTrackedDialog("Unable to verify phone number","",t,{title:Object(c.a)("Unable to verify phone number."),description:e&&e.message?e.message:Object(c.a)("Operation failed")})}else this.setState({verifyError:Object(c.a)("Incorrect verification code")})})}),x()(this,"_onCountryChanged",e=>{this.setState({phoneCountry:e.iso2})}),this.state={verifying:!1,verifyError:!1,verifyMsisdn:"",addTask:null,continueDisabled:!1,phoneCountry:"",newPhoneNumber:"",newPhoneNumberCode:""}}render(){const e=this.props.msisdns.map(e=>a.a.createElement(y_,{msisdn:e,onRemoved:this._onRemoved,key:e.address}));let t=a.a.createElement(g.a,{onClick:this._onAddClick,kind:"primary"},Object(c.a)("Add"));if(this.state.verifying){const e=this.state.verifyMsisdn;t=a.a.createElement("div",null,a.a.createElement("div",null,Object(c.a)("A text message has been sent to +%(msisdn)s. Please enter the verification code it contains.",{msisdn:e}),a.a.createElement("br",null),this.state.verifyError),a.a.createElement("form",{onSubmit:this._onContinueClick,autoComplete:"off",noValidate:!0},a.a.createElement(Ue.a,{type:"text",label:Object(c.a)("Verification code"),autoComplete:"off",disabled:this.state.continueDisabled,value:this.state.newPhoneNumberCode,onChange:this._onChangeNewPhoneNumberCode}),a.a.createElement(g.a,{onClick:this._onContinueClick,kind:"primary",disabled:this.state.continueDisabled},Object(c.a)("Continue"))))}const s=a.a.createElement(si,{onOptionChange:this._onCountryChanged,className:"mx_PhoneNumbers_country",value:this.state.phoneCountry,disabled:this.state.verifying,isSmall:!0,showPrefix:!0});return a.a.createElement("div",{className:"mx_PhoneNumbers"},e,a.a.createElement("form",{onSubmit:this._onAddClick,autoComplete:"off",noValidate:!0,className:"mx_PhoneNumbers_new"},a.a.createElement("div",{className:"mx_PhoneNumbers_input"},a.a.createElement(Ue.a,{type:"text",label:Object(c.a)("Phone Number"),autoComplete:"off",disabled:this.state.verifying,prefixComponent:s,value:this.state.newPhoneNumber,onChange:this._onChangeNewPhoneNumber}))),t)}},x()(f_,"propTypes",{msisdns:wt.a.array.isRequired,onMsisdnsChange:wt.a.func.isRequired}),v_=b_))||v_;var E_,S_,w_;class C_ extends a.a.Component{constructor(e){super(e),x()(this,"onRevokeClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:Object(c.a)("Unable to revoke sharing for email address")})}),x()(this,"onShareClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:Object(c.a)("Unable to share email address")})}),x()(this,"onContinueClick",async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});try{await this.state.addTask.checkEmailLinkClicked(),this.setState({addTask:null,continueDisabled:!1,verifying:!1})}catch(e){this.setState({continueDisabled:!1});const t=d.getComponent("dialogs.ErrorDialog");"M_THREEPID_AUTH_FAILED"===e.errcode?Le.a.createTrackedDialog("E-mail hasn't been verified yet","",t,{title:Object(c.a)("Your email address hasn't been verified yet"),description:Object(c.a)("Click the link in the email you received to verify and then click continue again.")}):(console.error("Unable to verify email address: "+e),Le.a.createTrackedDialog("Unable to verify email address","",t,{title:Object(c.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(c.a)("Operation failed")}))}});const{bound:t}=e.email;this.state={verifying:!1,addTask:null,continueDisabled:!1,bound:t}}UNSAFE_componentWillReceiveProps(e){const{bound:t}=e.email;this.setState({bound:t})}async changeBinding({bind:e,label:t,errorTitle:s}){if(!await le.a.get().doesServerSupportSeparateAddAndBind())return this.changeBindingTangledAddBind({bind:e,label:t,errorTitle:s});const n=d.getComponent("dialogs.ErrorDialog"),{medium:i,address:o}=this.props.email;try{if(e){const e=new bg;this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindEmailAddress(o),this.setState({continueDisabled:!1})}else await le.a.get().unbindThreePid(i,o);this.setState({bound:e})}catch(e){console.error(`Unable to ${t} email address ${o} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),Le.a.createTrackedDialog(`Unable to ${t} email address`,"",n,{title:s,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}async changeBindingTangledAddBind({bind:e,label:t,errorTitle:s}){const n=d.getComponent("dialogs.ErrorDialog"),{medium:i,address:o}=this.props.email,a=new bg;this.setState({verifying:!0,continueDisabled:!0,addTask:a});try{await le.a.get().deleteThreePid(i,o),e?await a.bindEmailAddress(o):await a.addEmailAddress(o),this.setState({continueDisabled:!1,bound:e})}catch(e){console.error(`Unable to ${t} email address ${o} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),Le.a.createTrackedDialog(`Unable to ${t} email address`,"",n,{title:s,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}render(){const e=d.getComponent("elements.AccessibleButton"),{address:t}=this.props.email,{verifying:s,bound:n}=this.state;let i;return i=s?a.a.createElement("span",null,Object(c.a)("Verify the link in your inbox"),a.a.createElement(e,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"primary_sm",onClick:this.onContinueClick,disabled:this.state.continueDisabled},Object(c.a)("Complete"))):n?a.a.createElement(e,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"danger_sm",onClick:this.onRevokeClick},Object(c.a)("Revoke")):a.a.createElement(e,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"primary_sm",onClick:this.onShareClick},Object(c.a)("Share")),a.a.createElement("div",{className:"mx_ExistingEmailAddress"},a.a.createElement("span",{className:"mx_ExistingEmailAddress_email"},t),i)}}x()(C_,"propTypes",{email:wt.a.object.isRequired});let k_=Object(P.a)("views.settings.discovery.EmailAddresses")((w_=S_=class extends a.a.Component{render(){let e;return e=this.props.emails.length>0?this.props.emails.map(e=>a.a.createElement(C_,{email:e,key:e.address})):a.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Discovery options will appear once you have added an email above.")),a.a.createElement("div",{className:"mx_EmailAddresses"},e)}},x()(S_,"propTypes",{emails:wt.a.array.isRequired}),E_=w_))||E_;var O_,R_,I_;class x_ extends a.a.Component{constructor(e){super(e),x()(this,"onRevokeClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:Object(c.a)("Unable to revoke sharing for phone number")})}),x()(this,"onShareClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:Object(c.a)("Unable to share phone number")})}),x()(this,"onVerificationCodeChange",e=>{this.setState({verificationCode:e.target.value})}),x()(this,"onContinueClick",async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const t=this.state.verificationCode;try{await this.state.addTask.haveMsisdnToken(t),this.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyError:null,verificationCode:""})}catch(e){if(this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"!==e.errcode){const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to verify phone number: "+e),Le.a.createTrackedDialog("Unable to verify phone number","",t,{title:Object(c.a)("Unable to verify phone number."),description:e&&e.message?e.message:Object(c.a)("Operation failed")})}else this.setState({verifyError:Object(c.a)("Incorrect verification code")})}});const{bound:t}=e.msisdn;this.state={verifying:!1,verificationCode:"",addTask:null,continueDisabled:!1,bound:t}}UNSAFE_componentWillReceiveProps(e){const{bound:t}=e.msisdn;this.setState({bound:t})}async changeBinding({bind:e,label:t,errorTitle:s}){if(!await le.a.get().doesServerSupportSeparateAddAndBind())return this.changeBindingTangledAddBind({bind:e,label:t,errorTitle:s});const n=d.getComponent("dialogs.ErrorDialog"),{medium:i,address:o}=this.props.msisdn;try{if(e){const e=new bg;this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindMsisdn(null,"+"+o),this.setState({continueDisabled:!1})}else await le.a.get().unbindThreePid(i,o);this.setState({bound:e})}catch(e){console.error(`Unable to ${t} phone number ${o} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),Le.a.createTrackedDialog(`Unable to ${t} phone number`,"",n,{title:s,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}async changeBindingTangledAddBind({bind:e,label:t,errorTitle:s}){const n=d.getComponent("dialogs.ErrorDialog"),{medium:i,address:o}=this.props.msisdn,a=new bg;this.setState({verifying:!0,continueDisabled:!0,addTask:a});try{await le.a.get().deleteThreePid(i,o),e?await a.bindMsisdn(null,"+"+o):await a.addMsisdn(null,"+"+o),this.setState({continueDisabled:!1,bound:e})}catch(e){console.error(`Unable to ${t} phone number ${o} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),Le.a.createTrackedDialog(`Unable to ${t} phone number`,"",n,{title:s,description:e&&e.message?e.message:Object(c.a)("Operation failed")})}}render(){const e=d.getComponent("elements.AccessibleButton"),t=d.getComponent("elements.Field"),{address:s}=this.props.msisdn,{verifying:n,bound:i}=this.state;let o;return o=n?a.a.createElement("span",{className:"mx_ExistingPhoneNumber_verification"},a.a.createElement("span",null,Object(c.a)("Please enter verification code sent via text."),a.a.createElement("br",null),this.state.verifyError),a.a.createElement("form",{onSubmit:this.onContinueClick,autoComplete:"off",noValidate:!0},a.a.createElement(t,{type:"text",label:Object(c.a)("Verification code"),autoComplete:"off",disabled:this.state.continueDisabled,value:this.state.verificationCode,onChange:this.onVerificationCodeChange}))):i?a.a.createElement(e,{className:"mx_ExistingPhoneNumber_confirmBtn",kind:"danger_sm",onClick:this.onRevokeClick},Object(c.a)("Revoke")):a.a.createElement(e,{className:"mx_ExistingPhoneNumber_confirmBtn",kind:"primary_sm",onClick:this.onShareClick},Object(c.a)("Share")),a.a.createElement("div",{className:"mx_ExistingPhoneNumber"},a.a.createElement("span",{className:"mx_ExistingPhoneNumber_address"},"+",s),o)}}x()(x_,"propTypes",{msisdn:wt.a.object.isRequired});let T_=Object(P.a)("views.settings.discovery.PhoneNumbers")((I_=R_=class extends a.a.Component{render(){let e;return e=this.props.msisdns.length>0?this.props.msisdns.map(e=>a.a.createElement(x_,{msisdn:e,key:e.address})):a.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(c.a)("Discovery options will appear once you have added a phone number above.")),a.a.createElement("div",{className:"mx_PhoneNumbers"},e)}},x()(R_,"propTypes",{msisdns:wt.a.array.isRequired}),O_=I_))||O_;var j_,N_,P_,D_=s(724),A_=s(726),M_=s(660),U_=s(619),L_=s(642),F_=s(655),B_=s(652),V_=s(657);let K_=Object(P.a)("views.terms.InlineTermsAgreement")((P_=N_=class extends a.a.Component{constructor(){super(),x()(this,"_togglePolicy",e=>{const t=Object(Se.a)(this.state.policies);t[e].checked=!t[e].checked,this.setState({policies:t})}),x()(this,"_onContinue",()=>{!!this.state.policies.some(e=>!e.checked)||(this.setState({busy:!0}),this.props.onFinished(this.state.policies.map(e=>e.url)))}),this.state={policies:[],busy:!1}}componentDidMount(){const e=[];for(const t of this.props.policiesAndServicePairs){const s=Object.values(t.policies);for(const t of s){const s=Object(c.i)(Object.keys(t).filter(e=>"version"!==e)),n={checked:!1,url:t[s].url,name:t[s].name};e.push(n)}}this.setState({policies:e})}_renderCheckboxes(){const e=[];for(let t=0;t<this.state.policies.length;t++){const s=this.state.policies[t],n=Object(c.a)("Accept <policyLink /> to continue:",{},{policyLink:()=>a.a.createElement("a",{href:s.url,rel:"noreferrer noopener",target:"_blank"},s.name,a.a.createElement("span",{className:"mx_InlineTermsAgreement_link"}))});e.push(a.a.createElement("div",{key:t,className:"mx_InlineTermsAgreement_cbContainer"},a.a.createElement("div",null,n),a.a.createElement("div",{className:"mx_InlineTermsAgreement_checkbox"},a.a.createElement(La.a,{onChange:()=>this._togglePolicy(t),checked:s.checked},Object(c.a)("Accept")))))}return e}render(){const e=d.getComponent("views.elements.AccessibleButton"),t=!!this.state.policies.some(e=>!e.checked);return a.a.createElement("div",null,this.props.introElement,this._renderCheckboxes(),a.a.createElement(e,{onClick:this._onContinue,disabled:t||this.state.busy,kind:"primary_sm"},Object(c.a)("Continue")))}},x()(N_,"propTypes",{policiesAndServicePairs:wt.a.array.isRequired,agreedUrls:wt.a.array.isRequired,onFinished:wt.a.func.isRequired,introElement:wt.a.node}),j_=P_))||j_;var W_,G_,q_;let H_=Object(P.a)("views.verification.VerificationCancelled")((q_=G_=class extends a.a.Component{render(){const e=d.getComponent("views.elements.DialogButtons");return a.a.createElement("div",null,a.a.createElement("p",null,Object(c.a)("The other party cancelled the verification.")),a.a.createElement(e,{primaryButton:Object(c.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this.props.onDone}))}},x()(G_,"propTypes",{onDone:wt.a.func.isRequired}),W_=q_))||W_;var $_,z_,Y_;let J_=Object(P.a)("views.verification.VerificationComplete")((Y_=z_=class extends a.a.Component{render(){const e=d.getComponent("views.elements.DialogButtons");return a.a.createElement("div",null,a.a.createElement("h2",null,Object(c.a)("Verified!")),a.a.createElement("p",null,Object(c.a)("You've successfully verified this user.")),a.a.createElement("p",null,Object(c.a)("Secure messages with this user are end-to-end encrypted and not able to be read by third parties.")),a.a.createElement(e,{onPrimaryButtonClick:this.props.onDone,primaryButton:Object(c.a)("Got It"),hasCancel:!1}))}},x()(z_,"propTypes",{onDone:wt.a.func.isRequired}),$_=Y_))||$_;var Q_,X_,Z_,eE=s(275);let tE=Object(P.a)("views.verification.VerificationQREmojiOptions")((Z_=X_=class extends a.a.Component{render(){const{request:e}=this.props;let t;return t=e.otherPartySupportsMethod(eE.c)?a.a.createElement(Sv.a,{qrCodeData:e.qrCodeData}):a.a.createElement("div",{className:"mx_VerificationQREmojiOptions_noQR"},a.a.createElement(Rn.a,null)),a.a.createElement("div",null,Object(c.a)("Verify this session by completing one of the following:"),a.a.createElement("div",{className:"mx_IncomingSasDialog_startOptions"},a.a.createElement("div",{className:"mx_IncomingSasDialog_startOption"},a.a.createElement("p",null,Object(c.a)("Scan this unique code")),t),a.a.createElement("div",{className:"mx_IncomingSasDialog_betweenText"},Object(c.a)("or")),a.a.createElement("div",{className:"mx_IncomingSasDialog_startOption"},a.a.createElement("p",null,Object(c.a)("Compare unique emoji")),a.a.createElement("span",{className:"mx_IncomingSasDialog_helpText"},Object(c.a)("Compare a unique set of emoji if you don't have a camera on either device")),a.a.createElement(g.a,{onClick:this.props.onStartEmoji,kind:"primary"},Object(c.a)("Start")))),a.a.createElement(g.a,{onClick:this.props.onCancel,kind:"danger"},Object(c.a)("Cancel")))}},x()(X_,"propTypes",{request:wt.a.object.isRequired,onCancel:wt.a.func.isRequired,onStartEmoji:wt.a.func.isRequired}),Q_=Z_))||Q_;var sE,nE,iE;let oE=Object(P.a)("views.verification.VerificationShowSas")((iE=nE=class extends a.a.Component{constructor(e){super(e),x()(this,"onMatchClick",()=>{this.setState({pending:!0}),this.props.onDone()}),x()(this,"onDontMatchClick",()=>{this.setState({cancelling:!0}),this.props.onCancel()}),this.state={pending:!1}}componentWillMount(){Gt()}render(){let e,t,s;if(this.props.sas.emoji){const s=this.props.sas.emoji.map((e,t)=>{return a.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_block",key:t},a.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_emoji"},e[0]),a.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_label"},Object(c.a)((s=e[1]).charAt(0).toUpperCase()+s.slice(1))));var s});e=a.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas"},s.slice(0,4),a.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_break"}),s.slice(4)),t=this.props.isSelf?Object(c.a)("Confirm the emoji below are displayed on both sessions, in the same order:"):Object(c.a)("Verify this user by confirming the following emoji appear on their screen.")}else{if(!this.props.sas.decimal)return a.a.createElement("div",null,Object(c.a)("Unable to find a supported verification method."),a.a.createElement(g.a,{kind:"primary",onClick:this.props.onCancel,className:"mx_UserInfo_wideButton"},Object(c.a)("Cancel")));{const s=this.props.sas.decimal.map((e,t)=>a.a.createElement("span",{key:t},e));e=a.a.createElement("div",{className:"mx_VerificationShowSas_decimalSas"},s),t=this.props.isSelf?Object(c.a)("Verify this session by confirming the following number appears on its screen."):Object(c.a)("Verify this user by confirming the following number appears on their screen.")}}if(this.state.pending||this.state.cancelling){let e;if(this.state.pending)if(this.props.isSelf)e=this.props.device?Object(c.a)("Waiting for your other session, %(deviceName)s (%(deviceId)s), to verify…",{deviceName:this.props.device?this.props.device.getDisplayName():"",deviceId:this.props.device?this.props.device.deviceId:""}):Object(c.a)("Waiting for your other session to verify…");else{const{displayName:t}=this.props;e=Object(c.a)("Waiting for %(displayName)s to verify…",{displayName:t})}else e=Object(c.a)("Cancelling…");s=a.a.createElement($c.a,{text:e})}else s=this.props.inDialog?a.a.createElement(Bi.a,{primaryButton:Object(c.a)("They match"),onPrimaryButtonClick:this.onMatchClick,primaryButtonClass:"mx_UserInfo_wideButton mx_VerificationShowSas_matchButton",cancelButton:Object(c.a)("They don't match"),onCancel:this.onDontMatchClick,cancelButtonClass:"mx_UserInfo_wideButton mx_VerificationShowSas_noMatchButton"}):a.a.createElement(a.a.Fragment,null,a.a.createElement(g.a,{onClick:this.onDontMatchClick,kind:"danger"},Object(c.a)("They don't match")),a.a.createElement(g.a,{onClick:this.onMatchClick,kind:"primary"},Object(c.a)("They match")));return a.a.createElement("div",{className:"mx_VerificationShowSas"},a.a.createElement("p",null,t),e,a.a.createElement("p",null,this.props.isSelf?"":Object(c.a)("To be secure, do this in person or use a trusted way to communicate.")),s)}},x()(nE,"propTypes",{pending:wt.a.bool,displayName:wt.a.string,device:wt.a.object,onDone:wt.a.func.isRequired,onCancel:wt.a.func.isRequired,sas:wt.a.object.isRequired,isSelf:wt.a.bool,inDialog:wt.a.bool}),sE=iE))||sE;Object(c.b)("Dog"),Object(c.b)("Cat"),Object(c.b)("Lion"),Object(c.b)("Horse"),Object(c.b)("Unicorn"),Object(c.b)("Pig"),Object(c.b)("Elephant"),Object(c.b)("Rabbit"),Object(c.b)("Panda"),Object(c.b)("Rooster"),Object(c.b)("Penguin"),Object(c.b)("Turtle"),Object(c.b)("Fish"),Object(c.b)("Octopus"),Object(c.b)("Butterfly"),Object(c.b)("Flower"),Object(c.b)("Tree"),Object(c.b)("Cactus"),Object(c.b)("Mushroom"),Object(c.b)("Globe"),Object(c.b)("Moon"),Object(c.b)("Cloud"),Object(c.b)("Fire"),Object(c.b)("Banana"),Object(c.b)("Apple"),Object(c.b)("Strawberry"),Object(c.b)("Corn"),Object(c.b)("Pizza"),Object(c.b)("Cake"),Object(c.b)("Heart"),Object(c.b)("Smiley"),Object(c.b)("Robot"),Object(c.b)("Hat"),Object(c.b)("Glasses"),Object(c.b)("Spanner"),Object(c.b)("Santa"),Object(c.b)("Thumbs up"),Object(c.b)("Umbrella"),Object(c.b)("Hourglass"),Object(c.b)("Clock"),Object(c.b)("Gift"),Object(c.b)("Light bulb"),Object(c.b)("Book"),Object(c.b)("Pencil"),Object(c.b)("Paperclip"),Object(c.b)("Scissors"),Object(c.b)("Lock"),Object(c.b)("Key"),Object(c.b)("Hammer"),Object(c.b)("Telephone"),Object(c.b)("Flag"),Object(c.b)("Train"),Object(c.b)("Bicycle"),Object(c.b)("Aeroplane"),Object(c.b)("Rocket"),Object(c.b)("Trophy"),Object(c.b)("Ball"),Object(c.b)("Guitar"),Object(c.b)("Trumpet"),Object(c.b)("Bell"),Object(c.b)("Anchor"),Object(c.b)("Headphones"),Object(c.b)("Folder"),Object(c.b)("Pin");let aE={};n.a&&(aE["structures.AutoHideScrollbar"]=n.a),i.o&&(aE["structures.ContextMenu"]=i.o),R&&(aE["structures.HomePage"]=R),D&&(aE["structures.HostSignupAction"]=D),Lt&&(aE["structures.LeftPanel"]=Lt),At&&(aE["structures.LeftPanelWidget"]=At),dn&&(aE["structures.LoggedInView"]=dn),un.a&&(aE["structures.MatrixChat"]=un.a),bs&&(aE["structures.NonUrgentToastContainer"]=bs),hn.a&&(aE["structures.NotificationPanel"]=hn.a),mn.a&&(aE["structures.RightPanel"]=mn.a),jn&&(aE["structures.RoomDirectory"]=jn),lt.a&&(aE["structures.RoomSearch"]=lt.a),Dn.a&&(aE["structures.RoomView"]=Dn.a),An.b&&(aE["structures.SpaceRoomDirectory"]=An.b),js.b&&(aE["structures.SpaceRoomView"]=js.b),Mn.b&&(aE["structures.TabbedView"]=Mn.b),Un&&(aE["structures.ToastContainer"]=Un),Wn&&(aE["structures.UploadBar"]=Wn),ct&&(aE["structures.UserMenu"]=ct),Si&&(aE["structures.auth.Login"]=Si),Ri&&(aE["structures.auth.Registration"]=Ri),Mi&&(aE["structures.auth.SoftLogout"]=Mi),Ui.d&&(aE["views.auth.InteractiveAuthEntryComponents"]=Ui.d),Li.a&&(aE["views.auth.PassphraseField"]=Li.a),ci&&(aE["views.auth.PasswordLogin"]=ci),$i&&(aE["views.auth.RegistrationForm"]=$i),m.a&&(aE["views.avatars.BaseAvatar"]=m.a),mt.a&&(aE["views.avatars.DecoratedRoomAvatar"]=mt.a),ge&&(aE["views.avatars.GroupAvatar"]=ge),Yi.a&&(aE["views.avatars.MemberAvatar"]=Yi.a),Oe.a&&(aE["views.avatars.RoomAvatar"]=Oe.a),Ji.a&&(aE["views.avatars.WidgetAvatar"]=Ji.a),xs.b&&(aE["views.beta.BetaCard"]=xs.b),Qi.a&&(aE["views.context_menus.CallContextMenu"]=Qi.a),Xi.a&&(aE["views.context_menus.DialpadContextMenu"]=Xi.a),T.e&&(aE["views.context_menus.IconizedContextMenu"]=T.e),Zi.a&&(aE["views.context_menus.WidgetContextMenu"]=Zi.a),eo.b&&(aE["views.dialogs.AddExistingToSpaceDialog"]=eo.b),to.a&&(aE["views.dialogs.AskInviteAnywayDialog"]=to.a),so.a&&(aE["views.dialogs.BetaFeedbackDialog"]=so.a),Be&&(aE["views.dialogs.BugReportDialog"]=Be),no.a&&(aE["views.dialogs.ChangelogDialog"]=no.a),io.a&&(aE["views.dialogs.CommunityPrototypeInviteDialog"]=io.a),oo&&(aE["views.dialogs.ConfirmAndWaitRedactDialog"]=oo),ro&&(aE["views.dialogs.ConfirmRedactDialog"]=ro),lo.a&&(aE["views.dialogs.ConfirmUserActionDialog"]=lo.a),uo&&(aE["views.dialogs.ConfirmWipeDeviceDialog"]=uo),mo.a&&(aE["views.dialogs.CreateCommunityPrototypeDialog"]=mo.a),po&&(aE["views.dialogs.CreateGroupDialog"]=po),go.a&&(aE["views.dialogs.CreateRoomDialog"]=go.a),vo&&(aE["views.dialogs.CryptoStoreTooNewDialog"]=vo),fo.a&&(aE["views.dialogs.DeactivateAccountDialog"]=fo.a),bo.b&&(aE["views.dialogs.DevtoolsDialog"]=bo.b),tt&&(aE["views.dialogs.EditCommunityPrototypeDialog"]=tt),Xe.a&&(aE["views.dialogs.ErrorDialog"]=Xe.a),yo.a&&(aE["views.dialogs.ForwardDialog"]=yo.a),Ss&&(aE["views.dialogs.HostSignupDialog"]=Ss),_o.d&&(aE["views.dialogs.InviteDialog"]=_o.d),Eo.a&&(aE["views.dialogs.ModalWidgetDialog"]=Eo.a),Hi&&(aE["views.dialogs.RegistrationEmailPromptDialog"]=Hi),Po&&(aE["views.dialogs.ReportEventDialog"]=Po),Ao.b&&(aE["views.dialogs.RoomSettingsDialog"]=Ao.b),Mo.a&&(aE["views.dialogs.ServerOfflineDialog"]=Mo.a),vi&&(aE["views.dialogs.ServerPickerDialog"]=vi),Uo&&(aE["views.dialogs.SeshatResetDialog"]=Uo),Fo.a&&(aE["views.dialogs.ShareDialog"]=Fo.a),Bo.a&&(aE["views.dialogs.SpaceSettingsDialog"]=Bo.a),qo&&(aE["views.dialogs.TermsDialog"]=qo),Ho.a&&(aE["views.dialogs.UntrustedDeviceDialog"]=Ho.a),Xo&&(aE["views.dialogs.UploadConfirmDialog"]=Xo),Ae.b&&(aE["views.dialogs.UserSettingsDialog"]=Ae.b),ea.a&&(aE["views.dialogs.WidgetCapabilitiesPromptDialog"]=ea.a),ta.a&&(aE["views.dialogs.security.AccessSecretStorageDialog"]=ta.a),sa&&(aE["views.dialogs.security.ConfirmDestroyCrossSigningDialog"]=sa),la&&(aE["views.dialogs.security.CreateCrossSigningDialog"]=la),ua.a&&(aE["views.dialogs.security.SetupEncryptionDialog"]=ua.a),Sn&&(aE["views.directory.NetworkDropdown"]=Sn),g.a&&(aE["views.elements.AccessibleButton"]=g.a),K.a&&(aE["views.elements.AccessibleTooltipButton"]=K.a),ha.b&&(aE["views.elements.DesktopBuildsNotice"]=ha.b),ma.a&&(aE["views.elements.DesktopCapturerSourcePicker"]=ma.a),pa&&(aE["views.elements.Draggable"]=pa),ga.a&&(aE["views.elements.EditableItemList"]=ga.a),va.a&&(aE["views.elements.EffectsOverlay"]=va.a),_a&&(aE["views.elements.EventListSummary"]=_a),Ea.a&&(aE["views.elements.EventTilePreview"]=Ea.a),Sa.a&&(aE["views.elements.FacePile"]=Sa.a),Ue.a&&(aE["views.elements.Field"]=Ue.a),wa&&(aE["views.elements.IRCTimelineProfileResizer"]=wa),Ia.a&&(aE["views.elements.ImageView"]=Ia.a),xa.a&&(aE["views.elements.InfoTooltip"]=xa.a),ot.a&&(aE["views.elements.InlineSpinner"]=ot.a),Ta.a&&(aE["views.elements.InviteReason"]=Ta.a),ja.a&&(aE["views.elements.LabelledToggleSwitch"]=ja.a),Na&&(aE["views.elements.MemberEventListSummary"]=Na),y.b&&(aE["views.elements.MiniAvatarUploader"]=y.b),Kn.a&&(aE["views.elements.ProgressBar"]=Kn.a),Pa.a&&(aE["views.elements.QRCode"]=Pa.a),Ps.a&&(aE["views.elements.RoomAliasField"]=Ps.a),it.a&&(aE["views.elements.RoomName"]=it.a),Da.a&&(aE["views.elements.RoomTopic"]=Da.a),hi&&(aE["views.elements.SSOButtons"]=hi),yi&&(aE["views.elements.ServerPicker"]=yi),Aa.a&&(aE["views.elements.SettingsFlag"]=Aa.a),Ma.a&&(aE["views.elements.Slider"]=Ma.a),Ua.a&&(aE["views.elements.SpellCheckLanguagesDropdown"]=Ua.a),La.a&&(aE["views.elements.StyledCheckbox"]=La.a),gi.a&&(aE["views.elements.StyledRadioButton"]=gi.a),Ke.a&&(aE["views.elements.StyledRadioGroup"]=Ke.a),Fa.a&&(aE["views.elements.ToggleSwitch"]=Fa.a),Ba.b&&(aE["views.elements.Tooltip"]=Ba.b),at&&(aE["views.elements.TooltipButton"]=at),Va.a&&(aE["views.elements.TruncatedList"]=Va.a),W&&(aE["views.elements.UserTagTile"]=W),Ts.a&&(aE["views.elements.Validation"]=Ts.a),dr&&(aE["views.emojipicker.Category"]=dr),Za&&(aE["views.emojipicker.Emoji"]=Za),or&&(aE["views.emojipicker.EmojiPicker"]=or),$a&&(aE["views.emojipicker.Header"]=$a),Qa&&(aE["views.emojipicker.Preview"]=Qa),sr&&(aE["views.emojipicker.QuickReactions"]=sr),ur&&(aE["views.emojipicker.ReactionPicker"]=ur),Ya&&(aE["views.emojipicker.Search"]=Ya),ws&&(aE["views.host_signup.HostSignupContainer"]=ws),gr&&(aE["views.messages.EncryptionEvent"]=gr),hr.a&&(aE["views.messages.EventTileBubble"]=hr.a),br&&(aE["views.messages.MJitsiWidgetEvent"]=br),Sr&&(aE["views.messages.MKeyVerificationRequest"]=Sr),Pr&&(aE["views.messages.MVideoBody"]=Pr),gc&&(aE["views.messages.MVoiceMessageBody"]=gc),Ec&&(aE["views.messages.MVoiceOrAudioBody"]=Ec),kc.a&&(aE["views.messages.MessageTimestamp"]=kc.a),Mc&&(aE["views.messages.ReactionsRow"]=Mc),jc&&(aE["views.messages.ReactionsRowButton"]=jc),Rc&&(aE["views.messages.ReactionsRowButtonTooltip"]=Rc),Lc.a&&(aE["views.messages.RedactedBody"]=Lc.a),Gc&&(aE["views.messages.SenderProfile"]=Gc),Hc.b&&(aE["views.right_panel.BaseCard"]=Hc.b),$c.b&&(aE["views.right_panel.EncryptionInfo"]=$c.b),zc.a&&(aE["views.right_panel.EncryptionPanel"]=zc.a),Zc&&(aE["views.right_panel.GroupHeaderButtons"]=Zc),Yc.a&&(aE["views.right_panel.HeaderButton"]=Yc.a),Jc.b&&(aE["views.right_panel.HeaderButtons"]=Jc.b),el.b&&(aE["views.right_panel.PinnedMessagesCard"]=el.b),tl.a&&(aE["views.right_panel.RoomHeaderButtons"]=tl.a),sl.a&&(aE["views.right_panel.RoomSummaryCard"]=sl.a),nl.a&&(aE["views.right_panel.UserInfo"]=nl.a),il.a&&(aE["views.right_panel.VerificationPanel"]=il.a),ol.a&&(aE["views.right_panel.WidgetCard"]=ol.a),al.a&&(aE["views.room_settings.AliasSettings"]=al.a),rl.a&&(aE["views.room_settings.RoomPublishSetting"]=rl.a),rd&&(aE["views.rooms.Autocomplete"]=rd),cd.a&&(aE["views.rooms.AuxPanel"]=cd.a),hu&&(aE["views.rooms.BasicMessageComposer"]=hu),vu.b&&(aE["views.rooms.EntityTile"]=vu.b),fu.a&&(aE["views.rooms.EventTile"]=fu.a),fe&&(aE["views.rooms.ExtraTile"]=fe),bu.a&&(aE["views.rooms.MemberList"]=bu.a),yu.a&&(aE["views.rooms.MemberTile"]=yu.a),Gu&&(aE["views.rooms.MessageComposer"]=Gu),qu.a&&(aE["views.rooms.NewRoomIntro"]=qu.a),ve.a&&(aE["views.rooms.NotificationBadge"]=ve.a),Hu.a&&(aE["views.rooms.PinnedEventTile"]=Hu.a),$u.a&&(aE["views.rooms.PresenceLabel"]=$u.a),bt&&(aE["views.rooms.RoomBreadcrumbs"]=bt),Ne&&(aE["views.rooms.RoomList"]=Ne),kt&&(aE["views.rooms.RoomListNumResults"]=kt),ce.b&&(aE["views.rooms.RoomSublist"]=ce.b),zu.a&&(aE["views.rooms.RoomTile"]=zu.a),Yu.b&&(aE["views.rooms.SearchBar"]=Yu.b),Ju.a&&(aE["views.rooms.ThirdPartyMemberInfo"]=Ju.a),Lu&&(aE["views.rooms.VoiceRecordComposerTile"]=Lu),sh&&(aE["views.rooms.WhoIsTypingTile"]=sh),ih.a&&(aE["views.settings.BridgeTile"]=ih.a),oh.a&&(aE["views.settings.E2eAdvancedPanel"]=oh.a),rh&&(aE["views.settings.EventIndexPanel"]=rh),uh&&(aE["views.settings.SetIdServer"]=uh),mh.a&&(aE["views.settings.SpellCheckSettings"]=mh.a),ph.a&&(aE["views.settings.UpdateCheckButton"]=ph.a),gh.a&&(aE["views.settings.tabs.room.AdvancedRoomSettingsTab"]=gh.a),vh.a&&(aE["views.settings.tabs.room.BridgeSettingsTab"]=vh.a),fh.a&&(aE["views.settings.tabs.room.RolesRoomSettingsTab"]=fh.a),bh.d&&(aE["views.settings.tabs.room.SecurityRoomSettingsTab"]=bh.d),yh.a&&(aE["views.settings.tabs.user.AppearanceUserSettingsTab"]=yh.a),_h.a&&(aE["views.settings.tabs.user.HelpUserSettingsTab"]=_h.a),Eh.a&&(aE["views.settings.tabs.user.MjolnirUserSettingsTab"]=Eh.a),Sh.a&&(aE["views.settings.tabs.user.PreferencesUserSettingsTab"]=Sh.a),Is.b&&(aE["views.spaces.SpaceBasicSettings"]=Is.b),Bs&&(aE["views.spaces.SpaceCreateMenu"]=Bs),en&&(aE["views.spaces.SpacePanel"]=en),wh.a&&(aE["views.spaces.SpacePublicShare"]=wh.a),Ch.a&&(aE["views.spaces.SpaceSettingsGeneralTab"]=Ch.a),kh.a&&(aE["views.spaces.SpaceSettingsVisibilityTab"]=kh.a),zs&&(aE["views.spaces.SpaceTreeLevel"]=zs),Oh.a&&(aE["views.toasts.GenericExpiringToast"]=Oh.a),Zt.a&&(aE["views.toasts.GenericToast"]=Zt.a),Rh.a&&(aE["views.toasts.NonUrgentEchoFailureToast"]=Rh.a),Ih&&(aE["views.toasts.VerificationRequestToast"]=Ih),dc&&(aE["views.voice_messages.Clock"]=dc),Au&&(aE["views.voice_messages.LiveRecordingClock"]=Au),Pu&&(aE["views.voice_messages.LiveRecordingWaveform"]=Pu),cc&&(aE["views.voice_messages.PlayPauseButton"]=cc),hc&&(aE["views.voice_messages.PlaybackClock"]=hc),ac&&(aE["views.voice_messages.PlaybackWaveform"]=ac),mc&&(aE["views.voice_messages.RecordingPlayback"]=mc),ic&&(aE["views.voice_messages.Waveform"]=ic),nn&&(aE["views.voip.AudioFeed"]=nn),on&&(aE["views.voip.AudioFeedArrayForCall"]=on),gs&&(aE["views.voip.CallContainer"]=gs),ms&&(aE["views.voip.CallPreview"]=ms),rs.a&&(aE["views.voip.CallView"]=rs.a),Nh.a&&(aE["views.voip.CallViewForRoom"]=Nh.a),Ph.a&&(aE["views.voip.DialPad"]=Ph.a),Dh.a&&(aE["views.voip.DialPadModal"]=Dh.a),os&&(aE["views.voip.IncomingCallBox"]=os),Ah.a&&(aE["views.voip.VideoFeed"]=Ah.a),se&&(aE["structures.CustomRoomTagPanel"]=se),Mh.a&&(aE["structures.EmbeddedPage"]=Mh.a),Uh.a&&(aE["structures.FilePanel"]=Uh.a),Lh&&(aE["structures.GenericErrorPage"]=Lh),z&&(aE["structures.GroupFilterPanel"]=z),em&&(aE["structures.GroupView"]=em),Ct&&(aE["structures.IndicatorScrollbar"]=Ct),aa.b&&(aE["structures.InteractiveAuth"]=aa.b),Wh.a&&(aE["structures.MainSplit"]=Wh.a),hm&&(aE["structures.MessagePanel"]=hm),_m&&(aE["structures.MyGroups"]=_m),Sm.a&&(aE["structures.RoomStatusBar"]=Sm.a),On.a&&(aE["structures.ScrollPanel"]=On.a),wm.a&&(aE["structures.SearchBox"]=wm.a),Cm.a&&(aE["structures.TimelinePanel"]=Cm.a),Rm&&(aE["structures.UserView"]=Rm),Nm&&(aE["structures.ViewSource"]=Nm),Lm&&(aE["structures.auth.CompleteSecurity"]=Lm),Gm&&(aE["structures.auth.E2eSetup"]=Gm),Ym&&(aE["structures.auth.ForgotPassword"]=Ym),Um.a&&(aE["structures.auth.SetupEncryptionBody"]=Um.a),Qm&&(aE["views.auth.AuthBody"]=Qm),Zm&&(aE["views.auth.AuthFooter"]=Zm),np&&(aE["views.auth.AuthHeader"]=np),op&&(aE["views.auth.AuthHeaderLogo"]=op),$n&&(aE["views.auth.AuthPage"]=$n),rp.a&&(aE["views.auth.CaptchaForm"]=rp.a),Bm&&(aE["views.auth.CompleteSecurityBody"]=Bm),si&&(aE["views.auth.CountryDropdown"]=si),lp&&(aE["views.auth.LanguageSelector"]=lp),dp&&(aE["views.auth.Welcome"]=dp),bp&&(aE["views.avatars.MemberStatusMessageAvatar"]=bp),Sp&&(aE["views.context_menus.GenericElementContextMenu"]=Sp),Op.a&&(aE["views.context_menus.GenericTextContextMenu"]=Op.a),Rp&&(aE["views.context_menus.GroupInviteTileContextMenu"]=Rp),jp.b&&(aE["views.context_menus.MessageContextMenu"]=jp.b),pp&&(aE["views.context_menus.StatusMessageContextMenu"]=pp),Dp&&(aE["views.context_menus.TagTileContextMenu"]=Dp),Fp&&(aE["views.dialogs.AddressPickerDialog"]=Fp),Ze.a&&(aE["views.dialogs.BaseDialog"]=Ze.a),Ge&&(aE["views.dialogs.FeedbackDialog"]=Ge),Wp&&(aE["views.dialogs.IncomingSasDialog"]=Wp),Ve.a&&(aE["views.dialogs.InfoDialog"]=Ve.a),Gp.a&&(aE["views.dialogs.IntegrationsDisabledDialog"]=Gp.a),qp.a&&(aE["views.dialogs.IntegrationsImpossibleDialog"]=qp.a),ra&&(aE["views.dialogs.InteractiveAuthDialog"]=ra),Hp&&(aE["views.dialogs.KeySignatureUploadFailedDialog"]=Hp),Jp&&(aE["views.dialogs.LazyLoadingDisabledDialog"]=Jp),Qp&&(aE["views.dialogs.LazyLoadingResyncDialog"]=Qp),He&&(aE["views.dialogs.LogoutDialog"]=He),Xp&&(aE["views.dialogs.ManualDeviceKeyVerificationDialog"]=Xp),sg&&(aE["views.dialogs.MessageEditHistoryDialog"]=sg),rg&&(aE["views.dialogs.NewSessionReviewDialog"]=rg),Me.a&&(aE["views.dialogs.QuestionDialog"]=Me.a),ug.a&&(aE["views.dialogs.RoomUpgradeDialog"]=ug.a),hg&&(aE["views.dialogs.RoomUpgradeWarningDialog"]=hg),vg&&(aE["views.dialogs.SessionRestoreErrorDialog"]=vg),Sg&&(aE["views.dialogs.SetEmailDialog"]=Sg),Og&&(aE["views.dialogs.SlashCommandHelpDialog"]=Og),Rg&&(aE["views.dialogs.StorageEvictedDialog"]=Rg),jg.a&&(aE["views.dialogs.TabbedIntegrationManagerDialog"]=jg.a),fn&&(aE["views.dialogs.TextInputDialog"]=fn),Ng&&(aE["views.dialogs.UploadFailureDialog"]=Ng),ag.a&&(aE["views.dialogs.VerificationRequestDialog"]=ag.a),Mg.a&&(aE["views.dialogs.WidgetOpenIDPermissionsDialog"]=Mg.a),qe.a&&(aE["views.dialogs.security.RestoreKeyBackupDialog"]=qe.a),Ug&&(aE["views.elements.ActionButton"]=Ug),Vg&&(aE["views.elements.AddressSelector"]=Vg),qg&&(aE["views.elements.AddressTile"]=qg),Yg.a&&(aE["views.elements.AppPermission"]=Yg.a),jt.a&&(aE["views.elements.AppTile"]=jt.a),Jg.a&&(aE["views.elements.AppWarning"]=Jg.a),Xg&&(aE["views.elements.DNDTagTile"]=Xg),Bi.a&&(aE["views.elements.DialogButtons"]=Bi.a),Cn&&(aE["views.elements.DirectorySearchBox"]=Cn),sv.a&&(aE["views.elements.Dropdown"]=sv.a),nv&&(aE["views.elements.EditableText"]=nv),ov&&(aE["views.elements.EditableTextContainer"]=ov),rv.a&&(aE["views.elements.ErrorBoundary"]=rv.a),Bc&&(aE["views.elements.Flair"]=Bc),cv.a&&(aE["views.elements.LanguageDropdown"]=cv.a),rr&&(aE["views.elements.LazyRenderList"]=rr),ys.a&&(aE["views.elements.PersistedElement"]=ys.a),ls&&(aE["views.elements.PersistentApp"]=ls),lv.a&&(aE["views.elements.Pill"]=lv.a),dv.a&&(aE["views.elements.PowerSelector"]=dv.a),uv.a&&(aE["views.elements.ReplyThread"]=uv.a),qt.a&&(aE["views.elements.ResizeHandle"]=qt.a),Rn.a&&(aE["views.elements.Spinner"]=Rn.a),hv&&(aE["views.elements.Spoiler"]=hv),jm.a&&(aE["views.elements.SyntaxHighlight"]=jm.a),Qg&&(aE["views.elements.TagTile"]=Qg),mi.a&&(aE["views.elements.TextWithTooltip"]=mi.a),Ev&&(aE["views.elements.TintableSvg"]=Ev),Sv.a&&(aE["views.elements.crypto.VerificationQRCode"]=Sv.a),wv&&(aE["views.groups.GroupInviteTile"]=wv),Rv.a&&(aE["views.groups.GroupMemberList"]=Rv.a),xv&&(aE["views.groups.GroupMemberTile"]=xv),Pv&&(aE["views.groups.GroupPublicityToggle"]=Pv),Uv.a&&(aE["views.groups.GroupRoomInfo"]=Uv.a),Lv.a&&(aE["views.groups.GroupRoomList"]=Lv.a),Kv&&(aE["views.groups.GroupRoomTile"]=Kv),Hv&&(aE["views.groups.GroupTile"]=Hv),$v.a&&(aE["views.groups.GroupUserSettings"]=$v.a),zv&&(aE["views.messages.DateSeparator"]=zv),gf&&(aE["views.messages.EditHistoryMessage"]=gf),yc&&(aE["views.messages.MAudioBody"]=yc),jr&&(aE["views.messages.MFileBody"]=jr),yf&&(aE["views.messages.MImageBody"]=yf),Sf&&(aE["views.messages.MKeyVerificationConclusion"]=Sf),Cf&&(aE["views.messages.MStickerBody"]=Cf),jf&&(aE["views.messages.MessageActionBar"]=jf),Af.a&&(aE["views.messages.MessageEvent"]=Af.a),Mf&&(aE["views.messages.MjolnirBody"]=Mf),Bf&&(aE["views.messages.RoomAvatarEvent"]=Bf),Gf&&(aE["views.messages.RoomCreate"]=Gf),zf.a&&(aE["views.messages.TextualBody"]=zf.a),Yf&&(aE["views.messages.TextualEvent"]=Yf),Qf&&(aE["views.messages.TileErrorBoundary"]=Qf),tb.a&&(aE["views.messages.UnknownBody"]=tb.a),sb&&(aE["views.messages.ViewSourceEvent"]=sb),rb&&(aE["views.room_settings.RelatedGroupSettings"]=rb),ub.a&&(aE["views.room_settings.RoomProfileSettings"]=ub.a),hb&&(aE["views.room_settings.UrlPreviewSettings"]=hb),mb.a&&(aE["views.rooms.AppsDrawer"]=mb.a),Ou.b&&(aE["views.rooms.E2EIcon"]=Ou.b),Pb&&(aE["views.rooms.EditMessageComposer"]=Pb),Ub&&(aE["views.rooms.JumpToBottomButton"]=Ub),Lb&&(aE["views.rooms.LinkPreviewWidget"]=Lb),iu&&(aE["views.rooms.MessageComposerFormatBar"]=iu),Gb&&(aE["views.rooms.ReadReceiptMarker"]=Gb),Iu&&(aE["views.rooms.ReplyPreview"]=Iu),ey&&(aE["views.rooms.RoomDetailList"]=ey),Jb&&(aE["views.rooms.RoomDetailRow"]=Jb),iy.a&&(aE["views.rooms.RoomHeader"]=iy.a),oy.a&&(aE["views.rooms.RoomPreviewBar"]=oy.a),ay.a&&(aE["views.rooms.RoomUpgradeWarningBar"]=ay.a),ry&&(aE["views.rooms.SearchResultTile"]=ry),vy&&(aE["views.rooms.SendMessageComposer"]=vy),_y&&(aE["views.rooms.SimpleRoomHeader"]=_y),Su&&(aE["views.rooms.Stickerpicker"]=Su),Cy&&(aE["views.rooms.TopUnreadMessagesBar"]=Cy),xy&&(aE["views.settings.AvatarSetting"]=xy),Ty&&(aE["views.settings.ChangeAvatar"]=Ty),Ny&&(aE["views.settings.ChangeDisplayName"]=Ny),My&&(aE["views.settings.ChangePassword"]=My),Ly&&(aE["views.settings.CrossSigningPanel"]=Ly),By&&(aE["views.settings.DevicesPanel"]=By),Ky&&(aE["views.settings.DevicesPanelEntry"]=Ky),Wy.a&&(aE["views.settings.IntegrationManager"]=Wy.a),a_&&(aE["views.settings.Notifications"]=a_),c_.a&&(aE["views.settings.ProfileSettings"]=c_.a),l_.a&&(aE["views.settings.SecureBackupPanel"]=l_.a),d_&&(aE["views.settings.SetIntegrationManager"]=d_),g_&&(aE["views.settings.account.EmailAddresses"]=g_),__&&(aE["views.settings.account.PhoneNumbers"]=__),k_&&(aE["views.settings.discovery.EmailAddresses"]=k_),T_&&(aE["views.settings.discovery.PhoneNumbers"]=T_),D_.a&&(aE["views.settings.tabs.room.GeneralRoomSettingsTab"]=D_.a),A_.a&&(aE["views.settings.tabs.room.NotificationSettingsTab"]=A_.a),M_.a&&(aE["views.settings.tabs.user.FlairUserSettingsTab"]=M_.a),U_.a&&(aE["views.settings.tabs.user.GeneralUserSettingsTab"]=U_.a),L_.a&&(aE["views.settings.tabs.user.LabsUserSettingsTab"]=L_.a),F_.a&&(aE["views.settings.tabs.user.NotificationUserSettingsTab"]=F_.a),B_.a&&(aE["views.settings.tabs.user.SecurityUserSettingsTab"]=B_.a),V_.a&&(aE["views.settings.tabs.user.VoiceUserSettingsTab"]=V_.a),K_&&(aE["views.terms.InlineTermsAgreement"]=K_),H_&&(aE["views.verification.VerificationCancelled"]=H_),J_&&(aE["views.verification.VerificationComplete"]=J_),tE&&(aE["views.verification.VerificationQREmojiOptions"]=tE),oE&&(aE["views.verification.VerificationShowSas"]=oE)},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n=s(18),i=s.n(n),o=s(156),a=s(96),r=s(92),c=s(94),l=s(146);function d(e){const t=c.a.get().getUserId();return"m.room.member"===e.getType()?e.getStateKey()===t:e.getSender()===t}function u(e,t){if(t!==l.a.DM)return!0;const s=c.a.get().getRoom(e);return!s||2!==s.currentState.getJoinedMemberCount()}function h(e){return e.sender?e.sender.name:e.getSender()}var m=s(234),p=s(134);var g=s(1);var v=s(98),f=s(127);var b=s(123);const y={"m.room.message":{isState:!1,previewer:new class{getTextFor(e,t){let s=e.getContent();if(e.isRelation("m.replace")&&(s=e.getContent()["m.new_content"]),!s||!s.body)return null;let n=(s.body||"").trim();const i=s.msgtype;if(!n||!i)return null;const o="org.matrix.custom.html"===s.format&&s.formatted_body;o&&(n=s.formatted_body);const a=e.getWireContent()["m.relates_to"];return a&&a["m.in_reply_to"]&&(n=o?(m.a.stripHTMLReply(n)||"").trim():(m.a.stripPlainReply(n)||"").trim(),!n)?null:(o&&(n=Object(p.d)(n)),"m.emote"===i?Object(r.a)("* %(senderName)s %(emote)s",{senderName:h(e),emote:n}):d(e)||!u(e.getRoomId(),t)?n:Object(r.a)("%(senderName)s: %(message)s",{senderName:h(e),message:"⁨"+n}))}}},"m.call.invite":{isState:!1,previewer:new class{getTextFor(e,t){return u(e.getRoomId(),t)?d(e)?Object(r.a)("You started a call"):Object(r.a)("%(senderName)s started a call",{senderName:h(e)}):d(e)?Object(r.a)("Waiting for answer"):Object(r.a)("%(senderName)s is calling",{senderName:h(e)})}}},"m.call.answer":{isState:!1,previewer:new class{getTextFor(e,t){return u(e.getRoomId(),t)?d(e)?Object(r.a)("You joined the call"):Object(r.a)("%(senderName)s joined the call",{senderName:h(e)}):Object(r.a)("Call in progress")}}},"m.call.hangup":{isState:!1,previewer:new class{getTextFor(e,t){return u(e.getRoomId(),t)?d(e)?Object(r.a)("You ended the call"):Object(r.a)("%(senderName)s ended the call",{senderName:h(e)}):Object(r.a)("Call ended")}}},"m.sticker":{isState:!1,previewer:new class{getTextFor(e,t){const s=e.getContent().body;return s?d(e)||!u(e.getRoomId(),t)?s:Object(r.a)("%(senderName)s: %(stickerName)s",{senderName:h(e),stickerName:s}):null}}},"m.reaction":{isState:!1,previewer:new class{getTextFor(e,t){const s=v.b.getValue("feature_roomlist_preview_reactions_dms");if(!(v.b.getValue("feature_roomlist_preview_reactions_all")||s&&f.a.shared().getUserIdForRoomId(e.getRoomId())))return null;const n=e.getRelation();if(!n)return null;const i=n.key;return i?d(e)||!u(e.getRoomId(),t)?i:Object(r.a)("%(senderName)s: %(reaction)s",{senderName:h(e),reaction:i}):null}}}},_="im.vector.any";class E extends o.a{constructor(){super(a.a,{}),i()(this,"previews",new Map)}static get instance(){return E.internalInstance}static getPreviewChangedEventName(e){return"room_preview_changed:"+(null==e?void 0:e.roomId)}async getPreviewForRoom(e,t){if(!e)return null;this.previews.has(e.roomId)||await this.generatePreview(e,t);const s=this.previews.get(e.roomId);return s?s.has(t)?s.get(t):s.get(_):null}async generatePreview(e,t){const s=e.timeline;if(!s)return;let n=this.previews.get(e.roomId);n||(n=new Map,this.previews.set(e.roomId,n)),n.has(_)||n.set(_,null),t&&!n.has(t)&&n.set(t,null);let i=!1;for(let t=s.length-1;t>=0&&t!==s.length-50;t--){const o=s[t];await this.matrixClient.decryptEventIfNeeded(o);const a=y[o.getType()];if(!a)continue;if(a.isState&&Object(g.t)(o.getStateKey()))continue;const r=a.previewer.getTextFor(o,null);if(!r)continue;i=i||r!==n.get(_),n.set(_,r);const c=Array.from(n.keys()).filter(e=>e!==_);for(const e of c){const t=e===_?null:e,s=a.previewer.getTextFor(o,t);s===r?(i=i||r!==n.get(e),n.delete(e)):(i=i||s!==n.get(e),n.set(e,s))}return void(i&&(this.previews.set(e.roomId,n),this.emit(b.b,this),this.emit(E.getPreviewChangedEventName(e),e)))}this.previews.set(e.roomId,new Map),this.emit(b.b,this),this.emit(E.getPreviewChangedEventName(e),e)}async onAction(e){if(this.matrixClient&&("MatrixActions.Room.timeline"===e.action||"MatrixActions.Event.decrypted"===e.action)){const t=e.event,s=e.hasOwnProperty("isLiveEvent")&&!e.isLiveEvent;if(!this.previews.has(t.getRoomId())||s)return;await this.generatePreview(this.matrixClient.getRoom(t.getRoomId()),_)}}}i()(E,"internalInstance",new E)},function(e,t,s){"use strict";s.d(t,"b",(function(){return x})),s.d(t,"a",(function(){return j}));var n=s(18),i=s.n(n),o=s(1),a=s(127),r=s(8),c=s(121),l=s(146),d=s(264),u=s(188),h=s(233);var m=s(360),p=s(142);const g={[h.b.Recent]:new m.a,[h.b.Alphabetic]:new class{async sortRooms(e,t){return e.sort((e,t)=>Object(p.a)(e.name,t.name))}},[h.b.Manual]:new class{async sortRooms(e,t){const s=e=>e.tags[t].order||0;return e.sort((e,t)=>s(e)-s(t))}}};function v(e,t,s){return function(e){if(!g[e])throw new Error(e+" is not a known algorithm");return g[e]}(s).sortRooms(e,t)}var f=s(488),b=s.n(f);class y{constructor(e,t){this.tagId=e,i()(this,"cachedOrderedRooms",void 0),i()(this,"sortingAlgorithm",void 0),i()(this,"updateLock",new b.a),this.setSortAlgorithm(t)}get orderedRooms(){return this.cachedOrderedRooms||[]}async setSortAlgorithm(e){if(!e)throw new Error("A sorting algorithm must be defined");this.sortingAlgorithm=e,await this.setRooms(this.orderedRooms)}getRoomIndex(e){let t=this.cachedOrderedRooms.indexOf(e);return-1===t&&(console.warn(`Degrading performance to find missing room in "${this.tagId}": ${e.roomId}`),t=this.cachedOrderedRooms.findIndex(t=>t.roomId===e.roomId)),t}}var _=s(203),E=s(174);const S=[_.a.Red,_.a.Grey,_.a.Bold,_.a.None];class w extends y{constructor(e,t){super(e,t),i()(this,"indices",{})}categorizeRooms(e){const t={[_.a.Red]:[],[_.a.Grey]:[],[_.a.Bold]:[],[_.a.None]:[]};for(const s of e){t[this.getRoomCategory(s)].push(s)}return t}getRoomCategory(e){return E.a.instance.getRoomState(e).color}async setRooms(e){if(this.sortingAlgorithm===h.b.Manual)this.cachedOrderedRooms=await v(e,this.tagId,this.sortingAlgorithm);else{const t=this.categorizeRooms(e);for(const e of Object.keys(t)){const s=t[e];t[e]=await v(s,this.tagId,this.sortingAlgorithm)}const s=[],n={};for(const e of S)n[e]=s.length,s.push(...t[e]);this.indices=n,this.cachedOrderedRooms=s}}async handleSplice(e,t){if(t===l.c.NewRoom){const t=this.getRoomCategory(e);this.alterCategoryPositionBy(t,1,this.indices),this.cachedOrderedRooms.splice(this.indices[t],0,e),await this.sortCategory(t)}else{if(t!==l.c.RoomRemoved)throw new Error("Unhandled splice: "+t);{const t=this.getRoomIndex(e);if(-1===t)return console.warn(`Tried to remove unknown room from ${this.tagId}: ${e.roomId}`),!1;const s=this.getCategoryFromIndices(t,this.indices);this.alterCategoryPositionBy(s,-1,this.indices),this.cachedOrderedRooms.splice(t,1)}}return!0}async handleRoomUpdate(e,t){try{if(await this.updateLock.acquireAsync(),t===l.c.NewRoom||t===l.c.RoomRemoved)return this.handleSplice(e,t);if(t!==l.c.Timeline&&t!==l.c.ReadReceipt)throw new Error("Unsupported update cause: "+t);const s=this.getRoomCategory(e);if(this.sortingAlgorithm===h.b.Manual)return;const n=this.getRoomIndex(e);if(-1===n)throw new Error(`Room ${e.roomId} has no index in ${this.tagId}`);const i=this.getCategoryFromIndices(n,this.indices);return i!==s&&(this.moveRoomIndexes(1,i,s,this.indices),this.cachedOrderedRooms.splice(n,1),this.cachedOrderedRooms.splice(this.indices[s],0,e)),await this.sortCategory(s),!0}finally{await this.updateLock.release()}}async sortCategory(e){const t=e===S[S.length-1]?Number.MAX_SAFE_INTEGER:this.indices[S[S.indexOf(e)+1]],s=this.indices[e],n=t-s,i=this.cachedOrderedRooms.splice(s,n),o=await v(i,this.tagId,this.sortingAlgorithm);this.cachedOrderedRooms.splice(s,0,...o)}getCategoryFromIndices(e,t){for(let s=0;s<S.length;s++){const n=S[s],i=s===S.length-1,o=t[n],a=i?Number.MAX_SAFE_INTEGER:t[S[s+1]];if(e>=o&&e<a)return n}throw new Error("Programming error: somehow you've ended up with an index that isn't in a category")}moveRoomIndexes(e,t,s,n){this.alterCategoryPositionBy(t,-e,n),this.alterCategoryPositionBy(s,+e,n)}alterCategoryPositionBy(e,t,s){const n=S.indexOf(e)+1;if(t>0)for(let e=n;e<S.length;e++){s[S[e]]+=Math.abs(t)}else if(t<0)for(let e=n;e<S.length;e++){s[S[e]]-=Math.abs(t)}for(let e=1;e<=S.length;e++){const t=S[e-1],n=S[e];s[t]>s[n]&&console.warn(`!! Room list index corruption: ${t} (i:${s[t]}) is greater than ${n} (i:${s[n]}) - category indices are likely desynced from reality`)}}}class C extends y{constructor(e,t){super(e,t)}async setRooms(e){this.cachedOrderedRooms=await v(e,this.tagId,this.sortingAlgorithm)}async handleRoomUpdate(e,t){try{await this.updateLock.acquireAsync();const s=t===l.c.NewRoom||t===l.c.RoomRemoved,n=t===l.c.Timeline||t===l.c.ReadReceipt;if(!s&&!n)throw new Error("Unsupported update cause: "+t);if(t===l.c.NewRoom)this.cachedOrderedRooms.push(e);else if(t===l.c.RoomRemoved){const t=this.getRoomIndex(e);t>=0?this.cachedOrderedRooms.splice(t,1):console.warn(`Tried to remove unknown room from ${this.tagId}: ${e.roomId}`)}return this.cachedOrderedRooms=await v(this.cachedOrderedRooms,this.tagId,this.sortingAlgorithm),!0}finally{await this.updateLock.release()}}}const k={[h.a.Natural]:(e,t)=>new C(e,t),[h.a.Importance]:(e,t)=>new w(e,t)};function O(e,t,s){if(!k[e])throw new Error(e+" is not a known algorithm");return k[e](t,s)}var R=s(98),I=s(475);const x="list_updated_event",T=[l.c.Timeline,l.c.ReadReceipt];class j extends r.EventEmitter{constructor(){super(),i()(this,"_cachedRooms",{}),i()(this,"_cachedStickyRooms",{}),i()(this,"filteredRooms",{}),i()(this,"_stickyRoom",null),i()(this,"_lastStickyRoom",null),i()(this,"sortAlgorithms",void 0),i()(this,"listAlgorithms",void 0),i()(this,"algorithms",void 0),i()(this,"rooms",[]),i()(this,"roomIdsToTags",{}),i()(this,"allowedByFilter",new Map),i()(this,"allowedRoomsByFilters",new Set),i()(this,"updatesInhibited",!1),i()(this,"unifiedRoomList",void 0)}get stickyRoom(){return this._stickyRoom?this._stickyRoom.room:null}get knownRooms(){return this.rooms}get hasTagSortingMap(){return!!this.sortAlgorithms}get hasFilters(){return this.allowedByFilter.size>0}set cachedRooms(e){this._cachedRooms=e,this.recalculateFilteredRooms(),this.recalculateStickyRoom()}get cachedRooms(){return this._cachedRooms}async setStickyRoom(e){await this.updateStickyRoom(e)}getTagSorting(e){return this.sortAlgorithms?this.sortAlgorithms[e]:null}async setTagSorting(e,t){if(!e)throw new Error("Tag ID must be defined");if(!t)throw new Error("Algorithm must be defined");this.sortAlgorithms[e]=t;const s=this.algorithms[e];await s.setSortAlgorithm(t),this._cachedRooms[e]=s.orderedRooms,this.recalculateFilteredRoomsForTag(e),this.recalculateStickyRoom(e)}getListOrdering(e){return this.listAlgorithms?this.listAlgorithms[e]:null}async setListOrdering(e,t){if(!e)throw new Error("Tag ID must be defined");if(!t)throw new Error("Algorithm must be defined");this.listAlgorithms[e]=t;const s=O(t,e,this.sortAlgorithms[e]);this.algorithms[e]=s,await s.setRooms(this._cachedRooms[e]),this._cachedRooms[e]=s.orderedRooms,this.recalculateFilteredRoomsForTag(e),this.recalculateStickyRoom(e)}setUnifiedRoomList(e){this.unifiedRoomList=e}addFilterCondition(e){this.allowedByFilter.set(e,this.rooms.filter(t=>e.isVisible(t))),this.recalculateFilteredRooms(),e.on(d.a,this.handleFilterChange.bind(this))}removeFilterCondition(e){e.off(d.a,this.handleFilterChange.bind(this)),this.allowedByFilter.has(e)&&(this.allowedByFilter.delete(e),this.recalculateFilteredRooms(),this.hasFilters||this.updatesInhibited||this.emit(x))}async handleFilterChange(){await this.recalculateFilteredRooms(),this.updatesInhibited||this.emit(d.a)}async updateStickyRoom(e){try{return await this.doUpdateStickyRoom(e)}finally{this._lastStickyRoom=null}}async doUpdateStickyRoom(e){var t,s;if(R.b.getValue("feature_spaces")&&null!==(t=e)&&void 0!==t&&t.isSpaceRoom()&&"invite"!==e.getMyMembership()&&(e=null),e&&!I.a.instance.isRoomVisible(e)&&(e=null),this._lastStickyRoom=this._stickyRoom||{},!e){if(this._stickyRoom){const e=this._stickyRoom.room;return this._stickyRoom=null,void await this.handleRoomUpdate(e,l.c.NewRoom)}return}let n=null===(s=this.roomIdsToTags[e.roomId])||void 0===s?void 0:s[0];if(!n)throw new Error(e.roomId+" does not belong to a tag and cannot be sticky");let i=(this.getOrderedRoomsWithoutSticky()[n]||[]).indexOf(e);const o=!!this._lastStickyRoom.room&&this._lastStickyRoom.room.roomId===e.roomId;if(this._lastStickyRoom.tag&&n!==this._lastStickyRoom.tag&&o&&i<0&&(console.warn(`Sticky room ${e.roomId} changed tags during sticky room handling`),i=0),i<0)throw new Error(e.roomId+" does not appear to be known and cannot be sticky");const a=this._stickyRoom;if(this._stickyRoom=null,this.recalculateStickyRoom(),a&&a.room&&a.room.roomId!==e.roomId&&await this.handleRoomUpdate(a.room,l.c.NewRoom),await this.handleRoomUpdate(e,l.c.RoomRemoved),this._stickyRoom){if(this._stickyRoom.room!==e){if(this._stickyRoom.room.roomId!==e.roomId)throw new Error("Sticky room changed while the sticky room was changing");console.warn("Sticky room changed references")}console.warn(`Sticky room changed tag & position from ${n} / ${i} to ${this._stickyRoom.tag} / ${this._stickyRoom.position}`),n=this._stickyRoom.tag,i=this._stickyRoom.position}a&&a.tag===n&&a.position<=i&&i++,this._stickyRoom={room:e,position:i,tag:n},this.recalculateFilteredRoomsForTag(n),a&&a.tag!==n&&this.recalculateFilteredRoomsForTag(a.tag),this.recalculateStickyRoom(),this.updatesInhibited||this.emit(x)}recalculateFilteredRooms(){if(!this.hasFilters)return;console.warn("Recalculating filtered room list");const e=Array.from(this.allowedByFilter.keys()),t={};for(const s of Object.keys(this.cachedRooms)){const n=this.cachedRooms[s].map(e=>e);this.tryInsertStickyRoomToFilterSet(n,s);const i=n.map(e=>e),o=[];for(const t of e){const e=i.filter(e=>t.isVisible(e));for(const t of e){const e=i.indexOf(t);e>=0&&i.splice(e,1),o.push(t)}}t[s]=o,R.b.getValue("advancedRoomListLogging")&&console.log(`[DEBUG] ${t[s].length}/${n.length} rooms filtered into ${s}`)}const s=Object.values(t).reduce((e,t)=>(e.push(...t),e),[]);this.allowedRoomsByFilters=new Set(s),this.filteredRooms=t,this.updatesInhibited||this.emit(x)}recalculateFilteredRoomsForTag(e){if(!this.hasFilters)return;R.b.getValue("advancedRoomListLogging")&&console.log("Recalculating filtered rooms for "+e),delete this.filteredRooms[e];const t=this.cachedRooms[e].map(e=>e);this.tryInsertStickyRoomToFilterSet(t,e);const s=t.filter(e=>this.allowedRoomsByFilters.has(e));s.length>0&&(this.filteredRooms[e]=s),R.b.getValue("advancedRoomListLogging")&&console.log(`[DEBUG] ${s.length}/${t.length} rooms filtered into ${e}`)}tryInsertStickyRoomToFilterSet(e,t){if(!this._stickyRoom||!this._stickyRoom.room||this._stickyRoom.tag!==t)return;const s=this._stickyRoom.position;s>=e.length?e.push(this._stickyRoom.room):e.splice(s,0,this._stickyRoom.room)}recalculateStickyRoom(e=null){if(!this._stickyRoom){if(this._cachedStickyRooms){if(this._cachedStickyRooms=null,this.updatesInhibited)return;this.emit(x)}return}if(!this._cachedStickyRooms||!e){R.b.getValue("advancedRoomListLogging")&&console.log("Generating clone of cached rooms for sticky room handling");const e={};for(const t of Object.keys(this.cachedRooms))e[t]=this.cachedRooms[t].map(e=>e);this._cachedStickyRooms=e}e&&(R.b.getValue("advancedRoomListLogging")&&console.log("Replacing cached sticky rooms for "+e),this._cachedStickyRooms[e]=this.cachedRooms[e].map(e=>e));const t=this._stickyRoom;e&&e!==t.tag||(R.b.getValue("advancedRoomListLogging")&&console.log(`Inserting sticky room ${t.room.roomId} at position ${t.position} in ${t.tag}`),this._cachedStickyRooms[t.tag].splice(t.position,0,t.room)),this.updatesInhibited||this.emit(x)}async populateTags(e,t){if(!e)throw new Error("Sorting map cannot be null or empty");if(!t)throw new Error("Ordering ma cannot be null or empty");if(Object(c.d)(Object.keys(e),Object.keys(t)))throw new Error("Both maps must contain the exact same tags");this.sortAlgorithms=e,this.listAlgorithms=t,this.algorithms={};for(const t of Object.keys(e))this.algorithms[t]=O(this.listAlgorithms[t],t,this.sortAlgorithms[t]);return this.setKnownRooms(this.rooms)}getOrderedRooms(){return this.hasFilters?this.filteredRooms:this._cachedStickyRooms||this.cachedRooms}getUnfilteredRooms(){return this._cachedStickyRooms||this.cachedRooms}getOrderedRoomsWithoutSticky(){return this.hasFilters?this.filteredRooms:this.cachedRooms}async setKnownRooms(e){if(Object(o.t)(e))throw new Error("Array of rooms cannot be null");if(!this.sortAlgorithms)throw new Error("Cannot set known rooms without a tag sorting map");this.updatesInhibited||console.warn("Resetting known rooms, initiating regeneration");const t=this._stickyRoom;await this.updateStickyRoom(null),this.rooms=e;const s={};for(const e in this.sortAlgorithms)s[e]=[];if(!e.length)return await this.generateFreshTags(s),void(this.cachedRooms=s);const n=Object(u.e)(e);for(const e of n[u.a.Invite])s[l.a.Invite].push(e);for(const e of n[u.a.Leave])s[l.a.Archived].push(e);for(const e of n[u.a.Join]){const t=this.getTagsOfJoinedRoom(e);let n=!1;if(t.length>0)for(const i of t)Object(o.t)(s[i])||(s[i].push(e),n=!0);n||(a.a.shared().getUserIdForRoomId(e.roomId)?this.unifiedRoomList?s[l.a.Unified].push(e):s[l.a.DM].push(e):this.unifiedRoomList?s[l.a.Unified].push(e):s[l.a.Untagged].push(e))}await this.generateFreshTags(s),this.cachedRooms=s,this.updateTagsFromCache(),t&&t.room&&(await this.updateStickyRoom(t.room),this._stickyRoom&&this._stickyRoom.room&&this._stickyRoom.tag!==t.tag&&(this._stickyRoom.position=0,this.recalculateStickyRoom(this._stickyRoom.tag)))}getTagsForRoom(e){const t=[],s=Object(u.b)(e.getMyMembership());return s===u.a.Invite?t.push(l.a.Invite):s===u.a.Leave?t.push(l.a.Archived):t.push(...this.getTagsOfJoinedRoom(e)),t.length||(this.unifiedRoomList?t.push(l.a.Unified):t.push(l.a.Untagged)),t}getTagsOfJoinedRoom(e){let t=Object.keys(e.tags||{});return 0===t.length&&a.a.shared().getUserIdForRoomId(e.roomId)&&(t=this.unifiedRoomList?[l.a.Unified]:[l.a.DM]),t}updateTagsFromCache(){const e={},t=Object.keys(this.cachedRooms);for(const s of t){const t=this.cachedRooms[s];for(const n of t)e[n.roomId]||(e[n.roomId]=[]),e[n.roomId].push(s)}this.roomIdsToTags=e}async generateFreshTags(e){if(!this.algorithms)throw new Error("Not ready: no algorithms to determine tags from");for(const t of Object.keys(e)){const s=this.algorithms[t];if(!s)throw new Error("No algorithm for "+t);await s.setRooms(e[t]),e[t]=s.orderedRooms}}async handleRoomUpdate(e,t){if(R.b.getValue("advancedRoomListLogging")&&console.log(`Handle room update for ${e.roomId} called with cause ${t}`),!this.algorithms)throw new Error("Not ready: no algorithms to determine tags from");const s=this._stickyRoom&&this._stickyRoom.room&&this._stickyRoom.room.roomId===e.roomId;if(t===l.c.NewRoom){const n=this._lastStickyRoom&&this._lastStickyRoom.room===e,i=this.roomIdsToTags[e.roomId],o=i&&i.length>0;o&&!n&&(console.warn(e.roomId+" is reportedly new but is already known - assuming TagChange instead"),t=l.c.PossibleTagChange);let a=this.rooms.includes(e);if(o&&!a&&(console.warn(e.roomId+" might be a reference change - attempting to update reference"),this.rooms=this.rooms.map(t=>t.roomId===e.roomId?e:t),a=this.rooms.includes(e),a||console.warn(e.roomId+" is still not referenced. It may be sticky.")),o&&!a&&!s)throw new Error(e.roomId+" is missing from room array but is known - trying to find duplicate");o&&s&&(this._stickyRoom.room=e),t!==l.c.NewRoom||s||a||this.rooms.push(e)}let n=!1;if(t===l.c.PossibleTagChange){const i=this.roomIdsToTags[e.roomId]||[],o=this.getTagsForRoom(e),a=Object(c.a)(i,o);if(a.removed.length>0||a.added.length>0){for(const t of a.removed){R.b.getValue("advancedRoomListLogging")&&console.log(`Removing ${e.roomId} from ${t}`);const s=this.algorithms[t];if(!s)throw new Error("No algorithm for "+t);await s.handleRoomUpdate(e,l.c.RoomRemoved),this._cachedRooms[t]=s.orderedRooms,this.recalculateFilteredRoomsForTag(t),this.recalculateStickyRoom(t)}for(const t of a.added){R.b.getValue("advancedRoomListLogging")&&console.log(`Adding ${e.roomId} to ${t}`);const s=this.algorithms[t];if(!s)throw new Error("No algorithm for "+t);await s.handleRoomUpdate(e,l.c.NewRoom),this._cachedRooms[t]=s.orderedRooms}this.roomIdsToTags[e.roomId]=o,R.b.getValue("advancedRoomListLogging")&&console.log(`Changing update cause for ${e.roomId} to Timeline to sort rooms`),t=l.c.Timeline,n=!0}else R.b.getValue("advancedRoomListLogging")&&console.log(`Received no-op update for ${e.roomId} - changing to Timeline update`),t=l.c.Timeline;n&&s&&(this._lastStickyRoom?this._stickyRoom={room:e,tag:this.roomIdsToTags[e.roomId][0],position:0}:await this.setStickyRoom(e))}if(t!==l.c.NewRoom&&t!==l.c.RoomRemoved&&this.stickyRoom===e)return R.b.getValue("advancedRoomListLogging")&&console.warn(`[RoomListDebug] Received ${t} update for sticky room ${e.roomId} - ignoring`),!1;if(!this.roomIdsToTags[e.roomId]){if(T.includes(t))return R.b.getValue("advancedRoomListLogging")&&console.warn(`Skipping tag update for ${e.roomId} because we don't know about the room`),!1;R.b.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Updating tags for room ${e.roomId} (${e.name})`);const s=this.getTagsForRoom(e).filter(e=>!Object(o.t)(this.cachedRooms[e]));if(!s.length)throw new Error("Tags cannot be determined for "+e.roomId);this.roomIdsToTags[e.roomId]=s,R.b.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Updated tags for ${e.roomId}:`,s)}R.b.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Reached algorithmic handling for ${e.roomId} and cause ${t}`);const i=this.roomIdsToTags[e.roomId];if(!i)return console.warn(`No tags known for "${e.name}" (${e.roomId})`),!1;let a=n;for(const s of i){const n=this.algorithms[s];if(!n)throw new Error("No algorithm for "+s);await n.handleRoomUpdate(e,t),this._cachedRooms[s]=n.orderedRooms,this.recalculateFilteredRoomsForTag(s),this.recalculateStickyRoom(s),a=!0}return R.b.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Finished handling ${e.roomId} with cause ${t} (changed=${a})`),a}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return T}));var n=s(18),i=s.n(n),o=s(94),a=s(96),r=s(92),c=s(165),l=s(144);var d=s(99),u=s(95),h=s(631),m=s(181),p=s(221);const g=e=>{switch(e){case y.SET_UP_ENCRYPTION:return Object(r.a)("Set up Secure Backup");case y.UPGRADE_ENCRYPTION:return Object(r.a)("Encryption upgrade available");case y.VERIFY_THIS_SESSION:return Object(r.a)("Verify this session")}},v=e=>{switch(e){case y.SET_UP_ENCRYPTION:case y.UPGRADE_ENCRYPTION:return"secure_backup";case y.VERIFY_THIS_SESSION:return"verification_warning"}},f=e=>{switch(e){case y.SET_UP_ENCRYPTION:return Object(r.a)("Continue");case y.UPGRADE_ENCRYPTION:return Object(r.a)("Upgrade");case y.VERIFY_THIS_SESSION:return Object(r.a)("Verify")}},b=e=>{switch(e){case y.SET_UP_ENCRYPTION:case y.UPGRADE_ENCRYPTION:return Object(r.a)("Safeguard against losing access to encrypted messages & data");case y.VERIFY_THIS_SESSION:return Object(r.a)("Other users may not trust it")}};let y;!function(e){e.SET_UP_ENCRYPTION="set_up_encryption",e.UPGRADE_ENCRYPTION="upgrade_encryption",e.VERIFY_THIS_SESSION="verify_this_session"}(y||(y={}));const _=()=>{T.sharedInstance().dismissEncryptionSetup()},E=e=>{var t;if(null!==(t=p.a.setupEncryptionNeeded)&&void 0!==t&&t.call(p.a,e))return;l.a.sharedInstance().addOrReplaceToast({key:"setupencryption",title:g(e),icon:v(e),props:{description:b(e),acceptLabel:f(e),onAccept:async()=>{if(e===y.VERIFY_THIS_SESSION)d.a.createTrackedDialog("Verify session","Verify session",h.a,{},null,!1,!0);else{const e=u.getComponent("elements.Spinner"),t=d.a.createDialog(e,null,"mx_Dialog_spinner",!1,!0);try{await Object(m.b)()}finally{t.close()}}},rejectLabel:Object(r.a)("Later"),onReject:_},component:c.a,priority:e===y.VERIFY_THIS_SESSION?95:40})},S=()=>{l.a.sharedInstance().dismissToast("setupencryption")};var w=s(103),C=s(208);function k(e){return"unverified_session_"+e}const O=async e=>{const t=o.a.get(),s=await t.getDevice(e);l.a.sharedInstance().addOrReplaceToast({key:k(e),title:Object(r.a)("New login. Was this you?"),icon:"verification_warning",props:{description:s.display_name,detail:Object(r.a)("%(deviceId)s from %(ip)s",{deviceId:e,ip:s.last_seen_ip}),acceptLabel:Object(r.a)("Check your devices"),onAccept:()=>{T.sharedInstance().dismissUnverifiedSessions([e]),a.a.dispatch({action:w.a.ViewUserSettings,initialTabId:C.a.Security})},rejectLabel:Object(r.a)("Later"),onReject:()=>{T.sharedInstance().dismissUnverifiedSessions([e])}},component:c.a,priority:80})},R=e=>{l.a.sharedInstance().dismissToast(k(e))};var I=s(243),x=s(742);class T{constructor(){i()(this,"dispatcherRef",void 0),i()(this,"dismissed",new Set),i()(this,"dismissedThisDeviceToast",!1),i()(this,"keyBackupInfo",null),i()(this,"keyBackupFetchedAt",null),i()(this,"ourDeviceIdsAtStart",null),i()(this,"displayingToastsForDeviceIds",new Set),i()(this,"_onWillUpdateDevices",async(e,t)=>{if(t)return;const s=o.a.get().getUserId();e.includes(s)&&this._ensureDeviceIdsAtStartPopulated()}),i()(this,"_onDevicesUpdated",e=>{e.includes(o.a.get().getUserId())&&this._recheck()}),i()(this,"_onDeviceVerificationChanged",e=>{e===o.a.get().getUserId()&&this._recheck()}),i()(this,"_onUserTrustStatusChanged",e=>{e===o.a.get().getUserId()&&this._recheck()}),i()(this,"_onCrossSingingKeysChanged",()=>{this._recheck()}),i()(this,"_onAccountData",e=>{(e.getType().startsWith("m.secret_storage.")||e.getType().startsWith("m.cross_signing."))&&this._recheck()}),i()(this,"_onSync",(e,t)=>{"PREPARED"===e&&null===t&&this._recheck()}),i()(this,"_onRoomStateEvents",e=>{"m.room.encryption"===e.getType()&&this._recheck()}),i()(this,"_onAction",({action:e})=>{"on_logged_in"===e&&this._recheck()})}static sharedInstance(){return window.mxDeviceListener||(window.mxDeviceListener=new T),window.mxDeviceListener}start(){o.a.get().on("crypto.willUpdateDevices",this._onWillUpdateDevices),o.a.get().on("crypto.devicesUpdated",this._onDevicesUpdated),o.a.get().on("deviceVerificationChanged",this._onDeviceVerificationChanged),o.a.get().on("userTrustStatusChanged",this._onUserTrustStatusChanged),o.a.get().on("crossSigning.keysChanged",this._onCrossSingingKeysChanged),o.a.get().on("accountData",this._onAccountData),o.a.get().on("sync",this._onSync),o.a.get().on("RoomState.events",this._onRoomStateEvents),this.dispatcherRef=a.a.register(this._onAction),this._recheck()}stop(){o.a.get()&&(o.a.get().removeListener("crypto.willUpdateDevices",this._onWillUpdateDevices),o.a.get().removeListener("crypto.devicesUpdated",this._onDevicesUpdated),o.a.get().removeListener("deviceVerificationChanged",this._onDeviceVerificationChanged),o.a.get().removeListener("userTrustStatusChanged",this._onUserTrustStatusChanged),o.a.get().removeListener("crossSigning.keysChanged",this._onCrossSingingKeysChanged),o.a.get().removeListener("accountData",this._onAccountData),o.a.get().removeListener("sync",this._onSync),o.a.get().removeListener("RoomState.events",this._onRoomStateEvents)),this.dispatcherRef&&(a.a.unregister(this.dispatcherRef),this.dispatcherRef=null),this.dismissed.clear(),this.dismissedThisDeviceToast=!1,this.keyBackupInfo=null,this.keyBackupFetchedAt=null,this.ourDeviceIdsAtStart=null,this.displayingToastsForDeviceIds=new Set}async dismissUnverifiedSessions(e){for(const t of e)this.dismissed.add(t);this._recheck()}dismissEncryptionSetup(){this.dismissedThisDeviceToast=!0,this._recheck()}_ensureDeviceIdsAtStartPopulated(){if(null===this.ourDeviceIdsAtStart){const e=o.a.get();this.ourDeviceIdsAtStart=new Set(e.getStoredDevicesForUser(e.getUserId()).map(e=>e.deviceId))}}async _getKeyBackupInfo(){const e=(new Date).getTime();return(!this.keyBackupInfo||this.keyBackupFetchedAt<e-3e5)&&(this.keyBackupInfo=await o.a.get().getKeyBackupVersion(),this.keyBackupFetchedAt=e),this.keyBackupInfo}shouldShowSetupEncryptionToast(){if(Object(m.d)())return!1;const e=o.a.get();return e&&e.getRooms().some(t=>e.isRoomEncrypted(t.roomId))}async _recheck(){const e=o.a.get();if(!await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"))return;if(!e.isCryptoEnabled())return;if(!e.isInitialSyncComplete())return;const t=await e.isCrossSigningReady(),s=await e.isSecretStorageReady(),n=t&&s;if(this.dismissedThisDeviceToast||n)S();else if(this.shouldShowSetupEncryptionToast())if(await e.downloadKeys([e.getUserId()]),!e.getCrossSigningId()&&e.getStoredCrossSigningForUser(e.getUserId()))E(y.VERIFY_THIS_SESSION);else{await this._getKeyBackupInfo()?E(y.UPGRADE_ENCRYPTION):(await e.waitForClientWellKnown(),Object(I.d)()&&Object(x.b)()?(S(),Object(m.b)()):E(y.SET_UP_ENCRYPTION))}this._ensureDeviceIdsAtStartPopulated();const i=new Set,d=new Set;if(t){const t=e.getStoredDevicesForUser(e.getUserId());for(const s of t){if(s.deviceId===e.deviceId)continue;(await e.checkDeviceTrust(e.getUserId(),s.deviceId)).isCrossSigningVerified()||this.dismissed.has(s.deviceId)||(this.ourDeviceIdsAtStart.has(s.deviceId)?i.add(s.deviceId):d.add(s.deviceId))}}var u;i.size>0?(u=i,l.a.sharedInstance().addOrReplaceToast({key:"reviewsessions",title:Object(r.a)("You have unverified logins"),icon:"verification_warning",props:{description:Object(r.a)("Review to ensure your account is safe"),acceptLabel:Object(r.a)("Review"),onAccept:()=>{T.sharedInstance().dismissUnverifiedSessions(u),a.a.dispatch({action:"view_user_info",userId:o.a.get().getUserId()})},rejectLabel:Object(r.a)("Later"),onReject:()=>{T.sharedInstance().dismissUnverifiedSessions(u)}},component:c.a,priority:50})):l.a.sharedInstance().dismissToast("reviewsessions");for(const e of d)O(e);for(const e of this.displayingToastsForDeviceIds)d.has(e)||R(e);this.displayingToastsForDeviceIds=d}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n,i=s(115),o=s.n(i);!function(e){e.Backward="b",e.Forward="f"}(n||(n={}));class a{constructor(e){o()(this,"timeline",void 0),o()(this,"ourEventIndex",0),o()(this,"paginateTokens",{[n.Backward]:null,[n.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(e=!1){return this.paginateTokens[e?n.Backward:n.Forward]}setPaginateToken(e,t=!1){this.paginateTokens[t?n.Backward:n.Forward]=e}addEvents(e,t=!1){t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}function r(e,t){this.rank=e,this.context=t}r.fromJson=function(e,t){const s=e.context||{},n=s.events_before||[],i=s.events_after||[],o=new a(t(e.result));return o.setPaginateToken(s.start,!0),o.addEvents(n.map(t),!0),o.addEvents(i.map(t),!1),o.setPaginateToken(s.end,!1),new r(e.rank,o)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v})),s.d(t,"b",(function(){return b}));var n=s(115),i=s.n(n),o=s(110),a=s(0),r=s(1);function c(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function l(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?c(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):c(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class d{constructor(e,t){this.client=e,this.indexEvent=t}get id(){return this.indexEvent.getStateKey()}get isActive(){return!0===this.indexEvent.getContent().active}get roomId(){return this.indexEvent.getRoomId()}async delete(){await this.client.sendStateEvent(this.roomId,o.h.name,{},this.id),await this.client.redactEvent(this.roomId,this.id)}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(e){return this.client.sendStateEvent(this.roomId,o.h.name,l(l({},this.indexEvent.getContent()),{},{name:e}),this.id)}async getFileInfo(){const e=this.client.getRoom(this.roomId);if(!e)throw new Error("Unknown room");const t=await this.client.getEventTimeline(e.getUnfilteredTimelineSet(),this.id);if(!t)throw new Error("Failed to get timeline for room event");const s=t.getEvents().find(e=>e.getId()===this.id);if(!s)throw new Error("Failed to find event");await this.client.decryptEventIfNeeded(s,{emit:!1,isRetry:!1});const n=s.getContent().file;return{info:n,httpUrl:this.client.mxcUrlToHttp(n.url)}}}var u=s(20),h=s.n(u),m=s(557);function p(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function g(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?p(Object(s),!0).forEach((function(t){i()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):p(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const v={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[o.a.RoomPowerLevels]:100,[o.a.RoomHistoryVisibility]:100,[o.a.RoomTombstone]:100,[o.a.RoomEncryption]:100,[o.a.RoomName]:50,[o.a.RoomMessage]:50,[o.a.RoomMessageEncrypted]:50,[o.a.Sticker]:50},users:{}};let f;!function(e){e.Viewer="viewer",e.Editor="editor",e.Owner="owner"}(f||(f={}));class b{constructor(e,t){if(this.client=e,this.roomId=t,i()(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){const e=this.room.currentState.getStateEvents(o.a.SpaceParent);return null==e||!e.length||e.every(e=>{var t;return!(null!==(t=e.getContent())&&void 0!==t&&t.via)})}setName(e){return this.client.sendStateEvent(this.roomId,o.a.RoomName,{name:e},"")}async invite(e,t=!0,s=!0){const n=[this.retryInvite(e)];return t&&n.push(...this.getDirectories().map(n=>n.invite(e,t,s))),Promise.all(n).then(()=>{s&&Object(m.a)(this.room)&&this.client.sendSharedHistoryKeys(this.roomId,[e])})}retryInvite(e){return Object(r.E)(async()=>{await this.client.invite(this.roomId,e).catch(e=>{if("M_FORBIDDEN"===(null==e?void 0:e.errcode))throw new h.a.AbortError(e);throw e})})}async setPermissions(e,t){var s;const n=this.room.currentState.getStateEvents(o.a.RoomPowerLevels,"");if(Array.isArray(n))throw new Error("Unexpected return type for power levels");const i=n.getContent()||{},a=i.users_default||0,r=i.events_default||50,c=(null===(s=i.events)||void 0===s?void 0:s[o.a.RoomPowerLevels])||100,l=i.users||{};switch(t){case f.Viewer:l[e]=a;break;case f.Editor:l[e]=r;break;case f.Owner:l[e]=c;break;default:throw new Error("Invalid role: "+t)}return i.users=l,this.client.sendStateEvent(this.roomId,o.a.RoomPowerLevels,i,"")}async createDirectory(e){const t=await this.client.unstableCreateFileTree(e);return await this.client.sendStateEvent(this.roomId,o.a.SpaceChild,{via:[this.client.getDomain()]},t.roomId),await this.client.sendStateEvent(t.roomId,o.a.SpaceParent,{via:[this.client.getDomain()]},this.roomId),t}getDirectories(){const e=[],t=this.room.currentState.getStateEvents(o.a.SpaceChild);for(const s of t)try{const t=this.client.unstableGetFileTreeSpace(s.getStateKey());t&&e.push(t)}catch(e){a.a.warn("Unable to create tree space instance for listing. Are we joined?",e)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}async delete(){const e=this.getDirectories();for(const t of e)await t.delete();const t=["invite","knock","join"],s=this.room.currentState.getStateEvents(o.a.RoomMember);for(const e of s){e.getStateKey()!==this.client.getUserId()&&t.includes(e.getContent().membership)&&await this.client.kick(this.roomId,e.getStateKey(),"Room deleted")}await this.client.leave(this.roomId)}getOrderedChildren(e){const t=e.map(e=>({roomId:e.getStateKey(),order:e.getContent().order}));return t.sort((e,t)=>{if(e.order&&!t.order)return-1;if(!e.order&&t.order)return 1;if(e.order||t.order)return Object(r.v)(e.order,t.order);{var s,n,i,a;const c=this.client.getRoom(e.roomId),l=this.client.getRoom(t.roomId);if(!c||!l)return Object(r.v)(e.roomId,t.roomId);const d=null!==(s=null===(n=c.currentState.getStateEvents(o.a.RoomCreate,""))||void 0===n?void 0:n.getTs())&&void 0!==s?s:0,u=null!==(i=null===(a=l.currentState.getStateEvents(o.a.RoomCreate,""))||void 0===a?void 0:a.getTs())&&void 0!==i?i:0;return d===u?Object(r.v)(e.roomId,t.roomId):d-u}}),t}getParentRoom(){const e=this.room.currentState.getStateEvents(o.a.SpaceParent)[0];if(!e)throw new Error("Expected to have a parent in a non-top level space");const t=this.client.getRoom(e.getStateKey());if(!t)throw new Error("Unable to locate room for parent");return t}getOrder(){if(this.isTopLevel)return-1;const e=this.getParentRoom().currentState.getStateEvents(o.a.SpaceChild);return this.getOrderedChildren(e).findIndex(e=>e.roomId===this.roomId)}async setOrder(e){var t;if(this.isTopLevel)throw new Error("Cannot set order of top level spaces currently");const s=this.getParentRoom(),n=s.currentState.getStateEvents(o.a.SpaceChild),i=this.getOrderedChildren(n);e=Math.max(Math.min(e,i.length-1),0);const a=this.getOrder()<e;a&&e===i.length-1?e--:a||0!==e||e++;const c=i[a?e:e-1],l=i[a?e+1:e];let d=r.a[0],u=!1;if(c)if(e===i.length-1)null!=l&&l.order&&(d=Object(r.w)(l.order));else{const e=null==c?void 0:c.order,t=null==l?void 0:l.order;e&&t?d=e===t?Object(r.w)(e):Object(r.c)(e,t):e?d=Object(r.w)(e):t?d=Object(r.z)(t):u=!0}else null!=l&&l.order&&(d=Object(r.z)(l.order));if(u){let t;for(let n=0;n<=e;n++){const e=i[n];if(0===n&&(t=e.order),e.order)t=e.order;else{var h;t=t?Object(r.w)(t):r.a[0];const n=s.currentState.getStateEvents(o.a.SpaceChild,e.roomId),i=null!==(h=null==n?void 0:n.getContent())&&void 0!==h?h:{via:[this.client.getDomain()]};await this.client.sendStateEvent(s.roomId,o.a.SpaceChild,g(g({},i),{},{order:t}),e.roomId)}}d=Object(r.w)(t)}const m=s.currentState.getStateEvents(o.a.SpaceChild,this.roomId),p=null!==(t=null==m?void 0:m.getContent())&&void 0!==t?t:{via:[this.client.getDomain()]};await this.client.sendStateEvent(s.roomId,o.a.SpaceChild,g(g({},p),{},{order:d}),this.roomId)}async createFile(e,t,s){const n=await this.client.uploadContent(new Blob([t]),{includeFilename:!1,onlyContentUri:!0});s.url=n;const i=await this.client.sendMessage(this.roomId,{msgtype:o.b.File,body:e,url:n,file:s,[o.i.name]:{}});await this.client.sendStateEvent(this.roomId,o.h.name,{active:!0,name:e},i.event_id)}getFile(e){const t=this.room.currentState.getStateEvents(o.h.name,e);return t?new d(this.client,t):null}listFiles(){var e;return(null!==(e=this.room.currentState.getStateEvents(o.h.name))&&void 0!==e?e:[]).map(e=>new d(this.client,e)).filter(e=>e.isActive)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(18),i=s.n(n),o=s(177),a=s(264),r=s(8),c=s(128),l=s(127),d=s(359);class u extends r.EventEmitter{constructor(e){super(),this.community=e,i()(this,"roomIds",new Set),i()(this,"userIds",new Set),i()(this,"onStoreUpdate",async()=>{const e=this.roomIds;this.roomIds=new Set((await c.a.getGroupRooms(this.community.groupId)).map(e=>e.roomId));const t=this.userIds;this.userIds=new Set((await c.a.getGroupMembers(this.community.groupId)).map(e=>e.userId)),(Object(d.a)(e,this.roomIds)||Object(d.a)(t,this.userIds))&&this.emit(a.a)}),c.a.on("update",this.onStoreUpdate),this.onStoreUpdate()}get kind(){return a.b.Prefilter}isVisible(e){return this.roomIds.has(e.roomId)||this.userIds.has(l.a.shared().getUserIdForRoomId(e.roomId))}destroy(){c.a.off("update",this.onStoreUpdate)}}var h=s(121);class m{constructor(e){this.store=e,i()(this,"filters",new Map),i()(this,"onTagsUpdated",()=>{const e=Array.from(this.filters.keys()),t=o.a.getSelectedTags();if(Object(h.d)(e,t)){if(!this.store.matrixClient)return void console.warn("Tag update without an associated matrix client - ignoring");const s=new Map,n=t.filter(e=>e.startsWith("+"));for(const e of n){const t=this.store.matrixClient.getGroup(e);if(!t){console.warn("Group selected with no group object available: "+e);continue}let n=this.filters.get(e);n||(n=new u(t)),s.set(e,n)}const i=Object(h.a)(e,t);for(const e of i.added){const t=s.get(e);t&&this.store.addFilter(t)}for(const e of i.removed){const t=this.filters.get(e);t&&(this.store.removeFilter(t),t.destroy())}this.filters=s}}),o.a.addListener(this.onTagsUpdated)}}}]]);
//# sourceMappingURL=init.js.map